<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>東京 小旅行 2026</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FAF0E6">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        :root {
            --primary: #2563EB;
            /* 主色藍 */
            --secondary: #F59E0B;
            /* 輔色黃 */
            --bg: #F3F4F6;
            /* 背景灰 */
            --white: #FFFFFF;
            --text-main: #1F2937;
            --text-sub: #6B7280;
            --danger: #EF4444;
            --food-choice: #8B5CF6;
            /* 紫色用於餐食選擇 */
            --tag-food-bg: #EDE9FE;
            --tag-toyota: #E0E7FF;
            /* 淺藍紫 for Toyota */
            --info-bg: #E0F2F1;
            /* 資訊頁背景色 */
            --info-text: #0D9488;
            /* 資訊頁文字色 */
            --kumamoto-info-bg: #F0F9FF;
            /* 熊本資訊背景 */
            --kumamoto-info-text: #0E7490;
            /* 熊本資訊文字 */
            --beppu-info: #14B8A6;
            /* 別府地獄專用色 */
            --beppu-bg: #E0F2F1;

            /* Safe Area Variables */
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        /* [新增] 水平捲軸圖片預覽容器 */
        .horizontal-scroll-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 4px 0;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            /* iOS 順暢捲動 */
            /* 隱藏捲軸但保留功能 */
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE 10+ */
        }

        .horizontal-scroll-container::-webkit-scrollbar {
            display: none;
            /* Chrome/Safari */
        }

        .preview-thumb-box {
            position: relative;
            width: 60px;
            height: 60px;
            flex-shrink: 0;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #eee;
        }

        .preview-thumb-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .btn-remove-img {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            z-index: 2;
        }

        /* [新增] 全螢幕圖庫 Modal */
        #gallery-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 9999;
            flex-direction: column;
        }

        #gallery-container {
            flex: 1;
            display: flex;
            align-items: center;
            overflow: hidden;
            /* 禁止溢出 */
            position: relative;
        }

        /* 圖片容器 - 用於 Zoom */
        .gallery-slide {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0;
            left: 0;
            transition: transform 0.3s ease-out;
            /* 滑動動畫 */
            will-change: transform;
        }

        .gallery-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.1s;
            /* Zoom 反應快一點 */
            transform-origin: center center;
        }

        .gallery-dots {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.5);
        }

        .gallery-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #888;
            transition: 0.3s;
        }

        .gallery-dot.active {
            background: white;
            transform: scale(1.2);
        }

        .gallery-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            z-index: 10000;
            text-shadow: 0 0 5px black;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            padding-bottom: calc(80px + var(--safe-area-bottom));
            /* 底部導航空間 + 安全區域 */
        }

        /* Header - Modified for Side-by-Side Layout */
        /* [新增] 右上角重新整理按鈕樣式 */
        /* [修改] 重整按鈕：縮小並跟隨文字 */
        .btn-app-refresh {
            position: relative;
            /* 改為相對定位，跟隨文字流 */
            display: inline-flex;
            /* 讓它像文字一樣排列 */
            vertical-align: middle;
            /* 垂直置中對齊文字 */
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            padding: 2px;
            /* 縮小點擊範圍的留白 */
            margin-left: 2px;
            /* 與標題文字保持一點距離 */
            margin-bottom: 4px;
            /* 微調垂直位置 */
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-app-refresh:active,
        .btn-app-refresh:hover {
            color: white;
            transform: rotate(180deg);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        /* [修改] 圖示縮小約 60% (原 20px -> 12px) */
        .btn-app-refresh svg {
            width: 12px;
            height: 12px;
            stroke-width: 3;
            /* 因為變小了，線條加粗一點點才清楚 */
        }

        header {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: var(--white);
            padding: 15px 20px;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2);
            position: relative;
            z-index: 10;
        }

        .header-content {
            position: relative;
            /* 確保 z-index 生效 */
            z-index: 10;
            /* 關鍵修正！讓文字與按鈕在最上層 */
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            max-width: 1200px;
            margin: 0 auto;
            flex-wrap: wrap;
        }

        .header-title-area {
            flex: 1;
            min-width: 200px;
        }

        .header-title-area h1 {
            margin: 0;
            font-size: 1.6rem;
            font-weight: 700;
            white-space: nowrap;
        }

        .header-title-area .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 5px;
        }

        .header-title-area .badge-trip {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;

            display: inline-flex;
            align-items: center;
            gap: 6px;

            margin-top: 8px;
        }

        /* [修改] SOS 浮動分享按鈕 (層級加強版) */
        /* [新增] 行前檢查清單樣式 */
        /* [修改] 行前檢查清單樣式 (加入折疊功能) */
        /* [修改] 行前檢查清單樣式 (含捲動與新增刪除功能) */
        .checklist-card-header {
            border-bottom: 1px dashed #E5E7EB;
            padding-bottom: 10px;
            margin-bottom: 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .checklist-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.2s ease-out;
            opacity: 0;
        }

        .checklist-container.show {
            /* 設定高度約為 5 行的高度 (每行約 50px)，超過出現捲軸 */
            max-height: 280px;
            opacity: 1;
            margin-top: 15px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .checklist-grid {
            display: flex;
            flex-direction: column;
            /* 改為垂直排列 */
            gap: 8px;
            padding-bottom: 5px;
        }

        .check-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            /* 讓刪除按鈕靠右 */
            gap: 8px;
            background: #F9FAFB;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
            border: 1px solid #E5E7EB;
            user-select: none;
        }

        .check-item:has(input:checked) {
            background: #ECFDF5;
            border-color: #10B981;
            color: #065F46;
            font-weight: 600;
        }

        .check-item input {
            accent-color: #10B981;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* 刪除按鈕樣式 */
        .btn-del-item {
            color: #EF4444;
            background: none;
            border: none;
            font-size: 1.2rem;
            line-height: 1;
            cursor: pointer;
            padding: 0 8px;
            opacity: 0.6;
        }

        .btn-del-item:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        /* 新增項目輸入框區域 */
        .add-item-box {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            padding: 5px;
            position: sticky;
            top: 0;
            background: var(--bg);
            z-index: 5;
            /* 背景色與body一致避免透明 */
            border-bottom: 1px solid #eee;
        }

        .input-add-item {
            flex: 1;
            padding: 10px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            outline: none;
            font-size: 0.9rem;
        }

        .btn-add-item {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 0 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* [新增] 隨身筆記浮動按鈕 (位於分享按鈕上方) */
        /* [修改] 隨身筆記浮動按鈕 (藍色) - 縮小與透明化 */
        .float-note-btn {
            position: fixed;
            bottom: 155px;
            /* [調整] 因為按鈕變小了，高度稍微降低靠近下方 */
            left: 20px;
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            padding: 16px;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
            z-index: 9999;
            cursor: pointer;
            transition: all 0.2s;
            /* 改為 all 以支援 opacity 變化 */
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-user-select: none;
            user-select: none;

            /* [新增] 縮小與透明度設定 */
            transform: scale(0.7);
            /* 縮小至 70% */
            opacity: 0.6;
            /* 透明度 60% */
            transform-origin: center center;
            /* 以中心點縮放 */
        }

        /* 讓使用者點擊(按住)時，稍微變回不透明，增加回饋感 */
        .float-note-btn:active {
            transform: scale(0.65);
            /* 按下時稍微更小一點點 */
            opacity: 1;
            /* 按下時變清楚 */
        }

        /* [修改] 匯率計算機浮動按鈕 (橘色) - 縮小與透明化 */
        .float-calc-btn {
            position: fixed;
            bottom: 205px;
            /* [調整] 配合藍色按鈕的高度調整 */
            left: 20px;

            background: rgba(245, 158, 11, 0.65);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);

            color: white;
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            padding: 16px;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
            z-index: 9999;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-user-select: none;
            user-select: none;

            /* [新增] 縮小與透明度設定 */
            transform: scale(0.7);
            /* 縮小至 70% */
            opacity: 0.6;
            /* 透明度 60% (會疊加背景本身的透明度) */
            transform-origin: center center;
        }

        /* 點擊時的回饋 */
        .float-calc-btn:active {
            transform: scale(0.65);
            opacity: 1;
            background: rgba(245, 158, 11, 0.85);
        }

        .float-note-btn svg,
        .float-calc-btn svg {
            width: 20px;
            height: 20px;
            stroke-width: 2.5;
        }

        .float-calc-btn:active {
            transform: scale(0.95);
            background: rgba(245, 158, 11, 0.85);
            /* 按下時變實心一點 */
        }

        .float-calc-btn svg {
            width: 20px;
            height: 20px;
            stroke-width: 2.5;
        }

        /* 計算機視窗樣式 */
        .calc-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calc-input {
            width: 60%;
            padding: 10px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 1.2rem;
            text-align: right;
            outline: none;
        }

        .calc-input:focus {
            border-color: #F59E0B;
        }

        .calc-label {
            font-weight: 600;
            color: #4B5563;
        }

        /* [新增] 計算機專用樣式 (Calculator Style) */
        .calc-display {
            background: #F3F4F6;
            padding: 15px;
            border-radius: 12px;
            text-align: right;
            margin-bottom: 15px;
            border: 2px solid #E5E7EB;
        }

        .calc-expr {
            font-size: 0.9rem;
            color: #6B7280;
            min-height: 1.2em;
            margin-bottom: 5px;
            overflow-x: auto;
            white-space: nowrap;
        }

        .calc-main {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1F2937;
            line-height: 1.2;
        }

        .calc-sub {
            font-size: 1rem;
            color: #059669;
            font-weight: 600;
            margin-top: 4px;
        }

        .calc-keypad {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            /* 稍微增加間距讓陰影更清楚 */
        }

        /* 按鈕基礎樣式 - 優化陰影與質感 */
        .calc-btn {
            background: white;
            border: 1px solid #F3F4F6;
            /* 極淡的邊框 */
            border-radius: 14px;
            /* 更圓潤 */
            padding: 15px 0;
            font-size: 1.3rem;
            font-weight: 500;
            color: #374151;
            cursor: pointer;

            /* [修改] 更自然的柔和浮起陰影 */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03), 0 2px 4px rgba(0, 0, 0, 0.04);
            transition: all 0.1s ease;
            user-select: none;

            display: flex;
            align-items: center;
            justify-content: center;
        }



        /* 按下時的凹陷感 */
        .calc-btn:active {
            transform: scale(0.96);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            background: #F9FAFB;
        }

        /* 功能鍵顏色 */
        .calc-btn.op {
            color: #2563EB;
            background: #EFF6FF;
            font-weight: 600;
        }

        .calc-btn.ac {
            color: #DC2626;
            background: #FEF2F2;
            font-weight: 600;
        }

        /* [修改] 等號按鍵 - 直式排列 (放在 + 號下方) */
        .calc-btn.eq {
            background: #2563EB;
            color: white;
            grid-row: span 2;
            /* 垂直跨兩行 */
            grid-column: 4;
            /* 固定在第4欄 */
            border: none;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            /* 藍色光暈 */
            font-size: 1.5rem;
        }

        .calc-btn.eq:active {
            background: #1D4ED8;
            transform: scale(0.96);
        }

        /* [修改] 0號按鍵 - 橫跨兩欄 */
        .calc-btn.zero {
            grid-column: span 2;
            /* 水平跨兩欄 */
            text-align: left;
            padding-left: 25px;
            /* 數字稍微靠左一點比較像真計算機 */
            justify-content: flex-start;
        }

        /* [修改] 右上角關閉 X 按鈕樣式 - 無底色並調整位置 */
        .btn-modal-close-x {
            position: absolute;
            top: 5px;
            /* [修改] 數值越小越往上 */
            right: 5px;
            /* [修改] 數值越小越往右 */
            width: 32px;
            height: 32px;
            background: transparent;
            /* [修改] 變為透明背景 */
            color: #9CA3AF;
            /* [微調] 稍微調淡一點的灰色，比較不搶眼 */
            border: none;
            font-size: 1.8rem;
            /* [微調] 加大字體，讓無底色的 X 更清晰 */
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }

        /* [修改] 滑鼠移入和按下時給予輕微的回饋 */
        .btn-modal-close-x:hover {
            color: #4B5563;
            /* 滑入時變深灰色 */
        }

        .btn-modal-close-x:active {
            background: rgba(0, 0, 0, 0.05);
            /* 按下時出現淡淡的圓形背景 */
            border-radius: 50%;
            transform: scale(0.9);
            color: #1F2937;
        }

        /* [新增] 筆記區升級 - 支援圖文混排與放大 */
        .note-editable-box {
            width: 100%;
            height: 250px;
            padding: 12px;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            font-size: 1rem;
            overflow-y: auto;
            background: #F9FAFB;
            outline: none;
            text-align: left;
            white-space: pre-wrap;
            /* 保留換行 */
        }

        .note-editable-box:focus {
            border-color: var(--primary);
            background: white;
        }

        /* 筆記內的圖片樣式 */
        .note-editable-box img {
            max-width: 90%;
            border-radius: 8px;
            margin: 10px 0;
            display: block;
            border: 2px solid #E5E7EB;
            cursor: zoom-in;
            /* [關鍵] 讓滑鼠移過去變成放大鏡，提示可點擊 */
        }

        /* 筆記工具列 */
        .note-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }

        .btn-note-tool {
            background: #EFF6FF;
            color: #2563EB;
            border: 1px solid #BFDBFE;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* [新增] 動態日夜背景特效 */
        header {
            /* 預設(白天): 原本的明亮藍色漸層 */
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            transition: background 1.5s ease;
            /* 顏色切換時有呼吸感 */
            overflow: hidden;
            /* 防止星星超出範圍 */
            position: relative;
            /* 確保特效層定位正確 */
        }

        /* 晚上的背景: 深邃的午夜藍 */
        header.is-night {
            background: linear-gradient(135deg, #0f172a, #1e3a8a);
        }

        /* 星星層 (預設隱藏) */
        .header-bg-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            /* 確保不擋住按鈕點擊 */
            z-index: 0;
            /* 在內容之下 */
            opacity: 0;
            transition: opacity 1.5s ease;

            /* 利用 CSS 徑向漸層畫出星星 */
            background-image:
                radial-gradient(white, rgba(255, 255, 255, .2) 2px, transparent 3px),
                radial-gradient(white, rgba(255, 255, 255, .15) 1px, transparent 2px),
                radial-gradient(white, rgba(255, 255, 255, .1) 2px, transparent 3px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            background-position: 0 0, 40px 60px, 130px 270px;
        }

        /* 晚上時顯示星星 */
        header.is-night .header-bg-effect {
            opacity: 0.8;
        }

        /* 確保原本的標題內容浮在星星之上 */
        .header-content {
            position: relative;
            z-index: 2;
        }

        /* --- 插入結束 --- */

        .float-note-btn:active {
            transform: scale(0.95);
        }

        .float-note-btn svg {
            width: 20px;
            height: 20px;
            stroke-width: 2.5;
        }

        .float-share-btn {
            position: fixed;
            bottom: 90px;
            /* 位於底部導航欄上方 */
            left: 20px;
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
            border: 2px solid white;
            /* 新增：白色邊框，增加辨識度 */
            border-radius: 50px;
            padding: 16px;
            font-size: 0.9rem;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.5);
            /* 陰影加深 */
            display: flex;
            align-items: center;
            gap: 8px;


            z-index: 9999;
            /* 設到最高，確保浮在所有內容之上 */

            cursor: pointer;
            transition: transform 0.2s;
            -webkit-user-select: none;
            user-select: none;
        }

        .float-share-btn:active {
            transform: scale(0.95);
        }

        /* --- 請在此處插入代碼 Start --- */
        .share-cancel-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: #9CA3AF;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            z-index: 20;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        .share-cancel-badge:active {
            transform: scale(0.9);
            background: #6B7280;
        }

        /* --- 請在此處插入代碼 End --- */
        .float-share-btn svg {
            width: 20px;
            height: 20px;
            stroke-width: 2.5;
        }

        .float-share-btn svg {
            width: 20px;
            height: 20px;
            stroke-width: 2.5;
        }

        .header-title-area .badge-trip::before {
            content: '';
            display: block;
            width: 16px;
            height: 16px;
            background-color: currentColor;
            /* 自動變成白色 */

            /* 親子/群組 SVG 圖示 (Users Icon) */
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2'%3E%3C/path%3E%3Ccircle cx='9' cy='7' r='4'%3E%3C/circle%3E%3Cpath d='M23 21v-2a4 4 0 0 0-3-3.87'%3E%3C/path%3E%3Cpath d='M16 3.13a4 4 0 0 1 0 7.75'%3E%3C/path%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2'%3E%3C/path%3E%3Ccircle cx='9' cy='7' r='4'%3E%3C/circle%3E%3Cpath d='M23 21v-2a4 4 0 0 0-3-3.87'%3E%3C/path%3E%3Cpath d='M16 3.13a4 4 0 0 1 0 7.75'%3E%3C/path%3E%3C/svg%3E");

            -webkit-mask-size: contain;
            mask-size: contain;
            -webkit-mask-repeat: no-repeat;
            mask-repeat: no-repeat;
        }

        /* New Header Weather Box - Side Layout */
        .header-weather-box {
            flex: 0 0 auto;
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 50px;
            /* Pill shape */
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            min-height: 70px;
        }

        /* Weather Columns */
        /* [新增] Header 我的位置區塊樣式 */
        .hw-col-my-loc {
            padding-right: 10px;
            margin-right: 5px;
            border-right: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 60px;
            text-align: left;
        }

        .hw-sub-label {
            font-size: 0.65rem;
            opacity: 0.8;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .hw-my-data {
            font-size: 0.9rem;
            font-weight: 700;
            white-space: nowrap;
            display: flex;
            gap: 4px;
            align-items: center;
        }

        /* 手機版微調 */
        @media (max-width: 600px) {
            .hw-col-my-loc {
                padding-right: 8px;
                margin-right: 0;
                border-right: 1px solid rgba(255, 255, 255, 0.2);

                /* [新增] 下面這兩行是解決擠壓的關鍵 */
                min-width: auto;
                /* [修正] 改為 auto，讓寬度隨內容調整 */
                flex-shrink: 0;
                /* [新增] 防止內容被擠扁 */
                white-space: nowrap;
                /* 禁止文字換行 */
            }
        }

        .hw-loc {
            font-size: 1.1rem;
            font-weight: 700;
            display: block;
            line-height: 1.2;
        }

        .hw-date {
            font-size: 0.75rem;
            opacity: 0.9;
            display: block;
            margin-top: 4px;
        }

        .hw-col-main {
            padding: 0 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .hw-icon svg {
            width: 36px;
            height: 36px;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
        }

        .hw-temp-group {
            text-align: center;
        }

        .hw-temp {
            font-size: 1.4rem;
            font-weight: 700;
            line-height: 1;
        }

        .hw-desc {
            font-size: 0.8rem;
            font-weight: 500;
            display: block;
            margin-top: 2px;
        }

        .hw-range {
            font-size: 0.7rem;
            opacity: 0.9;
            display: block;
            margin-top: 2px;
            font-family: monospace;
        }

        .hw-col-advice {
            padding-left: 15px;
            border-left: 1px solid rgba(255, 255, 255, 0.3);
            max-width: 140px;
            font-size: 0.75rem;
            line-height: 1.3;
            opacity: 0.95;
            display: flex;
            align-items: center;
            min-height: 50px;
            /* Ensure height for border */
        }

        /* Container & Tabs */
        .container {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s ease;
            max-width: 800px;
            margin: 0 auto;
        }

        .container.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.03);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .card-title {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.05rem;
        }

        /* Day specific styles */
        .day-wrapper {
            background: var(--white);
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: box-shadow 0.2s;
        }

        .day-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            cursor: pointer;
            border-radius: 12px;
            border-left: 5px solid transparent;
            transition: background-color 0.2s, border-left-color 0.3s;
        }

        .day-toggle:active {
            background-color: #F8F9FB;
        }

        .day-toggle.open {
            border-left-color: var(--primary);
        }

        .day-info h3 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--text-main);
        }

        .day-info span {
            font-size: 0.85rem;
            color: var(--text-sub);
        }

        .toggle-icon {
            transition: transform 0.3s;
            font-size: 0.8rem;
            color: var(--text-sub);
            font-weight: 700;
        }

        .day-toggle.open .toggle-icon {
            transform: rotate(180deg);
            color: var(--primary);
        }

        .timeline {
            display: none;
            padding: 15px 15px 5px 30px;
            border-top: 1px solid #F3F4F6;
        }

        .timeline.show {
            display: block;
        }

        .event {
            position: relative;
            padding-left: 20px;
            margin-bottom: 24px;
        }

        .event:last-child {
            margin-bottom: 0;
        }

        .event::before {
            content: '';
            position: absolute;
            left: -7px;
            top: 6px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--white);
            border: 3px solid var(--secondary);
            z-index: 1;
        }

        /* Event Styles */
        .event-meal .activity {
            color: var(--food-choice);
        }

        .event-meal .desc {
            border-left: 2px solid var(--food-choice);
            padding-left: 8px;
            margin-top: 5px;
        }

        .time {
            font-size: 0.85rem;
            color: var(--text-sub);
            font-weight: 600;
            font-family: monospace;
        }

        .activity {
            font-size: 1rem;
            font-weight: 700;
            margin: 4px 0;
            color: var(--text-main);
        }

        .desc {
            font-size: 0.9rem;
            color: #555;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        /* Tags */
        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tag {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 6px;
            font-weight: 500;
        }

        .tag-food {
            background: var(--tag-food-bg);
            color: var(--food-choice);
        }

        .tag-move {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .tag-stay {
            background: #D1FAE5;
            color: #059669;
        }

        .tag-spot {
            background: #FCE7F3;
            color: #BE185D;
        }

        .tag-kids {
            background: #E0F2FE;
            color: #0284C7;
            border: 1px solid #BAE6FD;
        }

        .tag-car {
            background: var(--tag-toyota);
            color: #4338CA;
        }

        .tag-relax {
            background: #FFFBEB;
            color: #D97706;
            border: 1px solid #FCD34D;
        }

        .tag-shrine {
            background: #FEE2E2;
            color: #B91C1C;
            border: 1px solid #FCA5A5;
        }

        .tag-flight {
            background: #BFDBFE;
            color: #1D4ED8;
        }

        .tag-tip {
            background: var(--info-bg);
            color: var(--info-text);
        }

        .tag-shop {
            background: var(--kumamoto-info-bg);
            color: var(--kumamoto-info-text);
        }

        .tag-beppu {
            background: var(--beppu-bg);
            color: var(--beppu-info);
        }

        .tag-snow {
            background: #E0F2FE;
            color: #0369A1;
            border: 1px solid #BAE6FD;
        }

        /* Buttons */
        .btn-primary {
            background-color: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* [新增] 幽靈按鈕 (無背景，藍色圖示) */
        .btn-submit-ghost {
            background-color: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .btn-submit-ghost:active {
            transform: scale(0.9);
            background-color: transparent !important;
        }

        .btn-submit-ghost svg {
            stroke: var(--primary);
            /* 圖示改為藍色 */
            width: 24px;
            height: 24px;
        }

        /* [修改] 使用者身分卡片 - 移除邊框 */
        .user-status-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 5px;
            /* 稍微減少 padding */
            border: none !important;
            /* [最重要的修改] 移除邊框 */
            box-shadow: none !important;
            /* 移除陰影 */
            background: transparent;
            /* 背景透明 */
            margin-bottom: 5px;
        }

        .btn-primary:active {
            background-color: #1D4ED8;
            /* Darker blue */
            transform: scale(0.96);
        }

        .btn-map {
            display: inline-flex;
            align-items: center;
            text-decoration: none;
            color: var(--primary);
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 4px;
            padding: 4px 0;
        }

        .btn-map::before {
            content: '';
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-right: 4px;

            /* 這裡設定圖示顏色跟隨文字顏色 (即您的主色藍) */
            background-color: currentColor;

            /* 使用 SVG 作為遮罩形狀 */
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'%3E%3C/path%3E%3Ccircle cx='12' cy='10' r='3'%3E%3C/circle%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'%3E%3C/path%3E%3Ccircle cx='12' cy='10' r='3'%3E%3C/circle%3E%3C/svg%3E");

            -webkit-mask-size: contain;
            mask-size: contain;
            -webkit-mask-repeat: no-repeat;
            mask-repeat: no-repeat;

            /* 微調垂直位置，讓圖示與文字對齊 */
            vertical-align: text-bottom;
        }

        .btn-link {
            background: var(--primary);
            color: white;
            text-decoration: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            display: block;
            text-align: center;
            margin-top: 10px;
        }

        .btn-link-sub {
            background: #EBF5FF;
            color: var(--primary);
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            display: block;
            text-align: center;
            margin-top: 8px;
            border: 1px solid var(--primary);
        }

        .btn-link-tel {
            background: #D1FAE5;
            color: #059669;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            display: block;
            text-align: center;
            margin-top: 8px;
            border: 1px solid #059669;
        }

        .btn-link-tel::before {
            content: '📞';
            margin-right: 4px;
        }

        /* Info Grid */
        .info-grid {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 10px;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .info-label {
            color: var(--text-sub);
        }

        .info-val {
            font-weight: 500;
        }

        .info-detail-box {
            border: 1px solid #D1D5DB;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .info-detail-box h4 {
            margin: 0 0 8px 0;
            font-size: 1rem;
            color: var(--primary);
        }

        /* Info Sections */
        /* [新增] Marquee Animation */
        @keyframes marquee {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        .info-section {
            background-color: var(--info-bg);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 16px;
            border: 1px solid #5EEAD4;
        }

        .info-section.kumamoto {
            background-color: var(--kumamoto-info-bg);
            border-color: #90CDF4;
        }

        .info-section.kumamoto h3 {
            color: var(--kumamoto-info-text);
            border-bottom: 2px solid #90CDF4;
        }

        .info-section.winter-drive {
            background-color: #FEF2F2;
            border-color: #FCA5A5;
            color: #B91C1C;
        }

        .info-section.winter-drive h3 {
            color: #B91C1C;
            border-bottom: 2px solid #FCA5A5;
        }

        .info-section h3 {
            color: var(--info-text);
            font-size: 1.2rem;
            margin-top: 0;
            border-bottom: 2px solid #5EEAD4;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }

        /* Price table */
        .price-table {
            display: grid;
            grid-template-columns: 1fr 80px 80px;
            gap: 8px;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .price-header {
            font-weight: 700;
            color: var(--primary);
            padding-bottom: 4px;
            border-bottom: 1px solid var(--primary);
        }

        .price-item {
            padding: 4px 0;
            border-bottom: 1px dashed #DDD;
        }

        .price-item:last-child {
            border-bottom: none;
        }

        .price-item .detail {
            font-size: 0.8rem;
            color: var(--text-sub);
        }

        .safari-method {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            border: 1px dashed var(--info-text);
        }

        .method-title {
            font-weight: 700;
            color: var(--primary);
            display: block;
            margin-bottom: 5px;
            font-size: 1rem;
        }

        .method-title.recommended {
            color: var(--danger);
        }

        .method-detail {
            font-size: 0.9rem;
            line-height: 1.5;
            color: #444;
        }

        /* Step List */
        .step-list {
            counter-reset: step-counter;
            padding-left: 0;
            list-style: none;
            margin-top: 10px;
        }

        .step-list li {
            position: relative;
            padding-left: 30px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .step-list li::before {
            counter-increment: step-counter;
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            width: 20px;
            height: 20px;
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            text-align: center;
            font-size: 0.75rem;
            line-height: 20px;
        }

        /* Bottom Nav - Optimized for Safe Area */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-around;
            padding: 8px 0 calc(8px + var(--safe-area-bottom));
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
            z-index: 100;
        }

        .nav-item {
            text-align: center;
            color: #9CA3AF;
            font-size: 0.7rem;
            cursor: pointer;
            transition: color 0.2s;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px;
            /* Touch target */
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            display: block;
            margin-bottom: 4px;
            height: 22px;
            width: 22px;
        }

        .nav-icon svg {
            width: 100%;
            height: 100%;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .alert-box {
            background: #FEF2F2;
            border: 1px solid #FECACA;
            color: #991B1B;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-top: 8px;
            display: flex;
            gap: 8px;
            align-items: start;
            margin-bottom: 15px;
        }

        /* 通用 Alert 圖示設定 */
        .alert-icon {
            width: 20px;
            height: 20px;
            background-color: currentColor;
            /* 自動抓取提示框的文字顏色 (綠/藍) */
            flex-shrink: 0;
            /* 防止圖示被文字擠壓變形 */
            margin-top: 1px;
            /* 微調垂直對齊 */

            -webkit-mask-size: contain;
            mask-size: contain;
            -webkit-mask-repeat: no-repeat;
            mask-repeat: no-repeat;
            -webkit-mask-position: center;
            mask-position: center;
        }

        /* --- Header 天氣圖示優化 (CSS Mask) --- */
        .weather-icon {
            width: 36px;
            height: 36px;
            background-color: white;
            /* 跟隨 Header 文字顏色 (白) */

            -webkit-mask-size: contain;
            mask-size: contain;
            -webkit-mask-repeat: no-repeat;
            mask-repeat: no-repeat;
            -webkit-mask-position: center;
            mask-position: center;

            /* 增加一點陰影讓白色圖示更清楚 */
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
        }

        /* 各種天氣對應的 SVG 形狀 */
        .weather-icon.sun {
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='5'%3E%3C/circle%3E%3Cline x1='12' y1='1' x2='12' y2='3'%3E%3C/line%3E%3Cline x1='12' y1='21' x2='12' y2='23'%3E%3C/line%3E%3Cline x1='4.22' y1='4.22' x2='5.64' y2='5.64'%3E%3C/line%3E%3Cline x1='18.36' y1='18.36' x2='19.78' y2='19.78'%3E%3C/line%3E%3Cline x1='1' y1='12' x2='3' y2='12'%3E%3C/line%3E%3Cline x1='21' y1='12' x2='23' y2='12'%3E%3C/line%3E%3Cline x1='4.22' y1='19.78' x2='5.64' y2='18.36'%3E%3C/line%3E%3Cline x1='18.36' y1='5.64' x2='19.78' y2='4.22'%3E%3C/line%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='5'%3E%3C/circle%3E%3Cline x1='12' y1='1' x2='12' y2='3'%3E%3C/line%3E%3Cline x1='12' y1='21' x2='12' y2='23'%3E%3C/line%3E%3Cline x1='4.22' y1='4.22' x2='5.64' y2='5.64'%3E%3C/line%3E%3Cline x1='18.36' y1='18.36' x2='19.78' y2='19.78'%3E%3C/line%3E%3Cline x1='1' y1='12' x2='3' y2='12'%3E%3C/line%3E%3Cline x1='21' y1='12' x2='23' y2='12'%3E%3C/line%3E%3Cline x1='4.22' y1='19.78' x2='5.64' y2='18.36'%3E%3C/line%3E%3Cline x1='18.36' y1='5.64' x2='19.78' y2='4.22'%3E%3C/line%3E%3C/svg%3E");
        }

        .weather-icon.cloud {
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z'%3E%3C/path%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z'%3E%3C/path%3E%3C/svg%3E");
        }

        .weather-icon.cloud-sun {
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 2v2'%3E%3C/path%3E%3Cpath d='m4.93 4.93 1.41 1.41'%3E%3C/path%3E%3Cpath d='M20 12h2'%3E%3C/path%3E%3Cpath d='m19.07 4.93-1.41 1.41'%3E%3C/path%3E%3Cpath d='M15.947 12.65a4 4 0 0 0-5.925-4.128'%3E%3C/path%3E%3Cpath d='M13 22H7a5 5 0 1 1 4.9-6H13a3 3 0 0 1 0 6Z'%3E%3C/path%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 2v2'%3E%3C/path%3E%3Cpath d='m4.93 4.93 1.41 1.41'%3E%3C/path%3E%3Cpath d='M20 12h2'%3E%3C/path%3E%3Cpath d='m19.07 4.93-1.41 1.41'%3E%3C/path%3E%3Cpath d='M15.947 12.65a4 4 0 0 0-5.925-4.128'%3E%3C/path%3E%3Cpath d='M13 22H7a5 5 0 1 1 4.9-6H13a3 3 0 0 1 0 6Z'%3E%3C/path%3E%3C/svg%3E");
        }

        /* [修改] Header 天氣圖示：使用新的雙重平行 V 型雪花 */
        .weather-icon.snow {
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3C!-- 六角冰核 --%3E%3Cpath d='M12 9 L14.6 10.5 L14.6 13.5 L12 15 L9.4 13.5 L9.4 10.5 Z'/%3E%3C!-- 主幹貫穿 --%3E%3Cpath d='M12 9 V1 M12 15 V23 M14.6 10.5 L21.5 6.5 M14.6 13.5 L21.5 17.5 M9.4 13.5 L2.5 17.5 M9.4 10.5 L2.5 6.5'/%3E%3C!-- 雙重 V 型 --%3E%3Cpath d='M9.5 5.5 L12 7.5 L14.5 5.5 M9.5 2 L12 4 L14.5 2'/%3E%3Cpath d='M9.5 18.5 L12 16.5 L14.5 18.5 M9.5 22 L12 20 L14.5 22'/%3E%3Cpath d='M16.4 6.6 L15.9 9.75 L18.9 10.9 M19.4 4.8 L18.9 8 L21.9 9.2'/%3E%3Cpath d='M18.9 13.1 L15.9 14.25 L16.4 17.4 M21.9 14.8 L18.9 16 L19.4 19.2'/%3E%3Cpath d='M7.6 17.4 L8.1 14.25 L5.1 13.1 M4.6 19.2 L5.1 16 L2.1 14.8'/%3E%3Cpath d='M5.1 10.9 L8.1 9.75 L7.6 6.6 M2.1 9.2 L5.1 8 L4.6 4.8'/%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3C!-- 六角冰核 --%3E%3Cpath d='M12 9 L14.6 10.5 L14.6 13.5 L12 15 L9.4 13.5 L9.4 10.5 Z'/%3E%3C!-- 主幹貫穿 --%3E%3Cpath d='M12 9 V1 M12 15 V23 M14.6 10.5 L21.5 6.5 M14.6 13.5 L21.5 17.5 M9.4 13.5 L2.5 17.5 M9.4 10.5 L2.5 6.5'/%3E%3C!-- 雙重 V 型 --%3E%3Cpath d='M9.5 5.5 L12 7.5 L14.5 5.5 M9.5 2 L12 4 L14.5 2'/%3E%3Cpath d='M9.5 18.5 L12 16.5 L14.5 18.5 M9.5 22 L12 20 L14.5 22'/%3E%3Cpath d='M16.4 6.6 L15.9 9.75 L18.9 10.9 M19.4 4.8 L18.9 8 L21.9 9.2'/%3E%3Cpath d='M18.9 13.1 L15.9 14.25 L16.4 17.4 M21.9 14.8 L18.9 16 L19.4 19.2'/%3E%3Cpath d='M7.6 17.4 L8.1 14.25 L5.1 13.1 M4.6 19.2 L5.1 16 L2.1 14.8'/%3E%3Cpath d='M5.1 10.9 L8.1 9.75 L7.6 6.6 M2.1 9.2 L5.1 8 L4.6 4.8'/%3E%3C/svg%3E");
        }

        .weather-icon.rain {
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M16 13v8'%3E%3C/path%3E%3Cpath d='M8 13v8'%3E%3C/path%3E%3Cpath d='M12 15v8'%3E%3C/path%3E%3Cpath d='M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25'%3E%3C/path%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M16 13v8'%3E%3C/path%3E%3Cpath d='M8 13v8'%3E%3C/path%3E%3Cpath d='M12 15v8'%3E%3C/path%3E%3Cpath d='M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25'%3E%3C/path%3E%3C/svg%3E");
        }

        /* 2. 霧 (Fog) - 預防之後遇到霧天也變方塊 */
        .weather-icon.fog {
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M5 6h14M4 10h16M6 14h12M4 18h16'%3E%3C/path%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M5 6h14M4 10h16M6 14h12M4 18h16'%3E%3C/path%3E%3C/svg%3E");
        }

        /* 3. 雷雨 (Lightning) - 預防遇到雷雨變方塊 */
        .weather-icon.lightning {
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9'%3E%3C/path%3E%3Cpolyline points='13 11 9 17 15 17 11 23'%3E%3C/polyline%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9'%3E%3C/path%3E%3Cpolyline points='13 11 9 17 15 17 11 23'%3E%3C/polyline%3E%3C/svg%3E");
        }

        /* Day 2: 計時器/碼表圖示 (Timer) */
        .alert-icon.time {
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='13' r='8'%3E%3C/circle%3E%3Cpath d='M12 9v4l2 2'%3E%3C/path%3E%3Cpath d='M5 3 2 6'%3E%3C/path%3E%3Cpath d='m22 6-3-3'%3E%3C/path%3E%3Cpath d='M12 2v4'%3E%3C/path%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='13' r='8'%3E%3C/circle%3E%3Cpath d='M12 9v4l2 2'%3E%3C/path%3E%3Cpath d='M5 3 2 6'%3E%3C/path%3E%3Cpath d='m22 6-3-3'%3E%3C/path%3E%3Cpath d='M12 2v4'%3E%3C/path%3E%3C/svg%3E");
        }

        /* Day 3: 溫泉/熱氣圖示 (Hot Springs) */
        .alert-icon.onsen {
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 20a4 4 0 1 1 0-8 4 4 0 0 1 0 8z'%3E%3C/path%3E%3Cpath d='M8 8c0-2.5 2-3 2-3s2 0.5 2 3'%3E%3C/path%3E%3Cpath d='M12 6c0-2.5 2-3 2-3s2 0.5 2 3'%3E%3C/path%3E%3Cpath d='M16 8c0-2.5 2-3 2-3s2 0.5 2 3'%3E%3C/path%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 20a4 4 0 1 1 0-8 4 4 0 0 1 0 8z'%3E%3C/path%3E%3Cpath d='M8 8c0-2.5 2-3 2-3s2 0.5 2 3'%3E%3C/path%3E%3Cpath d='M12 6c0-2.5 2-3 2-3s2 0.5 2 3'%3E%3C/path%3E%3Cpath d='M16 8c0-2.5 2-3 2-3s2 0.5 2 3'%3E%3C/path%3E%3C/svg%3E");
        }

        .event.optimized {
            border-left: 2px solid var(--secondary);
            padding-left: 28px;
            margin-left: -8px;
            background-color: #FFFDF5;
            padding-top: 5px;
            padding-bottom: 5px;
            border-radius: 4px;
        }

        /* AI Features Styles (Integrated) */
        .btn-ai-guide {
            background: linear-gradient(90deg, #8B5CF6, #EC4899);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            font-weight: 600;
        }

        .btn-ai-guide:active {
            transform: scale(0.95);
        }

        .btn-ai-guide svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        /* New Style for Replay Button (Blue Theme) */
        .btn-ai-play {
            background: linear-gradient(135deg, #2563EB, #3B82F6);
            /* Blue Gradient */
            color: white;
            border: none;
            /* Icon Only Style */
            width: 40px;
            height: 40px;
            border-radius: 50%;
            padding: 0;
            display: inline-flex;
            justify-content: center;
            align-items: center;

            cursor: pointer;
            margin-top: 10px;
            box-shadow: 0 2px 5px rgba(37, 99, 235, 0.2);
            transition: transform 0.2s;
        }

        .btn-ai-play:active {
            transform: scale(0.95);
        }

        .btn-ai-play svg {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* Weather Tab Specific Styles */
        .weather-search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .weather-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            font-size: 1rem;
            outline: none;
        }

        .weather-input:focus {
            border-color: var(--primary);
        }

        .btn-weather-search {
            background: #5A92E8;
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .weather-card-main {
            background: linear-gradient(135deg, #60A5FA, #2563EB);
            color: white;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
            position: relative;
            overflow: hidden;
        }

        .weather-card-main::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 60%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .wc-temp-big {
            font-size: 4rem;
            font-weight: 700;
            line-height: 1;
            margin: 10px 0;
            position: relative;
            z-index: 1;
        }

        .wc-loc {
            font-size: 1.5rem;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        /* Add flexbox to center content and icon */
        .wc-desc {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* New: Mini Icon Style for Weather Tab */
        .icon-mini {
            width: 18px;
            height: 18px;
            vertical-align: text-bottom;
            margin-right: 4px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            display: inline-block;
        }

        .weather-compare-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .wc-mini-card {
            flex: 1;
            background: white;
            padding: 15px;
            border-radius: 16px;
            border: 1px solid #E5E7EB;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .wc-mini-title {
            font-size: 0.85rem;
            color: #6B7280;
            margin-bottom: 5px;
        }

        .wc-mini-temp {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1F2937;
        }

        .wc-diff-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-top: 5px;
        }

        .wc-diff-hot {
            background: #FEE2E2;
            color: #DC2626;
        }

        .wc-diff-cold {
            background: #DBEAFE;
            color: #1D4ED8;
        }

        .advice-box {
            background: #F0FDF4;
            border: 1px solid #BBF7D0;
            padding: 15px;
            border-radius: 16px;
            color: #166534;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        /* 新增：自定義彈出視窗 (Modal) 樣式 - 取代原生 alert/prompt */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
            animation: fadeIn 0.2s;
            cursor: pointer;
            /* [新增] 這行是關鍵！讓手機知道背景可點擊 */
        }

        .modal-box {
            /* [修改] 改為偏白毛玻璃質感 */
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            /* 支援 iOS Safari */
            border: 1px solid rgba(255, 255, 255, 0.6);
            /* 玻璃邊緣反光感 */

            width: 90%;
            max-width: 320px;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            /* 加深陰影增加層次 */
            text-align: center;
            transform: scale(0.95);
            animation: popIn 0.2s forwards;
        }

        @keyframes popIn {
            to {
                transform: scale(1);
            }
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #1F2937;
        }

        .modal-desc {
            font-size: 0.9rem;
            color: #4B5563;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .modal-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
            outline: none;
        }

        .modal-input:focus {
            border-color: var(--primary);
        }

        .modal-btns {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-cancel {
            background: #F3F4F6;
            color: #4B5563;
        }

        .btn-confirm {
            background: var(--primary);
            color: white;
        }

        /* AI Container Styles */
        .ai-header {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: #4B5563;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 2px solid #E5E7EB;
            padding-bottom: 10px;
        }

        /* Chat History Box (Replaces old result box) */
        .chat-history {
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 16px;
            padding: 16px;
            min-height: 200px;
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        /* Chat Bubbles */
        .chat-row {
            display: flex;
            width: 100%;
            animation: slideIn 0.2s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-row.user {
            justify-content: flex-end;
        }

        .chat-row.ai {
            justify-content: flex-start;
        }

        .chat-bubble {
            max-width: 85%;
            padding: 12px 16px;
            font-size: 1rem;
            line-height: 1.6;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .chat-bubble.user {
            background: var(--primary);
            color: white;
            border-radius: 18px 18px 4px 18px;
        }

        .chat-bubble.ai {
            background: white;
            border: 1px solid #E5E7EB;
            color: #374151;
            border-radius: 18px 18px 18px 4px;
        }

        .chat-bubble strong {
            font-weight: 600;
        }

        .chat-bubble.ai strong {
            color: var(--primary);
        }

        /* Inline Audio Button in Bubble */
        .btn-audio-inline {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: #E0F2FE;
            color: var(--primary);
            border-radius: 50%;
            border: none;
            cursor: pointer;
            vertical-align: middle;
            margin-left: 8px;
            transition: transform 0.2s;
        }

        .btn-audio-inline:active {
            transform: scale(0.9);
            background: #BAE6FD;
        }

        .btn-audio-inline svg {
            width: 16px;
            height: 16px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* Updated Input Area Layout */
        .ai-input-wrapper {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        /* New: Voice Language Toggle */
        .voice-lang-switch {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: -5px;
            padding: 0 5px;
            font-size: 0.85rem;
            color: #4B5563;
        }

        .lang-option {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 6px 12px;
            /* 加大一點點擊範圍 */
            border-radius: 20px;
            /* 圓角更明顯 */
            border: 1px solid transparent;
            /* 預留邊框空間 */
            transition: all 0.2s;
            background: #fff;
        }

        .lang-option:hover {
            background: #F3F4F6;
        }

        /* 隱藏原生 radio，改用樣式控制 */
        .lang-option input {
            display: none;
        }

        /* 選中時的樣式 */
        .lang-option:has(input:checked) {
            background: #EFF6FF;
            border-color: var(--primary);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        /* 國旗 SVG 樣式 - 改為圓形簡約風 */
        .flag-icon {
            width: 24px;
            /* 正方形 */
            height: 24px;
            /* 正方形 */
            border-radius: 50%;
            /* 圓形 */
            object-fit: cover;
            display: block;
            /* 移除陰影，改用 SVG 內部邊框，更扁平 */
        }

        /* Mobile: Prevent Zoom on Input */
        .ai-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            outline: none;
            font-size: 16px;
            /* 16px prevents iOS zoom */
            transition: border-color 0.2s;
        }

        .ai-input:focus {
            border-color: #3b82f6;
        }

        .ai-actions-row {
            display: flex;
            gap: 8px;
            width: 100%;
        }

        .btn-mode {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.95rem;
            transition: transform 0.1s, opacity 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            min-height: 48px;
            /* Ensure touch target size */
            /* Mobile touch fix: Prevent text selection/callout on long press */
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }

        .btn-mode:active {
            transform: scale(0.96);
            opacity: 0.9;
        }

        .btn-mode svg {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .btn-mode.consult {
            background: linear-gradient(135deg, #1D4ED8, #3B82F6);
        }

        .btn-mode.trans {
            background: linear-gradient(135deg, #0EA5E9, #38BDF8);
        }

        .btn-mode.voice {
            background: linear-gradient(135deg, #06B6D4, #22D3EE);
        }

        .btn-mode.voice.recording {
            background: linear-gradient(135deg, #EF4444, #F87171);
            animation: pulse 1.5s infinite;
        }

        /* [新增] 相機按鈕樣式 */
        .btn-mode.camera {
            background: linear-gradient(135deg, #8B5CF6, #D946EF);
        }

        /* 隱藏原本的檔案上傳 Input，改用按鈕觸發 */
        #img-upload-input {
            display: none;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .btn-ai-reset {
            background: #F3F4F6;
            color: #6B7280;
            border: 1px solid #D1D5DB;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-bottom: 15px;
            display: none;
            align-self: flex-end;
            width: 100%;
            /* Full width on mobile usually better for back buttons */
            text-align: center;
        }

        .btn-ai-reset:hover {
            background: #E5E7EB;
        }

        .loading-bubble {
            color: #9CA3AF;
            font-style: italic;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .loading-dots:after {
            content: ' .';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: ' .';
            }

            40% {
                content: ' ..';
            }

            60% {
                content: ' ...';
            }

            80%,
            100% {
                content: ' ....';
            }
        }

        /* [新增] SVG Sprite 通用樣式 */
        .icon-sprite {
            width: 100%;
            height: 100%;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* Mobile Optimization - 修正後的完整手機版設定 */
        @media (max-width: 600px) {
            .container {
                padding: 15px 12px;
            }

            /* Header 調整 */
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .header-title-area h1 {
                font-size: 1.5rem;
                white-space: normal;
                line-height: 1.3;
            }

            /* 天氣區塊容器：縮小間距 */
            .header-weather-box {
                width: 100%;
                justify-content: space-between;
                padding: 10px 8px;
                /*15px*/
                border-radius: 12px;
                background: rgba(255, 255, 255, 0.15);
                min-height: auto;
                flex-wrap: wrap;
                gap: 5px;
                /* [修正] 間距縮小 */
            }

            /* 1. 左側：我的位置 (修正寬度) */
            .hw-col-my-loc {
                padding-right: 8px;
                margin-right: 0;
                border-right: 1px solid rgba(255, 255, 255, 0.2);
                min-width: auto;
                flex-shrink: 0;
                white-space: nowrap;
            }

            /* 2. 中間：目的地 (關鍵修正：填滿剩餘空間) */
            .hw-col-loc {
                flex: 1;
                /* [關鍵] 自動填滿中間剩餘所有空間 */
                min-width: 0;
                /* [關鍵] 允許內容壓縮，防止撐破 */
                border: none;
                padding: 0 4px;
                text-align: left;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            .hw-col-loc .hw-loc {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                /* 文字太長變 ... */
                font-size: 1rem;
                /* [新增] 手機版字體縮小一點 (原本是 1.1rem)，避免長地名擠壓 */
            }

            /* 3. 右側：天氣 (關鍵修正：不准搶空間) */
            .hw-col-main {
                flex: 0 0 auto;
                /* [關鍵] 固定寬度，不准自動變大 */
                padding: 0;
                /* [關鍵] 移除內距 */
                justify-content: flex-end;
                gap: 5px;
            }

            /* 底部建議文字 */
            .hw-col-advice {
                display: block;
                width: 100%;
                border-left: none;
                border-top: 1px solid rgba(255, 255, 255, 0.3);
                padding-left: 0;
                padding-top: 8px;
                max-width: none;
                min-height: auto;
                font-size: 0.8rem;
                line-height: 1.4;
                margin-top: 5px;
            }

            /* 其他手機版優化 */
            .timeline {
                padding-left: 15px;
                padding-right: 5px;
            }

            .event {
                padding-left: 15px;
            }

            .event::before {
                left: -6px;
            }

            .ai-actions-row {
                gap: 8px;
            }

            .btn-mode {
                padding: 10px 4px;
                font-size: 0.8rem;
                flex-direction: column;
                gap: 6px;
                line-height: 1.2;
                height: 70px;
            }

            .btn-mode svg {
                width: 24px;
                height: 24px;
                margin-bottom: 0;
            }

            .price-table {
                font-size: 0.85rem;
            }
        }

        /* [最終修正] 強制限制 AI 按鈕圖示大小 */
        .btn-mode .icon-sprite {
            width: 24px !important;
            height: 24px !important;
            margin-bottom: 5px;
            flex-shrink: 0;
        }

        /* [修改] 2D 高效能滑動引擎樣式 (High Performance Slide) */

        body {
            overflow-x: hidden;
            /* 移除 perspective，改為平面滑動 */
        }

        .container {
            /* 💡 [優化] 強制開啟 GPU 硬體加速，減少閃爍 */
            transform: translate3d(0, 0, 0);
            will-change: transform, opacity;

            /* 保持隱藏背面的設定，雖然是 2D 但可以防止渲染錯誤 */
            backface-visibility: hidden;
        }

        /* 2. 手指拖曳中 (絕對跟隨，無延遲) */
        .container.is-dragging {
            transition: none !important;
            cursor: grabbing;
        }

        /* 3. 放手後的慣性動畫 (使用您指定的 Bezier 曲線) */
        .container.is-animating {
            /* 💡 [優化] 使用 cubic-bezier(0.23, 1, 0.32, 1) 讓回彈更自然 */
            transition: transform 0.25s cubic-bezier(0.23, 1, 0.32, 1),
                opacity 0.25s ease !important;
        }

        /* 輔助：當頁面被隱藏時的狀態 */
        .container.page-hidden {
            display: none;
        }

        /* [新增] 圖片點擊放大 (Lightbox) 樣式 */
        .lightbox-overlay {
            display: none;
            /* 預設隱藏 */
            position: fixed;
            z-index: 10000;
            /* 最高層級，蓋過所有按鈕 */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            /* 深黑背景 */
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.2s;
        }

        .lightbox-content {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
            /* [修改] 移除 transition 以實現即時跟手效果 */
            /* transform: scale(1); */

            /* [新增] 游標變更與觸控優化 */
            cursor: grab;
            touch-action: none;
            /* 關鍵：防止手機滑動時觸發瀏覽器換頁或捲動 */
            transform-origin: center center;
            will-change: transform;
            /* 效能優化 */
        }

        .lightbox-content:active {
            cursor: grabbing;
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 25px;
            color: #fff;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10001;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* [新增] PWA 啟動過場畫面 (Splash Screen) */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #FAF0E6;
            /* 必須與您的 theme-color 一致 */
            z-index: 99999;
            /* 確保蓋在所有內容最上面 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.6s ease-out, visibility 0.6s;
        }

        /* 讓過場畫面消失的狀態 */
        #splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            /* 穿透點擊 */
        }

        /* 中間的飛機圖示 */
        .splash-logo {
            width: 120px;
            /* 可依需求調整大小 */
            height: 120px;
            margin-bottom: 20px;
            /* 這裡可以加動畫，例如輕微浮動 */
            animation: floatPlane 3s ease-in-out infinite;
        }

        /* 下方的文字 */
        .splash-text {
            color: #4B5563;
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: 2px;
            opacity: 0.9;
        }

        /* 簡單的浮動動畫 */
        @keyframes floatPlane {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        /* --- [新增] 住宿頁面優化樣式 Start --- */
        .stay-card-grid {
            display: grid;
            gap: 12px;
            font-size: 0.95rem;
        }

        .stay-row {
            display: grid;
            grid-template-columns: 85px 1fr;
            align-items: center;
            gap: 10px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #E5E7EB;
        }

        .stay-row:last-child {
            border-bottom: none;
        }

        .stay-label {
            color: #6B7280;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* 地址與 MapCode 的顯示區塊 */
        .stay-val {
            font-weight: 600;
            color: #1F2937;
            word-break: break-all;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        /* 複製按鈕 */
        .btn-copy-small {
            background: white;
            border: 1px solid #D1D5DB;
            color: #4B5563;
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 6px;
            cursor: pointer;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .btn-copy-small:active {
            transform: scale(0.95);
            background: #F3F4F6;
        }

        .btn-copy-small.copied {
            border-color: #10B981;
            color: #059669;
            background: #ECFDF5;
        }

        /* 底部大導航按鈕 */
        .btn-nav-large {
            width: 100%;
            background: linear-gradient(135deg, #2563EB, #1D4ED8);
            color: white;
            font-size: 1rem;
            font-weight: 700;
            padding: 14px;
            border-radius: 12px;
            border: none;
            text-decoration: none;
            /* 移除底線 */
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
            transition: transform 0.2s;
        }

        .btn-nav-large:active {
            transform: scale(0.98);
        }

        /* MapCode 專用樣式 */
        .map-code-box {
            font-family: 'Roboto Mono', monospace;
            color: #D97706;
            background: #FFFBEB;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #FCD34D;
            letter-spacing: 1px;
        }

        /* --- [新增] 住宿頁面優化樣式 End --- */
        /* --- [新增] 詳細天氣 Modal 樣式 --- */
        /* 請確認並修改 .weather-detail-scroll 的內容 */
        .weather-detail-scroll {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding: 10px 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;

            /* 👇 這是原本就有的，確保 iOS 滑動順暢 */
            -webkit-overflow-scrolling: touch;

            /* 👇 [新增] 限制捲動行為，防止連鎖反應帶動父層 */
            overscroll-behavior-x: contain;

            /* 👇 [新增] 讓滑鼠游標變更，提示可抓取 */
            cursor: grab;
        }

        /* --- [修改] Modal 頭部按鈕群組樣式 (對齊與防衝突) --- */
        .modal-header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            /* 按鈕之間的間距 */
        }

        /* 統一定義重整與關閉按鈕的大小與外觀 */
        /* 統一定義重整與關閉按鈕 (透明背景版) */
        .btn-header-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;

            background-color: transparent;
            /* 背景透明 */

            border: none;
            color: #4B5563;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;

            /* 強制設定 */
            position: static !important;
            margin: 0 !important;
        }

        .btn-header-icon svg {
            width: 24px;
            height: 24px;
            stroke-width: 2;
        }

        /* --- [修改] Modal 頭部按鈕群組樣式 (對齊與防衝突) --- */
        .modal-header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            /* 按鈕之間的間距 */
        }


        .btn-header-icon:active {
            background-color: #E5E7EB;
            transform: scale(0.92);
        }

        .btn-header-icon svg {
            width: 20px;
            height: 20px;
            stroke-width: 2.5;
        }

        /* 確保 Modal 內部捲動時不觸發底層翻頁 (CSS 輔助) */
        #weather-detail-modal .modal-box {
            overscroll-behavior: contain;
            /* 防止捲動鍊溢出 */
        }

        /* (同時建議在下方加入這行，隱藏醜醜的捲軸但保留功能) */
        .weather-detail-scroll::-webkit-scrollbar {
            display: none;
        }

        /* [修改] 小時預報排版：時間 -> Icon -> 狀態 -> 氣溫 */
        .wd-hour-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 60px;
            /* 稍微加寬以容納文字 */
            font-size: 0.85rem;
            color: #4B5563;
            gap: 4px;
            /* 元素間距 */
            padding: 5px 0;
        }

        .wd-hour-time {
            font-size: 0.85rem;
            opacity: 0.9;
            font-weight: 500;
        }

        .wd-hour-icon svg {
            width: 28px;
            /* Icon稍微放大 */
            height: 28px;
        }

        /* [新增] 天氣狀態文字 (如: 降雪, 多雲) */
        .wd-hour-desc {
            font-size: 0.75rem;
            color: #6B7280;
            font-weight: 500;
            white-space: nowrap;
            /* 不換行 */
        }

        .wd-hour-temp {
            font-weight: 700;
            color: #1F2937;
            font-size: 1.1rem;
            /* 氣溫放大 */
        }

        /* 隱藏原本的降雨機率 */
        .wd-hour-pop {
            display: none;
        }

        /* --- [修改] 未來預報列表優化 (垂直日期 + 固定圖示寬度) --- */
        .wd-daily-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            /* 增加間距讓手指好點 */
            border-bottom: 1px dashed #eee;
            font-size: 0.95rem;
        }

        /* 1. 日期欄位：改為垂直排列 (今天在上，日期在下) */
        .wd-day-name {
            width: 60px;
            font-weight: 600;
            color: #374151;
            display: flex;
            flex-direction: column;
            /* 關鍵：讓文字換行排列 */
            justify-content: center;
            line-height: 1.2;
        }

        .wd-day-name span {
            font-size: 0.75rem;
            color: #999;
            font-weight: 400;
            margin-top: 2px;
        }

        /* 2. 圖示欄位：強制固定大小，防止被擠扁 */
        .wd-day-icon {
            width: 48px;
            height: 32px;
            text-align: center;
            flex-shrink: 0;
            /* [關鍵修正] 禁止瀏覽器壓縮此區塊 */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .wd-day-icon svg {
            width: 32px;
            height: 32px;
            /* 移除預設顏色，改由 SVG 內部的漸層控制 */
        }

        /* 3. 降雨機率：移除水滴圖示，只留數字，改為靠左 */
        .wd-day-pop {
            width: 45px;
            font-size: 0.8rem;
            color: #60A5FA;
            /* 淺藍色 */
            font-weight: 600;
            text-align: left;
            margin-left: 6px;
        }

        /* 4. 氣溫：改為 Flex 佈局 + 固定寬度，解決對齊問題 */
        .wd-day-temp {
            flex: 1;
            display: flex;
            /* [修改] 啟用 Flexbox */
            justify-content: flex-end;
            /* [修改] 整體靠右 */
            gap: 10px;
            /* [修改] 低溫與高溫之間的固定間距 */
            font-family: monospace;
            font-weight: 600;
        }

        /* [新增] 設定固定寬度讓數字垂直對齊成兩列 */
        .wd-temp-low,
        .wd-temp-high {
            display: inline-block;
            width: 36px;
            /* [關鍵] 強制固定寬度，創造隱形欄位 */
            text-align: right;
            /* [關鍵] 數字在欄位內靠右對齊 */
        }

        .wd-temp-low {
            color: #9CA3AF;
        }

        /* 低溫維持淺灰 */

        /* [修改] 高溫 - 改用較柔和的深灰色 (#4B5563)，避免與低溫對比過強 */
        .wd-temp-high {
            display: inline-block;
            width: 36px;
            text-align: right;
            color: #4B5563;
            /* 原本是 #1F2937 (太深)，現在改淡一點 */
        }

        /* [新增] 即時天氣儀表板樣式 */
        .cw-container {
            margin-bottom: 20px;
            text-align: left;
            padding: 0 5px;
        }

        /* 上半部：大溫度與狀態 */
        .cw-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .cw-temp-big {
            font-size: 3.5rem;
            font-weight: 700;
            line-height: 1;
            color: #1F2937;
            letter-spacing: -2px;
        }

        .cw-info-col {
            text-align: right;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .cw-condition {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 4px;
        }

        .cw-hl-temp {
            font-size: 0.9rem;
            color: #6B7280;
            font-family: monospace;
        }

        /* 下半部：四格資訊卡 (仿 iOS 風格) */
        .cw-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .cw-card {
            background: rgba(0, 0, 0, 0.03);
            /* [還原] 背景改回極淡灰色，配合灰色文字 */
            border-radius: 12px;
            padding: 10px 5px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 70px;
        }

        .cw-icon {
            width: 18px;
            height: 18px;
            color: #666;
            /* [修改] 圖示顏色改為 #666 (與日出標籤一致) */
            margin-bottom: 4px;
        }

        .cw-label {
            font-size: 0.75rem;
            color: #666;
            /* [關鍵修改] 標籤顏色改為 #666 (與「日出」文字顏色完全一致) */
            margin-bottom: 2px;
        }

        .cw-value {
            font-size: 0.95rem;
            font-weight: 700;
            color: #333;
            /* [修改] 數值顏色改為 #333 (與日出「時間」顏色一致) */
        }

        /* [修改] 詳細天氣資訊卡 (優化配色與水平佈局) */
        /* [修改] 詳細天氣資訊卡 (優化配色與水平佈局) */
        .astro-box {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 20px;
            /* [修改] 背景改為極淡灰色 (與上方體感資訊欄一致)，移除偏白的突兀感 */
            background: rgba(0, 0, 0, 0.03);
            padding: 15px 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            border: none;
            align-items: center;
        }

        /* 左側：日出日落區 (改為水平排列) */
        .astro-left-col {
            display: flex;
            flex-direction: row;
            /* [修改] 水平排列 */
            gap: 25px;
            /* 增加間距 */
            border-right: 1px dashed #CBD5E1;
            padding-right: 25px;
            align-items: center;
        }

        .astro-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        /* 圖示設定 */
        .astro-icon svg {
            width: 36px;
            /* 稍微再大一點點 */
            height: 36px;
            fill: none;
            stroke-width: 2.5;
            /* 線條加粗一點，解決變形感 */
            stroke-linecap: round;
            stroke-linejoin: round;
            filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.05));
        }

        .icon-sunrise {
            stroke: #cf8402;
        }

        .icon-sunset {
            stroke: #5759cf;
        }

        .astro-time {
            font-size: 0.9rem;
            font-weight: 700;
            color: #334155;
            font-family: monospace;
        }

        /* 右側：維持不變 */
        .astro-right-col {
            display: flex;
            flex-direction: column;
            gap: 8px;
            justify-content: center;
        }

        /* [修改] 溫差標籤 - 透明背景、縮小字體、不換行 */
        .diff-badge {
            display: inline-flex;
            align-items: center;
            font-size: 0.75rem;
            /* [修改] 字體縮小 (原 0.8rem) */
            font-weight: 700;
            padding: 2px 8px;
            /* [修改] 內距縮小，讓標籤更精緻 */
            border-radius: 20px;
            width: fit-content;
            white-space: nowrap;
            /* [新增] 強制文字不換行 */
        }

        /* [修改] 背景改為 transparent (透明)，只保留有顏色的邊框 */
        .diff-hot {
            background: transparent;
            color: #DC2626;
            border: 1px solid #FECACA;
        }

        .diff-cold {
            background: transparent;
            color: #2563EB;
            border: 1px solid #BFDBFE;
            /* 保留您想要的藍色邊框 */
        }

        .diff-same {
            background: transparent;
            color: #64748B;
            border: 1px solid #E2E8F0;
        }

        /* 穿衣建議文字 */
        .advice-text-small {
            font-size: 0.85rem;
            color: #334155;
            line-height: 1.5;
            text-align: left;
        }

        /* --- [新增] iOS 天氣動態特效 (仿 iPhone 天氣) --- */
        /* 1. Header 容器設定 */
        .weather-bg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            /* 關鍵修正！讓它浮在背景色之上 */
            pointer-events: none;
            /* 讓滑鼠點擊可以穿透特效，點到下面的按鈕 */
        }


        /* --- 天氣背景色 (參考您的截圖配色) --- */
        /* 晴天: 亮藍漸層 */
        header.w-sun {
            background: linear-gradient(180deg, #2980B9 0%, #6DD5FA 100%);
        }

        /* 多雲: 灰藍漸層 */
        header.w-cloud {
            background: linear-gradient(180deg, #536976 0%, #292E49 100%);
        }

        /* 雨天: 深灰藍 (參考截圖1) */
        header.w-rain {
            background: linear-gradient(180deg, #373B44 0%, #4286f4 100%);
        }

        /* 雪天: 冰霜淺藍 (參考截圖2) */
        header.w-snow {
            background: linear-gradient(180deg, #83a4d4 0%, #b6fbff 100%);
        }

        /* 霧/陰天: 迷霧灰 */
        header.w-fog {
            background: linear-gradient(180deg, #757F9A 0%, #D7DDE8 100%);
        }

        /* 晚上模式 (權重最高，覆蓋以上顏色，但保留粒子特效) */
        header.is-night {
            background: linear-gradient(180deg, #0f2027 0%, #203a43 50%, #2c5364 100%) !important;
        }

        /* [星星特效] - 僅在晴朗夜晚出現 */
        .star-particle {
            position: absolute;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 3px rgba(255, 255, 255, 0.8);
            /* 微微發光暈 */
            animation: twinkle linear infinite;
        }

        @keyframes twinkle {
            0% {
                opacity: 0.3;
                transform: scale(0.8);
            }

            50% {
                opacity: 1;
                transform: scale(1.2);
            }

            /* 變亮變大 */
            100% {
                opacity: 0.3;
                transform: scale(0.8);
            }
        }

        /* --- 粒子動畫定義 --- */
        /* [雨滴] */
        .rain-drop {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            width: 1px;
            height: 60px;
            top: -60px;
            animation: rain-fall 0.7s linear infinite;
        }

        @keyframes rain-fall {
            to {
                transform: translateY(400px);
            }
        }

        /* --- [新] 玻璃水珠特效 (Glass Rain) --- */
        /* --- [升級版] 寫實玻璃水珠特效 (Glass Rain) --- */
        .glass-surface {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            overflow: hidden;
            pointer-events: none;
        }

        .glass-drop {
            position: absolute;
            /* 1. 基底改為全透明，不依靠背景色 */
            background: transparent;

            /* 2. 複雜陰影：模擬光線折射 (Refraction) 與立體感 */
            /* 內陰影(亮) + 內陰影(暗) + 外部投影 */
            box-shadow:
                inset 2px 2px 2px rgba(255, 255, 255, 0.4),
                inset -2px -2px 5px rgba(0, 0, 0, 0.3),
                1px 2px 4px rgba(0, 0, 0, 0.3);

            /* 預設圓角，稍後 JS 會隨機微調 */
            border-radius: 50%;
        }

        /* 3. [關鍵] 增加高光反射點 (Specular Highlight) - 讓它看起來像水 */
        .glass-drop::after {
            content: '';
            position: absolute;
            top: 20%;
            left: 20%;
            width: 30%;
            height: 30%;
            /* 模擬光源反射的小白點 */
            background: radial-gradient(circle, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0) 70%);
            border-radius: 50%;
            filter: blur(0.5px);
        }

        /* [修改] 滑落的水流 (模擬拖尾水痕) - 長條漸層 */
        /* [修改] 滑落的水流 (模擬拖尾水痕) - 高透明度寫實版 */
        /* [修改] 滑落的水流 (垂錐狀 Tapered Shape) */
        .glass-drop.trickle {
            /* 1. 漸層：上方完全透明，下方半透明白 */
            background: linear-gradient(to bottom,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.1) 20%,
                    rgba(255, 255, 255, 0.5) 80%,
                    rgba(255, 255, 255, 0.8) 100%);

            /* 2. 形狀：利用 clip-path 裁切出「上窄下寬」的錐形 */
            clip-path: polygon(40% 0%, 60% 0%, 100% 100%, 0% 100%);

            /* 3. 寬度設定 */
            width: 6px;

            /* 4. 陰影：因為 clip-path 會裁掉 box-shadow，改用 filter */
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));

            /* 5. 動畫設定 */
            animation-name: rain-slide-linear;
            animation-timing-function: linear;
            animation-iteration-count: 1;

            z-index: 12;
            pointer-events: none;
        }

        /* 修正動畫位移量，因為水流變長了，需要滑得更遠 */
        @keyframes trickle-wait-drop {
            0% {
                transform: translateY(-100%) scale(1);
                opacity: 0;
            }

            50% {
                transform: translateY(-100%) scale(1);
                opacity: 1;
            }

            /* 靜止在畫面外/上方 */
            55% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            /* 慢慢流進畫面 */
            100% {
                transform: translateY(600px) scale(1);
                opacity: 0;
            }

            /* 快速滑落 */
        }

        /* [新] 被水流帶走(融合)的效果 */
        .glass-drop.merged {
            transform: scale(0.2) translateY(20px);
            /* 縮小並稍微往下被帶走 */
            opacity: 0;
            transition: all 0.3s ease-out;
            /* 0.3秒內快速消失 */
        }

        /* [新] 純滑落動畫 (給 JavaScript 控制生成的動態水流使用) */
        /* 不需要等待，生成後直接滑落，這樣方便我們計算碰撞時間 */
        @keyframes rain-slide-linear {
            0% {
                transform: translateY(-50px);
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                transform: translateY(600px);
                opacity: 0;
            }
        }

        /* [修改] 全螢幕飄落特效：同步更新雪花造型 */
        .snow-flake {
            position: absolute;
            /* 改用 stroke='white' 的版本 */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 9 L14.6 10.5 L14.6 13.5 L12 15 L9.4 13.5 L9.4 10.5 Z'/%3E%3Cpath d='M12 9 V1 M12 15 V23 M14.6 10.5 L21.5 6.5 M14.6 13.5 L21.5 17.5 M9.4 13.5 L2.5 17.5 M9.4 10.5 L2.5 6.5'/%3E%3Cpath d='M9.5 5.5 L12 7.5 L14.5 5.5 M9.5 2 L12 4 L14.5 2'/%3E%3Cpath d='M9.5 18.5 L12 16.5 L14.5 18.5 M9.5 22 L12 20 L14.5 22'/%3E%3Cpath d='M16.4 6.6 L15.9 9.75 L18.9 10.9 M19.4 4.8 L18.9 8 L21.9 9.2'/%3E%3Cpath d='M18.9 13.1 L15.9 14.25 L16.4 17.4 M21.9 14.8 L18.9 16 L19.4 19.2'/%3E%3Cpath d='M7.6 17.4 L8.1 14.25 L5.1 13.1 M4.6 19.2 L5.1 16 L2.1 14.8'/%3E%3Cpath d='M5.1 10.9 L8.1 9.75 L7.6 6.6 M2.1 9.2 L5.1 8 L4.6 4.8'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-color: transparent;
            opacity: 0.9;
            top: -20px;
            animation: snow-fall-rotate 5s linear infinite;
        }

        /* [新增] 雪花飄落 + 自轉動畫 */
        @keyframes snow-fall-rotate {
            0% {
                transform: translateY(0) translateX(0) rotate(0deg);
                opacity: 0.9;
            }

            100% {
                /* 往下掉 300px + 往右飄 20px + 自轉 360度 */
                transform: translateY(400px) translateX(30px) rotate(360deg);
                opacity: 0;
            }
        }

        /* [雲朵飄動] */
        /* [雲朵飄動 - 新版] */
        /* [霧氣特效 - 補回遺失的設定] */
        .fog-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            /* 使用漸層模擬地面升起的霧氣 */
            background: linear-gradient(to top, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0.2) 60%, transparent 100%);
            filter: blur(15px);
            /* 強力模糊，製造朦朧感 */
            animation: fog-pulse 8s infinite alternate;
            z-index: 1;
        }

        @keyframes fog-pulse {
            0% {
                opacity: 0.6;
                transform: translateY(0);
            }

            100% {
                opacity: 1;
                transform: translateY(-10px);
            }

            /* 霧氣上下浮動 */
        }

        .cloud-shape {
            position: absolute;
            width: 100px;
            height: 40px;
            background: rgba(255, 255, 255, 0.8);
            /* 提高白度，讓它更明顯 */
            border-radius: 50px;
            /* 圓角膠囊狀 */
            top: 20px;
            filter: blur(5px);
            /* 輕微柔焦就好，不要太糊 */
            animation: cloud-float linear infinite;
            z-index: 2;
            /* 確保有一點層次 */
        }

        /* 利用偽元素製作雲的凸起造型 */
        .cloud-shape::after,
        .cloud-shape::before {
            content: '';
            position: absolute;
            background: inherit;
            border-radius: 50%;
        }

        .cloud-shape::after {
            width: 45px;
            height: 45px;
            top: -25px;
            left: 15px;
        }

        .cloud-shape::before {
            width: 35px;
            height: 35px;
            top: -15px;
            left: 45px;
        }

        /* 定義雲朵從左飄到右的動畫 */
        @keyframes cloud-float {
            0% {
                left: -150px;
                opacity: 0;
            }

            10% {
                opacity: 0.8;
            }

            90% {
                opacity: 0.8;
            }

            100% {
                left: 100%;
                opacity: 0;
            }

            /* 飄出螢幕右邊 */
        }

        /* [太陽光暈] */
        /* [太陽光暈 - 強烈照射版] */
        .sun-glow {
            position: absolute;
            /* 1. 調整位置：稍微往右上角外推，模擬陽光從角落射入 */
            top: -120px;
            right: -120px;

            /* 2. 加大範圍：讓光芒覆蓋半個 Header */
            width: 300px;
            height: 300px;

            /* 3. 強化顏色：核心純白 -> 中層金黃 -> 外層透明 */
            background: radial-gradient(circle,
                    rgba(255, 255, 255, 0.95) 10%,
                    /* 核心極亮 */
                    rgba(253, 224, 71, 0.6) 35%,
                    /* 中層暖黃光 */
                    rgba(255, 255, 255, 0.1) 60%,
                    /* 外層柔光 */
                    transparent 75%);

            border-radius: 50%;
            /* 4. 增加模糊度，讓光線更柔和自然 */
            filter: blur(40px);

            /* 5. 混合模式：讓光疊加在藍色背景上更耀眼 */
            mix-blend-mode: screen;

            animation: sun-breath 5s infinite ease-in-out;
            z-index: 1;
            /* 確保在背景之上 */
            pointer-events: none;
            /* 讓點擊穿透 */
        }

        /* 加入第二層光暈 (利用偽元素)，製造光線擴散感 */
        .sun-glow::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 140%;
            height: 140%;
            /* 比本體更大 */

            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 60%);
            border-radius: 50%;
            filter: blur(20px);

            /* 獨立的呼吸動畫，錯開時間 */
            animation: sun-pulse-slow 7s infinite ease-in-out;
        }

        /* 呼吸動畫定義 */
        @keyframes sun-breath {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.7;
            }

            50% {
                transform: scale(1.15);
                opacity: 1;
            }

            /* 變大且變亮 */
        }

        @keyframes sun-pulse-slow {

            0%,
            100% {
                transform: translate(-50%, -50%) scale(0.9);
                opacity: 0.3;
            }

            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0.6;
            }
        }

        .btn-icon-circle {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-icon-circle:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.95);
        }

        .avatar-item {
            font-size: 1.8rem;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            border: 2px solid transparent;
            background: #f8fafc;
            flex-shrink: 0;
            transition: all 0.2s;
            line-height: 1;
        }

        .avatar-item.active {
            border-color: #2563EB;
            background: #EFF6FF;
            transform: scale(1.1);
        }

        /* 確保頭像項目的點擊範圍不被擠壓 */
        .avatar-item {
            /* 提高層級確保可被點擊 */
        }

        /* --- [新增] 迎賓模態框樣式 --- */
        #welcome-modal {
            display: none;
            /* 預設隱藏 */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            /* 深色背景 */
            z-index: 10000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s;
        }

        .welcome-box {
            background: white;
            width: 90%;
            max-width: 400px;
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        /* 裝飾性背景圓 */
        .welcome-box::before {
            content: '';
            position: absolute;
            top: -50px;
            right: -50px;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #FBBF24, #F59E0B);
            border-radius: 50%;
            opacity: 0.2;
            z-index: 0;
        }

        .welcome-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .welcome-desc {
            font-size: 0.95rem;
            color: #6B7280;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        /* 頭像選擇網格 */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .avatar-option {
            font-size: 2rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 12px;
            transition: transform 0.2s, background 0.2s;
            user-select: none;
        }

        .avatar-option:hover {
            background: #F3F4F6;
            transform: scale(1.1);
        }

        .avatar-option.selected {
            background: #EFF6FF;
            border: 2px solid #2563EB;
            box-shadow: 0 2px 5px rgba(37, 99, 235, 0.2);
        }

        /* 暱稱輸入框 */
        .input-nickname {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 1rem;
            text-align: center;
            margin-bottom: 20px;
            outline: none;
            transition: border-color 0.2s;
        }

        .input-nickname:focus {
            border-color: #2563EB;
        }

        .btn-start-trip {
            background: linear-gradient(135deg, #2563EB, #1D4ED8);
            color: white;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
            transition: transform 0.1s;
        }

        .btn-start-trip:active {
            transform: scale(0.98);
        }

        /* --- [新增] 使用者狀態顯示區 (替代原本的輸入框) --- */
        .user-status-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            padding: 8px 12px;
            border-radius: 12px;
            border: 1px solid #E5E7EB;
            margin-bottom: 15px;
            cursor: pointer;
            /* 讓使用者知道可以點擊 */
            transition: background 0.2s;
        }

        .user-status-card:active {
            background: #F9FAFB;
        }

        .user-info-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .current-avatar {
            font-size: 2rem;
            background: #F3F4F6;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .current-user-text {
            display: flex;
            flex-direction: column;
        }

        .current-user-label {
            font-size: 0.75rem;
            color: #6B7280;
            font-weight: 500;
        }

        .current-user-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1F2937;
        }

        .btn-switch-user {
            background: #EFF6FF;
            color: #2563EB;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* --- [新增] 登出確認彈窗 --- */
        .logout-box {
            text-align: center;
        }

        .logout-avatar {
            font-size: 3rem;
            margin-bottom: 10px;
            display: block;
        }
    </style>
</head>

<body>
    <div id="splash-screen">
        <img src="icon-512.png" alt="App Logo" class="splash-logo">
        <div class="splash-text">東京小旅行</div>
    </div>


    <svg style="display: none;">
        <defs>
            <symbol id="icon-schedule" viewBox="0 0 24 24">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </symbol>

            <symbol id="icon-stay" viewBox="0 0 24 24">
                <path
                    d="M7 13c1.66 0 3-1.34 3-3S8.66 7 7 7s-3 1.34-3 3 1.34 3 3 3zm12-6h-8v7H3V5H1v15h2v-3h18v3h2v-9c0-2.21-1.79-4-4-4z">
                </path>
            </symbol>

            <symbol id="icon-car" viewBox="0 0 24 24">
                <path
                    d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2" />
                <circle cx="7" cy="17" r="2" />
                <circle cx="17" cy="17" r="2" />
                <path d="M5 17h2" />
                <path d="M15 17h2" />
            </symbol>

            <symbol id="icon-info" viewBox="0 0 24 24">
                <path
                    d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5" />
                <path d="M9 18h6" />
                <path d="M10 22h4" />
            </symbol>

            <symbol id="icon-weather" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="5"></circle>
                <path
                    d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42">
                </path>
            </symbol>

            <symbol id="icon-ai" viewBox="0 0 24 24">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z">
                </path>
            </symbol>
            <symbol id="icon-consult" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon>
            </symbol>

            <symbol id="icon-trans" viewBox="0 0 24 24">
                <path d="M7 10h14"></path>
                <path d="M17 6l4 4-4 4"></path>
                <path d="M17 14H3"></path>
                <path d="M7 18l-4-4 4-4"></path>
            </symbol>

            <symbol id="icon-voice" viewBox="0 0 24 24">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </symbol>

            <symbol id="icon-camera" viewBox="0 0 24 24">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                <circle cx="12" cy="13" r="4"></circle>
            </symbol>

            <symbol id="icon-loc" viewBox="0 0 24 24">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
            </symbol>
            <symbol id="icon-earth" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="2" y1="12" x2="22" y2="12"></line>
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z">
                </path>
            </symbol>

            <symbol id="icon-temp" viewBox="0 0 24 24">
                <path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"></path>
            </symbol>

            <symbol id="icon-shirt" viewBox="0 0 24 24">
                <path
                    d="M20.38 3.46L16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z">
                </path>
            </symbol>

            <symbol id="icon-reset" viewBox="0 0 24 24">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </symbol>

            <symbol id="icon-nav-arrow" viewBox="0 0 24 24">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
            </symbol>
        </defs>
    </svg>
    <header>
        <div id="weather-effect-layer" class="weather-bg-layer"></div>

        <div class="header-content">

            <div class="header-title-area">
                <div class="header-title-area">
                    <h1>東京貴婦充電之旅
                        <button class="btn-app-refresh" onclick="window.location.reload()" title="重新整理">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M23 4v6h-6"></path>
                                <path d="M1 20v-6h6"></path>
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                            </svg>
                        </button>
                    </h1>
                    <div class="subtitle">2026/04/18 - 04/20 (3天2夜)</div>
                    <div class="badge-trip">偽單身小旅行 / 羽田進 • 成田出</div>
                </div>
            </div>

            <!-- 天氣資訊盒 (擺放在右側，三欄式設計) -->
            <div class="header-weather-box" id="header-weather">

                <div class="hw-col-my-loc" id="hw-my-loc-box" onclick="getLocalWeather()">
                    <div class="hw-sub-label">
                        <svg class="icon-mini" style="width:12px;height:12px;vertical-align:text-top;">
                            <use href="#icon-nav-arrow"></use>
                        </svg>
                        我的位置
                    </div>
                    <div class="hw-my-data">
                        <span id="header-my-loc">定位中..</span>
                        <span id="header-my-temp" style="color: var(--secondary);">--</span>
                    </div>
                </div>

                <div class="hw-col-loc" onclick="openDetailedWeatherModal()" style="cursor: pointer;">
                    <span class="hw-loc" id="hw-loc">定位中...</span>
                    <span class="hw-date" id="hw-date">現在位置</span>
                    <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 2px;">
                        點擊查看詳情 ▼
                    </div>
                </div>
                <div class="hw-col-main">
                    <div class="hw-icon" id="hw-icon">
                        <div class="weather-icon cloud"></div>
                    </div>
                    <div class="hw-temp-group">
                        <div class="hw-temp" id="hw-temp">--°</div>
                        <span class="hw-desc" id="hw-desc">讀取中</span>
                        <span class="hw-range" id="hw-range"></span>
                    </div>
                </div>
                <div class="hw-col-advice" id="hw-advice">
                    正在讀取當地天氣資訊...
                </div>
            </div>
        </div>
    </header>

    <!-- TAB 1: 行程表 -->
    <div id="view-schedule" class="container active">
        <div class="card" style="border-left: 5px solid #F59E0B; margin-bottom: 20px;">
            <div class="card-header checklist-card-header" onclick="toggleChecklist(this)">
                <div class="card-title" style="display: flex; align-items: center; gap: 6px;">
                    <svg class="icon-mini" style="color: #F59E0B;" viewBox="0 0 24 24">
                        <path d="M9 11l3 3L22 4"></path>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                    </svg>
                    行前準備 Check List
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button onclick="resetChecklist(event)"
                        style="border:none; background:none; color:#9CA3AF; font-size:0.8rem; cursor:pointer; text-decoration:underline;">
                        ↺ 重置
                    </button>
                    <div class="tag tag-tip" id="checklist-progress"
                        style="background:#FFFBEB; color:#D97706; font-weight:700;">計算中...</div>
                    <div class="toggle-icon"
                        style="font-size: 0.8rem; color: #6B7280; font-weight: 700; transition: transform 0.3s;">▼</div>
                </div>
            </div>

            <div id="checklist-container" class="checklist-container">
                <div class="add-item-box" onclick="event.stopPropagation()">
                    <input type="text" id="new-item-input" class="input-add-item" placeholder="新增準備項目...">
                    <button class="btn-add-item" onclick="addNewCheckItem()">＋</button>
                </div>
                <div class="checklist-grid" id="checklist-list-area"></div>
            </div>
        </div>

        <!-- [新增] 公告跑馬燈 (僅在行程表分頁顯示) -->
        <div id="announcement-marquee" style="
            display: none;
            background: #FFFBEB;
            border-left: 5px solid #F59E0B;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 10px 15px;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            overflow: hidden;
            white-space: nowrap;
            position: relative;
            font-size: 0.9rem;
            -webkit-text-size-adjust: 100%;
        ">
            <div style="
                flex-shrink: 0;
                margin-right: 15px;
                font-weight: 700;
                color: #B45309;
                display: flex;
                align-items: center;
                gap: 6px;
                z-index: 2;
                background: #FFFBEB;
                padding-right: 10px;
                box-shadow: 5px 0 5px -2px rgba(255, 251, 235, 0); 
            ">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="#FDE68A" stroke="#F59E0B" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
                公告
            </div>
            <div
                style="flex: 1; overflow: hidden; position: relative; mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);">
                <div id="marquee-content" style="
                    display: inline-block;
                    padding-left: 100%;
                    animation: marquee 15s linear infinite;
                    animation: marquee 15s linear infinite;
                ">
                    <!-- Javascript will populate this -->
                </div>
            </div>
        </div>


        <!-- Day 1 -->
        <div class="day-wrapper">
            <div class="day-toggle" id="toggle-d1" onclick="toggleTimeline('d1', this)">
                <div class="day-info">
                    <h3>Day 1: 煥然一新，擁抱東京鐵塔</h3>
                    <span>4/18 (六) • 住宿: The Prince Park Tower Tokyo</span>
                </div>
                <div class="toggle-icon">▼</div>
            </div>
            <div id="d1" class="timeline">
                <div class="event">
                    <div class="time">04:25</div>
                    <div class="activity">抵達羽田機場 (HND) & 泉天空之湯</div>
                    <div class="desc">
                        <b>【優雅對策】</b>下機後直接前往羽田機場花園的「泉天空之湯」。<br>
                        24小時溫泉，消除水腫、洗頭化妝，休息到早上 8:30 再出發。這才是貴婦的節奏。
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Izumi+Tenku+no+Yu+Haneda+Airport"
                        target="_blank" class="btn-map">導航</a>
                    <div class="tags"><span class="tag tag-relax">放鬆</span><span class="tag tag-spot">溫泉</span></div>
                </div>
                <div class="event">
                    <div class="time">09:30</div>
                    <div class="activity">飯店寄放行李 & 芝公園拍照</div>
                    <div class="desc">
                        搭計程車或單軌電車前往飯店寄放行李。<br>
                        <b>拍照點：</b>芝公園 (Shiba Park)。早晨人少，可拍出與東京鐵塔的絕美合照，不用修圖掉路人。
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Shiba+Park" target="_blank"
                        class="btn-map">導航至芝公園</a>
                    <div class="tags"><span class="tag tag-spot">拍照</span><span class="tag tag-move">移動</span></div>
                </div>
                <div class="event event-meal">
                    <div class="time">11:30</div>
                    <div class="activity">午餐與逛街：表參道 (Omotesando)</div>
                    <div class="desc">
                        街道寬敞、建築美，適合街拍。<br>
                        <ul style="list-style-type: disc; padding-left: 20px;">
                            <li><b>午餐：</b>Bills 表參道 (鬆餅) 或 Ralph's Coffee (美式復古)。</li>
                            <li><b>逛街：</b>櫸木林蔭大道精品、MoMA Design Store、Le Labo 香氛。</li>
                        </ul>
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Omotesando" target="_blank"
                        class="btn-map">導航</a>
                    <div class="tags"><span class="tag tag-food">早午餐</span><span class="tag tag-shop">時尚</span></div>
                </div>
                <div class="event">
                    <div class="time">15:30</div>
                    <div class="activity">飯店 Check-in & 下午茶</div>
                    <div class="desc">
                        回到飯店辦理入住。房間最有名的就是「窗外的東京鐵塔」。<br>
                        利用自然光在窗邊瘋狂拍照。這段時間是最珍貴的放空時光。
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=The+Prince+Park+Tower+Tokyo"
                        target="_blank" class="btn-map">導航至飯店</a>
                    <div class="tags"><span class="tag tag-stay">飯店</span><span class="tag tag-relax">放空</span></div>
                </div>
                <div class="event event-meal">
                    <div class="time">18:30</div>
                    <div class="activity">晚餐：麻布台之丘 (Azabudai Hills)</div>
                    <div class="desc">
                        東京最新地標，離飯店很近。挑選一家景觀餐廳晚餐，飯後欣賞充滿設計感的建築與夜景。
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Azabudai+Hills" target="_blank"
                        class="btn-map">導航</a>
                    <div class="tags"><span class="tag tag-food">晚餐</span><span class="tag tag-spot">夜景</span></div>
                </div>
            </div>
        </div>

        <!-- Day 2 -->
        <div class="day-wrapper">
            <div class="day-toggle" id="toggle-d2" onclick="toggleTimeline('d2', this)">
                <div class="day-info">
                    <h3>Day 2: 質感散策，代官山與澀谷</h3>
                    <span>4/19 (日) • 住宿: The Prince Park Tower Tokyo</span>
                </div>
                <div class="toggle-icon">▼</div>
            </div>
            <div id="d2" class="timeline">
                <div class="event">
                    <div class="time">09:30</div>
                    <div class="activity">早餐與晨間散步</div>
                    <div class="desc">
                        睡飽一點，在飯店享用早餐，或去附近的 <b>Le Pain Quotidien</b> 吃歐式麵包。
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Le+Pain+Quotidien+Shiba+Park"
                        target="_blank" class="btn-map">導航至 Le Pain Quotidien</a>
                    <div class="tags"><span class="tag tag-food">早午餐</span><span class="tag tag-relax">悠閒</span></div>
                </div>
                <div class="event">
                    <div class="time">11:00</div>
                    <div class="activity">代官山 (Daikanyama) 散策</div>
                    <div class="desc">
                        穿梭在斜坡與階梯間的優雅街區。
                        <ul style="list-style-type: disc; padding-left: 20px;">
                            <li><b>必逛：</b>蔦屋書店 (Tsutaya Books) - 森林中的圖書館，氣質擺拍。</li>
                            <li><b>購物：</b>質感選物店 (Maison de Reefur, Tenoha)。</li>
                            <li><b>看書包：</b>土屋鞄製造所 (Tsuchiya Kaban)，如果在意小學生書包可順便優雅參觀。</li>
                        </ul>
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Daikanyama+T-Site" target="_blank"
                        class="btn-map">導航至蔦屋書店</a>
                    <div class="tags"><span class="tag tag-spot">散步</span><span class="tag tag-shop">選物</span></div>
                </div>
                <div class="event">
                    <div class="time">15:00</div>
                    <div class="activity">中目黑 或 澀谷</div>
                    <div class="desc">
                        沿著舊山手通散步到中目黑，在目黑川旁喝杯咖啡。或者前往澀谷 Scramble Square。
                    </div>
                    <div class="tags"><span class="tag tag-relax">下午茶</span><span class="tag tag-move">散步</span></div>
                </div>
                <div class="event">
                    <div class="time">17:00</div>
                    <div class="activity">拍照點：SHIBUYA SKY</div>
                    <div class="desc">
                        東京最紅頂樓展望台。<b>強烈建議提前一個月預約</b>日落時段。
                        <br>在透明玻璃角落拍出懸浮在東京上空的時尚大片。
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=SHIBUYA+SKY" target="_blank"
                        class="btn-map">導航</a>
                    <div class="tags"><span class="tag tag-spot">必拍</span><span class="tag tag-spot">夕陽夜景</span></div>
                </div>
                <div class="event event-meal">
                    <div class="time">19:30</div>
                    <div class="activity">晚餐：澀谷或惠比壽</div>
                    <div class="desc">
                        找一家日式燒肉 (如 Kintan) 或居酒屋，慶祝這趟難得的姊妹旅行。
                    </div>
                    <div class="tags"><span class="tag tag-food">燒肉/居酒屋</span></div>
                </div>
            </div>
        </div>

        <!-- Day 3 -->
        <div class="day-wrapper">
            <div class="day-toggle" id="toggle-d3" onclick="toggleTimeline('d3', this)">
                <div class="day-info">
                    <h3>Day 3: 最後衝刺，銀座購物</h3>
                    <span>4/20 (一) • 溫暖的家</span>
                </div>
                <div class="toggle-icon">▼</div>
            </div>
            <div id="d3" class="timeline">
                <div class="event">
                    <div class="time">10:00</div>
                    <div class="activity">退房與移動</div>
                    <div class="desc">
                        Check-out 後將行李寄放飯店，或者直接搭計程車帶行李去銀座找置物櫃。
                    </div>
                    <div class="tags"><span class="tag tag-move">移動</span><span class="tag tag-stay">寄行李</span></div>
                </div>
                <div class="event">
                    <div class="time">11:00</div>
                    <div class="activity">銀座逛街 (Ginza)</div>
                    <div class="desc">
                        大人購物的戰場。
                        <ul style="list-style-type: disc; padding-left: 20px;">
                            <li><b>GINZA SIX：</b> 藝術裝置、限定店、伴手禮。</li>
                            <li><b>Uniqlo / GU 銀座旗艦店：</b> 款式最齊全，一次買齊全家衣物。</li>
                            <li><b>下午茶：</b> 銀座千疋屋 (水果聖代) 或 資生堂 Parlour。</li>
                        </ul>
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Ginza+Six" target="_blank"
                        class="btn-map">導航</a>
                    <div class="tags"><span class="tag tag-shop">購物</span><span class="tag tag-food">甜點</span></div>
                </div>
                <div class="event">
                    <div class="time">16:00</div>
                    <div class="activity" style="color:#d97706;">準備前往成田機場</div>
                    <div class="desc">
                        <b>重要：</b>班機 19:30 起飛。週一傍晚易塞車。<br>
                        最慢 16:30 要搭上往機場的車 (巴士或 N'EX)，確保 17:30 前抵達櫃檯。
                    </div>
                    <div class="tags"><span class="tag tag-move">前往機場</span><span class="tag tag-alert">注意時間</span>
                    </div>
                </div>
                <div class="event">
                    <div class="time">19:30</div>
                    <div class="activity">班機起飛 (IT203)</div>
                    <div class="desc">
                        東京成田 (NRT) -> 台北 (TPE)。<br>
                        預計 22:35 抵達台灣，結束完美的充電之旅。
                    </div>
                    <div class="tags"><span class="tag tag-flight">回程</span></div>
                </div>
            </div>
        </div>

        <!-- End of Itinerary -->
    </div>

    <!-- TAB 2: 住宿資訊 (Updated Day 3) -->
    <div id="view-stay" class="container">

        <div class="card">
            <div class="card-header">
                <div class="card-title">東京皇家王子大飯店花園塔</div>
                <div class="tag tag-stay" style="background-color: #EF4444; color: white;">新裝修</div>
            </div>

            <div class="stay-card-grid">
                <div class="stay-row">
                    <div class="stay-label">
                        <svg class="icon-mini" style="color:#6B7280">
                            <use href="#icon-loc"></use>
                        </svg> 地址
                    </div>
                    <div class="stay-val">
                        <span>東京都港區芝公園 4-8-1</span>
                        <button class="btn-copy-small" onclick="copyText(this, '東京都港區芝公園 4-8-1')">
                            <svg class="icon-mini" style="width:12px;height:12px;">
                                <path d="M8 2h8a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"
                                    fill="none" stroke="currentColor" stroke-width="2" />
                            </svg>
                            複製
                        </button>
                    </div>
                </div>
                <div class="stay-row">
                    <div class="stay-label">
                        <svg class="icon-mini" style="color:#6B7280">
                            <use href="#icon-consult"></use>
                        </svg> 電話
                    </div>
                    <div class="stay-val">
                        <a href="tel:0354001111" style="color:#2563EB; text-decoration:none;">+81-3-5400-1111</a>
                    </div>
                </div>
                <div class="stay-row">
                    <div class="stay-label">
                        <svg class="icon-mini" style="color:#6B7280; width:14px; height:14px;">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"
                                fill="none" stroke="currentColor" stroke-width="2" />
                            <path d="M22 6l-10 7L2 6" fill="none" stroke="currentColor" stroke-width="2" />
                        </svg> 郵遞區號
                    </div>
                    <div class="stay-val">
                        <span>105-8563</span>
                        <button class="btn-copy-small" onclick="copyText(this, '105-8563')">
                            <svg class="icon-mini" style="width:12px;height:12px;">
                                <path d="M8 2h8a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"
                                    fill="none" stroke="currentColor" stroke-width="2" />
                            </svg>
                            複製
                        </button>
                    </div>
                </div>
            </div>

            <div class="info-detail-box" style="margin-top: 10px; border-color: #A7F3D0; background-color: #ECFDF5;">
                <h4 style="color: #047857;">✨ 飯店設施與特色</h4>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 5px;">
                    <span class="tag" style="background:#D1FAE5; color:#065F46; font-size:0.8rem;">溫泉</span>
                    <span class="tag" style="background:#D1FAE5; color:#065F46; font-size:0.8rem;">室內泳池</span>
                    <span class="tag" style="background:#D1FAE5; color:#065F46; font-size:0.8rem;">健身房</span>
                    <span class="tag" style="background:#D1FAE5; color:#065F46; font-size:0.8rem;">景觀極佳</span>
                </div>
                <p style="font-size: 0.9rem; color: #444; margin-top: 8px;">
                    位於東京鐵塔旁的豪華酒店，從房間即可欣賞絕美塔景。擁有天然溫泉 SPA，適合在市區放鬆度假。
                </p>
            </div>

            <a href="https://www.google.com/maps/search/?api=1&query=The+Prince+Park+Tower+Tokyo" target="_blank"
                class="btn-nav-large" style="background: linear-gradient(135deg, #2563EB, #1D4ED8);">
                <svg class="icon-mini" style="width:20px;height:20px;color:white;">
                    <use href="#icon-nav-arrow"></use>
                </svg>
                啟動 Google 導航
            </a>
        </div>

    </div>

    <!-- TAB 3: 交通資訊 -->
    <div id="view-car" class="container">
        <!-- 航班資訊 -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">航班資訊 (羽田進/成田出)</div>
                <div class="tag tag-flight" style="background-color: #F59E0B; color: white;">台灣虎航</div>
            </div>
            <div class="info-detail-box">
                <h4>去程：4/18 (六) 台北(TPE) → 羽田(HND)</h4>
                <div class="info-grid">
                    <div class="info-label">班次參考</div>
                    <div class="info-val">IT216</div>
                </div>
                <div class="info-grid">
                    <div class="info-label">起飛時間</div>
                    <div class="info-val">00:10 (TPE)</div>
                </div>
                <div class="info-grid">
                    <div class="info-label">起飛航廈</div>
                    <div class="info-val">TPE T1 (桃園機場第一航廈)</div>
                </div>
                <div class="info-grid">
                    <div class="info-label">抵達時間</div>
                    <div class="info-val">04:25 (HND 當地時間)</div>
                </div>
                <div class="info-grid">
                    <div class="info-label">抵達航廈</div>
                    <div class="info-val">HND T3 (羽田機場第三航廈)</div>
                </div>
            </div>
            <div class="info-detail-box" style="margin-top: 15px;">
                <h4>回程：4/20 (一) 成田(NRT) → 台北(TPE)</h4>
                <div class="info-grid">
                    <div class="info-label">班次參考</div>
                    <div class="info-val">IT203</div>
                </div>
                <div class="info-grid">
                    <div class="info-label">起飛時間</div>
                    <div class="info-val">19:30 (NRT 當地時間)</div>
                </div>
                <div class="info-grid">
                    <div class="info-label">起飛航廈</div>
                    <div class="info-val">NRT T2 (成田機場第二航廈)</div>
                </div>
                <div class="info-grid">
                    <div class="info-label">抵達時間</div>
                    <div class="info-val">22:35 (TPE 當地時間)</div>
                </div>
                <div class="info-grid">
                    <div class="info-label">抵達航廈</div>
                    <div class="info-val">TPE T1 (桃園機場第一航廈)</div>
                </div>
            </div>
        </div>

        <!-- [新增] 回程交通資訊 -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">回程交通：飯店 ➔ 成田機場</div>
                <div class="tag tag-move">機場交通</div>
            </div>

            <div class="info-section" style="margin-bottom: 15px;">
                <h4 style="color: #2563EB;">🚌 方案一：飯店利木津巴士 (Check-in 時確認)</h4>
                <div class="method-detail">
                    <p><b>The Prince Park Tower Tokyo</b> 往成田機場。</p>
                    <ul class="step-list" style="padding-left: 20px; margin-top: 5px;">
                        <li><b>目前班表：</b>末班直達車約為 12:55 (太早，不建議)，如果搭乘此班次，要在機場等 4.5 個小時，但可以利用這段時間逛機場免稅店。</li>
                        <li><b>關鍵動作：</b>Check-in 時，請務必詢問櫃台：<br>
                            <span style="color: #D97706; font-weight: 600;">「4/20 下午是否有加班車或季節性增開的巴士？」</span>
                        </li>
                        <li><b>理想目標：</b>若有 <b>15:30 - 16:00</b> 左右的直達車，請直接預訂，這是最完美的方案。</li>
                    </ul>
                </div>
            </div>

            <div class="info-section" style="background-color: #FFFBEB; border-color: #F59E0B;">
                <h4 style="color: #D97706;">🚕 方案二：計程車 + T-CAT (推薦備案)</h4>
                <div class="method-detail">
                    <p style="font-size: 0.9rem; color: #444; margin-bottom: 10px;">
                        若飯店無下午班次，<b>強烈建議</b>採用此方案。比去東京車站更輕鬆、人潮更少，且全程室內移動。
                    </p>

                    <div class="timeline-fix"
                        style="border-left: 2px solid #FCD34D; margin-left: 10px; padding-left: 20px;">
                        <div class="event" style="margin-bottom: 15px;">
                            <div class="time" style="color: #D97706;">15:30</div>
                            <div class="activity" style="font-weight: 600;">計程車 ➔ T-CAT (箱崎)</div>
                            <div class="desc" style="font-size: 0.9rem;">
                                從飯店或銀座搭計程車前往 <b>T-CAT (Tokyo City Air Terminal)</b>。<br>
                                <span style="color: #666; font-size: 0.85rem;">• 車程：約 15-20 分鐘。<br>•
                                    優勢：直達巴士樞紐，避開地鐵轉乘。</span>
                            </div>
                        </div>

                        <div class="event" style="margin-bottom: 15px;">
                            <div class="time" style="color: #D97706;">16:00</div>
                            <div class="activity" style="font-weight: 600;">搭乘利木津巴士</div>
                            <div class="desc" style="font-size: 0.9rem;">
                                T-CAT 往成田機場班次密集 (約 10-15 分一種一班)。<br>
                                <span style="color: #666; font-size: 0.85rem;">• 車程：約 60 分鐘。<br>• 舒適：室內候車，人潮較少。</span>
                            </div>
                        </div>

                        <div class="event">
                            <div class="time" style="color: #D97706;">17:00</div>
                            <div class="activity" style="font-weight: 600;">抵達成田機場 (NRT)</div>
                            <div class="desc" style="font-size: 0.9rem;">
                                正好趕上 17:30 關櫃時間，有充裕時間辦理退稅與最後採買。
                            </div>
                        </div>
                    </div>

                    <a href="https://www.google.com/maps/search/?api=1&query=T-CAT+Tokyo+City+Air+Terminal"
                        target="_blank" class="btn-map" style="margin-top: 10px;">導航至 T-CAT</a>
                </div>
            </div>
        </div>







    </div>

    <!-- TAB 4: 旅遊資訊 -->
    <div id="view-info" class="container">
        <div class="card">
            <div class="card-header">
                <!-- 修正 1: 將 Emoji 🌍 換成簡約 SVG 地球圖示 -->
                <div class="card-title" style="display: flex; align-items: center; gap: 6px;">
                    <svg class="icon-mini" style="color: var(--primary);">
                        <use href="#icon-earth"></use>
                    </svg>
                    即時天氣查詢 & 穿衣建議
                </div>
            </div>

            <div class="weather-search-box">
                <input type="text" id="weather-city-input" class="weather-input" placeholder="輸入城市 (例如: 熊本, 由布院)">
                <button class="btn-weather-search" onclick="fetchRealtimeWeather()">查詢</button>
            </div>

            <!-- Main Result -->
            <div id="weather-result" style="display: none;" class="animate-fade-in">

                <div
                    style="display: grid; grid-template-columns: 1fr 1.2fr 1fr; gap: 8px; margin-bottom: 12px; align-items: stretch;">

                    <div
                        style="background: white; padding: 8px 4px; border-radius: 12px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <div
                            style="color: #6B7280; font-size: 10px; margin-bottom: 2px; display: flex; align-items: center; justify-content: center; gap: 2px;">
                            <span id="wc-loc-box"><svg class="icon-mini" style="width:12px; height:12px;">
                                    <use href="#icon-loc"></use>
                                </svg> 我的位置</span>
                        </div>
                        <div id="wc-my-temp" style="font-size: 18px; font-weight: 700; color: #374151;">--°</div>
                    </div>

                    <div id="wc-box-main"
                        style="background: #5A92E8; color: white; padding: 8px 4px; border-radius: 12px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 1px solid transparent; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: all 0.3s ease;">
                        <div id="wc-loc"
                            style="font-size: 14px; font-weight: 500; margin-bottom: 0px; line-height: 1.2;">查詢中
                        </div>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 2px;">
                            <span id="wc-temp" style="font-size: 24px; font-weight: 700;">--°</span>
                        </div>
                        <div id="wc-desc" style="font-size: 11px; opacity: 0.9;">--</div>
                    </div>

                    <div id="wc-diff-box"
                        style="background: #F3F4F6; padding: 8px 4px; border-radius: 12px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid transparent; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: all 0.3s ease;">
                        <div id="wc-diff-title"
                            style="color: inherit; font-size: 10px; margin-bottom: 4px; opacity: 0.8;">與當地溫差</div>

                        <div id="wc-diff-val" style="font-size: 1.1rem; font-weight: bold; color: inherit;">--</div>

                        <div id="wc-diff-tag" style="display: none;"></div>
                    </div>
                </div>

                <div
                    style="background: white; border-left: 4px solid #5A92E8; padding: 10px; border-radius: 0 8px 8px 0; font-size: 13px; color: #1E40AF; display: flex; align-items: flex-start; gap: 8px;">
                    <svg class="icon-mini" style="flex-shrink: 0; margin-top: 2px; color: #5A92E8;">
                        <use href="#icon-shirt"></use>
                    </svg>
                    <span id="wc-advice" style="line-height: 1.4;">查詢後將顯示穿衣建議...</span>
                </div>

            </div>

            <!-- Default / Loading State -->
            <div id="weather-placeholder" style="text-align: center; padding: 40px; color: #9CA3AF;">
                <svg viewBox="0 0 24 24"
                    style="width: 60px; height: 60px; stroke: #D1D5DB; fill: none; stroke-width: 1.5; margin-bottom: 10px;">
                    <path d="M12 2v2"></path>
                    <path d="m4.93 4.93 1.41 1.41"></path>
                    <path d="M20 12h2"></path>
                    <path d="m19.07 4.93-1.41 1.41"></path>
                    <path d="M15.947 12.65a4 4 0 0 0-5.925-4.128"></path>
                    <path d="M13 22H7a5 5 0 1 1 4.9-6H13a3 3 0 0 1 0 6Z"></path>
                </svg>
                <div>請輸入城市名稱查詢即時天氣</div>
            </div>
        </div>
        <div class="card"
            style="background: transparent; box-shadow: none; padding: 0; border: none; margin-bottom: 10px;">
            <div class="card-header"
                style="background: #fff; border-radius: 16px; padding: 15px; border: 1px solid rgba(0,0,0,0.03); box-shadow: 0 2px 6px rgba(0,0,0,0.04); margin-bottom: 15px;">
                <div class="card-title">逛街、美照、美食備案口袋名單</div>
                <div class="tag tag-food">彈性選擇</div>
            </div>





            <div class="day-wrapper">
                <div class="day-toggle" id="toggle-food-t" onclick="toggleTimeline('food-t', this)">
                    <div class="day-info">
                        <h3>東京綜合備案 (表參道/六本木)</h3>
                        <span>貴婦午茶、美術館、時尚逛街</span>
                    </div>
                    <div class="toggle-icon">▼</div>
                </div>
                <div id="food-t" class="timeline">
                    <!-- Shopping -->
                    <div class="info-section"
                        style="border-color: #F87171; background-color: #FEF2F2; margin-bottom: 15px;">
                        <h3 style="color: #DC2626; border-bottom-color: #F87171;">🛍️ 逛街：時尚與質感 (表參道/新宿)</h3>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">1. 伊勢丹 新宿店 (Isetan)</span>
                            <div class="method-detail">
                                <p>東京時尚的頂點。B1 美食街伴手禮最齊全，2F 匯集全球設計師品牌。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Isetan+Shinjuku"
                                    target="_blank" class="btn-map">導航至伊勢丹</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">2. 表參道 Hills</span>
                            <div class="method-detail">
                                <p>安藤忠雄設計的經典建築。逛起來舒適優雅，品牌選品獨特。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Omotesando+Hills"
                                    target="_blank" class="btn-map">導航至表參道 Hills</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">3. NEWoMan 新宿</span>
                            <div class="method-detail">
                                <p>專為成熟女性打造的商場。選品店、藍瓶咖啡、甜點店都非常有質感。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=NEWoMan+Shinjuku"
                                    target="_blank" class="btn-map">導航至 NEWoMan</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">4. MCM 銀座/表參道</span>
                            <div class="method-detail">
                                <p>若是想看經典包款，表參道店展示空間寬敞，款式齊全。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=MCM+Omotesando" target="_blank"
                                    class="btn-map">導航至 MCM</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">5. Don Quijote 六本木店</span>
                            <div class="method-detail">
                                <p>如果不小心逛太晚，六本木的唐吉訶德商品陳列較整齊，適合補貨。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Don+Quijote+Roppongi"
                                    target="_blank" class="btn-map">導航至唐吉訶德</a>
                            </div>
                        </div>
                    </div>

                    <!-- Food -->
                    <div class="info-section"
                        style="border-color: #34D399; background-color: #ECFDF5; margin-bottom: 15px;">
                        <h3 style="color: #059669; border-bottom-color: #34D399;">🍴 美食：優雅午茶與晚餐</h3>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">1. Aoyama Flower Market Tea House</span>
                            <div class="method-detail">
                                <p>在溫室花園中用餐，被鮮花包圍。氣氛極佳，法式吐司非常好吃。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Aoyama+Flower+Market+Tea+House"
                                    target="_blank" class="btn-map">導航至花店茶屋</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">2. HARBS (六本木/新宿)</span>
                            <div class="method-detail">
                                <p>必吃<b>「水果千層蛋糕」</b>。份量大、鮮奶油清爽不膩。午間套餐CP值高。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=HARBS+Roppongi+Hills"
                                    target="_blank" class="btn-map">導航至 HARBS</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">3. AFURI 拉麵 (原宿/六本木)</span>
                            <div class="method-detail">
                                <p><b>「柚子鹽拉麵」</b>清爽湯頭帶有柚子香氣，是女生最愛的拉麵首選。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=AFURI+Harajuku" target="_blank"
                                    class="btn-map">導航至 AFURI</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">4. Yoroniku (よろにく) - 南青山</span>
                            <div class="method-detail">
                                <p>頂級燒肉名店 (需預約)。專人代烤，能吃到和牛最完美的口感。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Yoroniku+Minami+Aoyama"
                                    target="_blank" class="btn-map">導航至 Yoroniku</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">5. Shake Shack (外苑前)</span>
                            <div class="method-detail">
                                <p>位於神宮外苑銀杏大道旁，擁有超美戶外座位。漢堡與奶昔都很道地。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Shake+Shack+Gaienmae"
                                    target="_blank" class="btn-map">導航至 Shake Shack</a>
                            </div>
                        </div>
                    </div>

                    <!-- Photo -->
                    <div class="info-section"
                        style="border-color: #FBBF24; background-color: #FFFBEB; margin-bottom: 15px;">
                        <h3 style="color: #B45309; border-bottom-color: #FBBF24;">📸 美照：建築與街景</h3>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">1. 東急 Plaza 表參道原宿</span>
                            <div class="method-detail">
                                <p>入口處的<b>「萬花筒鏡面手扶梯」</b>，是表參道最經典的打卡點。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Tokyu+Plaza+Omotesando+Harajuku"
                                    target="_blank" class="btn-map">導航至東急 Plaza</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">2. 根津美術館 (Nezu Museum)</span>
                            <div class="method-detail">
                                <p>隈研吾設計。入口的竹林長廊充滿禪意，非常適合拍氣質美照。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Nezu+Museum" target="_blank"
                                    class="btn-map">導航至根津美術館</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">3. 國立新美術館</span>
                            <div class="method-detail">
                                <p>波浪狀的玻璃帷幕建築，光影效果極佳。裡面還有《你的名字》取景的咖啡廳。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=The+National+Art+Center+Tokyo"
                                    target="_blank" class="btn-map">導航至新美術館</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">4. 明治神宮 (酒樽牆)</span>
                            <div class="method-detail">
                                <p>巨大的清酒與洋酒酒樽牆，色彩鮮豔，是具代表性的日本背景。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Meiji+Jingu" target="_blank"
                                    class="btn-map">導航至明治神宮</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">5. Cat Street (貓街)</span>
                            <div class="method-detail">
                                <p>連接原宿與澀谷的步行街。充滿特色小店與塗鴉牆，街拍氛圍滿分。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Cat+Street+Tokyo"
                                    target="_blank" class="btn-map">導航至 Cat Street</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="day-wrapper">
                <div class="day-toggle" id="toggle-food-d" onclick="toggleTimeline('food-d', this)">
                    <div class="day-info">
                        <h3>代官山 & 澀谷備案</h3>
                        <span>潮流、夜景、質感生活</span>
                    </div>
                    <div class="toggle-icon">▼</div>
                </div>
                <div id="food-d" class="timeline">
                    <!-- Shopping -->
                    <div class="info-section"
                        style="border-color: #F87171; background-color: #FEF2F2; margin-bottom: 15px;">
                        <h3 style="color: #DC2626; border-bottom-color: #F87171;">🛍️ 逛街：最新潮流發信地</h3>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">1. Shibuya Parco</span>
                            <div class="method-detail">
                                <p>潮流百貨代表。6F 有任天堂與寶可夢中心，1F 有許多設計師品牌。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Shibuya+Parco" target="_blank"
                                    class="btn-map">導航至 Parco</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">2. Scramble Square</span>
                            <div class="method-detail">
                                <p>澀谷最高地標 (Shibuya Sky 樓下)。樓下甜點區非常好逛 (Echire 餅乾在此)。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Shibuya+Scramble+Square"
                                    target="_blank" class="btn-map">導航至 Scramble Square</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">3. 代官山 T-SITE (蔦屋書店)</span>
                            <div class="method-detail">
                                <p>世界最美書店。除了書，還有文具館、寵物店，在這散步非常舒服。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Daikanyama+T-Site"
                                    target="_blank" class="btn-map">導航至 T-SITE</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">4. 宮下公園 (MIYASHITA PARK)</span>
                            <div class="method-detail">
                                <p>結合公園與商場的新型態建築。LV 男裝店、Kith 都在這，頂樓公園可以喝咖啡。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Miyashita+Park" target="_blank"
                                    class="btn-map">導航至宮下公園</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">5. Loft 澀谷店</span>
                            <div class="method-detail">
                                <p>生活雜貨迷的天堂。整棟都是文具、美妝、家飾，可以逛很久。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Shibuya+Loft" target="_blank"
                                    class="btn-map">導航至 Loft</a>
                            </div>
                        </div>
                    </div>

                    <!-- Food -->
                    <div class="info-section"
                        style="border-color: #34D399; background-color: #ECFDF5; margin-bottom: 15px;">
                        <h3 style="color: #059669; border-bottom-color: #34D399;">🍴 美食：人氣排隊名店</h3>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">1. Ivy Place (代官山)</span>
                            <div class="method-detail">
                                <p>像是在別墅裡用餐的餐廳，鬆餅非常有名。需提早訂位或現場候位。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Ivy+Place+Daikanyama"
                                    target="_blank" class="btn-map">導航至 Ivy Place</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">2. Koffee Mameya</span>
                            <div class="method-detail">
                                <p>咖啡迷必訪。沒有座位，由咖啡師一對一依口味推薦豆子的體驗型咖啡店。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Koffee+Mameya+Shibuya"
                                    target="_blank" class="btn-map">導航至 Mameya</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">3. Paradise Lounge (Shibuya Sky)</span>
                            <div class="method-detail">
                                <p>位於展望台 46F 的酒吧。點杯飲料就能坐在窗邊享受百萬夜景，氣氛滿分。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Shibuya+Sky" target="_blank"
                                    class="btn-map">導航至 Sky Lounge</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">4. 月島文字燒 (Scramble Square)</span>
                            <div class="method-detail">
                                <p>「Monja Moheji」保有傳統口味又時尚。推薦「明太子麻糬起司」口味。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Moheji+Shibuya+Scramble"
                                    target="_blank" class="btn-map">導航至文字燒</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">5. 挽肉と米 (Hikiniku to Come)</span>
                            <div class="method-detail">
                                <p>炭烤漢堡排神店。需一早領號碼牌。現烤多汁漢堡排配上釜燒白飯絕配。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Hikiniku+to+Come+Shibuya"
                                    target="_blank" class="btn-map">導航至挽肉與米</a>
                            </div>
                        </div>
                    </div>

                    <!-- Photo -->
                    <div class="info-section"
                        style="border-color: #FBBF24; background-color: #FFFBEB; margin-bottom: 15px;">
                        <h3 style="color: #B45309; border-bottom-color: #FBBF24;">📸 美照：東京最潮視角</h3>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">1. Shibuya Sky (玻璃角落)</span>
                            <div class="method-detail">
                                <p>排隊也要拍的透明角落 (Sky Edge)。建議黃昏時段去，可以拍到從夕陽到夜景的變化。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Shibuya+Sky" target="_blank"
                                    class="btn-map">導航至 Shibuya Sky</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">2. 澀谷十字路口 (星巴克/Mag's)</span>
                            <div class="method-detail">
                                <p>世界最繁忙的路口。想拍俯瞰照可去 TSUTAYA 二樓星巴克或 MAG's PARK。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Shibuya+Scramble+Crossing"
                                    target="_blank" class="btn-map">導航至十字路口</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">3. 忠犬八公像</span>
                            <div class="method-detail">
                                <p>澀谷的象徵。雖然人很多，但還是要來跟八公合照一張才算來過澀谷。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Hachiko+Statue" target="_blank"
                                    class="btn-map">導航至八公像</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">4. Nonbei Yokocho (飲兵衛横丁)</span>
                            <div class="method-detail">
                                <p>充滿昭和風情的居酒屋小巷，紅燈籠非常上相。在路口拍照就很有感覺。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Nonbei+Yokocho" target="_blank"
                                    class="btn-map">導航至横丁</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">5. Log Road Daikanyama</span>
                            <div class="method-detail">
                                <p>原本是鐵道遺跡改建的散步道。兩旁充滿綠意與特色小店，隨手拍都像雜誌。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Log+Road+Daikanyama"
                                    target="_blank" class="btn-map">導航至 Log Road</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="day-wrapper">
                <div class="day-toggle" id="toggle-food-g" onclick="toggleTimeline('food-g', this)">
                    <div class="day-info">
                        <h3>銀座備案 (步行者天國)</h3>
                        <span>貴婦購物、百年老店、步行天國</span>
                    </div>
                    <div class="toggle-icon">▼</div>
                </div>
                <div id="food-g" class="timeline">
                    <!-- Shopping -->
                    <div class="info-section"
                        style="border-color: #F87171; background-color: #FEF2F2; margin-bottom: 15px;">
                        <h3 style="color: #DC2626; border-bottom-color: #F87171;">🛍️ 逛街：頂級購物殿堂</h3>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">1. GINZA SIX</span>
                            <div class="method-detail">
                                <p>銀座最大商場。中央天井的藝術裝置 (如草間彌生南瓜) 是看點。6F 蔦屋書店很美。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=GINZA+SIX" target="_blank"
                                    class="btn-map">導航至 GINZA SIX</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">2. Uniqlo 銀座旗艦店</span>
                            <div class="method-detail">
                                <p>全球最大旗艦店 (12層樓)。有賣鮮花、專屬客製化 T-shirt (UTme!)，款式最齊全。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Uniqlo+Ginza" target="_blank"
                                    class="btn-map">導航至 Uniqlo</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">3. 伊東屋 (G. Itoya)</span>
                            <div class="method-detail">
                                <p>百年文具店。整棟樓都是精美文具，還有室內蔬菜農場，文具控必逛。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Ginza+Itoya" target="_blank"
                                    class="btn-map">導航至伊東屋</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">4. 銀座三越</span>
                            <div class="method-detail">
                                <p>老牌貴婦百貨。1F 化妝品區品牌極多，B2 美食街是買高級水果與伴手禮的好地方。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Ginza+Mitsukoshi"
                                    target="_blank" class="btn-map">導航至三越</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">5. 東急 Plaza 銀座</span>
                            <div class="method-detail">
                                <p>以「江戶切子」為設計靈感。頂樓的 Kiriko Lounge 可以免費俯瞰銀座街景。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Tokyu+Plaza+Ginza"
                                    target="_blank" class="btn-map">導航至東急 Plaza</a>
                            </div>
                        </div>
                    </div>

                    <!-- Food -->
                    <div class="info-section"
                        style="border-color: #34D399; background-color: #ECFDF5; margin-bottom: 15px;">
                        <h3 style="color: #059669; border-bottom-color: #34D399;">🍴 美食：銀座經典滋味</h3>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">1. 銀座梅林 (Ginza Bairin)</span>
                            <div class="method-detail">
                                <p>銀座第一間炸豬排專門店。推薦<b>「特製菲力豬排三明治」</b>，肉質柔軟多汁。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Ginza+Bairin" target="_blank"
                                    class="btn-map">導航至銀座梅林</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">2. 佐藤養助 (銀座店)</span>
                            <div class="method-detail">
                                <p>來自秋田的稻庭烏龍麵。麵條細緻Q彈，口感如絲綢般滑順，沾胡麻醬絕配。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Sato+Yosuke+Ginza"
                                    target="_blank" class="btn-map">導航至佐藤養助</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">3. Bills 銀座</span>
                            <div class="method-detail">
                                <p>澳洲第一早午餐。銀座店氣氛特別好，必點<b>「Ricotta 起司鬆餅」</b>。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Bills+Ginza" target="_blank"
                                    class="btn-map">導航至 Bills</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">4. TsuruTonTan (銀座店)</span>
                            <div class="method-detail">
                                <p>在大碗公裡吃烏龍麵。位於東急 Plaza 10F，裝潢高雅，明太子奶油烏龍麵是人氣 No.1。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Tsurutontan+Ginza"
                                    target="_blank" class="btn-map">導航至 TsuruTonTan</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">5. 木村家 (Kimuraya)</span>
                            <div class="method-detail">
                                <p>紅豆麵包 (Anpan) 的創始店。酒種發酵的麵包香氣獨特，一定要買一個試試。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Kimuraya+Ginza" target="_blank"
                                    class="btn-map">導航至木村家</a>
                            </div>
                        </div>
                    </div>

                    <!-- Photo -->
                    <div class="info-section"
                        style="border-color: #FBBF24; background-color: #FFFBEB; margin-bottom: 15px;">
                        <h3 style="color: #B45309; border-bottom-color: #FBBF24;">📸 美照：銀座摩登風情</h3>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">1. 和光鐘樓 (Wako Clock Tower)</span>
                            <div class="method-detail">
                                <p>銀座的地標與象徵。站在銀座四丁目交叉口拍它是最經典的構圖。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Wako+Ginza" target="_blank"
                                    class="btn-map">導航至和光</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">2. 步行者天國 (中央通)</span>
                            <div class="method-detail">
                                <p>週末 (週六日) 下午中央通會封街。走在大馬路正中央拍照是銀座限定的體驗。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Ginza+Chuo-dori"
                                    target="_blank" class="btn-map">導航至中央通</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">3. Art Aquarium (金魚展)</span>
                            <div class="method-detail">
                                <p>位於三越新館。夢幻的燈光與數千條金魚的藝術水族館，非常絢麗好拍。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Art+Aquarium+Museum+Ginza"
                                    target="_blank" class="btn-map">導航至金魚展</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">4. 歌舞伎座 (Kabukiza)</span>
                            <div class="method-detail">
                                <p>宏偉的傳統日式建築，與背後現代大樓形成對比。B2 地下街可以買到特色伴手禮。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Kabukiza+Theatre"
                                    target="_blank" class="btn-map">導航至歌舞伎座</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">5. Nissan Crossing</span>
                            <div class="method-detail">
                                <p>位於交叉口的未來感建築。二樓有咖啡廳，可以用奶泡拉出自己照片的拉花。</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Nissan+Crossing"
                                    target="_blank" class="btn-map">導航至 Nissan Crossing</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>
        <!-- 熊本 上/下通 攻略 -->
        <!-- 紅眼班機休息推薦 -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">♨️ 紅眼救星：泉天空之湯 (羽田機場花園)</div>
                <div class="tag tag-relax">休息</div>
            </div>

            <div class="info-section">
                <h3>📍 位置與特色</h3>
                <p style="font-size: 0.95rem;">
                    位於與第三航廈直結的「羽田機場花園」12F。24小時營業，擁有天然溫泉、岩盤浴，天氣好還能看見富士山，是紅眼班機抵達後的最佳休息點。
                </p>
            </div>

            <div class="info-section" style="border-color: #EF4444; background-color: #FEF2F2; margin-top: 15px;">
                <h3 style="color: #B91C1C; border-bottom-color: #EF4444;">💰 省錢關鍵 (必讀)</h3>
                <div class="method-detail">
                    <p style="font-weight: 700; color: #DC2626; margin-bottom: 5px;">建議「05:00 後」再入場！</p>
                    <ul style="padding-left: 20px; font-size: 0.9rem;">
                        <li><b>深夜時段 (01:00 - 05:00)：</b> 需加收 <b style="color: #DC2626;">¥4,000</b> 深夜料金。</li>
                        <li><b>一般時段 (05:00 後)：</b> 僅收基本入場費 (成人約 ¥4,800)。</li>
                    </ul>
                    <p style="margin-top: 8px; font-size: 0.85rem; color: #4B5563;">
                        您的班機 IT216 於 <b>04:25</b> 抵達，入境+領行李走到花園約需 30-40 分鐘，剛好可以銜接 <b>05:00</b> 後的一般時段，直接省下 ¥4,000/人！
                    </p>
                </div>
            </div>

            <div class="info-section" style="margin-top: 15px;">
                <h3>⚠️ 注意事項</h3>
                <ul style="padding-left: 20px; font-size: 0.9rem;">
                    <li><b>清掃時間：</b>每日 <b>10:00 - 13:00</b> 浴場進行清掃，無法泡湯 (但可在休息區休息)。</li>
                    <li><b>行李寄放：</b>館內有收費置物櫃，或可先寄放於機場花園的飯店/機場櫃檯。</li>
                </ul>
                <a href="https://www.shopping-sumitomo-rd.com/haneda/spa-izumi/index.html" target="_blank"
                    class="btn-link" style="margin-top: 10px;">官方網站 & 混雜狀況查詢</a>
                <a href="https://www.japaholic.com/tw/article/detail/935599" target="_blank" class="btn-link"
                    style="margin-top: 8px; background-color: #F472B6;">Japaholic 詳細介紹文</a>
            </div>
        </div>

        <!-- Day 1: 東京鐵塔 & 麻布台之丘 -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">Day 1: 東京鐵塔 & 麻布台之丘</div>
                <div class="tag tag-shop">新地標</div>
            </div>

            <div class="info-section">
                <h3>🗼 麻布台之丘 (Azabudai Hills)</h3>
                <p style="font-size: 0.95rem;">
                    2023年底全新開幕的東京新地標，結合綠意與現代建築。
                </p>

                <div class="safari-method" style="border-color: #90CDF4; margin-top: 15px;">
                    <span class="method-title" style="color: var(--primary);">必逛重點</span>
                    <div class="method-detail">
                        <ul style="list-style-type: disc; margin-top: 5px; padding-left: 20px;">
                            <li><b>Garden Plaza：</b>曲線優美的建築設計，很多時尚店鋪與藝廊。</li>
                            <li><b>展望台：</b>(需確認是否開放) 可近距離平視東京鐵塔。</li>
                            <li><b>森 JP Tower：</b>日本最高摩天大樓。</li>
                        </ul>
                    </div>
                </div>

                <div class="safari-method" style="margin-top: 15px; border-color: #F87171;">
                    <span class="method-title" style="color: #DC2626;">東京鐵塔拍照點</span>
                    <div class="method-detail">
                        <p>住在 <b>The Prince Park Tower</b> 的最大優勢就是就在鐵塔腳下！</p>
                        <ul style="list-style-type: disc; margin-top: 5px; padding-left: 20px;">
                            <li><b>芝公園 (4號地)：</b>經典的草地野餐視角。</li>
                            <li><b>飯店花園：</b>專屬的私密視角，早晨或夜晚散步都很棒。</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Day 2: 代官山 & 澀谷 -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">Day 2: 代官山 蔦屋書店 & 澀谷 SKY</div>
                <div class="tag tag-relax">質感/夜景</div>
            </div>

            <div class="info-section" style="background-color: #FDF4F1; border-color: #78350F;">
                <h3 style="color: #78350F; border-bottom-color: #78350F;">☕ 代官山 (Daikanyama)</h3>
                <p style="font-size: 0.95rem; color: #444;">
                    東京最優雅的區域之一，適合放慢腳步散策。
                </p>
                <div class="safari-method" style="margin-top: 10px; border-color: #78350F;">
                    <span class="method-title" style="color: #78350F;">散策推薦</span>
                    <div class="method-detail">
                        <ul style="padding-left: 20px; line-height: 1.6;">
                            <li><b>蔦屋書店 (T-Site)：</b>世界最美書店之一，光是建築本身就值得細細品味。</li>
                            <li><b>舊朝倉家住宅：</b>隱藏在鬧區的日式庭園 (門票便宜)，秋景春景皆美。</li>
                            <li><b>Le Pain Quotidien：</b>我們預定的早午餐地點，享受歐式慵懶氛圍。</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="info-section" style="margin-top: 15px;">
                <h3>🌇 澀谷 (Shibuya) & SKY</h3>
                <p style="font-size: 0.9rem; margin-bottom: 10px;">
                    從代官山步行或搭車一段路即可抵達澀谷，感受東京的潮流脈動。
                </p>
                <div class="price-table">
                    <div class="price-header" style="color: #78350F; border-color: #78350F;">景點</div>
                    <div class="price-header" style="color: #78350F; border-color: #78350F;">特色</div>
                    <div class="price-header" style="color: #78350F; border-color: #78350F;">建議</div>

                    <div class="price-item"><b>SHIBUYA SKY</b></div>
                    <div class="price-item">360度露天展望台，目前東京最紅夜景。</div>
                    <div class="price-item">需預約夕陽時段</div>

                    <div class="price-item"><b>宮下公園</b></div>
                    <div class="price-item">頂樓有空中花園與星巴克，樓下是潮流商場。</div>
                    <div class="price-item">適合休息</div>

                    <div class="price-item"><b>十字路口</b></div>
                    <div class="price-item">世界最繁忙的路口，星巴克2樓是觀賞點。</div>
                    <div class="price-item">拍照打卡</div>
                </div>
            </div>
        </div>

        <!-- Day 3: 銀座 -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">Day 3: 銀座 (Ginza) 最後衝刺</div>
                <div class="tag tag-spot">購物</div>
            </div>

            <div class="info-section" style="background-color: #F0FDF4; border-color: #15803D;">
                <h3 style="color: #15803D; border-bottom-color: #15803D;">🛍️ 步行者天國與精品</h3>
                <p style="font-size: 0.95rem; color: #444;">
                    銀座的主要街道在週末會有「步行者天國」(封街)，週一雖然沒有，但寬敞的人行道依然好逛。
                </p>

                <div class="safari-method" style="margin-top: 10px;">
                    <span class="method-title" style="color: var(--primary);">購物地標</span>
                    <div class="method-detail">
                        <ul style="padding-left: 20px;">
                            <li><b>GINZA SIX：</b>銀座最大的複合設施，蔦屋書店與空中花園很美。</li>
                            <li><b>Uniqlo 銀座旗艦店：</b>共有12層樓，有許多限定商品與客製化服務 (UTme!)。</li>
                            <li><b>伊東屋 (Itoya)：</b>文具控的天堂，整棟都是精美文具。</li>
                            <li><b>木村家：</b>百年麵包老店，必買紅豆麵包。</li>
                        </ul>
                    </div>
                </div>

                <a href="https://www.google.com/maps/search/?api=1&query=Ginza+Station" target="_blank" class="btn-link"
                    style="display: flex; align-items: center; justify-content: center; gap: 6px;">導航至銀座四丁目 <svg
                        class="icon-mini" style="color: white;">
                        <use href="#icon-loc"></use>
                    </svg></a>
            </div>
        </div>


        <!-- 東京必買伴手禮攻略 -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">🎁 東京 (成田/銀座) 必買伴手禮</div>
                <div class="tag tag-shop">購物</div>
            </div>

            <div class="info-section" style="border-color: #F87171;">
                <h3 style="color: #DC2626; border-bottom-color: #F87171;">🍪 重點推薦</h3>
                <div class="method-detail">
                    <ul style="padding-left: 20px; line-height: 1.6;">
                        <li><b>NY Perfect Cheese：</b>東京車站最紅的伴手禮 (建議在東京車站購買)。</li>
                        <li><b>Press Butter Sand：</b>焦糖奶油夾心餅，成田機場有販售。</li>
                        <li><b>Sugar Butter Sand Tree：</b>白巧克力夾心燕麥餅，成田機場亦有販售。</li>
                        <li><b>Audrey (Glacia)：</b>草莓花束餅乾，造型非常可愛，深受女性歡迎。</li>
                        <li><b>東京香蕉 (Tokyo Banana)：</b>經典中的經典，推薦選擇「皮卡丘」或「水獺」等特殊造型版。</li>
                    </ul>
                </div>
            </div>

            <div class="info-section">
                <h3 style="color: #B45309; border-bottom-color: #FBBF24;">✈️ 機場免稅店提醒</h3>
                <p style="font-size: 0.9rem; color: #666;">
                    成田機場 (NRT) 的免稅店雖然好買，但熱門商品 (如 NY Perfect Cheese) 未必有貨。若有非買不可的品項，建議<b>在市區 (銀座/東京車站)
                        先買好</b>。機場結帳排隊人潮眾多，請務必提早抵達。
                </p>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <div class="card-title">⚠️ 重要法規：退稅與飛安 (2026)</div>
                <div class="tag tag-tip">必讀</div>
            </div>

            <div class="info-section" style="border-color: #FBBF24; background-color: #FFFBEB;">
                <h3 style="color: #B45309; border-bottom-color: #FBBF24; display: flex; align-items: center; gap: 8px;">
                    <svg style="width:24px;height:24px;flex-shrink:0;" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="11" fill="white" stroke="#E5E7EB" stroke-width="1" />
                        <circle cx="12" cy="12" r="6" fill="#BC002D" />
                    </svg>
                    日本退稅規定 (Tax Free)
                </h3>
                <div class="method-detail">
                    <p>2026年日本持續推動電子化退稅，建議事先於 <b>Visit Japan Web</b> 登錄護照資訊以產生免稅 QR Code。</p>
                    <ul style="list-style-type: disc; margin-top: 10px; padding-left: 20px;">
                        <li><b>免稅門檻：</b>同一天、同一店家消費滿 <b>5,000日圓 (未稅)</b> 以上。</li>
                        <li><b>憑證要求：</b>結帳時需出示<b>護照正本</b> (或是 Visit Japan Web 的免稅 QR Code)。</li>
                        <li><b>特殊包裝：</b>消耗品 (藥妝、零食、液體) 會被裝入<b>「紅色密封袋」</b>。在日本境內<b>嚴禁拆封</b>，若被海關查獲拆封，需補繳 10% 消費稅。</li>
                        <li style="margin-top:5px; color:#DC2626; font-size:0.85rem;">
                            *註：日本政府研擬未來改為「機場退稅制」(先含稅購買，機場再退稅)，若現場規定有變，請依店員指示為準。</li>
                    </ul>
                </div>
            </div>

            <div class="info-section" style="margin-top: 15px; border-color: #EF4444; background-color: #FEF2F2;">
                <h3 style="color: #B91C1C; border-bottom-color: #EF4444;">🔋 行動電源 & 電池攜帶規定</h3>
                <div class="method-detail">
                    <p style="font-weight: 700; color: #DC2626; margin-bottom: 8px;">嚴格禁止託運！請務必放在「手提行李」隨身登機。</p>
                    <div style="background:white; padding:10px; border-radius:8px; border:1px solid #FECACA;">
                        <div style="font-weight:600; color:#991B1B; margin-bottom:4px;">容量限制 (Wh)：</div>
                        <ul style="list-style-type: circle; padding-left: 20px; font-size: 0.9rem;">
                            <li><b>&lt; 100Wh：</b>可自由攜帶 (數量合理，通常限20顆內)。</li>
                            <li><b>100Wh ~ 160Wh：</b>需經航空公司批准 (通常每人限帶 2 顆)。</li>
                            <li><b>&gt; 160Wh：</b>禁止攜帶。</li>
                        </ul>
                        <div style="margin-top:8px; font-size:0.85rem; color:#666;">
                            *常見 10000mAh 行動電源約為 37Wh (可攜帶)。<br>
                            *若機身<b>「瓦數標示不清」</b>或磨損無法辨識，安檢有權沒收，請務必檢查機身標籤。
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 5: AI 助手 -->
    <div id="view-ai" class="container" style="padding-bottom: 20px;">
        <div style="display: flex; flex-direction: column; gap: 10px;">

            <!-- [Block 2] 隨身 AI 翻譯與助手 (Moved to Top) -->
            <div class="card"
                style="height: 73.5vh; display: flex; flex-direction: column; min-height: 0; margin-bottom: 0;">
                <div class="ai-header" id="ai-modal-title">
                    <!-- 標題 Icon -->
                    <svg class="icon-mini" style="width: 24px; height: 24px; color: #F59E0B;" viewBox="0 0 24 24">
                        <path
                            d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z">
                        </path>
                    </svg>
                    <span>隨身 AI 翻譯與助手</span>
                </div>

                <!-- 通知按鈕區 -->
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; padding: 0 5px;">
                    <button id="btn-notify-toggle" onclick="toggleNotification()"
                        style="border: none; background: none; color: #2563EB; font-size: 0.85rem; cursor: pointer; display: inline-flex; align-items: center; gap: 4px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <span style="text-decoration: underline;">開啟新記事通知</span>
                    </button>
                    <button onclick="resetAppPassword()"
                        style="border: none; background: none; color: #EF4444; font-size: 0.85rem; cursor: pointer; text-decoration: underline; display: inline-flex; align-items: center;">
                        <svg
                            style="width: 14px; height: 14px; margin-right: 4px; fill:none; stroke:currentColor; stroke-width:2;">
                            <use href="#icon-reset"></use>
                        </svg>
                        重設金鑰密碼
                    </button>
                </div>

                <!-- 對話紀錄 -->
                <div class="chat-history" id="chat-history" style="flex-grow: 1; overflow-y: auto;">
                    <!-- Welcome Message Bubble (Injected by JS) -->
                </div>

                <!-- 輸入區 -->
                <div class="ai-input-group" id="ai-input-area" style="display: block; margin-top: auto;">
                    <div class="ai-input-wrapper">
                        <input type="text" class="ai-input" id="ai-user-input" placeholder="請輸入內容..."
                            onkeypress="handleEnter(event)">

                        <!-- 新增：語音辨識語言切換開關 -->
                        <div class="voice-lang-switch">
                            <span
                                style="font-weight:600; color:#9CA3AF; font-size:0.75rem; display: flex; align-items: center; gap: 4px;">
                                <svg class="icon-mini" style="width: 14px; height: 14px;" viewBox="0 0 24 24">
                                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                    <line x1="12" y1="19" x2="12" y2="23"></line>
                                    <line x1="8" y1="23" x2="16" y2="23"></line>
                                </svg>
                                誰在說話:
                            </span>

                            <!-- 選項 1: 台灣 (中文) - 圓形簡約版 -->
                            <label class="lang-option" title="我 (說中文)">
                                <input type="radio" name="voice_lang" value="zh-TW" checked
                                    onchange="updatePlaceholder()">
                                <!-- Simplified Taiwan Circle Flag -->
                                <svg class="flag-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <mask id="maskTW">
                                        <circle cx="12" cy="12" r="12" fill="white" />
                                    </mask>
                                    <g mask="url(#maskTW)">
                                        <rect width="24" height="24" fill="#FE0000" />
                                        <rect width="12" height="12" fill="#000095" />
                                        <circle cx="6" cy="6" r="3.5" fill="white" />
                                        <circle cx="6" cy="6" r="2.5" fill="#000095" />
                                        <circle cx="6" cy="6" r="1.5" fill="white" />
                                    </g>
                                </svg>
                            </label>

                            <!-- 選項 2: 日本 (日文) - 圓形簡約版 -->
                            <label class="lang-option" title="店員 (說日文)">
                                <input type="radio" name="voice_lang" value="ja-JP" onchange="updatePlaceholder()">
                                <!-- Simplified Japan Circle Flag -->
                                <svg class="flag-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="12" r="11.5" fill="white" stroke="#E5E7EB" />
                                    <circle cx="12" cy="12" r="5" fill="#BC002D" />
                                </svg>
                            </label>
                        </div>

                        <div class="ai-actions-row">
                            <button class="btn-mode consult" onclick="sendToGemini('consult')">
                                <svg class="icon-sprite">
                                    <use href="#icon-consult"></use>
                                </svg>
                                行程諮詢
                            </button>
                            <button class="btn-mode trans" onclick="sendToGemini('translate')">
                                <svg class="icon-sprite">
                                    <use href="#icon-trans"></use>
                                </svg>
                                中/日翻譯
                            </button>
                            <button class="btn-mode voice" id="btn-voice-ja" onclick="startVoiceRecognition()">
                                <svg class="icon-sprite">
                                    <use href="#icon-voice"></use>
                                </svg>
                                語音輸入
                            </button>
                            <button class="btn-mode voice recording" id="btn-voice-stop"
                                onclick="stopVoiceRecognition()"
                                style="display: none; background: #EF4444; color: white;">
                                <svg class="icon" viewBox="0 0 24 24">
                                    <rect x="6" y="6" width="12" height="12"></rect>
                                </svg>
                                停止
                            </button>
                            <button class="btn-mode camera"
                                onclick="document.getElementById('img-upload-input').click()">
                                <svg class="icon-sprite">
                                    <use href="#icon-camera"></use>
                                </svg>
                                拍照辨識
                            </button>
                            <input type="file" id="img-upload-input" accept="image/*"
                                onchange="handleImageSelect(event)" style="display: none;">
                        </div>
                    </div>
                    <!-- [新增] AI 圖片預覽區 -->
                    <div id="ai-image-preview-container" class="horizontal-scroll-container"
                        style="margin-top: 8px; display: none;">
                        <!-- 預覽圖卡片會動態加在這裡 -->
                    </div>
                </div>

                <button id="btn-back-trans" class="btn-ai-reset" onclick="showAiTranslatorMode()">
                    ↩️ 返回一般模式
                </button>
            </div>

            <!-- [Block 1] 相對位置 (OpenStreetMap) (Moved to Bottom) -->
            <div class="card" style="flex-shrink: 0; margin-bottom: 0;">
                <div class="ai-header" style="margin-bottom: 8px;">
                    <svg class="icon-mini" style="width: 20px; height: 20px; color: #EF4444;" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    <span>相對位置</span>
                    <button class="btn-refresh-map" onclick="refreshMapLocation()" style="
                        background: none; border: none; cursor: pointer; padding: 4px; 
                        margin-left: auto; display: flex; align-items: center; justify-content: center;
                        color: #6B7280; transition: color 0.2s;
                    " title="重新定位">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M23 4v6h-6"></path>
                            <path d="M1 20v-6h6"></path>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                    </button>
                    <!-- [新增] 隱身模式按鈕 -->
                    <button id="btn-incognito" class="btn-icon-circle" style="
                        width: 32px; height: 32px; border-radius: 50%; border: 1px solid #E5E7EB; background: white;
                        display: flex; align-items: center; justify-content: center;
                        color: #6B7280; transition: all 0.2s; margin-left: 8px;
                    " title="隱身模式 (點擊切換)">
                        <!-- 預設顯示「眼睛 (可見)」 -->
                        <svg id="icon-visible" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path
                                d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" />
                        </svg>
                        <!-- 隱藏時顯示「閉眼 (隱身)」 -->
                        <svg id="icon-invisible" viewBox="0 0 24 24" width="20" height="20" fill="currentColor"
                            style="display: none;">
                            <path
                                d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-4.01.7l2.16 2.16C10.5 7.17 11.23 7 12 7zM2 4.27l2.28 2.28.46.46A11.804 11.804 0 0 0 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z" />
                        </svg>
                    </button>
                </div>
                <div style="position: relative;">
                    <div id="ai-osm-map" style="height: 440px; width: 100%; border-radius: 8px; z-index: 1;"></div>

                </div>
            </div>
        </div>
    </div>

    <!-- TAB 6: 旅程記錄 (New) -->
    <div id="view-ledger" class="container">
        <div class="card" style="margin-bottom: 12px; background: #5A92E8; color: white;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px;">
                <div id="ledger-header-info">
                    <div style="font-size: 0.8rem; opacity: 0.9;" id="ledger-view-title">公費總支出 (JPY)</div>
                    <div id="ledger-total-amount" style="font-size: 1.5rem; font-weight: 700;">¥ 0</div>
                </div>

                <div style="display: flex; gap: 8px;">
                    <button onclick="filterLedgerView('finance')" class="btn-icon-circle" id="btn-view-finance">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"></path>
                            <path d="M12 18V6"></path>
                        </svg>
                    </button>
                    <button onclick="filterLedgerView('note')" class="btn-icon-circle" id="btn-view-note"
                        style="opacity: 0.6;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                        </svg>
                    </button>
                    <button onclick="syncLedgerData()" class="btn-icon-circle">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path
                                d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="card" id="ledger-input-card" style="margin-bottom: 15px;">
            <div class="card-content" style="padding: 12px;">
                <!-- [新增] 使用者狀態顯示 (點擊可切換身分) -->
                <div id="user-status-display" class="user-status-card" onclick="showLogoutPopup()">
                    <div class="user-info-left">
                        <div id="display-current-avatar" class="current-avatar">👤</div>
                        <div class="current-user-text">
                            <span class="current-user-label">目前記錄身分</span>
                            <div style="display: flex; align-items: baseline; gap: 8px;">
                                <span id="display-current-name" class="current-user-name">請登入</span>
                                <span id="user-private-total"
                                    style="color: #2563EB; font-weight: bold; font-size: 0.9rem;"></span>
                            </div>
                        </div>
                    </div>
                    <div class="btn-switch-user">切換</div>
                    <!-- 隱藏欄位，確保相容舊有的 handleLedgerSubmit -->
                    <input type="hidden" id="custom-user-name" value="">
                    <input type="hidden" id="selected-user-info" value="">
                </div>

                <div id="ledger-finance-fields">
                    <!-- [新增] Row 1: 日期與付款方式 (分為兩列，含標籤，對齊下方輸入框) -->
                    <div style="margin-bottom: 8px; margin-right: 50px;">
                        <!-- Line 1: Date -->
                        <div style="display: flex; gap: 6px; margin-bottom: 8px; align-items: center;">
                            <label style="font-size: 0.85rem; color: #666; width: 36px; text-align: center;">日期</label>
                            <input type="date" id="ledger-date"
                                style="flex: 1; min-width: 0; height: 38px; padding: 2px 4px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; -webkit-appearance: none; appearance: none; background: #fff; color: #4B5563; font-size: 0.85rem; text-align: center;">
                        </div>
                        <!-- Line 2: Payment -->
                        <div style="display: flex; gap: 6px; align-items: center;">
                            <label style="font-size: 0.85rem; color: #666; width: 36px; text-align: center;">付款</label>
                            <select id="ledger-payment-method"
                                style="flex: 1; min-width: 0; height: 38px; padding: 2px 4px; border: 1px solid #ddd; border-radius: 8px; background: white; color: #4B5563; font-size: 0.85rem;">
                                <option value="cash" selected>💵 現金</option>
                                <option value="card">💳 刷卡</option>
                                <option value="ic">🐧 IC卡</option>
                                <option value="pay">📱 Pay</option>
                            </select>
                            <label style="font-size: 0.85rem; color: #666; margin: 0 4px;">支付</label>
                            <select id="ledger-pay-type"
                                style="flex: 1; min-width: 0; height: 38px; padding: 2px 4px; border: 1px solid #ddd; border-radius: 8px; background: white; color: #4B5563; font-size: 0.85rem;">
                                <option value="public" selected>公費</option>
                                <option value="private">個人</option>
                            </select>
                        </div>
                    </div>

                    <!-- Row 2: 品項與金額 -->
                    <div style="display: flex; gap: 6px; align-items: center;">
                        <!-- [新增] 掃描按鈕 (藍色無框線) -->
                        <button onclick="document.getElementById('bill-scan-input').click()"
                            style="width: 36px; height: 36px; padding: 0; border: none; background: transparent; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #2563EB;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 7V5a2 2 0 0 1 2-2h2"></path>
                                <path d="M17 3h2a2 2 0 0 1 2 2v2"></path>
                                <path d="M21 17v2a2 2 0 0 1-2 2h-2"></path>
                                <path d="M7 21H5a2 2 0 0 1-2-2v-2"></path>
                                <rect x="7" y="7" width="10" height="10" rx="1"></rect>
                                <line x1="12" y1="10" x2="12" y2="14"></line>
                                <line x1="10" y1="12" x2="14" y2="12"></line>
                            </svg>
                        </button>
                        <input type="file" id="bill-scan-input" accept="image/*" capture="environment"
                            onchange="handleBillFileChange(event)" style="display: none;">

                        <input type="text" id="ledger-item" placeholder="項目內容..."
                            style="flex: 1.5; min-width: 0; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        <input type="number" id="ledger-amount" placeholder="金額" inputmode="decimal"
                            style="flex: 1; min-width: 0; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        <button onclick="handleLedgerSubmit()" class="btn-submit-ghost btn-submit-ledger"
                            style="width: 44px; height: 42px; margin: 0; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 8px; flex-shrink: 0;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                        <!-- [新增] 放棄變更按鈕 (Finance) 縮小 (26->22) -->
                        <button id="btn-cancel-edit-finance" onclick="exitEditMode()" class="btn-cancel-edit"
                            style="display: none; width: 22px; height: 22px; margin: 0; padding: 0; align-items: center; justify-content: center; border-radius: 50%; border: none; background: #EF4444; flex-shrink: 0; cursor: pointer;">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"
                                stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                </div>

                <div id="ledger-note-fields" style="display: none;">
                    <div style="display: flex; gap: 8px; align-items: flex-end;">
                        <!-- Left Column: Date + Note -->
                        <div style="flex: 1; display: flex; flex-direction: column; min-width: 0;">
                            <!-- Date Input (Compact: 32px) -->
                            <input type="date" id="ledger-note-date"
                                style="display: block; width: 100%; height: 32px; margin: 0 0 6px 0; padding: 4px 8px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem; color: #4B5563; background: #fff; box-sizing: border-box; -webkit-appearance: none; appearance: none;">

                            <!-- Note Textarea Box (Adjusted Height) -->
                            <div
                                style="display: flex; flex-direction: column; width: 100%; margin: 0; border: 1px solid #ddd; border-radius: 8px; padding: 6px; background: white; box-sizing: border-box;">
                                <textarea id="ledger-note-content" placeholder="寫下旅程點滴..."
                                    style="width: 100%; height: 60px; padding: 2px; border: none; outline: none; resize: none; font-size: 0.95rem; line-height: 1.4;"></textarea>

                                <!-- 圖片預覽水平捲軸 (移入輸入框內) -->
                                <div id="note-image-preview" class="horizontal-scroll-container"
                                    style="display: none; margin-top: 6px; border-top: 1px dashed #eee; padding-top: 6px;">
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Buttons -->
                        <div style="display: flex; align-items: flex-end; gap: 8px; padding-bottom: 0;">

                            <!-- Column: Image + Submit -->
                            <div
                                style="display: flex; flex-direction: column; align-items: center; justify-content: flex-end; gap: 4px;">

                                <!-- [新增] 公告按鈕 (Pin Input) -->
                                <button onclick="toggleAnnouncementMode(this)" id="btn-pin-note"
                                    style="width: 44px; height: 28px; margin: 0; padding: 0; display: flex; align-items: center; justify-content: center; border: none; background: transparent; cursor: pointer; color: #9CA3AF; transition: color 0.3s;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                        style="transform: rotate(45deg);">
                                        <line x1="12" y1="17" x2="12" y2="22"></line>
                                        <path
                                            d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z">
                                        </path>
                                    </svg>
                                </button>

                                <!-- Image Button (Compact Height ~28px) -->
                                <button onclick="document.getElementById('multi-img-input').click()"
                                    style="width: 44px; height: 28px; margin: 0; padding: 0; display: flex; align-items: center; justify-content: center; border: none; background: transparent; cursor: pointer;">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2563EB"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                        <polyline points="21 15 16 10 5 21"></polyline>
                                    </svg>
                                </button>
                                <!-- Submit Button -->
                                <button onclick="handleLedgerSubmit()" class="btn-submit-ghost btn-submit-ledger"
                                    style="width: 44px; height: 44px; margin: 0; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 8px; border: 1px solid #E5E7EB; flex-shrink: 0; background: transparent;">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2563EB"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="22" y1="2" x2="11" y2="13"></line>
                                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                    </svg>
                                </button>
                            </div>

                            <!-- Cancel Button (Outside the column, aligned to bottom right) -->
                            <button id="btn-cancel-edit-note" onclick="exitEditMode()" class="btn-cancel-edit"
                                style="display: none; width: 22px; height: 22px; margin: 0 0 9px 0; padding: 0; align-items: center; justify-content: center; border-radius: 50%; border: none; background: #EF4444; flex-shrink: 0; cursor: pointer;">
                                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white"
                                    stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>

                            <!-- Hidden Input -->
                            <input type="file" id="multi-img-input" multiple accept="image/*" style="display: none;"
                                onchange="handleMultiImageSelect(event)">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="ledger-list" style="margin-bottom: 80px;"></div>
    </div>

    <!-- 自定義彈出視窗 HTML -->
    <div id="location-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">手動設定位置</div>
            <div class="modal-desc" id="modal-msg">無法取得 GPS 定位，請手動輸入您所在的城市以進行溫差比對。</div>
            <input type="text" id="modal-city-input" class="modal-input" placeholder="例如: 台北, Taichung" value="台北">
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeModal()">取消</button>
                <button class="modal-btn btn-confirm" onclick="submitManualLocation()">確定</button>
            </div>
        </div>
    </div>
    <div id="note-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 350px; text-align: left; position: relative;">

            <div
                style="position: absolute; top: 5px; right: 5px; display: flex; align-items: center; gap: 4px; z-index: 20;">

                <button class="btn-modal-close-x" style="position: static;"
                    onclick="document.getElementById('note-img-input').click()" title="插入照片">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" style="width: 20px; height: 20px;">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                </button>

                <button class="btn-modal-close-x" style="position: static;" onclick="closeNoteModal()" title="關閉">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" style="width: 20px; height: 20px;">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="modal-title"
                style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px; padding-right: 80px;">
                <span style="display:flex; align-items:center; gap:6px;">
                    <svg class="icon-mini" style="color:#2563EB;" viewBox="0 0 24 24">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    隨身圖文筆記
                </span>
                <span id="note-status" style="font-size:0.75rem; color:#10B981; font-weight:normal;"></span>
            </div>

            <input type="file" id="note-img-input" accept="image/*" style="display:none;"
                onchange="insertNoteImage(event)">

            <div id="note-area" class="note-editable-box" contenteditable="true" placeholder="在這裡記下停車位號碼、照片..."></div>

        </div>
    </div>
    <div id="calc-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 340px; padding: 25px 20px 20px 20px; position: relative;">

            <button class="btn-modal-close-x" onclick="closeCalcModal()">×</button>

            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom:10px; border-bottom:1px solid #eee; margin-right: 30px;">
                <button id="btn-swap-cur" onclick="toggleCurrency()"
                    style="background:#EFF6FF; border:1px solid #BFDBFE; border-radius:20px; padding:5px 12px; font-size:0.85rem; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:5px;">
                    <span id="cur-label-main" style="color:#2563EB">JPY</span>
                    <svg style="width:16px;height:16px; color:#6B7280;" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 17H4M4 17L8 13M4 17L8 21M4 7H20M20 7L16 3M20 7L16 11" />
                    </svg>
                    <span id="cur-label-sub" style="color:#059669">TWD</span>
                </button>

                <div style="display: flex; align-items: center; gap: 5px; font-size: 0.85rem; color: #666;">
                    <label>匯率:</label>
                    <input type="number" id="calc-rate" step="0.001"
                        style="width: 65px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-weight:bold; color:#D97706;"
                        oninput="reCalcTotal()">
                </div>
            </div>

            <div class="calc-display">
                <div class="calc-expr" id="calc-expr-display"></div>
                <div class="calc-main" id="calc-main-display">¥0</div>
                <div class="calc-sub" id="calc-sub-display">≈ NT$0</div>
            </div>

            <div class="calc-keypad">
                <button class="calc-btn ac" onclick="calcInput('AC')">AC</button>
                <button class="calc-btn op" onclick="calcInput('DEL')">⌫</button>
                <button class="calc-btn op" onclick="calcInput('/')">÷</button>
                <button class="calc-btn op" onclick="calcInput('*')">×</button>

                <button class="calc-btn" onclick="calcInput('7')">7</button>
                <button class="calc-btn" onclick="calcInput('8')">8</button>
                <button class="calc-btn" onclick="calcInput('9')">9</button>
                <button class="calc-btn op" onclick="calcInput('-')">-</button>

                <button class="calc-btn" onclick="calcInput('4')">4</button>
                <button class="calc-btn" onclick="calcInput('5')">5</button>
                <button class="calc-btn" onclick="calcInput('6')">6</button>
                <button class="calc-btn op" onclick="calcInput('+')">+</button>

                <button class="calc-btn" onclick="calcInput('1')">1</button>
                <button class="calc-btn" onclick="calcInput('2')">2</button>
                <button class="calc-btn" onclick="calcInput('3')">3</button>

                <button class="calc-btn eq" onclick="calcInput('=')">=</button>

                <button class="calc-btn zero" onclick="calcInput('0')">0</button>
                <button class="calc-btn" onclick="calcInput('.')">.</button>

            </div>
        </div>
    </div>
    <div id="img-preview-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">確認圖片</div>
            <div
                style="background:#F3F4F6; padding:10px; border-radius:8px; margin-bottom:15px; display:flex; justify-content:center;">
                <img id="img-preview-content"
                    style="max-width:100%; max-height:300px; border-radius:4px; object-fit:contain;">
            </div>
            <div class="modal-desc" style="font-size:0.85rem; color:#666; margin-bottom:15px;">
                確認要傳送這張圖片給 AI 進行分析嗎？
            </div>
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="cancelImagePreview()">取消</button>
                <button class="modal-btn btn-confirm" onclick="confirmImageAnalysis()">開始辨識</button>
            </div>
        </div>
    </div>
    <!-- Bottom Navigation Bar (6 items now) -->

    <nav class="nav-bar">
        <div class="nav-item active" data-target="view-schedule" onclick="switchTab(this)">
            <span class="nav-icon">
                <svg class="icon-sprite">
                    <use href="#icon-schedule"></use>
                </svg>
            </span>
            行程表
        </div>
        <div class="nav-item" data-target="view-stay" onclick="switchTab(this)">
            <span class="nav-icon">
                <svg class="icon-sprite">
                    <use href="#icon-stay"></use>
                </svg>
            </span>
            住宿資訊
        </div>
        <div class="nav-item" data-target="view-car" onclick="switchTab(this)">
            <span class="nav-icon">
                <svg class="icon-sprite">
                    <use href="#icon-car"></use>
                </svg>
            </span>
            交通資訊
        </div>
        <div class="nav-item" data-target="view-info" onclick="switchTab(this)">
            <span class="nav-icon">
                <svg class="icon-sprite">
                    <use href="#icon-info"></use>
                </svg>
            </span>
            旅遊資訊
        </div>

        <div class="nav-item" data-target="view-ledger" onclick="switchTab(this)">
            <span class="nav-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"></path>
                    <path d="M12 18V6"></path>
                </svg>
            </span>
            旅程記錄
        </div>

        <div class="nav-item" data-target="view-ai" onclick="switchTab(this)">
            <span class="nav-icon">
                <svg class="icon-sprite">
                    <use href="#icon-ai"></use>
                </svg>
            </span>
            AI 助手
        </div>
    </nav>
    <button id="btn-quick-note" class="float-note-btn" onclick="openNoteModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
    </button>
    <button id="btn-calc" class="float-calc-btn" onclick="openCalcModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
        </svg>
    </button>
    <button id="btn-share-loc" class="float-share-btn" onclick="shareCurrentLocation()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle>
        </svg>

    </button>

    <div id="weather-detail-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 400px; padding: 20px; max-height: 85vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div class="modal-title" id="wd-title" style="margin:0; font-size:1.3rem; color: #1F2937;">--</div>

                <div class="modal-header-actions">
                    <button id="wd-btn-refresh" class="btn-header-icon" title="重新整理">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                            stroke-linejoin="round">
                            <path d="M23 4v6h-6"></path>
                            <path d="M1 20v-6h6"></path>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                    </button>

                    <button class="btn-header-icon"
                        onclick="document.getElementById('weather-detail-modal').style.display='none'" title="關閉">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                            stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="cw-container">
                <div class="cw-header">
                    <div class="cw-temp-big" id="wd-cur-temp">--°</div>
                    <div class="cw-info-col">
                        <div class="cw-condition" id="wd-cur-desc">--</div>
                        <div class="cw-hl-temp" id="wd-cur-hl">高:-- 低:--</div>
                    </div>
                </div>
                <div class="cw-grid">
                    <div class="cw-card">
                        <div class="cw-label">體感</div>
                        <div class="cw-value" id="wd-feel">--°</div>
                    </div>
                    <div class="cw-card">
                        <div class="cw-label">降雨率</div>
                        <div class="cw-value" id="wd-pop">--%</div>
                    </div>
                    <div class="cw-card">
                        <div class="cw-label">紫外線</div>
                        <div class="cw-value" id="wd-uv">--</div>
                    </div>
                    <div class="cw-card">
                        <div class="cw-label">風速</div>
                        <div class="cw-value" id="wd-wind">--</div>
                    </div>
                </div>
            </div>
            <div class="astro-box">
                <div class="astro-left-col">
                    <div class="astro-item">
                        <div class="astro-icon">
                            <svg class="icon-sunrise" viewBox="0 0 24 24">
                                <path d="M17 18a5 5 0 0 0-10 0"></path>
                                <line x1="12" y1="2" x2="12" y2="9"></line>
                                <polyline points="8 6 12 2 16 6"></polyline>

                                <line x1="4.22" y1="10.22" x2="5.64" y2="11.64"></line>
                                <line x1="1" y1="18" x2="3" y2="18"></line>
                                <line x1="21" y1="18" x2="23" y2="18"></line>
                                <line x1="18.36" y1="11.64" x2="19.78" y2="10.22"></line>
                                <line x1="23" y1="22" x2="1" y2="22"></line>
                                <polyline points="8 6 12 2 16 6"></polyline>
                            </svg>
                        </div>
                        <span class="astro-time" id="wd-sunrise">--:--</span>
                    </div>

                    <div class="astro-item">
                        <div class="astro-icon">
                            <svg class="icon-sunset" viewBox="0 0 24 24">
                                <path d="M17 18a5 5 0 0 0-10 0"></path>
                                <line x1="12" y1="9" x2="12" y2="2"></line>
                                <path d="M8 5 L12 9 L16 5"></path>

                                <line x1="4.22" y1="10.22" x2="5.64" y2="11.64"></line>
                                <line x1="1" y1="18" x2="3" y2="18"></line>
                                <line x1="21" y1="18" x2="23" y2="18"></line>
                                <line x1="18.36" y1="11.64" x2="19.78" y2="10.22"></line>
                                <line x1="23" y1="22" x2="1" y2="22"></line>
                            </svg>
                        </div>
                        <span class="astro-time" id="wd-sunset">--:--</span>
                    </div>
                </div>

                <div class="astro-right-col">
                    <div id="wd-diff-badge" class="diff-badge diff-same" style="display:none;">
                        計算中...
                    </div>
                    <div id="wd-advice-text" class="advice-text-small">
                        正在分析當地穿著建議...
                    </div>
                </div>
            </div>

            <div style="font-size: 0.9rem; font-weight: 700; margin-bottom: 5px; color: #4B5563;">未來 24 小時預報</div>
            <div class="weather-detail-scroll" id="wd-hourly-list">
                <div style="padding:10px; color:#999;">載入中...</div>
            </div>

            <div style="font-size: 0.9rem; font-weight: 700; margin-top: 10px; margin-bottom: 5px; color: #4B5563;">未來 7
                天預報</div>
            <div id="wd-daily-list"></div>

        </div>
    </div>
    <div id="lightbox-modal" class="lightbox-overlay" onclick="closeLightbox()">
        <span class="lightbox-close">&times;</span>
        <img class="lightbox-content" id="lightbox-img">
    </div>

    <script>
        // [新增] 控制過場畫面消失的邏輯
        window.addEventListener('load', () => {
            const splash = document.getElementById('splash-screen');

            // 設定最短顯示時間 (例如 1.5 秒)，讓使用者看得到飛機，不會一閃而過
            setTimeout(() => {
                if (splash) {
                    splash.classList.add('hidden');

                    // 動畫結束後，將元素從 DOM 移除，釋放記憶體
                    setTimeout(() => {
                        splash.remove();
                    }, 600); // 配合 CSS transition 的 0.6s
                }
            }, 1500); // 1500毫秒 = 1.5秒，您可自行調整
        });

        // 原有的程式碼...
        // const encryptedApiKey = ...

        // [修改] 原本的 const apiKey = ""; 替換成以下內容：

        // [新增] 雨滴特效計時器管理 (避免切換分頁時殘留)
        // [修改] 雨滴特效計時器與物理引擎管理
        window.rainTimers = [];
        window.rainInterval = null;
        window.rainPhysicsFrame = null; // ★ 新增：物理運算幀代碼

        function clearRainTimers() {
            // 1. 清除計時器
            if (window.rainTimers) {
                window.rainTimers.forEach(t => clearTimeout(t));
                window.rainTimers = [];
            }
            // 2. 停止生成新水流
            if (window.rainInterval) {
                clearInterval(window.rainInterval);
                window.rainInterval = null;
            }
            // 3. ★ 停止物理碰撞偵測迴圈 (避免切換頁面後還在背景運算)
            if (window.rainPhysicsFrame) {
                cancelAnimationFrame(window.rainPhysicsFrame);
                window.rainPhysicsFrame = null;
            }
        }
        // [修改] 1. 定義兩組加密亂碼 (請將您的 AES 加密字串分別填入)
        // 用於 Gemini AI 對話、翻譯
        const encryptedGeminiKey = "U2FsdGVkX1+nfsR3iRTUhVLmg5tFktJ/a0pmOHAqyOtTirUSq9f0ecLMbxUJJcThglRe9faATNugHJ/1eQAAxQ==";
        // 用於 Google Places (分享位置時抓地標名稱)
        const encryptedPlacesKey = "U2FsdGVkX1/8kyFaxEPoelwm4PAoa+8/5wkmP0ob/Vhfkg6S+i+sN8Vv98Hb4wn8Xs33BPKC/OthWwUus2i7fQ==";
        // [安插在其他 ENC_ 變數群組中]
        const encryptedGasUrl = "U2FsdGVkX18EA8uUdoOzW15ZohySIYIGuYU0P1H0ccmeUliIulTPDQtUgwdb2mTOo9a9UazKGSMqAoSnRu2+erBWzOP5WoYAzX/iUdapUMWXj2rYqahij7MUhwAQKfv0agb0fCfYWqvJyHJ0XGUpyDbGGcyM09qCLSA3NLg9rqEV2FBCnbs66s0Te9T7SMl9"; // 填入您的 URL 密文
        const encryptedGasToken = "U2FsdGVkX18Ai8D1RX8NE51l8+0dsJK8BALcZZmlq78="; // 填入您的 Token 密文

        // [安插在其他 API_KEY 全域變數群組中]
        let gasUrl = "";
        let gasToken = "";
        // [修改] 2. 用來暫存解密後的 Key
        let geminiKey = "";
        let googleKey = "";
        let currentLedgerFilter = 'finance'; // 預設顯示記帳視圖
        let rawLedgerData = [];              // 存放從 GAS 抓回來的原始資料快取

        // [新增] 對話歷史紀錄 (讓 AI 記住前幾句話)
        let conversationHistory = [];
        // [新增] AI 導遊的系統提示詞 (這裡定義了它的記憶與人設)
        const systemPrompt = `
    你是一位深耕東京旅遊、語氣優雅且懂生活的「時尚旅遊領隊」。
你的任務是協助三位姊妹淘（30-40歲，暫時放下小孩的媽媽們）完成 2026/04/18 - 04/20 的東京之旅。

[核心行程資料]
- Day 1: 羽田(04:25抵達) -> 泉天空之湯 -> 芝公園/飯店(Prince Park Tower) -> 表參道 -> 麻布台之丘。
- Day 2: 代官山(蔦屋書店/土屋鞄) -> 中目黑 -> 澀谷(SHIBUYA SKY 夕陽時段需預約) -> 惠比壽燒肉。
- Day 3: 銀座購物(GINZA SIX/Uniqlo) -> 下午茶 -> 16:30 離境移動 -> 成田(19:30 班機 IT203)。
    
    【回答原則】
    [回應原則]
1. 語氣：親切如好友。使用「貴婦節奏」、「輕盈散步」等形容詞。
2. 專業：精確掌握交通時間（特別是 D3 回成田的 16:30 截止點）。
3. 拍照：隨時主動提醒行程中的絕美拍照點，並給予構圖建議。
4. 育兒：雖是無孩旅行，但若提到小孩商品（如國小書包、青少年衣服），請給予銀座或代官山的專業選購建議。
5. 簡潔：你是在手機上被閱讀，回答請精簡，不要長篇大論。
6. 親切：語氣要像朋友一樣熱心。
7. 準確：僅討論行程內涉及或相關的東京區域，不隨意延伸，不要編造不在行程活動範圍內的景點。
8. 語言：請使用繁體中文 (台灣)。
9. 回覆必須條列化，保持資訊易讀性。
10. 導航支援：若使用者詢問地點位置或如何前往，請務必在回答中附上 Google Maps 連結，格式請嚴格遵守：
       <br><a href='https://www.google.com/maps/search/?api=1&query=地點名稱' target='_blank' style='display:inline-flex; align-items:center; gap:4px; margin-top:5px; color:#2563EB; font-weight:bold; text-decoration:none; border:1px solid #2563EB; padding:2px 8px; border-radius:12px;'><svg style='width:14px;height:14px;fill:none;stroke:currentColor;stroke-width:2;' viewBox='0 0 24 24'><use href='#icon-loc'></use></svg>導航至 [地點]</a>
    `;
        // 3. 解密函式 (會在需要 API 時自動呼叫)
        // [修改] 3. 雙鑰匙解密函式 (傳入 'gemini' 或 'places' 取得對應 Key)
        // --- 有一說一：新增格式化函式 ---
        function formatLedgerTime(isoString) {
            if (!isoString) return "";
            try {
                const date = new Date(isoString);
                // 回傳如 "14:25" 格式
                return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
            } catch (e) {
                return "";
            }
        }

        function getKey(type) {
            // A. 如果記憶體中已經有解好的 Key，直接回傳
            if (type === 'gemini' && geminiKey) return geminiKey;
            if (type === 'places' && googleKey) return googleKey;
            if (type === 'gas_url' && gasUrl) return gasUrl;
            if (type === 'gas_token' && gasToken) return gasToken;

            // B. 讀取密碼 (兩把鑰匙共用同一個密碼 'app_password')
            let password = localStorage.getItem("app_password");

            // 如果連本機都沒有密碼，才跟使用者要一次
            if (!password) {
                password = prompt("請輸入 API 金鑰密碼 (輸入一次後將在本機記憶，直到您重設為止)：");
                if (!password) return null; // 使用者取消
            }

            try {
                // C. 內部輔助：單純解密字串
                const decrypt = (cipher) => {
                    if (!cipher) return "";
                    const bytes = CryptoJS.AES.decrypt(cipher, password);
                    return bytes.toString(CryptoJS.enc.Utf8);
                };

                // D. 嘗試用同一組密碼解開兩把鑰匙
                const g_key = decrypt(encryptedGeminiKey);
                const p_key = decrypt(encryptedPlacesKey);
                const g_url = decrypt(encryptedGasUrl);
                const g_token = decrypt(encryptedGasToken);

                // 驗證機制 (依據您的習慣，只要成功解開一個代表密碼正確)
                if (g_key.startsWith("AIza") || g_url.startsWith("https")) {
                    geminiKey = g_key;
                    googleKey = p_key;
                    gasUrl = g_url;
                    gasToken = g_token;

                    // 重要：密碼正確，存入本機記憶
                    localStorage.setItem("app_password", password);
                    // 【安插此行】啟動時自動同步資料
                    syncLedgerData();
                    // 根據需求回傳
                    const map = { 'gemini': geminiKey, 'places': googleKey, 'gas_url': gasUrl, 'gas_token': gasToken };
                    return map[type];
                } else {
                    alert("密碼錯誤，請重新嘗試。");
                    localStorage.removeItem("app_password"); // 錯誤就清掉
                    return null;
                }
            } catch (e) {
                console.error("解密出錯", e);
                localStorage.removeItem("app_password");
                return null;
            }
        }


        // [開始] 替換 switchView
        function switchView(viewId) {
            // 隱藏所有容器，顯示目標容器
            document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');

            // 更新導覽列狀態
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.getAttribute('onclick').includes(viewId));
            });

            // 針對特定分頁的初始化
            if (viewId === 'view-ledger') {
                syncLedgerData();
                // 確保 DOM 已經準備好再初始化頭像選擇器
                requestAnimationFrame(() => {
                    initAvatarSelector();
                });
            }
        }
        // [結束] 替換 switchView

        // Weather Data Configuration
        // Icons: Using simple SVG strings for white icons


        const tripConfig = {
            'd1': {
                dateStr: '2026-04-18',
                loc: '東京',
                lat: 35.6895, lon: 139.6917, // 東京市區
                backup: { temp: '18°C', range: '12°C ~ 20°C', desc: '晴時多雲', advice: '春季氣候宜人，早晚微涼。', icon: 'cloud-sun' }
            },
            'd2': {
                dateStr: '2026-04-19',
                loc: '澀谷',
                lat: 35.6580, lon: 139.7016, // 澀谷區
                backup: { temp: '19°C', range: '14°C ~ 22°C', desc: '多雲', advice: '逛街行程建議穿著舒適好走的鞋子。', icon: 'cloud' }
            },
            'd3': {
                dateStr: '2026-04-20',
                loc: '銀座',
                lat: 35.6712, lon: 139.7665, // 中央區銀座
                backup: { temp: '20°C', range: '15°C ~ 23°C', desc: '晴朗', advice: '天氣溫暖，適合戶外購物行程。', icon: 'sun' }
            }
        };

        // [修改 2] 讓 Widget 支援非同步讀取與 Loading 狀態
        // [新增] 通用快取抓取函式 (10分鐘快取機制)
        // [新增] 全域快取變數 (重新整理網頁後會自動清空，符合您的需求)
        // [API 省流優化] 統一快取管理系統 (LocalStorage 版)
        const CACHE_SYSTEM = {
            // 存入資料 (預設 TTL 為 30 分鐘)
            save: (key, data, ttlMinutes = 30) => {
                try {
                    const record = {
                        timestamp: Date.now(),
                        expiry: ttlMinutes * 60 * 1000,
                        data: data
                    };
                    localStorage.setItem(key, JSON.stringify(record));
                } catch (e) {
                    console.warn("LocalStorage 儲存失敗 (可能是容量已滿)", e);
                }
            },
            // 讀取資料
            get: (key) => {
                const json = localStorage.getItem(key);
                if (!json) return null;

                try {
                    const record = JSON.parse(json);
                    const now = Date.now();

                    // 檢查是否過期
                    if (now - record.timestamp > record.expiry) {
                        console.log(`[快取過期] ${key} 已清除`);
                        localStorage.removeItem(key);
                        return null;
                    }

                    console.log(`[省流模式] 讀取 LocalStorage: ${key}`);
                    return record.data;
                } catch (e) {
                    return null;
                }
            }
        };

        // [修改] 支援 LocalStorage 的 Fetch 函式
        async function fetchWithCache(url, cacheKey) {
            // 1. 先查快取
            const cachedData = CACHE_SYSTEM.get(cacheKey);
            if (cachedData) return cachedData;

            // 2. 無快取則呼叫 API
            console.log(`[API消耗] 呼叫網路: ${url}`);
            try {
                const res = await fetch(url);
                const data = await res.json();

                // 3. 存入快取 (天氣資料存 20 分鐘)
                CACHE_SYSTEM.save(cacheKey, data, 20);
                return data;
            } catch (e) {
                console.error("Fetch Error:", e);
                return null;
            }
        }
        window.currentActiveConfig = null;

        async function updateWeatherWidget(dayId) {
            const config = tripConfig[dayId];
            if (!config) return;

            window.currentActiveConfig = config; // ★ 加入這一行！紀錄目前的設定

            // 1. 先顯示 Loading 狀態 (提升使用者體驗)
            document.getElementById('hw-loc').innerText = config.loc;
            //document.getElementById('hw-date').innerText = config.dateStr.slice(5); // 只顯示 MM-DD
            document.getElementById('hw-date').innerText = config.dateStr; // 只顯示 MM-DD
            document.getElementById('hw-temp').innerText = '--';
            document.getElementById('hw-desc').innerText = '讀取中...';
            document.getElementById('hw-range').innerText = '';
            document.getElementById('hw-advice').innerText = '資料更新中...';
            // 顯示一個簡單的載入圖示
            document.getElementById('hw-icon').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="animation: rotate 1s linear infinite;"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>`;

            // 2. 呼叫智慧判斷函數取得資料
            const data = await getSmartWeatherData(config);

            // 3. 更新畫面
            document.getElementById('hw-temp').innerText = data.temp;
            document.getElementById('hw-desc').innerText = data.desc;
            document.getElementById('hw-range').innerText = data.range;
            document.getElementById('hw-advice').innerText = data.advice;

            // 處理 Icon
            const iconType = data.icon || 'cloud';
            // 如果是 API 回傳的，我們只給代碼 (如 sun, cloud, rain)，如果沒對應到就給 cloud
            const validIcons = ['sun', 'cloud', 'cloud-sun', 'snow', 'rain', 'fog', 'lightning'];
            const finalIcon = validIcons.includes(iconType) ? iconType : 'cloud';

            document.getElementById('hw-icon').innerHTML = `<div class="weather-icon ${finalIcon}"></div>`;
            // ... 前面是 document.getElementById('hw-icon').innerHTML = ...

            // ★★★ [新增 Start] 依據日本當地的 isDay 切換 Header 背景 ★★★
            const header = document.querySelector('header');

            // 如果 API 有回傳 isDay (代表是即時資料)，就用它判斷
            if (data.isDay !== undefined) {
                if (data.isDay === 0) {
                    header.classList.add('is-night'); // 切換為黑夜
                } else {
                    header.classList.remove('is-night'); // 切換為白天
                }
            } else {
                // 如果是未來預報或離線資料，通常預設顯示白天比較美觀
                header.classList.remove('is-night');
            }
            // ★★★ [新增 End] ★★★

            setWeatherEffect(finalIcon);
        }
        // ★★★ [新增函式] 當行程摺頁全關閉時，還原回「我的位置」天氣與特效
        function resetHeaderToLocal() {
            /* --- 請在此處插入代碼 Start --- */
            // [修正] 強制清空目前選中的行程設定，讓 Modal 知道現在是「我的位置」模式
            window.currentActiveConfig = null;
            /* --- 請在此處插入代碼 End --- */

            // 1. 檢查是否有快取的定位資料
            if (!window.appCache || !window.appCache['my_location_combined']) {
                return; // 還沒定位過就不動作
            }

            const cached = window.appCache['my_location_combined'].data;
            const header = document.querySelector('header');

            // 2. 還原文字資訊
            document.getElementById('hw-loc').innerText = cached.city;
            document.getElementById('hw-date').innerText = '現在位置';
            document.getElementById('hw-temp').innerText = `${Math.round(cached.temp)}°C`;
            document.getElementById('hw-desc').innerText = getWeatherDescText(cached.code);
            document.getElementById('hw-range').innerText = '';
            document.getElementById('hw-advice').innerText = '顯示您所在地的即時天氣。';

            // 3. 還原日夜背景 (關鍵)
            if (cached.isDay === 0) {
                header.classList.add('is-night');
            } else {
                header.classList.remove('is-night');
            }

            // 4. 還原天氣圖示與特效
            const iconType = getWeatherIconClass(cached.code);
            document.getElementById('hw-icon').innerHTML = `<div class="weather-icon ${iconType}"></div>`;

            if (typeof setWeatherEffect === 'function') {
                setWeatherEffect(iconType);
            }
        }
        // [修改] 智慧判斷函式：改用「真實溫度」生成動態建議
        // [修改] 智慧判斷函式：加入 10 分鐘快取機制
        async function getSmartWeatherData(config) {
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0]; // 格式: YYYY-MM-DD

            const tripDate = new Date(config.dateStr);
            tripDate.setHours(0, 0, 0, 0);
            const todayDate = new Date();
            todayDate.setHours(0, 0, 0, 0);

            // --- 情境 A: 過去式 ---
            if (tripDate < todayDate) {
                console.log(`[${config.loc}] 是過去行程，使用靜態紀錄。`);
                return config.backup;
            }

            // --- 情境 B & C: 今天或未來 (呼叫 API + 快取) ---
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${config.lat}&longitude=${config.lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&current_weather=true&timezone=Asia%2FTokyo`;

                // ★ 產生唯一快取金鑰 (日期+地點)
                const cacheKey = `trip_weather_${config.dateStr}_${config.lat}`;

                // ★ 改用快取函式抓取
                const json = await fetchWithCache(url, cacheKey);

                const index = json.daily.time.indexOf(config.dateStr);
                let displayData = {};

                // 資料解析邏輯 (維持原本不變)
                if (config.dateStr === todayStr) {
                    const current = json.current_weather;
                    const todayMax = json.daily.temperature_2m_max[0];
                    const todayMin = json.daily.temperature_2m_min[0];

                    displayData = {
                        temp: `${Math.round(current.temperature)}°C`,
                        range: `${Math.round(todayMin)}°C ~ ${Math.round(todayMax)}°C`,
                        desc: getWeatherDescText(current.weathercode),
                        icon: getWeatherIconClass(current.weathercode),
                        advice: `(即時) ${getSmartAdviceText(current.temperature, current.weathercode)}`,
                        isDay: current.is_day // ★ 新增這行：回傳日本當地的日夜
                    };
                }
                else if (index !== -1) {
                    const code = json.daily.weathercode[index];
                    const max = json.daily.temperature_2m_max[index];
                    const min = json.daily.temperature_2m_min[index];
                    const avgTemp = (max + min) / 2;

                    displayData = {
                        temp: `${Math.round(avgTemp)}°C`,
                        range: `${Math.round(min)}°C ~ ${Math.round(max)}°C`,
                        desc: getWeatherDescText(code),
                        icon: getWeatherIconClass(code),
                        advice: `(預報) ${getSmartAdviceText(avgTemp, code)}`,
                        // ★★★ [新增] 強制帶入該地點「此時此刻」的日夜狀態 ★★★
                        // 這樣就算查看明天的行程，背景也會反映日本現在是黑夜
                        isDay: json.current_weather.is_day
                    };
                }
                else {
                    // 若超出預報範圍 (例如7天後)，顯示當下天氣作為參考
                    const current = json.current_weather;
                    const todayMax = json.daily.temperature_2m_max[0];
                    const todayMin = json.daily.temperature_2m_min[0];
                    displayData = {
                        temp: `${Math.round(current.temperature)}°C`,
                        range: `${Math.round(todayMin)}°C ~ ${Math.round(todayMax)}°C`,
                        desc: getWeatherDescText(current.weathercode),
                        icon: getWeatherIconClass(current.weathercode),
                        advice: `(行前參考) ${getSmartAdviceText(current.temperature, current.weathercode)}`,
                        isDay: current.is_day // ★★★ [新增] 補上這行
                    };
                }

                return displayData;

            } catch (e) {
                console.error("API 獲取失敗", e);
                return { ...config.backup, desc: config.backup.desc + ' (離線)', advice: '網路連線異常，顯示離線資料。' };
            }
        }

        // 輔助函式：將 WMO Code 轉成中文描述
        function getWeatherDescText(code) {
            if (code === 0) return '晴朗';
            if (code >= 1 && code <= 3) return '多雲';
            if (code >= 45 && code <= 48) return '有霧'; // [優化] 增加霧的判斷
            if (code >= 51 && code <= 67) return '有雨';
            if (code >= 71 && code <= 77) return '有雪';
            if (code >= 80 && code <= 82) return '陣雨';
            if (code >= 95) return '雷雨';
            return '多雲';
        }
        // [新增] 補上遺失的天氣狀態文字轉換函式 (用於詳細天氣 Modal)
        function getWeatherStatusText(code) {
            // 直接沿用 getWeatherDescText 的邏輯，或者可以寫得更簡短
            return getWeatherDescText(code);
        }

        // 輔助函式：將 WMO Code 轉成你的 CSS Icon Class
        function getWeatherIconClass(code) {
            if (code === 0) return 'sun';
            if (code <= 3) return 'cloud-sun'; // 或 cloud
            if (code <= 48) return 'fog'; // 你可能需要新增 fog 樣式，或用 cloud 代替
            if (code <= 67) return 'rain';
            if (code <= 77) return 'snow';
            if (code <= 82) return 'rain';
            if (code <= 99) return 'lightning'; // 你可能需要新增 lightning 樣式
            return 'cloud';
        }
        // [新增] 穿衣建議大腦：根據「溫度」與「天氣」自動生成建議
        function getSmartAdviceText(temp, weatherCode) {
            let advice = "";

            // 1. 溫度判斷 (基礎穿著)
            if (temp >= 30) {
                advice = "天氣炎熱，請著短袖並注意防曬補水。";
            } else if (temp >= 25) {
                advice = "氣溫舒適偏熱，短袖或薄衫即可。";
            } else if (temp >= 20) {
                advice = "氣溫宜人，建議穿著薄長袖或襯衫。";
            } else if (temp >= 15) {
                advice = "稍有涼意，建議長袖搭配薄外套或風衣。";
            } else if (temp >= 10) {
                advice = "天氣偏冷，請穿著毛衣、夾克或厚外套。";
            } else if (temp >= 5) {
                advice = "氣溫寒冷，務必穿著羽絨外套、發熱衣保暖。";
            } else {
                advice = "嚴寒低溫！請全副武裝，圍巾手套不可少。";
            }

            // 2. 特殊天氣追加提醒 (下雨/下雪)
            if (weatherCode >= 51 && weatherCode <= 67 || weatherCode >= 80 && weatherCode <= 82) {
                advice += " 外出請記得攜帶雨具。";
            } else if (weatherCode >= 71 && weatherCode <= 77) {
                advice += " 路面可能濕滑，請穿防滑鞋。";
            }

            return advice;
        }
        // --- REAL-TIME WEATHER FUNCTIONS (Using Open-Meteo Free API) ---
        let currentMyTemp = null;

        // 智慧地名翻譯對照表 (保留作為快速快取，節省 AI 資源)
        const cityMapping = {
            '由布院': 'Yufuin',
            '湯布院': 'Yufuin',
            '黑川': 'Minamioguni',
            '黑川溫泉': 'Minamioguni',
            '熊本': 'Kumamoto',
            '熊本市': 'Kumamoto',
            '阿蘇': 'Aso',
            '別府': 'Beppu',
            '福岡': 'Fukuoka',
            '博多': 'Fukuoka',
            '太宰府': 'Dazaifu',
            '高千穗': 'Takachiho'
        };

        // 新增：獨立的 Gemini 呼叫函數，只回傳文字，不操作 UI
        // [修改] Gemini API 呼叫函式：升級支援圖片傳送 (Multimodal)
        // [修改] Gemini API 呼叫函式：升級為最新的 Gemini 3 Flash Preview
        async function getGeminiResponse(promptText, imageBase64 = null) {
            // [修改] 指定獲取 Gemini 的 Key
            const currentKey = getKey('gemini');
            if (!currentKey) {
                appendMessage('ai', '⚠️ 尚未輸入正確密碼，無法使用 AI 功能。');
                throw new Error("API Key Missing");
            }

            try {
                // 1. 建立基本的 parts 陣列，先放入文字
                let parts = [
                    { text: promptText }
                ];

                // 2. 如果有圖片，使用 unshift 將圖片「插隊」到最前面
                if (imageBase64) {
                    parts.unshift({
                        inline_data: {
                            mime_type: "image/jpeg",
                            data: imageBase64
                        }
                    });
                }

                // 3. 組合請求內容
                const requestBody = {
                    contents: [{
                        parts: parts
                    }]
                };

                // ★ 關鍵修改：使用正確的 Gemini 3 Flash Preview 模型名稱
                // Release Date: 2025-12-17
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${currentKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (data.error) {
                    console.error("API Error Detail:", data.error);
                    throw new Error(data.error.message);
                }

                if (!data.candidates || !data.candidates[0].content) {
                    throw new Error("API 回傳無內容，請稍後再試。");
                }

                let text = data.candidates[0].content.parts[0].text.trim();
                text = text.replace(/```(html|json)?/g, '').replace(/```/g, '').trim();
                return text;

            } catch (error) {
                console.error("AI Fetch Error:", error);
                throw error;
            }
        }

        async function fetchRealtimeWeather() {
            const rawInput = document.getElementById('weather-city-input').value.trim();
            if (!rawInput) {
                alert('請輸入城市名稱');
                return;
            }

            // UI Loading State
            document.getElementById('weather-placeholder').style.display = 'none';
            document.getElementById('weather-result').style.display = 'block';
            document.getElementById('wc-loc').innerText = rawInput;
            document.getElementById('wc-desc').innerText = '準備中...';
            document.getElementById('wc-temp').innerText = '--°';
            document.getElementById('wc-advice').innerText = '...';

            let searchTerm = rawInput;
            let isTranslated = false;

            try {
                // 步驟 1: 先檢查快速對照表 (最快)
                for (const key in cityMapping) {
                    if (rawInput.includes(key)) {
                        searchTerm = cityMapping[key];
                        isTranslated = true;
                        console.log("使用內建對照表:", searchTerm);
                        break;
                    }
                }

                // 步驟 2: 如果對照表沒有，請求 AI 在背景翻譯 (您的新想法!)
                // 步驟 2: AI 背景翻譯 (已加入永久快取)
                if (!isTranslated) {
                    // [新增] 先查快取 (金鑰: city_trans_中文名)
                    const cacheKey = `city_trans_${rawInput}`;
                    const cachedName = CACHE_SYSTEM.get(cacheKey);

                    if (cachedName) {
                        searchTerm = cachedName;
                        isTranslated = true;
                        console.log("使用快取地名:", searchTerm);
                        document.getElementById('wc-desc').innerText = `搜尋: ${searchTerm} (快取)`;
                    } else {
                        // 無快取，才呼叫 AI
                        document.getElementById('wc-desc').innerText = '🔍 AI 正在翻譯地名...';

                        const translatePrompt = `
                            Task: Translate the place name "${rawInput}" into its official English Romanization name for using in a Weather API.
                            Target: Global locations (Focus on Taiwan/Japan).
                            Rule: Output ONLY the English name. No explanations.
                            Example: "台北" -> "Taipei", "由布院" -> "Yufuin", "新竹" -> "Hsinchu".
                        `;

                        try {
                            const aiTranslation = await getGeminiResponse(translatePrompt);
                            if (/^[a-zA-Z\s\-,]+$/.test(aiTranslation)) {
                                searchTerm = aiTranslation;
                                isTranslated = true;
                                console.log("AI 翻譯結果:", searchTerm);
                                document.getElementById('wc-desc').innerText = `搜尋: ${searchTerm}...`;

                                // [新增] 翻譯成功後，存入快取 (保存 24 小時 = 1440 分鐘)
                                CACHE_SYSTEM.save(cacheKey, searchTerm, 1440);
                            }
                        } catch (e) {
                            console.warn("AI 翻譯失敗，嘗試使用原始中文搜尋");
                        }
                    }
                }

                document.getElementById('wc-desc').innerText = '連線氣象衛星...';

                // 步驟 3: Geocoding API 查詢
                // 優先使用翻譯後的英文，若無則用中文
                // [修改] count=10 以獲取更多候選地點來篩選日本
                let geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(searchTerm)}&count=10&language=en&format=json`;
                let geoRes = await fetch(geoUrl);
                let geoData = await geoRes.json();

                // 英文找不到，最後嘗試中文
                if ((!geoData.results || geoData.results.length === 0) && isTranslated) {
                    geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(rawInput)}&count=10&language=zh&format=json`;
                    geoRes = await fetch(geoUrl);
                    geoData = await geoRes.json();
                }

                if (!geoData.results || geoData.results.length === 0) {
                    throw new Error(`找不到「${rawInput}」<br>AI 翻譯: ${searchTerm}`);
                }

                // [新增] 篩選邏輯：優先找日本的結果
                let targetLocation = geoData.results[0];
                const jpLocation = geoData.results.find(r => r.country_code === 'JP' || r.country === 'Japan');
                if (jpLocation) {
                    targetLocation = jpLocation;
                    console.log("已自動鎖定日本地點:", targetLocation.name);
                }

                const { latitude, longitude, name, country } = targetLocation;

                // 步驟 4: 取得天氣
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`;
                const weatherRes = await fetch(weatherUrl);
                const weatherData = await weatherRes.json();

                const temp = weatherData.current_weather.temperature;
                const weatherCode = weatherData.current_weather.weathercode;

                // --- [專家優化 Start]：依據即時氣溫動態調整背景顏色 ---
                const boxMain = document.getElementById('wc-box-main');
                const tempText = document.getElementById('wc-temp');

                // 清除舊的行內樣式 (重置為動態配色)
                boxMain.style.color = '';

                if (temp < 15) {
                    // 🥶 寒冷 (藍色系：淺藍底 + 深藍字)
                    boxMain.style.background = '#EFF6FF'; // 淺藍背景
                    boxMain.style.borderColor = '#BFDBFE'; // 藍色邊框
                    boxMain.style.color = '#1E3A8A';       // 深藍文字 (地名)
                    tempText.style.color = '#2563EB';      // 亮藍氣溫
                    // 修正陰影顏色為藍色調
                    boxMain.style.boxShadow = '0 4px 10px rgba(37, 99, 235, 0.15)';
                } else if (temp >= 15 && temp <= 25) {
                    // 🍃 舒適 (綠色系：淺綠底 + 深綠字)
                    boxMain.style.background = '#ECFDF5'; // 淺綠背景
                    boxMain.style.borderColor = '#6EE7B7'; // 綠色邊框
                    boxMain.style.color = '#064E3B';       // 深綠文字
                    tempText.style.color = '#059669';      // 亮綠氣溫
                    boxMain.style.boxShadow = '0 4px 10px rgba(5, 150, 105, 0.15)';
                } else {
                    // 🥵 炎熱 (橘色系：淺橘底 + 深橘字)
                    boxMain.style.background = '#FFF7ED'; // 淺橘背景
                    boxMain.style.borderColor = '#FED7AA'; // 橘色邊框
                    boxMain.style.color = '#7C2D12';       // 深褐文字
                    tempText.style.color = '#EA580C';      // 亮橘氣溫
                    boxMain.style.boxShadow = '0 4px 10px rgba(234, 88, 12, 0.15)';
                }
                // --- [專家優化 End] ---
                // Update UI with Vertical English Name (上下分層)
                let displayLocHtml = rawInput;
                if (searchTerm && searchTerm.toLowerCase() !== rawInput.toLowerCase()) {
                    displayLocHtml = `
                        <div style="display: flex; flex-direction: column; align-items: center; line-height: 1.2;">
                            <span>${rawInput}</span>
                            <span style="font-size: 0.6em; opacity: 0.8; font-weight: 400; margin-top: 4px; font-family: sans-serif; letter-spacing: 0.5px;">${searchTerm}</span>
                        </div>
                    `;
                }
                document.getElementById('wc-loc').innerHTML = displayLocHtml;

                document.getElementById('wc-temp').innerText = `${temp}°C`;
                // 修正 3: 改用 innerHTML 以支援 SVG 圖示
                document.getElementById('wc-desc').innerHTML = getWeatherDesc(weatherCode);

                // 步驟 5: 溫差對比
                updateComparison(temp);

                // 步驟 6: AI 穿衣建議
                document.getElementById('wc-advice').innerText = 'AI 正在分析當地氣候...';
                askAiWeatherAdvice(rawInput, temp, getWeatherDesc(weatherCode));

            } catch (error) {
                console.error(error);
                document.getElementById('wc-desc').innerText = '查詢失敗';

                let errorMsg = error.message;
                if (errorMsg.includes('Failed to fetch')) {
                    errorMsg = '網路連線被阻擋。<br>請檢查網路設定。';
                }

                document.getElementById('wc-advice').innerHTML = `<span style="color:var(--danger); font-weight:bold;">${errorMsg}</span>`;
            }
        }

        // 修正 2: 定義簡約天氣 SVG 圖示 (白色線條)
        const simpleIcons = {
            sun: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>',
            cloud: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>',
            rain: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 13v8"></path><path d="M8 13v8"></path><path d="M12 15v8"></path><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"></path></svg>',

            // [修改] 雪：更新為最新的雙重平行 V 型 + 六角冰核
            snow: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 9 L14.6 10.5 L14.6 13.5 L12 15 L9.4 13.5 L9.4 10.5 Z"/><path d="M12 9 V1 M12 15 V23 M14.6 10.5 L21.5 6.5 M14.6 13.5 L21.5 17.5 M9.4 13.5 L2.5 17.5 M9.4 10.5 L2.5 6.5"/><path d="M9.5 5.5 L12 7.5 L14.5 5.5 M9.5 2 L12 4 L14.5 2"/><path d="M9.5 18.5 L12 16.5 L14.5 18.5 M9.5 22 L12 20 L14.5 22"/><path d="M16.4 6.6 L15.9 9.75 L18.9 10.9 M19.4 4.8 L18.9 8 L21.9 9.2"/><path d="M18.9 13.1 L15.9 14.25 L16.4 17.4 M21.9 14.8 L18.9 16 L19.4 19.2"/><path d="M7.6 17.4 L8.1 14.25 L5.1 13.1 M4.6 19.2 L5.1 16 L2.1 14.8"/><path d="M5.1 10.9 L8.1 9.75 L7.6 6.6 M2.1 9.2 L5.1 8 L4.6 4.8"/></svg>',

            fog: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 6h14M4 10h16M6 14h12M4 18h16"></path></svg>',
            lightning: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9"></path><polyline points="13 11 9 17 15 17 11 23"></polyline></svg>'
        };

        function getWeatherDesc(code) {
            // Updated to return HTML with Simple SVG
            if (code === 0) return `晴朗 ${simpleIcons.sun}`;
            if (code >= 1 && code <= 3) return `多雲 ${simpleIcons.cloud}`;
            if (code >= 45 && code <= 48) return `有霧 ${simpleIcons.fog}`;
            if (code >= 51 && code <= 67) return `有雨 ${simpleIcons.rain}`;
            if (code >= 71 && code <= 77) return `有雪 ${simpleIcons.snow}`;
            if (code >= 80 && code <= 82) return `陣雨 ${simpleIcons.rain}`;
            if (code >= 95) return `雷雨 ${simpleIcons.lightning}`;
            return `多雲 ${simpleIcons.cloud}`;
        }

        // [修改] 取得定位天氣 (同步更新 Header 與 分頁)
        // [修改] 取得定位天氣 (儲存天氣代碼供 AI 讀取)
        // [修改] 取得定位天氣 (防卡死穩定版)
        // [修改] 智慧定位函式：手機用高精確度，電腦自動降級為一般模式
        // [修改] 終極定位函式：支援 GPS (手機)、Wi-Fi (筆電) 與 有線網路 (桌機)
        // [修正版] 混合雙軌定位：手機抓精確、電腦抓 IP，確保 100% 成功率
        // [智慧定位函式] 完美解決方案：手機優先抓 GPS，電腦自動退回抓 IP
        // [最終版] 裝置分流定位：電腦模擬舊版行為(IP)，手機啟用高精度(GPS)
        function getLocalWeather() {
            // 定義 UI 
            const els = {
                headerLoc: document.getElementById('header-my-loc'),
                headerTemp: document.getElementById('header-my-temp'),
                tabTemp: document.getElementById('wc-my-temp'),
                titleBox: document.getElementById('wc-loc-box')
            };

            // 1. 檢查瀏覽器支援
            if (!navigator.geolocation) {
                alert('您的瀏覽器不支援定位');
                return;
            }

            // UI 顯示
            if (els.headerLoc) els.headerLoc.innerText = '定位中...';
            if (els.titleBox) els.titleBox.innerHTML = '<span class="loading-dots">定位中</span>';

            // 2. 判斷裝置類型：是手機嗎？
            // 如果是 iPhone, Android 等行動裝置，isMobile 會是 true
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            // 策略：手機用 true (高精度)，電腦強制用 false (低精度，像 index_ai 一樣)
            const useHighAccuracy = isMobile;

            console.log(`裝置偵測: ${isMobile ? "手機 (啟用 GPS)" : "電腦 (使用 IP 定位)"}`);

            // === 成功邏輯 ===
            const handleSuccess = async (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                try {
                    // A. 抓天氣 (加入 timezone=auto 以獲取精確時區)
                    const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`);
                    const weatherData = await weatherRes.json();

                    currentMyTemp = weatherData.current_weather.temperature;
                    const tempStr = `${Math.round(currentMyTemp)}°C`;
                    const code = weatherData.current_weather.weathercode;
                    // ★★★ [新增 Start] 捕捉日夜狀態 ★★★
                    const localIsDay = weatherData.current_weather.is_day; // 1=白, 0=夜
                    // ★★★ [新增 End] ★★★
                    // [新增] 取得 API 回傳的當地時區 (例如 "Asia/Tokyo")
                    const localTimezone = weatherData.timezone;

                    // B. AI 解析地名
                    let displayZh = "我的位置";
                    try {
                        // 提示詞
                        const locationPrompt = `Task: Identify the specific district/township name for ${lat},${lon} (e.g., 竹北市, 新竹市東區, 博多區). Output ONLY the Traditional Chinese name.`;
                        // 呼叫 AI (設定 10秒 超時)
                        const aiPromise = getGeminiResponse(locationPrompt);
                        const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 10000));
                        const aiCity = await Promise.race([aiPromise, timeoutPromise]);
                        if (aiCity) displayZh = aiCity.trim();
                    } catch (e) {
                        console.warn("AI 解析略過");
                    }

                    // C. 更新 UI
                    if (els.headerLoc) els.headerLoc.innerText = displayZh;
                    if (els.headerTemp) els.headerTemp.innerText = tempStr;
                    if (els.tabTemp) {
                        els.tabTemp.innerText = tempStr;
                        els.tabTemp.style.fontSize = '1.5rem';
                        els.tabTemp.style.color = '#1F2937';
                    }
                    if (els.titleBox) {
                        els.titleBox.innerHTML = `
                            <div style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                                <svg class="icon-mini" style="color: #EF4444;" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                                <span>${displayZh}</span>
                            </div>`;
                    }

                    // 存檔與比對
                    window.appCache = window.appCache || {};
                    window.appCache['my_location_combined'] = {
                        timestamp: Date.now(),
                        data: {
                            temp: currentMyTemp,
                            city: displayZh,
                            code: code,
                            timezone: localTimezone,
                            isDay: localIsDay,
                            // [新增] 儲存經緯度供地圖使用
                            lat: lat,
                            lon: lon
                        }
                    };

                    // [新增] 即時更新 AI 地圖 (如果地圖已經初始化的話)
                    if (window.updateMapLocation) {
                        window.updateMapLocation(lat, lon, Date.now());
                    }

                    // ★★★ [新增] 若目前沒有任何行程被打開，就直接套用這裡的日夜特效
                    /*if (!document.querySelector('.timeline.show')) {
                        const header = document.querySelector('header');
                        if (localIsDay === 0) header.classList.add('is-night');
                        else header.classList.remove('is-night');
                        
                        // 重繪特效
                        if (typeof setWeatherEffect === 'function') {
                             setWeatherEffect(getWeatherIconClass(code));
                        }
                    }*/
                    // ★★★ [修改] 若目前沒有任何行程被打開，直接呼叫還原函式更新「全部介面」(含文字與特效)
                    if (!document.querySelector('.timeline.show')) {
                        resetHeaderToLocal();
                    }
                    const targetTempStr = document.getElementById('wc-temp') ? document.getElementById('wc-temp').innerText : '--°';
                    if (targetTempStr !== '--°') updateComparison(parseFloat(targetTempStr));

                } catch (e) {
                    console.error("處理失敗", e);
                    if (els.headerLoc) els.headerLoc.innerText = '連線失敗';
                }
            };

            // === 失敗處理 (只針對手機的高精度失敗進行降級) ===
            const handleError = (err) => {
                console.warn("定位失敗:", err.code, err.message);

                // 如果是手機嘗試高精度失敗了，再給它一次機會用低精度
                if (useHighAccuracy) {
                    console.log("手機 GPS 失敗，嘗試切換 IP 定位...");
                    navigator.geolocation.getCurrentPosition(
                        handleSuccess,
                        (err2) => {
                            alert("定位失敗，請確認手機定位服務已開啟。");
                            if (els.headerLoc) els.headerLoc.innerText = '定位未開';
                        },
                        { enableHighAccuracy: false, timeout: 10000, maximumAge: 0 }
                    );
                } else {
                    // 電腦低精度如果也失敗，那就是真的被封鎖或沒網路了
                    if (els.headerLoc) els.headerLoc.innerText = '無法定位';
                    alert("電腦無法取得位置，請確認瀏覽器權限。");
                }
            };

            // === 3. 開始執行 ===
            // 這裡使用了變數 useHighAccuracy
            // 電腦版：useHighAccuracy 為 false -> 行為等同 index_ai (不會報錯)
            // 手機版：useHighAccuracy 為 true -> 行為等同 index (抓竹北)
            navigator.geolocation.getCurrentPosition(
                handleSuccess,
                handleError,
                { enableHighAccuracy: useHighAccuracy, timeout: 5000, maximumAge: 0 }
            );
        }

        // --- Modal Functions (取代原生 alert/prompt) ---
        function openModal(msg) {
            document.getElementById('modal-msg').innerText = msg;
            document.getElementById('location-modal').style.display = 'flex';
            document.getElementById('modal-city-input').focus();
        }

        function closeModal() {
            document.getElementById('location-modal').style.display = 'none';
        }
        // [新增] 隨身筆記功能 (自動儲存)
        // [修改] 隨身筆記功能 (支援圖文儲存 + 點擊放大)
        const NOTE_STORAGE_KEY = 'kyushu_trip_note_2026';

        function openNoteModal() {
            const modal = document.getElementById('note-modal');
            const area = document.getElementById('note-area');
            const status = document.getElementById('note-status');

            // 1. 讀取舊筆記 (改用 innerHTML 讀取 HTML 格式)
            area.innerHTML = localStorage.getItem(NOTE_STORAGE_KEY) || '';
            status.innerText = '';

            modal.style.display = 'flex';

            // 2. 綁定輸入事件 (即時自動儲存 HTML)
            area.oninput = function () {
                saveNoteContent();
            };

            // [關鍵新增] 3. 綁定圖片點擊事件 (事件委派)
            // 讓筆記內任何圖片被點擊時，都會觸發全螢幕燈箱
            area.onclick = function (e) {
                if (e.target.tagName === 'IMG') {
                    openLightbox(e.target.src); // 呼叫原本已寫好的燈箱功能
                }
            };
        }

        function saveNoteContent() {
            const area = document.getElementById('note-area');
            const status = document.getElementById('note-status');

            // 儲存整個 HTML (含圖片 Base64)
            localStorage.setItem(NOTE_STORAGE_KEY, area.innerHTML);
            status.innerText = '已自動儲存 ✓';
        }

        function closeNoteModal() {
            document.getElementById('note-modal').style.display = 'none';
        }

        // [新增] 處理筆記插入圖片
        async function insertNoteImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const area = document.getElementById('note-area');
            const status = document.getElementById('note-status');
            status.innerText = '圖片處理中...';

            try {
                // 1. 強力壓縮圖片 (寬度 600px, 品質 0.6)
                // 使用您程式碼底部原本就有的 compressImage 函式
                const base64 = await compressImage(file, 600, 0.6);

                // 2. 建立圖片元素
                const img = document.createElement('img');
                img.src = `data:image/jpeg;base64,${base64}`;

                // 3. 插入圖片
                area.focus(); // 確保焦點
                area.appendChild(document.createElement('br')); // 換行
                area.appendChild(img);
                area.appendChild(document.createElement('br')); // 換行

                // 4. 觸發儲存
                saveNoteContent();

            } catch (e) {
                alert("圖片插入失敗：" + e);
                status.innerText = '失敗';
            } finally {
                // 清空 input，確保下一張同名圖片也能觸發
                event.target.value = '';
            }
        }
        /* --- 在 function closeNoteModal() { ... } 結束後插入 --- */

        // [新增] 匯率計算機與 API 串接邏輯
        function openCalcModal() {
            document.getElementById('calc-modal').style.display = 'flex';

            // 1. 先嘗試讀取快取
            const savedRateData = JSON.parse(localStorage.getItem('live_exchange_rate_cache') || '{}');
            const now = Date.now();
            const oneHour = 3600000;

            if (savedRateData.rate && (now - savedRateData.timestamp < oneHour)) {
                updateRateUI(savedRateData.rate, '快取');
            } else {
                fetchLiveRate();
            }

            // [新增] 每次開啟預設為 JPY -> TWD 模式
            if (typeof isJpyToTwd !== 'undefined') {
                isJpyToTwd = true;
                const mainLabel = document.getElementById('cur-label-main');
                const subLabel = document.getElementById('cur-label-sub');
                if (mainLabel && subLabel) {
                    mainLabel.innerText = "JPY";
                    subLabel.innerText = "TWD";
                    mainLabel.style.color = "#2563EB"; // JPY 藍色
                    subLabel.style.color = "#059669"; // [新增] TWD 綠色
                }
            }

            // 重置計算機畫面
            if (typeof calcInput === 'function') {
                calcInput('AC');
            }
        }

        function closeCalcModal() {
            document.getElementById('calc-modal').style.display = 'none';
        }

        // 抓取即時匯率 (來源: 免費公開 API)
        // 抓取即時匯率 (來源: 免費公開 API)
        async function fetchLiveRate() {
            // [修正] 加入檢查
            const statusEl = document.getElementById('rate-status');
            if (statusEl) {
                statusEl.innerText = '⟳ 更新中...';
                statusEl.style.color = '#F59E0B';
            }

            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                const data = await res.json();
                const newRate = data.rates.TWD;

                if (newRate) {
                    localStorage.setItem('live_exchange_rate_cache', JSON.stringify({
                        rate: newRate,
                        timestamp: Date.now()
                    }));
                    updateRateUI(newRate, '即時');

                    // [修正] 改呼叫新的重算函式
                    if (typeof reCalcTotal === 'function') reCalcTotal();
                }
            } catch (e) {
                console.error("匯率更新失敗", e);
                // [修正] 加入檢查
                if (statusEl) {
                    statusEl.innerText = '⚠️ 連線失敗';
                    statusEl.style.color = '#EF4444';
                }
                // 失敗時若沒值，給個預設值
                const rateInput = document.getElementById('calc-rate');
                if (rateInput && !rateInput.value) rateInput.value = 0.22;
            }
        }

        function updateRateUI(rate, type) {
            const rateInput = document.getElementById('calc-rate');
            if (rateInput) rateInput.value = Number(rate).toFixed(3);

            // [修正] 加入檢查：確認 statusEl 存在才更新，避免報錯
            const statusEl = document.getElementById('rate-status');
            if (statusEl) {
                statusEl.innerText = `● ${type}匯率`;
                statusEl.style.color = '#10B981'; // 綠色
            }
        }

        // [新增] 計算機變數與邏輯
        let calcExpression = ""; // 儲存算式字串
        let isJpyToTwd = true;   // [新增] 預設為 日幣 -> 台幣

        // [新增] 切換幣別模式
        function toggleCurrency() {
            isJpyToTwd = !isJpyToTwd; // 切換狀態

            // 更新按鈕文字與顏色
            const mainLabel = document.getElementById('cur-label-main');
            const subLabel = document.getElementById('cur-label-sub');

            if (isJpyToTwd) {
                // 模式：日 -> 台
                mainLabel.innerText = "JPY";
                mainLabel.style.color = "#2563EB"; // 主顯示 JPY (藍)
                subLabel.innerText = "TWD";
                subLabel.style.color = "#059669";  // 副顯示 TWD (綠)
            } else {
                // 模式：台 -> 日
                mainLabel.innerText = "TWD";
                mainLabel.style.color = "#059669"; // 主顯示 TWD (綠)
                subLabel.innerText = "JPY";
                subLabel.style.color = "#2563EB";  // 副顯示 JPY (藍)
            }

            // 更新畫面上的符號並重新計算
            updateCalcDisplaySymbol();
            reCalcTotal();
        }

        // [新增] 更新畫面上的幣別符號
        function updateCalcDisplaySymbol() {
            const mainDisplay = document.getElementById('calc-main-display');
            // 讀取目前的數字 (去掉非數字字元)
            let currentVal = mainDisplay.innerText.replace(/[^\d.-]/g, '');
            if (!currentVal) currentVal = "0";

            // 根據模式加上對應符號
            const symbol = isJpyToTwd ? "¥" : "NT$";
            mainDisplay.innerText = symbol + currentVal;
        }

        // [修改] 計算機核心處理
        function calcInput(val) {
            const exprDisplay = document.getElementById('calc-expr-display');
            const mainDisplay = document.getElementById('calc-main-display');
            const symbol = isJpyToTwd ? "¥" : "NT$"; // 根據模式決定主符號

            if (val === 'AC') {
                calcExpression = "";
                exprDisplay.innerText = "";
                mainDisplay.innerText = symbol + "0";
                reCalcTotal(0);
                return;
            }

            if (val === 'DEL') {
                calcExpression = calcExpression.toString().slice(0, -1);
            } else if (val === '=') {
                try {
                    const safeExpr = calcExpression.replace(/×/g, '*').replace(/÷/g, '/');
                    if (!safeExpr) return;

                    const result = eval(safeExpr);

                    // 顯示結果 (加上符號)
                    mainDisplay.innerText = symbol + parseFloat(result.toFixed(2));
                    calcExpression = result.toString();
                    exprDisplay.innerText = "";
                    reCalcTotal(result);
                    return;
                } catch (e) {
                    mainDisplay.innerText = "Error";
                    calcExpression = "";
                }
            } else {
                const lastChar = calcExpression.slice(-1);
                const ops = ['+', '-', '*', '/', '.'];
                let displayVal = val;
                if (val === '*') displayVal = '×';
                if (val === '/') displayVal = '÷';

                if (ops.includes(val) && ops.includes(lastChar)) {
                    calcExpression = calcExpression.slice(0, -1) + val;
                } else {
                    calcExpression += val;
                }
            }

            exprDisplay.innerText = calcExpression.replace(/\*/g, '×').replace(/\//g, '÷');

            try {
                const safeExpr = calcExpression.replace(/×/g, '*').replace(/÷/g, '/');
                if (safeExpr && !['+', '-', '*', '/'].includes(safeExpr.slice(-1))) {
                    const previewRes = eval(safeExpr);
                    reCalcTotal(previewRes);
                }
            } catch (e) { }
        }

        // [修改] 雙向匯率換算邏輯
        function reCalcTotal(amount = null) {
            const rate = parseFloat(document.getElementById('calc-rate').value) || 0;
            const subDisplay = document.getElementById('calc-sub-display');
            const mainDisplay = document.getElementById('calc-main-display');

            if (amount === null) {
                // 從畫面讀取數字 (移除 ¥ 或 NT$)
                amount = parseFloat(mainDisplay.innerText.replace(/[^\d.-]/g, '')) || 0;
            }

            let resultVal = 0;
            let resultSymbol = "";

            if (isJpyToTwd) {
                // 模式：日幣轉台幣 (乘法)
                // 邏輯：日幣金額 × 匯率(0.22) = 台幣
                resultVal = Math.round(amount * rate);
                resultSymbol = "NT$";
            } else {
                // 模式：台幣轉日幣 (除法)
                // 邏輯：台幣金額 ÷ 匯率(0.22) = 日幣
                if (rate !== 0) {
                    resultVal = Math.round(amount / rate);
                }
                resultSymbol = "¥";
            }

            subDisplay.innerText = `≈ ${resultSymbol}${resultVal.toLocaleString()}`;
        }


        // [修正版] 點擊背景關閉視窗 (改用直接綁定，解決手機觸控無效問題)
        // 自動抓取所有 class 為 modal-overlay 的遮罩層
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', function (e) {
                // 判斷關鍵：只有當點擊的目標是「背景本人」時才關閉
                // 如果點到內部的白色視窗 (modal-box)，e.target 會是 box 而不是 overlay，就不會觸發
                if (e.target === this) {

                    // 特殊處理：如果是圖片預覽視窗，需要清空暫存
                    if (this.id === 'img-preview-modal' && typeof cancelImagePreview === 'function') {
                        cancelImagePreview();
                    } else {
                        this.style.display = 'none';
                    }
                }
            });
        });

        // [修改] 兩段式分享功能 (解決瀏覽器阻擋視窗問題)
        // 狀態標記：紀錄目前是否已經分析完成
        // --- [新增] Google Places API 救援函式 (三階段定位邏輯用) ---
        const fetchGooglePlaces = async (lat, lng, radius = 50) => {
            // [修改] 指定獲取 Google Places 的 Key
            const currentKey = getKey('places');
            if (!currentKey) return [];

            const centerLat = Number(lat);
            const centerLng = Number(lng);

            // 定義要搜尋的地標類型 (排除太過籠統的類型)
            const validTypes = [
                "restaurant", "cafe", "convenience_store", "tourist_attraction",
                "park", "store", "lodging", "transit_station", "museum", "shopping_mall"
            ];

            const url = `https://places.googleapis.com/v1/places:searchNearby`;
            const body = {
                includedTypes: validTypes,
                maxResultCount: 1, // [修改] 受歡迎度第一，所以取 1 筆即可
                rankPreference: "POPULARITY", // [修改] 改回依「受歡迎度」排序
                locationRestriction: {
                    circle: {
                        center: { latitude: centerLat, longitude: centerLng },
                        radius: Number(radius), // 搜尋半徑 (公尺)
                    },
                },
                languageCode: "zh-TW",
            };

            try {
                const res = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-Goog-Api-Key": currentKey,
                        "X-Goog-FieldMask": "places.displayName,places.addressDescriptor",
                    },
                    body: JSON.stringify(body),
                });
                if (!res.ok) return [];
                const data = await res.json();
                return data.places || [];
            } catch (e) {
                console.error("Google Places API Error:", e);
                return [];
            }
        };
        let isLocReady = false;
        let pendingShareData = null;

        // [修改] 智慧分享功能 (嘗試一鍵完成，遇阻擋則優雅變身)
        // [修改] 智慧分享功能 (三階段精準定位版)
        function shareCurrentLocation() {
            const btn = document.getElementById('btn-share-loc');

            // --- [階段二] 如果按鈕已經是「準備完成」狀態，直接發射 ---
            if (btn.dataset.shareState === 'ready' && window.pendingShareData) {
                navigator.share(window.pendingShareData)
                    .then(() => {
                        resetShareButton(btn); // 分享成功後復原
                    })
                    .catch((err) => {
                        console.log("使用者取消分享", err);
                    });
                return;
            }

            // --- [階段一] 正常流程 (第一次點擊) ---
            if (!navigator.geolocation) {
                alert("您的裝置不支援定位功能。");
                return;
            }

            // 防止重複點擊
            if (btn.dataset.shareState === 'analyzing') return;

            // 1. 鎖定並變更為「雷達分析中」動畫
            if (!btn.dataset.originalHtml) {
                btn.dataset.originalHtml = btn.innerHTML;
            }

            btn.dataset.shareState = 'analyzing';
            btn.style.pointerEvents = "none";

            // 雷達動畫
            btn.innerHTML = `
                <svg viewBox="0 0 24 24" style="width: 28px; height: 28px; color: #10B981;">
                    <circle cx="12" cy="12" r="4" fill="currentColor"></circle>
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none">
                        <animate attributeName="r" from="4" to="12" dur="1.5s" repeatCount="indefinite" />
                        <animate attributeName="opacity" from="1" to="0" dur="1.5s" repeatCount="indefinite" />
                    </circle>
                </svg>
            `;
            btn.style.background = "#ECFDF5";
            btn.style.borderColor = "#10B981";
            btn.style.color = "#10B981";
            btn.style.opacity = "0.8";

            // 2. 執行定位 (加上 async 以支援 await)
            navigator.geolocation.getCurrentPosition(async position => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                const mapUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;

                let locationName = "";
                let locationSource = "";

                try {
                    // --- 第一關：OSM (Nominatim) ---
                    const osmUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1&accept-language=zh-TW`;
                    const osmRes = await fetch(osmUrl);
                    const osmData = await osmRes.json();

                    if (osmData && osmData.name) {
                        locationName = osmData.name;
                        locationSource = "(OSM)";
                    }

                    // --- 第二關：Google Places API (NEW) 救援 ---
                    if (!locationName) {
                        console.log("OSM 無地標名，啟用 Google Places 救援...");
                        // 呼叫我們剛剛新增的輔助函式
                        const googlePlaces = await fetchGooglePlaces(lat, lon, 100);

                        // [修改] 條件：取用受歡迎度第一(Index 0) 的結果，並優先讀取其 Landmark
                        if (googlePlaces.length > 0) {
                            const place = googlePlaces[0];

                            // 1. 優先檢查是否有「地標 (landmarks)」資訊
                            if (place.addressDescriptor &&
                                place.addressDescriptor.landmarks &&
                                place.addressDescriptor.landmarks.length > 0) {

                                // 取出第一個地標名稱 (例如：盛群半導體)
                                locationName = place.addressDescriptor.landmarks[0].displayName.text;
                                locationSource = "(Google地標)";
                            }
                            // 2. 如果沒有地標，才使用原本的名稱
                            else if (place.displayName) {
                                locationName = place.displayName.text;
                                locationSource = "(Google熱點)";
                            }
                        }
                    }

                    // --- 第三關：OSM 門牌地址 (Fallback) ---
                    if (!locationName && osmData && osmData.address) {
                        const addr = osmData.address;
                        const road = addr.road || addr.pedestrian || "";
                        const houseNum = addr.house_number || "";
                        const suburb = addr.suburb || addr.neighbourhood || "";

                        if (road) {
                            locationName = `${road}${houseNum ? " " + houseNum + "" : ""}`;
                        } else if (suburb) {
                            locationName = suburb;
                        } else {
                            locationName = osmData.display_name.split(',')[0];
                        }
                        locationSource = "(地址)";
                    }

                    if (!locationName) locationName = "我的位置";
                    console.log(`定位完成: ${locationName} ${locationSource}`);

                } catch (e) {
                    console.error("定位解析失敗", e);
                    locationName = "我的位置";
                }

                // C. 準備全域資料
                window.pendingShareData = {
                    title: '我的即時位置',
                    text: `【報平安】我目前在「${locationName}」附近`,
                    url: mapUrl
                };

                // D. 嘗試觸發分享
                try {
                    await navigator.share(window.pendingShareData);
                    resetShareButton(btn);
                } catch (err) {
                    // 被阻擋時，切換為手動發送按鈕
                    console.log("自動分享未觸發，切換為手動模式");
                    btn.style.pointerEvents = "auto";

                    /* --- [修改] 加入右上角取消按鈕 (X) --- */
                    btn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px; animation: popIn 0.3s;">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                        點擊發送
                        <div class="share-cancel-badge" onclick="event.stopPropagation(); resetShareButton(this.parentElement);">✕</div>
                    `;
                    /* --- [修改結束] --- */

                    btn.style.background = "#10B981";
                    btn.style.borderColor = "#10B981";
                    btn.style.color = "white";
                    btn.style.opacity = "1";
                    btn.dataset.shareState = 'ready';
                    if (navigator.vibrate) navigator.vibrate(50);
                }

            }, error => {
                console.error(error);
                alert("無法取得位置，請確認 GPS 已開啟。");
                resetShareButton(btn);
            }, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        }
        // 輔助函式：重置按鈕
        // 請更新這個輔助函式 (通常在程式碼最下方)
        function resetShareButton(btn) {
            if (btn.dataset.originalHtml) {
                btn.innerHTML = btn.dataset.originalHtml;
            }
            btn.style.background = "";
            btn.style.borderColor = "";
            btn.style.color = "";
            btn.style.opacity = "";
            btn.style.pointerEvents = "auto"; // 恢復可點擊

            // 清除狀態標記與暫存資料
            delete btn.dataset.shareState;
            window.pendingShareData = null;
        }
        async function submitManualLocation() {
            const manualCity = document.getElementById('modal-city-input').value.trim();
            if (!manualCity) return;

            closeModal();

            const tempEl = document.getElementById('wc-my-temp');
            tempEl.innerText = '查詢中..';
            tempEl.style.color = '#2563EB';
            tempEl.style.fontSize = '1.2rem';

            // --- 新增：智慧翻譯邏輯 (與天氣查詢同步) ---
            let searchTerm = manualCity;
            let isTranslated = false;

            // 1. 檢查內建對照表
            for (const key in cityMapping) {
                if (manualCity.includes(key)) {
                    searchTerm = cityMapping[key];
                    isTranslated = true;
                    break;
                }
            }

            // 2. AI 背景翻譯 (若對照表沒有)
            if (!isTranslated) {
                // 提示使用者正在翻譯
                tempEl.innerText = '翻譯中..';

                const translatePrompt = `
                    Task: Translate the place name "${manualCity}" into its official English Romanization name for using in a Weather API.
                    Target: Global locations (Focus on Taiwan/Japan).
                    Rule: Output ONLY the English name. No explanations.
                    Example: "台北" -> "Taipei", "由布院" -> "Yufuin", "新竹" -> "Hsinchu".
                `;

                try {
                    const aiTranslation = await getGeminiResponse(translatePrompt);
                    if (/^[a-zA-Z\s\-,]+$/.test(aiTranslation)) {
                        searchTerm = aiTranslation;
                        isTranslated = true;
                        console.log("手動位置 AI 翻譯結果:", searchTerm);
                    }
                } catch (e) {
                    console.warn("AI 翻譯失敗，將使用原始中文搜尋");
                }
            }

            tempEl.innerText = '連線中..';
            // --- 邏輯結束 ---

            try {
                // 使用 Geocoding API 查詢
                // 優先使用翻譯後的英文搜尋 (精準度較高)
                // [修改] count=10
                let geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(searchTerm)}&count=10&language=en&format=json`;
                let geoRes = await fetch(geoUrl);
                let geoData = await geoRes.json();

                // 如果英文找不到，嘗試用原始中文搜尋 (Fallback)
                if ((!geoData.results || geoData.results.length === 0) && isTranslated) {
                    geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(manualCity)}&count=10&language=zh&format=json`;
                    geoRes = await fetch(geoUrl);
                    geoData = await geoRes.json();
                }

                if (!geoData.results || geoData.results.length === 0) {
                    tempEl.innerText = '查無此地';
                    // 恢復按鈕狀態並顯示錯誤
                    setTimeout(() => openModal(`找不到「${manualCity}」(翻譯: ${searchTerm})，請嘗試輸入其他名稱：`), 1000);
                    return;
                }

                // [新增] 篩選邏輯 (手動輸入也適用)
                let targetLocation = geoData.results[0];
                const jpLocation = geoData.results.find(r => r.country_code === 'JP' || r.country === 'Japan');
                // 如果手動輸入的地點有找到日本的，且使用者輸入的是中文或跟日本行程相關，優先選日本
                // (這裡簡單做：只要有日本選項就選日本，因為這是九州旅遊 App)
                if (jpLocation) {
                    targetLocation = jpLocation;
                }

                const { latitude, longitude } = targetLocation;
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`;
                const weatherRes = await fetch(weatherUrl);
                const weatherData = await weatherRes.json();

                currentMyTemp = weatherData.current_weather.temperature;

                // 更新 UI
                tempEl.innerText = `${currentMyTemp}°C`;
                tempEl.style.fontSize = '1.5rem';
                tempEl.style.color = '#1F2937';

                // 更改標題讓人知道是手動的 (加入英文顯示，上下分層)
                const titleEl = document.querySelector('.wc-mini-card .wc-mini-title');

                // 預設 HTML 結構
                let titleHtml = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px;">
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <svg class="icon-mini" style="color: #EF4444;" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                            <span>${manualCity}</span>
                        </div>
                `;

                // 若有英文翻譯且不同，則加入下一行
                if (searchTerm && searchTerm.toLowerCase() !== manualCity.toLowerCase()) {
                    titleHtml += `<span style="font-size: 0.75rem; color: #9CA3AF; font-weight: 400; font-family: sans-serif;">${searchTerm}</span>`;
                }

                titleHtml += `</div>`; // Close container
                titleEl.innerHTML = titleHtml;

                const targetTempStr = document.getElementById('wc-temp').innerText;
                if (targetTempStr !== '--°') {
                    updateComparison(parseFloat(targetTempStr));
                }

            } catch (e) {
                console.error(e);
                tempEl.innerText = '失敗';
                tempEl.style.color = '#EF4444';
            }
        }

        // [專家優化] 溫差比對：動態地點 + 顏色情緒
        function updateComparison(targetTemp) {
            // 1. 檢查是否有定位資料
            if (currentMyTemp === null) {
                getLocalWeather(); // 嘗試重新定位
                return;
            }

            // 2. 取得比較基準的地點名稱 (預設為「您的位置」)
            let baseLocName = "您的位置";
            if (window.appCache && window.appCache['my_location_combined']) {
                // 取出定位時存下的城市名 (例如: 竹北市, Taipei)
                const cachedName = window.appCache['my_location_combined'].data.city;
                if (cachedName) {
                    // 如果名字太長，擷取前兩個字比較簡潔 (例如 "新竹市東區" -> "新竹")
                    baseLocName = cachedName.length > 3 ? cachedName.substring(0, 2) : cachedName;
                }
            }

            // 3. 計算溫差
            const diff = targetTemp - currentMyTemp;
            const diffAbs = Math.abs(diff).toFixed(1);

            // 4. 取得 UI 元素
            const box = document.getElementById('wc-diff-box');
            const title = document.getElementById('wc-diff-title');
            const val = document.getElementById('wc-diff-val');

            // 5. 顏色與文字邏輯
            if (diff > 0) {
                // 🥵 目的地比較熱 (暖色系)
                box.style.background = '#FFF7ED'; // 淺橘底
                box.style.color = '#9A3412';      // 深橘褐字
                /*box.style.borderColor = '#FED7AA'; // 橘邊框*/

                title.innerText = `比${baseLocName}熱`;
                val.innerText = `+${diffAbs}°C`;

            } else if (diff < 0) {
                // 🥶 目的地比較冷 (冷色系)
                box.style.background = '#EFF6FF'; // 淺藍底
                box.style.color = '#1E40AF';      // 深藍字
                /*box.style.borderColor = '#BFDBFE'; // 藍邊框*/

                title.innerText = `比${baseLocName}冷`;
                val.innerText = `-${diffAbs}°C`;

            } else {
                // 😐 溫度相同
                box.style.background = '#F3F4F6';
                box.style.color = '#4B5563';
                /*box.style.borderColor = 'transparent';*/

                title.innerText = `與${baseLocName}`;
                val.innerText = `溫差小`;
            }
        }

        async function askAiWeatherAdvice(city, temp, condition) {
            // [新增] 1. 產生快取金鑰 (地點 + 氣溫整數 + 天氣狀況)
            // 這樣如果溫度只差 0.1 度，或是天氣一樣，就不用重新問 AI
            const cacheKey = `ai_advice_${city}_${Math.round(temp)}_${condition}`;

            // [新增] 2. 先查快取
            const cachedAdvice = CACHE_SYSTEM.get(cacheKey);
            if (cachedAdvice) {
                console.log("使用快取穿衣建議");
                document.getElementById('wc-advice').innerText = cachedAdvice;
                return;
            }

            // 無快取，才執行 AI 請求
            const prompt = `
                現在${city}的即時氣溫是 ${temp}度，天氣狀況為${condition}。
                請以「旅遊小秘書」的口吻，給予台灣旅客簡短的穿衣建議（約50字）。
                請包含體感描述（例如：是否需要發熱衣、圍巾等）。
            `;

            try {
                const text = await getGeminiResponse(prompt);
                document.getElementById('wc-advice').innerText = text;

                // [新增] 3. 存入快取 (保存 60 分鐘)
                CACHE_SYSTEM.save(cacheKey, text, 30);

            } catch (e) {
                document.getElementById('wc-advice').innerText = 'AI 連線逾時，建議洋蔥式穿搭。';
            }
        }

        // --- END REAL-TIME WEATHER ---

        // [修改] 切換分頁函式 - 加入左右滑動動畫判斷
        function switchTab(element) {
            // 移除所有 active
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.container').forEach(container => {
                container.classList.remove('active');
                // 清除殘留樣式
                container.style.transform = '';
                container.style.opacity = '';
                container.style.filter = '';
            });

            // 設定 active
            element.classList.add('active');
            const targetId = element.getAttribute('data-target');
            document.getElementById(targetId).classList.add('active');

            window.scrollTo(0, 0);
            // 如果切換到「旅程記錄」分頁，強制初始化頭像選單
            if (targetId === 'view-ledger') {
                // 使用 setTimeout 確保 DOM 已經完全顯示後再執行
                setTimeout(() => {
                    if (typeof initAvatarSelector === 'function') {
                        initAvatarSelector();
                    }
                }, 50);
            }
        }

        function toggleTimeline(id, toggleElement) {
            const timeline = document.getElementById(id);
            // If opening a new day
            if (!timeline.classList.contains('show')) {
                // Collapse others
                document.querySelectorAll('.timeline.show').forEach(t => t.classList.remove('show'));
                document.querySelectorAll('.day-toggle.open').forEach(t => t.classList.remove('open'));

                // Show target
                timeline.classList.add('show');
                toggleElement.classList.add('open');

                // Update Weather!
                updateWeatherWidget(id);
            } else {
                // Closing the current day
                timeline.classList.remove('show');
                toggleElement.classList.remove('open');

                // ★★★ [修改] 檢查是否還有其他摺頁是開著的？
                // 如果沒有任何 .timeline.show 了，代表全部關閉 -> 還原回我的位置
                if (!document.querySelector('.timeline.show')) {
                    resetHeaderToLocal();
                }
            }
        }

        // AI Functions - UI Interaction Part
        const chatHistory = document.getElementById('chat-history');
        const aiInput = document.getElementById('ai-user-input');
        const aiTitle = document.getElementById('ai-modal-title');
        const aiInputArea = document.getElementById('ai-input-area');
        const btnBackTrans = document.getElementById('btn-back-trans');

        // Initial Greeting
        // [修改] 初始化歡迎訊息 (加入對應按鈕的顏色與圖示)
        function initAiChat() {
            if (chatHistory.children.length === 0) {
                // 定義樣式變數，讓程式碼較整潔
                const iconStyle = 'width:16px; height:16px; vertical-align:text-bottom; margin-right:2px; display:inline-block;';
                const spanStyle = 'font-weight:700; display:inline-flex; align-items:center; vertical-align:middle; margin:0 2px;';

                // 1. 行程諮詢 (藍色)
                const iconConsult = `<svg style="${iconStyle}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon></svg>`;
                const txtConsult = `<span style="${spanStyle} color:#2563EB;">${iconConsult}行程諮詢</span>`;

                // 2. 中/日翻譯 (天空藍)
                const iconTrans = `<svg style="${iconStyle}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 10h14"></path><path d="M17 6l4 4-4 4"></path><path d="M17 14H3"></path><path d="M7 18l-4-4 4-4"></path></svg>`;
                const txtTrans = `<span style="${spanStyle} color:#0EA5E9;">${iconTrans}中/日翻譯</span>`;

                // 3. 語音輸入 (青色)
                const iconVoice = `<svg style="${iconStyle}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>`;
                const txtVoice = `<span style="${spanStyle} color:#06B6D4;">${iconVoice}語音輸入</span>`;

                // 4. 拍照辨識 (紫色/粉色)
                const iconCam = `<svg style="${iconStyle}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>`;
                const txtCam = `<span style="${spanStyle} color:#D946EF;">${iconCam}拍照辨識</span>`;

                const welcomeHtml = `
                    你好！我是你的東京旅遊 AI 助手。
                    <br><br>
                    你可以點選下方的 ${txtConsult} 詢問路線，或使用 ${txtTrans} 與當地人溝通。
                    點選 ${txtVoice} 搭配語言切換還能用說的喔！
                    更有 ${txtCam} 功能可以方便點餐及獲得商品資訊。
                `;
                appendMessage('ai', welcomeHtml);
            }
        }

        // Function to switch to AI tab programmatically
        function goToAiTab() {
            const aiTabBtn = document.querySelector('[data-target="view-ai"]');
            switchTab(aiTabBtn);
        }

        function showAiTranslatorMode() {
            // 修正 3: JS 動態切換標題時也要用 SVG
            const iconSvg = '<svg class="icon-mini" style="width: 24px; height: 24px; color: #F59E0B; margin-right: 8px;" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>';
            aiTitle.innerHTML = iconSvg + '<span>隨身 AI 翻譯與助手</span>';
            aiInputArea.style.display = 'block';
            btnBackTrans.style.display = 'none';
            // Scroll to bottom
            chatHistory.scrollTop = chatHistory.scrollHeight;
            setupVoiceButton();
        }

        // Append Message Bubble
        // [修改] 訊息顯示函式：移除自動朗讀，改為全手動播放
        function appendMessage(sender, htmlContent, isAudio = false) {
            const row = document.createElement('div');
            row.className = `chat-row ${sender}`;

            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${sender}`;
            bubble.innerHTML = htmlContent;

            // 若為 AI 回覆且標記為可朗讀 (isAudio=true)，加入喇叭按鈕
            if (sender === 'ai' && isAudio) {
                const btn = document.createElement('button');
                btn.className = 'btn-audio-inline';
                // 喇叭圖示
                btn.innerHTML = '<svg viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>';

                // 取得純文字 (移除 HTML 標籤與圖示文字) 以供朗讀
                const textToSpeak = bubble.innerText.replace('🔊', '').trim();

                // 綁定點擊事件 (只有點擊時才發聲)
                btn.onclick = () => speakText(textToSpeak);

                bubble.appendChild(btn);

                // ★ 已移除：setTimeout(() => speakText(textToSpeak), 200); 
                // 現在不會自動播放了！
            }

            row.appendChild(bubble);
            chatHistory.appendChild(row);

            // 自動捲動到底部
            chatHistory.scrollTop = chatHistory.scrollHeight;

            return bubble;
        }

        // [新增] 全域載入指示器 (用於記帳與系統操作)
        function showGlobalLoading() {
            if (document.getElementById('global-loading-overlay')) return;

            const overlay = document.createElement('div');
            overlay.id = 'global-loading-overlay';
            overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:99999; display:flex; justify-content:center; align-items:center; backdrop-filter:blur(2px);';
            overlay.innerHTML = '<div style="background:white; padding:20px 30px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.2); display:flex; flex-direction:column; align-items:center;">' +
                '<div class="loading-spinner" style="border:4px solid #f3f3f3; border-top:4px solid #2563EB; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin-bottom:10px;"></div>' +
                '<div style="font-weight:bold; color:#374151;">Loading...</div>' +
                '<style>@keyframes spin {0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);}}</style>' +
                '</div>';
            document.body.appendChild(overlay);
        }

        function hideGlobalLoading() {
            const overlay = document.getElementById('global-loading-overlay');
            if (overlay) overlay.remove();
        }

        function showLoading() {
            // 【有一說一】直接抓取 AI 歷史紀錄容器
            const chatHistoryContainer = document.getElementById('chat-history');

            // 如果抓不到容器（表示不在 AI 分頁），就安靜結束，不要報錯也不要 return 影響別人
            if (!chatHistoryContainer) return;

            const row = document.createElement('div');
            row.className = 'chat-row ai loading-row';
            row.id = 'loading-indicator';

            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble ai loading-bubble';
            bubble.innerHTML = 'AI 正在思考中<span class="loading-dots"></span>';

            row.appendChild(bubble);
            chatHistoryContainer.appendChild(row);
            chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
        }

        function removeLoading() {
            const loading = document.getElementById('loading-indicator');
            if (loading) loading.remove();
        }

        // Helper to update placeholder based on selection
        function updatePlaceholder() {
            const lang = document.querySelector('input[name="voice_lang"]:checked').value;
            const input = document.getElementById('ai-user-input');
            if (lang === 'zh-TW') {
                input.placeholder = '請輸入中文 (或使用語音)...';
            } else {
                input.placeholder = '請輸入日文 (或切換語音)...';
            }
        }

        // [修改] 文字轉語音函式 (過濾羅馬拼音，只唸日文)
        // [修改] 文字轉語音函式 (強力過濾版)
        // [修改] 文字轉語音函式 (過濾羅馬拼音 + 過濾星號)
        // [修改] 文字轉語音函式 (強力過濾：括號、星號、所有英文字母都不唸)
        function speakText(text) {
            speechSynthesis.cancel(); // 停止上一句

            let cleanText = text;

            // 1. 移除括號 (...) 及其內容
            cleanText = cleanText.replace(/\([^\)]+\)/g, '');

            // 2. 移除星號 (*)
            cleanText = cleanText.replace(/\*/g, '');

            // 3. ★ 關鍵修正：移除所有羅馬拼音/英文字母 (含長音符號)
            // 這樣就算拼音沒有括號 (如 Bebīchea)，也會被刪除，不會唸出來
            cleanText = cleanText.replace(/[a-zA-ZāēīōūĀĒĪŌŪ]+/g, '');

            // 4. 去除前後與多餘空白
            cleanText = cleanText.trim();

            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'ja-JP'; // 設定語言為日文
            utterance.rate = 0.9;     // 語速稍慢

            // 嘗試取得較自然的日文語音包
            const voices = speechSynthesis.getVoices();
            const jaVoice = voices.find(v => v.lang.includes('ja'));
            if (jaVoice) utterance.voice = jaVoice;

            speechSynthesis.speak(utterance);
        }

        // Voice Recognition Logic
        // [修正] 將 recognition 移出函式，避免重複宣告
        let recognition = null;

        function setupVoiceButton() {
            // [修正] 如果已經初始化過，就直接結束，防止重複綁定事件
            if (recognition) return;

            const voiceBtn = document.getElementById('btn-voice-ja');
            if (!voiceBtn) return;

            // 防止長按跳出選單
            voiceBtn.oncontextmenu = (e) => { e.preventDefault(); return false; };

            // let recognition; <--- [修正] 這行刪除，改用上面的全域變數

            // 檢查瀏覽器支援度
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();

                // 設定連續模式：讓 iOS 不會講一句話就自己斷線，而是由我們程式控制何時斷
                recognition.continuous = true;
                recognition.interimResults = true;

                // --- [關鍵修正 1] 設定語言與 UI 狀態 (onstart) ---
                recognition.onstart = function () {
                    voiceBtn.classList.add('recording');

                    // 取得當前選擇的語言名稱，更新按鈕文字
                    const selectedLang = document.querySelector('input[name="voice_lang"]:checked').value;
                    const langText = selectedLang === 'zh-TW' ? '中文' : '日文';

                    voiceBtn.innerHTML = `<span style="animation: pulse 1s infinite;">🔴 聆聽${langText}...</span>`;
                    document.getElementById('ai-user-input').placeholder = `正在聆聽${langText} (說完自動停止)...`;
                };

                // --- [關鍵修正 2] 結束時重置按鈕 (onend) ---
                recognition.onend = function () {
                    voiceBtn.classList.remove('recording');
                    voiceBtn.innerHTML = `
                        <svg class="icon-sprite"><use href="#icon-voice"></use></svg>
                        語音輸入
                    `;
                    updatePlaceholder();
                };

                // --- [關鍵修正 3] 錯誤處理 (onerror) ---
                // 過濾掉 iPhone 常見的良性錯誤，不再跳出煩人的 Alert
                recognition.onerror = function (event) {
                    console.log('Voice Error:', event.error);

                    // 忽略 "no-speech" (沒聽到聲音) 和 "aborted" (手動停止)
                    if (event.error === 'no-speech' || event.error === 'aborted') {
                        // 靜默失敗，只移除錄音狀態，不擾民
                        voiceBtn.classList.remove('recording');
                        return;
                    }

                    // 只有真正的錯誤才跳通知
                    voiceBtn.classList.remove('recording');
                    alert("語音連線中斷，請重新點擊按鈕。");
                };

                // --- [核心邏輯] 處理辨識結果 (onresult) ---
                recognition.onresult = function (event) {
                    let finalTranscript = '';

                    // 組合所有已確認的片段
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        }
                    }

                    // 如果有偵測到完整的句子
                    if (finalTranscript.trim().length > 0) {
                        recognition.stop(); // 1. 聽到這句話就立刻停止錄音

                        // 2. 填入輸入框顯示給使用者看
                        document.getElementById('ai-user-input').value = finalTranscript;

                        // 3. 直接發送給 AI 進行翻譯
                        sendToGemini('voice_direct');
                    }
                };

                // --- [關鍵修正 4] 按鈕點擊事件 ---
                voiceBtn.onclick = (e) => {
                    if (e && e.cancelable) e.preventDefault();

                    if (voiceBtn.classList.contains('recording')) {
                        // 如果正在錄音，按一下則停止
                        recognition.stop();
                    } else {
                        // ★★★ 修正重點：在 start() 之前設定語言！ ★★★
                        const selectedLang = document.querySelector('input[name="voice_lang"]:checked').value;
                        recognition.lang = selectedLang;

                        try {
                            recognition.start();
                        } catch (err) {
                            console.error("啟動失敗:", err);
                        }
                    }
                };

            } else {
                voiceBtn.style.display = 'none';
                alert('您的瀏覽器不支援語音輸入功能');
            }
        }

        function askGeminiGuide(spotName, customPrompt) {
            goToAiTab();
            // 修正 4: 導覽模式標題圖示也統一
            const iconSvg = '<svg class="icon-mini" style="width: 24px; height: 24px; color: #F59E0B; margin-right: 8px;" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>';
            aiTitle.innerHTML = iconSvg + `<span>${spotName} 小故事</span>`;
            aiInputArea.style.display = 'none';
            btnBackTrans.style.display = 'block';

            // Add system message to chat indicating start
            appendMessage('ai', `正在為您生成關於「${spotName}」的故事...`);

            const prompt = `
                你是一位帶領親子旅遊的九州導遊。
                請針對景點「${spotName}」生成一段給 5-8 歲小孩聽的導覽詞。
                要求：
                1. 語氣生動活潑，使用台灣繁體中文。
                2. 內容包含一個關於該景點的有趣冷知識。
                3. 給孩子一個「小小觀察任務」（例如：找找看某個顏色的東西）。
                4. 整體長度控制在 150 字以內。
                5. ${customPrompt}
            `;

            callGemini(prompt);
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendToGemini('auto');
        }

        // [修改] AI 發送邏輯：整合系統記憶與多種模式
        // [修改] AI 發送邏輯：加入「情境感知」能力
        // [修改] AI 發送邏輯：整合記憶、天氣感知、以及「羅馬拼音」翻譯
        // [修改] AI 發送邏輯：依據翻譯方向決定是否顯示拼音
        // [修改] AI 發送邏輯：加入「連續對話記憶」功能
        // [修改] AI 發送邏輯：修復「諮詢模式」誤判為翻譯的問題
        async function sendToGemini(mode) {
            const text = aiInput.value.trim();
            if (!text) return;

            // 顯示使用者的話
            appendMessage('user', text);
            aiInput.value = '';

            let finalPrompt = "";

            // 取得目前選擇的語言
            const selectedLang = document.querySelector('input[name="voice_lang"]:checked').value;
            const isInputZh = selectedLang === 'zh-TW';

            // --- 模式 A: 行程諮詢 ---
            if (mode === 'consult' || mode === 'auto') {
                let liveContext = "";
                if (window.appCache && window.appCache['my_location_combined']) {
                    const d = window.appCache['my_location_combined'].data;
                    liveContext = `目前位置：${d.city}, 天氣：${d.code}, 氣溫：${d.temp}°C`;
                }
                const historyText = conversationHistory.join('\n');

                finalPrompt = `
                    ${systemPrompt}
                    ${liveContext}
                    ${historyText}
                    【使用者問題】： "${text}"
                `;
            }
            // --- 模式 B: 手動按翻譯按鈕 ---
            else if (mode === 'translate') {
                finalPrompt = `
                    Role: Professional JP/TW Translator.
                    Input: "${text}"
                    Rules:
                    1. If input is Chinese -> Translate to Japanese (Polite). Add Pronunciation.
                    2. If input is Japanese -> Translate to Traditional Chinese.
                    Output: Translation result ONLY.
                `;
            }
            // --- 模式 C: 語音直達翻譯 (Voice Direct) ---
            else if (mode === 'voice_direct') {
                if (isInputZh) {
                    // 使用者說中文 -> 翻成日文給店員聽
                    finalPrompt = `
                        Task: Translate this Traditional Chinese text to Japanese (Polite form).
                        Input: "${text}"
                        Output: ONLY the Japanese translation text. NO Romaji. NO explanations.
                     `;
                } else {
                    // 使用者(或店員)說日文 -> 翻成中文給自己看
                    finalPrompt = `
                        Task: Translate this Japanese text to Traditional Chinese (Taiwan).
                        Input: "${text}"
                        Output: ONLY the Chinese translation. NO English. NO Romanization.
                     `;
                }
            }

            showLoading();
            try {
                const responseText = await getGeminiResponse(finalPrompt);
                removeLoading();

                // 決定是否顯示喇叭按鈕
                let showAudioBtn = false;

                if (mode === 'voice_direct') {
                    // 邏輯：如果你說中文(isInputZh)，代表你要翻成日文給別人聽 -> 顯示喇叭
                    if (isInputZh) {
                        showAudioBtn = true;
                    }
                    // 如果你錄的是日文，代表是翻譯成中文給自己看 -> 不顯示喇叭
                } else {
                    // 手動翻譯模式：只要結果有日文就顯示喇叭
                    showAudioBtn = (mode === 'translate') && /[\u3040-\u309F\u30A0-\u30FF]/.test(responseText);
                }

                const formattedText = responseText.replace(/\n/g, '<br>');
                appendMessage('ai', formattedText, showAudioBtn);

                // 寫入歷史紀錄 (諮詢模式才需要)
                if (mode === 'consult' || mode === 'auto') {
                    conversationHistory.push(`User: ${text}`);
                    conversationHistory.push(`Guide: ${responseText}`);
                    if (conversationHistory.length > 20) conversationHistory = conversationHistory.slice(-20);
                }

            } catch (e) {
                removeLoading();
                appendMessage('ai', `<span style="color:red">連線錯誤: ${e.message}</span>`);
            }
        }

        async function callGemini(promptText) {
            showLoading();

            try {
                // 改用新的共用函數 getGeminiResponse
                let rawText = await getGeminiResponse(promptText);
                removeLoading();

                // Check for Japanese chars to decide if we show audio button
                const hasJapanese = /[\u3040-\u309F\u30A0-\u30FF]/.test(rawText);
                const isTranslation = hasJapanese && rawText.length < 500;

                // Format text (convert newlines to <br>)
                const formattedText = rawText.replace(/\n/g, '<br>');

                appendMessage('ai', formattedText, isTranslation);

            } catch (error) {
                removeLoading();
                console.error('Gemini API Error:', error);
                appendMessage('ai', `<span style="color:red">發生錯誤，請稍後再試。<br>Error: ${error.message}</span>`);
            }
        }
        function resetAppPassword() {
            if (confirm("您確定要清除已記憶的密碼並重新輸入嗎？")) {
                localStorage.removeItem("app_password"); // 清除瀏覽器記憶
                alert("密碼已清除！頁面將重新整理，請重新輸入新密碼。");
                window.location.reload(); // 重新整理網頁
            }
        }
        // [修改] 行前清單功能：支援動態新增、刪除與狀態儲存
        const CHECKLIST_KEY = 'tokyo_trip_checklist_v1'; // 改用新 Key 避免舊資料衝突

        // 預設清單資料 (若使用者第一次開啟)
        const defaultItems = [
            { id: 'c1', text: '機場停車預約 (截圖備份)', checked: false },
            { id: 'c2', text: '護照 & 機票 (截圖備份)', checked: false },
            { id: 'c3', text: '旅遊保險單 (紙本/電子)', checked: false },
            { id: 'c4', text: '日幣現金 & 信用卡 & 西瓜卡', checked: false },
            { id: 'c5', text: 'eSIM / 漫遊開通', checked: false },
            { id: 'c6', text: 'Visit Japan Web 填寫', checked: false },
            { id: 'c7', text: '行動電源 & 充電線 & 車充', checked: false },
            { id: 'c8', text: '牙刷/常備藥品', checked: false },
            { id: 'c9', text: '健保卡 / 大頭照', checked: false },
            { id: 'c10', text: '小工具醫療箱 / 雪松', checked: false },
            { id: 'c11', text: '耳溫槍 / 得體刀', checked: false },
            { id: 'c12', text: '相機 / 讀卡機 / 拍立得', checked: false },
            { id: 'c13', text: '隱形眼鏡 / 墨鏡', checked: false },
        ];

        let checklistData = [];

        function initChecklist() {
            // 1. 讀取資料
            const saved = localStorage.getItem(CHECKLIST_KEY);
            if (saved) {
                try {
                    checklistData = JSON.parse(saved);
                } catch (e) {
                    checklistData = JSON.parse(JSON.stringify(defaultItems));
                }
            } else {
                checklistData = JSON.parse(JSON.stringify(defaultItems)); // 深拷貝
            }
            renderChecklist();
        }

        // 渲染清單畫面 (包含計算進度)
        function renderChecklist() {
            const listArea = document.getElementById('checklist-list-area');
            const progressEl = document.getElementById('checklist-progress');
            if (!listArea) return;

            listArea.innerHTML = ''; // 清空目前畫面
            let checkedCount = 0;

            checklistData.forEach((item, index) => {
                if (item.checked) checkedCount++;

                const label = document.createElement('label');
                label.className = 'check-item';
                // 點擊 label 本身切換 checkbox，防止點擊刪除按鈕時觸發
                label.innerHTML = `
                    <div style="display:flex; align-items:center; gap:8px; flex:1; cursor:pointer;">
                        <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleItemStatus(${index})">
                        <span>${item.text}</span>
                    </div>
                    <button class="btn-del-item" onclick="deleteCheckItem(${index}, event)">×</button>
                `;
                listArea.appendChild(label);
            });

            // 更新進度文字
            if (progressEl) {
                progressEl.innerText = `${checkedCount}/${checklistData.length}`;
                if (checkedCount === checklistData.length && checklistData.length > 0) {
                    progressEl.style.background = '#ECFDF5';
                    progressEl.style.color = '#059669';
                    progressEl.innerText = '準備完成！';
                } else {
                    progressEl.style.background = '#FFFBEB';
                    progressEl.style.color = '#D97706';
                }
            }

            // 儲存到 LocalStorage
            localStorage.setItem(CHECKLIST_KEY, JSON.stringify(checklistData));
        }

        // 切換勾選狀態
        function toggleItemStatus(index) {
            checklistData[index].checked = !checklistData[index].checked;
            renderChecklist(); // 重新渲染 (會自動儲存)
        }

        // 新增項目
        function addNewCheckItem() {
            const input = document.getElementById('new-item-input');
            const text = input.value.trim();
            if (!text) return;

            checklistData.unshift({ // 加在最上面
                id: 'new_' + Date.now(),
                text: text,
                checked: false
            });

            input.value = '';
            renderChecklist();
        }

        // 刪除項目
        function deleteCheckItem(index, event) {
            // 阻止事件冒泡，避免點擊刪除時觸發 label 的勾選
            event.stopPropagation();
            event.preventDefault();

            if (confirm('確定要刪除這個項目嗎？')) {
                checklistData.splice(index, 1);
                renderChecklist();
            }
        }
        // [新增] 重置檢查清單 (恢復預設值)
        function resetChecklist(event) {
            event.stopPropagation(); // 阻止冒泡，避免觸發折疊

            if (!confirm("確定要重置清單嗎？\n\n這將會：\n1. 清除所有勾選狀態\n2. 刪除您自訂的新增項目\n3. 恢復為原始預設清單")) {
                return;
            }

            // 恢復為預設項目 (使用深拷貝，避免汙染原始 defaultItems)
            checklistData = JSON.parse(JSON.stringify(defaultItems));

            // 重新渲染並儲存
            renderChecklist();

            // 如果清單目前是收合的，自動展開讓使用者看到結果
            const container = document.getElementById('checklist-container');
            const icon = document.querySelector('.checklist-card-header .toggle-icon');
            if (container && !container.classList.contains('show')) {
                container.classList.add('show');
                if (icon) {
                    icon.style.transform = 'rotate(180deg)';
                    icon.style.color = '#2563EB';
                }
            }

            alert("清單已重置完成！");
        }
        // 折疊/展開控制
        function toggleChecklist(headerEl) {
            const container = document.getElementById('checklist-container');
            const icon = headerEl.querySelector('.toggle-icon');

            // 切換顯示容器 (加上或移除 .show 類別)
            const isClosed = !container.classList.contains('show');

            if (isClosed) {
                container.classList.add('show');
                icon.style.transform = 'rotate(180deg)';
                icon.style.color = '#2563EB';
            } else {
                container.classList.remove('show');
                icon.style.transform = 'rotate(0deg)';
                icon.style.color = '#6B7280';
            }
        }
        // [新增] 圖片預覽全域變數
        let pendingImageBase64 = null;

        // [新增] 關閉圖片預覽
        function cancelImagePreview() {
            document.getElementById('img-preview-modal').style.display = 'none';
            pendingImageBase64 = null;
        }

        // [新增] 確認發送圖片 (原本的邏輯移到這裡)
        async function confirmImageAnalysis() {
            if (!pendingImageBase64) return;

            // [修正] 1. 移除這裡的 cancelImagePreview();
            // 不要在一開始就清除資料！

            // 2. 先把視窗隱藏起來就好 (視覺上關閉，但不要清空變數)
            document.getElementById('img-preview-modal').style.display = 'none';

            showLoading();

            try {
                // 3. 在聊天室顯示圖片
                // [修改] 加入 onclick 事件與 cursor:zoom-in 樣式
                const imgHtml = `<img src="data:image/jpeg;base64,${pendingImageBase64}" onclick="openLightbox(this.src)" style="max-width:100%; border-radius:10px; border:1px solid #ccc; margin-top:5px; cursor:zoom-in;">`;
                appendMessage('user', imgHtml);

                // 讀取位置
                let curLoc = "";
                if (window.appCache && window.appCache['my_location_combined']) {
                    curLoc = window.appCache['my_location_combined'].data.city;
                }

                // 設定 Prompt
                const visionPrompt = `
                ${systemPrompt}
                【使用者傳送了一張圖片】
                【使用者目前位置】：${curLoc}
                任務：請擔任專業導遊與購物助手。
                請判斷圖片內容並提供協助：
                1. 若是商品/藥妝/零食：說明這是什麼 (名稱與功效)，並推薦在「${curLoc}」哪裡買得到。
                2. 若是菜單：翻譯菜名並推薦必吃。
                3. 若是景點/路牌：告訴我這在哪裡。
                請用簡潔、像朋友般的口吻回答。
            `;

                // 4. 發送 API (這時候 pendingImageBase64 還有值，所以會成功)
                const responseText = await getGeminiResponse(visionPrompt, pendingImageBase64);

                removeLoading();
                const formattedText = responseText.replace(/\n/g, '<br>');
                appendMessage('ai', formattedText, false);

            } catch (e) {
                removeLoading();
                appendMessage('ai', `<span style="color:red">圖片辨識失敗：${e.message}</span>`);
            } finally {
                // [修正] 5. 無論成功或失敗，最後才真正清空變數
                pendingImageBase64 = null;
            }
        }
        async function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 1. 壓縮圖片 (但先不發送)
            // 為了預覽流暢，這裡先做壓縮，如果檔案太大會在這裡處理掉
            try {
                pendingImageBase64 = await compressImage(file, 800, 0.7);

                // 2. 顯示預覽彈窗
                const previewImg = document.getElementById('img-preview-content');
                previewImg.src = `data:image/jpeg;base64,${pendingImageBase64}`;

                document.getElementById('img-preview-modal').style.display = 'flex';

            } catch (e) {
                alert("圖片處理失敗，請重試");
                console.error(e);
            }

            // 3. 清空 input，確保下次選同一張圖也能觸發 change 事件
            event.target.value = '';
        }

        // 🟢 正確位置：壓縮函式也一起移出來
        function compressImage(file, maxWidth, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        let w = img.width;
                        let h = img.height;
                        if (w > maxWidth) {
                            h = Math.round(h * (maxWidth / w));
                            w = maxWidth;
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = w;
                        canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        const dataUrl = canvas.toDataURL('image/jpeg', quality);
                        const base64 = dataUrl.split(',')[1];
                        resolve(base64);
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        }

        // --- 👇 請在此處插入修正衝突的程式碼 👇 ---

        // [修正] 防止天氣橫向捲動區與全域換頁手勢衝突
        // [修正] 防止天氣橫向捲動區與全域換頁手勢衝突
        // [修正] 防止天氣視窗滑動時誤觸底層換頁
        function preventSwipeConflict() {
            // 定義一個阻擋訊號往上傳的函式
            const stopPropagation = (e) => {
                e.stopPropagation();
            };

            // 1. 針對「橫向」捲動的小時預報 (維持原有功能)
            const hourlyScroll = document.getElementById('wd-hourly-list');
            if (hourlyScroll) {
                hourlyScroll.addEventListener('touchstart', stopPropagation, { passive: true });
                hourlyScroll.addEventListener('touchmove', stopPropagation, { passive: true });
                hourlyScroll.addEventListener('touchend', stopPropagation, { passive: true });
                hourlyScroll.addEventListener('wheel', stopPropagation, { passive: true });
            }

            // 2. [新增] 針對「垂直」捲動的天氣視窗白色區塊 (.modal-box)
            // 這行是解決「上下滑動誤控」的關鍵
            const weatherModalBox = document.querySelector('#weather-detail-modal .modal-box');
            if (weatherModalBox) {
                weatherModalBox.addEventListener('touchstart', stopPropagation, { passive: true });
                weatherModalBox.addEventListener('touchmove', stopPropagation, { passive: true });
                weatherModalBox.addEventListener('touchend', stopPropagation, { passive: true });
                weatherModalBox.addEventListener('wheel', stopPropagation, { passive: true });
            }

            // 3. [新增] 針對 OSM 地圖容器 (防止拖曳地圖時觸發換頁)
            const osmMap = document.getElementById('ai-osm-map');
            if (osmMap) {
                // 阻擋所有手勢與滾輪事件冒泡
                osmMap.style.touchAction = 'none'; // [新增] 避免瀏覽器預設行為干擾

                // ★ 關鍵修正：只阻擋 touchstart，這樣 PageFlip 引擎就不會啟動 (isDragging = false)
                // 但必須放行 touchmove/touchend，因為 Leaflet 需要在 document 層級監聽拖曳
                osmMap.addEventListener('touchstart', stopPropagation, { passive: true });

                // osmMap.addEventListener('touchmove', stopPropagation, { passive: true }); // [刪除] 讓 Leaflet 收到
                // osmMap.addEventListener('touchend', stopPropagation, { passive: true });  // [刪除] 讓 Leaflet 收到

                osmMap.addEventListener('wheel', stopPropagation, { passive: true });
            }
        }

        // 確保頁面載入完成後執行綁定
        window.addEventListener('load', preventSwipeConflict);

        // --- 👆 插入結束 👆 ---

        document.addEventListener('DOMContentLoaded', () => {
            // [新增] 依據 GPS 位置自動判斷日夜 (支援跨時區)
            function initDynamicTheme() {
                const header = document.querySelector('header');

                // 定義成功時的邏輯
                const applyTheme = async (lat, lon) => {
                    try {
                        // 呼叫 API，傳入當下座標，API 會根據經緯度與天文時間自動計算
                        // current_weather=true 包含 is_day (1=白天, 0=黑夜)
                        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`;

                        // 嘗試讀取快取以節省流量 (與天氣功能共用快取系統)
                        const cacheKey = `theme_status_${lat.toFixed(1)}_${lon.toFixed(1)}`;
                        let isDay = CACHE_SYSTEM.get(cacheKey);

                        if (isDay === null) {
                            const res = await fetch(url);
                            const data = await res.json();
                            isDay = data.current_weather.is_day;
                            // 存入快取 30 分鐘
                            CACHE_SYSTEM.save(cacheKey, isDay, 30);
                        }

                        // 切換樣式：0 代表黑夜，1 代表白天
                        if (isDay === 0) {
                            header.classList.add('is-night');
                            console.log(`[主題] 位於 (${lat},${lon})，目前是夜晚 🌙`);
                        } else {
                            header.classList.remove('is-night');
                            console.log(`[主題] 位於 (${lat},${lon})，目前是白天 ☀️`);
                        }

                        // ★★★ [插入這段] 設定完日夜後，強制重繪特效 ★★★
                        if (window.setWeatherEffect && window.currentWeatherIcon) {
                            setWeatherEffect(window.currentWeatherIcon);
                        }
                    } catch (e) {
                        console.warn("主題 API 連線失敗，切換為系統時間備案");
                        fallbackTheme();
                    }
                };

                // 備案邏輯：如果沒開 GPS 或 API 失敗，改用手機系統時間
                const fallbackTheme = () => {
                    const hour = new Date().getHours();
                    // 簡單判斷：晚上 6 點後或早上 6 點前為夜晚
                    if (hour >= 18 || hour < 6) {
                        header.classList.add('is-night');
                    } else {
                        header.classList.remove('is-night');
                    }

                    // ★★★ [插入這段] 備案模式也要重繪特效 ★★★
                    if (window.setWeatherEffect && window.currentWeatherIcon) {
                        setWeatherEffect(window.currentWeatherIcon);
                    }
                };

                // 開始執行定位
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            // 成功取得位置，使用 API 精準判斷
                            applyTheme(position.coords.latitude, position.coords.longitude);
                        },
                        (error) => {
                            console.log("無法取得位置，使用時間備案");
                            fallbackTheme();
                        },
                        { timeout: 5000 }
                    );
                } else {
                    fallbackTheme();
                }
            }

            // 啟動主題偵測
            initDynamicTheme();
            // [新增] 圖片處理與壓縮邏輯

            // --- 智慧自動展開邏輯開始 ---

            // 1. 定義日期與行程 ID 的對應表
            const scheduleMap = {
                '2026-04-18': 'd1',
                '2026-04-19': 'd2',
                '2026-04-20': 'd3'
            };

            // 2. 取得今日日期 (格式 YYYY-MM-DD)
            const now = new Date();
            // ★ 測試用：若想現在測試「旅途中」的效果，請取消下行註解並修改日期
            //const now = new Date('2026-01-28'); 

            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${day}`;

            // 3. 取得 DOM 元素
            const checklistContainer = document.getElementById('checklist-container');
            const checklistIcon = document.querySelector('.checklist-card-header .toggle-icon');

            // 4. 執行判斷
            if (todayStr < '2026-04-18') {
                // 【情境 A：行前準備期】(現在 ~ 4/17)
                // 動作：自動展開 Checklist，收合所有行程

                if (checklistContainer) {
                    checklistContainer.classList.add('show');
                    if (checklistIcon) {
                        checklistIcon.style.transform = 'rotate(180deg)';
                        checklistIcon.style.color = '#2563EB'; // 藍色箭頭表示展開
                    }
                }
                // 預設載入 Day 1 天氣資訊供參考
                /*updateWeatherWidget('d1');*/

            } else if (scheduleMap[todayStr]) {
                // 【情境 B：旅途中】(1/25 ~ 1/30)
                // 動作：Checklist 保持關閉，自動展開「當天」的行程

                const targetDayId = scheduleMap[todayStr];
                const dayTimeline = document.getElementById(targetDayId);
                const dayToggle = document.getElementById('toggle-' + targetDayId);
                const dayIcon = dayToggle ? dayToggle.querySelector('.toggle-icon') : null;

                if (dayTimeline && dayToggle) {
                    // 展開該日行程
                    dayTimeline.classList.add('show');
                    dayToggle.classList.add('open'); // 讓左邊框變色
                    if (dayIcon) {
                        // 這裡您使用 div 箭頭，我們透過 CSS class 控制旋轉，或者直接用 style
                        // 您的 CSS .day-toggle.open .toggle-icon 已經有設定 transform，所以加上 open 類別即可
                    }

                    // 更新 Header 天氣為「當天」的地點
                    updateWeatherWidget(targetDayId);

                    // (選用) 自動捲動到當日行程，提升體驗
                    setTimeout(() => {
                        dayToggle.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 500);
                }
            } else {
                // 【情境 C：旅程結束】
                // 全部收合，或視需求顯示
                /*updateWeatherWidget('d1'); // 預設回顯 D1*/
            }

            // --- 智慧自動展開邏輯結束 ---

            initAiChat();
            setupVoiceButton(); // Init voice listener
            getLocalWeather(); // Fetch local weather on load
            initChecklist(); // Init checklist
            // [修正] 1:1 指隨心動物理翻頁引擎 (Physics Page Flip)
            let isDragging = false;
            let startX = 0;
            let startY = 0; // [新增] 垂直起點，用來判斷是否為捲動
            let currentTranslate = 0;
            let activeContainer = null;
            let navItems = [];
            let activeIndex = 0;

            // 1. 手指按下：鎖定目標，準備拖曳
            document.addEventListener('touchstart', (e) => {
                // [新增] 防止文字選取衝突：若點擊的是輸入框或編輯區，或是「正在選取文字」，則不啟動滑動邏輯
                if (['INPUT', 'TEXTAREA'].includes(e.target.tagName) || e.target.isContentEditable || window.getSelection().toString().length > 0) {
                    return;
                }

                const active = document.querySelector('.container.active');
                if (!active || active.classList.contains('is-animating')) return;

                // [修正] 改為「潛在拖曳中」，先不鎖死，等移動判斷方向後再決定
                isDragging = true;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY; // [新增] 紀錄垂直位置
                activeContainer = active;

                navItems = Array.from(document.querySelectorAll('.nav-item'));
                const activeNavItem = document.querySelector('.nav-item.active');
                activeIndex = navItems.indexOf(activeNavItem);
            }, { passive: false });

            // 2. 手指移動：計算物理量，即時更新畫面
            document.addEventListener('touchmove', (e) => {
                if (!isDragging || !activeContainer) return;

                const currentX = e.touches[0].clientX;
                const currentY = e.touches[0].clientY;
                const diffX = currentX - startX;
                const diffY = currentY - startY;

                // 優先判斷捲動：如果垂直移動 > 水平移動，視為捲動網頁
                if (Math.abs(diffY) > Math.abs(diffX)) {
                    isDragging = false;
                    activeContainer.classList.remove('is-dragging');
                    return;
                }

                // 確定是水平滑動
                activeContainer.classList.add('is-dragging');
                if (e.cancelable) e.preventDefault();

                // ★ [修改] 核心物理公式：改為 2D 平移 (TranslateX)
                // 使用 translate3d 確保啟用 GPU 加速
                activeContainer.style.transform = `translate3d(${diffX}px, 0, 0)`;

                // 💡 [選用] 根據滑動距離微調透明度 (模擬您提供的 opacity: 0 效果)
                // 滑動越遠，透明度越低 (最多降到 0.8，保留一點可見度以免使用者迷失)
                const opacity = 1 - (Math.abs(diffX) / window.innerWidth) * 0.5;
                activeContainer.style.opacity = opacity;
                activeContainer.style.filter = ''; // 移除舊的亮度濾鏡，保持乾淨

                currentTranslate = diffX;
            }, { passive: false });


            // 3. 手指放開：判斷是「翻過去」還是「彈回來」
            document.addEventListener('touchend', (e) => {
                if (!isDragging || !activeContainer) return;
                isDragging = false;

                // 移除拖曳狀態，加入動畫狀態 (讓 CSS 接手剩下的動作)
                activeContainer.classList.remove('is-dragging');
                activeContainer.classList.add('is-animating');

                const threshold = 80; // 滑動超過 80px 就視為要翻頁

                // A. 決定翻頁 (滑動距離足夠)
                // A. 決定翻頁 (滑動距離足夠)
                if (Math.abs(currentTranslate) > threshold) {
                    const direction = currentTranslate > 0 ? 'prev' : 'next';
                    let targetIndex;

                    // [修正] 循環邏輯：使用餘數運算來實現無限循環
                    if (direction === 'next') {
                        // 往右翻 (下一頁): 如果是最後一頁，會回到 0
                        targetIndex = (activeIndex + 1) % navItems.length;
                    } else {
                        // 往左翻 (上一頁): 如果是第 0 頁，會回到最後一頁
                        targetIndex = (activeIndex - 1 + navItems.length) % navItems.length;
                    }

                    finishFlip(activeContainer, direction, navItems[targetIndex]);
                }
                // B. 取消翻頁 (滑動距離不夠，彈回來)
                else {
                    revertFlip(activeContainer);
                }

                currentTranslate = 0;
            });

            // 輔助：彈回原位 (Revert)
            function revertFlip(element) {
                // 回到中心 (x: 0)
                element.style.transform = 'translate3d(0, 0, 0)';
                element.style.opacity = '1';

                setTimeout(() => {
                    element.classList.remove('is-animating');
                    element.style.transform = '';
                    element.style.opacity = '';
                }, 250); // 對應 CSS 的 0.25s
            }

            // 輔助：完成翻頁動作 (Slide Out & Slide In)
            function finishFlip(oldElement, direction, nextNavItem) {
                const screenW = window.innerWidth;

                // 1. 舊頁面滑出去 (Slide Exit)
                // 往左滑(Next) -> 舊頁面去 -100%，往右滑(Prev) -> 舊頁面去 100%
                const targetX = direction === 'next' ? -screenW : screenW;

                oldElement.style.transform = `translate3d(${targetX}px, 0, 0)`;
                oldElement.style.opacity = '0'; // 滑出時淡出

                // 2. 等舊頁面滑出去後，切換內容
                setTimeout(() => {
                    switchTab(nextNavItem);

                    const newTargetId = nextNavItem.getAttribute('data-target');
                    const newContainer = document.getElementById(newTargetId);

                    // 3. 新頁面準備進場 (Slide Enter)
                    // 如果是 Next，新頁面從右邊(100%)進來；如果是 Prev，從左邊(-100%)進來
                    const startX = direction === 'next' ? screenW : -screenW;

                    newContainer.classList.add('is-dragging'); // 暫時移除 transition 以便瞬間定位
                    newContainer.style.transform = `translate3d(${startX}px, 0, 0)`;
                    newContainer.style.opacity = '0';

                    // 強制瀏覽器重繪 (Reflow) 確保定位生效
                    void newContainer.offsetWidth;

                    // 4. 執行進場動畫 (Go to Center)
                    newContainer.classList.remove('is-dragging');
                    newContainer.classList.add('is-animating');
                    newContainer.style.transform = 'translate3d(0, 0, 0)';
                    newContainer.style.opacity = '1';

                    // 清理舊元素
                    oldElement.classList.remove('is-animating');
                    oldElement.style.transform = '';
                    oldElement.style.opacity = '';

                    // 清理新元素
                    setTimeout(() => {
                        newContainer.classList.remove('is-animating');
                        newContainer.style.transform = '';
                    }, 250); // 對應 CSS 的 0.25s

                }, 200); // 稍微提早一點切換，讓銜接更緊密
            }
        });
        // [升級版] 圖片放大燈箱控制函式 (含縮放與拖曳功能)
        let lbState = {
            scale: 1,
            panning: false,
            pointX: 0, pointY: 0, // 當前座標
            startX: 0, startY: 0, // 拖曳起始點
            lastX: 0, lastY: 0,   // 上一次結束點
            initialDist: 0        // 雙指初始距離
        };

        const lbImg = document.getElementById('lightbox-img');
        const lbModal = document.getElementById('lightbox-modal');

        // 1. 開啟燈箱
        window.openLightbox = function (src) {
            if (!lbImg || !lbModal) return;

            lbImg.src = src;
            lbModal.style.display = 'flex';

            // 重置狀態
            resetLightbox();

            // 阻擋圖片點擊冒泡 (避免點圖片時關閉燈箱)
            lbImg.onclick = (e) => e.stopPropagation();

            // 加入事件監聽
            addLightboxListeners();
        }

        // 2. 關閉燈箱
        window.closeLightbox = function (e) {
            // 只有點擊背景(遮罩)或關閉按鈕時才關閉
            // (因為 img 已經阻擋冒泡，這裡通常是點到 overlay)
            if (e && e.target !== lbModal && !e.target.classList.contains('lightbox-close')) return;

            lbModal.style.display = 'none';
            removeLightboxListeners();
        }

        function resetLightbox() {
            lbState = { scale: 1, panning: false, pointX: 0, pointY: 0, startX: 0, startY: 0, lastX: 0, lastY: 0, initialDist: 0 };
            updateTransform();
        }

        function updateTransform() {
            // 限制縮小不能小於 1 (原尺寸)
            if (lbState.scale < 1) lbState.scale = 1;
            lbImg.style.transform = `translate(${lbState.pointX}px, ${lbState.pointY}px) scale(${lbState.scale})`;
        }

        // --- 事件處理區 ---

        function addLightboxListeners() {
            // 電腦版：滾輪縮放
            lbImg.addEventListener('wheel', handleWheel, { passive: false });
            // 電腦版：拖曳
            lbImg.addEventListener('mousedown', handleMouseDown);

            // 手機版：觸控
            lbImg.addEventListener('touchstart', handleTouchStart, { passive: false });
            lbImg.addEventListener('touchmove', handleTouchMove, { passive: false });
            lbImg.addEventListener('touchend', handleTouchEnd);
        }

        function removeLightboxListeners() {
            lbImg.removeEventListener('wheel', handleWheel);
            lbImg.removeEventListener('mousedown', handleMouseDown);
            window.removeEventListener('mousemove', handleMouseMove);
            window.removeEventListener('mouseup', handleMouseUp);
            lbImg.removeEventListener('touchstart', handleTouchStart);
            lbImg.removeEventListener('touchmove', handleTouchMove);
            lbImg.removeEventListener('touchend', handleTouchEnd);
        }

        // [電腦] 滾輪縮放
        function handleWheel(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.2 : 0.2;
            lbState.scale += delta;
            updateTransform();
        }

        // [電腦] 滑鼠拖曳
        function handleMouseDown(e) {
            if (lbState.scale <= 1) return; // 沒放大時不給拖
            e.preventDefault();
            lbState.startX = e.clientX - lbState.pointX;
            lbState.startY = e.clientY - lbState.pointY;
            lbState.panning = true;

            window.addEventListener('mousemove', handleMouseMove);
            window.addEventListener('mouseup', handleMouseUp);
        }

        function handleMouseMove(e) {
            if (!lbState.panning) return;
            e.preventDefault();
            lbState.pointX = e.clientX - lbState.startX;
            lbState.pointY = e.clientY - lbState.startY;
            updateTransform();
        }

        function handleMouseUp() {
            lbState.panning = false;
            window.removeEventListener('mousemove', handleMouseMove);
            window.removeEventListener('mouseup', handleMouseUp);
        }

        // [手機] 觸控處理 (單指拖曳 / 雙指縮放)
        function handleTouchStart(e) {
            if (e.touches.length === 2) {
                // 雙指：開始縮放
                e.preventDefault(); // 防止背景捲動
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                lbState.initialDist = Math.hypot(touch1.pageX - touch2.pageX, touch1.pageY - touch2.pageY);
                lbState.lastScale = lbState.scale;
            } else if (e.touches.length === 1 && lbState.scale > 1) {
                // 單指且已放大：開始拖曳
                const touch = e.touches[0];
                lbState.startX = touch.pageX - lbState.pointX;
                lbState.startY = touch.pageY - lbState.pointY;
                lbState.panning = true;
            }
        }

        function handleTouchMove(e) {
            if (e.touches.length === 2) {
                // 雙指縮放中
                e.preventDefault();
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const dist = Math.hypot(touch1.pageX - touch2.pageX, touch1.pageY - touch2.pageY);

                // 計算縮放比例
                const delta = dist / lbState.initialDist;
                lbState.scale = lbState.lastScale * delta;
                updateTransform();
            } else if (e.touches.length === 1 && lbState.panning) {
                // 單指拖曳中
                e.preventDefault(); // 防止背景捲動
                const touch = e.touches[0];
                lbState.pointX = touch.pageX - lbState.startX;
                lbState.pointY = touch.pageY - lbState.startY;
                updateTransform();
            }
        }

        function handleTouchEnd(e) {
            lbState.panning = false;
            if (e.touches.length < 2) {
                lbState.initialDist = 0;
            }
        }
        // [新增] 複製文字功能 (含回饋動畫)
        function copyText(btn, text) {
            if (!navigator.clipboard) {
                // 備案：若瀏覽器不支援 Clipboard API (較舊的安卓 Webview)
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("Copy");
                document.body.removeChild(textArea);
                showCopyFeedback(btn);
                return;
            }

            navigator.clipboard.writeText(text).then(() => {
                showCopyFeedback(btn);
            }).catch(err => {
                console.error('複製失敗', err);
                alert('複製失敗，請手動複製');
            });
        }

        function showCopyFeedback(btn) {
            const originalHtml = btn.innerHTML;
            // 變更為綠色勾勾
            btn.innerHTML = `<svg class="icon-mini" style="width:12px;height:12px;"><path d="M20 6L9 17l-5-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> 已複製`;
            btn.classList.add('copied');

            // 2秒後復原
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.classList.remove('copied');
            }, 2000);
        }
        // [新增] 定義一個全域變數來記住現在是什麼圖示 (預設 cloud)
        window.currentWeatherIcon = 'cloud';

        // [修改] 原本的 setWeatherEffect 函式
        function setWeatherEffect(iconType) {
            // 1. [關鍵新增] 無論切換到哪種天氣，先強制關閉之前的物理引擎
            // 這能確保雨天特效不會在晴天、陰天或霧天時繼續在背景運算
            if (typeof clearRainTimers === 'function') {
                clearRainTimers();
            }

            // 2. 記住現在的天氣圖示，以便日夜切換後重繪
            window.currentWeatherIcon = iconType;

            const header = document.querySelector('header');
            const layer = document.getElementById('weather-effect-layer');
            if (!header || !layer) return;

            // 3. 重置所有天氣 class (保留 is-night)
            header.classList.remove('w-sun', 'w-cloud', 'w-rain', 'w-snow', 'w-fog'); layer.innerHTML = ''; // 清空舊粒子

            // 2. 根據圖示類型套用對應特效
            // 對應您的 validIcons: 'sun', 'cloud', 'cloud-sun', 'snow', 'rain', 'fog', 'lightning'

            if (iconType === 'sun') {
                header.classList.add('w-sun');

                // [修改] 檢查 Header 是否有 'is-night' 類別 (由 initDynamicTheme 控制)
                if (header.classList.contains('is-night')) {
                    // ★ 情境 A：晴朗的晚上 -> 顯示寫實星空
                    let stars = '';
                    // 生成 60 顆隨機分佈的星星
                    for (let i = 0; i < 60; i++) {
                        const left = Math.floor(Math.random() * 100);     // 水平隨機
                        const top = Math.floor(Math.random() * 70);       // 集中在中上空 (0%~70%)
                        const size = (Math.random() * 2 + 1).toFixed(1);  // 大小 1px ~ 3px
                        const dur = (Math.random() * 3 + 1.5).toFixed(1); // 閃爍速度 1.5s ~ 4.5s (讓星星不要閃得太整齊)
                        const delay = (Math.random() * 2).toFixed(1);     // 隨機延遲入場

                        stars += `<div class="star-particle" style="left:${left}%; top:${top}%; width:${size}px; height:${size}px; animation-duration:${dur}s; animation-delay:${delay}s;"></div>`;
                    }
                    layer.innerHTML = stars;
                } else {
                    // ★ 情境 B：晴朗的白天 -> 顯示太陽光暈 (原本的代碼)
                    layer.innerHTML = '<div class="sun-glow"></div>';
                }
            }
            else if (iconType === 'cloud' || iconType === 'cloud-sun') {
                header.classList.add('w-cloud');

                const isNight = header.classList.contains('is-night');

                // [關鍵修改] 設定日夜不同的透明度
                // 白天：雲朵不透明度高 (0.85)，看起來白白胖胖
                // 晚上：雲朵不透明度低 (0.4)，看起來像夜空中的陰影
                const mainOp = isNight ? 0.4 : 0.85;
                const bgOp = isNight ? 0.1 : 0.3;    // 背景大雲更淡

                let content = '';

                // [新增] 如果是「晚上多雲」，在雲層後方加一點稀疏的星星
                if (isNight) {
                    // 生成 15 顆星星 (比晴天的 60 顆少，營造被雲遮擋的感覺)
                    for (let i = 0; i < 15; i++) {
                        const left = Math.floor(Math.random() * 100);
                        const top = Math.floor(Math.random() * 80);
                        const size = (Math.random() * 2).toFixed(1);
                        // 閃爍速度設慢一點，營造寧靜感
                        const dur = (Math.random() * 3 + 3).toFixed(1);
                        content += `<div class="star-particle" style="left:${left}%; top:${top}%; width:${size}px; height:${size}px; animation-duration:${dur}s; opacity: 0.6;"></div>`;
                    }
                }

                // 雲朵層 (HTML 結構不變，但 style 裡的 opacity 換成了變數)
                content += `
            <div class="cloud-shape" style="top: 5%; transform: scale(3); animation-duration: 20s; opacity: ${bgOp}; z-index: 1;"></div>
            <div class="cloud-shape" style="top: 25%; transform: scale(1.8); animation-duration: 35s; animation-delay: -5s; opacity: ${mainOp};"></div>
            <div class="cloud-shape" style="top: 45%; width: 140px; transform: scale(1.6); animation-duration: 45s; animation-delay: -20s; opacity: ${mainOp * 0.8};"></div>
            <div class="cloud-shape" style="top: 65%; transform: scale(2.0); animation-duration: 60s; animation-delay: -10s; opacity: ${bgOp};"></div>
            <div class="cloud-shape" style="top: 10%; transform: scale(0.8); animation-duration: 80s; animation-delay: -40s; opacity: ${bgOp};"></div>
        `;

                layer.innerHTML = content;
            }
            else if (iconType === 'rain' || iconType === 'lightning') {
                // 1. 先清除舊狀態
                clearRainTimers();

                header.classList.add('w-rain');
                layer.innerHTML = '';

                // 2. [背景] 空中落下的雨絲
                const rainContainer = document.createElement('div');
                for (let i = 0; i < 40; i++) {
                    const drop = document.createElement('div');
                    drop.className = 'rain-drop';
                    drop.style.left = `${Math.floor(Math.random() * 100)}%`;
                    drop.style.animationDelay = `${(Math.random() * 2).toFixed(2)}s`;
                    drop.style.animationDuration = `${(0.5 + Math.random() * 0.4).toFixed(2)}s`;
                    rainContainer.appendChild(drop);
                }
                layer.appendChild(rainContainer);

                // 3. [前景] 玻璃容器
                const glassSurface = document.createElement('div');
                glassSurface.className = 'glass-surface';
                layer.appendChild(glassSurface);

                // 4. 生成「靜態水珠」 (獵物)
                const staticDrops = [];

                function spawnStaticDrop(isRespawn = false) {
                    const drop = document.createElement('div');
                    const left = Math.random() * 100;
                    const top = Math.random() * 95;
                    const size = (Math.random() * 6 + 3).toFixed(1);

                    drop.className = 'glass-drop';
                    if (isRespawn) drop.classList.add('fade-in');

                    drop.style.left = `${left}%`;
                    drop.style.top = `${top}%`;
                    drop.style.width = `${size}px`;
                    drop.style.height = `${size}px`;

                    const r1 = Math.floor(40 + Math.random() * 40);
                    const r2 = Math.floor(40 + Math.random() * 40);
                    drop.style.borderRadius = `${r1}% ${100 - r1}% ${r2}% ${100 - r2}%`;

                    glassSurface.appendChild(drop);
                    staticDrops.push(drop);
                }

                // 初始生成 45 顆
                for (let i = 0; i < 45; i++) spawnStaticDrop();

                // 5. 生成「動態水流」 (獵人)
                const activeTricklers = [];

                const spawnTrickler = () => {
                    const trickler = document.createElement('div');
                    const tLeft = Math.random() * 96 + 2;
                    const tDuration = Math.random() * 3 + 5; // 5~8秒
                    const tHeight = Math.random() * 40 + 60; // 60~100px

                    trickler.className = 'glass-drop trickle';
                    trickler.style.left = `${tLeft}%`;
                    trickler.style.top = '0%';
                    trickler.style.height = `${tHeight}px`;

                    trickler.style.animationDuration = `${tDuration}s`;

                    glassSurface.appendChild(trickler);
                    activeTricklers.push(trickler);

                    // 動畫結束後移除
                    const cleanup = setTimeout(() => {
                        trickler.remove();
                        const idx = activeTricklers.indexOf(trickler);
                        if (idx > -1) activeTricklers.splice(idx, 1);
                    }, tDuration * 1000);

                    window.rainTimers.push(cleanup);
                };

                // 6. [核心] 即時物理引擎 (Real-time Physics Engine)
                function runPhysicsLoop() {
                    if (activeTricklers.length > 0) {
                        const targets = staticDrops.filter(d => !d.classList.contains('merged') && d.parentNode);

                        activeTricklers.forEach(trickler => {
                            const tRect = trickler.getBoundingClientRect();
                            if (tRect.bottom < 0 || tRect.top > window.innerHeight) return;

                            targets.forEach(drop => {
                                const dRect = drop.getBoundingClientRect();

                                // 碰撞判定
                                const xOverlap = (tRect.right > dRect.left + 2) && (tRect.left < dRect.right - 2);
                                const yHit = (tRect.bottom >= dRect.top + 5);
                                const yNotPassed = (tRect.top < dRect.bottom);

                                if (xOverlap && yHit && yNotPassed) {
                                    drop.classList.add('merged'); // 即時消失

                                    // 3秒後重生
                                    const respawnTimer = setTimeout(() => {
                                        if (drop.parentNode) drop.remove();
                                        const idx = staticDrops.indexOf(drop);
                                        if (idx > -1) staticDrops.splice(idx, 1);
                                        spawnStaticDrop(true);
                                    }, Math.random() * 2000 + 2000);
                                    window.rainTimers.push(respawnTimer);
                                }
                            });
                        });
                    }
                    window.rainPhysicsFrame = requestAnimationFrame(runPhysicsLoop);
                }

                // 啟動引擎
                spawnTrickler();
                window.rainInterval = setInterval(spawnTrickler, 1200);
                runPhysicsLoop();
            }
            else if (iconType === 'snow') {
                // [重要] 切換到雪天時，務必清除雨天的物理運算
                if (typeof clearRainTimers === 'function') {
                    clearRainTimers();
                }

                header.classList.add('w-snow');

                let html = '';
                // 生成 30 片雪花 (依據您 snowflash 檔案中的設定)
                for (let i = 0; i < 30; i++) {
                    const left = Math.floor(Math.random() * 100);
                    const delay = (Math.random() * 5).toFixed(2);
                    // 讓雪花大小差異大一點 (3px ~ 8px)
                    const size = 3 + Math.floor(Math.random() * 6);

                    // opacity: 0.9 讓它在淺色背景更清楚
                    html += `<div class="snow-flake" style="left:${left}%; width:${size}px; height:${size}px; animation-delay:${delay}s; opacity: 0.9;"></div>`;
                }
                layer.innerHTML = html;
            }
            else if (iconType === 'fog') {
                header.classList.add('w-fog');

                const isNight = header.classList.contains('is-night');

                // [修正] 設定日夜透明度
                // 白天 (0.8): 霧很濃，下方白白的
                // 晚上 (0.2): 霧很薄，像一層薄紗，才不會讓夜空變成全白
                const fogOp = isNight ? 0.5 : 0.8;

                // 使用剛剛新增的 CSS class "fog-layer"
                layer.innerHTML = `<div class="fog-layer" style="opacity:${fogOp};"></div>`;
            }
            else {
                header.classList.add('w-cloud'); // 預設
            }
        }
        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('PWA Service Worker registered!', reg))
                    .catch(err => console.log('PWA registration failed:', err));
            });
        }
        // [新增] 開啟詳細天氣 Modal 的邏輯
        async function openDetailedWeatherModal() {
            // 1. 取得目前 Header 顯示的地點資料
            // 優先使用行程表切換的設定，如果沒有(例如剛開啟App)，則使用「我的位置」
            let config = window.currentActiveConfig;

            // 特判：如果使用者剛點了「我的位置」，我們需要抓取我的位置的經緯度
            // 這裡我們利用之前 getLocalWeather 存入的 appCache
            if (!config && window.appCache && window.appCache['my_location_combined']) {
                const myData = window.appCache['my_location_combined'].data;
                // 由於我們沒存經緯度在 cache (只存了氣溫)，這裡簡化處理：
                // 如果是「我的位置」狀態，重新觸發一次 getLocalWeather 來獲取經緯度並呼叫 API
                // 為了不讓程式碼太複雜，這裡建議使用者先選擇一天行程，或是我們直接顯示提示
                if (!navigator.geolocation) { alert("無法取得詳細資訊"); return; }

                navigator.geolocation.getCurrentPosition(pos => {
                    fetchAndShowDetail(pos.coords.latitude, pos.coords.longitude, myData.city);
                });
                return;
            }

            if (!config) {
                alert("請先選擇一天行程，或等待定位完成。");
                return;
            }

            // 2. 呼叫 API 並顯示
            fetchAndShowDetail(config.lat, config.lon, config.loc);
        }

        // [修改] 抓取詳細天氣資料 (加入漸層圖示邏輯)
        // [修改] 抓取詳細天氣資料 (修正：現在標籤、日夜判斷、標準圖示)
        async function fetchAndShowDetail(lat, lon, locName) {
            // 顯示 Loading
            document.getElementById('weather-detail-modal').style.display = 'flex';
            document.getElementById('wd-title').innerText = locName;
            // [新增] 設定重整按鈕的功能 (點擊後重新執行此函式)
            document.getElementById('wd-btn-refresh').onclick = function () {
                // 加入簡單的旋轉動畫效果，讓使用者知道有在跑
                const icon = this.querySelector('svg');
                if (icon) {
                    icon.style.transition = 'transform 0.5s';
                    icon.style.transform = 'rotate(360deg)';
                    setTimeout(() => { icon.style.transform = 'none'; }, 500);
                }
                // 重新抓取資料
                fetchAndShowDetail(lat, lon, locName);
            };
            // 初始化儀表板數值
            document.getElementById('wd-cur-temp').innerText = '--°';
            document.getElementById('wd-cur-desc').innerText = '載入中...';
            document.getElementById('wd-feel').innerText = '--';
            document.getElementById('wd-pop').innerText = '--';
            document.getElementById('wd-uv').innerText = '--';
            document.getElementById('wd-wind').innerText = '--';

            document.getElementById('wd-hourly-list').innerHTML = '<div style="padding:10px;">資料載入中...</div>';
            document.getElementById('wd-daily-list').innerHTML = '';

            try {
                // [關鍵修改] URL 新增 hourly 參數: apparent_temperature (體感), uv_index (紫外線), wind_speed_10m (風速)
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,weathercode,precipitation_probability,apparent_temperature,uv_index,wind_speed_10m&daily=weathercode,temperature_2m_max,temperature_2m_min,sunrise,sunset,precipitation_probability_max&current_weather=true&timezone=auto`;

                const res = await fetch(url);
                const data = await res.json();

                // --- 0. 處理時間索引 (修正：使用當地的 current_weather 時間) ---
                // Open-Meteo 的 current_weather.time 回傳的是當地的 ISO 時間 (例如 "2026-01-27T11:00")
                const localTimeStr = data.current_weather.time;

                // 直接在 hourly 列表中尋找這個時間字串，就能精準對應到當地的「現在」
                let startIdx = data.hourly.time.indexOf(localTimeStr);

                // 防呆：如果剛好沒對到 (極少見)，則預設從 0 開始
                if (startIdx === -1) {
                    // 嘗試只比對 "YYYY-MM-DDTHH" (前13碼)，忽略分鐘差異
                    const hourStr = localTimeStr.substring(0, 13);
                    startIdx = data.hourly.time.findIndex(t => t.startsWith(hourStr));
                }

                if (startIdx === -1) startIdx = 0;

                // --- 1. 更新上方儀表板 (Dashboard) ---
                // 使用目前這小時的詳細數據
                const curTemp = Math.round(data.current_weather.temperature);
                const curCode = data.current_weather.weathercode;
                const curFeel = Math.round(data.hourly.apparent_temperature[startIdx]);
                const curPop = data.hourly.precipitation_probability[startIdx];
                const curUv = data.hourly.uv_index[startIdx];
                const curWind = Math.round(data.hourly.wind_speed_10m[startIdx]);

                const todayMax = Math.round(data.daily.temperature_2m_max[0]);
                const todayMin = Math.round(data.daily.temperature_2m_min[0]);

                document.getElementById('wd-cur-temp').innerText = `${curTemp}°`;
                document.getElementById('wd-cur-desc').innerText = getWeatherDescText(curCode); // 使用既有的文字轉換函式
                document.getElementById('wd-cur-hl').innerText = `高:${todayMax}° 低:${todayMin}°`;

                document.getElementById('wd-feel').innerText = `${curFeel}°`;
                document.getElementById('wd-pop').innerText = `${curPop}%`;
                document.getElementById('wd-uv').innerText = curUv;
                document.getElementById('wd-wind').innerText = `${curWind} km/h`;


                // --- 2. 更新日出日落 ---
                const todayIndex = 0;
                const sunriseStr = data.daily.sunrise[todayIndex].split('T')[1];
                const sunsetStr = data.daily.sunset[todayIndex].split('T')[1];
                const sunriseHour = parseInt(sunriseStr.split(':')[0]);
                const sunsetHour = parseInt(sunsetStr.split(':')[0]);

                document.getElementById('wd-sunrise').innerText = sunriseStr;
                document.getElementById('wd-sunset').innerText = sunsetStr;
                // --- [新增] 2.5 更新右側：溫差比對與穿衣建議 ---

                // A. 溫差比對
                const diffBadge = document.getElementById('wd-diff-badge');
                // currentMyTemp 是全域變數，若有定位成功會有數值
                if (typeof currentMyTemp !== 'undefined' && currentMyTemp !== null) {
                    const diff = curTemp - currentMyTemp;
                    diffBadge.style.display = 'inline-flex';

                    if (Math.abs(diff) < 2) {
                        // 溫差小於 2 度，不顯示差異，或顯示差不多
                        diffBadge.style.display = 'none';
                    } else if (diff > 0) {
                        diffBadge.className = 'diff-badge diff-hot';
                        diffBadge.innerHTML = `氣溫比目前高 ${diff.toFixed(1)}°C`;
                    } else {
                        diffBadge.className = 'diff-badge diff-cold';
                        diffBadge.innerHTML = `氣溫比目前低 ${Math.abs(diff).toFixed(1)}°C`;
                    }
                } else {
                    diffBadge.style.display = 'none'; // 無定位資料時隱藏
                }

                // B. 穿衣建議 (重複利用您既有的智慧建議函式)
                // getSmartAdviceText(溫度, 天氣代碼) 是您程式碼中已經存在的函式
                const smartAdvice = getSmartAdviceText(curTemp, curCode);
                document.getElementById('wd-advice-text').innerText = smartAdvice;

                // --- 3. 渲染 24小時預報 (維持不變) ---
                const hourlyContainer = document.getElementById('wd-hourly-list');
                hourlyContainer.innerHTML = '';

                for (let i = startIdx; i < startIdx + 24; i++) {
                    if (!data.hourly.time[i]) break;

                    let hourRaw = parseInt(data.hourly.time[i].split('T')[1].split(':')[0]);
                    let timeStr = (i === startIdx) ? "現在" : `${hourRaw}時`;
                    let isNight = (hourRaw < sunriseHour || hourRaw >= sunsetHour);
                    const temp = Math.round(data.hourly.temperature_2m[i]);
                    const code = data.hourly.weathercode[i];

                    const iconSvg = getSimpleIconSvg(code, 0, `h${i}`, isNight);
                    const statusText = getWeatherStatusText(code);

                    const item = document.createElement('div');
                    item.className = 'wd-hour-item';

                    item.innerHTML = `
                <div class="wd-hour-time" style="${i === startIdx ? 'font-weight:bold; color:#2563EB;' : ''}">${timeStr}</div>
                <div class="wd-hour-icon">${iconSvg}</div>
                <div class="wd-hour-desc">${statusText}</div>
                <div class="wd-hour-temp">${temp}°</div>
            `;
                    hourlyContainer.appendChild(item);
                }

                // --- 4. 渲染未來 7 天預報 (紅線絕對防禦版：Gap 硬性隔離) ---
                const dailyContainer = document.getElementById('wd-daily-list');
                dailyContainer.innerHTML = '';

                const weeklyMaxVals = data.daily.temperature_2m_max.slice(0, 7);
                const weeklyMinVals = data.daily.temperature_2m_min.slice(0, 7);
                const globalMax = Math.max(...weeklyMaxVals);
                const globalMin = Math.min(...weeklyMinVals);
                const globalRange = globalMax - globalMin || 1;

                for (let i = 0; i < 7; i++) {
                    const max = Math.round(data.daily.temperature_2m_max[i]);
                    const min = Math.round(data.daily.temperature_2m_min[i]);
                    const code = data.daily.weathercode[i];
                    const popMax = data.daily.precipitation_probability_max[i];
                    const iconSvg = getSimpleIconSvg(code, popMax, `d${i}`, false);

                    const dateObj = new Date(data.daily.time[i]);
                    const dayNames = ["週日", "週一", "週二", "週三", "週四", "週五", "週六"];
                    const dayName = dayNames[dateObj.getDay()];

                    const leftPercent = ((min - globalMin) / globalRange) * 100;
                    const widthPercent = ((max - min) / globalRange) * 100;

                    let dotHtml = '';
                    if (i === 0) {
                        const currentT = data.current_weather.temperature;
                        const dotPercent = ((currentT - globalMin) / globalRange) * 100;
                        dotHtml = `
                        <div style="
                            position: absolute;
                            left: ${dotPercent}%;
                            top: 50%;
                            transform: translate(-50%, -50%);
                            width: 10px;
                            height: 10px;
                            background: #FFFFFF;
                            border: 2px solid #374151;
                            border-radius: 50%;
                            box-shadow: 0 0 3px rgba(0,0,0,0.3);
                            z-index: 10;
                        "></div>
                    `;
                    }

                    const row = document.createElement('div');
                    row.className = 'wd-daily-row';

                    // [最終解決方案]
                    // 1. gap: 15px; -> 這就是您的紅線。
                    //    這是 Grid 系統的強制間距，任何元素都無法進入這 15px 的範圍。
                    // 2. 色條欄位寬度: 80px; -> 將色條限制在中間較窄的區域。
                    row.style.cssText = `
                    display: grid;
                    grid-template-columns: 45px 85px 1fr 30px 80px 30px;
                    align-items: center;
                    gap: 15px; 
                    padding: 8px 0;
                    border-bottom: 1px solid #f0f0f0;
                `;

                    row.innerHTML = `
                    <div style="text-align:center;">
                        <div style="font-weight:700; font-size:0.9rem; color:#374151;">${i === 0 ? '今天' : dayName}</div>
                    </div>

                    <div style="display:flex; flex-direction:row; align-items:center; justify-content:flex-start; gap: 12px;">
                        <div style="width:30px; height:30px; flex-shrink:0;">${iconSvg}</div>
                        ${popMax > 0 ? `<div style="font-size:0.8rem; color:#60A5FA; font-weight:700; white-space:nowrap;">${popMax}%</div>` : ''}
                    </div>
                    
                    <div></div>

                    <div style="text-align:right; font-family:monospace; font-weight:600; color:#9CA3AF; font-size:0.95rem;">${min}°</div>

                    <div style="height: 6px; position: relative; width: 100%;">
                        <div style="
                            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                            background: #E5E7EB; 
                            border-radius: 10px; 
                            overflow: hidden; /* ★關鍵：這裡負責切掉跑出去的色條 */
                        ">
                            <div style="
                                position: absolute;
                                top: 0;
                                bottom: 0;
                                left: ${leftPercent}%;
                                width: ${widthPercent}%;
                                min-width: 6px;
                                border-radius: 10px;
                                background: linear-gradient(90deg, #22D3EE, #34D399, #FBBF24, #FB923C, #F87171);
                                opacity: 0.9;
                            "></div>
                        </div>
                        
                        ${dotHtml}
                    </div>

                    <div style="text-align:left; font-family:monospace; font-weight:600; color:#374151; font-size:0.95rem;">${max}°</div>
                `;
                    dailyContainer.appendChild(row);
                }

            } catch (e) {
                console.error(e);
                document.getElementById('wd-hourly-list').innerHTML = '無法取得詳細資料';
                alert('獲取天氣詳情失敗，請檢查網路。');
            }
        }

        // [修改] 取得標準天氣 SVG 圖示
        // pop: 降雨機率 (決定水位，若為0則純線條)
        // isNight: 是否為晚上 (決定顯示太陽還是月亮)
        // [修改] 最終完整版：整合太陽光芒切換、藍色雨滴、雷雨雙閃電
        // [修正] 最終除錯版：修復雷雨被誤判為雨天(Code 80+)的問題
        // [修改] 最終版：加入「霧」的水位計支援 + 所有修復
        // [修改] 最終美化版：加入精緻「六角雪花」造型 + 完整功能
        // [修改] 最終完成版：嚴格幾何對稱雪花 + 全局水位計 (由下而上平整填滿)
        function getSimpleIconSvg(code, pop, uid, isNight = false) {
            const originalColor = "#374151";
            const waterColor = "#60A5FA";
            const percentage = pop || 0;

            // 1. 定義漸層 (修改為 userSpaceOnUse 模式)
            let defs = '';
            let strokeAttr = `stroke="${originalColor}"`;

            if (percentage > 0) {
                defs = `
        <defs>
            <linearGradient id="grad-${uid}" x1="0" y1="24" x2="0" y2="0" gradientUnits="userSpaceOnUse">
                <stop offset="${percentage}%" stop-color="${waterColor}" />
                <stop offset="${percentage}%" stop-color="${originalColor}" />
            </linearGradient>
        </defs>`;
                strokeAttr = `stroke="url(#grad-${uid})"`;
            }

            const commonAttr = `viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" ${strokeAttr}`;

            let path = '';

            // 2. 圖示繪製邏輯
            if (code === 0 || code === 1) {
                // === 晴朗 ===
                if (isNight) {
                    path = `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>`;
                } else {
                    // 太陽
                    if (percentage > 0) {
                        path = `<circle cx="12" cy="12" r="5"></circle>`;
                        // 太陽光芒維持純色，不參與水位漸層
                        const rayStyle = `stroke="${originalColor}"`;
                        path += `
                    <line x1="12" y1="1" x2="12" y2="4" ${rayStyle}></line>
                    <line x1="12" y1="1" x2="12" y2="4" transform="rotate(60 12 12)" ${rayStyle}></line>
                    <line x1="12" y1="1" x2="12" y2="4" transform="rotate(120 12 12)" ${rayStyle}></line>
                    <line x1="12" y1="1" x2="12" y2="4" transform="rotate(180 12 12)" ${rayStyle}></line>
                    <line x1="12" y1="1" x2="12" y2="4" transform="rotate(240 12 12)" ${rayStyle}></line>
                    <line x1="12" y1="1" x2="12" y2="4" transform="rotate(300 12 12)" ${rayStyle}></line>
                `;
                    } else {
                        path = `
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                `;
                    }
                }
            } else if (code === 2 || code === 3) {
                // === 多雲 ===
                path = `<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>`;
            } else if (code >= 45 && code <= 48) {
                // === 霧 ===
                path = `<path d="M4 10h16 M4 14h16 M4 18h16"></path>`;
            } else if ((code >= 51 && code <= 67) || (code >= 80 && code <= 82)) {
                // === 雨 ===
                path = `
            <line x1="16" y1="13" x2="16" y2="21" stroke="${waterColor}"></line>
            <line x1="8" y1="13" x2="8" y2="21" stroke="${waterColor}"></line>
            <line x1="12" y1="15" x2="12" y2="23" stroke="${waterColor}"></line>
            <path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"></path>
        `;
            } else if ((code >= 71 && code <= 77) || (code >= 85 && code <= 86)) {
                // === 雪：嚴格幾何對稱版 + 全局水位計 ===

                // 1. 中央六角冰核 (R=3)
                path = `<path d="M12 9 L14.6 10.5 L14.6 13.5 L12 15 L9.4 13.5 L9.4 10.5 Z"></path>`;

                // 2. 六條直線主幹 (R=3 到 R=11)
                path += `
            <path d="M12 9 V1 M12 15 V23"></path> <path d="M14.6 10.5 L21.5 6.5 M14.6 13.5 L21.5 17.5"></path> <path d="M9.4 13.5 L2.5 17.5 M9.4 10.5 L2.5 6.5"></path>     `;

                // 3. V 型結構 (幾何對稱複製)
                // --- 上 (0度) ---
                path += `<path d="M9.5 5.5 L12 7.5 L14.5 5.5"></path>`;
                path += `<path d="M9.5 2 L12 4 L14.5 2"></path>`;

                // --- 下 (180度) ---
                path += `<path d="M9.5 18.5 L12 16.5 L14.5 18.5"></path>`;
                path += `<path d="M9.5 22 L12 20 L14.5 22"></path>`;

                // --- 右上 (60度) ---
                path += `<path d="M16.4 6.6 L15.9 9.75 L18.9 10.9"></path>`;
                path += `<path d="M19.4 4.8 L18.9 8 L21.9 9.2"></path>`;

                // --- 右下 (120度) ---
                path += `<path d="M18.9 13.1 L15.9 14.25 L16.4 17.4"></path>`;
                path += `<path d="M21.9 14.8 L18.9 16 L19.4 19.2"></path>`;

                // --- 左下 (240度) ---
                path += `<path d="M7.6 17.4 L8.1 14.25 L5.1 13.1"></path>`;
                path += `<path d="M4.6 19.2 L5.1 16 L2.1 14.8"></path>`;

                // --- 左上 (300度) ---
                path += `<path d="M5.1 10.9 L8.1 9.75 L7.6 6.6"></path>`;
                path += `<path d="M2.1 9.2 L5.1 8 L4.6 4.8"></path>`;

            } else if (code >= 95) {
                // === 雷雨 ===
                path = `<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>`;
                /*path += `<polygon points="19 2 16 7 18 7 17 11 22 5 20 5 19 2"></polygon>`;*/
            } else {
                path = `<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>`;
            }

            return `<svg ${commonAttr}>${defs}${path}</svg>`;
        }
        // A. 切換輸入模式
        function toggleLedgerInput() {
            const type = document.getElementById('ledger-type').value;
            document.getElementById('ledger-finance-fields').style.display = type === 'finance' ? 'block' : 'none';
            document.getElementById('ledger-note-fields').style.display = type === 'note' ? 'block' : 'none';
        }

        // [開始] 替換身分定義相關邏輯
        const AVATAR_OPTIONS = [
            '🦁', '🐰', '🐼', '🐨', '🦊', '🐱', '🐶', '🐯', '🐵', '🐷',
            '🐹', '🐻', '🐮', '🐸', '🐔', '🐧', '🦄', '🐙', '🦖', '🐬'
        ];

        // [已修正] 初始化頭像選擇器 (內建淨水器功能)
        function initAvatarSelector() {
            const container = document.getElementById('avatar-list');
            if (!container) return;

            // ★★★ 關鍵修正 1：讀取並清洗髒資料 ★★★
            let safeName = '爸爸'; // 預設值
            const cachedName = localStorage.getItem('last_user_name');

            if (cachedName) {
                const raw = cachedName.trim();
                // 檢查：如果讀出來的資料像 JSON (以 { 開頭)，代表是髒資料
                if (raw.startsWith('{')) {
                    try {
                        const parsed = JSON.parse(raw);
                        // 嘗試救回真正的名字 (排除 undefined 或遞迴 JSON)
                        if (parsed.name && !parsed.name.startsWith('{')) {
                            safeName = parsed.name;
                        } else {
                            safeName = '匿名'; // 救不回來就重置
                        }
                    } catch (e) {
                        safeName = '爸爸'; // 解析失敗用預設值
                    }
                } else if (raw !== 'undefined' && raw !== 'null') {
                    // 如果是乾淨的純文字，直接用
                    safeName = raw;
                }
            }
            // ★★★ 修正結束 ★★★

            const lastEmoji = localStorage.getItem('last_user_emoji') || '🦁';

            // 將清洗過的名字填入介面
            const nameInput = document.getElementById('custom-user-name');
            if (nameInput) {
                nameInput.value = safeName;
                // 同步更新全域防禦變數 (配合 handleLedgerSubmit)
                if (window.TEMP_USER_NAME !== undefined) window.TEMP_USER_NAME = safeName;
            }

            document.getElementById('current-selected-emoji').innerText = lastEmoji;

            // 動態生成頭像列 (保持不變)
            container.innerHTML = AVATAR_OPTIONS.map((emoji) => `
        <div class="avatar-item ${emoji === lastEmoji ? 'active' : ''}" 
             onclick="selectAvatar('${emoji}', this)"
             style="font-size: 1.8rem; cursor: pointer; padding: 10px; border-radius: 50%; border: 2px solid transparent; background: #f8fafc; flex-shrink: 0; transition: 0.2s; line-height: 1;">
            ${emoji}
        </div>
    `).join('');

            // 更新隱藏欄位
            updateUserInfoFromUI();
        }

        function selectAvatar(emoji, el) {
            document.getElementById('current-selected-emoji').innerText = emoji;
            document.querySelectorAll('.avatar-item').forEach(item => {
                item.style.borderColor = 'transparent';
                item.style.background = '#f8fafc';
            });
            el.style.borderColor = '#2563EB';
            el.style.background = '#EFF6FF';

            updateUserInfoFromUI();
            localStorage.setItem('last_user_emoji', emoji);
        }

        // [已修正] 更新使用者資訊 (防止髒資料寫入快取)
        function updateUserInfoFromUI() {
            const nameInput = document.getElementById('custom-user-name');
            let name = nameInput ? nameInput.value : '匿名';

            // ★★★ 關鍵修正 2：寫入前的最後防線 ★★★
            // 如果名字看起來像 JSON (以 { 開頭) 或包含 avatar 關鍵字，強制重置
            if (name && (name.trim().startsWith('{') || name.includes('"avatar"') || name.includes('avatar":'))) {
                console.warn('⚠️ 攔截到髒資料，強制修正為匿名');
                name = '匿名';
                // 同步修正介面，讓使用者看到乾淨的名字
                if (nameInput) nameInput.value = '匿名';
            }

            // 防呆
            if (!name || name === 'undefined' || name === 'null') {
                name = '匿名';
            }
            // ★★★ 修正結束 ★★★

            const avatar = document.getElementById('current-selected-emoji').innerText;

            // 更新隱藏欄位 (這是給程式看的，沒關係)
            const infoEl = document.getElementById('selected-user-info');
            if (infoEl) {
                infoEl.value = JSON.stringify({ name: name, avatar: avatar });
            }

            // ★ 關鍵：只存入「乾淨的純文字」到快取
            localStorage.setItem('last_user_name', name);

            // [新增] 同步更新 "個人" 選項的顯示名稱
            const privateOptions = document.querySelectorAll('#ledger-pay-type option[value="private"], #bill-scan-pay-type option[value="private"]');
            privateOptions.forEach(opt => {
                opt.innerText = name || '個人';
            });

            // 更新全域變數 (配合 handleLedgerSubmit)
            window.TEMP_USER_NAME = name;
        }
        // [結束] 替換身分定義相關邏輯

        // [最終淨化版] 處理記帳送出 (徹底防止資料污染 + 按鈕回饋優化)
        async function handleLedgerSubmit() {
            // 判斷是否為記帳模式 (決定要用哪種 Loading 方式)
            const isFinance = (document.getElementById('ledger-type')?.value === 'finance') ||
                (document.getElementById('ledger-finance-fields').style.display !== 'none');

            // 取得按鈕
            let activeBtn;
            if (isFinance) {
                activeBtn = document.querySelector('#ledger-finance-fields .btn-submit-ledger');
            } else {
                activeBtn = document.querySelector('#ledger-note-fields .btn-submit-ledger');
            }

            // 備份原始圖示 (紙飛機 + 文字)
            // let originalContent = activeBtn ? activeBtn.innerHTML : '';
            // 改為：不管原本是什麼，我們都預期恢復成標準的「紙飛機」圖示 (因為 Edit 模式會把圖示改成打勾，submit 完要變回紙飛機)
            const originalIconSVG = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${isFinance ? '#F97316' : '#2563EB'}"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>`;

            // 如果是純圖示（Finance），就恢復純圖示；如果是文字+圖示（Note），就恢復文字+圖示

            if (activeBtn) {
                // 使用按鈕內 Loading (橘色轉圈圈)
                activeBtn.disabled = true;
                activeBtn.innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#F59E0B" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="animation: spin 1s linear infinite;">
                    <style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>
                    <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
                </svg>`;
            } else {
                showGlobalLoading();
            }

            console.log("【執行版本：v2026-CLEAN-FLOW + UX回饋】");

            try {
                // ============================================================
                // 1. 抓取使用者資料 (多重來源 + 髒資料清洗)
                // ============================================================
                // 來源 A: 優先讀取 LocalStorage
                let userName = localStorage.getItem('last_user_name');
                if (!userName && window.TEMP_USER_NAME) userName = window.TEMP_USER_NAME.trim();

                // 來源 C: 最後嘗試 DOM
                if (!userName) {
                    const el = document.getElementById('custom-user-name') || document.querySelector('.user-name-input');
                    if (el) userName = el.value.trim();
                }

                // ★★★ 核心淨化邏輯 ★★★
                if (userName.startsWith('{') || userName.includes('"avatar"') || userName.includes('avatar":')) {
                    console.warn("⚠️ 攔截到受汙染的資料！已自動修復。");
                    userName = '匿名';
                    const el = document.getElementById('custom-user-name');
                    if (el) el.value = '';
                    window.TEMP_USER_NAME = '';
                }

                if (!userName || userName === 'undefined' || userName === 'null') userName = '匿名';

                let userAvatar = localStorage.getItem('last_user_emoji') || '🦁';

                // ============================================================
                // 2. 準備 Payload
                // ============================================================
                let finalRate = 0.21;
                const manualRateEl = document.getElementById('calc-rate');
                if (manualRateEl && parseFloat(manualRateEl.value) > 0) {
                    finalRate = parseFloat(manualRateEl.value);
                } else {
                    try {
                        const cached = localStorage.getItem('live_exchange_rate_cache');
                        if (cached) {
                            const parsed = JSON.parse(cached);
                            if (parsed.rate > 0) finalRate = parsed.rate;
                        }
                    } catch (e) { }
                }

                const rawAmount = document.getElementById('ledger-amount').value;
                const amountJpy = parseFloat(rawAmount) || 0;
                const amountTwd = amountJpy > 0 ? Math.round(amountJpy * finalRate) : 0;
                const finalAmountJpy = isFinance ? String(amountJpy) : "0";
                const finalAmountTwd = isFinance ? String(amountTwd) : "0";

                const payloadData = {
                    action: window.editingId ? 'edit' : 'upload',
                    token: (typeof getKey === 'function') ? getKey('gas_token') : '',
                    type: isFinance ? 'finance' : 'note',
                    id: window.editingId ? window.editingId : ((window.crypto && window.crypto.randomUUID) ? window.crypto.randomUUID() : ('id-' + Date.now())),
                    userName: userName,
                    userAvatar: userAvatar,
                    // [修改] 統一日期邏輯 (Finance 也可以選日期)
                    date: (() => {
                        const el = isFinance ? document.getElementById('ledger-date') : document.getElementById('ledger-note-date');
                        // 優先使用 ISO 值 (因為顯示值可能是 2026/2/4)
                        return el ? (el.dataset.isoValue || el.value) : new Date().toISOString().split('T')[0];
                    })(),
                    timestamp: (() => {
                        try {
                            const dateEl = isFinance ? document.getElementById('ledger-date') : document.getElementById('ledger-note-date');
                            if (dateEl) {
                                const dVal = dateEl.dataset.isoValue || dateEl.value; // YYYY-MM-DD
                                if (dVal) {
                                    // 支援兩種分隔符
                                    let y, m, d;
                                    if (dVal.includes('/')) {
                                        [y, m, d] = dVal.split('/').map(Number);
                                    } else {
                                        [y, m, d] = dVal.split('-').map(Number);
                                    }
                                    const now = new Date();
                                    const combined = new Date(y, m - 1, d, now.getHours(), now.getMinutes(), now.getSeconds());
                                    return combined.toISOString();
                                }
                            }
                        } catch (e) {
                            console.warn("Date construction error, fallback to now:", e);
                        }
                        return new Date().toISOString();
                    })(),
                    rate: String(finalRate),
                    twdAmount: finalAmountTwd,
                    twdAmount: finalAmountTwd,
                    item: isFinance ? (document.getElementById('ledger-item')?.value || '') : (() => {
                        let content = document.getElementById('ledger-note-content')?.value || '';
                        // 先移除舊標記，避免重複
                        content = content.replace(/\[公告\]\s*|#公告\s*/g, '');
                        // 若模式開啟則加回去
                        if (isAnnouncementMode) content = '[公告] ' + content;
                        return content;
                    })(),
                    content: isFinance ? (document.getElementById('ledger-item')?.value || '') : (() => {
                        let content = document.getElementById('ledger-note-content')?.value || '';
                        // 先移除舊標記，避免重複
                        content = content.replace(/\[公告\]\s*|#公告\s*/g, '');
                        // 若模式開啟則加回去
                        if (isAnnouncementMode) content = '[公告] ' + content;
                        return content;
                    })(),
                    amount: finalAmountJpy,
                    amount: finalAmountJpy,
                    // [新增] 付款方式
                    paymentMethod: isFinance ? (document.getElementById('ledger-payment-method')?.value || 'cash') : '',
                    // [新增] 支付者類型 (Public or UserName)
                    paymentType: isFinance ? (document.getElementById('ledger-pay-type')?.value === 'public' ? 'Public' : userName) : '',
                    // [新增] 加入圖片欄位 (Array of Base64 or URLs)
                    images: window.currentNoteImages || []
                };

                // ============================================================
                // 3. 發送請求
                // ============================================================
                const url = (typeof getKey === 'function') ? getKey('gas_url') : '';
                const resp = await fetch(url, { method: 'POST', body: JSON.stringify(payloadData) });
                const result = await resp.json();

                if (result.status === 'success' || result.result === 'success') {
                    // 清空輸入
                    document.getElementById('ledger-item').value = '';
                    document.getElementById('ledger-amount').value = '';
                    document.getElementById('ledger-note-content').value = '';

                    // [新增] 重置日期為今天 (Finance & Note)
                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    const todayStr = `${yyyy}-${mm}-${dd}`;

                    const noteDate = document.getElementById('ledger-note-date');
                    if (noteDate) {
                        noteDate.type = 'date';
                        noteDate.value = todayStr;
                        noteDate.dataset.isoValue = todayStr; // [關鍵] 強制覆寫緩存為今天
                        if (typeof formatCompactDate === 'function') formatCompactDate(noteDate);
                    }

                    const finDate = document.getElementById('ledger-date');
                    if (finDate) {
                        finDate.type = 'date';
                        finDate.value = todayStr;
                        finDate.dataset.isoValue = todayStr; // [關鍵] 強制覆寫緩存為今天
                        if (typeof formatCompactDate === 'function') formatCompactDate(finDate);
                    }

                    // [新增] 重置付款方式
                    const payMethod = document.getElementById('ledger-payment-method');
                    if (payMethod) payMethod.value = 'cash';

                    // [修正] 清空圖片暫存與預覽
                    window.currentNoteImages = [];
                    renderImagePreviews();

                    // [修正] 先判斷是否為編輯模式 (因為下面 exitEditMode 會清空 window.editingId)
                    const wasEditing = !!window.editingId;

                    if (window.editingId) {
                        try {
                            exitEditMode(); // [新增] 成功送出後，呼叫取消模式來復原 UI
                        } catch (e) {
                            console.error("Exit edit mode error:", e);
                            window.editingId = null;
                        }
                    }

                    // [回饋顯示邏輯]
                    // [回饋顯示邏輯]
                    if (activeBtn) {
                        // 顯示橘色 OK (編輯) 或 綠色 OK (新增)
                        const okColor = wasEditing ? '#F97316' : '#10B981';

                        // [修正] 強制設定按鈕樣式，不受 validation 影響
                        activeBtn.style.opacity = '1';
                        activeBtn.style.filter = 'none';
                        // 雖然 disable=true (因為清空輸入)，但視覺上我們要它是亮色的
                        // 這裡可以設 disabled=false 以免有些 CSS selector 影響
                        activeBtn.disabled = false;

                        activeBtn.innerHTML = `<span style="color:${okColor}; font-weight:900; font-size:1.2rem;">OK</span>`;
                        // 1.5秒後還原
                        setTimeout(() => {
                            if (activeBtn) {
                                // 還原回紙飛機
                                activeBtn.innerHTML = originalIconSVG;
                                // 修正顏色：Finance 用橘色，Note 用藍色
                                // activeBtn.querySelector('svg').style.stroke = isFinance ? '#F97316' : '#2563EB'; 
                                activeBtn.disabled = false;
                            }
                            // [修正] 等到還原圖示後，才去檢查狀態 (這時 input 是空的，會變灰)
                            updateLedgerSubmitState();
                            // [修正] 成功後重置公告狀態與 Placeholder
                            if (typeof setAnnouncementMode === 'function') {
                                setAnnouncementMode(false);
                            } else {
                                if (typeof updatePinButtonState === 'function') updatePinButtonState();
                            }
                        }, 1500);
                    } else {
                        alert(`✅ 儲存成功！`);
                        updateLedgerSubmitState();
                    }

                    if (typeof syncLedgerData === 'function') await syncLedgerData();
                } else {
                    throw new Error(result.message || "未知錯誤");
                }

                // [修正] 移除這裡的 updateLedgerSubmitState，改成在 setTimeout 裡做
                // updateLedgerSubmitState();

            } catch (e) {
                console.error("執行錯誤:", e);
                // 失敗回饋
                // 失敗回饋
                if (activeBtn) {
                    // 顯示紅色 NG
                    activeBtn.innerHTML = `<span style="color:#EF4444; font-weight:900; font-size:1.2rem;">NG</span>`;
                    setTimeout(() => {
                        if (activeBtn) {
                            // 還原回紙飛機 (即使失敗也還原，不保留 Edit 打勾狀態，讓使用者重新嘗試會比較清楚)
                            // 或者保留打勾？通常失敗後保持原狀比較好，但這裡為了簡單邏輯，先還原成紙飛機(視為重置)
                            // 不，用戶說「失敗顯示NG」，那NG完應該變回原本的樣子 (如果是 Edit 模式，原本是打勾)
                            // 但這裡我們簡化：NG 完變回紙飛機，因為資料可能沒送出，
                            // 修正：如果 window.editingId 還在，應該變回打勾？ 
                            // 暫時統一變回紙飛機，因為失敗通常需要重新檢查
                            activeBtn.innerHTML = originalIconSVG;
                            activeBtn.disabled = false;
                        }
                    }, 2000);
                } else {
                    alert("❌ 錯誤: " + e.message);
                }
            } finally {
                if (!isFinance) hideGlobalLoading();
            }
        }

        // C. 抓取並渲染列表 (依據 backend.gs 的 getAll)
        // A. 新增切換視圖函式
        function filterLedgerView(type) {
            currentLedgerFilter = type;

            // 更新按鈕透明度（讓使用者知道目前選中哪個）
            const btnFinance = document.getElementById('btn-view-finance');
            const btnNote = document.getElementById('btn-view-note');
            if (btnFinance) btnFinance.style.opacity = type === 'finance' ? '1' : '0.4';
            if (btnNote) btnNote.style.opacity = type === 'note' ? '1' : '0.4';

            // 切換輸入區域顯示
            const finFields = document.getElementById('ledger-finance-fields');
            const noteFields = document.getElementById('ledger-note-fields');
            if (finFields) finFields.style.display = type === 'finance' ? 'block' : 'none';
            if (noteFields) noteFields.style.display = type === 'note' ? 'block' : 'none';

            // 切換標題文字
            const title = document.getElementById('ledger-view-title');
            if (title) title.innerText = type === 'finance' ? '公費總支出 (JPY)' : '記事總數';

            // 重新渲染清單
            renderLedgerList(rawLedgerData);

            // [新增] 切換視圖時同步更新檢查按鈕狀態
            updateLedgerSubmitState();
        }

        // [新增] 確保全域變數存在 (解決 Delete/Edit 找不到資料的問題)
        window.rawLedgerData = [];

        // [新增] 通知功能相關邏輯 (含切換與狀態保存)
        const NOTIFY_KEY = 'ledger_notify_enabled';
        let pollingInterval = null;

        // 初始化：檢查設定並更新 UI
        function initNotificationState() {
            const isEnabled = localStorage.getItem(NOTIFY_KEY) === 'true';
            updateNotificationUI(isEnabled);

            // 如果原本是開啟且有權限，就開始輪詢
            if (isEnabled && "Notification" in window && Notification.permission === "granted") {
                startLedgerPolling();
            }
        }

        // 更新按鈕外觀
        function updateNotificationUI(isEnabled) {
            const btn = document.getElementById('btn-notify-toggle');
            if (!btn) return;

            const textSpan = btn.querySelector('span');
            const iconSvg = btn.querySelector('svg');

            if (isEnabled) {
                // 開啟狀態 -> 顯示「關閉通知」選項
                textSpan.innerText = '關閉新記事通知';
                textSpan.style.color = '#EF4444'; // 紅色
                // 鈴鐺加個斜線 (或者維持鈴鐺但變色) -> 用簡單的劃掉圖示
                // 這裡簡單換成紅色的鈴鐺
                btn.style.color = '#EF4444';
                // iconSvg path 可以不變，只變顏色
            } else {
                // 關閉狀態 -> 顯示「開啟通知」選項
                textSpan.innerText = '開啟新記事通知';
                textSpan.style.color = '#2563EB'; // 藍色
                btn.style.color = '#2563EB';
            }
        }

        // 切換開關 (綁定在按鈕上)
        function toggleNotification() {
            if (!("Notification" in window)) {
                alert("瀏覽器不支援通知功能。");
                return;
            }

            const currentState = localStorage.getItem(NOTIFY_KEY) === 'true';

            if (currentState) {
                // 執行關閉
                localStorage.setItem(NOTIFY_KEY, 'false');
                stopLedgerPolling();
                updateNotificationUI(false);
                alert("已關閉通知。");
            } else {
                // 執行開啟
                if (Notification.permission === "granted") {
                    enableNotification();
                } else if (Notification.permission !== "denied") {
                    Notification.requestPermission().then(permission => {
                        if (permission === "granted") {
                            enableNotification();
                        } else {
                            alert("您已拒絕通知權限。");
                        }
                    });
                } else {
                    alert("通知權限已被封鎖，請至瀏覽器設定開啟。");
                }
            }
        }

        function enableNotification() {
            localStorage.setItem(NOTIFY_KEY, 'true');
            startLedgerPolling();
            updateNotificationUI(true);
            alert("通知已開啟！每 60 秒檢查一次新記事。");
            // 立即同步一次
            syncLedgerData(true);
        }

        function startLedgerPolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            console.log("[Polling] Started (60s interval)");
            pollingInterval = setInterval(() => {
                syncLedgerData(true);
            }, 60000);
        }

        function stopLedgerPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                console.log("[Polling] Stopped");
            }
        }

        // [新增] 檢查並發送通知
        function checkAndNotifyNewNotes(oldData, newData) {
            // 雙重確認：只有在開啟狀態才通知
            if (localStorage.getItem(NOTIFY_KEY) !== 'true') return;

            if (!oldData || oldData.length === 0) return; // 第一次載入不通知

            const currentUserName = localStorage.getItem('last_user_name');
            const oldIds = new Set(oldData.map(i => i.id || i.timestamp));

            newData.forEach(item => {
                // 只通知 Note 類型
                if (item.type !== 'note') return;

                const itemId = item.id || item.timestamp;
                // 如果是新項目 (不在舊清單中)
                if (!oldIds.has(itemId)) {
                    // 解析作者與頭像
                    let author = '有人';
                    let avatar = '👤'; // 預設頭像

                    try {
                        if (item.user && typeof item.user === 'object') {
                            author = item.user.name || '成員';
                            // 這裡的 avatar 其實是 emoji 字元
                            if (item.user.avatar) avatar = item.user.avatar;
                        } else if (typeof item.user === 'string') {
                            if (item.user.startsWith('{')) {
                                const uObj = JSON.parse(item.user);
                                author = uObj.name || '成員';
                                if (uObj.avatar) avatar = uObj.avatar;
                            } else {
                                author = item.user;
                            }
                        }
                    } catch (e) {
                        console.warn('Parse user failed', e);
                    }

                    // 如果作者是自己，不通知 (避免收到自己剛剛發的)
                    // 如果 currentUserName 為空 (未設定)，則預設會收到通知
                    if (currentUserName && author === currentUserName) return;

                    // 發送通知
                    if (Notification.permission === "granted") {
                        const noteContent = item.content || item.item || '(圖片)';
                        // 過濾掉公告標籤
                        const cleanContent = noteContent.replace(/\[公告\]|#公告/g, '').trim();

                        // 嘗試發送
                        try {
                            // [Fix] 將 Emoji 頭像加在標題最前面
                            new Notification(`${avatar} ${author} 新增了一則記事`, {
                                body: cleanContent || '分享了一張圖片',
                                icon: 'icon-512.png', // 恢復使用 APP icon，因為 avatar 是文字
                                tag: `tokyo-trip-note-${itemId}` // [Fix] 使用唯一 tag，避免通知被覆蓋
                            });
                        } catch (e) {
                            console.warn("Notification failed", e);
                        }
                    }
                }
            });
        }

        // B. 更新後的同步函式 (加入快取機制 + 背景輪詢)
        async function syncLedgerData(isBackground = false) {
            const url = getKey('gas_url');
            const token = getKey('gas_token');
            if (!url || !token) return false;

            if (!isBackground) {
                // 可以加個簡單的 loading 狀態，但這裡先保持靜默以免干擾
            }

            try {
                const res = await fetch(`${url}?token=${token}&action=getAll`);
                const result = await res.json();
                if (result.status === 'success') {
                    const oldData = window.rawLedgerData || [];
                    const newData = result.data;

                    // [新增] 如果是背景執行，檢查有無新記事
                    if (isBackground) {
                        checkAndNotifyNewNotes(oldData, newData);
                    }

                    // [修正] 強制寫入 window 物件，確保 deleteLedgerItem 可以讀取
                    window.rawLedgerData = newData;
                    // 同時更新本地變數 (如果有的話)以防萬一
                    rawLedgerData = newData;

                    renderLedgerList(window.rawLedgerData);
                    return true;
                }
            } catch (e) {
                if (!isBackground) console.error("同步失敗", e);
            }
            return false;
        }

        // [修正版] 渲染列表 (分組 + 折疊 + 含年份)
        function renderLedgerList(data) {
            // [Fix] Always render marquee first, regardless of filter state
            renderAnnouncementMarquee(data);

            const listContainer = document.getElementById('ledger-list');
            if (!listContainer) return;

            // 排序：新的在上面
            data.sort((a, b) => new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date));

            const currentUserName = localStorage.getItem('last_user_name') || '匿名'; // [移動到前面定義]

            const filteredData = data.filter(item => {
                // 1. 基本 Tab 過濾 (finance / note)
                if (item.type !== currentLedgerFilter) return false;

                // 2. [新增] 隱私過濾：只顯示公費 OR 自己的私人支出
                if (item.type === 'finance') {
                    const pType = item.paymentType || 'Public';
                    // 如果是公費，保留
                    if (pType === 'Public' || pType === 'public') return true;
                    // 如果是私人，檢查是否為自己
                    if (currentUserName && pType === currentUserName) return true;

                    // 其他人的私人支出 -> 隱藏
                    return false;
                }

                // Note 暫時不過濾 (或視需求而定)
                return true;
            });

            let totalJPY = 0;
            let totalTWD = 0;
            // [新增] 私人支出統計
            let privateJPY = 0;
            let privateTWD = 0;

            // [刪除] 重複宣告
            // const currentUserName = localStorage.getItem('last_user_name') || '匿名';

            if (filteredData.length === 0) {
                listContainer.innerHTML = `<div style="text-align: center; color: #999; padding: 60px;">尚無紀錄</div>`;
                updateTotalDisplay(0, 0);
                // 清空私人顯示
                const pTotalEl = document.getElementById('user-private-total');
                if (pTotalEl) pTotalEl.innerText = '';
                return;
            }

            // 1. 分組邏輯 (Group By Date: YYYY-MM-DD)
            const groups = {};
            filteredData.forEach(item => {
                let dateStr = 'Unknown';
                let timeObj = new Date();
                try {
                    timeObj = new Date(item.timestamp || item.date);
                    // 格式：YYYY-MM-DD
                    const y = timeObj.getFullYear();
                    const m = String(timeObj.getMonth() + 1).padStart(2, '0');
                    const d = String(timeObj.getDate()).padStart(2, '0');
                    dateStr = `${y}-${m}-${d}`;
                } catch (e) { }

                if (!groups[dateStr]) groups[dateStr] = [];
                groups[dateStr].push(item);

                // 計算總額 (不變)
                if (item.type === 'finance') {
                    const jpy = parseFloat(item.amount || 0);
                    const twd = item.twdAmount ? parseInt(item.twdAmount) : Math.round(jpy * (item.rate || 0.21));

                    const pType = item.paymentType || 'Public';

                    // 公費總計
                    if (pType === 'Public' || pType === 'public') {
                        totalJPY += jpy;
                        totalTWD += twd;
                    }
                    // 私人總計 (只算目前登入者的)
                    else if (pType === currentUserName) {
                        privateJPY += jpy;
                        privateTWD += twd;
                    }
                }
            });

            // 更新 UI顯示
            updateTotalDisplay(totalJPY, totalTWD);

            const pTotalEl = document.getElementById('user-private-total');
            if (pTotalEl) {
                if (privateJPY > 0) {
                    pTotalEl.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: flex-start; margin-left: 8px; line-height: 1.2;">
                        <span style="font-weight: 700; color: #2563EB; font-size: 1rem;">¥ ${privateJPY.toLocaleString()}</span>
                        <span style="font-size: 0.75rem; color: #6B7280;">≈ NT$ ${privateTWD.toLocaleString()}</span>
                    </div>`;
                } else {
                    pTotalEl.innerText = '';
                }
            }

            // 2. 渲染分組
            let html = '';
            // 取得今天的日期字串 (用來判斷是否預設展開)
            const now = new Date();
            const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

            // 排序日期 (新的日期在上面)
            const sortedDates = Object.keys(groups).sort((a, b) => new Date(b) - new Date(a));

            sortedDates.forEach(dateKey => {
                const groupItems = groups[dateKey];
                const isToday = (dateKey === todayStr);

                // 格式化顯示標題 (YYYY/MM/DD + 星期)
                let displayDateTitle = dateKey;
                try {
                    const d = new Date(dateKey); // 這裡會是 UTC 00:00，但因為我們只取年月日，應該沒差
                    // 修正：直接解析字串避免時區問題
                    const [yy, mm, dd] = dateKey.split('-');
                    const dateObj = new Date(parseInt(yy), parseInt(mm) - 1, parseInt(dd));
                    const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
                    displayDateTitle = `${yy}/${mm}/${dd} (${dayNames[dateObj.getDay()]})`;
                } catch (e) { }

                // 標題 HTML (點擊切換顯示)
                // isToday 預設展開，其他預設折疊
                const arrowTransform = isToday ? 'rotate(180deg)' : 'rotate(0deg)';
                const contentDisplay = isToday ? 'block' : 'none';

                // 生成 Group ID
                const groupId = `group-${dateKey}`;

                const itemCount = groupItems.length; // [新增] 計算筆數

                html += `
                <div class="ledger-group" style="margin-bottom: 20px;">
                    <div onclick="toggleLedgerGroup('${groupId}', this)" 
                         style="display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; cursor: pointer; user-select: none;">
                        <div style="font-weight: 700; color: #4B5563; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                            <span>${displayDateTitle}</span>
                            <span style="font-size: 0.85rem; color: #9CA3AF; font-weight: 500;">(${itemCount})</span>
                            ${isToday ? '<span style="font-size:0.75rem; color:#EF4444; background:#FEE2E2; padding:2px 6px; border-radius:4px;">Today</span>' : ''}
                        </div>
                        <svg class="group-arrow" style="width: 20px; height: 20px; transition: transform 0.3s; transform: ${arrowTransform}; color: #9CA3AF;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                    
                    <div id="${groupId}" style="display: ${contentDisplay};">
                `;

                // 渲染該日期的所有項目
                groupItems.forEach(item => {
                    // ★★★ 核心解析邏輯 (與原本相同) ★★★
                    let displayUser = { name: '未知', avatar: '👤' };
                    try {
                        if (typeof item.user === 'object' && item.user !== null) {
                            displayUser = item.user;
                        } else if (typeof item.user === 'string') {
                            if (item.user.trim().startsWith('{')) {
                                displayUser = JSON.parse(item.user);
                            } else {
                                displayUser = { name: item.user, avatar: '👤' };
                            }
                        }
                    } catch (e) {
                        console.warn("解析使用者資料失敗", item.user);
                    }

                    // 時間只顯示 HH:mm (因為日期在標題了)
                    let timeStr = '';
                    try {
                        const t = new Date(item.timestamp || item.date);
                        timeStr = `${t.getHours().toString().padStart(2, '0')}:${t.getMinutes().toString().padStart(2, '0')}`;
                    } catch (e) { }

                    if (item.type === 'finance') {
                        const jpy = parseFloat(item.amount || 0);
                        const twd = item.twdAmount ? parseInt(item.twdAmount) : Math.round(jpy * (item.rate || 0.21));
                        const displayTitle = item.content || item.item || '無標題';

                        // 驗證身分
                        const currentUserName = localStorage.getItem('last_user_name');
                        let actionButtons = '';

                        // [新增] 付款方式圖示對應
                        let payIcon = '💵'; // 預設現金
                        const pm = (item.paymentMethod || '').toLowerCase();
                        if (pm.includes('card') || pm.includes('刷卡')) payIcon = '💳';
                        else if (pm.includes('ic') || pm.includes('suica')) payIcon = '🐧';
                        else if (pm.includes('pay')) payIcon = '📱';

                        if (currentUserName && displayUser.name === currentUserName) {
                            actionButtons = `
                            <div style="display: flex; gap: 10px; margin-top: 8px; justify-content: flex-end;">
                                <button onclick="editLedgerItem('${item.id}')" style="background:none; border:none; cursor:pointer; padding:4px;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <button onclick="deleteLedgerItem('${item.id}', this)" style="background:none; border:none; cursor:pointer; padding:4px;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#EF4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>`;
                        }

                        html += `
                        <div class="card" style="margin-bottom: 12px; padding: 15px; border-left: 4px solid #F97316; background: white; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="display: flex; gap: 12px;">
                                    <div style="display:flex; flex-direction:column; align-items:center; min-width:44px;">
                                        <span style="font-size: 1.8rem; line-height: 1;">${displayUser.avatar || '👤'}</span>
                                        <span style="font-size: 0.7rem; color: #6B7280; margin-top:2px; font-weight:500; text-align:center; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:44px;">${displayUser.name || '成員'}</span>
                                    </div>
                                    <div>
                                        <div style="font-weight: 700; font-size: 1.1rem; color: #1F2937; margin-bottom: 4px;">${displayTitle}</div>
                                        <div style="font-size: 0.8rem; color: #9CA3AF; display: flex; align-items: center; gap: 4px;">
                                            <span style="font-size: 0.9rem; filter: grayscale(0.1);" title="${item.paymentMethod || '現金'}">${payIcon}</span>
                                            ${timeStr}
                                        </div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 700; font-size: 1.2rem; color: #F97316;">
                                        ¥${jpy.toLocaleString()}
                                    </div>
                                    <div style="font-size: 0.85rem; color: #6B7280;">≈ NT$${twd.toLocaleString()}</div>
                                </div>
                            </div>
                            ${actionButtons}
                        </div>`;
                    } else {
                        // 筆記模式
                        // [修正] 強制轉為字串，避免純數字導致 .includes 報錯
                        let rawContent = item.content || item.item || '無內容';
                        let noteContent = String(rawContent);
                        const currentUserName = localStorage.getItem('last_user_name');

                        // [新增] 識別與顯示公告圖示
                        const isAnnouncement = noteContent.includes('[公告]') || noteContent.includes('#公告');
                        // 移除標記以便乾淨顯示
                        noteContent = noteContent.replace(/\[公告\]|#公告/g, '').trim();

                        let timeDisplay = timeStr;
                        if (isAnnouncement) {
                            // 在時間左邊加入紅色圖釘
                            timeDisplay = `
                             <svg width="14" height="14" viewBox="0 0 24 24" fill="#FEE2E2" stroke="#EF4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:2px; transform:rotate(45deg);">
                                <line x1="12" y1="17" x2="12" y2="22"></line>
                                <path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"></path>
                             </svg> ${timeStr}`;
                        }

                        // [新增] 圖片處理邏輯
                        let imagesHtml = '';
                        let imagesData = [];
                        if (item.image && typeof item.image === 'string') {
                            imagesData = item.image.split('\n').filter(u => u.trim() !== '');
                        }


                        if (imagesData.length > 0) {
                            // [修正] 將圖片資料存入全域 Cache，避免 onclick 傳遞過大字串導致失效
                            if (!window.ledgerImagesCache) window.ledgerImagesCache = {};
                            window.ledgerImagesCache[item.id] = imagesData;

                            const previewHtml = imagesData.map((src, idx) => {
                                return `
                                 <div class="note-img-thumb" style="width: 80px; height: 80px; border-radius: 8px; overflow: hidden; flex-shrink: 0; cursor: pointer; border:1px solid #eee;"
                                      onclick="openGalleryFromList('${item.id}', ${idx})">
                                     <img src="${src}" style="width: 100%; height: 100%; object-fit: cover;">
                                 </div>
                                 `;
                            }).join('');

                            imagesHtml = `
                             <div class="horizontal-scroll-container" 
                                  style="display: flex; gap: 8px; margin-top: 8px; overflow-x: auto; padding-bottom: 4px;"
                                  ontouchstart="event.stopPropagation()" 
                                  ontouchmove="event.stopPropagation()">
                                ${previewHtml}
                             </div>`;
                        }

                        let actionButtons = '';

                        if (currentUserName && displayUser.name === currentUserName) {
                            actionButtons = `
                            <div style="display: flex; gap: 10px; margin-top: 8px; justify-content: flex-end; border-top: 1px dashed #eee; padding-top: 8px;">
                                <button onclick="editLedgerItem('${item.id}')" style="background:none; border:none; cursor:pointer; padding:4px;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <button onclick="deleteLedgerItem('${item.id}', this)" style="background:none; border:none; cursor:pointer; padding:4px;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#EF4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>`;
                        }

                        html += `
                        <div class="card" style="margin-bottom: 12px; padding: 15px; border-left: 4px solid #2563EB; background: white; border-radius: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 8px;">
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <span style="font-size: 1.4rem;">${displayUser.avatar || '👤'}</span>
                                    <span style="font-size: 0.85rem; font-weight: 600; color:#374151;">${displayUser.name}</span>
                                </div>
                                <div style="font-size: 0.75rem; color: #9ca3af; display:flex; align-items:center;">${timeDisplay}</div>
                            </div>
                            <div style="font-size: 1rem; color: #374151; line-height: 1.6; white-space: pre-wrap; word-break: break-word;">${noteContent}</div>
                            ${imagesHtml}
                            ${actionButtons}
                        </div>`;
                    }
                });

                html += `</div></div>`; // Close group div
            });

            listContainer.innerHTML = html;
            updateTotalDisplay(totalJPY, totalTWD);
        }

        // [新增] 切換折疊顯示
        function toggleLedgerGroup(groupId, headerEl) {
            const content = document.getElementById(groupId);
            const arrow = headerEl.querySelector('.group-arrow');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                if (arrow) arrow.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                if (arrow) arrow.style.transform = 'rotate(0deg)';
            }
        }

        // 輔助函式：更新上方總金額
        function updateTotalDisplay(jpy, twd) {
            const totalDisplay = document.getElementById('ledger-total-amount');
            if (totalDisplay && currentLedgerFilter === 'finance') {
                totalDisplay.innerHTML = `
            <div>¥ ${jpy.toLocaleString()}</div>
            <div style="font-size: 0.85rem; opacity: 0.8; font-weight: 400;">≈ NT$ ${twd.toLocaleString()}</div>
        `;
            } else if (totalDisplay) {
                // 筆記模式顯示則數
                const count = document.querySelectorAll('#ledger-list .card').length;
                totalDisplay.innerHTML = `<div>${count} 則筆記</div>`;
            }
        }



        // --- [新增] 使用者身分管理邏輯 (Welcome Flow) ---

        // 1. 檢查使用者 Session
        function checkUserSession() {
            const userName = localStorage.getItem('last_user_name');
            const userAvatar = localStorage.getItem('last_user_emoji');

            // 嚴格檢查：必須兩個都有值，且 name 不是髒資料
            let isValid = false;
            if (userName && userAvatar) {
                if (!userName.trim().startsWith('{') && userName !== 'undefined' && userName !== 'null') {
                    isValid = true;
                }
            }

            if (isValid) {
                // 已登入：更新 UI 並隱藏迎賓頁
                updateUserDisplay();
                hideWelcomeModal();
                updateUserInfoFromUI(); // 確保 hidden fields 同步
            } else {
                // 未登入：顯示迎賓頁
                showWelcomeModal();
            }
        }

        // 2. 顯示迎賓 Modal
        function showWelcomeModal() {
            const modal = document.getElementById('welcome-modal');
            modal.style.display = 'flex';
            initWelcomeAvatarSelector();
        }

        // 3. 隱藏迎賓 Modal
        function hideWelcomeModal() {
            document.getElementById('welcome-modal').style.display = 'none';
        }

        // 4. 初始化迎賓頁頭像選擇器
        let selectedWelcomeAvatar = '🦁'; // 預設

        function initWelcomeAvatarSelector() {
            const container = document.getElementById('welcome-avatar-grid');
            // [修正] 改用 children.length 檢查，避免被 HTML 註解誤導
            if (container.children.length > 0) return;

            // 使用與原本相同的頭像列表
            const emojis = [
                '🦁', '🐰', '🐼', '🐨', '🦊', '🐱', '🐶', '🐯', '🐵', '🐷',
                '🐹', '🐻', '🐮', '🐸', '🐔', '🐧', '🦄', '🐙', '🦖', '🐬'
            ];

            container.innerHTML = '';
            emojis.forEach(emoji => {
                const div = document.createElement('div');
                div.className = 'avatar-option';
                div.innerText = emoji;
                if (emoji === selectedWelcomeAvatar) div.classList.add('selected');

                div.onclick = function () {
                    // 移除其他選中狀態
                    document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
                    // 選中當前
                    this.classList.add('selected');
                    selectedWelcomeAvatar = emoji;
                };
                container.appendChild(div);
            });
        }

        // 5. 處理登入 (按鈕點擊)
        function handleLogin() {
            const nameInput = document.getElementById('welcome-nickname');
            const name = nameInput.value.trim();

            if (!name) {
                alert('請輸入一個帥氣或可愛的暱稱！');
                return;
            }

            // 儲存到 LocalStorage
            localStorage.setItem('last_user_name', name);
            localStorage.setItem('last_user_emoji', selectedWelcomeAvatar);

            // 更新 UI
            updateUserDisplay();
            updateUserInfoFromUI(); // 同步 hidden fields

            // 關閉 Modal
            hideWelcomeModal();

            // 歡迎提示 (可選)
            // alert(`歡迎加入旅程，${name}！`);
        }

        // 6. 顯示登出確認窗
        function showLogoutPopup() {
            const name = localStorage.getItem('last_user_name') || '成員';
            const avatar = localStorage.getItem('last_user_emoji') || '👤';

            document.getElementById('logout-name-preview').innerText = name;
            document.getElementById('logout-avatar-preview').innerText = avatar;
            document.getElementById('logout-popup').style.display = 'flex';
        }

        // 7. 確認登出
        function handleLogoutConfirm() {
            // 清除 LocalStorage
            localStorage.removeItem('last_user_name');
            localStorage.removeItem('last_user_emoji');

            // 關閉確認窗
            document.getElementById('logout-popup').style.display = 'none';

            // 重新顯示迎賓頁
            showWelcomeModal();
        }

        // 8. 更新 UI顯示 (將 LocalStorage 資料填入 user-status-display 和 hidden fields)
        function updateUserDisplay() {
            const name = localStorage.getItem('last_user_name') || '請登入';
            const avatar = localStorage.getItem('last_user_emoji') || '👤';

            // 更新顯示卡片
            document.getElementById('display-current-name').innerText = name;
            document.getElementById('display-current-avatar').innerText = avatar;

            // 更新隱藏欄位 (給 handleLedgerSubmit 用)
            const nameInput = document.getElementById('custom-user-name');
            if (nameInput) nameInput.value = name;

            // 確保隱藏的 JSON 欄位也更新 (相容性)
            updateUserInfoFromUI();
        }

        // [Override] 修改既有的 updateUserInfoFromUI 以支援我們的新流程
        // 由於我們移除了原本的 UI，這裡需要改寫以從 hidden field 讀取或直接從 LS 讀取
        // 注意：原本的函數是綁定在 input oninput 上的，現在 input 是 hidden 的
        function updateUserInfoFromUI() {
            const name = document.getElementById('custom-user-name').value || localStorage.getItem('last_user_name') || '匿名';
            const avatar = localStorage.getItem('last_user_emoji') || '🦁';

            // 構建 JSON 字串 (給後端用)
            const userInfo = JSON.stringify({
                name: name,
                avatar: avatar
            });

            const hiddenInput = document.getElementById('selected-user-info');
            if (hiddenInput) hiddenInput.value = userInfo;

            // 確保全域變數同步 (如果有用到的話)
            window.TEMP_USER_NAME = name;
        }

        // [Hook] 在切換 Tab 時檢查 (如果切換到旅程記錄 view-ledger)
        // 覆寫原本的 switchTab 邏輯可能會太複雜，我們選擇用事件監聽或在 switchTab 後面掛鉤
        // 這裡採用簡單的定時檢查或在 switchTab 的 onclick 中加入
        // 由於 switchTab 是全域的，我們可以在這裡劫持它嗎？ 
        // 比較安全的方式是：找到 nav-item，為其添加額外的 onclick

        document.addEventListener('DOMContentLoaded', () => {
            const ledgerBtn = document.querySelector('.nav-item[data-target="view-ledger"]');
            if (ledgerBtn) {
                ledgerBtn.addEventListener('click', () => {
                    // 點擊旅程記錄分頁時，檢查 Session
                    checkUserSession();
                });
            }

            if (document.getElementById('view-ledger').classList.contains('active')) {
                checkUserSession();
            }

            // [新增] 應用程式啟動時，自動抓取一次匯率 (解決電腦版沒開計算機就抓不到匯率的問題)
            if (typeof fetchLiveRate === 'function') {
                fetchLiveRate();
            }
            // [新增] 初始化日期為今天
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const dateStr = `${yyyy}-${mm}-${dd}`;

            const noteDate = document.getElementById('ledger-note-date');
            if (noteDate && !noteDate.value) noteDate.value = dateStr;

            const finDate = document.getElementById('ledger-date');
            if (finDate && !finDate.value) finDate.value = dateStr;
        });

        // [新增] 編輯與刪除功能 (需配合 GAS 後端更新)
        // ==========================================
        window.editingId = null; // 全域變數：紀錄目前正在編輯的 ID
        window.deleteConfirmMap = {}; // [新增] 用來記錄哪些 ID 處於刪除確認狀態

        async function deleteLedgerItem(id, btnElement) {
            // [狀態 1] 第一次點擊：變更為確認狀態 (紅色實心垃圾桶)
            if (!window.deleteConfirmMap[id]) {
                window.deleteConfirmMap[id] = true;

                // 變更圖示為紅色實心
                const originalContent = btnElement.innerHTML;
                btnElement.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="#EF4444" stroke="#EF4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>`;

                // 3秒後若沒點擊，自動還原
                setTimeout(() => {
                    if (window.deleteConfirmMap[id] === true) { // 如果還在確認狀態(沒進入刪除中)
                        delete window.deleteConfirmMap[id];
                        btnElement.innerHTML = originalContent; // 還原
                    }
                }, 3000);
                return;
            }

            // [狀態 2] 第二次點擊：執行刪除 (水位下降動畫)
            window.deleteConfirmMap[id] = 'deleting'; // 標記為刪除中

            // 替換為水位下降動畫 SVG
            // 這裡使用兩個 path，一個是外框，一個是內部水位 (用 CSS animation 控制 height 或 clip-path)
            btnElement.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="none">
                 <!-- 定義遮罩 (垃圾桶形狀) -->
                 <defs>
                    <clipPath id="trash-clip-${id}">
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </clipPath>
                 </defs>
                 
                 <!-- 背景 (外框) -->
                 <path d="M3 6h18" stroke="#EF4444" stroke-width="2" stroke-linecap="round"></path>
                 <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="#EF4444" stroke-width="2"></path>
                 
                 <!-- 水位 (紅色區塊) -->
                 <!-- 使用 rect 配合 mask，並對 rect 做 translateY 動畫 -->
                 <rect x="0" y="0" width="24" height="24" fill="#EF4444" clip-path="url(#trash-clip-${id})" style="animation: drainWater 1.5s linear forwards; transform-origin: bottom;">
                 </rect>
                 
                 <style>
                    @keyframes drainWater {
                        0% { transform: translateY(0); }
                        100% { transform: translateY(24px); }
                    }
                 </style>
            </svg>`;

            try {
                const url = getKey('gas_url');
                const dataList = window.rawLedgerData || [];
                const item = dataList.find(d => d.id === id);
                const type = item ? item.type : 'finance';

                const payload = {
                    action: 'delete',
                    id: id,
                    type: type,
                    token: getKey('gas_token')
                };

                const res = await fetch(url, { method: 'POST', body: JSON.stringify(payload) });
                const result = await res.json();

                if (result.status === 'success') {
                    // [狀態 3] 成功：顯示 OK
                    btnElement.innerHTML = `<span style="color:#10B981; font-weight:900; font-size:0.9rem;">OK</span>`;

                    // 短暫停留後移除項目
                    setTimeout(() => {
                        if (window.rawLedgerData) {
                            window.rawLedgerData = window.rawLedgerData.filter(item => item.id !== id);
                            renderLedgerList(window.rawLedgerData);
                        } else {
                            syncLedgerData();
                        }
                    }, 500);
                } else {
                    throw new Error(result.message);
                }
            } catch (e) {
                console.error(e);
                // [狀態 4] 失敗：顯示 NG
                btnElement.innerHTML = `<span style="color:#EF4444; font-weight:900; font-size:0.9rem;">NG</span>`;
                setTimeout(() => {
                    delete window.deleteConfirmMap[id];
                    // 還原回初始 SVG (空心垃圾桶)
                    btnElement.innerHTML = `
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#EF4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>`;
                }, 1500);
            }
        }


        function editLedgerItem(id) {
            // [修正] 確保讀取全域變數
            const dataList = window.rawLedgerData || [];
            const item = dataList.find(d => d.id === id);
            if (!item) {
                alert('找不到該筆資料，請重新整理頁面。');
                return;
            }

            // 設定全域編輯 ID
            window.editingId = id;

            // 切換到對應的 Tab (Finance or Note)
            if (item.type === 'finance') {
                filterLedgerView('finance');
                // 填入資料
                document.getElementById('ledger-item').value = item.item || item.content || '';
                document.getElementById('ledger-amount').value = item.amount || '';

                // [新增] 填入日期 (Finance)
                const fDateInput = document.getElementById('ledger-date');
                if (fDateInput) {
                    // [關鍵修正] 先強制轉回 date 類型
                    fDateInput.type = 'date';
                    let dStr = item.date || item.timestamp; // Fallback to timestamp

                    if (dStr) {
                        // 嘗試標準化為 YYYY-MM-DD
                        try {
                            // 如果是 ISO 格式 或 時間戳
                            const dObj = new Date(dStr);
                            if (!isNaN(dObj.getTime())) {
                                const y = dObj.getFullYear();
                                const m = String(dObj.getMonth() + 1).padStart(2, '0');
                                const d = String(dObj.getDate()).padStart(2, '0');
                                dStr = `${y}-${m}-${d}`;
                            }
                        } catch (e) { }
                    }

                    fDateInput.value = dStr || '';
                    // 觸發格式化
                    if (typeof formatCompactDate === 'function') formatCompactDate(fDateInput);
                }

                // [新增] 填入付款方式
                const payMethod = document.getElementById('ledger-payment-method');
                if (payMethod) {
                    // 若舊資料沒有 paymentMethod 則預設 cash
                    payMethod.value = item.paymentMethod || 'cash';

                    // [修正] 如果是 Public/Private，應該設定 payType
                    // 但目前 payType 是根據 item.paymentType
                    const payTypeSelect = document.getElementById('ledger-pay-type');
                    if (payTypeSelect) {
                        const pType = item.paymentType || 'Public';
                        // 如果是 'Public' 或 'public' -> value='public'
                        // 如果是 userName 或 其他 -> value='private'
                        if (pType.toLowerCase() === 'public') {
                            payTypeSelect.value = 'public';
                        } else {
                            payTypeSelect.value = 'private';
                        }
                    }
                }
                // 為了讓使用者知道正在編輯，改變按鈕文字
                const btn = document.querySelector('#ledger-finance-fields .btn-submit-ledger');
                if (btn) {
                    // 改為顯示「編輯(打勾)」圖示 (橘色)
                    btn.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#F59E0B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                }
            } else {
                filterLedgerView('note');
                // 填入資料
                // [修正] 強制轉為字串，避免純數字導致 .includes 報錯
                let rawContent = item.content || item.item || '';
                let contentText = String(rawContent);

                // [新增] 偵測是否為公告 -> 設定 isAnnouncementMode
                if (contentText.includes('[公告]') || contentText.includes('#公告')) {
                    // 移除標記，讓編輯框只顯示純文字
                    contentText = contentText.replace(/\[公告\]\s*|#公告\s*/g, '');
                    if (typeof setAnnouncementMode === 'function') setAnnouncementMode(true);
                } else {
                    if (typeof setAnnouncementMode === 'function') setAnnouncementMode(false);
                }

                document.getElementById('ledger-note-content').value = contentText;

                // [新增] 填入日期
                const dateInput = document.getElementById('ledger-note-date');
                if (dateInput) {
                    // [關鍵修正] 先強制轉回 date 類型
                    dateInput.type = 'date';
                    let dStr = item.date || item.timestamp;
                    if (dStr) {
                        try {
                            const dObj = new Date(dStr);
                            if (!isNaN(dObj.getTime())) {
                                const y = dObj.getFullYear();
                                const m = String(dObj.getMonth() + 1).padStart(2, '0');
                                const d = String(dObj.getDate()).padStart(2, '0');
                                dStr = `${y}-${m}-${d}`;
                            }
                        } catch (e) { }
                    }
                    dateInput.value = dStr || '';
                    // 觸發格式化
                    if (typeof formatCompactDate === 'function') formatCompactDate(dateInput);
                }
                // 為了讓使用者知道正在編輯，改變按鈕文字
                const btn = document.querySelector('#ledger-note-fields .btn-submit-ledger');
                if (btn) {
                    // 改為顯示「編輯(打勾)」圖示 (藍色)
                    btn.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2563EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                }
            }

            // [新增] 顯示 Cancel 按鈕
            if (item.type === 'finance') {
                const cBtn = document.getElementById('btn-cancel-edit-finance');
                if (cBtn) cBtn.style.display = 'flex';
            } else {
                const cBtn = document.getElementById('btn-cancel-edit-note');
                if (cBtn) cBtn.style.display = 'flex';
            }

            // [新增] 載入現有圖片 (Note 模式)
            if (item.type !== 'finance') {
                window.currentNoteImages = [];
                // item.image 可能是一串 URL (換行分隔)
                if (item.image && typeof item.image === 'string') {
                    const urls = item.image.split('\n').filter(u => u.trim() !== '');
                    window.currentNoteImages = urls;
                }
                renderImagePreviews();
            }

            // 滾動到輸入區
            document.getElementById('ledger-input-card').scrollIntoView({ behavior: 'smooth' });

            // 提示
            // alert('請修改上方內容後，點擊按鈕送出。');

            // [新增] 填入資料後立即檢查狀態
            updateLedgerSubmitState();
        }

        // [新增] 檢查記帳/記事輸入狀態，控制送出按鈕可用性
        function updateLedgerSubmitState() {
            // 1. Finance Check
            const itemVal = document.getElementById('ledger-item').value.trim();
            const amountVal = document.getElementById('ledger-amount').value.trim();
            // 注意：這裡改成更精確的選擇器，避免選錯
            const financeBtn = document.querySelector('#ledger-finance-fields .btn-submit-ledger');

            if (financeBtn) {
                if (itemVal && amountVal) {
                    financeBtn.disabled = false;
                    financeBtn.style.opacity = '1';
                    financeBtn.style.cursor = 'pointer';
                    financeBtn.style.filter = 'none';
                } else {
                    financeBtn.disabled = true;
                    financeBtn.style.opacity = '0.3';
                    financeBtn.style.cursor = 'not-allowed';
                    financeBtn.style.filter = 'grayscale(100%)';
                }
            }

            // 2. Note Check
            const noteVal = document.getElementById('ledger-note-content').value.trim();
            const noteBtn = document.querySelector('#ledger-note-fields .btn-submit-ledger');

            if (noteBtn) {
                // [修正] 只要有文字 OR 有圖片就可以送出
                const hasImages = window.currentNoteImages && window.currentNoteImages.length > 0;

                if (noteVal || hasImages) {
                    noteBtn.disabled = false;
                    noteBtn.style.opacity = '1';
                    noteBtn.style.cursor = 'pointer';
                    noteBtn.style.filter = 'none';
                } else {
                    noteBtn.disabled = true;
                    noteBtn.style.opacity = '0.3';
                    noteBtn.style.cursor = 'not-allowed';
                    noteBtn.style.filter = 'grayscale(100%)';
                }
            }
        }

        // [新增] 綁定輸入監聽
        document.addEventListener('DOMContentLoaded', () => {
            const inputs = ['ledger-item', 'ledger-amount', 'ledger-note-content'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', updateLedgerSubmitState);
                }
            });
            // 初始化檢查 (稍微延遲確保 DOM 完全就緒)
            setTimeout(updateLedgerSubmitState, 100);
        });

        // [新增] 放棄變更模式 (更名為 exitEditMode 以避免衝突)
        function exitEditMode() {
            window.editingId = null;

            // 清空輸入
            document.getElementById('ledger-item').value = '';
            document.getElementById('ledger-amount').value = '';
            document.getElementById('ledger-note-content').value = '';

            // [新增] 重置日期為今天
            const today = new Date();

            // [新增] 離開編輯模式時，重置公告狀態
            if (typeof setAnnouncementMode === 'function') {
                setAnnouncementMode(false);
            } else {
                isAnnouncementMode = false;
                if (typeof updatePinButtonState === 'function') updatePinButtonState();
            }
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const todayStr = `${yyyy}-${mm}-${dd}`;

            const finDate = document.getElementById('ledger-date');
            if (finDate) {
                finDate.type = 'date';
                finDate.value = todayStr;
                finDate.dataset.isoValue = todayStr; // [關鍵] 強制覆寫緩存為今天
                if (typeof formatCompactDate === 'function') formatCompactDate(finDate);
            }

            const noteDate = document.getElementById('ledger-note-date');
            if (noteDate) {
                noteDate.type = 'date';
                noteDate.value = todayStr;
                noteDate.dataset.isoValue = todayStr; // [關鍵] 強制覆寫緩存為今天
                if (typeof formatCompactDate === 'function') formatCompactDate(noteDate);
            }

            // [新增] 重置付款方式
            const payMethod = document.getElementById('ledger-payment-method');
            if (payMethod) payMethod.value = 'cash';

            // [新增] 清空圖片
            window.currentNoteImages = [];
            renderImagePreviews();

            // 隱藏 Cancel 按鈕
            const cBtnFin = document.getElementById('btn-cancel-edit-finance');
            if (cBtnFin) cBtnFin.style.display = 'none';
            const cBtnNote = document.getElementById('btn-cancel-edit-note');
            if (cBtnNote) cBtnNote.style.display = 'none';

            // 還原按鈕為紙飛機
            const btns = document.querySelectorAll('.btn-submit-ledger');
            btns.forEach(btn => {
                // [修正] 使用 .closest() 來判斷是否為 Note 區塊
                const isNote = !!btn.closest('#ledger-note-fields');
                const color = isNote ? '#2563EB' : 'currentColor';

                btn.innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${color}"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>`;
            });

            // [新增] 清空後檢查狀態
            updateLedgerSubmitState();
        }

        // ============================================================
        // [新增] 多圖上傳與預覽邏輯
        // ============================================================
        window.currentNoteImages = []; // 存放 Base64 字串或 URL

        async function handleMultiImageSelect(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            showGlobalLoading(); // 顯示讀取中 (因為壓縮可能花時間)

            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    // 簡單壓縮: Max 1024px
                    // [修正] 改名避免與 AI 助手衝突
                    const base64 = await compressImageForNote(file, 1024, 0.8);
                    window.currentNoteImages.push(base64);
                }
                renderImagePreviews();
                // 清空 input 讓同一檔案可重複選
                event.target.value = '';
            } catch (e) {
                console.error("Image process error", e);
                alert("圖片處理失敗");
            } finally {
                hideGlobalLoading();
            }
        }

        // [修正] 改名為 compressImageForNote 以免覆蓋 AI 助手原本的 compressImage
        function compressImageForNote(file, maxWidth, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function (e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function () {
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = Math.round(height * (maxWidth / width));
                            width = maxWidth;
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        function renderImagePreviews() {
            const container = document.getElementById('note-image-preview');
            // [修正] 即使清空也要呼叫 updateLedgerSubmitState，確保按鈕狀態正確
            if (!window.currentNoteImages || window.currentNoteImages.length === 0) {
                container.style.display = 'none';
                container.innerHTML = '';
                updateLedgerSubmitState(); // [新增] 更新按鈕狀態
                return;
            }

            // [修正] 改用 horizontal-scroll-container 樣式，並加入防誤觸
            container.style.display = 'flex';
            // 注意：要確保 style 中有 overflow-x: auto; 這裡透過 class 控制，但若原本沒有 CSS class 定義，需手動加 inline style
            // 這裡為了保險，加上 inline style
            container.style.overflowX = 'auto';
            container.style.paddingBottom = '4px'; // 讓捲軸不遮擋

            // [關鍵] 加入防誤觸事件
            container.ontouchstart = (e) => e.stopPropagation();
            container.ontouchmove = (e) => e.stopPropagation();

            container.innerHTML = window.currentNoteImages.map((src, index) => `
                <div class="preview-thumb-box" onclick="openGallery(${index})" style="position: relative; flex-shrink: 0; width: 60px; height: 60px; margin-right: 8px;">
                    <img src="${src}" class="preview-thumb-img" style="width:100%; height:100%; object-fit:cover; border-radius:4px;">
                    <div class="btn-remove-img" onclick="removeImage(event, ${index})" 
                        style="position:absolute; top:2px; right:2px; background:rgba(239, 68, 68, 0.9); color:white; border-radius:50%; width:16px; height:16px; display:flex; align-items:center; justify-content:center; font-size:10px; cursor:pointer; font-weight:bold;">✕</div>
                </div>
            `).join('');

            updateLedgerSubmitState(); // [新增] 更新按鈕狀態
        }

        function removeImage(e, index) {
            e.stopPropagation(); // 阻止冒泡觸發 openGallery
            if (confirm('確定移除這張照片嗎？')) {
                window.currentNoteImages.splice(index, 1);
                renderImagePreviews();
            }
        }

        // ============================================================
        // [新增] 全螢幕圖庫邏輯 (含縮放與滑動)
        // ============================================================
        let galleryCurrentIndex = 0;
        let galleryImages = []; // 當前圖庫顯示的圖片來源陣列

        // [新增] 從列表開啟圖庫的輔助函式
        function openGalleryFromList(itemId, index) {
            if (window.ledgerImagesCache && window.ledgerImagesCache[itemId]) {
                const images = window.ledgerImagesCache[itemId];
                openGallery(index, images);
            }
        }

        // 開啟圖庫 (來源可能是 window.currentNoteImages 或是 Ledger List 中的圖片)
        function openGallery(index, imagesSource = null) {

            // 解析 imagesSource (如果是字串或陣列)
            let imgs = [];

            if (imagesSource) {
                if (Array.isArray(imagesSource)) {
                    imgs = imagesSource;
                } else if (typeof imagesSource === 'string') {
                    try {
                        imgs = JSON.parse(unescape(imagesSource));
                    } catch (e) {
                        imgs = [];
                    }
                }
            } else {
                // 預設是大頭貼輸入預覽
                imgs = window.currentNoteImages || [];
            }

            galleryImages = imgs;
            if (galleryImages.length === 0) return;

            galleryCurrentIndex = index;
            const modal = document.getElementById('gallery-modal');
            const container = document.getElementById('gallery-container');
            const dotsContainer = document.getElementById('gallery-dots');

            // 渲染圖片
            container.innerHTML = galleryImages.map((src, i) => `
                <div class="gallery-slide" style="transform: translateX(${(i - index) * 100}%)"
                     data-index="${i}">
                    <img src="${src}" class="gallery-img">
                </div>
            `).join('');

            // 渲染圓點
            updateGalleryDots();

            modal.style.display = 'flex';

            // 綁定手勢事件
            bindGalleryEvents();
        }

        function closeGallery() {
            document.getElementById('gallery-modal').style.display = 'none';
        }

        function updateGalleryDots() {
            const dotsContainer = document.getElementById('gallery-dots');
            dotsContainer.innerHTML = galleryImages.map((_, i) => `
                <div class="gallery-dot ${i === galleryCurrentIndex ? 'active' : ''}"></div>
            `).join('');
        }

        function switchGallerySlide(newIndex) {
            if (newIndex < 0) newIndex = 0;
            if (newIndex >= galleryImages.length) newIndex = galleryImages.length - 1;

            galleryCurrentIndex = newIndex;

            const slides = document.querySelectorAll('.gallery-slide');
            slides.forEach(slide => {
                const idx = parseInt(slide.getAttribute('data-index'));
                slide.style.transform = `translateX(${(idx - galleryCurrentIndex) * 100}%)`;
            });

            updateGalleryDots();

            // 重置縮放
            resetZoom();
        }


        // --- 手勢與縮放邏輯 (Pinch Zoom & Swipe) ---
        let touchStartX = 0;
        let touchStartY = 0;
        let isZooming = false;
        let currentScale = 1;
        let lastScale = 1;
        let initialDistance = 0;

        // 變數儲存當前圖片元素 (用於縮放)
        function getCurrentImg() {
            const slide = document.querySelector(`.gallery-slide[data-index="${galleryCurrentIndex}"]`);
            return slide ? slide.querySelector('img') : null;
        }

        function bindGalleryEvents() {
            const container = document.getElementById('gallery-container');
            const modal = document.getElementById('gallery-modal');

            // [新增] 阻擋 Modal 背景的觸控事件冒泡，防止底層滑動
            const blockTouch = (e) => {
                e.stopPropagation();
                // 如果是在背景滑動，也阻止默認捲動
                if (e.type === 'touchmove') e.preventDefault();
            };
            modal.ontouchstart = blockTouch;
            modal.ontouchmove = blockTouch;
            modal.ontouchend = blockTouch;

            container.ontouchstart = (e) => {
                e.stopPropagation(); // [新增] 阻止冒泡
                if (e.touches.length === 1) {
                    // 單指：可能是滑動
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                } else if (e.touches.length === 2) {
                    // 雙指：縮放起始
                    isZooming = true;
                    initialDistance = getDistance(e.touches);
                }
            };

            container.ontouchmove = (e) => {
                e.stopPropagation(); // [新增] 阻止冒泡
                e.preventDefault(); // 阻止瀏覽器預設行為

                if (isZooming && e.touches.length === 2) {
                    // 縮放中
                    const dist = getDistance(e.touches);
                    const delta = dist / initialDistance;
                    const newScale = lastScale * delta;

                    // 限制縮放範圍 (1x ~ 4x)
                    if (newScale >= 1 && newScale <= 4) {
                        currentScale = newScale;
                        const img = getCurrentImg();
                        if (img) img.style.transform = `scale(${currentScale})`;
                    }
                }
            };

            container.ontouchend = (e) => {
                e.stopPropagation(); // [新增] 阻止冒泡
                if (isZooming) {
                    // 縮放結束，紀錄當前倍率
                    isZooming = false;
                    lastScale = currentScale;
                    if (lastScale < 1.1) {
                        lastScale = 1;
                        resetZoom(); // 稍微縮小就回彈至原始大小，方便進行換頁
                    }
                } else {
                    // 單指滑動結束判斷
                    if (e.changedTouches.length === 1 && currentScale === 1) {
                        const touchEndX = e.changedTouches[0].clientX;
                        const diffX = touchStartX - touchEndX;

                        if (Math.abs(diffX) > 50) { // 滑動超過 50px
                            if (diffX > 0) {
                                switchGallerySlide(galleryCurrentIndex + 1); // Next
                            } else {
                                switchGallerySlide(galleryCurrentIndex - 1); // Prev
                            }
                        }
                    }
                }
            };
        }

        function getDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        function resetZoom() {
            currentScale = 1;
            lastScale = 1;
            const img = getCurrentImg();
            if (img) img.style.transform = `scale(1)`;
        }

    </script>
    <!-- [新增] 歡迎與身分選擇 Modal -->
    <div id="welcome-modal">
        <div class="welcome-box">
            <div class="welcome-title">歡迎使用旅程記錄 👋</div>
            <div class="welcome-desc">請選擇您的稱呼與頭像<br>讓旅程記錄更生動！</div>

            <div class="avatar-grid" id="welcome-avatar-grid"></div>

            <input type="text" id="welcome-nickname" class="input-nickname" placeholder="請輸入暱稱 (例如: Kenzo)"
                maxlength="10" onclick="this.focus()">

            <button class="btn-start-trip" onclick="handleLogin()">開始記錄旅程 </button>
        </div>
    </div>

    <!-- [新增] 登出/切換身分確認 Modal -->
    <div id="logout-popup" class="modal-overlay">
        <div class="modal-box" style="width: 300px;">
            <div class="modal-title">切換身分</div>
            <div class="logout-box">
                <span id="logout-avatar-preview" class="logout-avatar">👤</span>
                <p class="modal-desc">確定要登出目前的「<span id="logout-name-preview"
                        style="font-weight:bold; color:#1F2937;"></span>」身分，並重新選擇嗎？</p>
            </div>
            <div class="modal-btns">
                <button class="modal-btn btn-cancel"
                    onclick="document.getElementById('logout-popup').style.display='none'">取消</button>
                <button class="modal-btn btn-confirm" onclick="handleLogoutConfirm()"
                    style="background: #EF4444; color: white;">確定登出</button>
            </div>
        </div>
    </div>

    <!-- [新增] 全螢幕圖庫 Modal -->
    <div id="gallery-modal">
        <div class="gallery-close" onclick="closeGallery()">×</div>
        <div id="gallery-container">
            <!-- Images injected via JS -->
        </div>
        <div class="gallery-dots" id="gallery-dots">
            <!-- Dots injected via JS -->
        </div>
    </div>
    </div>
    <!-- [新增] 帳單辨識結果確認 Modal -->
    <!-- [修正] 增加 ontouchmove="event.stopPropagation()" 防止捲動穿透到 Body -->
    <div id="bill-scan-modal" class="modal-overlay">
        <div class="modal-box" onclick="event.stopPropagation()" ontouchmove="event.stopPropagation()"
            style="max-width: 90%; width: 400px; max-height: 85vh; display: flex; flex-direction: column;">
            <div class="modal-title">掃描結果確認</div>
            <div class="modal-desc">請勾選並確認要加入的項目。</div>

            <div
                style="background: #F9FAFB; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px dashed #E5E7EB;">
                <div style="display: flex; gap: 6px; margin-bottom: 8px; align-items: center;">
                    <label style="font-size: 0.85rem; color: #666; width: 40px;">日期</label>
                    <input type="date" id="bill-scan-date"
                        style="flex: 1; border: 1px solid #ddd; border-radius: 4px; padding: 6px; -webkit-appearance: none; appearance: none; background: white; color: #000;">
                </div>
                <div style="display: flex; gap: 6px; align-items: center;">
                    <label style="font-size: 0.85rem; color: #666; width: 40px;">付款</label>
                    <select id="bill-scan-payment-method"
                        style="flex: 1; border: 1px solid #ddd; border-radius: 4px; padding: 6px; background: white;">
                        <option value="cash">💵 現金</option>
                        <option value="card" selected>💳 刷卡</option>
                        <option value="ic">🐧 IC卡</option>
                        <option value="pay">📱 Pay</option>
                    </select>
                    <label style="font-size: 0.85rem; color: #666; margin: 0 4px;">支付</label>
                    <select id="bill-scan-pay-type"
                        style="flex: 1; border: 1px solid #ddd; border-radius: 4px; padding: 6px; background: white;">
                        <option value="public" selected>公費</option>
                        <option value="private">個人</option>
                    </select>
                </div>
            </div>

            <div id="bill-scan-list"
                style="flex: 1; overflow-y: auto; margin: 10px 0; border: 1px solid #eee; border-radius: 8px; padding: 8px;">
                <!-- JS 動態生成項目 -->
            </div>

            <!-- 手動新增按鈕 -->
            <button onclick="addManualBillItem()"
                style="align-self: flex-start; margin-bottom: 10px; background: transparent; border: 1px dashed #aaa; padding: 5px 10px; border-radius: 6px; font-size: 0.9rem; color: #555; cursor: pointer;">
                + 新增項目
            </button>

            <div class="modal-btns">
                <button class="modal-btn btn-cancel"
                    onclick="document.getElementById('bill-scan-modal').style.display='none'; document.body.style.overflow='';">取消</button>
                <button class="modal-btn btn-confirm" onclick="confirmBillScan()">確定加入</button>
            </div>
        </div>
    </div>

    <!-- [新增] 帳單辨識 Modal 樣式 -->
    <style>
        .bill-item-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .bill-item-row:last-child {
            border-bottom: none;
        }

        .bill-check {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .bill-name-input {
            flex: 2;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 0;
        }

        .bill-amount-input {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 0;
            text-align: right;
        }

        .bill-remove-btn {
            color: #ef4444;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0 4px;
        }
    </style>

    <script>
        // [新增] 帳單掃描與辨識邏輯

        async function handleBillFileChange(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 清空 Input 避免重複觸發
            event.target.value = '';

            showGlobalLoading("正在分析收據...");

            try {
                // 1. 壓縮圖片
                const base64 = await compressImageForNote(file, 1024, 0.8);
                // 去除 data:image/jpeg;base64, 前綴
                const cleanBase64 = base64.split(',')[1];

                // 2. 呼叫 Gemini
                const prompt = `
                    你是一個收據辨識助手。請分析這張收據圖片，並提取「交易日期」與所有「消費項目」。
                    
                    規則：
                    1. 只提取具體消費品項，不要總計(Total)、稅金(Tax)或找零。
                    2. 若品項名稱為日文或英文，請翻譯成「繁體中文」 (若不確定則保留原文)。
                    3. 金額請只保留數字。
                    4. 辨識收據上的日期，格式為 YYYY-MM-DD (若找不到或不確定則回傳 null)。
                    5. 回傳格式必須是單純的 JSON Object，不要 Markdown 標記，格式如下：
                       {
                         "date": "2024-01-01",
                         "items": [{"name": "品項A", "amount": 100}, {"name": "品項B", "amount": 550}]
                       }
                `;

                const resultText = await getGeminiResponse(prompt, cleanBase64);

                // 3. 解析 JSON
                let items = [];
                let detectedDate = null;

                try {
                    // 嘗試清理 Markdown 代碼塊
                    let cleanJson = resultText.replace(/```json/g, '').replace(/```/g, '').trim();
                    const parsed = JSON.parse(cleanJson);

                    if (Array.isArray(parsed)) {
                        items = parsed; // 相容舊格式 (雖然 Prompt 改了，但以防萬一)
                    } else if (parsed && typeof parsed === 'object') {
                        items = parsed.items || [];
                        detectedDate = parsed.date;
                    }
                } catch (e) {
                    console.error("JSON Parse Error:", e);
                    alert("辨識結果格式錯誤，請重試");
                    hideGlobalLoading();
                    return;
                }

                if (!Array.isArray(items)) {
                    alert("辨識結果格式不符，請重試");
                    hideGlobalLoading();
                    return;
                }

                // 4. 顯示結果 Modal
                renderBillScanResult(items);
                document.getElementById('bill-scan-modal').style.display = 'flex';

                // [新增] 初始化日期與付款方式
                const bsDate = document.getElementById('bill-scan-date');
                if (bsDate) {
                    if (detectedDate) {
                        bsDate.value = detectedDate;
                    } else {
                        // 若沒抓到，預設為今天
                        const today = new Date();
                        const yyyy = today.getFullYear();
                        const mm = String(today.getMonth() + 1).padStart(2, '0');
                        const dd = String(today.getDate()).padStart(2, '0');
                        bsDate.value = `${yyyy}-${mm}-${dd}`;
                    }
                }

                const bsPay = document.getElementById('bill-scan-payment-method');
                if (bsPay) bsPay.value = 'card'; // 掃描通常是刷卡單? 或保持預設

                // [新增] 鎖定背景捲動
                document.body.style.overflow = 'hidden';

            } catch (e) {
                console.error("Scan Error:", e);
                alert("辨識失敗：" + e.message);
            } finally {
                hideGlobalLoading();
            }
        }

        function renderBillScanResult(items) {
            const list = document.getElementById('bill-scan-list');
            list.innerHTML = '';

            items.forEach(item => {
                addManualBillItem(item.name, item.amount);
            });
            // 如果沒東西，預設加一列
            if (items.length === 0) addManualBillItem();
        }

        function addManualBillItem(name = '', amount = '') {
            const list = document.getElementById('bill-scan-list');
            const div = document.createElement('div');
            div.className = 'bill-item-row';
            div.innerHTML = `
                <input type="checkbox" class="bill-check" checked>
                <input type="text" class="bill-name-input" placeholder="品項名稱" value="${name}">
                <input type="number" class="bill-amount-input" placeholder="金額" value="${amount}">
                <div class="bill-remove-btn" onclick="this.parentElement.remove()">×</div>
            `;
            list.appendChild(div);
        }

        async function confirmBillScan() {
            const rows = document.querySelectorAll('.bill-item-row');
            let entries = [];

            // [新增] 讀取全域日期與付款方式
            const dateVal = document.getElementById('bill-scan-date')?.value || new Date().toISOString().split('T')[0];
            const payVal = document.getElementById('bill-scan-payment-method')?.value || 'cash';
            const pType = document.getElementById('bill-scan-pay-type')?.value || 'public';

            // 1. 蒐集資料
            rows.forEach(row => {
                const checked = row.querySelector('.bill-check').checked;
                // [修正] 確保去除前後空白
                const name = row.querySelector('.bill-name-input').value.trim();
                const amount = row.querySelector('.bill-amount-input').value.trim();

                if (checked && name && amount) {
                    entries.push({ item: name, amount: parseInt(amount) });
                }
            });

            if (entries.length === 0) {
                alert("沒有選取任何有效項目");
                return;
            }

            // 2. 批次送出
            document.getElementById('bill-scan-modal').style.display = 'none';
            // [新增] 解除背景捲動鎖定
            document.body.style.overflow = '';

            showGlobalLoading("正在儲存 " + entries.length + " 筆帳目...");

            try {
                // [修正] 採用與 handleLedgerSubmit 完全一致的使用者抓取邏輯
                // 這樣能避免抓到 "請登入" 或是錯誤的文字
                let userName = localStorage.getItem('last_user_name');
                if (!userName && window.TEMP_USER_NAME) userName = window.TEMP_USER_NAME.trim();
                if (!userName) {
                    const el = document.getElementById('custom-user-name') || document.querySelector('.user-name-input');
                    if (el) userName = el.value.trim();
                }
                if (!userName || userName === 'undefined' || userName === 'null' || userName === '請登入') userName = '匿名';

                let avatar = localStorage.getItem('last_user_emoji') || '🦁';
                // 如果 localStorage 沒東西，才試著抓 DOM
                if (avatar === '🦁') {
                    const domAvatar = document.getElementById('display-current-avatar').innerText;
                    if (domAvatar && domAvatar !== '👤') avatar = domAvatar;
                }

                // 循序送出 (Serial) 並加入延遲，避免後端鎖死 (Script Lock)
                let successCount = 0;
                for (const entry of entries) {
                    await submitFinanceEntrySimple(entry.item, entry.amount, avatar, userName, dateVal, payVal, pType);
                    successCount++;
                    // [新增] 延遲 300ms
                    await new Promise(r => setTimeout(r, 300));
                }

                alert(`成功加入 ${successCount} 筆項目！`);

                // 重新整理列表
                syncLedgerData();

            } catch (e) {
                console.error("Batch Submit Error:", e);
                alert("儲存過程發生錯誤：" + e.message);
                syncLedgerData();
            } finally {
                hideGlobalLoading();
            }
        }

        // [提取] 獨立的記帳送出函式 (修正版：增加 payType 參數)
        async function submitFinanceEntrySimple(item, amount, avatar, userName, dateStr, paymentMethod, payType) {
            const url = getKey('gas_url');
            const token = getKey('gas_token');
            if (!url || !token) throw new Error("API URL/Token Missing");

            // 1. 計算匯率 (比照 handleLedgerSubmit)
            let finalRate = 0.21;
            const manualRateEl = document.getElementById('calc-rate');
            if (manualRateEl && parseFloat(manualRateEl.value) > 0) {
                finalRate = parseFloat(manualRateEl.value);
            } else {
                try {
                    const cached = localStorage.getItem('live_exchange_rate_cache');
                    if (cached) {
                        const parsed = JSON.parse(cached);
                        if (parsed.rate > 0) finalRate = parsed.rate;
                    }
                } catch (e) { }
            }

            const amountJpy = parseFloat(amount) || 0;
            const amountTwd = amountJpy > 0 ? Math.round(amountJpy * finalRate) : 0;

            // 2. 建構標準 Payload
            const payload = {
                action: 'upload', // 修正為正確的 action
                token: token,
                type: 'finance',
                // 產生 UUID
                id: (window.crypto && window.crypto.randomUUID) ? window.crypto.randomUUID() : ('id-' + Date.now() + Math.random().toString(36).substr(2, 5)),
                userName: userName,
                userAvatar: avatar,
                date: dateStr || new Date().toISOString().split('T')[0], // 使用傳入的日期
                timestamp: (() => {
                    // 簡易構造 timestamp
                    if (dateStr) {
                        const now = new Date();
                        const [y, m, d] = dateStr.split('-').map(Number);
                        return new Date(y, m - 1, d, now.getHours(), now.getMinutes()).toISOString();
                    }
                    return new Date().toISOString();
                })(),
                paymentMethod: paymentMethod || 'cash',
                paymentType: (payType === 'public' ? 'Public' : userName), // [新增]
                rate: String(finalRate),
                twdAmount: String(amountTwd),
                item: item,
                content: item, // 為了相容性，兩者都填
                amount: String(amountJpy),
                images: [] // 掃描項目暫不附圖
            };

            // 3. 發送請求
            const resp = await fetch(url, { method: 'POST', body: JSON.stringify(payload) });
            const result = await resp.json();

            if (result.status !== 'success' && result.result !== 'success') {
                throw new Error(result.message || "Submit Failed");
            }
        }

        // [新增] 取消編輯模式
        function cancelEditMode() {
            window.editingId = null;

            // 1. 重置日期為今天
            // 使用本地時區，避免 ISO UTC 誤差
            const today = new Date();
            const y = today.getFullYear();
            const m = String(today.getMonth() + 1).padStart(2, '0');
            const d = String(today.getDate()).padStart(2, '0');
            const todayStr = `${y}-${m}-${d}`;

            const dateInput = document.getElementById('ledger-note-date');
            if (dateInput) dateInput.value = todayStr;

            // 2. 清空輸入框
            if (document.getElementById('ledger-note-content')) document.getElementById('ledger-note-content').value = '';
            if (document.getElementById('ledger-item')) document.getElementById('ledger-item').value = '';
            if (document.getElementById('ledger-amount')) document.getElementById('ledger-amount').value = '';

            // [新增] 重置 Finance 日期與付款
            if (document.getElementById('ledger-date')) document.getElementById('ledger-date').value = todayStr;
            if (document.getElementById('ledger-payment-method')) document.getElementById('ledger-payment-method').value = 'cash';

            // 3. 隱藏 Cancel 按鈕
            const cBtnNote = document.getElementById('btn-cancel-edit-note');
            if (cBtnNote) cBtnNote.style.display = 'none';

            const cBtnFinance = document.getElementById('btn-cancel-edit-finance');
            if (cBtnFinance) cBtnFinance.style.display = 'none';

            // 4. 還原按鈕圖示 (Note)
            const btnNote = document.querySelector('#ledger-note-fields .btn-submit-ledger');
            if (btnNote) {
                btnNote.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2563EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>`;
            }

            // 5. 還原按鈕圖示 (Finance)
            const btnFinance = document.querySelector('#ledger-finance-fields .btn-submit-ledger');
            if (btnFinance) {
                btnFinance.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2563EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>`;
            }

            // 6. 清空圖片預覽
            window.currentNoteImages = [];
            if (typeof renderImagePreviews === 'function') renderImagePreviews();

            // 7. 更新按鈕狀態
            if (typeof updateLedgerSubmitState === 'function') updateLedgerSubmitState();

            // [新增] 強制格式化日期 (縮短顯示)
            if (typeof formatCompactDate === 'function') {
                formatCompactDate(document.getElementById('ledger-date'));
                formatCompactDate(document.getElementById('ledger-note-date'));
            }
        }

        // [新增] 緊湊日期顯示邏輯 (YYYY/M/D)
        function initCompactDateInput(id) {
            const el = document.getElementById(id);
            if (!el) return;

            // 初始格式化
            formatCompactDate(el);

            // 聚焦時切換回原生 Date Picker
            el.addEventListener('focus', function () {
                this.type = 'date';

                // 還原 ISO 格式 (YYYY-MM-DD) 給 Picker
                if (this.dataset.isoValue) {
                    this.value = this.dataset.isoValue;
                }
            });

            // 失焦或改變時切換回 Text 並格式化
            el.addEventListener('blur', function () {
                handleDateBlur(this);
            });
            el.addEventListener('change', function () {
                handleDateBlur(this);
            });
        }

        function handleDateBlur(el) {
            if (el.value) {
                // 如果是 ISO 格式，存起來
                if (el.value.includes('-')) {
                    el.dataset.isoValue = el.value;
                }
            } else {
                // 如果清空了，也許要保留原值或設為今天？
                // 這裡暫時保持原樣
            }

            el.type = 'text';
            formatCompactDate(el);
        }

        function formatCompactDate(el) {
            if (!el) return;

            // 如果當前是 date type，先取值存起來
            if (el.type === 'date' && el.value) {
                el.dataset.isoValue = el.value;
            }

            const rawVal = el.dataset.isoValue || el.value;
            if (!rawVal) return;

            // 嘗試解析 YYYY-MM-DD
            if (rawVal.includes('-')) {
                const parts = rawVal.split('-');
                if (parts.length === 3) {
                    const y = parts[0];
                    const m = parseInt(parts[1], 10);
                    const d = parseInt(parts[2], 10);
                    // 切換為 Text
                    el.type = 'text';
                    el.value = `${y}/${m}/${d}`;
                }
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            initCompactDateInput('ledger-date');
            initCompactDateInput('ledger-note-date');

            // [新增] 自動展開行程
            autoExpandItinerary();

            // [修正] 改用靜默重試機制 (Silent Retry) 確保資料同步
            initLedgerSyncWithRetry();

            // [新增] 啟動時立即檢查登入狀態 (持久化)
            if (typeof checkUserSession === 'function') {
                checkUserSession();
            }
        });

        // [新增] 靜默重試同步機制
        // 嘗試同步最多 3 次 (delay: 2s, 5s, 10s)
        function initLedgerSyncWithRetry(attempt = 0) {
            const delays = [2000, 5000, 10000]; // 第一次失敗後等 2秒，第二次等 5秒...

            if (typeof syncLedgerData !== 'function') {
                console.error("[Init] syncLedgerData not found, aborting.");
                return;
            }

            console.log(`[Init] Attempting sync (${attempt + 1})...`);

            syncLedgerData().then(success => {
                if (success) {
                    console.log("[Init] Sync success!");
                    // [新增] 初始化通知狀態
                    if (typeof initNotificationState === 'function') {
                        initNotificationState();
                    }
                } else {
                    console.warn(`[Init] Sync failed or keys missing.`);
                    if (attempt < delays.length) {
                        const delay = delays[attempt];
                        console.log(`[Init] Retrying in ${delay / 1000}s...`);
                        setTimeout(() => initLedgerSyncWithRetry(attempt + 1), delay);
                    } else {
                        console.error("[Init] All sync attempts failed.");
                    }
                }
            }).catch(e => {
                console.error("[Init] Sync error:", e);
                // Error case also retries
                if (attempt < delays.length) {
                    const delay = delays[attempt];
                    setTimeout(() => initLedgerSyncWithRetry(attempt + 1), delay);
                }
            });
        }

        // [新增] 自動展開行程邏輯
        function autoExpandItinerary() {
            const today = new Date();
            const y = today.getFullYear();
            const m = String(today.getMonth() + 1).padStart(2, '0');
            const d = String(today.getDate()).padStart(2, '0');
            const todayStr = `${y}-${m}-${d}`;

            console.log("Auto Expand Check:", todayStr);

            // 1. 行程前 (< 04/18) -> 展開 Check List
            if (todayStr < "2026-04-18") {
                const clContainer = document.getElementById('checklist-container');
                if (clContainer) {
                    // 直接操作 class 與 style，模擬打開狀態
                    clContainer.style.display = 'block';
                    // 若有 CSS transition class (如 show)，也可加上:
                    clContainer.classList.add('show');

                    const clHeader = document.querySelector('.checklist-card-header');
                    if (clHeader) {
                        const icon = clHeader.querySelector('.toggle-icon');
                        if (icon) {
                            icon.style.transform = 'rotate(180deg)';
                            icon.style.color = 'var(--primary)';
                        }
                    }
                }
            }
            // 2. Day 1 (04/18)
            else if (todayStr === "2026-04-18") {
                const t1 = document.getElementById('toggle-d1');
                if (t1) toggleTimeline('d1', t1);
            }
            // 3. Day 2 (04/19)
            else if (todayStr === "2026-04-19") {
                const t2 = document.getElementById('toggle-d2');
                if (t2) toggleTimeline('d2', t2);
            }
            // 4. Day 3 (04/20)
            else if (todayStr === "2026-04-20") {
                const t3 = document.getElementById('toggle-d3');
                if (t3) toggleTimeline('d3', t3);
            }
        }

        // [New] Announcement Logic
        let isAnnouncementMode = false;

        // [New] 修改為集中管理的模式切換函式
        function toggleAnnouncementMode(btn) {
            setAnnouncementMode(!isAnnouncementMode);
        }

        // [New] 集中管理公告模式狀態與 UI
        function setAnnouncementMode(enabled) {
            isAnnouncementMode = enabled;
            updatePinButtonState();

            const noteInput = document.getElementById('ledger-note-content');
            if (noteInput) {
                if (isAnnouncementMode) {
                    noteInput.placeholder = "輸入公告內容...";
                } else {
                    noteInput.placeholder = "寫下旅程點滴...";
                }
            }
        }

        // [New] 更新圖釘按鈕狀態 (連動輸入框內容)
        function updatePinButtonState() {
            const btn = document.getElementById('btn-pin-note');
            if (!btn) return;

            const noteInput = document.getElementById('ledger-note-content');
            const hasText = noteInput && noteInput.value.trim().length > 0;
            const icon = btn.querySelector('svg');

            if (isAnnouncementMode) {
                if (hasText) {
                    // 模式開啟且有文字 -> 亮紅色 (Filled)
                    btn.style.color = '#EF4444';
                    if (icon) icon.style.fill = '#FEE2E2';
                } else {
                    // 模式開啟但無文字 -> 淡紅色 (Outline) 表示模式啟用中
                    btn.style.color = '#FCA5A5';
                    if (icon) icon.style.fill = 'none';
                }
            } else {
                // 模式關閉 -> 灰色
                btn.style.color = '#9CA3AF';
                if (icon) icon.style.fill = 'none';
            }
        }

        // [New] 綁定輸入框監聽器
        document.addEventListener('DOMContentLoaded', () => {
            const noteInput = document.getElementById('ledger-note-content');
            if (noteInput) {
                noteInput.addEventListener('input', updatePinButtonState);
            }
        });

        function renderAnnouncementMarquee(data) {
            const container = document.getElementById('announcement-marquee');
            const content = document.getElementById('marquee-content');
            if (!container || !content) return;

            // Filter for announcements (notes containing [公告] or #公告)
            const announcements = data.filter(item => {
                if (item.type !== 'note') return false;

                // [修正] 強制轉為字串，避免純數字導致 .includes 報錯
                const c = String(item.content || '');
                const i = String(item.item || '');

                return (c.includes('[公告]') || c.includes('#公告')) ||
                    (i.includes('[公告]') || i.includes('#公告'));
            }).sort((a, b) => new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date));

            if (announcements.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'flex';

            // Build marquee text
            // Build marquee text
            const parts = announcements.map(item => {
                let dateStr = '';
                try {
                    const d = new Date(item.timestamp || item.date);
                    const mm = String(d.getMonth() + 1).padStart(2, '0');
                    const dd = String(d.getDate()).padStart(2, '0');
                    dateStr = `[${mm}/${dd}]`;
                } catch (e) { }

                // Parse User Name
                let userName = '成員';
                try {
                    if (typeof item.user === 'object' && item.user !== null) {
                        userName = item.user.name || '成員';
                    } else if (typeof item.user === 'string') {
                        if (item.user.trim().startsWith('{')) {
                            const uObj = JSON.parse(item.user);
                            userName = uObj.name || '成員';
                        } else {
                            userName = item.user;
                        }
                    }
                } catch (e) { }

                const rawText = item.content || item.item || '';
                const cleanText = rawText.replace(/\[公告\]|#公告/g, '').trim();

                // [Fix] If text is empty (e.g. only image + tag), skip it.
                if (!cleanText) return '';

                // Format: Date Name： Content
                return `<span style="font-weight:700; color:#B45309; margin-right:4px;">${dateStr}</span><span style="font-weight:700; color:#D97706; margin-right:4px;">${userName}：</span><span style="color:#92400E;">${cleanText}</span>`;
            }).filter(part => part !== ''); // Remove empty parts

            // Using a simple join with spacing
            content.innerHTML = parts.join('<span style="margin: 0 20px; color:#FCD34D;">|</span>');
        }

    </script>
    <!-- [新增] OpenStreetMap 初始化腳本 -->
    <script>
        let osmMap = null;
        let osmMarker = null;

        // --- Location Sharing & Incognito Logic ---
        const CONFIG = {
            get GAS_URL() { return getKey('gas_url'); },
            get AUTH_TOKEN() { return getKey('gas_token'); }
        };

        let isIncognito = localStorage.getItem('is_incognito') === 'true';
        let otherUserMarkers = {};

        // Init Incognito Button UI
        function updateIncognitoUI() {
            const btn = document.getElementById('btn-incognito');
            const iconVisible = document.getElementById('icon-visible');
            const iconInvisible = document.getElementById('icon-invisible');

            if (!btn || !iconVisible || !iconInvisible) return;

            if (isIncognito) {
                iconVisible.style.display = 'none';
                iconInvisible.style.display = 'block';
                btn.style.color = '#EF4444';
                btn.style.borderColor = '#FECACA';
                btn.style.background = '#FEF2F2';
            } else {
                iconVisible.style.display = 'block';
                iconInvisible.style.display = 'none';
                btn.style.color = '#10B981';
                btn.style.borderColor = '#D1FAE5';
                btn.style.background = '#ECFDF5';
            }
        }

        // Bind Button Event (Delayed to ensure DOM)
        setTimeout(() => {
            const btnIncognito = document.getElementById('btn-incognito');
            if (btnIncognito) {
                updateIncognitoUI();
                btnIncognito.addEventListener('click', () => {
                    isIncognito = !isIncognito;
                    localStorage.setItem('is_incognito', isIncognito);
                    updateIncognitoUI();

                    const msg = isIncognito ? "已開啟隱身模式 (停止分享)" : "已關閉隱身模式 (開始分享)";
                    if (typeof showToast === 'function') showToast(msg);
                    else alert(msg);

                    // [New] 即時更新自己的地圖標記外觀
                    if (osmMarker && window.appCache && window.appCache['my_location_combined']) {
                        const { lat, lon } = window.appCache['my_location_combined'].data;
                        const newIcon = getAvatarIcon();
                        osmMarker.setIcon(newIcon);
                    }

                    if (!isIncognito && window.appCache && window.appCache['my_location_combined']) {
                        const { lat, lon } = window.appCache['my_location_combined'].data;
                        sendLocationToBackend(lat, lon);
                    }
                });
            }
        }, 500);

        // Send Location to Backend
        window.sendLocationToBackend = function (lat, lng) {
            if (isIncognito) {
                console.log("[Location] Incognito mode is ON. Skip sending.");
                return;
            }

            const userName = localStorage.getItem('last_user_name') || 'Unknown';
            const userAvatar = localStorage.getItem('last_user_emoji') || '👤';
            let userId = localStorage.getItem('user_id');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
                localStorage.setItem('user_id', userId);
            }

            const payload = {
                type: 'location',
                id: userId,
                userName: userName,
                userAvatar: userAvatar,
                lat: lat,
                lon: lng,
                date: new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '/'),
                timestamp: new Date().toISOString(),
                token: CONFIG.AUTH_TOKEN
            };

            fetch(CONFIG.GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(() => {
                console.log("[Location] Sent successfully.");
            }).catch(err => {
                console.error("[Location] Send failed:", err);
            });
        };

        // Fetch and Render Other Users
        window.fetchAndRenderLocations = function () {
            console.log("[Location] Fetching other users...");

            fetch(CONFIG.GAS_URL + '?token=' + CONFIG.AUTH_TOKEN)
                .then(res => res.json())
                .then(data => {
                    if (data.status !== 'success') return;

                    const myUserId = localStorage.getItem('user_id');
                    const latestLocations = {};

                    data.data.forEach(item => {
                        if (!item.lat || !item.lon) return;
                        const uid = String(item.id);
                        if (uid === String(myUserId)) return;

                        const time = new Date(item.timestamp).getTime();
                        if (!latestLocations[uid] || time > latestLocations[uid].time) {
                            latestLocations[uid] = { ...item, time: time };
                        }
                    });

                    Object.values(latestLocations).forEach(loc => {
                        renderOtherUserMarker(loc);
                    });

                    // [新增] 自動調整視野以顯示所有使用者
                    const bounds = [];
                    // 1. 加入自己的位置
                    if (osmMarker) bounds.push(osmMarker.getLatLng());
                    // 2. 加入其他人的位置
                    Object.values(otherUserMarkers).forEach(m => bounds.push(m.getLatLng()));

                    if (bounds.length > 0) {
                        try {
                            osmMap.fitBounds(bounds, { padding: [50, 50], maxZoom: 16 });
                        } catch (e) {
                            console.warn("[OSM] fitBounds error:", e);
                        }
                    }

                }).catch(e => console.error("[Location] Fetch failed:", e));
        };

        function renderOtherUserMarker(loc) {
            if (!osmMap) return;

            const uid = loc.id;
            const name = loc.user.name || '夥伴';
            const avatar = loc.user ? (loc.user.avatar || '👤') : '👤';
            const lat = Number(loc.lat);
            const lng = Number(loc.lon);
            const timeStr = getTimeAgo(loc.time);

            const icon = L.divIcon({
                className: 'other-user-marker',
                html: `<div style="
                    background: white; 
                    border: 2px solid #10B981; 
                    border-radius: 50%; 
                    width: 28px; 
                    height: 28px; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    font-size: 16px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    opacity: 0.9;
                ">${avatar}</div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 16],
                popupAnchor: [0, -18]
            });

            if (otherUserMarkers[uid]) {
                otherUserMarkers[uid].setLatLng([lat, lng]);
                otherUserMarkers[uid].setPopupContent(`${name} (${timeStr}在這裡)`);
            } else {
                const marker = L.marker([lat, lng], { icon: icon }).addTo(osmMap);
                marker.bindPopup(`${name} (${timeStr}在這裡)`);
                otherUserMarkers[uid] = marker;
            }
        }

        // Auto-sync loop
        setInterval(() => {
            if (window.appCache && window.appCache['my_location_combined']) {
                const { lat, lon } = window.appCache['my_location_combined'].data;
                window.sendLocationToBackend(lat, lon);
            }
            if (osmMap) window.fetchAndRenderLocations();
        }, 300000);

        function initOSM() {
            // 防止重複初始化
            if (osmMap) return;

            const mapContainer = document.getElementById('ai-osm-map');
            if (!mapContainer) return;

            // 預設視野：東京車站
            // 預設視野：東京車站
            let startLat = 35.6812;
            let startLng = 139.7671;
            let startZoom = 13;
            let hasLocation = false;

            // [新增] 嘗試從天氣快取取得位置
            if (window.appCache && window.appCache['my_location_combined']) {
                const d = window.appCache['my_location_combined'].data;
                if (d.lat && d.lon) {
                    startLat = d.lat;
                    startLng = d.lon;
                    startZoom = 16; // 有定位時放大一點
                    hasLocation = true;
                    console.log("[OSM] 使用天氣快取定位:", startLat, startLng);
                }
            }

            try {
                // 初始化地圖
                osmMap = L.map('ai-osm-map').setView([startLat, startLng], startZoom);

                // 加入 OpenStreetMap 圖層
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(osmMap);

                // [新增] 加入比例尺
                L.control.scale().addTo(osmMap);

                // 加入標記 (不可拖曳)
                const startIcon = getAvatarIcon();
                osmMarker = L.marker([startLat, startLng], { icon: startIcon, draggable: false }).addTo(osmMap);

                // 如果有自動定位，綁定 Popup (但不自動顯示)
                if (hasLocation) {
                    const userName = localStorage.getItem('last_user_name') || '使用者';
                    const timeStr = getTimeAgo(window.appCache['my_location_combined'].timestamp || Date.now());
                    osmMarker.bindPopup(`${userName} (${timeStr}在這裡)`);
                }

                if (typeof window.fetchAndRenderLocations === 'function') {
                    window.fetchAndRenderLocations();
                }

                console.log("[OSM] Map initialized.");
            } catch (e) {
                console.error("[OSM] Init failed:", e);
            }
        }

        // [New] Helper to get avatar icon
        function getAvatarIcon() {
            const avatar = localStorage.getItem('last_user_emoji') || '👤';

            // Incognito: Use SVG Icon (Eye Off)
            if (typeof isIncognito !== 'undefined' && isIncognito) {
                return L.divIcon({
                    className: 'custom-avatar-marker incognito',
                    html: `<div style="
                        background: #FEF2F2; 
                        border: 2px solid #EF4444; 
                        border-radius: 50%; 
                        width: 32px; 
                        height: 32px; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                        color: #EF4444;
                    ">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                           <path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-4.01.7l2.16 2.16C10.5 7.17 11.23 7 12 7zM2 4.27l2.28 2.28.46.46A11.804 11.804 0 0 0 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>
                        </svg>
                    </div>`,
                    iconSize: [36, 36],
                    iconAnchor: [18, 18],
                    popupAnchor: [0, -20]
                });
            }

            // Normal: Blue border (#5A92E8) + Avatar
            return L.divIcon({
                className: 'custom-avatar-marker',
                html: `<div style="
                    background: white; 
                    border: 2px solid #5A92E8; 
                    border-radius: 50%; 
                    width: 32px; 
                    height: 32px; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    font-size: 20px;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                ">${avatar}</div>`,
                iconSize: [36, 36],
                iconAnchor: [18, 18],
                popupAnchor: [0, -20]
            });
        }

        // [新增] 時間計算 helper
        function getTimeAgo(timestamp) {
            if (!timestamp) return "剛剛";
            const diff = Date.now() - timestamp;
            const minutes = Math.floor(diff / 60000);
            if (minutes < 1) return "剛剛";
            if (minutes < 60) return `${minutes}分鐘前`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}小時前`;
            return `${Math.floor(hours / 24)}天前`;
        }

        // [新增] 全域更新地圖位置函式 (供天氣模組呼叫)
        window.updateMapLocation = function (lat, lng, timestamp) {
            if (!osmMap) return; // 地圖還沒初始化，下次 initOSM 會自己抓 cache

            console.log("[OSM] updateMapLocation called:", lat, lng, timestamp);

            try {
                // 1. 移動視野
                osmMap.setView([lat, lng], 16);

                // 2. 移動標記
                const avatarIcon = getAvatarIcon();
                if (osmMarker) {
                    osmMarker.setIcon(avatarIcon);
                    osmMarker.setLatLng([lat, lng]);
                } else {
                    osmMarker = L.marker([lat, lng], { icon: avatarIcon, draggable: false }).addTo(osmMap);
                }

                // 3. 設定 Popup (點擊顯示，點擊地圖其他處關閉)
                const userName = localStorage.getItem('last_user_name') || '使用者';
                const timeStr = getTimeAgo(timestamp || Date.now());
                const popupContent = `${userName} (${timeStr}在這裡)`;

                // 綁定 Popup 到標記上，不自動開啟
                osmMarker.bindPopup(popupContent);


            } catch (e) {
                console.error("[OSM] Update location failed:", e);
            }
        };

        // [New] Refresh Logic
        window.refreshMapLocation = function () {
            if (!osmMap) return;

            // Loading Animation
            const btn = document.querySelector('.btn-refresh-map svg');
            if (btn) btn.style.transformOrigin = 'center';
            if (btn) btn.style.animation = 'spin 1s linear infinite';
            // Add keyframes if not exists (or rely on existing) - adding inline style for safety
            if (!document.getElementById('style-spin')) {
                const style = document.createElement('style');
                style.id = 'style-spin';
                style.innerHTML = `@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`;
                document.head.appendChild(style);
            }

            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    // Update Map
                    const now = Date.now();
                    window.updateMapLocation(lat, lng, now);

                    // Update Cache
                    if (window.appCache && window.appCache['my_location_combined']) {
                        window.appCache['my_location_combined'].data.lat = lat;
                        window.appCache['my_location_combined'].data.lon = lng;
                        window.appCache['my_location_combined'].timestamp = now; // Save timestamp
                    }

                    // [New] Send to Backend
                    if (typeof sendLocationToBackend === 'function') {
                        sendLocationToBackend(lat, lng);
                    }
                    // [New] Fetch Others
                    if (typeof window.fetchAndRenderLocations === 'function') {
                        window.fetchAndRenderLocations();
                    }

                    // Stop Animation
                    if (btn) btn.style.animation = '';

                }, error => {
                    alert("無法重新取得位置，請確認 GPS 權限。");
                    if (btn) btn.style.animation = '';
                }, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            } else {
                alert("瀏覽器不支援定位。");
                if (btn) btn.style.animation = '';
            }
        };

        function locateUserOnMap() {
            if (!osmMap) {
                initOSM();
            }

            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    // 移動地圖與標記
                    osmMap.setView([lat, lng], 16);
                    if (osmMarker) osmMarker.setLatLng([lat, lng]);

                    // 顯示 Popup
                    L.popup()
                        .setLatLng([lat, lng])
                        .setContent("📍 您在這裡")
                        .openOn(osmMap);

                }, error => {
                    alert("無法取得您的位置，請確認瀏覽器權限。");
                    console.error("[OSM] Geolocation error:", error);
                });
            } else {
                alert("您的瀏覽器不支援定位功能。");
            }
        }

        // [重要] 修正 Leaflet 在隱藏 Tab 初始化時大小錯誤的問題
        // 監聽 Tab 切換，當切換到 AI Tab 時重繪地圖
        document.addEventListener('DOMContentLoaded', () => {
            const aiTabBtn = document.querySelector('button[onclick="switchTab(\'ai\')"]');
            // 或是您原本的 Tab 切換邏輯

            // 由於您的 Tab 切換是 onclick="switchTab('ai')"，我們可以用 MutationObserver 監聽 class 變化
            // 或者直接 hook switchTab 函式。
            // 這裡採用最簡單的 hook 方式：

            const originalSwitchTab = window.switchTab;
            window.switchTab = function (arg) {
                if (originalSwitchTab) originalSwitchTab(arg);

                // 判斷是否切換到 AI 分頁
                // 1. arg 是字串 'ai'
                // 2. arg 是 DOM 元素且 data-target="view-ai"
                let isAi = (arg === 'ai');
                if (!isAi && arg && arg.getAttribute) {
                    const target = arg.getAttribute('data-target');
                    if (target === 'view-ai') isAi = true;
                }

                if (isAi) {
                    // 延遲一點點確保 display: block 已套用
                    setTimeout(() => {
                        initOSM();
                        if (osmMap) osmMap.invalidateSize(); // [關鍵] 修正大小
                    }, 200);
                }
            };
        });
    </script>
    <script>
        (function () {
            // 1. 啟動條件：網址帶有 ?dev=true 或 localStorage 設定為 true
            // 您可以在瀏覽器網址列加上 ?dev=true 來開啟
            // 或者在 Console 輸入 localStorage.setItem('isDev', 'true') 然後重新整理
            const isDev = new URLSearchParams(window.location.search).has('dev') || localStorage.getItem('isDev') === 'true';

            if (!isDev) return;

            console.log("🛠️ Dev Mode: Visual Inspector Enabled");

            // 建立控制按鈕
            const btn = document.createElement('button');
            btn.innerText = '🔍 Inspector Off';
            btn.style.position = 'fixed';
            btn.style.bottom = '10px';
            btn.style.left = '10px';
            btn.style.zIndex = '999999';
            btn.style.padding = '8px 12px';
            btn.style.background = '#333';
            btn.style.color = '#fff';
            btn.style.border = '1px solid #555';
            btn.style.borderRadius = '4px';
            btn.style.cursor = 'pointer';
            btn.style.fontFamily = 'monospace';
            document.body.appendChild(btn);

            let isActive = false;
            let hoveredEl = null;

            // 建立標示框
            const outline = document.createElement('div');
            outline.style.position = 'fixed';
            outline.style.border = '2px solid #EF4444';
            outline.style.background = 'rgba(239, 68, 68, 0.1)';
            outline.style.pointerEvents = 'none'; // 讓滑鼠穿透
            outline.style.zIndex = '999998';
            outline.style.display = 'none';
            outline.style.transition = 'all 0.1s ease'; // 平滑移動
            document.body.appendChild(outline);

            // 建立提示 Toast
            const toast = document.createElement('div');
            toast.style.position = 'fixed';
            toast.style.top = '20px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.background = 'rgba(0,0,0,0.8)';
            toast.style.color = '#fff';
            toast.style.padding = '8px 16px';
            toast.style.borderRadius = '20px';
            toast.style.zIndex = '999999';
            toast.style.display = 'none';
            toast.style.fontSize = '12px';
            document.body.appendChild(toast);

            function showToast(msg) {
                toast.innerText = msg;
                toast.style.display = 'block';
                setTimeout(() => { toast.style.display = 'none'; }, 2000);
            }

            // 開關切換
            btn.onclick = () => {
                isActive = !isActive;
                btn.innerText = isActive ? '🔍 Inspector ON' : '🔍 Inspector Off';
                btn.style.background = isActive ? '#EF4444' : '#333';
                if (!isActive) {
                    outline.style.display = 'none';
                    hoveredEl = null;
                }
            };

            // 滑鼠移動：移動紅框
            document.addEventListener('mousemove', (e) => {
                if (!isActive) return;

                const el = document.elementFromPoint(e.clientX, e.clientY);
                if (!el || el === outline || el === btn || el === toast) return;

                if (hoveredEl !== el) {
                    hoveredEl = el;
                    const rect = el.getBoundingClientRect();
                    outline.style.display = 'block';
                    outline.style.top = rect.top + 'px';
                    outline.style.left = rect.left + 'px';
                    outline.style.width = rect.width + 'px';
                    outline.style.height = rect.height + 'px';
                }
            });

            // 點擊：複製 Selector
            document.addEventListener('click', (e) => {
                if (!isActive) return;
                if (e.target === btn) return;

                e.preventDefault();
                e.stopPropagation();

                const el = e.target;
                const selector = getCssSelector(el);

                // 複製到剪貼簿
                navigator.clipboard.writeText(selector).then(() => {
                    showToast(`Copied: ${selector}`);
                    console.log(`[Inspector] Selected:`, el, `\nSelector: ${selector}`);
                }).catch(err => {
                    console.error('Copy failed', err);
                    showToast(`Copy Failed: ${selector}`);
                });

                // 閃爍效果
                outline.style.background = 'rgba(239, 68, 68, 0.4)';
                setTimeout(() => {
                    outline.style.background = 'rgba(239, 68, 68, 0.1)';
                }, 200);
            }, true); // Use capture phase to intercept clicks first

            // 產生唯一 Selector 的輔助函式
            function getCssSelector(el) {
                if (!(el instanceof Element)) return;
                const path = [];
                while (el.nodeType === Node.ELEMENT_NODE) {
                    let selector = el.nodeName.toLowerCase();
                    if (el.id) {
                        selector += '#' + el.id;
                        path.unshift(selector);
                        break; // ID 是唯一的，找到就夠了
                    } else {
                        let sib = el, nth = 1;
                        while (sib = sib.previousElementSibling) {
                            if (sib.nodeName.toLowerCase() == selector)
                                nth++;
                        }
                        if (nth != 1)
                            selector += ":nth-of-type(" + nth + ")";
                    }
                    path.unshift(selector);
                    el = el.parentNode;
                }
                return path.join(" > ");
            }

        })();
    </script>
</body>

<style>
    /* Refined Gallery Modal Styles (Lightbox feel, not fullscreen) */
    #gallery-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        /* Dimmed backdrop */
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 24px;
        /* Padding creates the 'not full screen' effect */
        box-sizing: border-box;
    }

    #gallery-container {
        width: 100%;
        height: 100%;
        max-width: 100%;
        max-height: 100%;
        /* Fill the padded area */
        position: relative;
        background: black;
        border-radius: 16px;
        /* Rounded corners */
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .gallery-close {
        position: absolute;
        top: 16px;
        right: 16px;
        color: white;
        font-size: 28px;
        line-height: 1;
        z-index: 10001;
        cursor: pointer;
        background: rgba(0, 0, 0, 0.4);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
    }

    .gallery-dots {
        position: absolute;
        bottom: 20px;
        left: 0;
        right: 0;
        display: flex;
        justify-content: center;
        gap: 8px;
        z-index: 10002;
        pointer-events: none;
    }
</style>

</html>