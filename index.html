<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ±äº¬ å§Šå¦¹å°æ—…è¡Œ 2026</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563EB">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563EB;
            /* ä¸»è‰²è— */
            --secondary: #F59E0B;
            /* è¼”è‰²é»ƒ */
            --bg: #F3F4F6;
            /* èƒŒæ™¯ç° */
            --white: #FFFFFF;
            --text-main: #1F2937;
            --text-sub: #6B7280;
            --danger: #EF4444;
            --food-choice: #8B5CF6;
            /* ç´«è‰²ç”¨æ–¼é¤é£Ÿé¸æ“‡ */
            --tag-food-bg: #EDE9FE;
            --tag-toyota: #E0E7FF;
            /* æ·ºè—ç´« for Toyota */
            --info-bg: #E0F2F1;
            /* è³‡è¨Šé èƒŒæ™¯è‰² */
            --info-text: #0D9488;
            /* è³‡è¨Šé æ–‡å­—è‰² */
            --kumamoto-info-bg: #F0F9FF;
            /* ç†Šæœ¬è³‡è¨ŠèƒŒæ™¯ */
            --kumamoto-info-text: #0E7490;
            /* ç†Šæœ¬è³‡è¨Šæ–‡å­— */
            --beppu-info: #14B8A6;
            /* åˆ¥åºœåœ°ç„å°ˆç”¨è‰² */
            --beppu-bg: #E0F2F1;

            /* Safe Area Variables */
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        /* [æ–°å¢] æ°´å¹³æ²è»¸åœ–ç‰‡é è¦½å®¹å™¨ */
        .horizontal-scroll-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 4px 0;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            /* iOS é †æš¢æ²å‹• */
            /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE 10+ */
        }

        .horizontal-scroll-container::-webkit-scrollbar {
            display: none;
            /* Chrome/Safari */
        }

        .preview-thumb-box {
            position: relative;
            width: 60px;
            height: 60px;
            flex-shrink: 0;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #eee;
        }

        .preview-thumb-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .btn-remove-img {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            z-index: 2;
        }

        /* [æ–°å¢] å…¨è¢å¹•åœ–åº« Modal */
        #gallery-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 9999;
            flex-direction: column;
        }

        #gallery-container {
            flex: 1;
            display: flex;
            align-items: center;
            overflow: hidden;
            /* ç¦æ­¢æº¢å‡º */
            position: relative;
        }

        /* åœ–ç‰‡å®¹å™¨ - ç”¨æ–¼ Zoom */
        .gallery-slide {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0;
            left: 0;
            transition: transform 0.3s ease-out;
            /* æ»‘å‹•å‹•ç•« */
            will-change: transform;
        }

        .gallery-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.1s;
            /* Zoom åæ‡‰å¿«ä¸€é» */
            transform-origin: center center;
        }

        .gallery-dots {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.5);
        }

        .gallery-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #888;
            transition: 0.3s;
        }

        .gallery-dot.active {
            background: white;
            transform: scale(1.2);
        }

        .gallery-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            z-index: 10000;
            text-shadow: 0 0 5px black;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            padding-bottom: calc(80px + var(--safe-area-bottom));
            /* åº•éƒ¨å°èˆªç©ºé–“ + å®‰å…¨å€åŸŸ */
        }

        /* Header - Modified for Side-by-Side Layout */
        /* [æ–°å¢] å³ä¸Šè§’é‡æ–°æ•´ç†æŒ‰éˆ•æ¨£å¼ */
        /* [ä¿®æ”¹] é‡æ•´æŒ‰éˆ•ï¼šç¸®å°ä¸¦è·Ÿéš¨æ–‡å­— */
        .btn-app-refresh {
            position: relative;
            /* æ”¹ç‚ºç›¸å°å®šä½ï¼Œè·Ÿéš¨æ–‡å­—æµ */
            display: inline-flex;
            /* è®“å®ƒåƒæ–‡å­—ä¸€æ¨£æ’åˆ— */
            vertical-align: middle;
            /* å‚ç›´ç½®ä¸­å°é½Šæ–‡å­— */
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            padding: 2px;
            /* ç¸®å°é»æ“Šç¯„åœçš„ç•™ç™½ */
            margin-left: 2px;
            /* èˆ‡æ¨™é¡Œæ–‡å­—ä¿æŒä¸€é»è·é›¢ */
            margin-bottom: 4px;
            /* å¾®èª¿å‚ç›´ä½ç½® */
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-app-refresh:active,
        .btn-app-refresh:hover {
            color: white;
            transform: rotate(180deg);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        /* [ä¿®æ”¹] åœ–ç¤ºç¸®å°ç´„ 60% (åŸ 20px -> 12px) */
        .btn-app-refresh svg {
            width: 12px;
            height: 12px;
            stroke-width: 3;
            /* å› ç‚ºè®Šå°äº†ï¼Œç·šæ¢åŠ ç²—ä¸€é»é»æ‰æ¸…æ¥š */
        }

        header {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: var(--white);
            padding: 15px 20px;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2);
            position: relative;
            z-index: 10;
        }

        .header-content {
            position: relative;
            /* ç¢ºä¿ z-index ç”Ÿæ•ˆ */
            z-index: 10;
            /* é—œéµä¿®æ­£ï¼è®“æ–‡å­—èˆ‡æŒ‰éˆ•åœ¨æœ€ä¸Šå±¤ */
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            max-width: 1200px;
            margin: 0 auto;
            flex-wrap: wrap;
        }

        .header-title-area {
            flex: 1;
            min-width: 200px;
        }

        .header-title-area h1 {
            margin: 0;
            font-size: 1.6rem;
            font-weight: 700;
            white-space: nowrap;
        }

        .header-title-area .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 5px;
        }

        .header-title-area .badge-trip {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;

            display: inline-flex;
            align-items: center;
            gap: 6px;

            margin-top: 8px;
        }

        /* [ä¿®æ”¹] SOS æµ®å‹•åˆ†äº«æŒ‰éˆ• (å±¤ç´šåŠ å¼·ç‰ˆ) */
        /* [æ–°å¢] è¡Œå‰æª¢æŸ¥æ¸…å–®æ¨£å¼ */
        /* [ä¿®æ”¹] è¡Œå‰æª¢æŸ¥æ¸…å–®æ¨£å¼ (åŠ å…¥æŠ˜ç–ŠåŠŸèƒ½) */
        /* [ä¿®æ”¹] è¡Œå‰æª¢æŸ¥æ¸…å–®æ¨£å¼ (å«æ²å‹•èˆ‡æ–°å¢åˆªé™¤åŠŸèƒ½) */
        .checklist-card-header {
            border-bottom: 1px dashed #E5E7EB;
            padding-bottom: 10px;
            margin-bottom: 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .checklist-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.2s ease-out;
            opacity: 0;
        }

        .checklist-container.show {
            /* è¨­å®šé«˜åº¦ç´„ç‚º 5 è¡Œçš„é«˜åº¦ (æ¯è¡Œç´„ 50px)ï¼Œè¶…éå‡ºç¾æ²è»¸ */
            max-height: 280px;
            opacity: 1;
            margin-top: 15px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .checklist-grid {
            display: flex;
            flex-direction: column;
            /* æ”¹ç‚ºå‚ç›´æ’åˆ— */
            gap: 8px;
            padding-bottom: 5px;
        }

        .check-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            /* è®“åˆªé™¤æŒ‰éˆ•é å³ */
            gap: 8px;
            background: #F9FAFB;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
            border: 1px solid #E5E7EB;
            user-select: none;
        }

        .check-item:has(input:checked) {
            background: #ECFDF5;
            border-color: #10B981;
            color: #065F46;
            font-weight: 600;
        }

        .check-item input {
            accent-color: #10B981;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* åˆªé™¤æŒ‰éˆ•æ¨£å¼ */
        .btn-del-item {
            color: #EF4444;
            background: none;
            border: none;
            font-size: 1.2rem;
            line-height: 1;
            cursor: pointer;
            padding: 0 8px;
            opacity: 0.6;
        }

        .btn-del-item:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        /* æ–°å¢é …ç›®è¼¸å…¥æ¡†å€åŸŸ */
        .add-item-box {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            padding: 5px;
            position: sticky;
            top: 0;
            background: var(--bg);
            z-index: 5;
            /* èƒŒæ™¯è‰²èˆ‡bodyä¸€è‡´é¿å…é€æ˜ */
            border-bottom: 1px solid #eee;
        }

        .input-add-item {
            flex: 1;
            padding: 10px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            outline: none;
            font-size: 0.9rem;
        }

        .btn-add-item {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 0 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* [æ–°å¢] éš¨èº«ç­†è¨˜æµ®å‹•æŒ‰éˆ• (ä½æ–¼åˆ†äº«æŒ‰éˆ•ä¸Šæ–¹) */
        /* [ä¿®æ”¹] éš¨èº«ç­†è¨˜æµ®å‹•æŒ‰éˆ• (è—è‰²) - ç¸®å°èˆ‡é€æ˜åŒ– */
        .float-note-btn {
            position: fixed;
            bottom: 155px;
            /* [èª¿æ•´] å› ç‚ºæŒ‰éˆ•è®Šå°äº†ï¼Œé«˜åº¦ç¨å¾®é™ä½é è¿‘ä¸‹æ–¹ */
            left: 20px;
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            padding: 16px;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
            z-index: 9999;
            cursor: pointer;
            transition: all 0.2s;
            /* æ”¹ç‚º all ä»¥æ”¯æ´ opacity è®ŠåŒ– */
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-user-select: none;
            user-select: none;

            /* [æ–°å¢] ç¸®å°èˆ‡é€æ˜åº¦è¨­å®š */
            transform: scale(0.7);
            /* ç¸®å°è‡³ 70% */
            opacity: 0.6;
            /* é€æ˜åº¦ 60% */
            transform-origin: center center;
            /* ä»¥ä¸­å¿ƒé»ç¸®æ”¾ */
        }

        /* è®“ä½¿ç”¨è€…é»æ“Š(æŒ‰ä½)æ™‚ï¼Œç¨å¾®è®Šå›ä¸é€æ˜ï¼Œå¢åŠ å›é¥‹æ„Ÿ */
        .float-note-btn:active {
            transform: scale(0.65);
            /* æŒ‰ä¸‹æ™‚ç¨å¾®æ›´å°ä¸€é»é» */
            opacity: 1;
            /* æŒ‰ä¸‹æ™‚è®Šæ¸…æ¥š */
        }

        /* [ä¿®æ”¹] åŒ¯ç‡è¨ˆç®—æ©Ÿæµ®å‹•æŒ‰éˆ• (æ©˜è‰²) - ç¸®å°èˆ‡é€æ˜åŒ– */
        .float-calc-btn {
            position: fixed;
            bottom: 205px;
            /* [èª¿æ•´] é…åˆè—è‰²æŒ‰éˆ•çš„é«˜åº¦èª¿æ•´ */
            left: 20px;

            background: rgba(245, 158, 11, 0.65);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);

            color: white;
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            padding: 16px;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
            z-index: 9999;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-user-select: none;
            user-select: none;

            /* [æ–°å¢] ç¸®å°èˆ‡é€æ˜åº¦è¨­å®š */
            transform: scale(0.7);
            /* ç¸®å°è‡³ 70% */
            opacity: 0.6;
            /* é€æ˜åº¦ 60% (æœƒç–ŠåŠ èƒŒæ™¯æœ¬èº«çš„é€æ˜åº¦) */
            transform-origin: center center;
        }

        /* é»æ“Šæ™‚çš„å›é¥‹ */
        .float-calc-btn:active {
            transform: scale(0.65);
            opacity: 1;
            background: rgba(245, 158, 11, 0.85);
        }

        .float-note-btn svg,
        .float-calc-btn svg {
            width: 20px;
            height: 20px;
            stroke-width: 2.5;
        }

        .float-calc-btn:active {
            transform: scale(0.95);
            background: rgba(245, 158, 11, 0.85);
            /* æŒ‰ä¸‹æ™‚è®Šå¯¦å¿ƒä¸€é» */
        }

        .float-calc-btn svg {
            width: 20px;
            height: 20px;
            stroke-width: 2.5;
        }

        /* è¨ˆç®—æ©Ÿè¦–çª—æ¨£å¼ */
        .calc-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calc-input {
            width: 60%;
            padding: 10px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 1.2rem;
            text-align: right;
            outline: none;
        }

        .calc-input:focus {
            border-color: #F59E0B;
        }

        .calc-label {
            font-weight: 600;
            color: #4B5563;
        }

        /* [æ–°å¢] è¨ˆç®—æ©Ÿå°ˆç”¨æ¨£å¼ (Calculator Style) */
        .calc-display {
            background: #F3F4F6;
            padding: 15px;
            border-radius: 12px;
            text-align: right;
            margin-bottom: 15px;
            border: 2px solid #E5E7EB;
        }

        .calc-expr {
            font-size: 0.9rem;
            color: #6B7280;
            min-height: 1.2em;
            margin-bottom: 5px;
            overflow-x: auto;
            white-space: nowrap;
        }

        .calc-main {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1F2937;
            line-height: 1.2;
        }

        .calc-sub {
            font-size: 1rem;
            color: #059669;
            font-weight: 600;
            margin-top: 4px;
        }

        .calc-keypad {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            /* ç¨å¾®å¢åŠ é–“è·è®“é™°å½±æ›´æ¸…æ¥š */
        }

        /* æŒ‰éˆ•åŸºç¤æ¨£å¼ - å„ªåŒ–é™°å½±èˆ‡è³ªæ„Ÿ */
        .calc-btn {
            background: white;
            border: 1px solid #F3F4F6;
            /* æ¥µæ·¡çš„é‚Šæ¡† */
            border-radius: 14px;
            /* æ›´åœ“æ½¤ */
            padding: 15px 0;
            font-size: 1.3rem;
            font-weight: 500;
            color: #374151;
            cursor: pointer;

            /* [ä¿®æ”¹] æ›´è‡ªç„¶çš„æŸ”å’Œæµ®èµ·é™°å½± */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03), 0 2px 4px rgba(0, 0, 0, 0.04);
            transition: all 0.1s ease;
            user-select: none;

            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* æŒ‰ä¸‹æ™‚çš„å‡¹é™·æ„Ÿ */
        .calc-btn:active {
            transform: scale(0.96);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            background: #F9FAFB;
        }

        /* åŠŸèƒ½éµé¡è‰² */
        .calc-btn.op {
            color: #2563EB;
            background: #EFF6FF;
            font-weight: 600;
        }

        .calc-btn.ac {
            color: #DC2626;
            background: #FEF2F2;
            font-weight: 600;
        }

        /* [ä¿®æ”¹] ç­‰è™ŸæŒ‰éµ - ç›´å¼æ’åˆ— (æ”¾åœ¨ + è™Ÿä¸‹æ–¹) */
        .calc-btn.eq {
            background: #2563EB;
            color: white;
            grid-row: span 2;
            /* å‚ç›´è·¨å…©è¡Œ */
            grid-column: 4;
            /* å›ºå®šåœ¨ç¬¬4æ¬„ */
            border: none;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            /* è—è‰²å…‰æšˆ */
            font-size: 1.5rem;
        }

        .calc-btn.eq:active {
            background: #1D4ED8;
            transform: scale(0.96);
        }

        /* [ä¿®æ”¹] 0è™ŸæŒ‰éµ - æ©«è·¨å…©æ¬„ */
        .calc-btn.zero {
            grid-column: span 2;
            /* æ°´å¹³è·¨å…©æ¬„ */
            text-align: left;
            padding-left: 25px;
            /* æ•¸å­—ç¨å¾®é å·¦ä¸€é»æ¯”è¼ƒåƒçœŸè¨ˆç®—æ©Ÿ */
            justify-content: flex-start;
        }

        /* [ä¿®æ”¹] å³ä¸Šè§’é—œé–‰ X æŒ‰éˆ•æ¨£å¼ - ç„¡åº•è‰²ä¸¦èª¿æ•´ä½ç½® */
        .btn-modal-close-x {
            position: absolute;
            top: 5px;
            /* [ä¿®æ”¹] æ•¸å€¼è¶Šå°è¶Šå¾€ä¸Š */
            right: 5px;
            /* [ä¿®æ”¹] æ•¸å€¼è¶Šå°è¶Šå¾€å³ */
            width: 32px;
            height: 32px;
            background: transparent;
            /* [ä¿®æ”¹] è®Šç‚ºé€æ˜èƒŒæ™¯ */
            color: #9CA3AF;
            /* [å¾®èª¿] ç¨å¾®èª¿æ·¡ä¸€é»çš„ç°è‰²ï¼Œæ¯”è¼ƒä¸æ¶çœ¼ */
            border: none;
            font-size: 1.8rem;
            /* [å¾®èª¿] åŠ å¤§å­—é«”ï¼Œè®“ç„¡åº•è‰²çš„ X æ›´æ¸…æ™° */
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }

        /* [ä¿®æ”¹] æ»‘é¼ ç§»å…¥å’ŒæŒ‰ä¸‹æ™‚çµ¦äºˆè¼•å¾®çš„å›é¥‹ */
        .btn-modal-close-x:hover {
            color: #4B5563;
            /* æ»‘å…¥æ™‚è®Šæ·±ç°è‰² */
        }

        .btn-modal-close-x:active {
            background: rgba(0, 0, 0, 0.05);
            /* æŒ‰ä¸‹æ™‚å‡ºç¾æ·¡æ·¡çš„åœ“å½¢èƒŒæ™¯ */
            border-radius: 50%;
            transform: scale(0.9);
            color: #1F2937;
        }

        /* [æ–°å¢] ç­†è¨˜å€å‡ç´š - æ”¯æ´åœ–æ–‡æ··æ’èˆ‡æ”¾å¤§ */
        .note-editable-box {
            width: 100%;
            height: 250px;
            padding: 12px;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            font-size: 1rem;
            overflow-y: auto;
            background: #F9FAFB;
            outline: none;
            text-align: left;
            white-space: pre-wrap;
            /* ä¿ç•™æ›è¡Œ */
        }

        .note-editable-box:focus {
            border-color: var(--primary);
            background: white;
        }

        /* ç­†è¨˜å…§çš„åœ–ç‰‡æ¨£å¼ */
        .note-editable-box img {
            max-width: 90%;
            border-radius: 8px;
            margin: 10px 0;
            display: block;
            border: 2px solid #E5E7EB;
            cursor: zoom-in;
            /* [é—œéµ] è®“æ»‘é¼ ç§»éå»è®Šæˆæ”¾å¤§é¡ï¼Œæç¤ºå¯é»æ“Š */
        }

        /* ç­†è¨˜å·¥å…·åˆ— */
        .note-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }

        .btn-note-tool {
            background: #EFF6FF;
            color: #2563EB;
            border: 1px solid #BFDBFE;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* [æ–°å¢] å‹•æ…‹æ—¥å¤œèƒŒæ™¯ç‰¹æ•ˆ */
        header {
            /* é è¨­(ç™½å¤©): åŸæœ¬çš„æ˜äº®è—è‰²æ¼¸å±¤ */
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            transition: background 1.5s ease;
            /* é¡è‰²åˆ‡æ›æ™‚æœ‰å‘¼å¸æ„Ÿ */
            overflow: hidden;
            /* é˜²æ­¢æ˜Ÿæ˜Ÿè¶…å‡ºç¯„åœ */
            position: relative;
            /* ç¢ºä¿ç‰¹æ•ˆå±¤å®šä½æ­£ç¢º */
        }

        /* æ™šä¸Šçš„èƒŒæ™¯: æ·±é‚ƒçš„åˆå¤œè— */
        header.is-night {
            background: linear-gradient(135deg, #0f172a, #1e3a8a);
        }

        /* æ˜Ÿæ˜Ÿå±¤ (é è¨­éš±è—) */
        .header-bg-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            /* ç¢ºä¿ä¸æ“‹ä½æŒ‰éˆ•é»æ“Š */
            z-index: 0;
            /* åœ¨å…§å®¹ä¹‹ä¸‹ */
            opacity: 0;
            transition: opacity 1.5s ease;

            /* åˆ©ç”¨ CSS å¾‘å‘æ¼¸å±¤ç•«å‡ºæ˜Ÿæ˜Ÿ */
            background-image:
                radial-gradient(white, rgba(255, 255, 255, .2) 2px, transparent 3px),
                radial-gradient(white, rgba(255, 255, 255, .15) 1px, transparent 2px),
                radial-gradient(white, rgba(255, 255, 255, .1) 2px, transparent 3px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            background-position: 0 0, 40px 60px, 130px 270px;
        }

        /* æ™šä¸Šæ™‚é¡¯ç¤ºæ˜Ÿæ˜Ÿ */
        header.is-night .header-bg-effect {
            opacity: 0.8;
        }

        /* ç¢ºä¿åŸæœ¬çš„æ¨™é¡Œå…§å®¹æµ®åœ¨æ˜Ÿæ˜Ÿä¹‹ä¸Š */
        .header-content {
            position: relative;
            z-index: 2;
        }

        /* --- æ’å…¥çµæŸ --- */

        .float-note-btn:active {
            transform: scale(0.95);
        }

        .float-note-btn svg {
            width: 20px;
            height: 20px;
            stroke-width: 2.5;
        }

        .float-share-btn {
            position: fixed;
            bottom: 90px;
            /* ä½æ–¼åº•éƒ¨å°èˆªæ¬„ä¸Šæ–¹ */
            left: 20px;
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
            border: 2px solid white;
            /* æ–°å¢ï¼šç™½è‰²é‚Šæ¡†ï¼Œå¢åŠ è¾¨è­˜åº¦ */
            border-radius: 50px;
            padding: 16px;
            font-size: 0.9rem;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.5);
            /* é™°å½±åŠ æ·± */
            display: flex;
            align-items: center;
            gap: 8px;


            z-index: 9999;
            /* è¨­åˆ°æœ€é«˜ï¼Œç¢ºä¿æµ®åœ¨æ‰€æœ‰å…§å®¹ä¹‹ä¸Š */

            cursor: pointer;
            transition: transform 0.2s;
            -webkit-user-select: none;
            user-select: none;
        }

        .float-share-btn:active {
            transform: scale(0.95);
        }

        /* --- è«‹åœ¨æ­¤è™•æ’å…¥ä»£ç¢¼ Start --- */
        .share-cancel-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: #9CA3AF;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            z-index: 20;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        .share-cancel-badge:active {
            transform: scale(0.9);
            background: #6B7280;
        }

        /* --- è«‹åœ¨æ­¤è™•æ’å…¥ä»£ç¢¼ End --- */
        .float-share-btn svg {
            width: 20px;
            height: 20px;
            stroke-width: 2.5;
        }

        .float-share-btn svg {
            width: 20px;
            height: 20px;
            stroke-width: 2.5;
        }

        .header-title-area .badge-trip::before {
            content: '';
            display: block;
            width: 16px;
            height: 16px;
            background-color: currentColor;
            /* è‡ªå‹•è®Šæˆç™½è‰² */

            /* è¦ªå­/ç¾¤çµ„ SVG åœ–ç¤º (Users Icon) */
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2'%3E%3C/path%3E%3Ccircle cx='9' cy='7' r='4'%3E%3C/circle%3E%3Cpath d='M23 21v-2a4 4 0 0 0-3-3.87'%3E%3C/path%3E%3Cpath d='M16 3.13a4 4 0 0 1 0 7.75'%3E%3C/path%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2'%3E%3C/path%3E%3Ccircle cx='9' cy='7' r='4'%3E%3C/circle%3E%3Cpath d='M23 21v-2a4 4 0 0 0-3-3.87'%3E%3C/path%3E%3Cpath d='M16 3.13a4 4 0 0 1 0 7.75'%3E%3C/path%3E%3C/svg%3E");

            -webkit-mask-size: contain;
            mask-size: contain;
            -webkit-mask-repeat: no-repeat;
            mask-repeat: no-repeat;
        }

        /* New Header Weather Box - Side Layout */
        .header-weather-box {
            flex: 0 0 auto;
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 50px;
            /* Pill shape */
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            min-height: 70px;
        }

        /* Weather Columns */
        /* [æ–°å¢] Header æˆ‘çš„ä½ç½®å€å¡Šæ¨£å¼ */
        .hw-col-my-loc {
            padding-right: 10px;
            margin-right: 5px;
            border-right: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 60px;
            text-align: left;
        }

        .hw-sub-label {
            font-size: 0.65rem;
            opacity: 0.8;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .hw-my-data {
            font-size: 0.9rem;
            font-weight: 700;
            white-space: nowrap;
            display: flex;
            gap: 4px;
            align-items: center;
        }

        /* æ‰‹æ©Ÿç‰ˆå¾®èª¿ */
        @media (max-width: 600px) {
            .hw-col-my-loc {
                padding-right: 8px;
                margin-right: 0;
                border-right: 1px solid rgba(255, 255, 255, 0.2);

                /* [æ–°å¢] ä¸‹é¢é€™å…©è¡Œæ˜¯è§£æ±ºæ“ å£“çš„é—œéµ */
                min-width: auto;
                /* [ä¿®æ­£] æ”¹ç‚º autoï¼Œè®“å¯¬åº¦éš¨å…§å®¹èª¿æ•´ */
                flex-shrink: 0;
                /* [æ–°å¢] é˜²æ­¢å…§å®¹è¢«æ“ æ‰ */
                white-space: nowrap;
                /* ç¦æ­¢æ–‡å­—æ›è¡Œ */
            }
        }

        .hw-loc {
            font-size: 1.1rem;
            font-weight: 700;
            display: block;
            line-height: 1.2;
        }

        .hw-date {
            font-size: 0.75rem;
            opacity: 0.9;
            display: block;
            margin-top: 4px;
        }

        .hw-col-main {
            padding: 0 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .hw-icon svg {
            width: 36px;
            height: 36px;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
        }

        .hw-temp-group {
            text-align: center;
        }

        .hw-temp {
            font-size: 1.4rem;
            font-weight: 700;
            line-height: 1;
        }

        .hw-desc {
            font-size: 0.8rem;
            font-weight: 500;
            display: block;
            margin-top: 2px;
        }

        .hw-range {
            font-size: 0.7rem;
            opacity: 0.9;
            display: block;
            margin-top: 2px;
            font-family: monospace;
        }

        .hw-col-advice {
            padding-left: 15px;
            border-left: 1px solid rgba(255, 255, 255, 0.3);
            max-width: 140px;
            font-size: 0.75rem;
            line-height: 1.3;
            opacity: 0.95;
            display: flex;
            align-items: center;
            min-height: 50px;
            /* Ensure height for border */
        }

        /* Container & Tabs */
        .container {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s ease;
            max-width: 800px;
            margin: 0 auto;
        }

        .container.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.03);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .card-title {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.05rem;
        }

        /* Day specific styles */
        .day-wrapper {
            background: var(--white);
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: box-shadow 0.2s;
        }

        .day-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            cursor: pointer;
            border-radius: 12px;
            border-left: 5px solid transparent;
            transition: background-color 0.2s, border-left-color 0.3s;
        }

        .day-toggle:active {
            background-color: #F8F9FB;
        }

        .day-toggle.open {
            border-left-color: var(--primary);
        }

        .day-info h3 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--text-main);
        }

        .day-info span {
            font-size: 0.85rem;
            color: var(--text-sub);
        }

        .toggle-icon {
            transition: transform 0.3s;
            font-size: 0.8rem;
            color: var(--text-sub);
            font-weight: 700;
        }

        .day-toggle.open .toggle-icon {
            transform: rotate(180deg);
            color: var(--primary);
        }

        .timeline {
            display: none;
            padding: 15px 15px 5px 30px;
            border-top: 1px solid #F3F4F6;
        }

        .timeline.show {
            display: block;
        }

        .event {
            position: relative;
            padding-left: 20px;
            margin-bottom: 24px;
        }

        .event:last-child {
            margin-bottom: 0;
        }

        .event::before {
            content: '';
            position: absolute;
            left: -7px;
            top: 6px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--white);
            border: 3px solid var(--secondary);
            z-index: 1;
        }

        /* Event Styles */
        .event-meal .activity {
            color: var(--food-choice);
        }

        .event-meal .desc {
            border-left: 2px solid var(--food-choice);
            padding-left: 8px;
            margin-top: 5px;
        }

        .time {
            font-size: 0.85rem;
            color: var(--text-sub);
            font-weight: 600;
            font-family: monospace;
        }

        .activity {
            font-size: 1rem;
            font-weight: 700;
            margin: 4px 0;
            color: var(--text-main);
        }

        .desc {
            font-size: 0.9rem;
            color: #555;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        /* Tags */
        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tag {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 6px;
            font-weight: 500;
        }

        .tag-food {
            background: var(--tag-food-bg);
            color: var(--food-choice);
        }

        .tag-move {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .tag-stay {
            background: #D1FAE5;
            color: #059669;
        }

        .tag-spot {
            background: #FCE7F3;
            color: #BE185D;
        }

        .tag-kids {
            background: #E0F2FE;
            color: #0284C7;
            border: 1px solid #BAE6FD;
        }

        .tag-car {
            background: var(--tag-toyota);
            color: #4338CA;
        }

        .tag-relax {
            background: #FFFBEB;
            color: #D97706;
            border: 1px solid #FCD34D;
        }

        .tag-shrine {
            background: #FEE2E2;
            color: #B91C1C;
            border: 1px solid #FCA5A5;
        }

        .tag-flight {
            background: #BFDBFE;
            color: #1D4ED8;
        }

        .tag-tip {
            background: var(--info-bg);
            color: var(--info-text);
        }

        .tag-shop {
            background: var(--kumamoto-info-bg);
            color: var(--kumamoto-info-text);
        }

        .tag-beppu {
            background: var(--beppu-bg);
            color: var(--beppu-info);
        }

        .tag-snow {
            background: #E0F2FE;
            color: #0369A1;
            border: 1px solid #BAE6FD;
        }

        /* Buttons */
        .btn-primary {
            background-color: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* [æ–°å¢] å¹½éˆæŒ‰éˆ• (ç„¡èƒŒæ™¯ï¼Œè—è‰²åœ–ç¤º) */
        .btn-submit-ghost {
            background-color: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .btn-submit-ghost:active {
            transform: scale(0.9);
            background-color: transparent !important;
        }

        .btn-submit-ghost svg {
            stroke: var(--primary);
            /* åœ–ç¤ºæ”¹ç‚ºè—è‰² */
            width: 24px;
            height: 24px;
        }

        /* [ä¿®æ”¹] ä½¿ç”¨è€…èº«åˆ†å¡ç‰‡ - ç§»é™¤é‚Šæ¡† */
        .user-status-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 5px;
            /* ç¨å¾®æ¸›å°‘ padding */
            border: none !important;
            /* [æœ€é‡è¦çš„ä¿®æ”¹] ç§»é™¤é‚Šæ¡† */
            box-shadow: none !important;
            /* ç§»é™¤é™°å½± */
            background: transparent;
            /* èƒŒæ™¯é€æ˜ */
            margin-bottom: 5px;
        }

        .btn-primary:active {
            background-color: #1D4ED8;
            /* Darker blue */
            transform: scale(0.96);
        }

        .btn-map {
            display: inline-flex;
            align-items: center;
            text-decoration: none;
            color: var(--primary);
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 4px;
            padding: 4px 0;
        }

        .btn-map::before {
            content: '';
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-right: 4px;

            /* é€™è£¡è¨­å®šåœ–ç¤ºé¡è‰²è·Ÿéš¨æ–‡å­—é¡è‰² (å³æ‚¨çš„ä¸»è‰²è—) */
            background-color: currentColor;

            /* ä½¿ç”¨ SVG ä½œç‚ºé®ç½©å½¢ç‹€ */
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'%3E%3C/path%3E%3Ccircle cx='12' cy='10' r='3'%3E%3C/circle%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'%3E%3C/path%3E%3Ccircle cx='12' cy='10' r='3'%3E%3C/circle%3E%3C/svg%3E");

            -webkit-mask-size: contain;
            mask-size: contain;
            -webkit-mask-repeat: no-repeat;
            mask-repeat: no-repeat;

            /* å¾®èª¿å‚ç›´ä½ç½®ï¼Œè®“åœ–ç¤ºèˆ‡æ–‡å­—å°é½Š */
            vertical-align: text-bottom;
        }

        .btn-link {
            background: var(--primary);
            color: white;
            text-decoration: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            display: block;
            text-align: center;
            margin-top: 10px;
        }

        .btn-link-sub {
            background: #EBF5FF;
            color: var(--primary);
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            display: block;
            text-align: center;
            margin-top: 8px;
            border: 1px solid var(--primary);
        }

        .btn-link-tel {
            background: #D1FAE5;
            color: #059669;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            display: block;
            text-align: center;
            margin-top: 8px;
            border: 1px solid #059669;
        }

        .btn-link-tel::before {
            content: 'ğŸ“';
            margin-right: 4px;
        }

        /* Info Grid */
        .info-grid {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 10px;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .info-label {
            color: var(--text-sub);
        }

        .info-val {
            font-weight: 500;
        }

        .info-detail-box {
            border: 1px solid #D1D5DB;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .info-detail-box h4 {
            margin: 0 0 8px 0;
            font-size: 1rem;
            color: var(--primary);
        }

        /* Info Sections */
        .info-section {
            background-color: var(--info-bg);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 16px;
            border: 1px solid #5EEAD4;
        }

        .info-section.kumamoto {
            background-color: var(--kumamoto-info-bg);
            border-color: #90CDF4;
        }

        .info-section.kumamoto h3 {
            color: var(--kumamoto-info-text);
            border-bottom: 2px solid #90CDF4;
        }

        .info-section.winter-drive {
            background-color: #FEF2F2;
            border-color: #FCA5A5;
            color: #B91C1C;
        }

        .info-section.winter-drive h3 {
            color: #B91C1C;
            border-bottom: 2px solid #FCA5A5;
        }

        .info-section h3 {
            color: var(--info-text);
            font-size: 1.2rem;
            margin-top: 0;
            border-bottom: 2px solid #5EEAD4;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }

        /* Price table */
        .price-table {
            display: grid;
            grid-template-columns: 1fr 80px 80px;
            gap: 8px;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .price-header {
            font-weight: 700;
            color: var(--primary);
            padding-bottom: 4px;
            border-bottom: 1px solid var(--primary);
        }

        .price-item {
            padding: 4px 0;
            border-bottom: 1px dashed #DDD;
        }

        .price-item:last-child {
            border-bottom: none;
        }

        .price-item .detail {
            font-size: 0.8rem;
            color: var(--text-sub);
        }

        .safari-method {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            border: 1px dashed var(--info-text);
        }

        .method-title {
            font-weight: 700;
            color: var(--primary);
            display: block;
            margin-bottom: 5px;
            font-size: 1rem;
        }

        .method-title.recommended {
            color: var(--danger);
        }

        .method-detail {
            font-size: 0.9rem;
            line-height: 1.5;
            color: #444;
        }

        /* Step List */
        .step-list {
            counter-reset: step-counter;
            padding-left: 0;
            list-style: none;
            margin-top: 10px;
        }

        .step-list li {
            position: relative;
            padding-left: 30px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .step-list li::before {
            counter-increment: step-counter;
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            width: 20px;
            height: 20px;
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            text-align: center;
            font-size: 0.75rem;
            line-height: 20px;
        }

        /* Bottom Nav - Optimized for Safe Area */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-around;
            padding: 8px 0 calc(8px + var(--safe-area-bottom));
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
            z-index: 100;
        }

        .nav-item {
            text-align: center;
            color: #9CA3AF;
            font-size: 0.7rem;
            cursor: pointer;
            transition: color 0.2s;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px;
            /* Touch target */
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            display: block;
            margin-bottom: 4px;
            height: 22px;
            width: 22px;
        }

        .nav-icon svg {
            width: 100%;
            height: 100%;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .alert-box {
            background: #FEF2F2;
            border: 1px solid #FECACA;
            color: #991B1B;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-top: 8px;
            display: flex;
            gap: 8px;
            align-items: start;
            margin-bottom: 15px;
        }

        /* é€šç”¨ Alert åœ–ç¤ºè¨­å®š */
        .alert-icon {
            width: 20px;
            height: 20px;
            background-color: currentColor;
            /* è‡ªå‹•æŠ“å–æç¤ºæ¡†çš„æ–‡å­—é¡è‰² (ç¶ /è—) */
            flex-shrink: 0;
            /* é˜²æ­¢åœ–ç¤ºè¢«æ–‡å­—æ“ å£“è®Šå½¢ */
            margin-top: 1px;
            /* å¾®èª¿å‚ç›´å°é½Š */

            -webkit-mask-size: contain;
            mask-size: contain;
            -webkit-mask-repeat: no-repeat;
            mask-repeat: no-repeat;
            -webkit-mask-position: center;
            mask-position: center;
        }

        /* --- Header å¤©æ°£åœ–ç¤ºå„ªåŒ– (CSS Mask) --- */
        .weather-icon {
            width: 36px;
            height: 36px;
            background-color: white;
            /* è·Ÿéš¨ Header æ–‡å­—é¡è‰² (ç™½) */

            -webkit-mask-size: contain;
            mask-size: contain;
            -webkit-mask-repeat: no-repeat;
            mask-repeat: no-repeat;
            -webkit-mask-position: center;
            mask-position: center;

            /* å¢åŠ ä¸€é»é™°å½±è®“ç™½è‰²åœ–ç¤ºæ›´æ¸…æ¥š */
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
        }

        /* å„ç¨®å¤©æ°£å°æ‡‰çš„ SVG å½¢ç‹€ */
        .weather-icon.sun {
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='5'%3E%3C/circle%3E%3Cline x1='12' y1='1' x2='12' y2='3'%3E%3C/line%3E%3Cline x1='12' y1='21' x2='12' y2='23'%3E%3C/line%3E%3Cline x1='4.22' y1='4.22' x2='5.64' y2='5.64'%3E%3C/line%3E%3Cline x1='18.36' y1='18.36' x2='19.78' y2='19.78'%3E%3C/line%3E%3Cline x1='1' y1='12' x2='3' y2='12'%3E%3C/line%3E%3Cline x1='21' y1='12' x2='23' y2='12'%3E%3C/line%3E%3Cline x1='4.22' y1='19.78' x2='5.64' y2='18.36'%3E%3C/line%3E%3Cline x1='18.36' y1='5.64' x2='19.78' y2='4.22'%3E%3C/line%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='5'%3E%3C/circle%3E%3Cline x1='12' y1='1' x2='12' y2='3'%3E%3C/line%3E%3Cline x1='12' y1='21' x2='12' y2='23'%3E%3C/line%3E%3Cline x1='4.22' y1='4.22' x2='5.64' y2='5.64'%3E%3C/line%3E%3Cline x1='18.36' y1='18.36' x2='19.78' y2='19.78'%3E%3C/line%3E%3Cline x1='1' y1='12' x2='3' y2='12'%3E%3C/line%3E%3Cline x1='21' y1='12' x2='23' y2='12'%3E%3C/line%3E%3Cline x1='4.22' y1='19.78' x2='5.64' y2='18.36'%3E%3C/line%3E%3Cline x1='18.36' y1='5.64' x2='19.78' y2='4.22'%3E%3C/line%3E%3C/svg%3E");
        }

        .weather-icon.cloud {
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z'%3E%3C/path%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z'%3E%3C/path%3E%3C/svg%3E");
        }

        .weather-icon.cloud-sun {
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 2v2'%3E%3C/path%3E%3Cpath d='m4.93 4.93 1.41 1.41'%3E%3C/path%3E%3Cpath d='M20 12h2'%3E%3C/path%3E%3Cpath d='m19.07 4.93-1.41 1.41'%3E%3C/path%3E%3Cpath d='M15.947 12.65a4 4 0 0 0-5.925-4.128'%3E%3C/path%3E%3Cpath d='M13 22H7a5 5 0 1 1 4.9-6H13a3 3 0 0 1 0 6Z'%3E%3C/path%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 2v2'%3E%3C/path%3E%3Cpath d='m4.93 4.93 1.41 1.41'%3E%3C/path%3E%3Cpath d='M20 12h2'%3E%3C/path%3E%3Cpath d='m19.07 4.93-1.41 1.41'%3E%3C/path%3E%3Cpath d='M15.947 12.65a4 4 0 0 0-5.925-4.128'%3E%3C/path%3E%3Cpath d='M13 22H7a5 5 0 1 1 4.9-6H13a3 3 0 0 1 0 6Z'%3E%3C/path%3E%3C/svg%3E");
        }

        /* [ä¿®æ”¹] Header å¤©æ°£åœ–ç¤ºï¼šä½¿ç”¨æ–°çš„é›™é‡å¹³è¡Œ V å‹é›ªèŠ± */
        .weather-icon.snow {
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3C!-- å…­è§’å†°æ ¸ --%3E%3Cpath d='M12 9 L14.6 10.5 L14.6 13.5 L12 15 L9.4 13.5 L9.4 10.5 Z'/%3E%3C!-- ä¸»å¹¹è²«ç©¿ --%3E%3Cpath d='M12 9 V1 M12 15 V23 M14.6 10.5 L21.5 6.5 M14.6 13.5 L21.5 17.5 M9.4 13.5 L2.5 17.5 M9.4 10.5 L2.5 6.5'/%3E%3C!-- é›™é‡ V å‹ --%3E%3Cpath d='M9.5 5.5 L12 7.5 L14.5 5.5 M9.5 2 L12 4 L14.5 2'/%3E%3Cpath d='M9.5 18.5 L12 16.5 L14.5 18.5 M9.5 22 L12 20 L14.5 22'/%3E%3Cpath d='M16.4 6.6 L15.9 9.75 L18.9 10.9 M19.4 4.8 L18.9 8 L21.9 9.2'/%3E%3Cpath d='M18.9 13.1 L15.9 14.25 L16.4 17.4 M21.9 14.8 L18.9 16 L19.4 19.2'/%3E%3Cpath d='M7.6 17.4 L8.1 14.25 L5.1 13.1 M4.6 19.2 L5.1 16 L2.1 14.8'/%3E%3Cpath d='M5.1 10.9 L8.1 9.75 L7.6 6.6 M2.1 9.2 L5.1 8 L4.6 4.8'/%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3C!-- å…­è§’å†°æ ¸ --%3E%3Cpath d='M12 9 L14.6 10.5 L14.6 13.5 L12 15 L9.4 13.5 L9.4 10.5 Z'/%3E%3C!-- ä¸»å¹¹è²«ç©¿ --%3E%3Cpath d='M12 9 V1 M12 15 V23 M14.6 10.5 L21.5 6.5 M14.6 13.5 L21.5 17.5 M9.4 13.5 L2.5 17.5 M9.4 10.5 L2.5 6.5'/%3E%3C!-- é›™é‡ V å‹ --%3E%3Cpath d='M9.5 5.5 L12 7.5 L14.5 5.5 M9.5 2 L12 4 L14.5 2'/%3E%3Cpath d='M9.5 18.5 L12 16.5 L14.5 18.5 M9.5 22 L12 20 L14.5 22'/%3E%3Cpath d='M16.4 6.6 L15.9 9.75 L18.9 10.9 M19.4 4.8 L18.9 8 L21.9 9.2'/%3E%3Cpath d='M18.9 13.1 L15.9 14.25 L16.4 17.4 M21.9 14.8 L18.9 16 L19.4 19.2'/%3E%3Cpath d='M7.6 17.4 L8.1 14.25 L5.1 13.1 M4.6 19.2 L5.1 16 L2.1 14.8'/%3E%3Cpath d='M5.1 10.9 L8.1 9.75 L7.6 6.6 M2.1 9.2 L5.1 8 L4.6 4.8'/%3E%3C/svg%3E");
        }

        .weather-icon.rain {
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M16 13v8'%3E%3C/path%3E%3Cpath d='M8 13v8'%3E%3C/path%3E%3Cpath d='M12 15v8'%3E%3C/path%3E%3Cpath d='M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25'%3E%3C/path%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M16 13v8'%3E%3C/path%3E%3Cpath d='M8 13v8'%3E%3C/path%3E%3Cpath d='M12 15v8'%3E%3C/path%3E%3Cpath d='M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25'%3E%3C/path%3E%3C/svg%3E");
        }

        /* 2. éœ§ (Fog) - é é˜²ä¹‹å¾Œé‡åˆ°éœ§å¤©ä¹Ÿè®Šæ–¹å¡Š */
        .weather-icon.fog {
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M5 6h14M4 10h16M6 14h12M4 18h16'%3E%3C/path%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M5 6h14M4 10h16M6 14h12M4 18h16'%3E%3C/path%3E%3C/svg%3E");
        }

        /* 3. é›·é›¨ (Lightning) - é é˜²é‡åˆ°é›·é›¨è®Šæ–¹å¡Š */
        .weather-icon.lightning {
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9'%3E%3C/path%3E%3Cpolyline points='13 11 9 17 15 17 11 23'%3E%3C/polyline%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9'%3E%3C/path%3E%3Cpolyline points='13 11 9 17 15 17 11 23'%3E%3C/polyline%3E%3C/svg%3E");
        }

        /* Day 2: è¨ˆæ™‚å™¨/ç¢¼è¡¨åœ–ç¤º (Timer) */
        .alert-icon.time {
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='13' r='8'%3E%3C/circle%3E%3Cpath d='M12 9v4l2 2'%3E%3C/path%3E%3Cpath d='M5 3 2 6'%3E%3C/path%3E%3Cpath d='m22 6-3-3'%3E%3C/path%3E%3Cpath d='M12 2v4'%3E%3C/path%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='13' r='8'%3E%3C/circle%3E%3Cpath d='M12 9v4l2 2'%3E%3C/path%3E%3Cpath d='M5 3 2 6'%3E%3C/path%3E%3Cpath d='m22 6-3-3'%3E%3C/path%3E%3Cpath d='M12 2v4'%3E%3C/path%3E%3C/svg%3E");
        }

        /* Day 3: æº«æ³‰/ç†±æ°£åœ–ç¤º (Hot Springs) */
        .alert-icon.onsen {
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 20a4 4 0 1 1 0-8 4 4 0 0 1 0 8z'%3E%3C/path%3E%3Cpath d='M8 8c0-2.5 2-3 2-3s2 0.5 2 3'%3E%3C/path%3E%3Cpath d='M12 6c0-2.5 2-3 2-3s2 0.5 2 3'%3E%3C/path%3E%3Cpath d='M16 8c0-2.5 2-3 2-3s2 0.5 2 3'%3E%3C/path%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 20a4 4 0 1 1 0-8 4 4 0 0 1 0 8z'%3E%3C/path%3E%3Cpath d='M8 8c0-2.5 2-3 2-3s2 0.5 2 3'%3E%3C/path%3E%3Cpath d='M12 6c0-2.5 2-3 2-3s2 0.5 2 3'%3E%3C/path%3E%3Cpath d='M16 8c0-2.5 2-3 2-3s2 0.5 2 3'%3E%3C/path%3E%3C/svg%3E");
        }

        .event.optimized {
            border-left: 2px solid var(--secondary);
            padding-left: 28px;
            margin-left: -8px;
            background-color: #FFFDF5;
            padding-top: 5px;
            padding-bottom: 5px;
            border-radius: 4px;
        }

        /* AI Features Styles (Integrated) */
        .btn-ai-guide {
            background: linear-gradient(90deg, #8B5CF6, #EC4899);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            font-weight: 600;
        }

        .btn-ai-guide:active {
            transform: scale(0.95);
        }

        .btn-ai-guide svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        /* New Style for Replay Button (Blue Theme) */
        .btn-ai-play {
            background: linear-gradient(135deg, #2563EB, #3B82F6);
            /* Blue Gradient */
            color: white;
            border: none;
            /* Icon Only Style */
            width: 40px;
            height: 40px;
            border-radius: 50%;
            padding: 0;
            display: inline-flex;
            justify-content: center;
            align-items: center;

            cursor: pointer;
            margin-top: 10px;
            box-shadow: 0 2px 5px rgba(37, 99, 235, 0.2);
            transition: transform 0.2s;
        }

        .btn-ai-play:active {
            transform: scale(0.95);
        }

        .btn-ai-play svg {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* Weather Tab Specific Styles */
        .weather-search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .weather-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            font-size: 1rem;
            outline: none;
        }

        .weather-input:focus {
            border-color: var(--primary);
        }

        .btn-weather-search {
            background: #5A92E8;
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .weather-card-main {
            background: linear-gradient(135deg, #60A5FA, #2563EB);
            color: white;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
            position: relative;
            overflow: hidden;
        }

        .weather-card-main::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 60%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .wc-temp-big {
            font-size: 4rem;
            font-weight: 700;
            line-height: 1;
            margin: 10px 0;
            position: relative;
            z-index: 1;
        }

        .wc-loc {
            font-size: 1.5rem;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        /* Add flexbox to center content and icon */
        .wc-desc {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* New: Mini Icon Style for Weather Tab */
        .icon-mini {
            width: 18px;
            height: 18px;
            vertical-align: text-bottom;
            margin-right: 4px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            display: inline-block;
        }

        .weather-compare-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .wc-mini-card {
            flex: 1;
            background: white;
            padding: 15px;
            border-radius: 16px;
            border: 1px solid #E5E7EB;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .wc-mini-title {
            font-size: 0.85rem;
            color: #6B7280;
            margin-bottom: 5px;
        }

        .wc-mini-temp {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1F2937;
        }

        .wc-diff-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-top: 5px;
        }

        .wc-diff-hot {
            background: #FEE2E2;
            color: #DC2626;
        }

        .wc-diff-cold {
            background: #DBEAFE;
            color: #1D4ED8;
        }

        .advice-box {
            background: #F0FDF4;
            border: 1px solid #BBF7D0;
            padding: 15px;
            border-radius: 16px;
            color: #166534;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        /* æ–°å¢ï¼šè‡ªå®šç¾©å½ˆå‡ºè¦–çª— (Modal) æ¨£å¼ - å–ä»£åŸç”Ÿ alert/prompt */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
            animation: fadeIn 0.2s;
            cursor: pointer;
            /* [æ–°å¢] é€™è¡Œæ˜¯é—œéµï¼è®“æ‰‹æ©ŸçŸ¥é“èƒŒæ™¯å¯é»æ“Š */
        }

        .modal-box {
            /* [ä¿®æ”¹] æ”¹ç‚ºåç™½æ¯›ç»ç’ƒè³ªæ„Ÿ */
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            /* æ”¯æ´ iOS Safari */
            border: 1px solid rgba(255, 255, 255, 0.6);
            /* ç»ç’ƒé‚Šç·£åå…‰æ„Ÿ */

            width: 90%;
            max-width: 320px;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            /* åŠ æ·±é™°å½±å¢åŠ å±¤æ¬¡ */
            text-align: center;
            transform: scale(0.95);
            animation: popIn 0.2s forwards;
        }

        @keyframes popIn {
            to {
                transform: scale(1);
            }
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #1F2937;
        }

        .modal-desc {
            font-size: 0.9rem;
            color: #4B5563;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .modal-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
            outline: none;
        }

        .modal-input:focus {
            border-color: var(--primary);
        }

        .modal-btns {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-cancel {
            background: #F3F4F6;
            color: #4B5563;
        }

        .btn-confirm {
            background: var(--primary);
            color: white;
        }

        /* AI Container Styles */
        .ai-header {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: #4B5563;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 2px solid #E5E7EB;
            padding-bottom: 10px;
        }

        /* Chat History Box (Replaces old result box) */
        .chat-history {
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 16px;
            padding: 16px;
            min-height: 200px;
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        /* Chat Bubbles */
        .chat-row {
            display: flex;
            width: 100%;
            animation: slideIn 0.2s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-row.user {
            justify-content: flex-end;
        }

        .chat-row.ai {
            justify-content: flex-start;
        }

        .chat-bubble {
            max-width: 85%;
            padding: 12px 16px;
            font-size: 1rem;
            line-height: 1.6;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .chat-bubble.user {
            background: var(--primary);
            color: white;
            border-radius: 18px 18px 4px 18px;
        }

        .chat-bubble.ai {
            background: white;
            border: 1px solid #E5E7EB;
            color: #374151;
            border-radius: 18px 18px 18px 4px;
        }

        .chat-bubble strong {
            font-weight: 600;
        }

        .chat-bubble.ai strong {
            color: var(--primary);
        }

        /* Inline Audio Button in Bubble */
        .btn-audio-inline {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: #E0F2FE;
            color: var(--primary);
            border-radius: 50%;
            border: none;
            cursor: pointer;
            vertical-align: middle;
            margin-left: 8px;
            transition: transform 0.2s;
        }

        .btn-audio-inline:active {
            transform: scale(0.9);
            background: #BAE6FD;
        }

        .btn-audio-inline svg {
            width: 16px;
            height: 16px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* Updated Input Area Layout */
        .ai-input-wrapper {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        /* New: Voice Language Toggle */
        .voice-lang-switch {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: -5px;
            padding: 0 5px;
            font-size: 0.85rem;
            color: #4B5563;
        }

        .lang-option {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 6px 12px;
            /* åŠ å¤§ä¸€é»é»æ“Šç¯„åœ */
            border-radius: 20px;
            /* åœ“è§’æ›´æ˜é¡¯ */
            border: 1px solid transparent;
            /* é ç•™é‚Šæ¡†ç©ºé–“ */
            transition: all 0.2s;
            background: #fff;
        }

        .lang-option:hover {
            background: #F3F4F6;
        }

        /* éš±è—åŸç”Ÿ radioï¼Œæ”¹ç”¨æ¨£å¼æ§åˆ¶ */
        .lang-option input {
            display: none;
        }

        /* é¸ä¸­æ™‚çš„æ¨£å¼ */
        .lang-option:has(input:checked) {
            background: #EFF6FF;
            border-color: var(--primary);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        /* åœ‹æ—— SVG æ¨£å¼ - æ”¹ç‚ºåœ“å½¢ç°¡ç´„é¢¨ */
        .flag-icon {
            width: 24px;
            /* æ­£æ–¹å½¢ */
            height: 24px;
            /* æ­£æ–¹å½¢ */
            border-radius: 50%;
            /* åœ“å½¢ */
            object-fit: cover;
            display: block;
            /* ç§»é™¤é™°å½±ï¼Œæ”¹ç”¨ SVG å…§éƒ¨é‚Šæ¡†ï¼Œæ›´æ‰å¹³ */
        }

        /* Mobile: Prevent Zoom on Input */
        .ai-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            outline: none;
            font-size: 16px;
            /* 16px prevents iOS zoom */
            transition: border-color 0.2s;
        }

        .ai-input:focus {
            border-color: #3b82f6;
        }

        .ai-actions-row {
            display: flex;
            gap: 8px;
            width: 100%;
        }

        .btn-mode {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.95rem;
            transition: transform 0.1s, opacity 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            min-height: 48px;
            /* Ensure touch target size */
            /* Mobile touch fix: Prevent text selection/callout on long press */
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }

        .btn-mode:active {
            transform: scale(0.96);
            opacity: 0.9;
        }

        .btn-mode svg {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .btn-mode.consult {
            background: linear-gradient(135deg, #1D4ED8, #3B82F6);
        }

        .btn-mode.trans {
            background: linear-gradient(135deg, #0EA5E9, #38BDF8);
        }

        .btn-mode.voice {
            background: linear-gradient(135deg, #06B6D4, #22D3EE);
        }

        .btn-mode.voice.recording {
            background: linear-gradient(135deg, #EF4444, #F87171);
            animation: pulse 1.5s infinite;
        }

        /* [æ–°å¢] ç›¸æ©ŸæŒ‰éˆ•æ¨£å¼ */
        .btn-mode.camera {
            background: linear-gradient(135deg, #8B5CF6, #D946EF);
        }

        /* éš±è—åŸæœ¬çš„æª”æ¡ˆä¸Šå‚³ Inputï¼Œæ”¹ç”¨æŒ‰éˆ•è§¸ç™¼ */
        #img-upload-input {
            display: none;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .btn-ai-reset {
            background: #F3F4F6;
            color: #6B7280;
            border: 1px solid #D1D5DB;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-bottom: 15px;
            display: none;
            align-self: flex-end;
            width: 100%;
            /* Full width on mobile usually better for back buttons */
            text-align: center;
        }

        .btn-ai-reset:hover {
            background: #E5E7EB;
        }

        .loading-bubble {
            color: #9CA3AF;
            font-style: italic;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .loading-dots:after {
            content: ' .';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: ' .';
            }

            40% {
                content: ' ..';
            }

            60% {
                content: ' ...';
            }

            80%,
            100% {
                content: ' ....';
            }
        }

        /* [æ–°å¢] SVG Sprite é€šç”¨æ¨£å¼ */
        .icon-sprite {
            width: 100%;
            height: 100%;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* Mobile Optimization - ä¿®æ­£å¾Œçš„å®Œæ•´æ‰‹æ©Ÿç‰ˆè¨­å®š */
        @media (max-width: 600px) {
            .container {
                padding: 15px 12px;
            }

            /* Header èª¿æ•´ */
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .header-title-area h1 {
                font-size: 1.5rem;
                white-space: normal;
                line-height: 1.3;
            }

            /* å¤©æ°£å€å¡Šå®¹å™¨ï¼šç¸®å°é–“è· */
            .header-weather-box {
                width: 100%;
                justify-content: space-between;
                padding: 10px 8px;
                /*15px*/
                border-radius: 12px;
                background: rgba(255, 255, 255, 0.15);
                min-height: auto;
                flex-wrap: wrap;
                gap: 5px;
                /* [ä¿®æ­£] é–“è·ç¸®å° */
            }

            /* 1. å·¦å´ï¼šæˆ‘çš„ä½ç½® (ä¿®æ­£å¯¬åº¦) */
            .hw-col-my-loc {
                padding-right: 8px;
                margin-right: 0;
                border-right: 1px solid rgba(255, 255, 255, 0.2);
                min-width: auto;
                flex-shrink: 0;
                white-space: nowrap;
            }

            /* 2. ä¸­é–“ï¼šç›®çš„åœ° (é—œéµä¿®æ­£ï¼šå¡«æ»¿å‰©é¤˜ç©ºé–“) */
            .hw-col-loc {
                flex: 1;
                /* [é—œéµ] è‡ªå‹•å¡«æ»¿ä¸­é–“å‰©é¤˜æ‰€æœ‰ç©ºé–“ */
                min-width: 0;
                /* [é—œéµ] å…è¨±å…§å®¹å£“ç¸®ï¼Œé˜²æ­¢æ’ç ´ */
                border: none;
                padding: 0 4px;
                text-align: left;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            .hw-col-loc .hw-loc {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                /* æ–‡å­—å¤ªé•·è®Š ... */
                font-size: 1rem;
                /* [æ–°å¢] æ‰‹æ©Ÿç‰ˆå­—é«”ç¸®å°ä¸€é» (åŸæœ¬æ˜¯ 1.1rem)ï¼Œé¿å…é•·åœ°åæ“ å£“ */
            }

            /* 3. å³å´ï¼šå¤©æ°£ (é—œéµä¿®æ­£ï¼šä¸å‡†æ¶ç©ºé–“) */
            .hw-col-main {
                flex: 0 0 auto;
                /* [é—œéµ] å›ºå®šå¯¬åº¦ï¼Œä¸å‡†è‡ªå‹•è®Šå¤§ */
                padding: 0;
                /* [é—œéµ] ç§»é™¤å…§è· */
                justify-content: flex-end;
                gap: 5px;
            }

            /* åº•éƒ¨å»ºè­°æ–‡å­— */
            .hw-col-advice {
                display: block;
                width: 100%;
                border-left: none;
                border-top: 1px solid rgba(255, 255, 255, 0.3);
                padding-left: 0;
                padding-top: 8px;
                max-width: none;
                min-height: auto;
                font-size: 0.8rem;
                line-height: 1.4;
                margin-top: 5px;
            }

            /* å…¶ä»–æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
            .timeline {
                padding-left: 15px;
                padding-right: 5px;
            }

            .event {
                padding-left: 15px;
            }

            .event::before {
                left: -6px;
            }

            .ai-actions-row {
                gap: 8px;
            }

            .btn-mode {
                padding: 10px 4px;
                font-size: 0.8rem;
                flex-direction: column;
                gap: 6px;
                line-height: 1.2;
                height: 70px;
            }

            .btn-mode svg {
                width: 24px;
                height: 24px;
                margin-bottom: 0;
            }

            .price-table {
                font-size: 0.85rem;
            }
        }

        /* [æœ€çµ‚ä¿®æ­£] å¼·åˆ¶é™åˆ¶ AI æŒ‰éˆ•åœ–ç¤ºå¤§å° */
        .btn-mode .icon-sprite {
            width: 24px !important;
            height: 24px !important;
            margin-bottom: 5px;
            flex-shrink: 0;
        }

        /* [ä¿®æ”¹] 2D é«˜æ•ˆèƒ½æ»‘å‹•å¼•æ“æ¨£å¼ (High Performance Slide) */

        body {
            overflow-x: hidden;
            /* ç§»é™¤ perspectiveï¼Œæ”¹ç‚ºå¹³é¢æ»‘å‹• */
        }

        .container {
            /* ğŸ’¡ [å„ªåŒ–] å¼·åˆ¶é–‹å•Ÿ GPU ç¡¬é«”åŠ é€Ÿï¼Œæ¸›å°‘é–ƒçˆ */
            transform: translate3d(0, 0, 0);
            will-change: transform, opacity;

            /* ä¿æŒéš±è—èƒŒé¢çš„è¨­å®šï¼Œé›–ç„¶æ˜¯ 2D ä½†å¯ä»¥é˜²æ­¢æ¸²æŸ“éŒ¯èª¤ */
            backface-visibility: hidden;
        }

        /* 2. æ‰‹æŒ‡æ‹–æ›³ä¸­ (çµ•å°è·Ÿéš¨ï¼Œç„¡å»¶é²) */
        .container.is-dragging {
            transition: none !important;
            cursor: grabbing;
        }

        /* 3. æ”¾æ‰‹å¾Œçš„æ…£æ€§å‹•ç•« (ä½¿ç”¨æ‚¨æŒ‡å®šçš„ Bezier æ›²ç·š) */
        .container.is-animating {
            /* ğŸ’¡ [å„ªåŒ–] ä½¿ç”¨ cubic-bezier(0.23, 1, 0.32, 1) è®“å›å½ˆæ›´è‡ªç„¶ */
            transition: transform 0.25s cubic-bezier(0.23, 1, 0.32, 1),
                opacity 0.25s ease !important;
        }

        /* è¼”åŠ©ï¼šç•¶é é¢è¢«éš±è—æ™‚çš„ç‹€æ…‹ */
        .container.page-hidden {
            display: none;
        }

        /* [æ–°å¢] åœ–ç‰‡é»æ“Šæ”¾å¤§ (Lightbox) æ¨£å¼ */
        .lightbox-overlay {
            display: none;
            /* é è¨­éš±è— */
            position: fixed;
            z-index: 10000;
            /* æœ€é«˜å±¤ç´šï¼Œè“‹éæ‰€æœ‰æŒ‰éˆ• */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            /* æ·±é»‘èƒŒæ™¯ */
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.2s;
        }

        .lightbox-content {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
            /* [ä¿®æ”¹] ç§»é™¤ transition ä»¥å¯¦ç¾å³æ™‚è·Ÿæ‰‹æ•ˆæœ */
            /* transform: scale(1); */

            /* [æ–°å¢] æ¸¸æ¨™è®Šæ›´èˆ‡è§¸æ§å„ªåŒ– */
            cursor: grab;
            touch-action: none;
            /* é—œéµï¼šé˜²æ­¢æ‰‹æ©Ÿæ»‘å‹•æ™‚è§¸ç™¼ç€è¦½å™¨æ›é æˆ–æ²å‹• */
            transform-origin: center center;
            will-change: transform;
            /* æ•ˆèƒ½å„ªåŒ– */
        }

        .lightbox-content:active {
            cursor: grabbing;
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 25px;
            color: #fff;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10001;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* [æ–°å¢] PWA å•Ÿå‹•éå ´ç•«é¢ (Splash Screen) */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #2563EB;
            /* å¿…é ˆèˆ‡æ‚¨çš„ theme-color ä¸€è‡´ */
            z-index: 99999;
            /* ç¢ºä¿è“‹åœ¨æ‰€æœ‰å…§å®¹æœ€ä¸Šé¢ */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.6s ease-out, visibility 0.6s;
        }

        /* è®“éå ´ç•«é¢æ¶ˆå¤±çš„ç‹€æ…‹ */
        #splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            /* ç©¿é€é»æ“Š */
        }

        /* ä¸­é–“çš„é£›æ©Ÿåœ–ç¤º */
        .splash-logo {
            width: 120px;
            /* å¯ä¾éœ€æ±‚èª¿æ•´å¤§å° */
            height: 120px;
            margin-bottom: 20px;
            /* é€™è£¡å¯ä»¥åŠ å‹•ç•«ï¼Œä¾‹å¦‚è¼•å¾®æµ®å‹• */
            animation: floatPlane 3s ease-in-out infinite;
        }

        /* ä¸‹æ–¹çš„æ–‡å­— */
        .splash-text {
            color: white;
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: 2px;
            opacity: 0.9;
        }

        /* ç°¡å–®çš„æµ®å‹•å‹•ç•« */
        @keyframes floatPlane {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        /* --- [æ–°å¢] ä½å®¿é é¢å„ªåŒ–æ¨£å¼ Start --- */
        .stay-card-grid {
            display: grid;
            gap: 12px;
            font-size: 0.95rem;
        }

        .stay-row {
            display: grid;
            grid-template-columns: 85px 1fr;
            align-items: center;
            gap: 10px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #E5E7EB;
        }

        .stay-row:last-child {
            border-bottom: none;
        }

        .stay-label {
            color: #6B7280;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* åœ°å€èˆ‡ MapCode çš„é¡¯ç¤ºå€å¡Š */
        .stay-val {
            font-weight: 600;
            color: #1F2937;
            word-break: break-all;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        /* è¤‡è£½æŒ‰éˆ• */
        .btn-copy-small {
            background: white;
            border: 1px solid #D1D5DB;
            color: #4B5563;
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 6px;
            cursor: pointer;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .btn-copy-small:active {
            transform: scale(0.95);
            background: #F3F4F6;
        }

        .btn-copy-small.copied {
            border-color: #10B981;
            color: #059669;
            background: #ECFDF5;
        }

        /* åº•éƒ¨å¤§å°èˆªæŒ‰éˆ• */
        .btn-nav-large {
            width: 100%;
            background: linear-gradient(135deg, #2563EB, #1D4ED8);
            color: white;
            font-size: 1rem;
            font-weight: 700;
            padding: 14px;
            border-radius: 12px;
            border: none;
            text-decoration: none;
            /* ç§»é™¤åº•ç·š */
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
            transition: transform 0.2s;
        }

        .btn-nav-large:active {
            transform: scale(0.98);
        }

        /* MapCode å°ˆç”¨æ¨£å¼ */
        .map-code-box {
            font-family: 'Roboto Mono', monospace;
            color: #D97706;
            background: #FFFBEB;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #FCD34D;
            letter-spacing: 1px;
        }

        /* --- [æ–°å¢] ä½å®¿é é¢å„ªåŒ–æ¨£å¼ End --- */
        /* --- [æ–°å¢] è©³ç´°å¤©æ°£ Modal æ¨£å¼ --- */
        /* è«‹ç¢ºèªä¸¦ä¿®æ”¹ .weather-detail-scroll çš„å…§å®¹ */
        .weather-detail-scroll {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding: 10px 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;

            /* ğŸ‘‡ é€™æ˜¯åŸæœ¬å°±æœ‰çš„ï¼Œç¢ºä¿ iOS æ»‘å‹•é †æš¢ */
            -webkit-overflow-scrolling: touch;

            /* ğŸ‘‡ [æ–°å¢] é™åˆ¶æ²å‹•è¡Œç‚ºï¼Œé˜²æ­¢é€£é–åæ‡‰å¸¶å‹•çˆ¶å±¤ */
            overscroll-behavior-x: contain;

            /* ğŸ‘‡ [æ–°å¢] è®“æ»‘é¼ æ¸¸æ¨™è®Šæ›´ï¼Œæç¤ºå¯æŠ“å– */
            cursor: grab;
        }

        /* --- [ä¿®æ”¹] Modal é ­éƒ¨æŒ‰éˆ•ç¾¤çµ„æ¨£å¼ (å°é½Šèˆ‡é˜²è¡çª) --- */
        .modal-header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            /* æŒ‰éˆ•ä¹‹é–“çš„é–“è· */
        }

        /* çµ±ä¸€å®šç¾©é‡æ•´èˆ‡é—œé–‰æŒ‰éˆ•çš„å¤§å°èˆ‡å¤–è§€ */
        /* çµ±ä¸€å®šç¾©é‡æ•´èˆ‡é—œé–‰æŒ‰éˆ• (é€æ˜èƒŒæ™¯ç‰ˆ) */
        .btn-header-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;

            background-color: transparent;
            /* èƒŒæ™¯é€æ˜ */

            border: none;
            color: #4B5563;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;

            /* å¼·åˆ¶è¨­å®š */
            position: static !important;
            margin: 0 !important;
        }

        .btn-header-icon svg {
            width: 24px;
            height: 24px;
            stroke-width: 2;
        }

        /* --- [ä¿®æ”¹] Modal é ­éƒ¨æŒ‰éˆ•ç¾¤çµ„æ¨£å¼ (å°é½Šèˆ‡é˜²è¡çª) --- */
        .modal-header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            /* æŒ‰éˆ•ä¹‹é–“çš„é–“è· */
        }


        .btn-header-icon:active {
            background-color: #E5E7EB;
            transform: scale(0.92);
        }

        .btn-header-icon svg {
            width: 20px;
            height: 20px;
            stroke-width: 2.5;
        }

        /* ç¢ºä¿ Modal å…§éƒ¨æ²å‹•æ™‚ä¸è§¸ç™¼åº•å±¤ç¿»é  (CSS è¼”åŠ©) */
        #weather-detail-modal .modal-box {
            overscroll-behavior: contain;
            /* é˜²æ­¢æ²å‹•éŠæº¢å‡º */
        }

        /* (åŒæ™‚å»ºè­°åœ¨ä¸‹æ–¹åŠ å…¥é€™è¡Œï¼Œéš±è—é†œé†œçš„æ²è»¸ä½†ä¿ç•™åŠŸèƒ½) */
        .weather-detail-scroll::-webkit-scrollbar {
            display: none;
        }

        /* [ä¿®æ”¹] å°æ™‚é å ±æ’ç‰ˆï¼šæ™‚é–“ -> Icon -> ç‹€æ…‹ -> æ°£æº« */
        .wd-hour-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 60px;
            /* ç¨å¾®åŠ å¯¬ä»¥å®¹ç´æ–‡å­— */
            font-size: 0.85rem;
            color: #4B5563;
            gap: 4px;
            /* å…ƒç´ é–“è· */
            padding: 5px 0;
        }

        .wd-hour-time {
            font-size: 0.85rem;
            opacity: 0.9;
            font-weight: 500;
        }

        .wd-hour-icon svg {
            width: 28px;
            /* Iconç¨å¾®æ”¾å¤§ */
            height: 28px;
        }

        /* [æ–°å¢] å¤©æ°£ç‹€æ…‹æ–‡å­— (å¦‚: é™é›ª, å¤šé›²) */
        .wd-hour-desc {
            font-size: 0.75rem;
            color: #6B7280;
            font-weight: 500;
            white-space: nowrap;
            /* ä¸æ›è¡Œ */
        }

        .wd-hour-temp {
            font-weight: 700;
            color: #1F2937;
            font-size: 1.1rem;
            /* æ°£æº«æ”¾å¤§ */
        }

        /* éš±è—åŸæœ¬çš„é™é›¨æ©Ÿç‡ */
        .wd-hour-pop {
            display: none;
        }

        /* --- [ä¿®æ”¹] æœªä¾†é å ±åˆ—è¡¨å„ªåŒ– (å‚ç›´æ—¥æœŸ + å›ºå®šåœ–ç¤ºå¯¬åº¦) --- */
        .wd-daily-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            /* å¢åŠ é–“è·è®“æ‰‹æŒ‡å¥½é» */
            border-bottom: 1px dashed #eee;
            font-size: 0.95rem;
        }

        /* 1. æ—¥æœŸæ¬„ä½ï¼šæ”¹ç‚ºå‚ç›´æ’åˆ— (ä»Šå¤©åœ¨ä¸Šï¼Œæ—¥æœŸåœ¨ä¸‹) */
        .wd-day-name {
            width: 60px;
            font-weight: 600;
            color: #374151;
            display: flex;
            flex-direction: column;
            /* é—œéµï¼šè®“æ–‡å­—æ›è¡Œæ’åˆ— */
            justify-content: center;
            line-height: 1.2;
        }

        .wd-day-name span {
            font-size: 0.75rem;
            color: #999;
            font-weight: 400;
            margin-top: 2px;
        }

        /* 2. åœ–ç¤ºæ¬„ä½ï¼šå¼·åˆ¶å›ºå®šå¤§å°ï¼Œé˜²æ­¢è¢«æ“ æ‰ */
        .wd-day-icon {
            width: 48px;
            height: 32px;
            text-align: center;
            flex-shrink: 0;
            /* [é—œéµä¿®æ­£] ç¦æ­¢ç€è¦½å™¨å£“ç¸®æ­¤å€å¡Š */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .wd-day-icon svg {
            width: 32px;
            height: 32px;
            /* ç§»é™¤é è¨­é¡è‰²ï¼Œæ”¹ç”± SVG å…§éƒ¨çš„æ¼¸å±¤æ§åˆ¶ */
        }

        /* 3. é™é›¨æ©Ÿç‡ï¼šç§»é™¤æ°´æ»´åœ–ç¤ºï¼Œåªç•™æ•¸å­—ï¼Œæ”¹ç‚ºé å·¦ */
        .wd-day-pop {
            width: 45px;
            font-size: 0.8rem;
            color: #60A5FA;
            /* æ·ºè—è‰² */
            font-weight: 600;
            text-align: left;
            margin-left: 6px;
        }

        /* 4. æ°£æº«ï¼šæ”¹ç‚º Flex ä½ˆå±€ + å›ºå®šå¯¬åº¦ï¼Œè§£æ±ºå°é½Šå•é¡Œ */
        .wd-day-temp {
            flex: 1;
            display: flex;
            /* [ä¿®æ”¹] å•Ÿç”¨ Flexbox */
            justify-content: flex-end;
            /* [ä¿®æ”¹] æ•´é«”é å³ */
            gap: 10px;
            /* [ä¿®æ”¹] ä½æº«èˆ‡é«˜æº«ä¹‹é–“çš„å›ºå®šé–“è· */
            font-family: monospace;
            font-weight: 600;
        }

        /* [æ–°å¢] è¨­å®šå›ºå®šå¯¬åº¦è®“æ•¸å­—å‚ç›´å°é½Šæˆå…©åˆ— */
        .wd-temp-low,
        .wd-temp-high {
            display: inline-block;
            width: 36px;
            /* [é—œéµ] å¼·åˆ¶å›ºå®šå¯¬åº¦ï¼Œå‰µé€ éš±å½¢æ¬„ä½ */
            text-align: right;
            /* [é—œéµ] æ•¸å­—åœ¨æ¬„ä½å…§é å³å°é½Š */
        }

        .wd-temp-low {
            color: #9CA3AF;
        }

        /* ä½æº«ç¶­æŒæ·ºç° */

        /* [ä¿®æ”¹] é«˜æº« - æ”¹ç”¨è¼ƒæŸ”å’Œçš„æ·±ç°è‰² (#4B5563)ï¼Œé¿å…èˆ‡ä½æº«å°æ¯”éå¼· */
        .wd-temp-high {
            display: inline-block;
            width: 36px;
            text-align: right;
            color: #4B5563;
            /* åŸæœ¬æ˜¯ #1F2937 (å¤ªæ·±)ï¼Œç¾åœ¨æ”¹æ·¡ä¸€é» */
        }

        /* [æ–°å¢] å³æ™‚å¤©æ°£å„€è¡¨æ¿æ¨£å¼ */
        .cw-container {
            margin-bottom: 20px;
            text-align: left;
            padding: 0 5px;
        }

        /* ä¸ŠåŠéƒ¨ï¼šå¤§æº«åº¦èˆ‡ç‹€æ…‹ */
        .cw-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .cw-temp-big {
            font-size: 3.5rem;
            font-weight: 700;
            line-height: 1;
            color: #1F2937;
            letter-spacing: -2px;
        }

        .cw-info-col {
            text-align: right;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .cw-condition {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 4px;
        }

        .cw-hl-temp {
            font-size: 0.9rem;
            color: #6B7280;
            font-family: monospace;
        }

        /* ä¸‹åŠéƒ¨ï¼šå››æ ¼è³‡è¨Šå¡ (ä»¿ iOS é¢¨æ ¼) */
        .cw-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .cw-card {
            background: rgba(0, 0, 0, 0.03);
            /* [é‚„åŸ] èƒŒæ™¯æ”¹å›æ¥µæ·¡ç°è‰²ï¼Œé…åˆç°è‰²æ–‡å­— */
            border-radius: 12px;
            padding: 10px 5px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 70px;
        }

        .cw-icon {
            width: 18px;
            height: 18px;
            color: #666;
            /* [ä¿®æ”¹] åœ–ç¤ºé¡è‰²æ”¹ç‚º #666 (èˆ‡æ—¥å‡ºæ¨™ç±¤ä¸€è‡´) */
            margin-bottom: 4px;
        }

        .cw-label {
            font-size: 0.75rem;
            color: #666;
            /* [é—œéµä¿®æ”¹] æ¨™ç±¤é¡è‰²æ”¹ç‚º #666 (èˆ‡ã€Œæ—¥å‡ºã€æ–‡å­—é¡è‰²å®Œå…¨ä¸€è‡´) */
            margin-bottom: 2px;
        }

        .cw-value {
            font-size: 0.95rem;
            font-weight: 700;
            color: #333;
            /* [ä¿®æ”¹] æ•¸å€¼é¡è‰²æ”¹ç‚º #333 (èˆ‡æ—¥å‡ºã€Œæ™‚é–“ã€é¡è‰²ä¸€è‡´) */
        }

        /* [ä¿®æ”¹] è©³ç´°å¤©æ°£è³‡è¨Šå¡ (å„ªåŒ–é…è‰²èˆ‡æ°´å¹³ä½ˆå±€) */
        /* [ä¿®æ”¹] è©³ç´°å¤©æ°£è³‡è¨Šå¡ (å„ªåŒ–é…è‰²èˆ‡æ°´å¹³ä½ˆå±€) */
        .astro-box {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 20px;
            /* [ä¿®æ”¹] èƒŒæ™¯æ”¹ç‚ºæ¥µæ·¡ç°è‰² (èˆ‡ä¸Šæ–¹é«”æ„Ÿè³‡è¨Šæ¬„ä¸€è‡´)ï¼Œç§»é™¤åç™½çš„çªå…€æ„Ÿ */
            background: rgba(0, 0, 0, 0.03);
            padding: 15px 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            border: none;
            align-items: center;
        }

        /* å·¦å´ï¼šæ—¥å‡ºæ—¥è½å€ (æ”¹ç‚ºæ°´å¹³æ’åˆ—) */
        .astro-left-col {
            display: flex;
            flex-direction: row;
            /* [ä¿®æ”¹] æ°´å¹³æ’åˆ— */
            gap: 25px;
            /* å¢åŠ é–“è· */
            border-right: 1px dashed #CBD5E1;
            padding-right: 25px;
            align-items: center;
        }

        .astro-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        /* åœ–ç¤ºè¨­å®š */
        .astro-icon svg {
            width: 36px;
            /* ç¨å¾®å†å¤§ä¸€é»é» */
            height: 36px;
            fill: none;
            stroke-width: 2.5;
            /* ç·šæ¢åŠ ç²—ä¸€é»ï¼Œè§£æ±ºè®Šå½¢æ„Ÿ */
            stroke-linecap: round;
            stroke-linejoin: round;
            filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.05));
        }

        .icon-sunrise {
            stroke: #cf8402;
        }

        .icon-sunset {
            stroke: #5759cf;
        }

        .astro-time {
            font-size: 0.9rem;
            font-weight: 700;
            color: #334155;
            font-family: monospace;
        }

        /* å³å´ï¼šç¶­æŒä¸è®Š */
        .astro-right-col {
            display: flex;
            flex-direction: column;
            gap: 8px;
            justify-content: center;
        }

        /* [ä¿®æ”¹] æº«å·®æ¨™ç±¤ - é€æ˜èƒŒæ™¯ã€ç¸®å°å­—é«”ã€ä¸æ›è¡Œ */
        .diff-badge {
            display: inline-flex;
            align-items: center;
            font-size: 0.75rem;
            /* [ä¿®æ”¹] å­—é«”ç¸®å° (åŸ 0.8rem) */
            font-weight: 700;
            padding: 2px 8px;
            /* [ä¿®æ”¹] å…§è·ç¸®å°ï¼Œè®“æ¨™ç±¤æ›´ç²¾ç·» */
            border-radius: 20px;
            width: fit-content;
            white-space: nowrap;
            /* [æ–°å¢] å¼·åˆ¶æ–‡å­—ä¸æ›è¡Œ */
        }

        /* [ä¿®æ”¹] èƒŒæ™¯æ”¹ç‚º transparent (é€æ˜)ï¼Œåªä¿ç•™æœ‰é¡è‰²çš„é‚Šæ¡† */
        .diff-hot {
            background: transparent;
            color: #DC2626;
            border: 1px solid #FECACA;
        }

        .diff-cold {
            background: transparent;
            color: #2563EB;
            border: 1px solid #BFDBFE;
            /* ä¿ç•™æ‚¨æƒ³è¦çš„è—è‰²é‚Šæ¡† */
        }

        .diff-same {
            background: transparent;
            color: #64748B;
            border: 1px solid #E2E8F0;
        }

        /* ç©¿è¡£å»ºè­°æ–‡å­— */
        .advice-text-small {
            font-size: 0.85rem;
            color: #334155;
            line-height: 1.5;
            text-align: left;
        }

        /* --- [æ–°å¢] iOS å¤©æ°£å‹•æ…‹ç‰¹æ•ˆ (ä»¿ iPhone å¤©æ°£) --- */
        /* 1. Header å®¹å™¨è¨­å®š */
        .weather-bg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            /* é—œéµä¿®æ­£ï¼è®“å®ƒæµ®åœ¨èƒŒæ™¯è‰²ä¹‹ä¸Š */
            pointer-events: none;
            /* è®“æ»‘é¼ é»æ“Šå¯ä»¥ç©¿é€ç‰¹æ•ˆï¼Œé»åˆ°ä¸‹é¢çš„æŒ‰éˆ• */
        }


        /* --- å¤©æ°£èƒŒæ™¯è‰² (åƒè€ƒæ‚¨çš„æˆªåœ–é…è‰²) --- */
        /* æ™´å¤©: äº®è—æ¼¸å±¤ */
        header.w-sun {
            background: linear-gradient(180deg, #2980B9 0%, #6DD5FA 100%);
        }

        /* å¤šé›²: ç°è—æ¼¸å±¤ */
        header.w-cloud {
            background: linear-gradient(180deg, #536976 0%, #292E49 100%);
        }

        /* é›¨å¤©: æ·±ç°è— (åƒè€ƒæˆªåœ–1) */
        header.w-rain {
            background: linear-gradient(180deg, #373B44 0%, #4286f4 100%);
        }

        /* é›ªå¤©: å†°éœœæ·ºè— (åƒè€ƒæˆªåœ–2) */
        header.w-snow {
            background: linear-gradient(180deg, #83a4d4 0%, #b6fbff 100%);
        }

        /* éœ§/é™°å¤©: è¿·éœ§ç° */
        header.w-fog {
            background: linear-gradient(180deg, #757F9A 0%, #D7DDE8 100%);
        }

        /* æ™šä¸Šæ¨¡å¼ (æ¬Šé‡æœ€é«˜ï¼Œè¦†è“‹ä»¥ä¸Šé¡è‰²ï¼Œä½†ä¿ç•™ç²’å­ç‰¹æ•ˆ) */
        header.is-night {
            background: linear-gradient(180deg, #0f2027 0%, #203a43 50%, #2c5364 100%) !important;
        }

        /* [æ˜Ÿæ˜Ÿç‰¹æ•ˆ] - åƒ…åœ¨æ™´æœ—å¤œæ™šå‡ºç¾ */
        .star-particle {
            position: absolute;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 3px rgba(255, 255, 255, 0.8);
            /* å¾®å¾®ç™¼å…‰æšˆ */
            animation: twinkle linear infinite;
        }

        @keyframes twinkle {
            0% {
                opacity: 0.3;
                transform: scale(0.8);
            }

            50% {
                opacity: 1;
                transform: scale(1.2);
            }

            /* è®Šäº®è®Šå¤§ */
            100% {
                opacity: 0.3;
                transform: scale(0.8);
            }
        }

        /* --- ç²’å­å‹•ç•«å®šç¾© --- */
        /* [é›¨æ»´] */
        .rain-drop {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            width: 1px;
            height: 60px;
            top: -60px;
            animation: rain-fall 0.7s linear infinite;
        }

        @keyframes rain-fall {
            to {
                transform: translateY(400px);
            }
        }

        /* --- [æ–°] ç»ç’ƒæ°´ç ç‰¹æ•ˆ (Glass Rain) --- */
        /* --- [å‡ç´šç‰ˆ] å¯«å¯¦ç»ç’ƒæ°´ç ç‰¹æ•ˆ (Glass Rain) --- */
        .glass-surface {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            overflow: hidden;
            pointer-events: none;
        }

        .glass-drop {
            position: absolute;
            /* 1. åŸºåº•æ”¹ç‚ºå…¨é€æ˜ï¼Œä¸ä¾é èƒŒæ™¯è‰² */
            background: transparent;

            /* 2. è¤‡é›œé™°å½±ï¼šæ¨¡æ“¬å…‰ç·šæŠ˜å°„ (Refraction) èˆ‡ç«‹é«”æ„Ÿ */
            /* å…§é™°å½±(äº®) + å…§é™°å½±(æš—) + å¤–éƒ¨æŠ•å½± */
            box-shadow:
                inset 2px 2px 2px rgba(255, 255, 255, 0.4),
                inset -2px -2px 5px rgba(0, 0, 0, 0.3),
                1px 2px 4px rgba(0, 0, 0, 0.3);

            /* é è¨­åœ“è§’ï¼Œç¨å¾Œ JS æœƒéš¨æ©Ÿå¾®èª¿ */
            border-radius: 50%;
        }

        /* 3. [é—œéµ] å¢åŠ é«˜å…‰åå°„é» (Specular Highlight) - è®“å®ƒçœ‹èµ·ä¾†åƒæ°´ */
        .glass-drop::after {
            content: '';
            position: absolute;
            top: 20%;
            left: 20%;
            width: 30%;
            height: 30%;
            /* æ¨¡æ“¬å…‰æºåå°„çš„å°ç™½é» */
            background: radial-gradient(circle, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0) 70%);
            border-radius: 50%;
            filter: blur(0.5px);
        }

        /* [ä¿®æ”¹] æ»‘è½çš„æ°´æµ (æ¨¡æ“¬æ‹–å°¾æ°´ç—•) - é•·æ¢æ¼¸å±¤ */
        /* [ä¿®æ”¹] æ»‘è½çš„æ°´æµ (æ¨¡æ“¬æ‹–å°¾æ°´ç—•) - é«˜é€æ˜åº¦å¯«å¯¦ç‰ˆ */
        /* [ä¿®æ”¹] æ»‘è½çš„æ°´æµ (å‚éŒç‹€ Tapered Shape) */
        .glass-drop.trickle {
            /* 1. æ¼¸å±¤ï¼šä¸Šæ–¹å®Œå…¨é€æ˜ï¼Œä¸‹æ–¹åŠé€æ˜ç™½ */
            background: linear-gradient(to bottom,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.1) 20%,
                    rgba(255, 255, 255, 0.5) 80%,
                    rgba(255, 255, 255, 0.8) 100%);

            /* 2. å½¢ç‹€ï¼šåˆ©ç”¨ clip-path è£åˆ‡å‡ºã€Œä¸Šçª„ä¸‹å¯¬ã€çš„éŒå½¢ */
            clip-path: polygon(40% 0%, 60% 0%, 100% 100%, 0% 100%);

            /* 3. å¯¬åº¦è¨­å®š */
            width: 6px;

            /* 4. é™°å½±ï¼šå› ç‚º clip-path æœƒè£æ‰ box-shadowï¼Œæ”¹ç”¨ filter */
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));

            /* 5. å‹•ç•«è¨­å®š */
            animation-name: rain-slide-linear;
            animation-timing-function: linear;
            animation-iteration-count: 1;

            z-index: 12;
            pointer-events: none;
        }

        /* ä¿®æ­£å‹•ç•«ä½ç§»é‡ï¼Œå› ç‚ºæ°´æµè®Šé•·äº†ï¼Œéœ€è¦æ»‘å¾—æ›´é  */
        @keyframes trickle-wait-drop {
            0% {
                transform: translateY(-100%) scale(1);
                opacity: 0;
            }

            50% {
                transform: translateY(-100%) scale(1);
                opacity: 1;
            }

            /* éœæ­¢åœ¨ç•«é¢å¤–/ä¸Šæ–¹ */
            55% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            /* æ…¢æ…¢æµé€²ç•«é¢ */
            100% {
                transform: translateY(600px) scale(1);
                opacity: 0;
            }

            /* å¿«é€Ÿæ»‘è½ */
        }

        /* [æ–°] è¢«æ°´æµå¸¶èµ°(èåˆ)çš„æ•ˆæœ */
        .glass-drop.merged {
            transform: scale(0.2) translateY(20px);
            /* ç¸®å°ä¸¦ç¨å¾®å¾€ä¸‹è¢«å¸¶èµ° */
            opacity: 0;
            transition: all 0.3s ease-out;
            /* 0.3ç§’å…§å¿«é€Ÿæ¶ˆå¤± */
        }

        /* [æ–°] ç´”æ»‘è½å‹•ç•« (çµ¦ JavaScript æ§åˆ¶ç”Ÿæˆçš„å‹•æ…‹æ°´æµä½¿ç”¨) */
        /* ä¸éœ€è¦ç­‰å¾…ï¼Œç”Ÿæˆå¾Œç›´æ¥æ»‘è½ï¼Œé€™æ¨£æ–¹ä¾¿æˆ‘å€‘è¨ˆç®—ç¢°æ’æ™‚é–“ */
        @keyframes rain-slide-linear {
            0% {
                transform: translateY(-50px);
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                transform: translateY(600px);
                opacity: 0;
            }
        }

        /* [ä¿®æ”¹] å…¨è¢å¹•é£„è½ç‰¹æ•ˆï¼šåŒæ­¥æ›´æ–°é›ªèŠ±é€ å‹ */
        .snow-flake {
            position: absolute;
            /* æ”¹ç”¨ stroke='white' çš„ç‰ˆæœ¬ */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 9 L14.6 10.5 L14.6 13.5 L12 15 L9.4 13.5 L9.4 10.5 Z'/%3E%3Cpath d='M12 9 V1 M12 15 V23 M14.6 10.5 L21.5 6.5 M14.6 13.5 L21.5 17.5 M9.4 13.5 L2.5 17.5 M9.4 10.5 L2.5 6.5'/%3E%3Cpath d='M9.5 5.5 L12 7.5 L14.5 5.5 M9.5 2 L12 4 L14.5 2'/%3E%3Cpath d='M9.5 18.5 L12 16.5 L14.5 18.5 M9.5 22 L12 20 L14.5 22'/%3E%3Cpath d='M16.4 6.6 L15.9 9.75 L18.9 10.9 M19.4 4.8 L18.9 8 L21.9 9.2'/%3E%3Cpath d='M18.9 13.1 L15.9 14.25 L16.4 17.4 M21.9 14.8 L18.9 16 L19.4 19.2'/%3E%3Cpath d='M7.6 17.4 L8.1 14.25 L5.1 13.1 M4.6 19.2 L5.1 16 L2.1 14.8'/%3E%3Cpath d='M5.1 10.9 L8.1 9.75 L7.6 6.6 M2.1 9.2 L5.1 8 L4.6 4.8'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            background-color: transparent;
            opacity: 0.9;
            top: -20px;
            animation: snow-fall-rotate 5s linear infinite;
        }

        /* [æ–°å¢] é›ªèŠ±é£„è½ + è‡ªè½‰å‹•ç•« */
        @keyframes snow-fall-rotate {
            0% {
                transform: translateY(0) translateX(0) rotate(0deg);
                opacity: 0.9;
            }

            100% {
                /* å¾€ä¸‹æ‰ 300px + å¾€å³é£„ 20px + è‡ªè½‰ 360åº¦ */
                transform: translateY(400px) translateX(30px) rotate(360deg);
                opacity: 0;
            }
        }

        /* [é›²æœµé£„å‹•] */
        /* [é›²æœµé£„å‹• - æ–°ç‰ˆ] */
        /* [éœ§æ°£ç‰¹æ•ˆ - è£œå›éºå¤±çš„è¨­å®š] */
        .fog-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            /* ä½¿ç”¨æ¼¸å±¤æ¨¡æ“¬åœ°é¢å‡èµ·çš„éœ§æ°£ */
            background: linear-gradient(to top, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0.2) 60%, transparent 100%);
            filter: blur(15px);
            /* å¼·åŠ›æ¨¡ç³Šï¼Œè£½é€ æœ¦æœ§æ„Ÿ */
            animation: fog-pulse 8s infinite alternate;
            z-index: 1;
        }

        @keyframes fog-pulse {
            0% {
                opacity: 0.6;
                transform: translateY(0);
            }

            100% {
                opacity: 1;
                transform: translateY(-10px);
            }

            /* éœ§æ°£ä¸Šä¸‹æµ®å‹• */
        }

        .cloud-shape {
            position: absolute;
            width: 100px;
            height: 40px;
            background: rgba(255, 255, 255, 0.8);
            /* æé«˜ç™½åº¦ï¼Œè®“å®ƒæ›´æ˜é¡¯ */
            border-radius: 50px;
            /* åœ“è§’è† å›Šç‹€ */
            top: 20px;
            filter: blur(5px);
            /* è¼•å¾®æŸ”ç„¦å°±å¥½ï¼Œä¸è¦å¤ªç³Š */
            animation: cloud-float linear infinite;
            z-index: 2;
            /* ç¢ºä¿æœ‰ä¸€é»å±¤æ¬¡ */
        }

        /* åˆ©ç”¨å½å…ƒç´ è£½ä½œé›²çš„å‡¸èµ·é€ å‹ */
        .cloud-shape::after,
        .cloud-shape::before {
            content: '';
            position: absolute;
            background: inherit;
            border-radius: 50%;
        }

        .cloud-shape::after {
            width: 45px;
            height: 45px;
            top: -25px;
            left: 15px;
        }

        .cloud-shape::before {
            width: 35px;
            height: 35px;
            top: -15px;
            left: 45px;
        }

        /* å®šç¾©é›²æœµå¾å·¦é£„åˆ°å³çš„å‹•ç•« */
        @keyframes cloud-float {
            0% {
                left: -150px;
                opacity: 0;
            }

            10% {
                opacity: 0.8;
            }

            90% {
                opacity: 0.8;
            }

            100% {
                left: 100%;
                opacity: 0;
            }

            /* é£„å‡ºè¢å¹•å³é‚Š */
        }

        /* [å¤ªé™½å…‰æšˆ] */
        /* [å¤ªé™½å…‰æšˆ - å¼·çƒˆç…§å°„ç‰ˆ] */
        .sun-glow {
            position: absolute;
            /* 1. èª¿æ•´ä½ç½®ï¼šç¨å¾®å¾€å³ä¸Šè§’å¤–æ¨ï¼Œæ¨¡æ“¬é™½å…‰å¾è§’è½å°„å…¥ */
            top: -120px;
            right: -120px;

            /* 2. åŠ å¤§ç¯„åœï¼šè®“å…‰èŠ’è¦†è“‹åŠå€‹ Header */
            width: 300px;
            height: 300px;

            /* 3. å¼·åŒ–é¡è‰²ï¼šæ ¸å¿ƒç´”ç™½ -> ä¸­å±¤é‡‘é»ƒ -> å¤–å±¤é€æ˜ */
            background: radial-gradient(circle,
                    rgba(255, 255, 255, 0.95) 10%,
                    /* æ ¸å¿ƒæ¥µäº® */
                    rgba(253, 224, 71, 0.6) 35%,
                    /* ä¸­å±¤æš–é»ƒå…‰ */
                    rgba(255, 255, 255, 0.1) 60%,
                    /* å¤–å±¤æŸ”å…‰ */
                    transparent 75%);

            border-radius: 50%;
            /* 4. å¢åŠ æ¨¡ç³Šåº¦ï¼Œè®“å…‰ç·šæ›´æŸ”å’Œè‡ªç„¶ */
            filter: blur(40px);

            /* 5. æ··åˆæ¨¡å¼ï¼šè®“å…‰ç–ŠåŠ åœ¨è—è‰²èƒŒæ™¯ä¸Šæ›´è€€çœ¼ */
            mix-blend-mode: screen;

            animation: sun-breath 5s infinite ease-in-out;
            z-index: 1;
            /* ç¢ºä¿åœ¨èƒŒæ™¯ä¹‹ä¸Š */
            pointer-events: none;
            /* è®“é»æ“Šç©¿é€ */
        }

        /* åŠ å…¥ç¬¬äºŒå±¤å…‰æšˆ (åˆ©ç”¨å½å…ƒç´ )ï¼Œè£½é€ å…‰ç·šæ“´æ•£æ„Ÿ */
        .sun-glow::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 140%;
            height: 140%;
            /* æ¯”æœ¬é«”æ›´å¤§ */

            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 60%);
            border-radius: 50%;
            filter: blur(20px);

            /* ç¨ç«‹çš„å‘¼å¸å‹•ç•«ï¼ŒéŒ¯é–‹æ™‚é–“ */
            animation: sun-pulse-slow 7s infinite ease-in-out;
        }

        /* å‘¼å¸å‹•ç•«å®šç¾© */
        @keyframes sun-breath {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.7;
            }

            50% {
                transform: scale(1.15);
                opacity: 1;
            }

            /* è®Šå¤§ä¸”è®Šäº® */
        }

        @keyframes sun-pulse-slow {

            0%,
            100% {
                transform: translate(-50%, -50%) scale(0.9);
                opacity: 0.3;
            }

            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0.6;
            }
        }

        .btn-icon-circle {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-icon-circle:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.95);
        }

        .avatar-item {
            font-size: 1.8rem;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            border: 2px solid transparent;
            background: #f8fafc;
            flex-shrink: 0;
            transition: all 0.2s;
            line-height: 1;
        }

        .avatar-item.active {
            border-color: #2563EB;
            background: #EFF6FF;
            transform: scale(1.1);
        }

        /* ç¢ºä¿é ­åƒé …ç›®çš„é»æ“Šç¯„åœä¸è¢«æ“ å£“ */
        .avatar-item {
            /* æé«˜å±¤ç´šç¢ºä¿å¯è¢«é»æ“Š */
        }

        /* --- [æ–°å¢] è¿è³“æ¨¡æ…‹æ¡†æ¨£å¼ --- */
        #welcome-modal {
            display: none;
            /* é è¨­éš±è— */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            /* æ·±è‰²èƒŒæ™¯ */
            z-index: 10000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s;
        }

        .welcome-box {
            background: white;
            width: 90%;
            max-width: 400px;
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        /* è£é£¾æ€§èƒŒæ™¯åœ“ */
        .welcome-box::before {
            content: '';
            position: absolute;
            top: -50px;
            right: -50px;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #FBBF24, #F59E0B);
            border-radius: 50%;
            opacity: 0.2;
            z-index: 0;
        }

        .welcome-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .welcome-desc {
            font-size: 0.95rem;
            color: #6B7280;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        /* é ­åƒé¸æ“‡ç¶²æ ¼ */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .avatar-option {
            font-size: 2rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 12px;
            transition: transform 0.2s, background 0.2s;
            user-select: none;
        }

        .avatar-option:hover {
            background: #F3F4F6;
            transform: scale(1.1);
        }

        .avatar-option.selected {
            background: #EFF6FF;
            border: 2px solid #2563EB;
            box-shadow: 0 2px 5px rgba(37, 99, 235, 0.2);
        }

        /* æš±ç¨±è¼¸å…¥æ¡† */
        .input-nickname {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 1rem;
            text-align: center;
            margin-bottom: 20px;
            outline: none;
            transition: border-color 0.2s;
        }

        .input-nickname:focus {
            border-color: #2563EB;
        }

        .btn-start-trip {
            background: linear-gradient(135deg, #2563EB, #1D4ED8);
            color: white;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
            transition: transform 0.1s;
        }

        .btn-start-trip:active {
            transform: scale(0.98);
        }

        /* --- [æ–°å¢] ä½¿ç”¨è€…ç‹€æ…‹é¡¯ç¤ºå€ (æ›¿ä»£åŸæœ¬çš„è¼¸å…¥æ¡†) --- */
        .user-status-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            padding: 8px 12px;
            border-radius: 12px;
            border: 1px solid #E5E7EB;
            margin-bottom: 15px;
            cursor: pointer;
            /* è®“ä½¿ç”¨è€…çŸ¥é“å¯ä»¥é»æ“Š */
            transition: background 0.2s;
        }

        .user-status-card:active {
            background: #F9FAFB;
        }

        .user-info-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .current-avatar {
            font-size: 2rem;
            background: #F3F4F6;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .current-user-text {
            display: flex;
            flex-direction: column;
        }

        .current-user-label {
            font-size: 0.75rem;
            color: #6B7280;
            font-weight: 500;
        }

        .current-user-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1F2937;
        }

        .btn-switch-user {
            background: #EFF6FF;
            color: #2563EB;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* --- [æ–°å¢] ç™»å‡ºç¢ºèªå½ˆçª— --- */
        .logout-box {
            text-align: center;
        }

        .logout-avatar {
            font-size: 3rem;
            margin-bottom: 10px;
            display: block;
        }
    </style>
</head>

<body>
    <div id="splash-screen">
        <img src="icon-512.png" alt="App Logo" class="splash-logo">
        <div class="splash-text">ä¹å·è¦ªå­è‡ªé§•éŠ</div>
    </div>


    <svg style="display: none;">
        <defs>
            <symbol id="icon-schedule" viewBox="0 0 24 24">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </symbol>

            <symbol id="icon-stay" viewBox="0 0 24 24">
                <path
                    d="M7 13c1.66 0 3-1.34 3-3S8.66 7 7 7s-3 1.34-3 3 1.34 3 3 3zm12-6h-8v7H3V5H1v15h2v-3h18v3h2v-9c0-2.21-1.79-4-4-4z">
                </path>
            </symbol>

            <symbol id="icon-car" viewBox="0 0 24 24">
                <path
                    d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2" />
                <circle cx="7" cy="17" r="2" />
                <circle cx="17" cy="17" r="2" />
                <path d="M5 17h2" />
                <path d="M15 17h2" />
            </symbol>

            <symbol id="icon-info" viewBox="0 0 24 24">
                <path
                    d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5" />
                <path d="M9 18h6" />
                <path d="M10 22h4" />
            </symbol>

            <symbol id="icon-weather" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="5"></circle>
                <path
                    d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42">
                </path>
            </symbol>

            <symbol id="icon-ai" viewBox="0 0 24 24">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z">
                </path>
            </symbol>
            <symbol id="icon-consult" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon>
            </symbol>

            <symbol id="icon-trans" viewBox="0 0 24 24">
                <path d="M7 10h14"></path>
                <path d="M17 6l4 4-4 4"></path>
                <path d="M17 14H3"></path>
                <path d="M7 18l-4-4 4-4"></path>
            </symbol>

            <symbol id="icon-voice" viewBox="0 0 24 24">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </symbol>

            <symbol id="icon-camera" viewBox="0 0 24 24">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                <circle cx="12" cy="13" r="4"></circle>
            </symbol>

            <symbol id="icon-loc" viewBox="0 0 24 24">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
            </symbol>
            <symbol id="icon-earth" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="2" y1="12" x2="22" y2="12"></line>
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z">
                </path>
            </symbol>

            <symbol id="icon-temp" viewBox="0 0 24 24">
                <path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"></path>
            </symbol>

            <symbol id="icon-shirt" viewBox="0 0 24 24">
                <path
                    d="M20.38 3.46L16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z">
                </path>
            </symbol>

            <symbol id="icon-reset" viewBox="0 0 24 24">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </symbol>

            <symbol id="icon-nav-arrow" viewBox="0 0 24 24">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
            </symbol>
        </defs>
    </svg>
    <header>
        <div id="weather-effect-layer" class="weather-bg-layer"></div>

        <div class="header-content">

            <div class="header-title-area">
                <div class="header-title-area">
                    <h1>æ±äº¬å§Šå¦¹å°æ—…è¡Œ
                        <button class="btn-app-refresh" onclick="window.location.reload()" title="é‡æ–°æ•´ç†">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M23 4v6h-6"></path>
                                <path d="M1 20v-6h6"></path>
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                            </svg>
                        </button>
                    </h1>
                    <div class="subtitle">2026/04/25 - 04/28 (3å¤©2å¤œ)</div>
                    <div class="badge-trip">å§Šå¦¹å°æ—…è¡Œ â€¢ ç¾½ç”°å‡ºç™¼</div>
                </div>
            </div>

            <!-- å¤©æ°£è³‡è¨Šç›’ (æ“ºæ”¾åœ¨å³å´ï¼Œä¸‰æ¬„å¼è¨­è¨ˆ) -->
            <div class="header-weather-box" id="header-weather">

                <div class="hw-col-my-loc" id="hw-my-loc-box" onclick="getLocalWeather()">
                    <div class="hw-sub-label">
                        <svg class="icon-mini" style="width:12px;height:12px;vertical-align:text-top;">
                            <use href="#icon-nav-arrow"></use>
                        </svg>
                        æˆ‘çš„ä½ç½®
                    </div>
                    <div class="hw-my-data">
                        <span id="header-my-loc">å®šä½ä¸­..</span>
                        <span id="header-my-temp" style="color: var(--secondary);">--</span>
                    </div>
                </div>

                <div class="hw-col-loc" onclick="openDetailedWeatherModal()" style="cursor: pointer;">
                    <span class="hw-loc" id="hw-loc">å®šä½ä¸­...</span>
                    <span class="hw-date" id="hw-date">ç¾åœ¨ä½ç½®</span>
                    <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 2px;">
                        é»æ“ŠæŸ¥çœ‹è©³æƒ… â–¼
                    </div>
                </div>
                <div class="hw-col-main">
                    <div class="hw-icon" id="hw-icon">
                        <div class="weather-icon cloud"></div>
                    </div>
                    <div class="hw-temp-group">
                        <div class="hw-temp" id="hw-temp">--Â°</div>
                        <span class="hw-desc" id="hw-desc">è®€å–ä¸­</span>
                        <span class="hw-range" id="hw-range"></span>
                    </div>
                </div>
                <div class="hw-col-advice" id="hw-advice">
                    æ­£åœ¨è®€å–ç•¶åœ°å¤©æ°£è³‡è¨Š...
                </div>
            </div>
        </div>
    </header>

    <!-- TAB 1: è¡Œç¨‹è¡¨ -->
    <div id="view-schedule" class="container active">
        <div class="card" style="border-left: 5px solid #F59E0B; margin-bottom: 20px;">
            <div class="card-header checklist-card-header" onclick="toggleChecklist(this)">
                <div class="card-title" style="display: flex; align-items: center; gap: 6px;">
                    <svg class="icon-mini" style="color: #F59E0B;" viewBox="0 0 24 24">
                        <path d="M9 11l3 3L22 4"></path>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                    </svg>
                    è¡Œå‰æº–å‚™ Check List
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button onclick="resetChecklist(event)"
                        style="border:none; background:none; color:#9CA3AF; font-size:0.8rem; cursor:pointer; text-decoration:underline;">
                        â†º é‡ç½®
                    </button>
                    <div class="tag tag-tip" id="checklist-progress"
                        style="background:#FFFBEB; color:#D97706; font-weight:700;">è¨ˆç®—ä¸­...</div>
                    <div class="toggle-icon"
                        style="font-size: 0.8rem; color: #6B7280; font-weight: 700; transition: transform 0.3s;">â–¼</div>
                </div>
            </div>

            <div id="checklist-container" class="checklist-container">
                <div class="add-item-box" onclick="event.stopPropagation()">
                    <input type="text" id="new-item-input" class="input-add-item" placeholder="æ–°å¢æº–å‚™é …ç›®...">
                    <button class="btn-add-item" onclick="addNewCheckItem()">ï¼‹</button>
                </div>
                <div class="checklist-grid" id="checklist-list-area"></div>
            </div>
        </div>


        <!-- Day 1 -->
        <div class="day-wrapper">
            <div class="day-toggle" id="toggle-d1" onclick="toggleTimeline('d1', this)">
                <div class="day-info">
                    <h3>Day 1: æŠµé”èˆ‡ç†Šæœ¬å¸‚å€</h3>
                    <span>1/25 (æ—¥) â€¢ ä½å®¿: ç†Šæœ¬ The Blossom</span>
                </div>
                <div class="toggle-icon">â–¼</div>
            </div>
            <div id="d1" class="timeline">
                <div class="event">
                    <div class="time">11:00</div>
                    <div class="activity">æŠµé”ç†Šæœ¬æ©Ÿå ´ (KMJ)</div>
                    <div class="desc">é ˜å–è¡Œæå¾Œï¼Œå‰å¾€1æ¨“å…¥å¢ƒå¤§å»³å¤– 4è™Ÿä¹˜è»Šè™•ã€‚</div>
                    <div class="tags"><span class="tag tag-move">æ˜Ÿå®‡èˆªç©º</span></div>
                </div>
                <div class="event">
                    <div class="time">12:00</div>
                    <div class="activity">å‰å¾€ç†Šæœ¬å¸‚å€ (äº¤é€šé¸æ“‡)</div>
                    <div class="desc">
                        <ul style="list-style-type: disc; padding-left: 20px;">
                            <li><b>é¸é … A (ç›´é”å·´å£«)ï¼š</b> æ­ä¹˜åˆ©æœ¨æ´¥å·´å£«å¾€ã€Œç†Šæœ¬ç«™ã€ã€‚è»Šç¨‹ç´„60åˆ†ï¼Œæˆäººç´„1000å††ã€‚æœ€è¼•é¬†ï¼Œè¡Œæå…æ¬é‹ã€‚</li>
                            <li><b>é¸é … B (å…è²»æ¥é§+JR)ï¼š</b> æ­ä¹˜å…è²»ã€Œç©ºæ¸¯Linerã€è‡³è‚¥å¾Œå¤§æ´¥ç«™ (15åˆ†)ï¼Œè½‰ä¹˜ JR è±è‚¥æœ¬ç·šè‡³ç†Šæœ¬ç«™ (40åˆ†ï¼Œç´„480å††)ã€‚ä¸æ€•å¡è»Šï¼Œä½†éœ€è½‰ä¹˜ã€‚
                            </li>
                            <li><b>é¸é … C (è¨ˆç¨‹è»Š)ï¼š</b> ç›´æ¥å‰å¾€é£¯åº—ï¼Œè»Šç¨‹ç´„ 45-50 åˆ†ï¼Œè»Šè³‡ç´„ 5000-6000å††ã€‚</li>
                        </ul>
                    </div>
                    <div class="tags"><span class="tag tag-move">å·´å£«</span><span class="tag tag-move">JRé›»è»Š</span></div>
                </div>
                <div class="event">
                    <div class="time">13:10</div>
                    <div class="activity">é£¯åº— Check-in / å¯„æ”¾è¡Œæ</div>
                    <div class="desc">The Blossom Kumamoto (JRç†Šæœ¬ç«™æ— Amu Plazaæ¨“ä¸Š)ã€‚</div>
                    <a href="https://www.google.com/maps/search/?api=1&query=THE+BLOSSOM+KUMAMOTO" target="_blank"
                        class="btn-map">å°èˆª</a>
                </div>
                <div class="event event-meal">
                    <div class="time">13:30</div>
                    <div class="activity">åˆé¤/é»å¿ƒæ™‚æ®µï¼šç†Šæœ¬ç«™å‘¨é‚Š</div>
                    <div class="desc">
                        <ul style="list-style-type: disc;">
                            <li><b>è‚¥å¾Œå¥½ç‰©å¸‚å ´ï¼š</b> (ç†Šæœ¬ç«™å…§) æ¨è–¦ï¼šã„ããªã‚Šå›£å­ (é•·å£½åºµ)ã€ç«¹è¼ªæ²™æ‹‰ (ãƒ’ãƒ©ã‚¤)ã€‚å¿«é€Ÿè§£æ±ºã€‚</li>
                            <li><b>ç†Šæœ¬æ‹‰éºµï¼š</b> ç«™å‰æœ‰å¹¾é–“æ‹‰éºµåº—ï¼Œå¯å¿«é€Ÿé£½é¤ä¸€é “ã€‚</li>
                        </ul>
                    </div>
                    <div class="tags"><span class="tag tag-food">é¸æ“‡åˆé¤</span></div>
                </div>
                <div class="event">
                    <div class="time">15:00</div>
                    <div class="activity">ç†Šæœ¬åŸ / æ«»ä¹‹é¦¬å ´ åŸå½©è‹‘</div>
                    <div class="desc">
                        æ¬£è³å¤©å®ˆé–£å¤–è§€(ä¿®å¾©ä¸­)ï¼ŒåŸå½©è‹‘æœ‰è¨±å¤šè©¦åƒèˆ‡ç´€å¿µå“ã€‚
                        <div style="margin-top: 8px; border-top: 1px dashed #ccc; padding-top: 5px;">
                            <strong style="color: var(--food-choice); font-size: 0.9rem;">ğŸ˜‹ åŸå½©è‹‘å¿…åƒæ¨è–¦ï¼š</strong>
                            <ul
                                style="list-style-type: disc; margin-top: 5px; padding-left: 20px; font-size: 0.9rem; color: #555;">
                                <li><b>æµ·è†½å¯æ¨‚é¤… (ã†ã«ã‚³ãƒ­ãƒƒã‚±)ï¼š</b> æ¿ƒéƒæµ·è†½å…§é¤¡ï¼Œå¤–é…¥å…§è»Ÿã€‚</li>
                                <li><b>è…ä¹ƒå±‹ é¦¬è‚‰å¯æ¨‚é¤…ï¼š</b> ä¸æ•¢åƒç”Ÿé¦¬è‚‰å¯ä»¥å˜—è©¦é€™å€‹ï¼Œç„¡è…¥å‘³ã€‚</li>
                                <li><b>æŠ¹èŒ¶éœœæ·‡æ·‹ (TENTE)ï¼š</b> ç†Šæœ¬ç”¢èŒ¶è‘‰è£½ä½œï¼ŒèŒ¶é¦™æ¿ƒåšã€‚</li>
                            </ul>
                        </div>
                    </div>
                    <button class="btn-ai-guide"
                        onclick="askGeminiGuide('ç†Šæœ¬åŸå¤©å®ˆé–£èˆ‡å¿è€…', 'å‘Šè¨´5æ­²å°å­©é—œæ–¼é€™åº§åŸå ¡çš„å¿è€…æ•…äº‹æˆ–æ­¦å£«æ•…äº‹ï¼Œä¸¦çµ¦ä»–ä¸€å€‹å°‹æ‰¾åŸç‰†ä¸Šç‰¹æ®ŠçŸ³é ­çš„ä»»å‹™ã€‚')">
                        âœ¨ èªªæ•…äº‹çµ¦å­©å­è½
                    </button>
                    <a href="https://www.google.com/maps/search/?api=1&query=Sakuranobaba+Josaien" target="_blank"
                        class="btn-map">å°èˆª</a>
                    <div class="tags"><span class="tag tag-spot">è¦ªå­æ•£æ­¥</span><span class="tag tag-food">é‚Šèµ°é‚Šåƒ</span></div>
                </div>
                <div class="event">
                    <div class="time">16:45</div>
                    <div class="activity">æ°´å‰å¯ºæˆè¶£åœ’ (æ—¥å¼åº­åœ’å‚™æ¡ˆ)</div>
                    <div class="desc">è‹¥ç†Šæœ¬åŸè¡Œç¨‹çµæŸå¾—æ—©ï¼Œå¯æ­å¸‚é›»Aç³»çµ±è‡³ã€Œæ°´å‰å¯ºå…¬åœ’ã€ã€‚æ—¥å¼åº­åœ’é€ æ™¯å„ªç¾ã€‚</div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Suizenji+Jojuen" target="_blank"
                        class="btn-map">å°èˆª</a>
                    <div class="tags"><span class="tag tag-kids">å‚™æ¡ˆ</span><span class="tag tag-spot">å…¬åœ’</span></div>
                </div>
                <div class="event">
                    <div class="time">18:00</div>
                    <div class="activity" style="color: var(--kumamoto-info-text);">ä¸Šé€š/ä¸‹é€š è³¼ç‰©è¡—æ•£ç­–</div>
                    <div class="desc">
                        åœ¨æ™šé¤å‰äº«å—å¸‚å€ç†±é¬§çš„æ‹±å»Šå•†åº—è¡—ã€‚å¯æ­ä¹˜å¸‚é›»è‡³ã€Œé€šç”ºç­‹ã€æˆ–ã€Œè¾›å³¶ç”ºã€ç«™ã€‚
                        <span
                            style="display:block; font-weight: 600; margin-top: 5px;">***è©³ç›¡æ”»ç•¥èˆ‡ç¾é£Ÿé¸æ“‡è«‹è¦‹ã€Œæ—…éŠè³‡è¨Šã€é ç±¤ã€‚***</span>
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Kamitori+Shopping+Street" target="_blank"
                        class="btn-map">å°èˆªè‡³ä¸Šé€šè¡—</a>
                    <div class="tags"><span class="tag tag-shop">è³¼ç‰©</span><span class="tag tag-relax">ç¾é£Ÿé¸æ“‡å¤š</span></div>
                </div>
                <div class="event event-meal">
                    <div class="time">19:30</div>
                    <div class="activity">æ™šé¤æ™‚æ®µï¼šç†Šæœ¬å¸‚å€/è»Šç«™é¸æ“‡</div>
                    <div class="desc">
                        <ul style="list-style-type: disc;">
                            <li><b>å‹çƒˆäº­è±¬æ’ï¼š</b> (æ–°å¸‚è¡—/Amu Plaza) çŸ¥åæ—¥å¼è±¬æ’è€åº—ï¼Œç™½é£¯é«˜éº—èœå¯çºŒã€‚</li>
                            <li><b>å¤©å¤–å¤©æ‹‰éºµï¼š</b> (æ–°å¸‚è¡—) çŸ¥åè’œå‘³è±šéª¨æ‹‰éºµï¼Œé‡å£å‘³ã€‚</li>
                        </ul>
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Katsuretsutei+Amu+Plaza+Kumamoto"
                        target="_blank" class="btn-map">å‹çƒˆäº­å°èˆª</a>
                    <div class="tags"><span class="tag tag-food">é¸æ“‡æ™šé¤</span></div>
                </div>
                <div class="event">
                    <div class="time">21:00</div>
                    <div class="activity">æ™šé¤å¾Œå»ºè­°è¡Œç¨‹ (è‡ªç”±é¸æ“‡)</div>
                    <div class="desc">
                        <ul style="list-style-type: disc;">
                            <li><b>Amu Plaza è³¼ç‰© (æ¨è–¦)ï¼š</b> é£¯åº—æ¨“ä¸‹ï¼Œå¯é€›é€›è—¥å¦åº—æˆ–ä¼´æ‰‹ç¦®åº—ã€‚</li>
                            <li><b>è»Šç«™è¶…å¸‚è£œè²¨ï¼š</b> è³¼è²·éš”å¤©é›¶é£ŸåŠé£²å“ã€‚</li>
                            <li><b>é£¯åº—æ³¡æ¾¡ä¼‘æ¯ï¼š</b> ç¬¬ä¸€å¤©é•·é€”æ—…è¡Œï¼Œææ—©å›æˆ¿è®“å­©å­ä¼‘æ¯ã€‚</li>
                        </ul>
                    </div>
                    <div class="tags"><span class="tag tag-spot">è¼•é¬†</span><span class="tag tag-kids">è³¼ç‰©</span></div>
                </div>
            </div>
        </div>

        <!-- Day 2 -->
        <div class="day-wrapper">
            <div class="day-toggle" id="toggle-d2" onclick="toggleTimeline('d2', this)">
                <div class="day-info">
                    <h3>Day 2: è§€å…‰åˆ—è»Š & é»‘å·æº«æ³‰</h3>
                    <span>1/26 (ä¸€) â€¢ ä½å®¿: é»‘å·æº«æ³‰ éº“æ—…é¤¨</span>
                </div>
                <div class="toggle-icon">â–¼</div>
            </div>
            <div id="d2" class="timeline">
                <div class="alert-box" style="background: #F7FCEF; border: 1px solid #D9F99D; color: #3F6212;">
                    <div class="alert-icon time"></div>
                    <div><b>å„ªåŒ–ç›®æ¨™ï¼š</b>èª¿æ•´ä¸‹åˆè¡Œç¨‹æ™‚é–“ï¼Œç¢ºä¿ **17:05 å¾å¤§è§€å³°å‡ºç™¼**ï¼Œæ–¼ **18:00 æŠµé”é»‘å·æº«æ³‰**ã€‚</div>
                </div>
                <div class="event">
                    <div class="time">09:00</div>
                    <div class="activity">Check-out & å‰å¾€ç†Šæœ¬ç«™ JR æœˆå°</div>
                    <div class="desc">The Blossom å°±åœ¨ç†Šæœ¬ç«™æ—ï¼Œç§»å‹•éå¸¸æ–¹ä¾¿ï¼Œä½†ä»å»ºè­°é ç•™æ™‚é–“ã€‚</div>
                    <div class="tags"><span class="tag tag-move">ç§»å‹•</span></div>
                </div>
                <div class="event">
                    <div class="time">09:57</div>
                    <div class="activity">JR è§€å…‰åˆ—è»Šã€Œé˜¿è˜‡ç”·å­©!ã€</div>
                    <div class="desc">
                        ç¬¬3ç¯€è»Šå»‚è¨­æœ‰**æœ¨çƒæ± ã€å…’ç«¥åœ–æ›¸å®¤**å’Œå“ºä¹³å®¤ï¼Œè«‹é ç•™æ™‚é–“å¸¶å­©å­å»ç©ã€‚
                    </div>
                    <button class="btn-ai-guide"
                        onclick="askGeminiGuide('é˜¿è˜‡ç”·å­©è™Ÿåˆ—è»Š', 'å‘å­©å­ä»‹ç´¹é€™å°ç«è»Šä¸Šçš„å°ç‹— Kuro é†¬æ˜¯èª°ï¼Œä¸¦å»ºè­°ä¸€å€‹åœ¨ç«è»Šä¸Šå¯ä»¥ç©çš„å°‹å¯¶éŠæˆ²ã€‚')">
                        âœ¨ Kuro é†¬æ˜¯èª°ï¼Ÿ
                    </button>
                    <!-- å‚™æ¡ˆ -->
                    <div
                        style="margin-top:8px; border-top:1px dashed #ccc; padding-top:5px; font-size:0.85rem; color:#666;">
                        ğŸš‚ <b>åœé§›å‚™æ¡ˆï¼š</b> è‹¥é‡åœé§›ï¼Œå¯æ”¹æ­ <b>ä¹å·æ©«æ–·ç‰¹æ€¥ (09:11ç™¼)</b> æˆ– <b>æ™®é€šåˆ—è»Š</b>ã€‚é›–ç„¡è¦ªå­è¨­æ–½ï¼Œä½†ä»å¯æ¬£è³æ²¿é€”é¢¨æ™¯ã€‚
                    </div>
                    <div class="tags"><span class="tag tag-move">ç«è»Š</span><span class="tag tag-kids">è¦ªå­å¿…éŠ</span></div>
                </div>
                <div class="event">
                    <div class="time">11:27</div>
                    <div class="activity">æŠµé”é˜¿è˜‡ç«™ (å–è»Šæº–å‚™)</div>
                    <div class="desc">åˆ—è»Šæº–æ™‚æŠµé”é˜¿è˜‡ç«™ã€‚è«‹æº–å‚™å‰å¾€ç§Ÿè»Šè¡Œã€‚</div>
                    <div class="tags"><span class="tag tag-move">æŠµé”</span></div>
                </div>
                <div class="event">
                    <div class="time">11:40</div>
                    <div class="activity">Toyota ç§Ÿè»Š - é˜¿è˜‡ç«™å‰åº— (å–è»Š)</div>
                    <div class="desc">
                        <b>ç§Ÿè»Šè¡Œï¼š</b> Toyota Rent a Car é˜¿è˜‡ç«™å‰åº— (ãƒˆãƒ¨ã‚¿ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼é˜¿è˜‡é§…å‰åº—)ã€‚å»ºè­°é ç•™ 30-45 åˆ†é˜è¾¦ç†æ‰‹çºŒã€‚
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Toyota+Rent+a+Car+é˜¿è˜‡é§…å‰åº—" target="_blank"
                        class="btn-map">å°èˆªè‡³ç§Ÿè»Šè¡Œ</a>
                    <div class="tags"><span class="tag tag-car">Toyota</span><span class="tag tag-move">ç§Ÿè»Šé–‹å§‹</span>
                    </div>
                </div>
                <div
                    style="text-align:center; margin: 20px 0 10px 0; color:#6B7280; font-size:0.9rem; font-weight:600; display:flex; align-items:center; justify-content:center; gap:10px;">
                    <span>ğŸ‘‡ ä¸‹åˆè¡Œç¨‹äºŒé¸ä¸€ (è¦–å¤©æ°£/é«”åŠ›æ±ºå®š) ğŸ‘‡</span>
                </div>

                <div
                    style="border: 2px solid #D1FAE5; background: #ECFDF5; border-radius: 12px; padding: 15px; margin-bottom: 20px; position:relative;">
                    <div
                        style="position:absolute; top:-12px; left:15px; background:#059669; color:white; padding:2px 10px; border-radius:12px; font-size:0.8rem; font-weight:bold;">
                        â˜€ï¸ æ–¹æ¡ˆ Aï¼šç¶“å…¸é˜¿è˜‡é¢¨å…‰
                    </div>

                    <div class="event event-meal optimized" style="margin-top:10px;">
                        <div class="time">12:20</div>
                        <div class="activity">åˆé¤ï¼šé˜¿è˜‡èµ¤ç‰›ä¸¼ (ã„ã¾ãã‚“)</div>
                        <div class="desc">è‹¥æ’éšŠéé•·ï¼Œå»ºè­°æ”¹åƒé™„è¿‘å…¶ä»–é¤å»³ä»¥ç¯€çœæ™‚é–“ã€‚</div>
                        <a href="https://www.google.com/maps/search/?api=1&query=ã„ã¾ãã‚“é£Ÿå ‚+é˜¿è˜‡" target="_blank"
                            class="btn-map">å°èˆª</a>
                    </div>
                    <div class="event optimized">
                        <div class="time">13:40</div>
                        <div class="activity">é˜¿è˜‡ç¥ç¤¾ (åƒæ‹œ)</div>
                        <div class="desc">åƒè§€æ¨“é–€èˆ‡å•†åº—è¡—ï¼Œç¥ˆæ±‚æ—…é€”å¹³å®‰ã€‚</div>
                    </div>
                    <div class="event optimized" style="margin-bottom:0;">
                        <div class="time">14:45</div>
                        <div class="activity">è‰åƒé‡Œ (ç«å±±åšç‰©é¤¨)</div>
                        <div class="desc">æ¬£è³é˜¿è˜‡ç«å±±ç¾¤èˆ‡æ”¾ç‰§ç¾æ™¯ã€‚</div>
                        <a href="https://www.google.com/maps/search/?api=1&query=Kusasenri+Coffee+Roastery"
                            target="_blank" class="btn-map">å°èˆª</a>
                    </div>
                </div>

                <div
                    style="border: 2px solid #BAE6FD; background: #F0F9FF; border-radius: 12px; padding: 15px; margin-bottom: 20px; position:relative;">
                    <div
                        style="position:absolute; top:-12px; left:15px; background:#0284C7; color:white; padding:2px 10px; border-radius:12px; font-size:0.8rem; font-weight:bold;">
                        â„ï¸ æ–¹æ¡ˆ Bï¼šä¹é‡ç©é›ªè¶£
                    </div>

                    <div class="event event-meal" style="margin-top:10px;">
                        <div class="time">12:15</div>
                        <div class="activity">åˆé¤ï¼šé˜¿è˜‡é“ä¹‹é©› (ä¾¿ç•¶)</div>
                        <div class="desc">è³¼è²·ç†Šæœ¬ç†Šä¾¿ç•¶æˆ–è¼•é£Ÿï¼Œåœ¨è»Šä¸Šæˆ–ä¼‘æ¯å€å¿«é€Ÿè§£æ±ºï¼Œçˆ­å–ç©é›ªæ™‚é–“ã€‚</div>
                    </div>
                    <div class="event" style="margin-bottom:0;">
                        <div class="time">13:30 - 15:30</div>
                        <div class="activity">ä¹é‡æ£®æ—å…¬åœ’æ»‘é›ªå ´</div>
                        <div class="desc">
                            ç§Ÿå€‹é›ªç›† (Sled) è®“å­©å­æ”¾é›»ï¼
                            <ul style="margin-top:5px; padding-left:20px; font-size:0.85rem; color:#555;">
                                <li><b>è·é›¢ï¼š</b>å¾é˜¿è˜‡ç«™é–‹è»Šç´„ 50 åˆ†é˜ã€‚</li>
                                <li><b>è£å‚™ï¼š</b>ç¾å ´å¯ç§Ÿé›ªè¡£æ‰‹å¥—ï¼Œäººåˆ°å°±å¥½ã€‚</li>
                            </ul>
                        </div>
                        <button class="btn-ai-guide" onclick="askGeminiGuide('ä¹é‡æ»‘é›ªå ´', 'ç”¨èˆˆå¥®çš„èªæ°£é‚€è«‹å­©å­å»æ»‘é›ªï¼Œä¸¦èªªæ˜ç©é›ªç›†æœ‰å¤šåˆºæ¿€å®‰å…¨ã€‚')">
                            âœ¨ AI ä»‹ç´¹æ»‘é›ªå ´
                        </button>
                        <a href="http://googleusercontent.com/maps.google.com/search?q=Kuju+Forest+Park+Skiing+Ground"
                            target="_blank" class="btn-map">å°èˆªè‡³æ»‘é›ªå ´</a>
                    </div>
                </div>
                <div class="event optimized">
                    <div class="time">16:00</div>
                    <div class="activity" style="color: var(--secondary);">é˜¿è˜‡å¤§è§€å³° (Daikanbo Lookout)</div>
                    <div class="desc">
                        çœºæœ›é˜¿è˜‡äº”å²³ã€Œæ¶…æ§ƒåƒã€çµ•æ™¯ï¼Œåœè»Šå ´æ—æœ‰ä¼´æ‰‹ç¦®èˆ‡é»å¿ƒåº—ã€‚
                        <span style="color:var(--danger); font-weight: 600;">***é‡è¦ï¼šè«‹å‹™å¿…åœ¨ 17:05 å‰ä¸Šè»Šå‡ºç™¼***</span>ã€‚
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Daikanbo+Lookout" target="_blank"
                        class="btn-map">å°èˆª</a>
                    <div class="tags"><span class="tag tag-spot">æ™¯è§€</span></div>
                </div>
                <div class="event optimized">
                    <div class="time">17:05</div>
                    <div class="activity" style="color: var(--danger); font-weight: 700;">å‰å¾€é»‘å·æº«æ³‰ (è‡ªé§• 55åˆ†)</div>
                    <div class="desc">
                        <span style="color:var(--danger); font-weight: 600;">âš ï¸ å±±è·¯é§•é§›è«‹å°å¿ƒï¼š</span> å†¬å­£å±±è·¯ï¼Œè«‹å‹¿è¶…é€Ÿä¸¦æ³¨æ„å®‰å…¨ã€‚
                    </div>
                    <div class="tags"><span class="tag tag-move">æº–æ™‚å‡ºç™¼ï¼</span></div>
                </div>
                <div class="event event-meal">
                    <div class="time" style="color: var(--primary); font-weight: 700;">18:00</div>
                    <div class="activity" style="color: var(--primary); font-weight: 700;">æˆåŠŸæŠµé”é»‘å·æº«æ³‰æ—…é¤¨</div>
                    <div class="desc">è¾¦ç†å…¥ä½æ‰‹çºŒï¼Œæ”¾é¬†ä¼‘æ¯ã€‚</div>
                    <div class="info-detail-box" style="border: 1px dashed #10B981; margin-top: 15px;">
                        <h4 style="color:#10B981;">ğŸ‘‰ æ—…é¤¨å°èˆªè³‡è¨Š (é›»è©±)</h4>
                        <div class="info-grid">
                            <div class="info-label">éº“æ—…é¤¨</div>
                            <div class="info-val">0967-44-0103</div>
                        </div>

                        <span
                            style="display: block; font-size: 0.8rem; color: #666; margin-top: 5px;">å»ºè­°ä½¿ç”¨é›»è©±è™Ÿç¢¼è¼¸å…¥è»Šç”¨å°èˆªã€‚</span>
                    </div>
                </div>
                <div class="event event-meal">
                    <div class="time">19:00</div>
                    <div class="activity">æ™šé¤: æ—…é¤¨æœƒå¸­æ–™ç†</div>
                    <div class="desc">åœ¨æ—…é¤¨äº«ç”¨ç²¾ç·»çš„æ—¥å¼æœƒå¸­æ™šé¤ (é€šå¸¸æ™šé¤æ™‚é–“ç‚º 18:30-19:30)ã€‚</div>
                    <div class="tags"><span class="tag tag-stay">æº«æ³‰æ—…é¤¨</span><span class="tag tag-food">å·²åŒ…å«</span></div>
                </div>
                <div class="event">
                    <div class="time">21:00</div>
                    <div class="activity">é»‘å·æº«æ³‰è¡— å¤œé–“æ•£ç­– (æ¥µæ¨è–¦)</div>
                    <div class="desc">
                        ç©¿è‘—æµ´è¡£ï¼Œæ¼«æ­¥æ–¼é»ç¶´è‘—æŸ”å’Œç‡ˆç± çš„æº«æ³‰è¡—ã€‚æ°£æ°›å¯§éœï¼Œéå¸¸é©åˆæ”¾é¬†ã€‚
                        <span style="display:block; margin-top: 5px;">âš ï¸ è«‹æ³¨æ„å†¬å­£ä¿æš–ï¼Œä¸¦ç¢ºä¿å­©å­è…³æ­¥å®‰å…¨ã€‚</span>
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Kurokawa+Onsen+Town" target="_blank"
                        class="btn-map">æº«æ³‰è¡—ä¸­å¿ƒå°èˆª</a>
                    <div class="tags"><span class="tag tag-relax">æ”¾é¬†</span><span class="tag tag-kids">è¦ªå­é«”é©—</span></div>
                </div>
            </div>
        </div>

        <!-- Day 3 -->
        <div class="day-wrapper">
            <div class="day-toggle" id="toggle-d3" onclick="toggleTimeline('d3', this)">
                <div class="day-info">
                    <h3>Day 3: åˆ¥åºœæµ·åœ°ç„ã€é‡ç”Ÿå‹•ç‰©åœ’ & ç”±å¸ƒé™¢</h3>
                    <span>1/27 (äºŒ) â€¢ ä½å®¿: ç”±å¸ƒé™¢ æ¹¯å¸ƒé™¢å±±ç‡ˆèˆ˜</span>
                </div>
                <div class="toggle-icon">â–¼</div>
            </div>
            <div id="d3" class="timeline">
                <div class="alert-box"
                    style="background: var(--beppu-bg); border: 1px solid var(--beppu-info); color: #075985;">
                    <div class="alert-icon onsen"></div>
                    <div><b>è¡Œç¨‹æç¤ºï¼š</b>æµ·åœ°ç„å·²åŠ å…¥æ­¤è¡Œç¨‹ï¼æ‚¨å°‡å¾é»‘å·æº«æ³‰å‡ºç™¼ï¼Œ**åœ¨å‰å¾€ç”±å¸ƒé™¢çš„é€”ä¸­ç¶“éåˆ¥åºœä¸¦åƒè§€æµ·åœ°ç„**ï¼Œå®Œç¾ä¸²è¯è¡Œç¨‹ã€‚</div>
                </div>
                <div class="event event-meal">
                    <div class="time">06:30</div>
                    <div class="activity">æ—©é¤: æ—…é¤¨å…§äº«ç”¨</div>
                    <div class="desc">äº«ç”¨é»‘å·æº«æ³‰æ—…é¤¨è±ç››çš„æ—¥å¼æ—©é¤ã€‚</div>
                    <div class="tags"><span class="tag tag-stay">æº«æ³‰æ—…é¤¨</span><span class="tag tag-food">å·²åŒ…å«</span></div>
                </div>
                <div class="event">
                    <div class="time">08:00</div>
                    <div class="activity">é»‘å·æº«æ³‰æ•£ç­– & Check-out</div>
                    <div class="desc">åœ¨é€€æˆ¿å‰è³¼è²·ã€Œå…¥æ¹¯æ‰‹å½¢ã€é€›æº«æ³‰è¡—ï¼Œäº«å—æ—©æ™¨çš„å¯§éœã€‚</div>
                    <div class="tags"><span class="tag tag-relax">æ•£æ­¥</span></div>
                </div>
                <div class="event">
                    <div class="time">09:00</div>
                    <div class="activity">ç§»å‹•è‡³åˆ¥åºœåœ°ç„å€ (è‡ªé§• 1å°æ™‚30åˆ†)</div>
                    <div class="desc">è»Šç¨‹è¼ƒé•·ï¼Œå»ºè­°æº–å‚™å¥½å­©å­çš„é›¶é£Ÿå’Œå¨›æ¨‚ã€‚</div>
                    <div class="tags"><span class="tag tag-move">ç§»å‹•</span><span class="tag tag-car">é«˜é€Ÿ/å±±è·¯</span></div>
                </div>
                <div class="event">
                    <div class="time" style="color: var(--beppu-info); font-weight: 700;">10:30</div>
                    <div class="activity" style="color: var(--beppu-info); font-weight: 700;">æŠµé” åˆ¥åºœ æµ·åœ°ç„ (Umi Jigoku)
                    </div>
                    <div class="desc">
                        åœ°ç„å·¡ç¦®ä¸­æœ€å¤¢å¹»çš„ä¸€è™•ï¼å› ä½”åœ°è¼ƒå¤§ï¼Œå»ºè­°åœç•™ç´„ **75åˆ†é˜**ã€‚
                        <ul style="list-style-type: disc; margin-top: 5px; padding-left: 20px;">
                            <li>**å¿…çœ‹ï¼š** éˆ·è—è‰²çš„æº«æ³‰æ°´ã€ç†±å¸¶ç¡è“®æ± ï¼ˆé¬¼è“®ï¼‰ã€æº«æ³‰é›è›‹ã€‚</li>
                            <li>**å‚™æ¡ˆï¼š** æµ·åœ°ç„æ—çš„ **ç¶åœ°ç„ï¼ˆKamado Jigokuï¼‰** ä¹Ÿå¾ˆæ¨è–¦ï¼Œä»¥å¤šç¨®é¡è‰²çš„æº«æ³‰å’Œé£²ç”¨æº«æ³‰èåï¼Œè‹¥æ™‚é–“è¨±å¯å¯ä¸€ä½µåƒè§€ï¼ˆå¤šåŠ  30 åˆ†é˜ï¼‰ã€‚</li>
                        </ul>
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=åˆ¥åºœ+æµ·åœ°ç„" target="_blank"
                        class="btn-map">å°èˆªè‡³æµ·åœ°ç„</a>
                    <div class="tags"><span class="tag tag-beppu">åˆ¥åºœåœ°ç„</span><span class="tag tag-spot">æ™¯è§€</span></div>
                </div>
                <div class="event event-meal">
                    <div class="time">13:45</div>
                    <div class="activity">åˆé¤æ™‚æ®µï¼šåœ°ç„å‘¨é‚Šè¼•é£Ÿ/ç§»å‹•ä¸­</div>
                    <div class="desc">
                        <ul style="list-style-type: disc;">
                            <li><b>åœ°ç„è’¸æ–™ç†/æº«æ³‰è›‹ï¼š</b> åœ¨åœ°ç„å€å¿«é€Ÿè³¼è²·è¼•é£Ÿ (å¦‚æº«æ³‰è›‹æˆ–åœ°ç„è’¸å¸ƒä¸) ç•¶ä½œåˆé¤ã€‚</li>
                            <li><b>å‹•ç‰©åœ’åœ’å…§é¤å»³ï¼š</b> è‹¥åœ¨åœ°ç„å€æœªç”¨é¤ï¼Œå‰‡ç›´æ¥å‰å¾€å‹•ç‰©åœ’åœ¨åœ’å…§ç”¨é¤ã€‚</li>
                        </ul>
                    </div>
                    <div class="tags"><span class="tag tag-food">é¸æ“‡åˆé¤</span></div>
                </div>
                <div class="event">
                    <div class="time">12:30</div>
                    <div class="activity">æŠµé” ä¹å·è‡ªç„¶å‹•ç‰©å…¬åœ’ (African Safari)</div>
                    <div class="desc">å¾åœ°ç„å€è‡ªé§•ç´„ 15-20 åˆ†é˜å¯æŠµé”ã€‚åœè»Šå ´å¾ˆå¤§ï¼Œè«‹ç•™æ„è·¯æ¨™ã€‚</div>
                    <a href="https://www.google.com/maps/search/?api=1&query=African+Safari+Oita" target="_blank"
                        class="btn-map">å°èˆª</a>
                    <div class="tags"><span class="tag tag-move">æŠµé”</span></div>
                </div>
                <div class="event">
                    <div class="time">12:30 - 16:30</div>
                    <div class="activity">ä¹å·è‡ªç„¶å‹•ç‰©å…¬åœ’ (4å°æ™‚éŠç©)</div>
                    <div class="desc">
                        **æ™‚é–“å»ºè­°ï¼š** è‡ªé§•è§€è³ (30åˆ†é˜) + å¢æ—å·´å£« (50åˆ†é˜) + è¦ªè¿‘å€ (1å°æ™‚30åˆ†é˜)ã€‚
                        **è«‹å‹™å¿…ææ—©é ç´„å¢æ—å·´å£«å ´æ¬¡ï¼Œä¸¦å®‰æ’åœ¨ 15:00 å·¦å³é–‹å§‹ã€‚** è©³æƒ…è«‹è¦‹ã€Œæ—…éŠè³‡è¨Šã€é ç±¤ã€‚
                    </div>
                    <button class="btn-ai-guide"
                        onclick="askGeminiGuide('ä¹å·è‡ªç„¶å‹•ç‰©å…¬åœ’', 'è«‹ç”¨èª‡å¼µæœ‰è¶£çš„èªæ°£ï¼Œå‘Šè¨´å­©å­ç­‰ä¸€ä¸‹æœƒçœ‹åˆ°ç…å­è€è™å°±åœ¨è»Šå­æ—é‚Šï¼Œä¸¦æé†’ä»–å€‘è¦æ³¨æ„çœ‹ä»€éº¼å‹•ç‰©çš„ç‰™é½’ã€‚')">
                        âœ¨ å•Ÿå‹•æ¢éšªæ¨¡å¼
                    </button>
                    <div class="tags"><span class="tag tag-kids">è¦ªå­å¿…éŠ</span><span class="tag tag-spot">å‹•ç‰©åœ’</span></div>
                </div>
                <div class="event">
                    <div class="time">16:30</div>
                    <div class="activity">å‰å¾€ç”±å¸ƒé™¢æº«æ³‰ (å±±ç‡ˆé¤¨)</div>
                    <div class="desc">è»Šç¨‹ç´„ 40åˆ†é˜ï¼Œå¤©è‰²å·²æš—ï¼Œè«‹å°å¿ƒé§•é§›ã€‚</div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Yufuin+Santoukan" target="_blank"
                        class="btn-map">å°èˆªè‡³å±±ç‡ˆé¤¨</a>
                    <div class="tags"><span class="tag tag-move">ç§»å‹•</span><span class="tag tag-stay">ä½å®¿ç¢ºèª</span></div>
                </div>
                <div class="event event-meal">
                    <div class="time">18:30</div>
                    <div class="activity">æ™šé¤: æ—…é¤¨æœƒå¸­æ–™ç†</div>
                    <div class="desc">ç”±å¸ƒé™¢æ—…é¤¨è²»ç”¨é€šå¸¸åŒ…å«ç²¾ç·»çš„æ—¥å¼æœƒå¸­æ™šé¤ï¼Œè«‹ç›¡æƒ…äº«å—ï¼</div>
                    <div class="tags"><span class="tag tag-stay">æº«æ³‰æ—…é¤¨</span><span class="tag tag-food">å·²åŒ…å«</span></div>
                </div>
                <div class="event">
                    <div class="time">20:30</div>
                    <div class="activity">ç”±å¸ƒé™¢æº«æ³‰å€ æ‚ é–’æ•£æ­¥</div>
                    <div class="desc">
                        æ¹¯ä¹‹åªè¡—é“åº—å®¶å¤šå·²æ‰“çƒŠï¼Œä½†å¤œæ™šçš„ç”±å¸ƒé™¢å®‰éœä¸”æ˜Ÿç©ºæ¸…æ™°ã€‚å¯æ•£æ­¥è‡³é‡‘é±—æ¹–æ¬£è³å¤œè‰²ï¼Œæˆ–åœ¨æ—…é¤¨ä¼‘æ¯ã€‚
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Kinrin+Lake" target="_blank"
                        class="btn-map">é‡‘é±—æ¹–æ–¹å‘å°èˆª</a>
                    <div class="tags"><span class="tag tag-relax">æ”¾é¬†</span></div>
                </div>
            </div>
        </div>

        <!-- Day 4 -->
        <div class="day-wrapper">
            <div class="day-toggle" id="toggle-d4" onclick="toggleTimeline('d4', this)">
                <div class="day-info">
                    <h3>Day 4: ç”±å¸ƒé™¢è‡³ç¦å²¡</h3>
                    <span>1/28 (ä¸‰) â€¢ ä½å®¿: ç¦å²¡ ä¼‘é›·å…‹è“‹ç‰¹</span>
                </div>
                <div class="toggle-icon">â–¼</div>
            </div>
            <div id="d4" class="timeline">
                <div class="event event-meal">
                    <div class="time">08:00</div>
                    <div class="activity">æ—©é¤: æ—…é¤¨å…§äº«ç”¨</div>
                    <div class="desc">äº«ç”¨ç”±å¸ƒé™¢æ—…é¤¨çš„è±ç››æ—©é¤ã€‚</div>
                    <div class="tags"><span class="tag tag-stay">æ—…é¤¨</span><span class="tag tag-food">å·²åŒ…å«</span></div>
                </div>
                <div class="event">
                    <div class="time">09:30</div>
                    <div class="activity">é‡‘é±—æ¹– & æ¹¯ä¹‹åªè¡—é“</div>
                    <div class="desc">æ™¨éœ§ç¾æ™¯ï¼Œè¡—é“ä¸Šæœ‰å²åŠªæ¯”èŒ¶å±‹ã€MiffyéºµåŒ…åº—ã€‚</div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Kinrin+Lake" target="_blank"
                        class="btn-map">å°èˆª</a>
                    <div class="tags"><span class="tag tag-kids">å¥½é€›</span></div>
                </div>

                <!-- COMICO ART MUSEUM INSERTED HERE -->
                <div class="event">
                    <div class="time">11:00</div>
                    <div class="activity">COMICO ART MUSEUM YUFUIN</div>
                    <div class="desc">
                        ç”±éšˆç ”å¾è¨­è¨ˆçš„ç¾ä»£ç¾è¡“é¤¨ï¼Œå±•å‡ºè‰é–“å½Œç”Ÿç­‰å¤§å¸«ä½œå“ï¼Œå»ºç¯‰èˆ‡ç”±å¸ƒå²³æ™¯è§€èåˆï¼Œéå¸¸å€¼å¾—ä¸€è¨ªã€‚
                        <span
                            style="display:block; font-size: 0.8rem; color: #666; margin-top: 5px;">*å»ºè­°äº‹å…ˆä¸Šç¶²é ç´„è³¼ç¥¨ã€‚</span>
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=COMICO+ART+MUSEUM+YUFUIN" target="_blank"
                        class="btn-map">å°èˆª</a>
                    <div class="tags"><span class="tag tag-spot">è—è¡“</span><span class="tag tag-spot">å»ºç¯‰</span></div>
                </div>

                <div class="event event-meal">
                    <div class="time">12:30</div>
                    <div class="activity">åˆé¤æ™‚æ®µï¼šç”±å¸ƒé™¢å¿…åƒé‡œé£¯</div>
                    <div class="desc">
                        <ul style="list-style-type: disc;">
                            <li><b>ç”±å¸ƒã¾ã¶ã— å¿ƒ (ç”±å¸ƒé‡œé£¯)ï¼š</b> è¶…äººæ°£æ’éšŠååº—ï¼Œæ¨è–¦è±å¾Œç‰›é‡œé£¯æˆ–åœ°é›é‡œé£¯ï¼Œä¸€é‹ä¸‰åƒï¼ˆåŸå‘³ã€åŠ ä½æ–™ã€èŒ¶æ³¡é£¯ï¼‰ã€‚å»ºè­°æå‰æ’éšŠæˆ–é¿é–‹å°–å³°ã€‚</li>
                            <li><b>æ¹¯ä¹‹åªè¡—é“å°åƒï¼š</b> è‹¥ä¸æƒ³ä¹…å€™ï¼Œå¯é¸æ“‡æ²¿è¡—åƒè±å¾Œç‰›ä¸²ç‡’ã€å¯æ¨‚é¤…ç­‰ã€‚</li>
                        </ul>
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Yufu+Mabushi+Shin" target="_blank"
                        class="btn-map">å°èˆªè‡³ç”±å¸ƒé‡œé£¯</a>
                    <div class="tags"><span class="tag tag-food">é¸æ“‡åˆé¤</span><span class="tag tag-spot">æ’éšŠç¾é£Ÿ</span></div>
                </div>
                <div class="event">
                    <div class="time">13:30</div>
                    <div class="activity">å‰å¾€ç¦å²¡å¸‚å€ (é–‹å§‹ç§»å‹•)</div>
                    <div class="desc">è¸ä¸Šå›ç¦å²¡çš„æ­¸é€”ï¼Œç¸½è»Šç¨‹ç´„ 2.5å°æ™‚ã€‚</div>
                    <div class="tags"><span class="tag tag-move">ç§»å‹•</span></div>
                </div>

                <!-- NEW STOP: YAMADA SA -->
                <div class="event">
                    <div class="time">14:40</div>
                    <div class="activity">ä¸­é€”ä¼‘æ¯ï¼šå±±ç”°æœå‹™å€ (Yamada SA)</div>
                    <div class="desc">
                        ä½æ–¼é«˜é€Ÿå…¬è·¯ä¸Šçš„å¤§å‹ä¼‘æ¯ç«™ï¼Œç’°å¢ƒå„ªç¾ï¼Œæœ‰éºµåŒ…åº—ã€è¾²ç”¢å“å’Œä¹¾æ·¨çš„æ´—æ‰‹é–“ã€‚é©åˆåœè»Šè®“å­©å­æ´»å‹•ç­‹éª¨ã€‚
                        <span style="display:block; font-size: 0.8rem; color: #666; margin-top: 5px;">*åœç•™ç´„ 20 åˆ†é˜ã€‚</span>
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Yamada+Service+Area+Up+Line"
                        target="_blank" class="btn-map">å°èˆªè‡³å±±ç”°SA</a>
                    <div class="tags"><span class="tag tag-relax">ä¼‘æ¯ç«™</span><span class="tag tag-food">è£œçµ¦</span></div>
                </div>

                <!-- èª¿æ•´çš„é‚„è»Šè¡Œç¨‹ -->
                <div class="event">
                    <div class="time">16:10</div>
                    <div class="activity">å¸‚å€åŠ æ²¹ (é‚„è»Šå‰æ»¿æ²¹)</div>
                    <div class="desc">
                        ä¾è¦å®šéœ€åŠ æ»¿æ²¹é‚„è»Šã€‚å»ºè­°å‰å¾€é™„è¿‘çš„åŠ æ²¹ç«™ã€‚
                    </div>
                    <a href="https://www.google.com/maps/search/gas+station+near+Toyota+Rent+a+Car+Hakata+Station+Hakata+Exit"
                        target="_blank" class="btn-map">æœå°‹é™„è¿‘åŠ æ²¹ç«™</a>
                    <div class="tags"><span class="tag tag-car">åŠ æ²¹</span></div>
                </div>
                <div class="event">
                    <div class="time">16:30</div>
                    <div class="activity">æ­¸é‚„ç§Ÿè³ƒè»Šè¼› (Toyota åšå¤šé§…åšå¤šå£åº—)</div>
                    <div class="desc">
                        <b>é‚„è»Šé»ï¼š</b> Toyota Rent a Car åšå¤šé§…åšå¤šå£åº—ã€‚<br>
                        è«‹å‹™å¿…æ”œå¸¶åŠ æ²¹æ”¶æ“šä»¥ä¾›æŸ¥é©—ã€‚
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Toyota+Rent+a+Car+Hakata+Station+Hakata+Exit"
                        target="_blank" class="btn-map">å°èˆªè‡³é‚„è»Šé»</a>
                    <div class="tags"><span class="tag tag-move">é‚„è»Š</span></div>
                </div>
                <!-- èª¿æ•´çµæŸ -->
                <div class="event">
                    <div class="time">18:00</div>
                    <div class="activity">é£¯åº— Check-in</div>
                    <div class="desc">ä¼‘é›·å…‹è“‹ç‰¹ The Gate Hotelã€‚</div>
                    <div class="tags"><span class="tag tag-stay">å¸‚å€é£¯åº—</span></div>
                </div>
                <div class="event event-meal">
                    <div class="time">20:00</div>
                    <div class="activity">æ™šé¤æ™‚æ®µï¼šç¦å²¡åœ¨åœ°ç¾é£Ÿé¸æ“‡</div>
                    <div class="desc">
                        <ul style="list-style-type: disc;">
                            <li><b>åšå¤šç‰›è…¸é‹ (ã‚‚ã¤é‹)ï¼š</b> å†¬å¤©å¿…åƒï¼Œæš–èƒƒã€‚å¯é¸åšå¤šç«™é™„è¿‘çŸ¥ååº—å®¶ã€‚</li>
                            <li><b>åšå¤šæ‹‰éºµï¼š</b> ä¸€è˜­æˆ–ä¸€é¢¨å ‚æœ¬åº—éƒ½åœ¨ç¦å²¡ã€‚</li>
                        </ul>
                    </div>
                    <div class="tags"><span class="tag tag-food">é¸æ“‡æ™šé¤</span></div>
                </div>
                <div class="event">
                    <div class="time">21:30</div>
                    <div class="activity">åšå¤šç«™å‘¨é‚Š å¤œé–“æ•£æ­¥/è£œè²¨</div>
                    <div class="desc">
                        é‚„è»Šå¾Œè¼•é¬†æ­ä¹˜å¤§çœ¾äº¤é€šå·¥å…·ã€‚å¯å‰å¾€åšå¤šé‹æ²³åŸï¼ˆæ°´èˆç§€ï¼‰æˆ–åœ¨é£¯åº—å‘¨é‚Šè—¥å¦åº—è£œçµ¦ã€‚
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Canal+City+Hakata" target="_blank"
                        class="btn-map">é‹æ²³åŸå°èˆª</a>
                    <div class="tags"><span class="tag tag-kids">è³¼ç‰©</span><span class="tag tag-spot">å¤œæ™¯</span></div>
                </div>
            </div>
        </div>

        <!-- Day 5 -->
        <div class="day-wrapper">
            <div class="day-toggle" id="toggle-d5" onclick="toggleTimeline('d5', this)">
                <div class="day-info">
                    <h3>Day 5: å¤ªå®°åºœèˆ‡ç¦å²¡è³¼ç‰©</h3>
                    <span>1/29 (å››) â€¢ ä½å®¿: ç¦å²¡ ä¼‘é›·å…‹è“‹ç‰¹</span>
                </div>
                <div class="toggle-icon">â–¼</div>
            </div>
            <div id="d5" class="timeline">
                <div class="event event-meal">
                    <div class="time">09:00</div>
                    <div class="activity">æ—©é¤: é£¯åº—æˆ–åšå¤šç«™å…§</div>
                    <div class="desc">å¯æ–¼é£¯åº—äº«ç”¨ï¼Œæˆ–åœ¨åšå¤šç«™å…§é¸è³¼æ—¥å¼æ—©é¤æˆ–éºµåŒ…ã€‚</div>
                    <div class="tags"><span class="tag tag-food">é¸æ“‡æ—©é¤</span></div>
                </div>
                <div class="event">
                    <div class="time">09:30</div>
                    <div class="activity">å¤ªå®°åºœå¤©æ»¿å®®</div>
                    <div class="desc">æ­è¥¿éµå‰å¾€ã€‚å¿…åƒæ¢…æé¤…ï¼Œåƒè§€è¡¨åƒé“æ˜Ÿå·´å…‹ã€‚</div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Dazaifu+Tenmangu" target="_blank"
                        class="btn-map">å°èˆª</a>
                </div>
                <div class="event event-meal">
                    <div class="time">12:30</div>
                    <div class="activity">åˆé¤æ™‚æ®µï¼šå¤ªå®°åºœå‘¨é‚Šé¸æ“‡</div>
                    <div class="desc">
                        <ul style="list-style-type: disc;">
                            <li><b>æ¢…æé¤…ï¼š</b> å¯ç•¶é»å¿ƒã€‚</li>
                            <li><b>å¤ªå®°åºœé£Ÿå ‚ï¼š</b> è¡¨åƒé“ä¸Šæœ‰å¤šå®¶çƒé¾éºµã€å®šé£Ÿé¤å»³ã€‚</li>
                        </ul>
                    </div>
                    <div class="tags"><span class="tag tag-food">é¸æ“‡åˆé¤</span></div>
                </div>
                <div class="event">
                    <div class="time">14:30</div>
                    <div class="activity">ä¹å·åœ‹ç«‹åšç‰©é¤¨</div>
                    <div class="desc">ä½æ–¼å¤ªå®°åºœæ—ï¼Œå£¯è§€çš„å»ºç¯‰èˆ‡å±•è¦½ã€‚</div>
                </div>
                <!-- å‚™æ¡ˆ -->
                <div class="event">
                    <div class="time">å‚™æ¡ˆ</div>
                    <div class="activity">ç¦å²¡éºµåŒ…è¶…äººå…’ç«¥åšç‰©é¤¨ (é›¨å¤©é¦–é¸)</div>
                    <div class="desc">
                        ä½æ–¼åšå¤šæ²³ç•”åŸ (Hakata Riverain) 5-6æ¨“ï¼Œèˆ‡åœ°éµã€Œä¸­æ´²å·ç«¯ã€ç«™ç›´çµã€‚
                        å®Œå…¨å®¤å…§ï¼Œé©åˆå­¸é½¡å‰å…’ç«¥æ”¾é›»ã€‚
                        <span
                            style="display:block; font-size: 0.8rem; color: #666; margin-top: 5px;">*è©³æƒ…è«‹è¦‹ã€Œæ—…éŠè³‡è¨Šã€é ç±¤ã€‚</span>
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Fukuoka+Anpanman+Children's+Museum"
                        target="_blank" class="btn-map">å°èˆª</a>
                    <div class="tags"><span class="tag tag-kids">è¦ªå­å¿…éŠ</span><span class="tag tag-spot">å®¤å…§</span></div>
                </div>
                <!-- å‚™æ¡ˆçµæŸ -->

                <div class="event">
                    <div class="time">17:00</div>
                    <div class="activity">åšå¤šé‹æ²³åŸ / æ«›ç”°ç¥ç¤¾</div>
                    <div class="desc">è³¼ç‰©ä¸­å¿ƒæœ‰æ°´èˆç§€ (æ•´é»)ã€‚</div>
                    <div class="tags"><span class="tag tag-spot">è³¼ç‰©</span></div>
                </div>
                <div class="event event-meal">
                    <div class="time">20:00</div>
                    <div class="activity">æ™šé¤æ™‚æ®µï¼šå±‹å°é«”é©—æˆ–è³¼ç‰©ä¸­å¿ƒ</div>
                    <div class="desc">
                        <ul style="list-style-type: disc;">
                            <li><b>ä¸­æ´²å±‹å°ï¼š</b> é«”é©—ç¦å²¡çš„è·¯é‚Šæ”¤æ–‡åŒ– (è¦ªå­éœ€æ³¨æ„ç’°å¢ƒ)ã€‚</li>
                            <li><b>é‹æ²³åŸå…§é¤å»³ï¼š</b> é¸æ“‡å¤šæ¨£ï¼Œç”¨é¤ç’°å¢ƒè¼ƒèˆ’é©ã€‚</li>
                        </ul>
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Nakasu+Yatai" target="_blank"
                        class="btn-map">å±‹å°å°èˆª</a>
                    <div class="tags"><span class="tag tag-food">é¸æ“‡æ™šé¤</span></div>
                </div>
                <div class="event">
                    <div class="time">21:30</div>
                    <div class="activity">æœ€çµ‚è£œçµ¦èˆ‡å›æˆ¿æ•´ç†</div>
                    <div class="desc">
                        åœ¨ç¦å²¡å¸‚å€æ¡è²·æœ€å¾Œçš„ä¼´æ‰‹ç¦®å’Œè—¥å¦ï¼Œä¸¦æå‰æ•´ç†è¡Œæã€‚
                    </div>
                    <div class="tags"><span class="tag tag-kids">è³¼ç‰©</span><span class="tag tag-relax">æº–å‚™è¿”ç¨‹</span></div>
                </div>
            </div>
        </div>

        <!-- Day 6 -->
        <div class="day-wrapper">
            <div class="day-toggle" id="toggle-d6" onclick="toggleTimeline('d6', this)">
                <div class="day-info">
                    <h3>Day 6: è³¼ç‰©èˆ‡è¿”ç¨‹</h3>
                    <span>1/30 (äº”) â€¢ æº«æš–çš„å®¶</span>
                </div>
                <div class="toggle-icon">â–¼</div>
            </div>
            <div id="d6" class="timeline">
                <div class="event event-meal">
                    <div class="time">09:00</div>
                    <div class="activity">æ—©é¤: é£¯åº—æˆ–åšå¤šç«™å…§</div>
                    <div class="desc">æœ€å¾Œä¸€å€‹æ—©æ™¨ï¼Œè¼•é¬†ç”¨é¤ã€‚</div>
                    <div class="tags"><span class="tag tag-food">é¸æ“‡æ—©é¤</span></div>
                </div>
                <div class="event">
                    <div class="time">10:00</div>
                    <div class="activity">å‰å¾€ LaLaport ç¦å²¡</div>
                    <div class="desc">
                        ç¦å²¡æœ€æ–°å¤§å‹è³¼ç‰©ä¸­å¿ƒï¼Œå¿…çœ‹ <b>1:1 å¯¦é«”å¤§é‹¼å½ˆç«‹åƒ</b>ï¼
                        å•†å ´å…§é‚„æœ‰ KidZania (éœ€é ç´„) å’Œè±å¯Œçš„å…’ç«¥éŠæ¨‚è¨­æ–½ã€‚
                        <span style="display:block; font-size: 0.8rem; color: #666; margin-top: 5px;">*äº¤é€šï¼šå¾åšå¤šç«™æ­ä¹˜å·´å£«æˆ– JR
                            å‰å¾€ç«¹ä¸‹ç«™ã€‚</span>
                    </div>
                    <button class="btn-ai-guide"
                        onclick="askGeminiGuide('RX-93ff Î½é‹¼å½ˆ', 'ç°¡å–®ä»‹ç´¹é€™å€‹å·¨å¤§çš„æ©Ÿå™¨äººæœ‰å¤šé«˜ï¼ˆç”¨å¹¾å±¤æ¨“æ¯”å–»ï¼‰ï¼Œä»¥åŠä»–ç‚ºä»€éº¼è¦ç«™åœ¨é€™è£¡ä¿è­·å¤§å®¶ã€‚')">
                        âœ¨ ä»‹ç´¹å·¨å‹æ©Ÿå™¨äºº
                    </button>
                    <a href="https://www.google.com/maps/search/?api=1&query=LaLaport+Fukuoka" target="_blank"
                        class="btn-map">å°èˆªè‡³ LaLaport</a>
                    <div class="tags"><span class="tag tag-spot">é‹¼å½ˆ</span><span class="tag tag-kids">è¦ªå­å¿…éŠ</span><span
                            class="tag tag-shop">è³¼ç‰©</span></div>
                </div>
                <div class="event event-meal">
                    <div class="time">12:30</div>
                    <div class="activity">åˆé¤æ™‚æ®µï¼šLaLaport ç¾é£Ÿè¡—</div>
                    <div class="desc">
                        ç¾é£Ÿè¡—é¸æ“‡éå¸¸å¤šæ¨£ï¼Œæœ‰ä¹å·åœ¨åœ°ç¾é£Ÿä¹Ÿæœ‰çŸ¥åé€£é–åº—ï¼Œç’°å¢ƒå¯¬æ•é©åˆè¦ªå­ã€‚
                    </div>
                    <div class="tags"><span class="tag tag-food">é¸æ“‡åˆé¤</span></div>
                </div>
                <div class="event">
                    <div class="time">14:30</div>
                    <div class="activity">è¿”å›åšå¤šç«™ & AMU PLAZA ä¼´æ‰‹ç¦®æ¡è²·</div>
                    <div class="desc">
                        å›åˆ°åšå¤šç«™é ˜å–è¡Œæå‰ï¼Œå‹™å¿…åœ¨ **AMU PLAZA** æˆ– **Ming** å•†åº—è¡—æ¡è³¼æœ€å¾Œçš„ä¼´æ‰‹ç¦®ï¼(è©³è¦‹æ—…éŠè³‡è¨Š)
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=AMU+PLAZA+Hakata" target="_blank"
                        class="btn-map">å°èˆªè‡³ AMU PLAZA</a>
                    <div class="tags"><span class="tag tag-shop">ä¼´æ‰‹ç¦®</span><span class="tag tag-move">ç§»å‹•</span></div>
                </div>
                <div class="event">
                    <div class="time">16:00</div>
                    <div class="activity">å‰å¾€ç¦å²¡æ©Ÿå ´ (FUK)</div>
                    <div class="desc">æ­ä¹˜åœ°éµç©ºæ¸¯ç·šï¼Œç´„ 5-10 åˆ†é˜å³å¯æŠµé”æ©Ÿå ´ã€‚</div>
                </div>
                <div class="event">
                    <div class="time">19:10</div>
                    <div class="activity">ç­æ©Ÿèµ·é£›</div>
                    <div class="desc">æ˜Ÿå®‡èˆªç©º å¾€å°åŒ— (TPE)ã€‚</div>
                    <div class="tags"><span class="tag tag-move">è¿”ç¨‹</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: ä½å®¿è³‡è¨Š (Updated Day 3) -->
    <div id="view-stay" class="container">

        <div class="card">
            <div class="card-header">
                <div class="card-title">Day 1: ç†Šæœ¬ - THE BLOSSOM</div>
                <div class="tag tag-stay">è»Šç«™ç›´çµ</div>
            </div>

            <div class="stay-card-grid">
                <div class="stay-row">
                    <div class="stay-label">
                        <svg class="icon-mini" style="color:#6B7280">
                            <use href="#icon-loc"></use>
                        </svg> åœ°å€
                    </div>
                    <div class="stay-val">
                        <span>ç†Šæœ¬çœŒç†Šæœ¬å¸‚è¥¿åŒºæ˜¥æ—¥3-15-26</span>
                        <button class="btn-copy-small" onclick="copyText(this, 'ç†Šæœ¬çœŒç†Šæœ¬å¸‚è¥¿åŒºæ˜¥æ—¥3-15-26')">
                            <svg class="icon-mini" style="width:12px;height:12px;">
                                <path d="M8 2h8a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"
                                    fill="none" stroke="currentColor" stroke-width="2" />
                            </svg>
                            è¤‡è£½
                        </button>
                    </div>
                </div>
                <div class="stay-row">
                    <div class="stay-label">
                        <svg class="icon-mini" style="color:#6B7280">
                            <use href="#icon-consult"></use>
                        </svg> é›»è©±
                    </div>
                    <div class="stay-val">
                        <a href="tel:0963278777" style="color:#2563EB; text-decoration:none;">096-327-8777</a>
                    </div>
                </div>
                <div class="stay-row">
                    <div class="stay-label">
                        MapCode
                    </div>
                    <div class="stay-val">
                        <span class="map-code-box">29 459 270*76</span>
                    </div>
                </div>
            </div>

            <div class="info-detail-box" style="margin-top: 15px; border-color: #BFDBFE; background-color: #EFF6FF;">
                <h4 style="color: #1D4ED8;">âœ¨ ç‰¹è‰²èˆ‡æ³¨æ„</h4>
                <ul style="padding-left: 20px; font-size: 0.9rem; margin-top:5px; color:#444;">
                    <li><b>ä½ç½®ï¼š</b>JRç†Šæœ¬ç«™æ— AMU PLAZA æ¨“ä¸Š (9Få¤§å»³)ã€‚</li>
                    <li><b>åœè»Šï¼š</b>è«‹åœ AMU PLAZA åœ°ä¸‹åœè»Šå ´ (ä½å®¢å„ªæƒ ç´„ Â¥1,000)ï¼Œå°‡åœè»Šåˆ¸å¸¶è‡³æ«ƒå°ã€‚</li>
                    <li><b>è¨­æ–½ï¼š</b>å¤§æµ´å ´ä½æ–¼ 9Fï¼Œæˆ¿å¡æ„Ÿæ‡‰é€²å…¥ã€‚</li>
                </ul>
            </div>

            <a href="https://www.google.com/maps/search/?api=1&query=THE+BLOSSOM+KUMAMOTO" target="_blank"
                class="btn-nav-large">
                <svg class="icon-mini" style="width:20px;height:20px;color:white;">
                    <use href="#icon-nav-arrow"></use>
                </svg>
                å•Ÿå‹• Google å°èˆª
            </a>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">Day 2: é»‘å·æº«æ³‰ - éº“æ—…é¤¨</div>
                <div class="tag tag-stay">å‚³çµ±æ—¥å¼</div>
            </div>

            <div class="stay-card-grid">
                <div class="stay-row">
                    <div class="stay-label">
                        <svg class="icon-mini" style="color:#6B7280">
                            <use href="#icon-loc"></use>
                        </svg> åœ°å€
                    </div>
                    <div class="stay-val">
                        <span>ç†Šæœ¬çœŒé˜¿è˜‡éƒ¡å—å°å›½ç”ºæº€é¡˜å¯º6618</span>
                        <button class="btn-copy-small" onclick="copyText(this, 'ç†Šæœ¬çœŒé˜¿è˜‡éƒ¡å—å°å›½ç”ºæº€é¡˜å¯º6618')">
                            <svg class="icon-mini" style="width:12px;height:12px;">
                                <path d="M8 2h8a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"
                                    fill="none" stroke="currentColor" stroke-width="2" />
                            </svg>
                            è¤‡è£½
                        </button>
                    </div>
                </div>
                <div class="stay-row">
                    <div class="stay-label">
                        <svg class="icon-mini" style="color:#6B7280">
                            <use href="#icon-consult"></use>
                        </svg>é›»è©±
                    </div>
                    <div class="stay-val">
                        <a href="tel:0967440103" style="color:#2563EB; text-decoration:none;">0967-44-0103</a>
                    </div>
                </div>
                <div class="stay-row">
                    <div class="stay-label">MapCode</div>
                    <div class="stay-val">
                        <span class="map-code-box">440 542 454*47</span>
                    </div>
                </div>
            </div>

            <div class="info-detail-box" style="margin-top: 15px; border-color: #FCD34D; background-color: #FFFBEB;">
                <h4 style="color: #B45309;">âš ï¸ æ³¨æ„äº‹é …</h4>
                <ul style="padding-left: 20px; font-size: 0.9rem; margin-top:5px; color:#444;">
                    <li><b>æŠµé”ï¼š</b>æº«æ³‰è¡—é“è·¯æ¥µç‹¹çª„ï¼Œå¼·çƒˆå»ºè­°å¤©é»‘å‰æŠµé”ã€‚</li>
                    <li><b>è¡Œæï¼š</b>é¤¨å…§ç‚ºå¤è€å»ºç¯‰ï¼Œæ¨“æ¢¯å¤šä¸”é™¡ï¼Œå»ºè­°æ”œå¸¶è¼•ä¾¿éå¤œåŒ…ï¼Œå¤§è¡Œæç•™è»Šä¸Šã€‚</li>
                    <li><b>æº«æ³‰ï¼š</b>æ“æœ‰ 15 å€‹æ¹¯æ±  (å«è²¸åˆ‡é¢¨å‘‚)ï¼Œç„¡éœ€é ç´„ï¼Œçœ‹ç‡ˆè™Ÿä½¿ç”¨ã€‚</li>
                </ul>
            </div>

            <a href="https://www.google.com/maps/search/?api=1&query=Fumoto+Ryokan+Kurokawa" target="_blank"
                class="btn-nav-large" style="background: linear-gradient(135deg, #D97706, #B45309);">
                <svg class="icon-mini" style="width:20px;height:20px;color:white;">
                    <use href="#icon-nav-arrow"></use>
                </svg>
                å•Ÿå‹• Google å°èˆª
            </a>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">Day 3: ç”±å¸ƒé™¢ - æ¹¯å¸ƒé™¢å±±ç‡ˆèˆ˜</div>
                <div class="tag tag-stay">é‡‘é±—æ¹–æ—</div>
            </div>

            <div class="stay-card-grid">
                <div class="stay-row">
                    <div class="stay-label">
                        <svg class="icon-mini" style="color:#6B7280">
                            <use href="#icon-loc"></use>
                        </svg> åœ°å€
                    </div>
                    <div class="stay-val">
                        <span>å¤§åˆ†çœŒç”±å¸ƒå¸‚æ¹¯å¸ƒé™¢ç”ºå·ä¸Š1553</span>
                        <button class="btn-copy-small" onclick="copyText(this, 'å¤§åˆ†çœŒç”±å¸ƒå¸‚æ¹¯å¸ƒé™¢ç”ºå·ä¸Š1553')">
                            <svg class="icon-mini" style="width:12px;height:12px;">
                                <path d="M8 2h8a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"
                                    fill="none" stroke="currentColor" stroke-width="2" />
                            </svg>
                            è¤‡è£½
                        </button>
                    </div>
                </div>
                <div class="stay-row">
                    <div class="stay-label"><svg class="icon-mini" style="color:#6B7280">
                            <use href="#icon-consult"></use>
                        </svg>é›»è©±</div>
                    <div class="stay-val">
                        <a href="tel:0977845310" style="color:#2563EB; text-decoration:none;">0977-84-5310</a>
                    </div>
                </div>
                <div class="stay-row">
                    <div class="stay-label">MapCode</div>
                    <div class="stay-val">
                        <span class="map-code-box">269 359 525*30</span>
                    </div>
                </div>
            </div>

            <div class="info-detail-box" style="margin-top: 15px; border-color: #A7F3D0; background-color: #ECFDF5;">
                <h4 style="color: #047857;">âœ¨ ä½å®¿é‡é»</h4>
                <ul style="padding-left: 20px; font-size: 0.9rem; margin-top:5px; color:#444;">
                    <li><b>æ™šé¤ï¼š</b>åŒ…å«ç²¾ç·»æ‡·çŸ³æ–™ç†ï¼Œè«‹å‹™å¿…æ–¼ 17:30 å‰æŠµé”è¾¦ç†å…¥ä½ã€‚</li>
                    <li><b>æ™¨é–“ï¼š</b>èµ°è·¯ 2 åˆ†é˜å³é”é‡‘é±—æ¹–ï¼Œå¿…çœ‹æ¸…æ™¨éœ§æ°£ç¾æ™¯ã€‚</li>
                    <li><b>è¨­æ–½ï¼š</b>å…¨é¤¨æªœæœ¨é€ ï¼Œéš”éŸ³è¼ƒå¼±ï¼Œå¤œé–“è«‹æ”¾è¼•è…³æ­¥ã€‚</li>
                </ul>
            </div>

            <a href="https://www.google.com/maps/search/?api=1&query=Yufuin+Santoukan" target="_blank"
                class="btn-nav-large" style="background: linear-gradient(135deg, #059669, #047857);">
                <svg class="icon-mini" style="width:20px;height:20px;color:white;">
                    <use href="#icon-nav-arrow"></use>
                </svg>
                å•Ÿå‹• Google å°èˆª
            </a>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">Day 4-5: ç¦å²¡ - THE GATE HOTEL</div>
                <div class="tag tag-stay">å¤©ç¥ç«™ç›´çµ</div>
            </div>

            <div class="stay-card-grid">
                <div class="stay-row">
                    <div class="stay-label">
                        <svg class="icon-mini" style="color:#6B7280">
                            <use href="#icon-loc"></use>
                        </svg> åœ°å€
                    </div>
                    <div class="stay-val">
                        <span>ç¦å²¡çœŒç¦å²¡å¸‚ä¸­å¤®åŒºå¤©ç¥2-8-49</span>
                        <button class="btn-copy-small" onclick="copyText(this, 'ç¦å²¡çœŒç¦å²¡å¸‚ä¸­å¤®åŒºå¤©ç¥2-8-49')">
                            <svg class="icon-mini" style="width:12px;height:12px;">
                                <path d="M8 2h8a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"
                                    fill="none" stroke="currentColor" stroke-width="2" />
                            </svg>
                            è¤‡è£½
                        </button>
                    </div>
                </div>
                <div class="stay-row">
                    <div class="stay-label"><svg class="icon-mini" style="color:#6B7280">
                            <use href="#icon-consult"></use>
                        </svg>é›»è©±</div>
                    <div class="stay-val">
                        <a href="tel:0924062605" style="color:#2563EB; text-decoration:none;">092-406-2605</a>
                    </div>
                </div>
                <div class="stay-row">
                    <div class="stay-label">MapCode</div>
                    <div class="stay-val">
                        <span class="map-code-box">13 317 683*55</span>
                    </div>
                </div>
            </div>

            <div class="info-detail-box" style="margin-top: 15px; border-color: #F472B6; background-color: #FFF1F2;">
                <h4 style="color: #BE185D;">âœ¨ ç‰¹è‰² (THE GATE HOTEL by HULIC)</h4>
                <ul style="padding-left: 20px; font-size: 0.9rem; margin-top:5px; color:#444;">
                    <li><b>ä½ç½®ï¼š</b>å¤©ç¥æ ¸å¿ƒåœ°å¸¶ï¼Œåœ°éµå¤©ç¥ç«™ Exit 5 ç›´çµã€‚</li>
                    <li><b>æ™¯è§€ï¼š</b>å¤§å»³ä½æ–¼ 19 æ¨“ï¼Œè¦–é‡æ¥µä½³ã€‚</li>
                    <li><b>ç¦®é‡ï¼š</b>13 æ¨“è¨­æœ‰æˆ¿å®¢å°ˆå±¬ Lounge (6:00-24:00)ï¼Œæä¾›å…è²»é£²æ–™èˆ‡éœ²å°åº§ä½ã€‚</li>
                </ul>
            </div>

            <div class="info-detail-box" style="margin-top: 10px; border-color: #FCA5A5; background-color: #FEF2F2;">
                <h4 style="color: #991B1B;">âš ï¸ è‡ªé§•é‡è¦æ³¨æ„äº‹é … (ç„¡åœè»Šå ´)</h4>
                <ul style="padding-left: 20px; font-size: 0.9rem; margin-top:5px; color:#444;">
                    <li><b>ç„¡åœè»Šå ´ï¼š</b>é£¯åº—æœ¬èº«**æ²’æœ‰**åœè»Šå ´ã€‚</li>
                    <li><b>æ¨è–¦åœè»Šï¼š</b>è«‹åœæ”¾æ–¼é™„è¿‘çš„ <b>Solaria Terminal Parking (ã‚½ãƒ©ãƒªã‚¢ã‚¿ãƒ¼ãƒŸãƒŠãƒ«é§è»Šå ´)</b>ã€‚
                        <br><span style="font-size:0.85rem; color:#666;">(å°èˆªé›»è©±: 092-721-6821)</span>
                    </li>
                    <li><b>è²»ç”¨ï¼š</b>éå¤œè²»ç”¨ç´„ Â¥2,000-Â¥3,000ï¼Œç„¡é£¯åº—è£œåŠ©ã€‚</li>
                </ul>
            </div>

            <a href="https://www.google.com/maps/search/?api=1&query=THE+GATE+HOTEL+Fukuoka+by+HULIC" target="_blank"
                class="btn-nav-large" style="background: linear-gradient(135deg, #DB2777, #BE185D);">
                <svg class="icon-mini" style="width:20px;height:20px;color:white;">
                    <use href="#icon-nav-arrow"></use>
                </svg>
                å•Ÿå‹• Google å°èˆª
            </a>
        </div>

    </div>

    <!-- TAB 3: äº¤é€šè³‡è¨Š -->
    <div id="view-car" class="container">
        <!-- èˆªç­è³‡è¨Š -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">èˆªç­è³‡è¨Š (ç†Šæœ¬é€²/ç¦å²¡å‡º)</div>
                <div class="tag tag-flight">æ˜Ÿå®‡èˆªç©º</div>
            </div>
            <div class="info-detail-box">
                <h4>å»ç¨‹ï¼š1/25 å°åŒ—(TPE) â†’ ç†Šæœ¬(KMJ)</h4>
                <div class="info-grid">
                    <div class="info-label">ç­æ¬¡åƒè€ƒ</div>
                    <div class="info-val">JX846</div>
                </div>
                <div class="info-grid">
                    <div class="info-label">èµ·é£›æ™‚é–“</div>
                    <div class="info-val">07:30 (TPE)</div>
                </div>
                <div class="info-grid">
                    <div class="info-label">èµ·é£›èˆªå»ˆ</div>
                    <div class="info-val">TPE T2 (æ¡ƒåœ’æ©Ÿå ´ç¬¬äºŒèˆªå»ˆ)</div>
                </div>
                <div class="info-grid">
                    <div class="info-label">æŠµé”æ™‚é–“</div>
                    <div class="info-val">11:00 (KMJ ç•¶åœ°æ™‚é–“)</div>
                </div>
                <div class="info-grid">
                    <div class="info-label">æŠµé”èˆªå»ˆ</div>
                    <div class="info-val">KMJ åœ‹éš›ç·šèˆªå»ˆ</div>
                </div>
            </div>
            <div class="info-detail-box" style="margin-top: 15px;">
                <h4>å›ç¨‹ï¼š1/30 ç¦å²¡(FUK) â†’ å°åŒ—(TPE)</h4>
                <div class="info-grid">
                    <div class="info-label">ç­æ¬¡åƒè€ƒ</div>
                    <div class="info-val">JX847</div>
                </div>
                <div class="info-grid">
                    <div class="info-label">èµ·é£›æ™‚é–“</div>
                    <div class="info-val">19:10 (FUK ç•¶åœ°æ™‚é–“)</div>
                </div>
                <div class="info-grid">
                    <div class="info-label">èµ·é£›èˆªå»ˆ</div>
                    <div class="info-val">FUK åœ‹éš›ç·šèˆªå»ˆ</div>
                </div>
                <div class="info-grid">
                    <div class="info-label">æŠµé”æ™‚é–“</div>
                    <div class="info-val">20:40 (TPE ç•¶åœ°æ™‚é–“)</div>
                </div>
                <div class="info-grid">
                    <div class="info-label">æŠµé”èˆªå»ˆ</div>
                    <div class="info-val">TPE T2 (æ¡ƒåœ’æ©Ÿå ´ç¬¬äºŒèˆªå»ˆ)</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">ç§Ÿè»Šè³‡è¨Š (Day 2-4)</div>
                <div class="tag tag-car">Toyota</div>
            </div>
            <div class="info-grid">
                <div class="info-label">ç§Ÿè»Šå…¬å¸</div>
                <div class="info-val">Toyota Rent a Car</div>
            </div>
            <div class="info-grid">
                <div class="info-label">å–è»Šåœ°é»</div>
                <div class="info-val">é˜¿è˜‡ç«™å‰åº—</div>
            </div>
            <div class="info-grid">
                <div class="info-label">é‚„è»Šåœ°é»</div>
                <div class="info-val">åšå¤šé§…åšå¤šå£åº—</div>
            </div>
            <div class="info-grid">
                <div class="info-label">å°èˆªé›»è©±</div>
                <div class="info-val">092-441-0100</div>
            </div>
            <a href="https://www.google.com/maps/search/?api=1&query=Toyota+Rent+a+Car+é˜¿è˜‡é§…å‰åº—" target="_blank"
                class="btn-link">å°èˆªè‡³å–è»Šé»</a>
            <a href="https://www.google.com/maps/search/?api=1&query=Toyota+Rent+a+Car+Hakata+Station+Hakata+Exit"
                target="_blank" class="btn-link" style="margin-top: 5px;">å°èˆªè‡³é‚„è»Šé»</a>
        </div>
        <div class="card">
            <div class="card-header">
                <div class="card-title">Day 2 (1/26) å¿…æ­ï¼šé˜¿è˜‡ç”·å­©!</div>
                <div class="tag tag-move">è§€å…‰åˆ—è»Š</div>
            </div>
            <div class="info-grid">
                <div class="info-label">è»Šæ¬¡</div>
                <div class="info-val">ASO BOY! 1è™Ÿ</div>
            </div>
            <div class="info-grid">
                <div class="info-label">å€é–“</div>
                <div class="info-val">ç†Šæœ¬ (09:57) â†’ é˜¿è˜‡ (11:27)</div>
            </div>

            <div class="info-detail-box">
                <h4>ğŸ¶ åˆ—è»Šå‰ç¥¥ç‰©ï¼šå°é»‘ KURO</h4>
                <p style="font-size: 0.9rem;">KURO æ˜¯é˜¿è˜‡ç”·å­©çš„çœ‹æ¿çŠ¬ï¼Œè»Šå…§å¤–å…±æœ‰**101éš»ä¸åŒé€ å‹çš„ KURO åœ–æ¡ˆ**ï¼Œå¯ä»¥è®“å­©å­å€‘å°‹æ‰¾ï¼Œå¢æ·»æ—…é€”æ¨‚è¶£ï¼</p>
                <p style="font-size: 0.8rem; color: #9CA3AF; margin-top: 5px;"></p>
            </div>

            <div class="info-detail-box" style="margin-top: 15px;">
                <h4>ğŸ‰ è¦ªå­å¨›æ¨‚è¨­æ–½ (ç¬¬3ç¯€è»Šå»‚)</h4>
                <p style="font-size: 0.9rem; margin-bottom: 5px;">
                    ç¬¬3ç¯€è»Šå»‚å¾Œæ–¹æ˜¯å…’ç«¥å°ˆå±¬ç©ºé–“ï¼Œè¨­æœ‰**æœ¨çƒæ± **ï¼ˆè«‹æ³¨æ„é–‹æ”¾æ™‚é–“ï¼‰å’Œ**å…’ç«¥åœ–æ›¸å®¤**ã€‚
                </p>
                <p style="font-size: 0.9rem; margin-bottom: 5px;">
                    æ­¤å¤–ï¼Œé‚„æœ‰**å“ºä¹³å®¤**å’Œå¤šåŠŸèƒ½å»æ‰€ï¼Œç¢ºä¿å¸¶è‘—å°å°å­©çš„å®¶é•·ä¹Ÿèƒ½èˆ’é©æ­ä¹˜ã€‚
                </p>
            </div>

            <div class="info-detail-box" style="margin-top: 15px;">
                <h4>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ç¨ç‰¹å…¨æ™¯å¸­ä½</h4>
                <p style="font-size: 0.9rem; margin-bottom: 5px;">
                    **æ™¯è§€è»Šå»‚ (ç¬¬1å’Œç¬¬4ç¯€)**ï¼šè¨­æœ‰å…¨æ™¯å¤§çª—æˆ¶ï¼Œè¦–é‡çµ•ä½³ï¼Œèƒ½æ¬£è³é˜¿è˜‡æ²¿ç·šé¢¨æ™¯ã€‚
                </p>
                <p style="font-size: 0.9rem;">
                    **è¦ªå­åº§ä½ (White Seats)**ï¼šæœ‰é¢å°é¢ã€é™„æ¡Œå­çš„åº§ä½ï¼Œéå¸¸é©åˆå®¶åº­ç”¨é¤æˆ–äº’å‹•ï¼Œæ˜¯é è¨‚æ™‚çš„é¦–é¸ï¼
                </p>
            </div>
        </div>

        <!-- [æ–°å¢] Map Code ä¸€è¦½è¡¨ -->
        <div class="card">
            <div class="card-header">
                <div class="card-title" style="display: flex; align-items: center; gap: 6px;">
                    <svg class="icon-mini" style="color: var(--primary);">
                        <use href="#icon-loc"></use>
                    </svg>
                    è¡Œç¨‹æ™¯é» Map Code ä¸€è¦½
                </div>
                <div class="tag tag-car">è»Šæ©Ÿå°èˆª</div>
            </div>

            <div class="info-section" style="background-color: #F3F4F6; border-color: #9CA3AF;">
                <p style="font-size: 0.85rem; color: #4B5563; margin-bottom: 10px;">
                    ğŸ’¡ <b>ä½¿ç”¨å°æ’‡æ­¥ï¼š</b>æ—¥æœ¬è»Šè¼‰å°èˆªè¼¸å…¥ Map Code æœ€ç‚ºç²¾æº–ã€‚è‹¥ Map Code æŸ¥ç„¡åœ°é»ï¼Œä½¿ç”¨ä¸‹æ–¹æä¾›çš„<b>é›»è©±è™Ÿç¢¼ (Tel)</b> å°èˆªæ˜¯æœ€ä½³å‚™æ¡ˆã€‚
                </p>

                <!-- ç†Šæœ¬å€åŸŸ -->
                <h4 style="color: #3B82F6; margin: 15px 0 5px 0; border-left: 4px solid #3B82F6; padding-left: 8px;">ğŸ»
                    ç†Šæœ¬å€åŸŸ (Day 1-2)</h4>
                <div class="price-table" style="grid-template-columns: 1.5fr 1fr;">
                    <div class="price-item" style="font-weight:600;">æ™¯é»åç¨±</div>
                    <div class="price-item" style="font-weight:600; font-family:monospace;">Map Code / Tel</div>

                    <div class="price-item">ç†Šæœ¬æ©Ÿå ´ (KMJ)</div>
                    <div class="price-item">
                        <div style="font-family:monospace; color:#2563EB; font-weight:600;">29 434 250*85</div>
                        <div style="font-size:0.85rem; color:#666; margin-top:2px;">Tel: 096-232-2810</div>
                    </div>

                    <div class="price-item">ç†Šæœ¬ç«™ (The Blossom)</div>
                    <div class="price-item">
                        <div style="font-family:monospace; color:#2563EB; font-weight:600;">29 459 270*76</div>
                        <div style="font-size:0.85rem; color:#666; margin-top:2px;">Tel: 096-327-8777</div>
                    </div>

                    <div class="price-item">æ«»ä¹‹é¦¬å ´ åŸå½©è‹‘</div>
                    <div class="price-item">
                        <div style="font-family:monospace; color:#2563EB; font-weight:600;">29 489 328*36</div>
                        <div style="font-size:0.85rem; color:#666; margin-top:2px;">Tel: 096-288-5600</div>
                    </div>
                </div>

                <!-- é˜¿è˜‡/é»‘å·å€åŸŸ -->
                <h4 style="color: #10B981; margin: 20px 0 5px 0; border-left: 4px solid #10B981; padding-left: 8px;">â›°ï¸
                    é˜¿è˜‡èˆ‡é»‘å· (Day 2-3)</h4>
                <div class="price-table" style="grid-template-columns: 1.5fr 1fr;">
                    <div class="price-item">Toyota ç§Ÿè»Š (é˜¿è˜‡ç«™å‰)</div>
                    <div class="price-item">
                        <div style="font-family:monospace; color:#059669; font-weight:600;">256 386 414*43</div>
                        <div style="font-size:0.85rem; color:#666; margin-top:2px;">Tel: 0967-35-5100</div>
                    </div>

                    <div class="price-item">è‰åƒé‡Œ (é˜¿è˜‡ç«å±±åšç‰©é¤¨)</div>
                    <div class="price-item">
                        <div style="font-family:monospace; color:#059669; font-weight:600;">256 456 833*60</div>
                        <div style="font-size:0.85rem; color:#666; margin-top:2px;">Tel: 0967-34-2111</div>
                    </div>

                    <div class="price-item">å¤§è§€å³°å±•æœ›æ‰€</div>
                    <div class="price-item">
                        <div style="font-family:monospace; color:#059669; font-weight:600;">256 688 642*31</div>
                        <div style="font-size:0.85rem; color:#666; margin-top:2px;">Tel: 0967-32-3856</div>
                    </div>

                    <div class="price-item">é»‘å·æº«æ³‰ (éŠå®¢ä¸­å¿ƒ)</div>
                    <div class="price-item">
                        <div style="font-family:monospace; color:#059669; font-weight:600;">440 542 567*14</div>
                        <div style="font-size:0.85rem; color:#666; margin-top:2px;">Tel: 0967-44-0076</div>
                    </div>
                </div>

                <!-- åˆ¥åºœ/ç”±å¸ƒé™¢å€åŸŸ -->
                <h4 style="color: #F59E0B; margin: 20px 0 5px 0; border-left: 4px solid #F59E0B; padding-left: 8px;">â™¨ï¸
                    åˆ¥åºœèˆ‡ç”±å¸ƒé™¢ (Day 3-4)</h4>
                <div class="price-table" style="grid-template-columns: 1.5fr 1fr;">
                    <div class="price-item">åˆ¥åºœ æµ·åœ°ç„</div>
                    <div class="price-item">
                        <div style="font-family:monospace; color:#D97706; font-weight:600;">46 521 440*43</div>
                        <div style="font-size:0.85rem; color:#666; margin-top:2px;">Tel: 0977-66-0121</div>
                    </div>

                    <div class="price-item">ä¹å·è‡ªç„¶å‹•ç‰©å…¬åœ’</div>
                    <div class="price-item">
                        <div style="font-family:monospace; color:#D97706; font-weight:600;">46 434 225*85</div>
                        <div style="font-size:0.85rem; color:#666; margin-top:2px;">Tel: 0978-48-2331</div>
                    </div>

                    <div class="price-item">ç”±å¸ƒé™¢è»Šç«™</div>
                    <div class="price-item">
                        <div style="font-family:monospace; color:#D97706; font-weight:600;">269 357 442*11</div>
                        <div style="font-size:0.85rem; color:#666; margin-top:2px;">Tel: 0977-84-2446</div>
                    </div>

                    <div class="price-item">é‡‘é±—æ¹– (é™„è¿‘åœ°æ¨™)</div>
                    <div class="price-item">
                        <div style="font-family:monospace; color:#D97706; font-weight:600;">269 359 586*66</div>
                        <div style="font-size:0.85rem; color:#666; margin-top:2px;">Tel: 0977-28-8500</div>
                    </div>
                </div>

                <!-- ç¦å²¡å€åŸŸ -->
                <h4 style="color: #EF4444; margin: 20px 0 5px 0; border-left: 4px solid #EF4444; padding-left: 8px;">ğŸœ
                    ç¦å²¡èˆ‡å¤ªå®°åºœ (Day 4-6)</h4>
                <div class="price-table" style="grid-template-columns: 1.5fr 1fr;">
                    <!-- æ–°å¢å±±ç”°ä¼‘æ¯ç«™ -->
                    <div class="price-item">å±±ç”°æœå‹™å€ (å¾€ç¦å²¡)</div>
                    <div class="price-item">
                        <div style="font-family:monospace; color:#DC2626; font-weight:600;">55 136 580*55</div>
                        <div style="font-size:0.85rem; color:#666; margin-top:2px;">Tel: 0946-52-3103</div>
                    </div>

                    <div class="price-item">Toyota ç§Ÿè»Š (åšå¤šç«™)</div>
                    <div class="price-item">
                        <div style="font-family:monospace; color:#DC2626; font-weight:600;">13 320 644*85</div>
                        <div style="font-size:0.85rem; color:#666; margin-top:2px;">Tel: 092-441-0100</div>
                    </div>

                    <div class="price-item">å¤ªå®°åºœå¤©æ»¿å®® (åœè»Šå ´)</div>
                    <div class="price-item">
                        <div style="font-family:monospace; color:#DC2626; font-weight:600;">55 364 046*12</div>
                        <div style="font-size:0.85rem; color:#666; margin-top:2px;">Tel: 092-922-8225</div>
                    </div>

                    <div class="price-item">ä¹å·åœ‹ç«‹åšç‰©é¤¨</div>
                    <div class="price-item">
                        <div style="font-family:monospace; color:#DC2626; font-weight:600;">55 334 895*88</div>
                        <div style="font-size:0.85rem; color:#666; margin-top:2px;">Tel: 092-918-2807</div>
                    </div>

                    <div class="price-item">LaLaport ç¦å²¡</div>
                    <div class="price-item">
                        <div style="font-family:monospace; color:#DC2626; font-weight:600;">13 133 766*55</div>
                        <div style="font-size:0.85rem; color:#666; margin-top:2px;">Tel: 092-707-9820</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- [æ–°å¢çµæŸ] -->

        <div class="card">
            <div class="card-header">
                <div class="card-title">ğŸ‡¯ğŸ‡µ è‡ªé§•èˆ‡åŠ æ²¹é ˆçŸ¥</div>
                <div class="tag tag-car">å¿…è®€</div>
            </div>

            <div class="info-section" style="margin-bottom: 15px;">
                <h3 style="color: var(--primary); border-bottom-color: var(--primary);">ğŸš— è‡ªé§•é‡é»æç¤º</h3>
                <ul style="padding-left: 20px; font-size: 0.9rem; line-height: 1.6; color: #444;">
                    <li><b>é å·¦è¡Œé§›ï¼š</b>æ—¥æœ¬ç‚ºå³é§•å·¦è¡Œï¼Œé›¨åˆ·å’Œæ–¹å‘ç‡ˆä½ç½®é€šå¸¸èˆ‡å°ç£ç›¸åï¼ˆé›¨åˆ·åœ¨å·¦ï¼Œæ–¹å‘ç‡ˆåœ¨å³ï¼‰ã€‚è½‰å½æ™‚è«‹å£è¨£é»˜å”¸ã€Œå·¦å°åœˆã€å³å¤§åœˆã€ã€‚</li>
                    <li><b>ç¦®è®“è¡Œäººï¼š</b>è½‰å½é‡æ–‘é¦¬ç·šæœ‰è¡Œäººæ™‚ï¼Œ**å¿…é ˆå®Œå…¨åœè»Š**ç¦®è®“ã€‚</li>
                    <li><b>åœæ­¢æ¨™èªŒ (æ­¢ã¾ã‚Œ)ï¼š</b>çœ‹åˆ°å€’ä¸‰è§’å½¢ç´…è‰²æ¨™èªŒï¼Œè»Šè¼ªå¿…é ˆ**å®Œå…¨éœæ­¢**ï¼ˆæ•¸3ç§’ï¼‰ç¢ºèªç„¡è»Šå¾Œå†é–‹ï¼Œé€™æ˜¯æ—¥æœ¬è­¦å¯Ÿå–ç· é‡é»ã€‚</li>
                    <li><b>å¹³äº¤é“ï¼š</b>é€šéå‰å¿…é ˆ**å®Œå…¨åœè»Š**ï¼Œé–‹çª—è½è²éŸ³ç¢ºèªç„¡ç«è»Šå¾Œå†é€šéã€‚</li>
                </ul>
            </div>

            <div class="info-section" style="background-color: #FFFBEB; border-color: #F59E0B;">
                <h3 style="color: #D97706; border-bottom-color: #F59E0B;">â›½ åŠ æ²¹ç«™ä½¿ç”¨æŒ‡å—</h3>
                <div class="method-detail">
                    <p style="margin-bottom: 8px;">ç§Ÿè»Šé€šå¸¸éœ€<b>ã€ŒåŠ æ»¿æ²¹é‚„è»Š (æº€ã‚¿ãƒ³è¿”ã—)ã€</b>ï¼Œè«‹ä¿ç•™æœ€å¾Œä¸€æ¬¡åŠ æ²¹æ”¶æ“šã€‚</p>
                    <div
                        style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; text-align: center; margin-bottom: 10px;">
                        <div
                            style="background:#FFCCCC; padding:5px; border-radius:5px; color:#CC0000; font-weight:bold;">
                            ç´…è‰²<br><span style="font-size:0.8rem">92ç„¡é‰›<br>(Regular)</span></div>
                        <div
                            style="background:#FFFFCC; padding:5px; border-radius:5px; color:#999900; font-weight:bold;">
                            é»ƒè‰²<br><span style="font-size:0.8rem">98ç„¡é‰›<br>(High Octane)</span></div>
                        <div
                            style="background:#CCFFCC; padding:5px; border-radius:5px; color:#006600; font-weight:bold;">
                            ç¶ è‰²<br><span style="font-size:0.8rem">æŸ´æ²¹<br>(Diesel)</span></div>
                    </div>
                    <p>ä¸€èˆ¬ç§Ÿè³ƒè½è»Šï¼ˆå¦‚ Toyota Corolla/Yarisï¼‰é€šå¸¸åŠ  <b style="color:#CC0000;">ç´…è‰² Regular (ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼)</b>ã€‚è«‹å‹™å¿…ç¢ºèªç§Ÿè»Šåˆç´„ã€‚</p>
                </div>

                <!-- æ–°å¢ï¼šè‡ªåŠ©åŠ æ²¹æ•™å­¸å€å¡Š -->
                <div style="margin-top: 15px; border-top: 1px dashed #F59E0B; padding-top: 15px;">
                    <h4 style="color: #D97706; margin: 0 0 10px 0;">ğŸ¤– è‡ªåŠ©åŠ æ²¹ (Self) æ“ä½œæ­¥é©Ÿ</h4>
                    <ul class="step-list" style="padding-left: 20px;">
                        <li><b>åœè»Šç†„ç«ï¼š</b> èªæ˜æ‹›ç‰Œå¯«æœ‰ã€Œã‚»ãƒ«ãƒ• (Self)ã€çš„åŠ æ²¹ç«™ã€‚åœå¦¥å¾Œè«‹å‹™å¿…ç†„ç«ã€‚</li>
                        <li><b>æ¶ˆé™¤éœé›»ï¼š</b> è§¸æ‘¸åŠ æ²¹æ©Ÿä¸Šçš„ã€Œéœé›»é™¤å» (éœé›»é™¤å»ã‚·ãƒ¼ãƒˆ)ã€é»‘è‰²è§¸æ‘¸æ¿ã€‚</li>
                        <li><b>é¸æ“‡æ”¯ä»˜ï¼š</b> è¢å¹•é»é¸ã€Œã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ (ä¿¡ç”¨å¡)ã€æˆ–ã€Œç¾é‡‘ã€ã€‚</li>
                        <li><b>é¸æ“‡æ²¹ç¨®ï¼š</b> é»é¸ç´…è‰² <b style="color:#CC0000;">Regular (ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼)</b>ã€‚</li>
                        <li><b>è¨­å®šæ²¹é‡ï¼š</b> é‚„è»Šè«‹é¸æ“‡ <b style="color:#2563EB;">ã€Œæº€ã‚¿ãƒ³ (æ»¿æ²¹)ã€</b>ã€‚</li>
                        <li><b>åŠ æ²¹ï¼š</b> æ’å…¥æ²¹æ§ï¼Œæ‰£ä¸‹æ‰³æ©Ÿã€‚è·³åœå¾Œè«‹ä¸è¦ç¡¬åŠ ï¼Œæ›å›æ²¹æ§ã€‚</li>
                        <li><b>é ˜å–æ”¶æ“šï¼š</b> å‹™å¿…é ˜å–æ”¶æ“š (é ˜åæ›¸) ä»¥ä¾›é‚„è»ŠæŸ¥é©—ã€‚</li>
                    </ul>
                </div>

                <!-- æ–°å¢ï¼šä»˜æ¬¾èˆ‡æ‰¾é›¶æ³¨æ„äº‹é … -->
                <div
                    style="margin-top: 15px; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #FCD34D;">
                    <h4 style="color: #B45309; margin: 0 0 5px 0; font-size: 0.95rem;">ğŸ’° ä»˜æ¬¾èˆ‡æ‰¾é›¶é‡è¦æç¤º</h4>
                    <ul style="padding-left: 20px; font-size: 0.9rem; color: #444; margin-bottom: 0;">
                        <li style="margin-bottom: 5px;"><b>ç¾é‡‘æ‰¾é›¶é™·é˜±ï¼š</b>
                            éƒ¨åˆ†èˆŠå¼æ©Ÿå°åŠ æ²¹å¾Œåªæœƒåå‡ºæ”¶æ“šï¼ˆæˆ–æ‰¾é›¶å–®ï¼‰ï¼Œ**ä¸æœƒç›´æ¥åéˆ”ç¥¨**ï¼éœ€æ‹¿è‘—å–®å­å»æ—é‚Šçš„<b>ã€Œç²¾ç®—æ©Ÿã€</b>æƒææ¢ç¢¼æ‰æœƒé€€éŒ¢ã€‚</li>
                        <li><b>ä¿¡ç”¨å¡é æˆæ¬Šï¼š</b> é¸æ“‡ã€Œæ»¿æ²¹ã€æ™‚ï¼Œç³»çµ±å¯èƒ½æœƒå…ˆé æ‰£ä¸€ç­†é‡‘é¡ï¼ˆå¦‚1è¬æ—¥åœ“ï¼‰ï¼Œå¯¦éš›æ‰£æ¬¾æœƒä¾åŠ æ²¹é‡è¨ˆç®—ï¼Œç„¡éœ€æ“”å¿ƒã€‚</li>
                    </ul>
                </div>
            </div>

            <div class="info-section" style="margin-top: 15px; border-color: #EF4444;">
                <h3 style="color: #EF4444; border-bottom-color: #EF4444;">â›“ï¸ é›ªéŠå®‰è£æ•™å­¸</h3>
                <div class="method-detail">
                    <p style="font-weight:bold; margin-bottom:5px;">âš ï¸ å‡ºç™¼å‰ç¢ºèªé©…å‹•è¼ª (å‰é©…/å¾Œé©…/å››é©…)</p>
                    <ul class="step-list" style="padding-left: 20px;">
                        <li><b>æ­¥é©Ÿ 1ï¼š</b>å°‡é›ªéŠæ”¤å¹³åœ¨è¼ªèƒå¾Œæ–¹ï¼Œç¢ºèªç„¡æ‰“çµã€‚</li>
                        <li><b>æ­¥é©Ÿ 2ï¼š</b>å°‡é›ªéŠå…©ç«¯æ‹‰èµ·ï¼ŒåŒ…è¦†è¼ªèƒã€‚</li>
                        <li><b>æ­¥é©Ÿ 3ï¼š</b>å…ˆæ‰£ä¸Šå…§å´æ›å‹¾ (é€šå¸¸åœ¨è¼ªèƒå¾Œæ–¹ä¸Šæ–¹)ã€‚</li>
                        <li><b>æ­¥é©Ÿ 4ï¼š</b>èª¿æ•´å¤–å´éŠæ¢ä½ç½®ï¼Œæ‰£ä¸Šå¤–å´æ›å‹¾ã€‚</li>
                        <li><b>æ­¥é©Ÿ 5ï¼š</b>ä½¿ç”¨æ©¡çš®åœˆæˆ–ç·Šç¹ƒå™¨æ‹‰ç·ŠéŠæ¢ï¼Œç¢ºä¿è²¼åˆè¼ªèƒã€‚</li>
                        <li><b>æ­¥é©Ÿ 6ï¼š</b>è¡Œé§›ç´„ 50 å…¬å°ºå¾Œåœè»Šæª¢æŸ¥ï¼Œå†æ¬¡æ‹‰ç·Šã€‚</li>
                    </ul>
                    <p style="font-size:0.85rem; color:#666; margin-top:5px;">*è¡Œé§›é›ªéŠè·¯æ®µè«‹ä¿æŒæ™‚é€Ÿ 30-50km/h ä»¥ä¸‹ã€‚</p>
                </div>
            </div>

            <div class="info-section winter-drive" style="margin-top: 15px;">
                <h3>â„ï¸ å†¬å­£è‡ªé§•èˆ‡å®‰å…¨æç¤º</h3>
                <p style="font-size: 0.95rem; margin-bottom: 10px; font-weight: 500;">
                    æ‚¨çš„è¡Œç¨‹ç¶“éé˜¿è˜‡å±±ã€é»‘å·æº«æ³‰ã€ç”±å¸ƒé™¢ç­‰å±±å€ï¼Œ1æœˆä¸‹æ—¬ç‚ºå†¬å­£æ—ºå­£ï¼Œè«‹å‹™å¿…ç•™æ„ï¼š</p>

                <div class="info-detail-box" style="border-color: #FCA5A5; background-color: #FFF6F6;">
                    <h4 style="color: #B91C1C;">èƒç´‹èˆ‡é›ªéˆ (é‡è¦)</h4>
                    <p class="method-detail">
                        <span style="font-weight: 600; color: #B91C1C;">é›ªèƒï¼š</span> è«‹å‹™å¿…èˆ‡ç§Ÿè»Šå…¬å¸ç¢ºèªæ‚¨çš„è»Šè¼›æ˜¯å¦é…å‚™**é›ªèƒ (Snow
                        Tires)**ã€‚è‹¥ç„¡é›ªèƒï¼Œå¯èƒ½ç„¡æ³•é€²å…¥éƒ¨åˆ†ç©é›ªçš„å±±å€ã€‚
                    </p>
                    <p class="method-detail" style="margin-top: 5px;">
                        <span style="font-weight: 600; color: #B91C1C;">é›ªéˆï¼š</span>
                        åœ¨ç§Ÿè»Šæ™‚ï¼Œç¢ºèªæ˜¯å¦å‚™æœ‰é›ªéˆä¸¦çŸ¥é“å¦‚ä½•ä½¿ç”¨ã€‚éƒ¨åˆ†è·¯æ®µå¦‚é‡å¤§é›ªï¼Œæœƒå¼·åˆ¶è¦æ±‚åŠ è£é›ªéˆã€‚
                    </p>
                </div>

                <div class="info-detail-box"
                    style="margin-top: 15px; border-color: #FCA5A5; background-color: #FFF6F6;">
                    <h4 style="color: #B91C1C;">å±±å€é§•è»Šæ™‚é–“</h4>
                    <p class="method-detail">
                        **é»‘å·è‡³åˆ¥åºœ/ç”±å¸ƒé™¢ï¼š** å±±è·¯è¼ƒå¤šï¼Œä¸‹åˆ 5 é»å¾Œå¤©è‰²æœƒå®Œå…¨è®Šæš—ã€‚Day 3 çš„è¡Œç¨‹éœ€è¦è·¨è¶Šå±±å€ï¼Œè«‹ç›¡é‡åœ¨ç™½å¤©å®Œæˆå¤§éƒ¨åˆ†ç§»å‹•ã€‚
                    </p>
                    <p class="method-detail" style="margin-top: 5px;">
                        **çµå†°é¢¨éšªï¼š** æ—©æ™¨æˆ–æ·±å¤œï¼Œæ©‹æ¨‘å’Œå±±å€èƒŒå…‰è·¯æ®µå®¹æ˜“çµå†°ï¼Œè«‹æ¸›é€Ÿæ…¢è¡Œï¼Œèˆ‡å‰è»Šä¿æŒå®‰å…¨è·é›¢ã€‚
                    </p>
                </div>
                <div class="info-detail-box"
                    style="margin-top: 15px; border-color: #EF4444; background-color: #FEF2F2;">
                    <h4 style="color: #DC2626;">âš ï¸ é›ªåœ°é§•é§›é—œéµ (Fact Check)</h4>
                    <div class="method-detail">
                        <ul class="step-list" style="padding-left: 20px; margin-top: 5px; color: #7F1D1D;">
                            <li><b>åš´ç¦ã€Œæ€¥ã€æ“ä½œï¼š</b>é›ªåœ°æ‘©æ“¦åŠ›ä½ï¼Œåš´ç¦æ€¥è¸©æ²¹é–€ã€æ€¥ç…è»Šæˆ–æ€¥è½‰å½ã€‚è«‹ç§‰æŒã€Œæ…¢ã€æŸ”ã€ç©©ã€åŸå‰‡ã€‚</li>
                            <li><b>å–„ç”¨å¼•æ“ç…è»Šï¼š</b>ä¸‹å¡æˆ–æ¸›é€Ÿæ™‚ï¼Œè«‹å–„ç”¨ä½é€Ÿæª” (Bæª”/Sæª”/Læª”) åˆ©ç”¨å¼•æ“ç‰½å¼•åŠ›æ¸›é€Ÿï¼Œé¿å…å–®ç´”ä¾è³´è…³ç…å°è‡´æ‰“æ»‘ã€‚</li>
                            <li><b>å°å¿ƒã€Œé»‘å†°ã€ï¼š</b>çœ‹èµ·ä¾†æ¿•æ¿•çš„æŸæ²¹è·¯é¢ï¼Œå¯èƒ½å…¶å¯¦æ˜¯é€æ˜çš„ã€Œé»‘å†° (Black Ice)ã€ï¼Œæ¥µå…¶æ»‘æºœã€‚æ©‹æ¨‘ã€éš§é“å‡ºå…¥å£èˆ‡é™°å½±è™•æœ€å¸¸è¦‹ã€‚</li>
                            <li><b>åœè»Šå…©å¤§é‡é»ï¼š</b>
                                <br>1. æˆ¶å¤–éå¤œ<b>è«‹å‹¿æ‹‰æ‰‹ç…è»Š</b> (ä»¥å…å‡çµå¡æ­»)ï¼ŒP æª”å³å¯ã€‚
                                <br>2. <b>è«‹ç«‹èµ·é›¨åˆ·</b>ï¼Œé¿å…æ©¡è† å‡çµé»åœ¨ç»ç’ƒä¸Šã€‚
                            </li>
                            <li><b>é™¤é›ªå†ä¸Šè·¯ï¼š</b>å‡ºç™¼å‰å‹™å¿…æ¸…é™¤<b>è»Šé ‚</b>ç©é›ªï¼Œä»¥å…ç…è»Šæ™‚é›ªå¡Šæ»‘è½é®æ“‹è¦–ç·šã€‚</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 4: æ—…éŠè³‡è¨Š -->
    <div id="view-info" class="container">
        <div class="card"
            style="background: transparent; box-shadow: none; padding: 0; border: none; margin-bottom: 10px;">
            <div class="card-header"
                style="background: #fff; border-radius: 16px; padding: 15px; border: 1px solid rgba(0,0,0,0.03); box-shadow: 0 2px 6px rgba(0,0,0,0.04); margin-bottom: 15px;">
                <div class="card-title">ç¾é£Ÿå‚™æ¡ˆå£è¢‹åå–®</div>
                <div class="tag tag-food">å½ˆæ€§é¸æ“‡</div>
            </div>

            <div class="day-wrapper">
                <div class="day-toggle" id="toggle-food-k" onclick="toggleTimeline('food-k', this)">
                    <div class="day-info">
                        <h3>ç†Šæœ¬å€å‚™æ¡ˆ</h3>
                        <span>å‹çƒˆäº­ã€æ‹‰éºµã€é¦¬è‚‰æ–™ç†</span>
                    </div>
                    <div class="toggle-icon">â–¼</div>
                </div>
                <div id="food-k" class="timeline">
                    <div class="info-section"
                        style="border-color: #34D399; background-color: #ECFDF5; margin-bottom: 15px;">
                        <h3 style="color: #059669; border-bottom-color: #34D399;">â˜€ï¸ åˆé¤å£è¢‹åå–® (ç‚¸è±¬æ’/æ‹‰éºµ/å¤ªå¹³ç‡•)</h3>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">ğŸ· å‹çƒˆäº­ (Katsuretsu Tei) æ–°å¸‚è¡—æœ¬åº—</span>
                            <div class="method-detail">
                                <p>ç†Šæœ¬å¿…åƒï¼ç±³å…¶æ—æ¨è–¦çš„ç‚¸è±¬æ’ã€‚å¤–çš®é…¥è„†ä¸æ²¹è†©ï¼Œè‚‰è³ªé®®å«©ã€‚<b>å…’ç«¥é¤</b>ä¹Ÿéå¸¸è±ç››ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Katsuretsu+Tei+Shinshigai"
                                    target="_blank" class="btn-map">å°èˆªè‡³å‹çƒˆäº­</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">ğŸœ é»‘äº­æ‹‰éºµ (Kokutei) ä¸‹é€šåº—</span>
                            <div class="method-detail">
                                <p>ç†Šæœ¬æ‹‰éºµä»£è¡¨ï¼Œç‰¹è‰²æ˜¯é¦™æ¿ƒçš„<b>ç„¦è’œæ²¹è±šéª¨æ¹¯é ­</b>ã€‚ä¸‹é€šåº—ä½ç½®æ–¹ä¾¿ï¼Œé©åˆé€›è¡—ä¸­é€”ç”¨é¤ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Kokutei+Shimotori"
                                    target="_blank" class="btn-map">å°èˆªè‡³é»‘äº­æ‹‰éºµ</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">ğŸ¦ ç´…è˜­äº­ (Kourantei) ä¸‹é€šæœ¬åº—</span>
                            <div class="method-detail">
                                <p>ç†Šæœ¬é„‰åœŸæ–™ç†<b>ã€Œå¤ªå¹³ç‡•ã€</b>çš„ååº—ã€‚é¡ä¼¼å£æ„Ÿæ¸…çˆ½çš„ç²‰çµ²æ¹¯ï¼Œæ­é…æ»¿æ»¿çš„æµ·é®®èˆ‡è”¬èœï¼Œå¥åº·ç„¡è² æ“”ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Kourantei+Shimotori"
                                    target="_blank" class="btn-map">å°èˆªè‡³ç´…è˜­äº­</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">ğŸ¥© è…ä¹ƒå±‹ (Suganoya) ä¸Šé€šåº—</span>
                            <div class="method-detail">
                                <p>çŸ¥åçš„é¦¬è‚‰æ–™ç†å°ˆé–€åº—ã€‚åˆé–“å¥—é¤åƒ¹æ ¼è¦ªæ°‘ï¼Œå¯ä»¥å˜—è©¦é¦¬è‚‰åˆºèº«æˆ–é¦¬è‚‰æ¼¢å ¡æ’ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Suganoya+Kamitori"
                                    target="_blank" class="btn-map">å°èˆªè‡³è…ä¹ƒå±‹</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">ğŸ£ å£½å¸ Zanmai (ã™ã—ã–ã‚“ã¾ã„) ä¸‹é€šåº—</span>
                            <div class="method-detail">
                                <p>ä½æ–¼ä¸‹é€šå•†åº—è¡—å…§ï¼Œ24å°æ™‚ç‡Ÿæ¥­çš„çŸ¥åå£½å¸é€£é–ã€‚é£Ÿæç©©å®šæ–°é®®ï¼Œå°å…’ç«¥ä¹Ÿå¾ˆå‹å–„ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Sushi+Zanmai+Shimotori+Kumamoto"
                                    target="_blank" class="btn-map">å°èˆªè‡³å£½å¸ Zanmai</a>
                            </div>
                        </div>
                    </div>

                    <div class="info-section"
                        style="border-color: #FBBF24; background-color: #FFFBEB; margin-bottom: 15px;">
                        <h3 style="color: #B45309; border-bottom-color: #FBBF24;">ğŸŒ™ æ™šé¤å£è¢‹åå–® (å±…é…’å±‹/ç‡’è‚‰/é¦¬è‚‰)</h3>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">ğŸ é¦¬æ«» (Uma Sakura) ä¸‹é€šåº—</span>
                            <div class="method-detail">
                                <p>å¦‚æœæ™šé¤æƒ³èªçœŸåƒé¦¬è‚‰æ–™ç†ï¼Œé€™è£¡æä¾›ç‡’è‚‰ã€æ¶®æ¶®é‹ç­‰å¤šç¨®åƒæ³•ã€‚åº—å…§æ°£æ°›è¼ƒæ™‚å°šï¼Œè¨­æœ‰åŒ…å»‚ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Umasakura+Shimotori"
                                    target="_blank" class="btn-map">å°èˆªè‡³é¦¬æ«»</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">ğŸ® æ©«é¦¬å ´ (Yokobachi)</span>
                            <div class="method-detail">
                                <p>ä½æ–¼ä¸Šä¹ƒè£é€šçš„å¤æ°‘å®¶é¢¨å±…é…’å±‹ã€‚æœ‰æˆ¶å¤–åº­é™¢åº§ä½ï¼Œæ°›åœæ¥µä½³ã€‚æä¾›é¤ƒå­ã€ä¸²ç‡’ç­‰è±å¯Œæ–™ç†ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Yokobachi+Kumamoto"
                                    target="_blank" class="btn-map">å°èˆªè‡³æ©«é¦¬å ´</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">ğŸ”¥ å­«ä¸‰éƒ (Mago Saburo) ç‡’è‚‰</span>
                            <div class="method-detail">
                                <p>ä¸»æ‰“ç†Šæœ¬ç”¢çš„ã€Œé»‘æ¨ºç‰›ã€ç‡’è‚‰ã€‚è‚‰è³ªé®®ç¾ï¼Œåƒ¹æ ¼åˆç†ã€‚ä½æ–¼ç†±é¬§çš„ä¸‹é€šé™„è¿‘ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Magosaburo+Kagomachi"
                                    target="_blank" class="btn-map">å°èˆªè‡³å­«ä¸‰éƒ</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">ğŸ“ å¤©è‰æ°´ç”¢ç ”ç©¶æ‰€</span>
                            <div class="method-detail">
                                <p>ä¸»æ‰“å¤©è‰ç›´é€çš„æ–°é®®æµ·é®®å±…é…’å±‹ã€‚ç”Ÿé­šç‰‡æ‹¼ç›¤éå¸¸å£¯è§€ï¼Œæµ·é®®æ„›å¥½è€…é¦–é¸ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Amakusa+Suisan+Kenkyujo"
                                    target="_blank" class="btn-map">å°èˆªè‡³å¤©è‰æ°´ç”¢</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">ğŸœ å‘³åƒæ‹‰éºµ æœ¬åº—</span>
                            <div class="method-detail">
                                <p>ç†Šæœ¬æ‹‰éºµçš„ä¸–ç•Œç´šé€£é–æœ¬åº—ã€‚å£å‘³ç©©å®šï¼Œé©åˆå®¶åº­æ—…å®¢çš„å®‰å…¨ç‰Œã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Ajisen+Ramen+Honten"
                                    target="_blank" class="btn-map">å°èˆªè‡³å‘³åƒæœ¬åº—</a>
                            </div>
                        </div>
                    </div>

                    <div class="info-section"
                        style="border-color: #F472B6; background-color: #FFF1F2; margin-bottom: 15px;">
                        <h3 style="color: #DB2777; border-bottom-color: #F472B6;">ğŸ° ç†Šæœ¬åˆèŒ¶ & å’–å•¡</h3>

                        <div class="safari-method" style="border-color: #F472B6; margin-top: 10px;">
                            <span class="method-title" style="color: #BE185D;">Swiss Konditorei (ã‚¹ã‚¤ã‚¹)</span>
                            <div class="method-detail">
                                <p>ç†Šæœ¬è€å­—è™Ÿæ´‹è“å­åº—ã€‚æ¨è–¦<b>ã€Œé…’å¿ƒå·§å…‹åŠ› (Liqueur Bonbon)ã€</b>æ˜¯ç¶“å…¸ä¼´æ‰‹ç¦®ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Swiss+Konditorei+Shimotori"
                                    target="_blank" class="btn-map">å°èˆªè‡³ Swiss</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F472B6; margin-top: 10px;">
                            <span class="method-title" style="color: #BE185D;">å²¡ç”°å’–å•¡ (Okada Coffee)</span>
                            <div class="method-detail">
                                <p>ä¸Šé€šå•†åº—è¡—çš„å„ªé›…å’–å•¡é¤¨ï¼Œæ²ˆç©©çš„æ˜­å’Œé¢¨æ ¼ã€‚é©åˆå–æ‰‹æ²–å’–å•¡é…æ —å­è›‹ç³•ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Okada+Coffee+Kamitori"
                                    target="_blank" class="btn-map">å°èˆªè‡³å²¡ç”°å’–å•¡</a>
                            </div>
                        </div>
                    </div>

                    <div class="info-section"
                        style="border-color: #F87171; background-color: #FEF2F2; margin-bottom: 15px;">
                        <h3 style="color: #DC2626; border-bottom-color: #F87171;">ğŸ  å¿…åƒï¼ç†Šæœ¬åç‰©ã€Œã„ããªã‚Šå›£å­ã€</h3>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">1. é•·å£½åºµ (é•·å¯¿åºµ)</span>
                            <div class="method-detail">
                                <p>ç†Šæœ¬æœ€æœ‰åçš„ã„ããªã‚Šå›£å­å°ˆè³£åº—ã€‚ç†±é¨°é¨°çš„ç•ªè–¯èˆ‡ç´…è±†å…§é¤¡ï¼Œå¤–çš®Qå½ˆå¾®é¹¹ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Chojuan+Kumamoto"
                                    target="_blank" class="btn-map">æœå°‹é•·å£½åºµ</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">2. è¯ä¸¸å ‚ (Hanamarudo)</span>
                            <div class="method-detail">
                                <p>ä½æ–¼æ«»ä¹‹é¦¬å ´åŸå½©è‹‘å…§ï¼Œé™¤äº†å‚³çµ±å£å‘³ï¼Œé‚„æœ‰å‰µæ–°çš„<b>å½©è‰²ç³°å­</b>ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Hanamarudo+Kumamoto"
                                    target="_blank" class="btn-map">å°èˆªè‡³è¯ä¸¸å ‚</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">3. èŠ‹å±‹é•·å…µè¡›</span>
                            <div class="method-detail">
                                <p>ç•ªè–¯å°ˆé–€åº—ï¼Œé‚„æœ‰ç•ªè–¯ç‰‡ã€ç•ªè–¯éœœæ·‡æ·‹ç­‰å„ç¨®ç•ªè–¯è£½å“ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Imoya+Chobei" target="_blank"
                                    class="btn-map">æœå°‹èŠ‹å±‹é•·å…µè¡›</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">4. æ‘ä¸Š KARASHI RENKON</span>
                            <div class="method-detail">
                                <p>æ¨è–¦å˜—è©¦ç†Šæœ¬åç‰©<b>ã€Œè¾›å­è“®è—•ã€</b>ã€‚ç¾ç‚¸ç†±ç†±åƒæ¯”è¼ƒä¸å—†è¾£ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Murakami+Karashi+Renkon"
                                    target="_blank" class="btn-map">å°èˆªè‡³æ‘ä¸Šè¾›å­è“®è—•</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">5. KUMAMON Square é™å®šç”œé»</span>
                            <div class="method-detail">
                                <p>ç†Šæœ¬éƒ¨é•·è¾¦å…¬å®¤é™å®šçš„è–ä»£æˆ–æ‹¿éµï¼Œé€ å‹å¯æ„›çµ•å°èƒ½æ”¶æœå°å­©çš„å¿ƒã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Kumamon+Square" target="_blank"
                                    class="btn-map">å°èˆªè‡³ Kumamon Square</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="day-wrapper">
                <div class="day-toggle" id="toggle-food-a" onclick="toggleTimeline('food-a', this)">
                    <div class="day-info">
                        <h3>é˜¿è˜‡ & é»‘å·å‚™æ¡ˆ</h3>
                        <span>èµ¤ç‰›ä¸¼ã€åœ°é›ã€æº«æ³‰è¡—ç”œé»</span>
                    </div>
                    <div class="toggle-icon">â–¼</div>
                </div>
                <div id="food-a" class="timeline">
                    <div class="info-section"
                        style="border-color: #34D399; background-color: #ECFDF5; margin-bottom: 15px;">
                        <h3 style="color: #059669; border-bottom-color: #34D399;">â˜€ï¸ åˆé¤å£è¢‹åå–® (èµ¤ç‰›ä¸¼/ç”°æ¨‚/è•éº¥éºµ)</h3>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">ğŸ¥© Imakin é£Ÿå ‚ (ã„ã¾ãã‚“é£Ÿå ‚)</span>
                            <div class="method-detail">
                                <p>é˜¿è˜‡<b>èµ¤ç‰›ä¸¼çš„å‚³èªªç´šååº—</b>ã€‚ç™¾å¹´è€åº—ï¼ŒåŠç†Ÿçš„èµ¤ç‰›é‹ªæ»¿ç¢—é¢ã€‚å»ºè­°ä¸€æ—©å»ç™»è¨˜ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Imakin+Shokudo" target="_blank"
                                    class="btn-map">å°èˆªè‡³ Imakin</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">â›°ï¸ å€å–°ä¸¼ (Bakuro)</span>
                            <div class="method-detail">
                                <p>ä½æ–¼åŠå±±è…°ï¼Œè¦–é‡æ¥µä½³å¯çœºæœ›é˜¿è˜‡äº”å²³ï¼Œèµ¤ç‰›æ¼¢å ¡æ’å’Œç‰›æ’ä¸¼éƒ½éå¸¸ç¾å‘³ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Restaurant+Bakuro+Aso"
                                    target="_blank" class="btn-map">å°èˆªè‡³å€å–°ä¸¼</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">ğŸ¢ é«˜æ£®ç”°æ¨‚ä¿å­˜æœƒ (é«˜æ£®ç”°æ¥½ä¿å­˜ä¼š)</span>
                            <div class="method-detail">
                                <p>é«”é©—åœ¨åœçˆè£æ—åƒ<b>ã€Œç”°æ¨‚ç‡’ã€</b>ã€‚å°‡èŠ‹é ­ã€è’Ÿè’»ã€å±±å¥³é­šå¡—ä¸Šå‘³å™Œç‚­çƒ¤ï¼Œéå¸¸å…·æœ‰æ—¥æœ¬å‚³çµ±é¢¨æƒ…ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Takamori+Dengaku+Hozonkai"
                                    target="_blank" class="btn-map">å°èˆªè‡³é«˜æ£®ç”°æ¨‚</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">ğŸ¥¢ é˜¿è˜‡è·¯ è•éº¥éºµ (ãã°å‡¦ é˜¿è˜‡è·¯)</span>
                            <div class="method-detail">
                                <p>ä½æ–¼é˜¿è˜‡ç«™é™„è¿‘çš„è€å­—è™Ÿè•éº¥éºµåº—ã€‚éºµæ¢æ‰‹å·¥è£½ä½œï¼Œæ¨è–¦æ­é…ç‚¸è¦å¤©å©¦ç¾…ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Sobadokoro+Asoji"
                                    target="_blank" class="btn-map">å°èˆªè‡³é˜¿è˜‡è·¯</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">ğŸŒ¾ è¾²å®¶é¤å»³ å±±ä¹‹é‡Œ (è¾²å®¶ã‚Œã™ã¨ã‚‰ã‚“ å±±ã®é‡Œ)</span>
                            <div class="method-detail">
                                <p>æä¾›è‡ªå®¶è¾²å ´ç¨®æ¤çš„é£Ÿæèˆ‡èµ¤ç‰›ç‡’è‚‰ã€‚ç’°å¢ƒæº«é¦¨ï¼Œé©åˆå®¶åº­ç”¨é¤ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Nouka+Restaurant+Yamanosato"
                                    target="_blank" class="btn-map">å°èˆªè‡³å±±ä¹‹é‡Œ</a>
                            </div>
                        </div>
                    </div>

                    <div class="info-section"
                        style="border-color: #FBBF24; background-color: #FFFBEB; margin-bottom: 15px;">
                        <h3 style="color: #B45309; border-bottom-color: #FBBF24;">ğŸŒ™ æ™šé¤å£è¢‹åå–® (é»‘å·æº«æ³‰/é˜¿è˜‡)</h3>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">ğŸ® å‘³è™• Naka (å‘³å‡¦ãªã‹)</span>
                            <div class="method-detail">
                                <p>é»‘å·æº«æ³‰è¡—ä¸Šçš„äººæ°£å®šé£Ÿåº—ã€‚æä¾›åœ°é›æ–™ç†ã€é—œæ±ç…®èˆ‡ä¸¼é£¯ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Ajidokoro+Naka+Kurokawa"
                                    target="_blank" class="btn-map">å°èˆªè‡³å‘³è™• Naka</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">ğŸ¥© ç‡’è‚‰ UFUFU (ç„¼è‚‰ ã€€ã†ãµãµ)</span>
                            <div class="method-detail">
                                <p>é»‘å·æº«æ³‰å€å…§çš„ç‡’è‚‰åº—ã€‚æä¾›é˜¿è˜‡ç‰›ç‡’è‚‰ï¼Œåº—å…§ä¹¾æ·¨èˆ’é©ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Yakiniku+Ufufu+Kurokawa"
                                    target="_blank" class="btn-map">å°èˆªè‡³ç‡’è‚‰ UFUFU</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">ğŸº Waroku å±‹ (ã‚ã‚ãå±‹)</span>
                            <div class="method-detail">
                                <p>é»‘å·è‘—åçš„ç™¾å¹´å»ºç¯‰é¤å»³ï¼Œä¸»æ‰“<b>ã€Œé»‘å’–å“©ã€</b>èˆ‡èµ¤ç‰›ç‰›æ’ã€‚æ°›åœå¾©å¤è¿·äººã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Warokuya+Kurokawa"
                                    target="_blank" class="btn-map">å°èˆªè‡³ Waroku å±‹</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">ğŸœ å°åœ‹è•éº¥è¡—é“ (å¾äº¦ç´…)</span>
                            <div class="method-detail">
                                <p>é˜¿è˜‡å°åœ‹ç”ºçš„è•éº¥éºµååº—ã€‚è‹¥æ™šé¤æ™‚é–“è¼ƒæ—©ï¼Œå¯ä»¥åœ¨å›é»‘å·å‰å…ˆç”¨é¤ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Sobadokoro+Waremoko"
                                    target="_blank" class="btn-map">å°èˆªè‡³å¾äº¦ç´…</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">ğŸ± é“ä¹‹é©› é˜¿è˜‡ (å¤–å¸¶å‚™æ¡ˆ)</span>
                            <div class="method-detail">
                                <p>é˜¿è˜‡ç«™æ—çš„é“ä¹‹é©›è²©è³£è¨±å¤šé«˜å“è³ªçš„<b>èµ¤ç‰›ä¾¿ç•¶</b>å’Œåœ¨åœ°ç†Ÿé£Ÿï¼Œè²·å›é£¯åº—åƒä¹Ÿå¾ˆäº«å—ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Michinoeki+Aso" target="_blank"
                                    class="btn-map">å°èˆªè‡³é“ä¹‹é©›é˜¿è˜‡</a>
                            </div>
                        </div>
                    </div>

                    <div class="info-section"
                        style="border-color: #F472B6; background-color: #FFF1F2; margin-bottom: 15px;">
                        <h3 style="color: #DB2777; border-bottom-color: #F472B6;">â˜• å±±æ—åˆèŒ¶ & ç”œé»</h3>

                        <div class="safari-method" style="border-color: #F472B6; margin-top: 10px;">
                            <span class="method-title" style="color: #BE185D;">Patisserie Roku (éº“)</span>
                            <div class="method-detail">
                                <p>é»‘å·æº«æ³‰å¿…è¨ªç”œé»åº—ã€‚<b>ã€Œé¹½éº´æ³¡èŠ™ã€</b>æ˜¯æ‹›ç‰Œï¼Œå¤–çš®é…¥è„†å…§é¤¡æ¿ƒéƒã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Patisserie+Roku+Kurokawa"
                                    target="_blank" class="btn-map">å°èˆªè‡³ Patisserie Roku</a>
                            </div>
                        </div>
                    </div>

                    <div class="info-section"
                        style="border-color: #F87171; background-color: #FEF2F2; margin-bottom: 15px;">
                        <h3 style="color: #DC2626; border-bottom-color: #F87171;">ğŸ¥› å¿…åƒï¼é˜¿è˜‡ç‰§å ´é®®ä¹³ & éœœæ·‡æ·‹</h3>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">1. ABE ç‰§å ´ (ASO MILK FACTORY)</span>
                            <div class="method-detail">
                                <p>æ¦®ç²åœ‹éš›å‘³è¦ºè³ä¸‰æ˜Ÿçš„é ‚ç´šç‰›å¥¶ã€‚å¹´è¼ªè›‹ç³•å’Œç¾©å¼å†°æ·‡æ·‹ (Gelato) è¶…ç´šæ¿ƒéƒã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Aso+Milk+Factory"
                                    target="_blank" class="btn-map">å°èˆªè‡³ Aso Milk Factory</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">2. å¤§è§€å³° èŒ¶åº—</span>
                            <div class="method-detail">
                                <p>åœ¨çµ•æ™¯å±•æœ›å°åƒ<b>é˜¿è˜‡å°åœ‹æ¾¤è¥¿ç‰›ä¹³</b>è£½ä½œçš„éœœæ·‡æ·‹ï¼Œå¥¶é¦™ç‰¹æ¿ƒã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Daikanbo+Tea+House"
                                    target="_blank" class="btn-map">å°èˆªè‡³å¤§è§€å³°èŒ¶åº—</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">3. è‰åƒé‡Œ çˆç²ç„™ç…æ‰€</span>
                            <div class="method-detail">
                                <p>ä½æ–¼è‰åƒé‡Œå±•æœ›å°ï¼Œæ–‡é’é¢¨æ ¼çš„å’–å•¡åº—ã€‚æ‰‹æ²–å’–å•¡æ­é…ç¨ç‰¹çš„ç«¹ç‚­æ‹¿éµã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Kusasenri+Coffee+Roastery"
                                    target="_blank" class="btn-map">å°èˆªè‡³è‰åƒé‡Œå’–å•¡</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">4. å±±å¹æ°´æº çƒ¤é¦™é­š</span>
                            <div class="method-detail">
                                <p>ç”¢å±±æ‘æ°´æºé ­æ—çš„ç¾çƒ¤é¦™é­šã€‚è‚‰è³ªç´°ç·»ï¼Œé€£éª¨é ­éƒ½èƒ½åƒï¼Œå­©å­ä¹Ÿèƒ½è¼•é¬†å˜—è©¦ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Yamabuki+Suigen"
                                    target="_blank" class="btn-map">å°èˆªè‡³å±±å¹æ°´æº</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">5. ç™½å·æ°´æº ç‰©ç”¢é¤¨</span>
                            <div class="method-detail">
                                <p>å–ç”¨åæ°´è£½ä½œçš„<b>ã€Œæ°´é¥…é ­ã€</b>å’Œè±†è…ï¼Œå£æ„Ÿæ»‘å«©æ¸…çˆ½ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Shirakawa+Suigen"
                                    target="_blank" class="btn-map">å°èˆªè‡³ç™½å·æ°´æº</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="day-wrapper">
                <div class="day-toggle" id="toggle-food-y" onclick="toggleTimeline('food-y', this)">
                    <div class="day-info">
                        <h3>åˆ¥åºœ & ç”±å¸ƒé™¢å‚™æ¡ˆ</h3>
                        <span>åœ°ç„è’¸ã€è±å¾Œç‰›é‡œé£¯</span>
                    </div>
                    <div class="toggle-icon">â–¼</div>
                </div>
                <div id="food-y" class="timeline">
                    <div class="info-section"
                        style="border-color: #34D399; background-color: #ECFDF5; margin-bottom: 15px;">
                        <h3 style="color: #059669; border-bottom-color: #34D399;">â˜€ï¸ åˆé¤å£è¢‹åå–® (é‡œé£¯/å¤©å©¦ç¾…/åœ°ç„è’¸)</h3>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">ğŸš ç”±å¸ƒMabushi å¿ƒ (ç”±å¸ƒã¾ã¶ã— å¿ƒ)</span>
                            <div class="method-detail">
                                <p>ç”±å¸ƒé™¢å¿…åƒ<b>ã€Œè±å¾Œç‰›é‡œé£¯ã€</b>ï¼Œä¸€é‹ä¸‰åƒã€‚å»ºè­°é–‹åº—å‰å»é‡‘é±—æ¹–åº—æ’éšŠã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Yufu+Mabushi+Shin+Kinrinko"
                                    target="_blank" class="btn-map">å°èˆªè‡³é‡‘é±—æ¹–åº—</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">ğŸ¤ æ±æ´‹è»’ (Toyoken) - åˆ¥åºœ</span>
                            <div class="method-detail">
                                <p>å¤§åˆ†åç‰©<b>ã€Œé›è‚‰å¤©å©¦ç¾…ã€</b>ç™¼æºåœ°ã€‚å¤–é…¥å…§å«©ï¼Œé…¸æ©˜é†‹é†¬æ²¹æ¸…çˆ½å¥½åƒï¼Œå­©å­æœ€æ„›ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Toyoken+Beppu" target="_blank"
                                    class="btn-map">å°èˆªè‡³æ±æ´‹è»’</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">â™¨ï¸ åœ°ç„è’¸å·¥æˆ¿ éµè¼ª (åœ°ç„è’¸ã—å·¥æˆ¿)</span>
                            <div class="method-detail">
                                <p>DIYé«”é©—å‹é¤å»³ã€‚åˆ©ç”¨æº«æ³‰è’¸æ°£è’¸ç†Ÿè”¬èœæµ·é®®ï¼Œå¥åº·åˆå¥½ç©ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Jigokumushi+Kobo+Kannawa"
                                    target="_blank" class="btn-map">å°èˆªè‡³åœ°ç„è’¸å·¥æˆ¿</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">ğŸœ å…­ç›› (Rokusei) å†·éºµ - åˆ¥åºœ</span>
                            <div class="method-detail">
                                <p>åˆ¥åºœåç‰©<b>ã€Œå†·éºµã€</b>ã€‚éºµæ¢Qå½ˆæœ‰å‹ï¼Œç‰›è‚‰æ¹¯é ­é†‡åšï¼Œä¸€å¹´å››å­£éƒ½å¥½åƒã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Rokusei+Reimen+Beppu"
                                    target="_blank" class="btn-map">å°èˆªè‡³å…­ç››å†·éºµ</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">ğŸ¶ Snoopy Tea House ç”±å¸ƒé™¢</span>
                            <div class="method-detail">
                                <p>å…¨çƒç¬¬ä¸€é–“å²åŠªæ¯”èŒ¶å±‹ã€‚æä¾›å¯æ„›é€ å‹é¤é»ï¼Œå£å‘³æ„å¤–åœ°å¥½ï¼Œç’°å¢ƒç™‚ç™’ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Snoopy+Tea+House+Yufuin"
                                    target="_blank" class="btn-map">å°èˆªè‡³å²åŠªæ¯”èŒ¶å±‹</a>
                            </div>
                        </div>
                    </div>

                    <div class="info-section"
                        style="border-color: #FBBF24; background-color: #FFFBEB; margin-bottom: 15px;">
                        <h3 style="color: #B45309; border-bottom-color: #FBBF24;">ğŸŒ™ æ™šé¤å£è¢‹åå–® (ç‡’è‚‰/å±…é…’å±‹/æ´‹é£Ÿ)</h3>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">ğŸ¥© ç‡’è‚‰å…ƒç›¸ (Gensou) - åˆ¥åºœ</span>
                            <div class="method-detail">
                                <p>åˆ¥åºœäººæ°£ç‡’è‚‰ï¼Œæä¾›é«˜å“è³ªè±å¾Œç‰›ã€‚åº§ä½å¯¬æ•é©åˆå®¶åº­ï¼Œå»ºè­°é ç´„ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Yakiniku+Gensou+Beppu"
                                    target="_blank" class="btn-map">å°èˆªè‡³ç‡’è‚‰å…ƒç›¸</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">ğŸŸ æµ·é®®å±…é…’å±‹ çˆç«¯ä» (Robata Jin)</span>
                            <div class="method-detail">
                                <p>ä½æ–¼åˆ¥åºœç«™å‰ï¼ŒCPå€¼é«˜ã€‚å¿…åƒå¤§åˆ†åç‰©ã€Œé—œé¯–é­šã€é—œç«¹è¢é­šã€ç”Ÿé­šç‰‡ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Robata+Jin+Beppu"
                                    target="_blank" class="btn-map">å°èˆªè‡³çˆç«¯ä»</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">ğŸ½ï¸ Somuri (ãã‚€ã‚Š) ç‰›æ’é¤¨ - åˆ¥åºœ</span>
                            <div class="method-detail">
                                <p>æ­£å®—è±å¾Œç‰›ç‰›æ’ã€‚è€æ´¾è¥¿é¤å»³é¢¨æ ¼ï¼Œæœå‹™å‘¨åˆ°ï¼Œç‰›æ’é®®å«©å¤šæ±ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Steak+House+Somuri+Beppu"
                                    target="_blank" class="btn-map">å°èˆªè‡³ Somuri</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">ğŸ£ é¾œæ­£è¿´è½‰å£½å¸ (Kamesho) - åˆ¥åºœ</span>
                            <div class="method-detail">
                                <p>åˆ¥åºœå‚³å¥‡æ’éšŠå£½å¸ã€‚ç”Ÿé­šç‰‡åšåˆ‡ã€CPå€¼æ¥µé«˜ã€‚åªèƒ½ç¾å ´æ’éšŠï¼Œå»ºè­°æ™šé¤å‰ææ—©å»ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Kamesho+Kurukuru+Sushi"
                                    target="_blank" class="btn-map">å°èˆªè‡³é¾œæ­£å£½å¸</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">ğŸ¥˜ é¾œä¹‹äº•åˆ¥èŠ æ¹¯ä¹‹å²³åºµ - ç”±å¸ƒé™¢</span>
                            <div class="method-detail">
                                <p>ç’°å¢ƒæ¥µç‚ºæ¸…å¹½é›…è‡´ï¼Œæä¾›ç²¾ç·»çš„å±±é‡Œæ–™ç†ã€‚ä¸ä½å®¿ä¹Ÿèƒ½äº«å—é ‚ç´šæ°›åœã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Yunotakean+Yufuin"
                                    target="_blank" class="btn-map">å°èˆªè‡³æ¹¯ä¹‹å²³åºµ</a>
                            </div>
                        </div>
                    </div>

                    <div class="info-section"
                        style="border-color: #F472B6; background-color: #FFF1F2; margin-bottom: 15px;">
                        <h3 style="color: #DB2777; border-bottom-color: #F472B6;">â˜• ç”±å¸ƒé™¢ç«¥è©±åˆèŒ¶</h3>

                        <div class="safari-method" style="border-color: #F472B6; margin-top: 10px;">
                            <span class="method-title" style="color: #BE185D;">Miffy Kitchen (ç±³é£›å…”éºµåŒ…)</span>
                            <div class="method-detail">
                                <p>ç«¥è©±å°å±‹é¢¨æ ¼ï¼Œè²©å”®ç±³é£›å…”é€ å‹éºµåŒ…ã€‚äºŒæ¨“æœ‰å…§ç”¨å€ï¼Œé©åˆè¦ªå­ä¼‘æ¯ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Miffy+Kitchen+Yufuin"
                                    target="_blank" class="btn-map">å°èˆªè‡³ç±³é£›å…”å»šæˆ¿</a>
                            </div>
                        </div>
                    </div>

                    <div class="info-section"
                        style="border-color: #F87171; background-color: #FEF2F2; margin-bottom: 15px;">
                        <h3 style="color: #DC2626; border-bottom-color: #F87171;">ğŸ° å¿…åƒï¼ç”±å¸ƒé™¢æ•£æ­¥ç”œé»</h3>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">1. B-Speak è›‹ç³•æ²</span>
                            <div class="method-detail">
                                <p>ç”±å¸ƒé™¢ç”œé»ç‹è€…ã€‚è›‹ç³•æ²è“¬é¬†æ¿•æ½¤ã€‚é€šå¸¸ä¸­åˆå‰æœƒè³£å®Œå°æ¢è£ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=B-Speak+Yufuin" target="_blank"
                                    class="btn-map">å°èˆªè‡³ B-Speak</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">2. Milch (ãƒŸãƒ«ãƒ’) èµ·å¸æ¯</span>
                            <div class="method-detail">
                                <p>åŠç†Ÿèµ·å¸è›‹ç³•æ¯ï¼Œç†±ç†±åƒä¸­é–“æœƒæµå¿ƒã€‚æ¨è–¦ç¾å ´åƒç†±çš„ï¼</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Milch+Yufuin" target="_blank"
                                    class="btn-map">å°èˆªè‡³ Milch</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">3. é‡‘è³å¯æ¨‚é¤… (é‡‘è³ã‚³ãƒ­ãƒƒã‚±)</span>
                            <div class="method-detail">
                                <p>æ¹¯ä¹‹åªè¡—é“å¿…åƒã€‚å¤–çš®é…¥è„†ï¼Œå…§é¤¡ç‰›è‚‰é¦¬éˆ´è–¯æ³¥é¹¹é¦™å¥½åƒã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Gold+Prize+Croquette+Yufuin"
                                    target="_blank" class="btn-map">å°èˆªè‡³é‡‘è³å¯æ¨‚é¤…</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">4. é æ™º (Cucuchi) éŠ…é‘¼ç‡’</span>
                            <div class="method-detail">
                                <p>ç¾åšçš„éŠ…é‘¼ç‡’ï¼Œé¤…çš®é¬†è»Ÿã€‚åº—é¢è¨­è¨ˆå¾ˆç¾ï¼Œé©åˆæ‹ç…§ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Cucuchi+Yufuin" target="_blank"
                                    class="btn-map">å°èˆªè‡³é æ™º</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">5. å²¡æœ¬å±‹ åœ°ç„è’¸å¸ƒä¸ (åˆ¥åºœ)</span>
                            <div class="method-detail">
                                <p>åˆ©ç”¨æº«æ³‰è’¸æ°£è£½ä½œçš„å¸ƒä¸ï¼Œå£æ„Ÿæ‰å¯¦å¸¶æœ‰ç„¦ç³–è‹¦ç”œå‘³ï¼Œåˆ¥åºœå¿…åƒã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Okamotoya+Shop" target="_blank"
                                    class="btn-map">å°èˆªè‡³å²¡æœ¬å±‹</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="day-wrapper">
                <div class="day-toggle" id="toggle-food-f" onclick="toggleTimeline('food-f', this)">
                    <div class="day-info">
                        <h3>ç¦å²¡å€å‚™æ¡ˆ</h3>
                        <span>ç‰›è…¸é‹ã€å±‹å°ã€åšå¤šæ‹‰éºµ</span>
                    </div>
                    <div class="toggle-icon">â–¼</div>
                </div>
                <div id="food-f" class="timeline">
                    <div class="info-section"
                        style="border-color: #34D399; background-color: #ECFDF5; margin-bottom: 15px;">
                        <h3 style="color: #059669; border-bottom-color: #34D399;">â˜€ï¸ åˆé¤å£è¢‹åå–® (å£½å¸/å®šé£Ÿ/çƒé¾éºµ)</h3>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">ğŸ£ ç“¢ç°å£½å¸ (ã²ã‚‡ã†ãŸã‚“å¯¿å¸)</span>
                            <div class="method-detail">
                                <p>å¤©ç¥åœ°å€CPå€¼æœ€é«˜çš„æ’éšŠå£½å¸ååº—ã€‚é£Ÿææ–°é®®ã€åƒ¹æ ¼åˆç†ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Hyotan+Sushi+Tenjin"
                                    target="_blank" class="btn-map">å°èˆªè‡³ç“¢ç°å£½å¸</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">ğŸ¤ å¤©éº©ç¾…è™• Hirao (å¤©éº©ç¾…å‡¦ã²ã‚‰ãŠ)</span>
                            <div class="method-detail">
                                <p>ç¦å²¡éˆé­‚ç¾é£Ÿï¼ç¾ç‚¸å¤©å©¦ç¾…ä¸€é“é“ä¸Šæ¡Œï¼Œå…è²»çš„<b>ã€ŒæŸšå­èŠ±æã€</b>éå¸¸ä¸‹é£¯ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Tempura+Hirao+Daimyo"
                                    target="_blank" class="btn-map">å°èˆªè‡³å¤§ååº—</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">ğŸœ å¤§åœ°ä¹‹çƒé¾éºµ (å¤§åœ°ã®ã†ã©ã‚“)</span>
                            <div class="method-detail">
                                <p>åšå¤šçƒé¾éºµä»£è¡¨ã€‚æ¨è–¦<b>ã€Œç‰›è’¡å¤©çƒé¾éºµã€</b>ï¼Œç‚¸ç‰›è’¡å¤§åˆ°è“‹ä½ç¢—ï¼Œéºµæ¢åŠé€æ˜Qå½ˆã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Daichi+no+Udon+Hakata"
                                    target="_blank" class="btn-map">å°èˆªè‡³åšå¤šç«™åœ°ä¸‹åº—</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">ğŸ± å‰å¡šé°»é­šå±‹ (å‰å¡šã†ãªãå±‹)</span>
                            <div class="method-detail">
                                <p>ä¸­æ´²æ²³ç•”ç™¾å¹´ååº—ã€‚çƒ¤å·¥çµ•ä½³ï¼Œå¤–é…¥å…§å«©ã€‚å»ºè­°é–‹åº—å‰æŠ½è™Ÿç¢¼ç‰Œã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Yoshizuka+Unagiya"
                                    target="_blank" class="btn-map">å°èˆªè‡³å‰å¡šé°»é­šå±‹</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #34D399; margin-top: 10px;">
                            <span class="method-title" style="color: #059669;">ğŸ¦€ ç¨šåŠ æ¦® (Chikae) - å‡æ—¥åˆé–“å¾¡è†³</span>
                            <div class="method-detail">
                                <p>ç¦å²¡é«˜ç´šæ–™äº­ï¼Œåˆé¤é™é‡å¾¡è†³ã€‚å¯ä»¥åœ¨å·¨å¤§çš„é­šæ± å§å°æ—ç”¨é¤ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Chikae+Fukuoka" target="_blank"
                                    class="btn-map">å°èˆªè‡³ç¨šåŠ æ¦®</a>
                            </div>
                        </div>
                    </div>

                    <div class="info-section"
                        style="border-color: #FBBF24; background-color: #FFFBEB; margin-bottom: 15px;">
                        <h3 style="color: #B45309; border-bottom-color: #FBBF24;">ğŸŒ™ æ™šé¤å£è¢‹åå–® (é‹ç‰©/æ‹‰éºµ/ç‡’è‚‰)</h3>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">ğŸ² åšå¤šè¯å‘³é³¥ (æ°´ç‚Šé›è‚‰é‹)</span>
                            <div class="method-detail">
                                <p><b>è¦ªå­é¦–é¸</b>ã€‚é›æ¹¯æ¿ƒéƒå……æ»¿è† åŸè›‹ç™½ï¼Œå£å‘³æ¸…çˆ½å¥åº·ã€‚å»ºè­°é ç´„ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Hakata+Hanamidori+Hakata"
                                    target="_blank" class="btn-map">æœå°‹è¯å‘³é³¥</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">ğŸœ Shin-Shin æ‹‰éºµ</span>
                            <div class="method-detail">
                                <p>éºµæ¢æ¥µç´°ï¼Œè±šéª¨æ¹¯é ­æ¿ƒéƒç„¡è…¥å‘³ï¼Œå°æœ‹å‹æ¥å—åº¦é«˜ã€‚å¤©ç¥æœ¬åº—å¸¸å¤§æ’é•·é¾ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Hakata+Ramen+Shin-Shin+Tenjin"
                                    target="_blank" class="btn-map">æœå°‹ Shin-Shin</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">ğŸ¥© æ¥µå‘³å±‹ (KIWAMIYA) æ¼¢å ¡æ’</span>
                            <div class="method-detail">
                                <p>ç‰¹è‰²<b>ã€ŒDIY éµæ¿æ¼¢å ¡æ’ã€</b>ï¼Œè‡ªå·±ç”¨ç­·å­åˆ‡ä¸‹ç…ç†Ÿã€‚æ’éšŠéšŠä¼é€šå¸¸å¾ˆé•·ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Kiwamiya+Hakata"
                                    target="_blank" class="btn-map">å°èˆªè‡³æ¥µå‘³å±‹</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">ğŸ¥˜ åšå¤šæ‘©æ»‹é‹ å¤§å±± (ã‚‚ã¤é‹ ãŠãŠã‚„ã¾)</span>
                            <div class="method-detail">
                                <p>æ¨è–¦<b>ã€Œå‘³å™Œå£å‘³ã€</b>ç‰›è…¸é‹ã€‚åšå¤šç«™å…§æœ‰åˆ†åº—ï¼Œäº¤é€šæ–¹ä¾¿ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Hakata+Motsunabe+Ooyama"
                                    target="_blank" class="btn-map">æœå°‹å¤§å±±ç‰›è…¸é‹</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #FBBF24; margin-top: 10px;">
                            <span class="method-title" style="color: #B45309;">ğŸ£ åšå¤šé­šå˜‰ (åšå¤šé­šãŒã—)</span>
                            <div class="method-detail">
                                <p>ä½æ–¼åšå¤šç«™ä¸€ç•ªè¡—ã€‚ç”±é­šå¸‚å ´ç›´ç‡Ÿï¼Œé£Ÿææ–°é®®ï¼Œé©åˆæƒ³åƒå£½å¸ä½†ä¸æƒ³è·‘é çš„é¸æ“‡ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Hakata+Uogashi+Hakata+Station"
                                    target="_blank" class="btn-map">å°èˆªè‡³åšå¤šé­šå˜‰</a>
                            </div>
                        </div>
                    </div>

                    <div class="info-section"
                        style="border-color: #F472B6; background-color: #FFF1F2; margin-bottom: 15px;">
                        <h3 style="color: #DB2777; border-bottom-color: #F472B6;">ğŸ° ä¸‹åˆèŒ¶ & ç™‚ç™’ç”œé» (é€›ç´¯å°ˆç”¨)</h3>

                        <div class="safari-method" style="border-color: #F472B6; margin-top: 10px;">
                            <span class="method-title" style="color: #BE185D;">Cafe del SOL (å¤©ç¥/è¥¿é€š)</span>
                            <div class="method-detail">
                                <p><b>ã€Œè“¬é¬†ç³»é¬†é¤…ã€</b>ï¼Œå£æ„Ÿåƒé›²æœµä¸€æ¨£è»Ÿç¶¿ã€‚å—å¥³æ€§èˆ‡å°å­©æ­¡è¿ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Cafe+del+SOL+Fukuoka"
                                    target="_blank" class="btn-map">å°èˆªè‡³ Cafe del SOL</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F472B6; margin-top: 10px;">
                            <span class="method-title" style="color: #BE185D;">Mutsukado ã‚€ã¤ã‹å ‚ (åšå¤šç«™)</span>
                            <div class="method-detail">
                                <p>çŸ¥ååå¸å°ˆè³£åº—å’–å•¡å»³ï¼Œå¿…åƒ<b>ã€Œæ°´æœé®®å¥¶æ²¹ä¸‰æ˜æ²»ã€</b>ã€‚ä½æ–¼ AMU PLAZA 5æ¨“ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Mutsukado+Hakata"
                                    target="_blank" class="btn-map">å°èˆªè‡³ AMU PLAZA åº—</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F472B6; margin-top: 10px;">
                            <span class="method-title" style="color: #BE185D;">il FORNO del Mignon (åšå¤šç«™)</span>
                            <div class="method-detail">
                                <p>åšå¤šç«™ä¸­å¤®æ”¹æœ­å£æ—çš„<b>ã€Œè¿·ä½ å¯é Œã€</b>æ’éšŠååº—ã€‚é©åˆè²·å›é£¯åº—ç•¶å®µå¤œã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=il+FORNO+del+Mignon+Hakata"
                                    target="_blank" class="btn-map">å°èˆªè‡³åšå¤šç«™å¯é Œ</a>
                            </div>
                        </div>
                    </div>

                    <div class="info-section"
                        style="border-color: #F87171; background-color: #FEF2F2; margin-bottom: 15px;">
                        <h3 style="color: #DC2626; border-bottom-color: #F87171;">ğŸ¥– å¿…åƒï¼æ˜å¤ªå­æ³•åœ‹éºµåŒ… (5å¤§ååº—)</h3>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">1. Full Full (ãƒ•ãƒ«ãƒ•ãƒ«)</span>
                            <div class="method-detail">
                                <p>ç¦å²¡æ˜å¤ªå­æ³•åœ‹éºµåŒ…çš„ä»£åè©ï¼å¤–çš®é…¥è„†ï¼Œå…§é¤¡æ¿ƒéƒã€‚å€¼å¾—ç‰¹åœ°å‰å¾€ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Full+Full+Bakery+Fukuoka"
                                    target="_blank" class="btn-map">æœå°‹ Full Full</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">2. Pain Stock (ãƒ‘ãƒ³ã‚¹ãƒˆãƒƒã‚¯)</span>
                            <div class="method-detail">
                                <p>ç¦å²¡è¶…äººæ°£æ’éšŠéºµåŒ…åº—ã€‚æ‹›ç‰Œæ˜å¤ªå­æ³•åœ‹éºµåŒ…å£æ„Ÿæ¥µä½³ï¼Œå¸¸ç§’æ®ºã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Pain+Stock+Tenjin"
                                    target="_blank" class="btn-map">å°èˆªè‡³å¤©ç¥åº— (Stock)</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">3. DACOMECCA (ãƒ€ã‚³ãƒ¡ãƒƒã‚«)</span>
                            <div class="method-detail">
                                <p>æ±äº¬è¶…ç´… Amam Dacotan å§Šå¦¹åº—ã€‚è£æ½¢å¤¢å¹»ï¼Œç‚­çƒ¤æ¼¢å ¡æ’èˆ‡æ˜å¤ªå­éºµåŒ…å¿…è²·ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Dacomecca+Hakata"
                                    target="_blank" class="btn-map">å°èˆªè‡³ Dacomecca</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">4. TRANDOR (ãƒˆãƒ©ãƒ³ãƒ‰ãƒ¼ãƒ«)</span>
                            <div class="method-detail">
                                <p>ä½æ–¼åšå¤šç«™å…§ã€‚åŠç†Ÿè›‹å’–å“©éºµåŒ…å’Œæ˜å¤ªå­éºµåŒ…æ˜¯æ—…å®¢è£œçµ¦é¦–é¸ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=Trandor+Hakata" target="_blank"
                                    class="btn-map">å°èˆªè‡³åšå¤šç«™åº—</a>
                            </div>
                        </div>

                        <div class="safari-method" style="border-color: #F87171; margin-top: 10px;">
                            <span class="method-title" style="color: #DC2626;">5. THE CITY BAKERY</span>
                            <div class="method-detail">
                                <p>ä½æ–¼å¤©ç¥ Solaria Plaza B2ã€‚æ¨è–¦<b>ã€Œæ˜å¤ªå­æ¤’é¹½å¯é Œã€</b>ï¼Œé¹¹é¦™é…¥è„†ã€‚</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=The+City+Bakery+Tenjin"
                                    target="_blank" class="btn-map">å°èˆªè‡³å¤©ç¥åº—</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <!-- ä¿®æ­£ 1: å°‡ Emoji ğŸŒ æ›æˆç°¡ç´„ SVG åœ°çƒåœ–ç¤º -->
                    <div class="card-title" style="display: flex; align-items: center; gap: 6px;">
                        <svg class="icon-mini" style="color: var(--primary);">
                            <use href="#icon-earth"></use>
                        </svg>
                        å³æ™‚å¤©æ°£æŸ¥è©¢ & ç©¿è¡£å»ºè­°
                    </div>
                </div>

                <div class="weather-search-box">
                    <input type="text" id="weather-city-input" class="weather-input" placeholder="è¼¸å…¥åŸå¸‚ (ä¾‹å¦‚: ç†Šæœ¬, ç”±å¸ƒé™¢)">
                    <button class="btn-weather-search" onclick="fetchRealtimeWeather()">æŸ¥è©¢</button>
                </div>

                <!-- Main Result -->
                <div id="weather-result" style="display: none;" class="animate-fade-in">

                    <div
                        style="display: grid; grid-template-columns: 1fr 1.2fr 1fr; gap: 8px; margin-bottom: 12px; align-items: stretch;">

                        <div
                            style="background: white; padding: 8px 4px; border-radius: 12px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: center; align-items: center;">
                            <div
                                style="color: #6B7280; font-size: 10px; margin-bottom: 2px; display: flex; align-items: center; justify-content: center; gap: 2px;">
                                <span id="wc-loc-box"><svg class="icon-mini" style="width:12px; height:12px;">
                                        <use href="#icon-loc"></use>
                                    </svg> æˆ‘çš„ä½ç½®</span>
                            </div>
                            <div id="wc-my-temp" style="font-size: 18px; font-weight: 700; color: #374151;">--Â°</div>
                        </div>

                        <div id="wc-box-main"
                            style="background: #5A92E8; color: white; padding: 8px 4px; border-radius: 12px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 1px solid transparent; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: all 0.3s ease;">
                            <div id="wc-loc"
                                style="font-size: 14px; font-weight: 500; margin-bottom: 0px; line-height: 1.2;">æŸ¥è©¢ä¸­
                            </div>
                            <div style="display: flex; align-items: center; justify-content: center; gap: 2px;">
                                <span id="wc-temp" style="font-size: 24px; font-weight: 700;">--Â°</span>
                            </div>
                            <div id="wc-desc" style="font-size: 11px; opacity: 0.9;">--</div>
                        </div>

                        <div id="wc-diff-box"
                            style="background: #F3F4F6; padding: 8px 4px; border-radius: 12px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid transparent; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: all 0.3s ease;">
                            <div id="wc-diff-title"
                                style="color: inherit; font-size: 10px; margin-bottom: 4px; opacity: 0.8;">èˆ‡ç•¶åœ°æº«å·®</div>

                            <div id="wc-diff-val" style="font-size: 1.1rem; font-weight: bold; color: inherit;">--</div>

                            <div id="wc-diff-tag" style="display: none;"></div>
                        </div>
                    </div>

                    <div
                        style="background: white; border-left: 4px solid #5A92E8; padding: 10px; border-radius: 0 8px 8px 0; font-size: 13px; color: #1E40AF; display: flex; align-items: flex-start; gap: 8px;">
                        <svg class="icon-mini" style="flex-shrink: 0; margin-top: 2px; color: #5A92E8;">
                            <use href="#icon-shirt"></use>
                        </svg>
                        <span id="wc-advice" style="line-height: 1.4;">æŸ¥è©¢å¾Œå°‡é¡¯ç¤ºç©¿è¡£å»ºè­°...</span>
                    </div>

                </div>

                <!-- Default / Loading State -->
                <div id="weather-placeholder" style="text-align: center; padding: 40px; color: #9CA3AF;">
                    <svg viewBox="0 0 24 24"
                        style="width: 60px; height: 60px; stroke: #D1D5DB; fill: none; stroke-width: 1.5; margin-bottom: 10px;">
                        <path d="M12 2v2"></path>
                        <path d="m4.93 4.93 1.41 1.41"></path>
                        <path d="M20 12h2"></path>
                        <path d="m19.07 4.93-1.41 1.41"></path>
                        <path d="M15.947 12.65a4 4 0 0 0-5.925-4.128"></path>
                        <path d="M13 22H7a5 5 0 1 1 4.9-6H13a3 3 0 0 1 0 6Z"></path>
                    </svg>
                    <div>è«‹è¼¸å…¥åŸå¸‚åç¨±æŸ¥è©¢å³æ™‚å¤©æ°£</div>
                </div>
            </div>

        </div>
        <!-- ç†Šæœ¬ ä¸Š/ä¸‹é€š æ”»ç•¥ -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">Day 1: ç†Šæœ¬ ä¸Šé€š/ä¸‹é€š é€›è¡—æ”»ç•¥</div>
                <div class="tag tag-shop">è³¼ç‰©ç¾é£Ÿ</div>
            </div>

            <div class="info-section kumamoto">
                <h3>ğŸ›ï¸ ä¸Šé€š (Kamitori) èˆ‡ ä¸‹é€š (Shimodori)</h3>
                <p style="font-size: 0.95rem;">
                    é€™æ˜¯ç†Šæœ¬æœ€ä¸»è¦çš„å…©æ¢æ‹±å»Šå•†åº—è¡—ï¼Œçš†ç‚ºå®¤å…§ç©ºé–“ï¼Œå³ä½¿ä¸‹é›¨ä¹Ÿä¸æ€•ã€‚æ­ä¹˜ç†Šæœ¬å¸‚é›»è‡³ã€Œé€šç”ºç­‹ã€æˆ–ã€Œè¾›å³¶ç”ºã€ç«™å³å¯åˆ°é”æ ¸å¿ƒå€åŸŸã€‚
                </p>

                <div class="safari-method" style="border-color: #90CDF4; margin-top: 15px;">
                    <span class="method-title" style="color: var(--kumamoto-info-text);">ä¸Šé€š (åŒ—æ®µ) - æ‚ é–’èˆ‡è³ªæ„Ÿ</span>
                    <div class="method-detail">
                        <p>ä¸Šé€šåå‘**æ–‡é’ã€ç²¾å“ã€å’–å•¡å»³**å’Œ**æœ¬åœ°è€åº—**ï¼Œæ°£æ°›ç›¸å°å®‰éœå„ªé›…ã€‚é©åˆæƒ³æ‰¾ç‰¹è‰²å°åº—ã€æ›¸åº—æˆ–å–ä¸‹åˆèŒ¶çš„å®¶åº­ã€‚</p>
                        <ul style="list-style-type: disc; margin-top: 5px; padding-left: 20px;">
                            <li>**é‡é»åº—å®¶ï¼š** é¶´å±‹ç™¾è²¨ã€å€‹æ€§é›œè²¨åº—ã€æ›¸åº—ã€‚</li>
                            <li>**å‚™è¨»ï¼š** é€™è£¡é€£æ¥è‘—ç†Šæœ¬åŸï¼Œé€šå¸¸å¾ç†Šæœ¬åŸæ–¹å‘èµ°éä¾†æ˜¯ç¬¬ä¸€ç«™ã€‚</li>
                        </ul>
                    </div>
                </div>

                <div class="safari-method" style="margin-top: 15px; border-color: #90CDF4;">
                    <span class="method-title" style="color: var(--kumamoto-info-text);">ä¸‹é€š (å—æ®µ) - åº¶æ°‘èˆ‡ç¾é£Ÿ</span>
                    <div class="method-detail">
                        <p>ä¸‹é€šæ˜¯æœ€ç†±é¬§çš„ä¸€æ®µï¼Œä»¥**è—¥å¦åº—ã€æœé£¾é€£é–åº—ã€é›»ç©åº—**å’Œ**é¤é£²åº—**ç‚ºä¸»ï¼Œå……æ»¿åº¶æ°‘æ´»åŠ›ã€‚å¤§éƒ¨åˆ†çŸ¥åçš„ç†Šæœ¬æ‹‰éºµåº—ï¼ˆå¦‚å¤©å¤–å¤©ï¼‰å’Œè±¬æ’åº—ï¼ˆå¦‚å‹çƒˆäº­ï¼‰éƒ½åœ¨é™„è¿‘å··å¼„ä¸­ã€‚</p>
                        <ul style="list-style-type: disc; margin-top: 5px; padding-left: 20px;">
                            <li>**é‡é»åº—å®¶ï¼š** å”å‰è¨¶å¾·ï¼ˆãƒ‰ãƒ³ã‚­ï¼‰ã€å¤§å‹è—¥å¦åº—ã€é›»å½±é™¢ã€‚</li>
                            <li>**å‚™è¨»ï¼š** é€™è£¡é è¿‘è¾›å³¶ç”ºï¼Œå¯æ­ä¹˜å¸‚é›»è¿”å›ç†Šæœ¬ç«™ï¼Œäº¤é€šä¾¿åˆ©ã€‚</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–°å¢ï¼šDay 2 é»‘å·æº«æ³‰æ•£æ­¥æ”»ç•¥ -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">Day 2: é»‘å·æº«æ³‰ æ•£ç­–èˆ‡å…¥æ¹¯æ‰‹å½¢</div>
                <div class="tag tag-relax">æº«æ³‰æ°£æ°›</div>
            </div>

            <div class="info-section" style="background-color: #FDF4F1; border-color: #78350F;">
                <h3 style="color: #78350F; border-bottom-color: #78350F;">â™¨ï¸ å…¥æ¹¯æ‰‹å½¢ (Onsen Hopping Pass)</h3>
                <p style="font-size: 0.95rem; color: #444;">
                    é€™æ˜¯é»‘å·æº«æ³‰æœ€å¤§çš„ç‰¹è‰²ï¼åªè¦è³¼è²·ä¸€æšæœ¨è£½çš„ã€Œå…¥æ¹¯æ‰‹å½¢ã€(ç´„ 1,500å††)ï¼Œå³å¯ä»»é¸ 3 é–“æ—…é¤¨çš„éœ²å¤©æº«æ³‰æ³¡æ¹¯ã€‚
                </p>
                <div class="safari-method" style="margin-top: 10px; border-color: #78350F;">
                    <span class="method-title" style="color: #78350F;">ä½¿ç”¨å°æ’‡æ­¥</span>
                    <div class="method-detail">
                        <ul style="padding-left: 20px; line-height: 1.6;">
                            <li><b>ä½œç‚ºç´€å¿µå“ï¼š</b>ä½¿ç”¨å®Œç•¢å¾Œï¼Œæ‰‹å½¢å¯ä»¥è“‹ä¸Šå°ç« å¸¶å›å®¶ç•¶æ¯å¢Šæˆ–æ›é£¾ï¼Œéå¸¸æœ‰è³ªæ„Ÿã€‚</li>
                            <li><b>å„ªæƒ æŠ˜æ‰£ï¼š</b>æ›è‘—æ‰‹å½¢åœ¨æº«æ³‰è¡—ä¸Šçš„éƒ¨åˆ†å•†åº—æ¶ˆè²»æˆ–ç”¨é¤ï¼Œå‡ºç¤ºå¯äº«æŠ˜æ‰£ã€‚</li>
                            <li><b>æ¨è–¦æ¹¯æ± ï¼š</b>é™¤äº†æ‚¨ä½å®¿çš„æ—…é¤¨å¤–ï¼Œæ¨è–¦é«”é©—ã€Œå±±æ¢…èŠ± (Yamamizuki)ã€çš„æºªæµéœ²å¤©é¢¨å‘‚ï¼Œæˆ–ã€Œæ–°æ˜é¤¨ã€çš„æ´çªŸé¢¨å‘‚ã€‚</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="info-section" style="margin-top: 15px;">
                <h3>ğŸŒ² æº«æ³‰è¡—å¿…åƒèˆ‡æ°›åœ</h3>
                <p style="font-size: 0.9rem; margin-bottom: 10px;">
                    é»‘å·å…¨æ‘ç‚ºäº†ç¶­è­·æ™¯è§€ï¼Œå»ºç¯‰çµ±ä¸€ä½¿ç”¨é»‘è‰²èˆ‡æœ¨è³ªèª¿ï¼Œæ²’æœ‰éœ“è™¹ç‡ˆï¼Œåªæœ‰æŸ”å’Œçš„ç‡ˆç± ï¼Œéå¸¸é©åˆç©¿è‘—æµ´è¡£æ‹ç…§ã€‚
                </p>
                <div class="price-table">
                    <div class="price-header" style="color: #78350F; border-color: #78350F;">å¿…åƒç”œé»</div>
                    <div class="price-header" style="color: #78350F; border-color: #78350F;">ç‰¹è‰²</div>
                    <div class="price-header" style="color: #78350F; border-color: #78350F;">ä½ç½®</div>

                    <div class="price-item"><b>Patisserie Roku</b></div>
                    <div class="price-item">è¶…äººæ°£ã€Œé¹½éº´æ³¡èŠ™ã€ï¼Œå¤–çš®é…¥è„†å…§é¤¡æ¿ƒéƒã€‚</div>
                    <div class="price-item">åœ°è—å ‚é™„è¿‘</div>

                    <div class="price-item"><b>ç™½ç‰å­ (ç™½ç‰ãƒƒå­)</b></div>
                    <div class="price-item">ç¾ç…®ç™½ç‰æ¹¯åœ“ï¼Œå£æ„ŸQå½ˆï¼Œæ­é…é»‘èœœé»ƒè±†ç²‰ã€‚</div>
                    <div class="price-item">å·ç«¯é€š</div>

                    <div class="price-item"><b>éŠ…é‘¼ç‡’ (Dora Dora)</b></div>
                    <div class="price-item">å¤¾è‘—å¸ƒä¸æˆ–å†°æ·‡æ·‹çš„å‰µæ„éŠ…é‘¼ç‡’ã€‚</div>
                    <div class="price-item">æº«æ³‰è¡—ä¸­å¿ƒ</div>
                </div>
                <a href="https://www.google.com/maps/search/?api=1&query=Patisserie+Roku+Kurokawa" target="_blank"
                    class="btn-link" style="background-color: #78350F;">å°èˆªè‡³ Patisserie Roku ğŸ°</a>
            </div>
        </div>

        <!-- æ–°å¢ï¼šDay 3/4 ç”±å¸ƒé™¢æ•£æ­¥æ”»ç•¥ -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">Day 3-4: ç”±å¸ƒé™¢ æ¹¯ä¹‹åªè¡—é“æ”»ç•¥</div>
                <div class="tag tag-spot">è¶…å¥½é€›</div>
            </div>

            <div class="info-section" style="background-color: #F0FDF4; border-color: #15803D;">
                <h3 style="color: #15803D; border-bottom-color: #15803D;">ğŸš¶ ç¶“å…¸æ•£æ­¥è·¯ç·š</h3>
                <p style="font-size: 0.95rem; color: #444;">
                    å¾ç”±å¸ƒé™¢è»Šç«™å‡ºä¾†ï¼Œæ²¿è‘—æ­£å‰æ–¹çš„é“è·¯ç›´èµ°ï¼Œé›–ç„¶æœƒçœ‹åˆ°å£¯è§€çš„ç”±å¸ƒå²³ï¼Œä½†ç²¾è¯å€å…¶å¯¦åœ¨å³å‰æ–¹çš„<b>ã€Œæ¹¯ä¹‹åªè¡—é“ã€</b>ã€‚
                </p>
                <div class="method-detail" style="margin-top: 10px;">
                    <p><b>å»ºè­°å‹•ç·šï¼š</b> è»Šç«™ â†’ B-speak (è›‹ç³•æ²) â†’ æ¹¯ä¹‹åªè¡—é“ (ä¸»æˆ°å ´) â†’ Floral Village (ç«¥è©±æ‘) â†’ é‡‘é±—æ¹–ã€‚</p>
                    <p style="margin-top:5px; font-size:0.85rem; color:#666;">*å…¨ç¨‹æ­¥è¡Œå–®è¶Ÿç´„ 20-30 åˆ†é˜ (ä¸å«é€›è¡—)ï¼Œæ²¿è·¯éå¸¸å¹³å¦å¥½èµ°ï¼Œé©åˆæ¨è»Šã€‚
                    </p>
                </div>
            </div>

            <div class="info-section" style="margin-top: 15px;">
                <h3>ğŸ° æ’éšŠç¾é£Ÿ & ç‰¹è‰²åº—é‹ª</h3>

                <div class="safari-method" style="margin-top: 10px;">
                    <span class="method-title" style="color: var(--primary);">B-speak è›‹ç³•æ² (P-roll)</span>
                    <div class="method-detail">
                        ç”±å¸ƒé™¢æœ€çŸ¥åçš„ç”œé»ï¼å£æ„Ÿè“¬é¬†è›‹é¦™æ¿ƒéƒã€‚
                        <br><span style="color: var(--danger); font-weight:bold;">âš ï¸ æ³¨æ„ï¼š</span> å°æ¢è£é€šå¸¸æ—©ä¸Š 10:30
                        å‰å°±æœƒè³£å…‰ã€‚è‹¥æƒ³è²·ï¼Œå»ºè­°ç¬¬ä¸€å¤©æŠµé”æ™‚å…ˆå»é è¨‚éš”å¤©å–è²¨ï¼Œæˆ–ä¸€æ—©å»æ’éšŠã€‚
                    </div>
                </div>

                <div class="safari-method" style="margin-top: 10px;">
                    <span class="method-title" style="color: var(--primary);">Milch (ãƒŸãƒ«ãƒ’) èµ·å¸æ¯</span>
                    <div class="method-detail">
                        å¿…åƒï¼æ¨è–¦é»<b>ã€Œç†±çš„ (Hot)ã€</b>èµ·å¸è›‹ç³•æ¯ï¼ŒåŠç†Ÿæµå¿ƒçš„å£æ„Ÿéå¸¸éŠ·é­‚ã€‚ä¹Ÿæœ‰å†·çš„å¯ä»¥é¸æ“‡ã€‚
                    </div>
                </div>

                <div class="safari-method" style="margin-top: 10px;">
                    <span class="method-title" style="color: var(--primary);">é‡‘è³å¯æ¨‚é¤… (é‡‘è³ã‚³ãƒ­ãƒƒã‚±)</span>
                    <div class="method-detail">
                        æ›¾ç²å…¨æ—¥æœ¬å¯æ¨‚é¤…å¤§è³½é‡‘è³ã€‚å¤–çš®é…¥è„†ï¼Œå…§é¤¡èª¿å‘³è¼ƒé‡ï¼Œé©åˆé‚Šèµ°é‚Šåƒã€‚
                    </div>
                </div>

                <div class="info-detail-box"
                    style="margin-top: 15px; border-color: #F472B6; background-color: #FFF1F2;">
                    <h4 style="color: #DB2777;">ğŸ„ Yufuin Floral Village (ç«¥è©±æ‘)</h4>
                    <p style="font-size: 0.9rem;">
                        ä»¿ç…§è‹±åœ‹ç§‘èŒ¨æ²ƒçˆ¾å¾· (Cotswolds) æ‰“é€ çš„é»ƒè‰²çŸ®æˆ¿èšè½ã€‚é€™è£¡æœ‰ï¼š
                    </p>
                    <ul style="padding-left: 20px; font-size: 0.9rem; margin-top: 5px;">
                        <li><b>Miffy éºµåŒ…åº—ï¼š</b>é€ å‹éºµåŒ…è¶…å¯æ„›ï¼ŒäºŒæ¨“æœ‰å’–å•¡å»³ã€‚</li>
                        <li><b>é¾è²“å•†åº— (ã©ã‚“ãã‚Šã®æ£®)ï¼š</b>å‰åœåŠ›ç²‰çµ²å¿…é€›ã€‚</li>
                        <li><b>å‹•ç‰©é¤µé£Ÿï¼š</b>åœ’å€å…§æœ‰é¤Šå±±ç¾Šã€å…”å­ç”šè‡³æ¾é¼ ï¼Œå°æœ‹å‹æœƒå¾ˆæ„›ã€‚</li>
                    </ul>
                </div>
                <a href="https://www.google.com/maps/search/?api=1&query=Yufuin+Floral+Village" target="_blank"
                    class="btn-link"
                    style="display: flex; align-items: center; justify-content: center; gap: 6px;">å°èˆªè‡³ç«¥è©±æ‘ <svg
                        class="icon-mini" style="color: white;">
                        <use href="#icon-loc"></use>
                    </svg></a>
            </div>
        </div>


        <!-- ä¹å·è‡ªç„¶å‹•ç‰©å…¬åœ’ æ”»ç•¥ -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">Day 3: ä¹å·è‡ªç„¶å‹•ç‰©å…¬åœ’ (æ”»ç•¥)</div>
                <div class="tag tag-tip">é‡é»è³‡è¨Š</div>
            </div>

            <!-- é–€ç¥¨è³‡è¨Š -->
            <div class="info-section" style="border-color: #F59E0B;">
                <h3 style="color: var(--secondary);">ğŸ’° é–€ç¥¨èˆ‡è²»ç”¨ (åƒè€ƒ)</h3>
                <div class="price-table">
                    <div class="price-header">é …ç›®</div>
                    <div class="price-header">æˆäºº</div>
                    <div class="price-header">4æ­²~ä¸­å­¸ç”Ÿ</div>

                    <div class="price-item">å…¥åœ’è²»</div>
                    <div class="price-item">Â¥2,600</div>
                    <div class="price-item">Â¥1,500</div>

                    <div class="price-item">å¢æ—å·´å£« (Jungle Bus)</div>
                    <div class="price-item">Â¥1,400</div>
                    <div class="price-item">Â¥1,200</div>

                    <div class="price-item" style="font-weight: 700;">è‡ªé§•è»Šå°è¦½æ”¶éŸ³æ©Ÿ</div>
                    <div class="price-item" colspan="2">Â¥600 (æ¯å°è»Š)</div>
                </div>
                <p class="detail" style="margin-top: 10px; font-size: 0.85rem; color: var(--danger);">
                    **è²»ç”¨ç¸½è¨ˆï¼š** è‹¥é¸æ“‡ã€Œå…¥åœ’ + å¢æ—å·´å£«ã€ï¼Œæ¯ä½æˆäººç´„ Â¥4,000ã€‚
                </p>
            </div>
            <div class="info-section" style="border-color: #F59E0B; background-color: #FFFBEB; margin-top: 15px;">
                <h3 style="color: var(--secondary); border-bottom-color: var(--secondary);">â° é–‹åœ’æ™‚é–“èˆ‡æ¶ç¥¨æ”»ç•¥</h3>

                <div class="method-detail">
                    <div style="margin-bottom: 12px;">
                        <span style="font-weight: 700; color: #1F2937; display: block; margin-bottom: 4px;">â„ï¸ å†¬å­£ (11æœˆ1æ—¥
                            ï½ 2æœˆåº•)</span>
                        <ul style="padding-left: 20px; margin: 0; font-size: 0.9rem; line-height: 1.6;">
                            <li><b>å”®ç¥¨é–‹å§‹ï¼š</b>09:30</li>
                            <li><b>æ­£å¼é–‹åœ’ï¼š</b>10:00</li>
                            <li><b>é–‰åœ’æ™‚é–“ï¼š</b>15:30 (æœ€å¾Œå…¥åœ’ 15:00)</li>
                        </ul>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <span style="font-weight: 700; color: #1F2937; display: block; margin-bottom: 4px;">â˜€ï¸ å¤å­£ (3æœˆ1æ—¥
                            ï½ 10æœˆ31æ—¥)</span>
                        <ul style="padding-left: 20px; margin: 0; font-size: 0.9rem; line-height: 1.6;">
                            <li><b>å”®ç¥¨é–‹å§‹ï¼š</b>09:00</li>
                            <li><b>æ­£å¼é–‹åœ’ï¼š</b>09:30</li>
                            <li><b>é–‰åœ’æ™‚é–“ï¼š</b>16:30 (æœ€å¾Œå…¥åœ’ 16:00)</li>
                        </ul>
                    </div>

                    <div
                        style="background: white; padding: 12px; border-radius: 8px; border: 1px dashed #D97706; margin-top: 10px;">
                        <span
                            style="color: #D97706; font-weight: 700; display: flex; align-items: center; gap: 5px; margin-bottom: 5px;">
                            <svg class="icon-mini" style="color:#D97706">
                                <use href="#icon-time"></use>
                            </svg>
                            Jungle Bus æ¶ç¥¨å»ºè­°
                        </span>
                        <p style="font-size: 0.9rem; line-height: 1.5; margin-bottom: 8px; font-weight: 500;">
                            å› å·´å£«åº§ä½æœ‰é™ä¸”éœ€ç•¶æ—¥ç¾å ´æ’éšŠè³¼ç¥¨ï¼Œå¼·çƒˆå»ºè­°ï¼š
                        </p>
                        <ul style="padding-left: 20px; margin: 0; font-size: 0.9rem; line-height: 1.6;">
                            <li><b>å¹³æ—¥ï¼š</b>å»ºè­° <b style="color: #DC2626;">09:00 å‰</b> (é–‹åœ’å‰ 30 åˆ†é˜) æŠµé”ã€‚</li>
                            <li><b>å‡æ—¥/é€£å‡ï¼š</b>å»ºè­° <b style="color: #DC2626;">08:30 å‰</b> (é–‹åœ’å‰ 1 å°æ™‚) æŠµé”ã€‚</li>
                        </ul>
                        <p
                            style="font-size: 0.85rem; color: #666; margin-top: 8px; border-top: 1px solid #eee; padding-top: 6px;">
                            ğŸ’¡ <b>ç‚ºä»€éº¼è¦é€™éº¼æ—©ï¼Ÿ</b><br>
                            æ—ºå­£æ™‚é–‹åœ’å‰é–€å£å¸¸æœ‰è‡ªé§•è»Šé™£æ’éšŠã€‚æ—©é»åˆ°æ˜¯ç‚ºäº†ç¢ºä¿èƒ½è²·åˆ°<b>ã€Œä¸Šåˆæ™‚æ®µã€</b>çš„å·´å£«ç¥¨ï¼Œä»¥å…è¡Œç¨‹è¢«æ‹–åˆ°ä¸‹åˆï¼Œå½±éŸ¿å¾ŒçºŒå‰å¾€ç”±å¸ƒé™¢çš„æ™‚é–“ã€‚
                        </p>
                    </div>
                </div>
            </div>
            <!-- å¢æ—å·´å£«é ç´„æ•™å­¸ -->
            <div class="info-section">
                <h3>ğŸšŒ å¢æ—å·´å£« (Jungle Bus) é ç´„æ•™å­¸</h3>

                <p style="font-size: 0.95rem; font-weight: 600;">
                    å¢æ—å·´å£«æ˜¯å¿…ç©é …ç›®ï¼å»ºè­°æ‚¨æå‰é ç´„ï¼Œä»¥ç¢ºä¿æœ‰ä½å­ï¼Œç‰¹åˆ¥æ˜¯é€±æœ«æˆ–å‡æœŸã€‚
                </p>
                <ol style="font-size: 0.9rem; margin-top: 10px; padding-left: 20px;">
                    <li>**ç·šä¸Šé ç´„ (æ¨è–¦)ï¼š** å®˜æ–¹ç¶²ç«™é€šå¸¸æœƒåœ¨å‡ºç™¼æ—¥æœŸçš„å‰ 1 å€‹æœˆå·¦å³é–‹æ”¾é ç´„ã€‚é¸æ“‡æ—¥æœŸèˆ‡æ™‚æ®µï¼Œç·šä¸Šä»˜è²»ã€‚</li>
                    <li>**ç•¶æ—¥ç¾å ´è³¼ç¥¨ï¼š** å¦‚æœç„¡æ³•ç·šä¸Šé è¨‚ï¼Œè«‹å‹™å¿…åœ¨**ä¸€é–‹åœ’æ™‚**ï¼ˆæˆ–é è¨ˆæŠµé”æ™‚ï¼‰ç«‹åˆ»å‰å¾€å”®ç¥¨è™•è³¼è²·ç•¶æ—¥çš„å ´æ¬¡ã€‚ç†±é–€æ™‚æ®µå®¹æ˜“å®¢æ»¿ã€‚</li>
                    <li>**é¸æ“‡æ™‚æ®µï¼š** å»ºè­°é¸æ“‡å‰›å…¥åœ’å¾Œçš„æ™‚æ®µï¼ˆç´„ 14:30-15:30ï¼‰ï¼Œä»¥å…è€½èª¤å¾ŒçºŒå‰å¾€ç”±å¸ƒé™¢çš„è¡Œç¨‹ã€‚</li>
                </ol>
            </div>


            <!-- æ··åˆé«”é©—å»ºè­° -->
            <div class="info-section" style="background-color: #FFFBEB; border-color: var(--secondary);">
                <h3 style="color: var(--secondary);">ğŸš— å¦‚ä½•å…¼é¡§è‡ªé§•èˆ‡å¢æ—å·´å£« (å®Œç¾é«”é©—è·¯ç·š)</h3>
                <p style="font-size: 0.95rem;">
                    æƒ³è¦å®Œæ•´é«”é©—å‹•ç‰©åœ’ï¼Œå»ºè­°å°‡è‡ªé§•è§€è³èˆ‡å·´å£«é¤µé£Ÿçµåˆï¼š
                </p>

                <div class="safari-method" style="border-color: var(--secondary);">
                    <span class="method-title" style="color: var(--secondary);">æ­¥é©Ÿä¸€ï¼šè‡ªé§•é«”é©— (å…è²»ï¼Œéœ€ç§Ÿå€Ÿå°è¦½æ©Ÿ)</span>
                    <div class="method-detail">
                        <p>
                            **å…ˆé–‹æ‚¨è‡ªå·±çš„ç§Ÿè³ƒè»Š**é€²å…¥ Safari Zone é€›ä¸€åœˆã€‚é€™æ¨£å¯ä»¥å¾å®¹åœ°ç”¨è‡ªå·±çš„é€Ÿåº¦è§€è³å‹•ç‰©ï¼Œä¸”è»Šå…§ç©ºé–“å¤§è¼ƒç‚ºèˆ’é©ã€‚
                        </p>
                        <p style="margin-top: 5px;">
                            **å„ªé»ï¼š** æ„Ÿå—å‹•ç‰©é è¿‘è»Šè¼›çš„éœ‡æ’¼æ„Ÿï¼Œä¸å—æ™‚é–“é™åˆ¶ã€‚
                        </p>
                    </div>
                </div>

                <div class="safari-method" style="margin-top: 15px; border-color: var(--danger);">
                    <span class="method-title recommended" style="color: var(--danger);">æ­¥é©ŸäºŒï¼šå¢æ—å·´å£« (é¤µé£Ÿé«”é©—ï¼Œéœ€é ç´„)</span>
                    <div class="method-detail">
                        <p>
                            **éš¨å¾Œå†æ­ä¹˜å¢æ—å·´å£«**ã€‚å·´å£«æœƒåœ¨è»Šä¸Šå®šé»åœè»Šï¼Œè®“å­©å­å€‘è¦ªæ‰‹å°‡é£¼æ–™å¾é˜²è­·ç¶²é¤µçµ¦å‹•ç‰©ã€‚é€™æ˜¯è‡ªé§•ç„¡æ³•å–ä»£çš„äº’å‹•æ¨‚è¶£ï¼
                        </p>
                        <p style="margin-top: 5px;">
                            **æ™‚ç¨‹å®‰æ’ï¼š** å»ºè­° 14:30 æŠµé”å¾Œï¼Œå…ˆå¿«é€Ÿè‡ªé§•ä¸€åœˆ (ç´„ 30-40 åˆ†é˜)ï¼Œå†æ¥è‘—æ­ä¹˜é ç´„å¥½çš„å·´å£«å ´æ¬¡ (ç´„ 50 åˆ†é˜)ã€‚
                        </p>
                    </div>
                </div>
            </div>

            <!-- è¦ªè¿‘å€å»ºè­° -->
            <div class="info-section" style="margin-top: 16px;">
                <h3>ğŸ• è¦ªè¿‘å€ (Fureai Zone) å»ºè­°</h3>
                <div class="method-detail">
                    <p>åƒè§€å®Œ Safari Zone å¾Œï¼Œè«‹å‹™å¿…åˆ°è¦ªè¿‘å€èµ°èµ°ã€‚é€™è£¡æœ‰**è¢‹é¼ ã€å¤©ç«ºé¼ **ç­‰å¯æ„›çš„å°å‹•ç‰©å¯ä»¥æ‘¸æ‘¸æŠ±æŠ±ï¼Œé‚„æœ‰**é¨é¦¬é«”é©—**ï¼ˆéœ€å¦å¤–ä»˜è²»ï¼‰ï¼Œéå¸¸é©åˆå°æœ‹å‹ç©æ¨‚ï¼Œé€šå¸¸æœƒèŠ±è²» 1-1.5
                        å°æ™‚ã€‚</p>
                    <a href="https://www.google.com/maps/search/?api=1&query=African+Safari+Oita" target="_blank"
                        class="btn-link">æŸ¥çœ‹å‹•ç‰©å…¬åœ’å®˜ç¶² (æœå°‹)</a>
                </div>
            </div>
        </div>

        <!-- ç¦å²¡éºµåŒ…è¶…äººå…’ç«¥åšç‰©é¤¨ æ”»ç•¥ -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">ç¦å²¡éºµåŒ…è¶…äººå…’ç«¥åšç‰©é¤¨ (æ”»ç•¥)</div>
                <div class="tag tag-kids">è¦ªå­å‚™æ¡ˆ</div>
            </div>
            <div class="info-section" style="border-color: #F472B6;">
                <h3 style="color: #DB2777; border-bottom-color: #F472B6;">ğŸ éºµåŒ…è¶…äººåšç‰©é¤¨é‡é»</h3>
                <div class="method-detail">
                    <p>é€™æ˜¯ä¸€å€‹å°ˆç‚ºå­¸é½¡å‰å…’ç«¥è¨­è¨ˆçš„å¤¢å¹»æ¨‚åœ’ï¼Œä½æ–¼å¸‚ä¸­å¿ƒï¼Œäº¤é€šæ¥µåº¦ä¾¿åˆ©ï¼ˆåœ°éµç›´çµï¼‰ã€‚</p>
                    <ul style="list-style-type: disc; margin-top: 10px; padding-left: 20px;">
                        <li><b>ä½ç½®ï¼š</b>åšå¤šæ²³ç•”åŸ (Hakata Riverain Mall) 5F/6Fã€‚</li>
                        <li><b>äº¤é€šï¼š</b>åœ°éµç©ºæ¸¯ç·š/ç®±å´ç·šã€Œä¸­æ´²å·ç«¯ç«™ã€6è™Ÿå‡ºå£ç›´é”ã€‚</li>
                        <li><b>é–€ç¥¨ï¼š</b>1æ­²ä»¥ä¸Šçµ±ä¸€ç¥¨åƒ¹ (ç´„ 2,000-2,200å††)ï¼Œ1æ­²ä»¥ä¸‹å…è²»ã€‚</li>
                    </ul>
                </div>

                <div class="safari-method" style="margin-top: 15px; border-color: #F472B6;">
                    <span class="method-title" style="color: #DB2777;">å¿…ç©äº®é»</span>
                    <div class="method-detail">
                        <ul style="padding-left: 20px;">
                            <li><b>éºµåŒ…è¶…äººè¡¨æ¼”ç§€ï¼š</b>æ¯å¤©æœ‰å›ºå®šå ´æ¬¡ï¼Œè§’è‰²æœƒå‡ºä¾†è·³èˆäº’å‹•ã€‚</li>
                            <li><b>æœé†¬çˆºçˆºçš„éºµåŒ…å·¥å» ï¼š</b>å¿…è²·ï¼é‚„åŸåº¦è¶…é«˜çš„é€ å‹éºµåŒ…ï¼Œé›–ç„¶åƒ¹æ ¼ç¨é«˜ä½†éå¸¸å¯æ„›ã€‚</li>
                            <li><b>ç”Ÿæ—¥æœå‹™ï¼š</b>è‹¥å­©å­ç•¶æœˆç”Ÿæ—¥ï¼Œå¯ç²å¾—ç”Ÿæ—¥è²¼ç´™å’Œçš‡å†  (éœ€å‘å·¥ä½œäººå“¡è©¢å•)ã€‚</li>
                        </ul>
                    </div>
                </div>
                <p class="detail" style="margin-top: 10px; font-size: 0.85rem; color: var(--danger);">
                    **æ³¨æ„ï¼š** é¤¨å…§é€šå¸¸ç¦æ­¢é£²é£Ÿï¼ˆå¬°å…’å‰¯é£Ÿå“é™¤å¤–ï¼‰ï¼Œä¸”å¬°å…’è»Šéœ€å¯„æ”¾åœ¨å…¥å£è™•ã€‚
                </p>
            </div>
        </div>

        <!-- ä¼´æ‰‹ç¦®æ”»ç•¥ -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">ğŸ ç¦å²¡ & ç†Šæœ¬ å¿…è²·ä¼´æ‰‹ç¦®æ¸…å–®</div>
                <div class="tag tag-shop">è³¼ç‰©</div>
            </div>

            <div class="info-section" style="border-color: #F87171;">
                <h3 style="color: #DC2626; border-bottom-color: #F87171;">ğŸ“ ç¦å²¡ (åšå¤šç«™/æ©Ÿå ´)</h3>
                <div class="method-detail">
                    <ul style="padding-left: 20px; line-height: 1.6;">
                        <li><b>åšå¤šé€šã‚Šã‚‚ã‚“ (åšå¤šé€šé¥…é ­)ï¼š</b>ç¦å²¡No.1ä¼´æ‰‹ç¦®ï¼Œå……æ»¿å¥¶é¦™çš„ç™½è±†æ²™é¥…é ­ï¼Œå¿…è²·ï¼</li>
                        <li><b>Menbei (æ˜å¤ªä»™è²)ï¼š</b>ç¦å¤ªéƒæ¨å‡ºçš„æ˜å¤ªå­ä»™è²ï¼Œé¹¹é¦™é…¥è„†ï¼Œé©åˆç•¶ä¸‹é…’èœã€‚</li>
                        <li><b>åŠªåŠªé› (å†·ç‚¸é›)ï¼š</b>å£æ„Ÿç¨ç‰¹çš„å†°æ¶¼ç‚¸é›ï¼Œé©åˆåœ¨é£¯åº—äº«ç”¨æˆ–æœ€å¾Œä¸€å¤©å¸¶å› (éœ€ä¿å†·)ã€‚</li>
                        <li><b>ç­‘ç´«éº»ç³¬ (ç­‘ç´«ã‚‚ã¡)ï¼š</b>æ·‹ä¸Šé»‘ç³–èœœçš„é»ƒè±†ç²‰éº»ç³¬ï¼Œå£æ„Ÿç²¾ç·»ã€‚</li>
                        <li><b>Tubu Tube æ˜å¤ªå­é†¬ï¼š</b>ç®¡ç‹€åŒ…è£çš„æ˜å¤ªå­ï¼Œæ–¹ä¾¿æ–™ç†æˆ–å¡—æŠ¹éºµåŒ…ã€‚</li>
                    </ul>
                </div>
            </div>

            <div class="info-section kumamoto">
                <h3 style="color: var(--kumamoto-info-text); border-bottom-color: #90CDF4;">ğŸ» ç†Šæœ¬ (ç†Šæœ¬ç«™/åŸå½©è‹‘)</h3>
                <div class="method-detail">
                    <ul style="padding-left: 20px; line-height: 1.6;">
                        <li><b>è­½ä¹‹é™£å¤ªé¼“ (èª‰ã®é™£å¤ªé¼“)ï¼š</b>ç´…è±†ç¾Šç¾¹åŒ…è¦†æ±‚è‚¥(éº»ç³¬)çš„ç¶“å…¸ç”œé»ï¼ŒåŒ…è£ç²¾ç¾ã€‚</li>
                        <li><b>é»‘ç³–å¤šç´èŒ²æ£’ï¼š</b>å¤–é…¥å…§è»Ÿçš„é»‘ç³–æ¢ç‹€ç”œç”œåœˆï¼Œé…ç‰›å¥¶è¶…æ­ã€‚</li>
                        <li><b>æ­¦è€…è¿” (æ­¦è€…ãŒãˆã—)ï¼š</b>ä»¥ç†Šæœ¬åŸçŸ³ç‰†å‘½åçš„ç´…è±†é…¥çš®é»å¿ƒã€‚</li>
                        <li><b>ç†Šæœ¬ç†Š (Kumamon) å‘¨é‚Šï¼š</b>ç†Šæœ¬é™å®šçš„éƒ¨é•·å•†å“ï¼Œåœ¨ç†Šæœ¬ç«™æˆ–æ©Ÿå ´éƒ½è²·å¾—åˆ°ã€‚</li>
                    </ul>
                </div>
            </div>

        </div>
        <div class="card">
            <div class="card-header">
                <div class="card-title">âš ï¸ é‡è¦æ³•è¦ï¼šé€€ç¨…èˆ‡é£›å®‰ (2026)</div>
                <div class="tag tag-tip">å¿…è®€</div>
            </div>

            <div class="info-section" style="border-color: #FBBF24; background-color: #FFFBEB;">
                <h3 style="color: #B45309; border-bottom-color: #FBBF24; display: flex; align-items: center; gap: 8px;">
                    <svg style="width:24px;height:24px;flex-shrink:0;" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="11" fill="white" stroke="#E5E7EB" stroke-width="1" />
                        <circle cx="12" cy="12" r="6" fill="#BC002D" />
                    </svg>
                    æ—¥æœ¬é€€ç¨…è¦å®š (Tax Free)
                </h3>
                <div class="method-detail">
                    <p>2026å¹´æ—¥æœ¬æŒçºŒæ¨å‹•é›»å­åŒ–é€€ç¨…ï¼Œå»ºè­°äº‹å…ˆæ–¼ <b>Visit Japan Web</b> ç™»éŒ„è­·ç…§è³‡è¨Šä»¥ç”¢ç”Ÿå…ç¨… QR Codeã€‚</p>
                    <ul style="list-style-type: disc; margin-top: 10px; padding-left: 20px;">
                        <li><b>å…ç¨…é–€æª»ï¼š</b>åŒä¸€å¤©ã€åŒä¸€åº—å®¶æ¶ˆè²»æ»¿ <b>5,000æ—¥åœ“ (æœªç¨…)</b> ä»¥ä¸Šã€‚</li>
                        <li><b>æ†‘è­‰è¦æ±‚ï¼š</b>çµå¸³æ™‚éœ€å‡ºç¤º<b>è­·ç…§æ­£æœ¬</b> (æˆ–æ˜¯ Visit Japan Web çš„å…ç¨… QR Code)ã€‚</li>
                        <li><b>ç‰¹æ®ŠåŒ…è£ï¼š</b>æ¶ˆè€—å“ (è—¥å¦ã€é›¶é£Ÿã€æ¶²é«”) æœƒè¢«è£å…¥<b>ã€Œç´…è‰²å¯†å°è¢‹ã€</b>ã€‚åœ¨æ—¥æœ¬å¢ƒå…§<b>åš´ç¦æ‹†å°</b>ï¼Œè‹¥è¢«æµ·é—œæŸ¥ç²æ‹†å°ï¼Œéœ€è£œç¹³ 10% æ¶ˆè²»ç¨…ã€‚</li>
                        <li style="margin-top:5px; color:#DC2626; font-size:0.85rem;">
                            *è¨»ï¼šæ—¥æœ¬æ”¿åºœç ”æ“¬æœªä¾†æ”¹ç‚ºã€Œæ©Ÿå ´é€€ç¨…åˆ¶ã€(å…ˆå«ç¨…è³¼è²·ï¼Œæ©Ÿå ´å†é€€ç¨…)ï¼Œè‹¥ç¾å ´è¦å®šæœ‰è®Šï¼Œè«‹ä¾åº—å“¡æŒ‡ç¤ºç‚ºæº–ã€‚</li>
                    </ul>
                </div>
            </div>

            <div class="info-section" style="margin-top: 15px; border-color: #EF4444; background-color: #FEF2F2;">
                <h3 style="color: #B91C1C; border-bottom-color: #EF4444;">ğŸ”‹ è¡Œå‹•é›»æº & é›»æ± æ”œå¸¶è¦å®š</h3>
                <div class="method-detail">
                    <p style="font-weight: 700; color: #DC2626; margin-bottom: 8px;">åš´æ ¼ç¦æ­¢è¨—é‹ï¼è«‹å‹™å¿…æ”¾åœ¨ã€Œæ‰‹æè¡Œæã€éš¨èº«ç™»æ©Ÿã€‚</p>
                    <div style="background:white; padding:10px; border-radius:8px; border:1px solid #FECACA;">
                        <div style="font-weight:600; color:#991B1B; margin-bottom:4px;">å®¹é‡é™åˆ¶ (Wh)ï¼š</div>
                        <ul style="list-style-type: circle; padding-left: 20px; font-size: 0.9rem;">
                            <li><b>&lt; 100Whï¼š</b>å¯è‡ªç”±æ”œå¸¶ (æ•¸é‡åˆç†ï¼Œé€šå¸¸é™20é¡†å…§)ã€‚</li>
                            <li><b>100Wh ~ 160Whï¼š</b>éœ€ç¶“èˆªç©ºå…¬å¸æ‰¹å‡† (é€šå¸¸æ¯äººé™å¸¶ 2 é¡†)ã€‚</li>
                            <li><b>&gt; 160Whï¼š</b>ç¦æ­¢æ”œå¸¶ã€‚</li>
                        </ul>
                        <div style="margin-top:8px; font-size:0.85rem; color:#666;">
                            *å¸¸è¦‹ 10000mAh è¡Œå‹•é›»æºç´„ç‚º 37Wh (å¯æ”œå¸¶)ã€‚<br>
                            *è‹¥æ©Ÿèº«<b>ã€Œç“¦æ•¸æ¨™ç¤ºä¸æ¸…ã€</b>æˆ–ç£¨æç„¡æ³•è¾¨è­˜ï¼Œå®‰æª¢æœ‰æ¬Šæ²’æ”¶ï¼Œè«‹å‹™å¿…æª¢æŸ¥æ©Ÿèº«æ¨™ç±¤ã€‚
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 5: AI åŠ©æ‰‹ -->
    <div id="view-ai" class="container">
        <!-- ... existing AI Tab content ... -->
        <div class="card"
            style="height: calc(100vh - 140px); min-height: 500px; display: flex; flex-direction: column;">
            <div class="ai-header" id="ai-modal-title">
                <!-- ä¿®æ­£ 1: æ¨™é¡Œ Sparkles æ›æˆ SVG -->
                <svg class="icon-mini" style="width: 24px; height: 24px; color: #F59E0B;" viewBox="0 0 24 24">
                    <path
                        d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z">
                    </path>
                </svg>
                <span>éš¨èº« AI ç¿»è­¯èˆ‡åŠ©æ‰‹</span>
            </div>
            <div style="text-align: right; margin-bottom: 5px; padding-right: 5px;">
                <button onclick="resetAppPassword()"
                    style="border: none; background: none; color: #EF4444; font-size: 0.85rem; cursor: pointer; text-decoration: underline; display: inline-flex; align-items: center;">
                    <svg
                        style="width: 14px; height: 14px; margin-right: 4px; fill:none; stroke:currentColor; stroke-width:2;">
                        <use href="#icon-reset"></use>
                    </svg>
                    é‡è¨­é‡‘é‘°å¯†ç¢¼
                </button>
            </div>
            <div class="chat-history" id="chat-history">
                <!-- Welcome Message Bubble (Injected by JS) -->
            </div>

            <div class="ai-input-group" id="ai-input-area" style="display: block; margin-top: auto;">
                <div class="ai-input-wrapper">
                    <input type="text" class="ai-input" id="ai-user-input" placeholder="è«‹è¼¸å…¥å…§å®¹..."
                        onkeypress="handleEnter(event)">

                    <!-- æ–°å¢ï¼šèªéŸ³è¾¨è­˜èªè¨€åˆ‡æ›é–‹é—œ -->
                    <div class="voice-lang-switch">
                        <span
                            style="font-weight:600; color:#9CA3AF; font-size:0.75rem; display: flex; align-items: center; gap: 4px;">
                            <svg class="icon-mini" style="width: 14px; height: 14px;" viewBox="0 0 24 24">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                <line x1="12" y1="19" x2="12" y2="23"></line>
                                <line x1="8" y1="23" x2="16" y2="23"></line>
                            </svg>
                            èª°åœ¨èªªè©±:
                        </span>

                        <!-- é¸é … 1: å°ç£ (ä¸­æ–‡) - åœ“å½¢ç°¡ç´„ç‰ˆ -->
                        <label class="lang-option" title="æˆ‘ (èªªä¸­æ–‡)">
                            <input type="radio" name="voice_lang" value="zh-TW" checked onchange="updatePlaceholder()">
                            <!-- Simplified Taiwan Circle Flag -->
                            <svg class="flag-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <mask id="maskTW">
                                    <circle cx="12" cy="12" r="12" fill="white" />
                                </mask>
                                <g mask="url(#maskTW)">
                                    <rect width="24" height="24" fill="#FE0000" />
                                    <rect width="12" height="12" fill="#000095" />
                                    <!-- ç°¡åŒ–çš„é’å¤©ç™½æ—¥ (åŒå¿ƒåœ“é¢¨æ ¼) -->
                                    <circle cx="6" cy="6" r="3.5" fill="white" />
                                    <circle cx="6" cy="6" r="2.5" fill="#000095" />
                                    <circle cx="6" cy="6" r="1.5" fill="white" />
                                </g>
                            </svg>
                        </label>

                        <!-- é¸é … 2: æ—¥æœ¬ (æ—¥æ–‡) - åœ“å½¢ç°¡ç´„ç‰ˆ -->
                        <label class="lang-option" title="åº—å“¡ (èªªæ—¥æ–‡)">
                            <input type="radio" name="voice_lang" value="ja-JP" onchange="updatePlaceholder()">
                            <!-- Simplified Japan Circle Flag -->
                            <svg class="flag-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="11.5" fill="white" stroke="#E5E7EB" />
                                <circle cx="12" cy="12" r="5" fill="#BC002D" />
                            </svg>
                        </label>
                    </div>

                    <div class="ai-actions-row">
                        <button class="btn-mode consult" onclick="sendToGemini('consult')">
                            <svg class="icon-sprite">
                                <use href="#icon-consult"></use>
                            </svg>
                            è¡Œç¨‹è«®è©¢
                        </button>
                        <button class="btn-mode trans" onclick="sendToGemini('translate')">
                            <svg class="icon-sprite">
                                <use href="#icon-trans"></use>
                            </svg>
                            ä¸­/æ—¥ç¿»è­¯
                        </button>
                        <button class="btn-mode voice" id="btn-voice-ja">
                            <svg class="icon-sprite">
                                <use href="#icon-voice"></use>
                            </svg>
                            èªéŸ³è¼¸å…¥
                        </button>
                        <button class="btn-mode camera" onclick="document.getElementById('img-upload-input').click()">
                            <svg class="icon-sprite">
                                <use href="#icon-camera"></use>
                            </svg>
                            æ‹ç…§è¾¨è­˜
                        </button>
                        <input type="file" id="img-upload-input" accept="image/*" onchange="handleImageSelect(event)"
                            style="display: none;">

                    </div>
                </div>
            </div>

            <button id="btn-back-trans" class="btn-ai-reset" onclick="showAiTranslatorMode()">
                â†©ï¸ è¿”å›ä¸€èˆ¬æ¨¡å¼
            </button>
        </div>
    </div>

    <!-- TAB 6: æ—…ç¨‹è¨˜éŒ„ (New) -->
    <div id="view-ledger" class="container">
        <div class="card" style="margin-bottom: 12px; background: #5A92E8; color: white;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px;">
                <div id="ledger-header-info">
                    <div style="font-size: 0.8rem; opacity: 0.9;" id="ledger-view-title">å…¬è²»ç¸½æ”¯å‡º (JPY)</div>
                    <div id="ledger-total-amount" style="font-size: 1.5rem; font-weight: 700;">Â¥ 0</div>
                </div>

                <div style="display: flex; gap: 8px;">
                    <button onclick="filterLedgerView('finance')" class="btn-icon-circle" id="btn-view-finance">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"></path>
                            <path d="M12 18V6"></path>
                        </svg>
                    </button>
                    <button onclick="filterLedgerView('note')" class="btn-icon-circle" id="btn-view-note"
                        style="opacity: 0.6;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                        </svg>
                    </button>
                    <button onclick="syncLedgerData()" class="btn-icon-circle">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path
                                d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="card" id="ledger-input-card" style="margin-bottom: 15px;">
            <div class="card-content" style="padding: 12px;">
                <!-- [æ–°å¢] ä½¿ç”¨è€…ç‹€æ…‹é¡¯ç¤º (é»æ“Šå¯åˆ‡æ›èº«åˆ†) -->
                <div id="user-status-display" class="user-status-card" onclick="showLogoutPopup()">
                    <div class="user-info-left">
                        <div id="display-current-avatar" class="current-avatar">ğŸ‘¤</div>
                        <div class="current-user-text">
                            <span class="current-user-label">ç›®å‰è¨˜éŒ„èº«åˆ†</span>
                            <div style="display: flex; align-items: baseline; gap: 8px;">
                                <span id="display-current-name" class="current-user-name">è«‹ç™»å…¥</span>
                                <span id="user-private-total"
                                    style="color: #2563EB; font-weight: bold; font-size: 0.9rem;"></span>
                            </div>
                        </div>
                    </div>
                    <div class="btn-switch-user">åˆ‡æ›</div>
                    <!-- éš±è—æ¬„ä½ï¼Œç¢ºä¿ç›¸å®¹èˆŠæœ‰çš„ handleLedgerSubmit -->
                    <input type="hidden" id="custom-user-name" value="">
                    <input type="hidden" id="selected-user-info" value="">
                </div>

                <div id="ledger-finance-fields">
                    <!-- [æ–°å¢] Row 1: æ—¥æœŸèˆ‡ä»˜æ¬¾æ–¹å¼ (åˆ†ç‚ºå…©åˆ—ï¼Œå«æ¨™ç±¤ï¼Œå°é½Šä¸‹æ–¹è¼¸å…¥æ¡†) -->
                    <div style="margin-bottom: 8px; margin-right: 50px;">
                        <!-- Line 1: Date -->
                        <div style="display: flex; gap: 6px; margin-bottom: 8px; align-items: center;">
                            <label style="font-size: 0.85rem; color: #666; width: 36px; text-align: center;">æ—¥æœŸ</label>
                            <input type="date" id="ledger-date"
                                style="flex: 1; min-width: 0; height: 38px; padding: 2px 4px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; -webkit-appearance: none; appearance: none; background: #fff; color: #4B5563; font-size: 0.85rem; text-align: center;">
                        </div>
                        <!-- Line 2: Payment -->
                        <div style="display: flex; gap: 6px; align-items: center;">
                            <label style="font-size: 0.85rem; color: #666; width: 36px; text-align: center;">ä»˜æ¬¾</label>
                            <select id="ledger-payment-method"
                                style="flex: 1; min-width: 0; height: 38px; padding: 2px 4px; border: 1px solid #ddd; border-radius: 8px; background: white; color: #4B5563; font-size: 0.85rem;">
                                <option value="cash" selected>ğŸ’µ ç¾é‡‘</option>
                                <option value="card">ğŸ’³ åˆ·å¡</option>
                                <option value="ic">ğŸ§ ICå¡</option>
                                <option value="pay">ğŸ“± Pay</option>
                            </select>
                            <label style="font-size: 0.85rem; color: #666; margin: 0 4px;">æ”¯ä»˜</label>
                            <select id="ledger-pay-type"
                                style="flex: 1; min-width: 0; height: 38px; padding: 2px 4px; border: 1px solid #ddd; border-radius: 8px; background: white; color: #4B5563; font-size: 0.85rem;">
                                <option value="public" selected>å…¬è²»</option>
                                <option value="private">å€‹äºº</option>
                            </select>
                        </div>
                    </div>

                    <!-- Row 2: å“é …èˆ‡é‡‘é¡ -->
                    <div style="display: flex; gap: 6px; align-items: center;">
                        <!-- [æ–°å¢] æƒææŒ‰éˆ• (è—è‰²ç„¡æ¡†ç·š) -->
                        <button onclick="document.getElementById('bill-scan-input').click()"
                            style="width: 36px; height: 36px; padding: 0; border: none; background: transparent; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #2563EB;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 7V5a2 2 0 0 1 2-2h2"></path>
                                <path d="M17 3h2a2 2 0 0 1 2 2v2"></path>
                                <path d="M21 17v2a2 2 0 0 1-2 2h-2"></path>
                                <path d="M7 21H5a2 2 0 0 1-2-2v-2"></path>
                                <rect x="7" y="7" width="10" height="10" rx="1"></rect>
                                <line x1="12" y1="10" x2="12" y2="14"></line>
                                <line x1="10" y1="12" x2="14" y2="12"></line>
                            </svg>
                        </button>
                        <input type="file" id="bill-scan-input" accept="image/*" capture="environment"
                            onchange="handleBillFileChange(event)" style="display: none;">

                        <input type="text" id="ledger-item" placeholder="é …ç›®å…§å®¹..."
                            style="flex: 1.5; min-width: 0; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        <input type="number" id="ledger-amount" placeholder="é‡‘é¡" inputmode="decimal"
                            style="flex: 1; min-width: 0; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        <button onclick="handleLedgerSubmit()" class="btn-submit-ghost btn-submit-ledger"
                            style="width: 44px; height: 42px; margin: 0; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 8px; flex-shrink: 0;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                        <!-- [æ–°å¢] æ”¾æ£„è®Šæ›´æŒ‰éˆ• (Finance) ç¸®å° (26->22) -->
                        <button id="btn-cancel-edit-finance" onclick="exitEditMode()" class="btn-cancel-edit"
                            style="display: none; width: 22px; height: 22px; margin: 0; padding: 0; align-items: center; justify-content: center; border-radius: 50%; border: none; background: #EF4444; flex-shrink: 0; cursor: pointer;">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"
                                stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                </div>

                <div id="ledger-note-fields" style="display: none;">
                    <div style="display: flex; gap: 8px; align-items: flex-end;">
                        <!-- Left Column: Date + Note -->
                        <div style="flex: 1; display: flex; flex-direction: column; min-width: 0;">
                            <!-- Date Input (Compact: 32px) -->
                            <input type="date" id="ledger-note-date"
                                style="display: block; width: 100%; height: 32px; margin: 0 0 6px 0; padding: 4px 8px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem; color: #4B5563; background: #fff; box-sizing: border-box; -webkit-appearance: none; appearance: none;">

                            <!-- Note Textarea Box (Adjusted Height) -->
                            <div
                                style="display: flex; flex-direction: column; width: 100%; margin: 0; border: 1px solid #ddd; border-radius: 8px; padding: 6px; background: white; box-sizing: border-box;">
                                <textarea id="ledger-note-content" placeholder="å¯«ä¸‹æ—…ç¨‹é»æ»´..."
                                    style="width: 100%; height: 60px; padding: 2px; border: none; outline: none; resize: none; font-size: 0.95rem; line-height: 1.4;"></textarea>

                                <!-- åœ–ç‰‡é è¦½æ°´å¹³æ²è»¸ (ç§»å…¥è¼¸å…¥æ¡†å…§) -->
                                <div id="note-image-preview" class="horizontal-scroll-container"
                                    style="display: none; margin-top: 6px; border-top: 1px dashed #eee; padding-top: 6px;">
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Buttons -->
                        <div style="display: flex; align-items: flex-end; gap: 8px; padding-bottom: 0;">

                            <!-- Column: Image + Submit -->
                            <div
                                style="display: flex; flex-direction: column; align-items: center; justify-content: flex-end; gap: 4px;">
                                <!-- Image Button (Compact Height ~28px) -->
                                <button onclick="document.getElementById('multi-img-input').click()"
                                    style="width: 44px; height: 28px; margin: 0; padding: 0; display: flex; align-items: center; justify-content: center; border: none; background: transparent; cursor: pointer;">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2563EB"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                        <polyline points="21 15 16 10 5 21"></polyline>
                                    </svg>
                                </button>
                                <!-- Submit Button -->
                                <button onclick="handleLedgerSubmit()" class="btn-submit-ghost btn-submit-ledger"
                                    style="width: 44px; height: 44px; margin: 0; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 8px; border: 1px solid #E5E7EB; flex-shrink: 0; background: transparent;">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2563EB"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="22" y1="2" x2="11" y2="13"></line>
                                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                    </svg>
                                </button>
                            </div>

                            <!-- Cancel Button (Outside the column, aligned to bottom right) -->
                            <button id="btn-cancel-edit-note" onclick="exitEditMode()" class="btn-cancel-edit"
                                style="display: none; width: 22px; height: 22px; margin: 0 0 9px 0; padding: 0; align-items: center; justify-content: center; border-radius: 50%; border: none; background: #EF4444; flex-shrink: 0; cursor: pointer;">
                                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white"
                                    stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>

                            <!-- Hidden Input -->
                            <input type="file" id="multi-img-input" multiple accept="image/*" style="display: none;"
                                onchange="handleMultiImageSelect(event)">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="ledger-list" style="margin-bottom: 80px;"></div>
    </div>

    <!-- è‡ªå®šç¾©å½ˆå‡ºè¦–çª— HTML -->
    <div id="location-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">æ‰‹å‹•è¨­å®šä½ç½®</div>
            <div class="modal-desc" id="modal-msg">ç„¡æ³•å–å¾— GPS å®šä½ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æ‚¨æ‰€åœ¨çš„åŸå¸‚ä»¥é€²è¡Œæº«å·®æ¯”å°ã€‚</div>
            <input type="text" id="modal-city-input" class="modal-input" placeholder="ä¾‹å¦‚: å°åŒ—, Taichung" value="å°åŒ—">
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn btn-confirm" onclick="submitManualLocation()">ç¢ºå®š</button>
            </div>
        </div>
    </div>
    <div id="note-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 350px; text-align: left; position: relative;">

            <div
                style="position: absolute; top: 5px; right: 5px; display: flex; align-items: center; gap: 4px; z-index: 20;">

                <button class="btn-modal-close-x" style="position: static;"
                    onclick="document.getElementById('note-img-input').click()" title="æ’å…¥ç…§ç‰‡">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" style="width: 20px; height: 20px;">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                </button>

                <button class="btn-modal-close-x" style="position: static;" onclick="closeNoteModal()" title="é—œé–‰">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" style="width: 20px; height: 20px;">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="modal-title"
                style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px; padding-right: 80px;">
                <span style="display:flex; align-items:center; gap:6px;">
                    <svg class="icon-mini" style="color:#2563EB;" viewBox="0 0 24 24">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    éš¨èº«åœ–æ–‡ç­†è¨˜
                </span>
                <span id="note-status" style="font-size:0.75rem; color:#10B981; font-weight:normal;"></span>
            </div>

            <input type="file" id="note-img-input" accept="image/*" style="display:none;"
                onchange="insertNoteImage(event)">

            <div id="note-area" class="note-editable-box" contenteditable="true" placeholder="åœ¨é€™è£¡è¨˜ä¸‹åœè»Šä½è™Ÿç¢¼ã€ç…§ç‰‡..."></div>

        </div>
    </div>
    <div id="calc-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 340px; padding: 25px 20px 20px 20px; position: relative;">

            <button class="btn-modal-close-x" onclick="closeCalcModal()">Ã—</button>

            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom:10px; border-bottom:1px solid #eee; margin-right: 30px;">
                <button id="btn-swap-cur" onclick="toggleCurrency()"
                    style="background:#EFF6FF; border:1px solid #BFDBFE; border-radius:20px; padding:5px 12px; font-size:0.85rem; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:5px;">
                    <span id="cur-label-main" style="color:#2563EB">JPY</span>
                    <svg style="width:16px;height:16px; color:#6B7280;" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 17H4M4 17L8 13M4 17L8 21M4 7H20M20 7L16 3M20 7L16 11" />
                    </svg>
                    <span id="cur-label-sub" style="color:#059669">TWD</span>
                </button>

                <div style="display: flex; align-items: center; gap: 5px; font-size: 0.85rem; color: #666;">
                    <label>åŒ¯ç‡:</label>
                    <input type="number" id="calc-rate" step="0.001"
                        style="width: 65px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-weight:bold; color:#D97706;"
                        oninput="reCalcTotal()">
                </div>
            </div>

            <div class="calc-display">
                <div class="calc-expr" id="calc-expr-display"></div>
                <div class="calc-main" id="calc-main-display">Â¥0</div>
                <div class="calc-sub" id="calc-sub-display">â‰ˆ NT$0</div>
            </div>

            <div class="calc-keypad">
                <button class="calc-btn ac" onclick="calcInput('AC')">AC</button>
                <button class="calc-btn op" onclick="calcInput('DEL')">âŒ«</button>
                <button class="calc-btn op" onclick="calcInput('/')">Ã·</button>
                <button class="calc-btn op" onclick="calcInput('*')">Ã—</button>

                <button class="calc-btn" onclick="calcInput('7')">7</button>
                <button class="calc-btn" onclick="calcInput('8')">8</button>
                <button class="calc-btn" onclick="calcInput('9')">9</button>
                <button class="calc-btn op" onclick="calcInput('-')">-</button>

                <button class="calc-btn" onclick="calcInput('4')">4</button>
                <button class="calc-btn" onclick="calcInput('5')">5</button>
                <button class="calc-btn" onclick="calcInput('6')">6</button>
                <button class="calc-btn op" onclick="calcInput('+')">+</button>

                <button class="calc-btn" onclick="calcInput('1')">1</button>
                <button class="calc-btn" onclick="calcInput('2')">2</button>
                <button class="calc-btn" onclick="calcInput('3')">3</button>

                <button class="calc-btn eq" onclick="calcInput('=')">=</button>

                <button class="calc-btn zero" onclick="calcInput('0')">0</button>
                <button class="calc-btn" onclick="calcInput('.')">.</button>

            </div>
        </div>
    </div>
    <div id="img-preview-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">ç¢ºèªåœ–ç‰‡</div>
            <div
                style="background:#F3F4F6; padding:10px; border-radius:8px; margin-bottom:15px; display:flex; justify-content:center;">
                <img id="img-preview-content"
                    style="max-width:100%; max-height:300px; border-radius:4px; object-fit:contain;">
            </div>
            <div class="modal-desc" style="font-size:0.85rem; color:#666; margin-bottom:15px;">
                ç¢ºèªè¦å‚³é€é€™å¼µåœ–ç‰‡çµ¦ AI é€²è¡Œåˆ†æå—ï¼Ÿ
            </div>
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="cancelImagePreview()">å–æ¶ˆ</button>
                <button class="modal-btn btn-confirm" onclick="confirmImageAnalysis()">é–‹å§‹è¾¨è­˜</button>
            </div>
        </div>
    </div>
    <!-- Bottom Navigation Bar (6 items now) -->

    <nav class="nav-bar">
        <div class="nav-item active" data-target="view-schedule" onclick="switchTab(this)">
            <span class="nav-icon">
                <svg class="icon-sprite">
                    <use href="#icon-schedule"></use>
                </svg>
            </span>
            è¡Œç¨‹è¡¨
        </div>
        <div class="nav-item" data-target="view-stay" onclick="switchTab(this)">
            <span class="nav-icon">
                <svg class="icon-sprite">
                    <use href="#icon-stay"></use>
                </svg>
            </span>
            ä½å®¿è³‡è¨Š
        </div>
        <div class="nav-item" data-target="view-car" onclick="switchTab(this)">
            <span class="nav-icon">
                <svg class="icon-sprite">
                    <use href="#icon-car"></use>
                </svg>
            </span>
            äº¤é€šè³‡è¨Š
        </div>
        <div class="nav-item" data-target="view-info" onclick="switchTab(this)">
            <span class="nav-icon">
                <svg class="icon-sprite">
                    <use href="#icon-info"></use>
                </svg>
            </span>
            æ—…éŠè³‡è¨Š
        </div>

        <div class="nav-item" data-target="view-ledger" onclick="switchTab(this)">
            <span class="nav-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"></path>
                    <path d="M12 18V6"></path>
                </svg>
            </span>
            æ—…ç¨‹è¨˜éŒ„
        </div>

        <div class="nav-item" data-target="view-ai" onclick="switchTab(this)">
            <span class="nav-icon">
                <svg class="icon-sprite">
                    <use href="#icon-ai"></use>
                </svg>
            </span>
            AI åŠ©æ‰‹
        </div>
    </nav>
    <button id="btn-quick-note" class="float-note-btn" onclick="openNoteModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
    </button>
    <button id="btn-calc" class="float-calc-btn" onclick="openCalcModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
        </svg>
    </button>
    <button id="btn-share-loc" class="float-share-btn" onclick="shareCurrentLocation()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle>
        </svg>

    </button>

    <div id="weather-detail-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 400px; padding: 20px; max-height: 85vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div class="modal-title" id="wd-title" style="margin:0; font-size:1.3rem; color: #1F2937;">--</div>

                <div class="modal-header-actions">
                    <button id="wd-btn-refresh" class="btn-header-icon" title="é‡æ–°æ•´ç†">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                            stroke-linejoin="round">
                            <path d="M23 4v6h-6"></path>
                            <path d="M1 20v-6h6"></path>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                    </button>

                    <button class="btn-header-icon"
                        onclick="document.getElementById('weather-detail-modal').style.display='none'" title="é—œé–‰">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                            stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="cw-container">
                <div class="cw-header">
                    <div class="cw-temp-big" id="wd-cur-temp">--Â°</div>
                    <div class="cw-info-col">
                        <div class="cw-condition" id="wd-cur-desc">--</div>
                        <div class="cw-hl-temp" id="wd-cur-hl">é«˜:-- ä½:--</div>
                    </div>
                </div>
                <div class="cw-grid">
                    <div class="cw-card">
                        <div class="cw-label">é«”æ„Ÿ</div>
                        <div class="cw-value" id="wd-feel">--Â°</div>
                    </div>
                    <div class="cw-card">
                        <div class="cw-label">é™é›¨ç‡</div>
                        <div class="cw-value" id="wd-pop">--%</div>
                    </div>
                    <div class="cw-card">
                        <div class="cw-label">ç´«å¤–ç·š</div>
                        <div class="cw-value" id="wd-uv">--</div>
                    </div>
                    <div class="cw-card">
                        <div class="cw-label">é¢¨é€Ÿ</div>
                        <div class="cw-value" id="wd-wind">--</div>
                    </div>
                </div>
            </div>
            <div class="astro-box">
                <div class="astro-left-col">
                    <div class="astro-item">
                        <div class="astro-icon">
                            <svg class="icon-sunrise" viewBox="0 0 24 24">
                                <path d="M17 18a5 5 0 0 0-10 0"></path>
                                <line x1="12" y1="2" x2="12" y2="9"></line>
                                <polyline points="8 6 12 2 16 6"></polyline>

                                <line x1="4.22" y1="10.22" x2="5.64" y2="11.64"></line>
                                <line x1="1" y1="18" x2="3" y2="18"></line>
                                <line x1="21" y1="18" x2="23" y2="18"></line>
                                <line x1="18.36" y1="11.64" x2="19.78" y2="10.22"></line>
                                <line x1="23" y1="22" x2="1" y2="22"></line>
                                <polyline points="8 6 12 2 16 6"></polyline>
                            </svg>
                        </div>
                        <span class="astro-time" id="wd-sunrise">--:--</span>
                    </div>

                    <div class="astro-item">
                        <div class="astro-icon">
                            <svg class="icon-sunset" viewBox="0 0 24 24">
                                <path d="M17 18a5 5 0 0 0-10 0"></path>
                                <line x1="12" y1="9" x2="12" y2="2"></line>
                                <path d="M8 5 L12 9 L16 5"></path>

                                <line x1="4.22" y1="10.22" x2="5.64" y2="11.64"></line>
                                <line x1="1" y1="18" x2="3" y2="18"></line>
                                <line x1="21" y1="18" x2="23" y2="18"></line>
                                <line x1="18.36" y1="11.64" x2="19.78" y2="10.22"></line>
                                <line x1="23" y1="22" x2="1" y2="22"></line>
                            </svg>
                        </div>
                        <span class="astro-time" id="wd-sunset">--:--</span>
                    </div>
                </div>

                <div class="astro-right-col">
                    <div id="wd-diff-badge" class="diff-badge diff-same" style="display:none;">
                        è¨ˆç®—ä¸­...
                    </div>
                    <div id="wd-advice-text" class="advice-text-small">
                        æ­£åœ¨åˆ†æç•¶åœ°ç©¿è‘—å»ºè­°...
                    </div>
                </div>
            </div>

            <div style="font-size: 0.9rem; font-weight: 700; margin-bottom: 5px; color: #4B5563;">æœªä¾† 24 å°æ™‚é å ±</div>
            <div class="weather-detail-scroll" id="wd-hourly-list">
                <div style="padding:10px; color:#999;">è¼‰å…¥ä¸­...</div>
            </div>

            <div style="font-size: 0.9rem; font-weight: 700; margin-top: 10px; margin-bottom: 5px; color: #4B5563;">æœªä¾† 7
                å¤©é å ±</div>
            <div id="wd-daily-list"></div>

        </div>
    </div>
    <div id="lightbox-modal" class="lightbox-overlay" onclick="closeLightbox()">
        <span class="lightbox-close">&times;</span>
        <img class="lightbox-content" id="lightbox-img">
    </div>

    <script>
        // [æ–°å¢] æ§åˆ¶éå ´ç•«é¢æ¶ˆå¤±çš„é‚è¼¯
        window.addEventListener('load', () => {
            const splash = document.getElementById('splash-screen');

            // è¨­å®šæœ€çŸ­é¡¯ç¤ºæ™‚é–“ (ä¾‹å¦‚ 1.5 ç§’)ï¼Œè®“ä½¿ç”¨è€…çœ‹å¾—åˆ°é£›æ©Ÿï¼Œä¸æœƒä¸€é–ƒè€Œé
            setTimeout(() => {
                if (splash) {
                    splash.classList.add('hidden');

                    // å‹•ç•«çµæŸå¾Œï¼Œå°‡å…ƒç´ å¾ DOM ç§»é™¤ï¼Œé‡‹æ”¾è¨˜æ†¶é«”
                    setTimeout(() => {
                        splash.remove();
                    }, 600); // é…åˆ CSS transition çš„ 0.6s
                }
            }, 1500); // 1500æ¯«ç§’ = 1.5ç§’ï¼Œæ‚¨å¯è‡ªè¡Œèª¿æ•´
        });

        // åŸæœ‰çš„ç¨‹å¼ç¢¼...
        // const encryptedApiKey = ...

        // [ä¿®æ”¹] åŸæœ¬çš„ const apiKey = ""; æ›¿æ›æˆä»¥ä¸‹å…§å®¹ï¼š

        // [æ–°å¢] é›¨æ»´ç‰¹æ•ˆè¨ˆæ™‚å™¨ç®¡ç† (é¿å…åˆ‡æ›åˆ†é æ™‚æ®˜ç•™)
        // [ä¿®æ”¹] é›¨æ»´ç‰¹æ•ˆè¨ˆæ™‚å™¨èˆ‡ç‰©ç†å¼•æ“ç®¡ç†
        window.rainTimers = [];
        window.rainInterval = null;
        window.rainPhysicsFrame = null; // â˜… æ–°å¢ï¼šç‰©ç†é‹ç®—å¹€ä»£ç¢¼

        function clearRainTimers() {
            // 1. æ¸…é™¤è¨ˆæ™‚å™¨
            if (window.rainTimers) {
                window.rainTimers.forEach(t => clearTimeout(t));
                window.rainTimers = [];
            }
            // 2. åœæ­¢ç”Ÿæˆæ–°æ°´æµ
            if (window.rainInterval) {
                clearInterval(window.rainInterval);
                window.rainInterval = null;
            }
            // 3. â˜… åœæ­¢ç‰©ç†ç¢°æ’åµæ¸¬è¿´åœˆ (é¿å…åˆ‡æ›é é¢å¾Œé‚„åœ¨èƒŒæ™¯é‹ç®—)
            if (window.rainPhysicsFrame) {
                cancelAnimationFrame(window.rainPhysicsFrame);
                window.rainPhysicsFrame = null;
            }
        }
        // [ä¿®æ”¹] 1. å®šç¾©å…©çµ„åŠ å¯†äº‚ç¢¼ (è«‹å°‡æ‚¨çš„ AES åŠ å¯†å­—ä¸²åˆ†åˆ¥å¡«å…¥)
        // ç”¨æ–¼ Gemini AI å°è©±ã€ç¿»è­¯
        const encryptedGeminiKey = "U2FsdGVkX1+nfsR3iRTUhVLmg5tFktJ/a0pmOHAqyOtTirUSq9f0ecLMbxUJJcThglRe9faATNugHJ/1eQAAxQ==";
        // ç”¨æ–¼ Google Places (åˆ†äº«ä½ç½®æ™‚æŠ“åœ°æ¨™åç¨±)
        const encryptedPlacesKey = "U2FsdGVkX1/8kyFaxEPoelwm4PAoa+8/5wkmP0ob/Vhfkg6S+i+sN8Vv98Hb4wn8Xs33BPKC/OthWwUus2i7fQ==";
        // [å®‰æ’åœ¨å…¶ä»– ENC_ è®Šæ•¸ç¾¤çµ„ä¸­]
        const encryptedGasUrl = "U2FsdGVkX18Y5ACmuYYoRyVW9r0uSdtY78SCv9lD5FsvYaEkuPk9yeg0s7HslxJyvVeiunIJvN0o7F0SiJyHfsM1Mer3Y0tSKnJwsq02TMdK7IVNOOJqyjLf4uGdNW3RvCDVmNDSVScpi23eh0DNZrfiY34LCCgHxFxueBiFx7mCvwYOiCqsziqRPXM+x8Gq"; // å¡«å…¥æ‚¨çš„ URL å¯†æ–‡
        const encryptedGasToken = "U2FsdGVkX18Ai8D1RX8NE51l8+0dsJK8BALcZZmlq78="; // å¡«å…¥æ‚¨çš„ Token å¯†æ–‡

        // [å®‰æ’åœ¨å…¶ä»– API_KEY å…¨åŸŸè®Šæ•¸ç¾¤çµ„ä¸­]
        let gasUrl = "";
        let gasToken = "";
        // [ä¿®æ”¹] 2. ç”¨ä¾†æš«å­˜è§£å¯†å¾Œçš„ Key
        let geminiKey = "";
        let googleKey = "";
        let currentLedgerFilter = 'finance'; // é è¨­é¡¯ç¤ºè¨˜å¸³è¦–åœ–
        let rawLedgerData = [];              // å­˜æ”¾å¾ GAS æŠ“å›ä¾†çš„åŸå§‹è³‡æ–™å¿«å–

        // [æ–°å¢] å°è©±æ­·å²ç´€éŒ„ (è®“ AI è¨˜ä½å‰å¹¾å¥è©±)
        let conversationHistory = [];
        // [æ–°å¢] AI å°éŠçš„ç³»çµ±æç¤ºè© (é€™è£¡å®šç¾©äº†å®ƒçš„è¨˜æ†¶èˆ‡äººè¨­)
        const systemPrompt = `
    ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ä¹å·æ—…éŠå°éŠï¼Œè² è²¬å¸¶é ˜ã€Œè¦ªå­è‡ªç”±è¡Œã€åœ˜éšŠã€‚
    ç›®å‰çš„æ—¥æœŸæ˜¯ 2026å¹´1æœˆ (è«‹æ ¹æ“šä½¿ç”¨è€…æå•åˆ¤æ–·ç›¸å°æ—¥æœŸ)ã€‚
    
    ã€è¡Œç¨‹ç¸½è¦½ã€‘
    Day 1 (1/25 æ—¥): æ­ä¹˜æ˜Ÿå®‡èˆªç©ºJX846(07:30å‡ºç™¼) æŠµé”ç†Šæœ¬æ©Ÿå ´(é è¨ˆ12:00) -> ç†Šæœ¬åŸ/æ«»ä¹‹é¦¬å ´ -> æ™šé¤:å‹çƒˆäº­è±¬æ’ -> ä½: The Blossom Kumamotoã€‚
    Day 2 (1/26 ä¸€): ç†Šæœ¬ç«™æ­ Aso Boy! (09:00) -> ç§Ÿè»Š(Toyota)-> é˜¿è˜‡ç«™/è‰åƒé‡Œ/ç«å±±åšç‰©é¤¨ -> é–‹è»Šå¾€é»‘å·æº«æ³‰ -> ä½: é»‘å·æº«æ³‰ (å…¥æ¹¯æ‰‹å½¢)ã€‚
    Day 3 (1/27 äºŒ): ä¹å·è‡ªç„¶é‡ç”Ÿå‹•ç‰©åœ’ (å¢æ—å·´å£«) -> åˆ¥åºœåœ°ç„å·¡ç¦® (æµ·åœ°ç„/ç¶åœ°ç„) -> ä½: ç”±å¸ƒé™¢ (é‡‘é±—æ¹–æ—)ã€‚
    Day 4 (1/28 ä¸‰): ç”±å¸ƒé™¢æ•£ç­– (æ¹¯ä¹‹åª/SnoopyèŒ¶å±‹) -> å¤ªå®°åºœå¤©æ»¿å®® -> TeamLab Forest ç¦å²¡ -> ä½: ç¦å²¡å¸‚å€ã€‚
    Day 5 (1/29 å››): å¤§æ¿ å…¬åœ’/ç¾è¡“é¤¨ -> å¤©ç¥åœ°ä¸‹è¡—/PARCO (åˆé¤:æ¥µå‘³å±‹) -> åšå¤šé‹æ²³åŸ -> ä¸­æ´²å±‹å° -> ä½: ç¦å²¡å¸‚å€ã€‚
    Day 6 (1/30 äº”): æ•´ç†è¡Œæ -> ç¦å²¡æ©Ÿå ´é‚„è»Š (10:30) -> æ­æ©Ÿè¿”å° (JX847 19:10)ã€‚

    ã€å›ç­”åŸå‰‡ã€‘
    1. ç°¡æ½”ï¼šä½ æ˜¯åœ¨æ‰‹æ©Ÿä¸Šè¢«é–±è®€ï¼Œå›ç­”è«‹ç²¾ç°¡ï¼Œä¸è¦é•·ç¯‡å¤§è«–ã€‚
    2. è¦ªåˆ‡ï¼šèªæ°£è¦åƒæœ‹å‹ä¸€æ¨£ç†±å¿ƒã€‚
    3. æº–ç¢ºï¼šåªèƒ½æ ¹æ“šä¸Šè¿°è¡Œç¨‹å›ç­”ï¼Œä¸è¦ç·¨é€ ä¸åœ¨è¡Œç¨‹å…§çš„æ™¯é»ã€‚
    4. èªè¨€ï¼šè«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡ (å°ç£)ã€‚
    5. å°èˆªæ”¯æ´ï¼šè‹¥ä½¿ç”¨è€…è©¢å•åœ°é»ä½ç½®æˆ–å¦‚ä½•å‰å¾€ï¼Œè«‹å‹™å¿…åœ¨å›ç­”ä¸­é™„ä¸Š Google Maps é€£çµï¼Œæ ¼å¼è«‹åš´æ ¼éµå®ˆï¼š
       <br><a href='https://www.google.com/maps/search/?api=1&query=åœ°é»åç¨±' target='_blank' style='display:inline-flex; align-items:center; gap:4px; margin-top:5px; color:#2563EB; font-weight:bold; text-decoration:none; border:1px solid #2563EB; padding:2px 8px; border-radius:12px;'><svg style='width:14px;height:14px;fill:none;stroke:currentColor;stroke-width:2;' viewBox='0 0 24 24'><use href='#icon-loc'></use></svg>å°èˆªè‡³ [åœ°é»]</a>
    `;
        // 3. è§£å¯†å‡½å¼ (æœƒåœ¨éœ€è¦ API æ™‚è‡ªå‹•å‘¼å«)
        // [ä¿®æ”¹] 3. é›™é‘°åŒ™è§£å¯†å‡½å¼ (å‚³å…¥ 'gemini' æˆ– 'places' å–å¾—å°æ‡‰ Key)
        // --- æœ‰ä¸€èªªä¸€ï¼šæ–°å¢æ ¼å¼åŒ–å‡½å¼ ---
        function formatLedgerTime(isoString) {
            if (!isoString) return "";
            try {
                const date = new Date(isoString);
                // å›å‚³å¦‚ "14:25" æ ¼å¼
                return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
            } catch (e) {
                return "";
            }
        }

        function getKey(type) {
            // A. å¦‚æœè¨˜æ†¶é«”ä¸­å·²ç¶“æœ‰è§£å¥½çš„ Keyï¼Œç›´æ¥å›å‚³
            if (type === 'gemini' && geminiKey) return geminiKey;
            if (type === 'places' && googleKey) return googleKey;
            if (type === 'gas_url' && gasUrl) return gasUrl;
            if (type === 'gas_token' && gasToken) return gasToken;

            // B. è®€å–å¯†ç¢¼ (å…©æŠŠé‘°åŒ™å…±ç”¨åŒä¸€å€‹å¯†ç¢¼ 'app_password')
            let password = localStorage.getItem("app_password");

            // å¦‚æœé€£æœ¬æ©Ÿéƒ½æ²’æœ‰å¯†ç¢¼ï¼Œæ‰è·Ÿä½¿ç”¨è€…è¦ä¸€æ¬¡
            if (!password) {
                password = prompt("è«‹è¼¸å…¥ API é‡‘é‘°å¯†ç¢¼ (è¼¸å…¥ä¸€æ¬¡å¾Œå°‡åœ¨æœ¬æ©Ÿè¨˜æ†¶ï¼Œç›´åˆ°æ‚¨é‡è¨­ç‚ºæ­¢)ï¼š");
                if (!password) return null; // ä½¿ç”¨è€…å–æ¶ˆ
            }

            try {
                // C. å…§éƒ¨è¼”åŠ©ï¼šå–®ç´”è§£å¯†å­—ä¸²
                const decrypt = (cipher) => {
                    if (!cipher) return "";
                    const bytes = CryptoJS.AES.decrypt(cipher, password);
                    return bytes.toString(CryptoJS.enc.Utf8);
                };

                // D. å˜—è©¦ç”¨åŒä¸€çµ„å¯†ç¢¼è§£é–‹å…©æŠŠé‘°åŒ™
                const g_key = decrypt(encryptedGeminiKey);
                const p_key = decrypt(encryptedPlacesKey);
                const g_url = decrypt(encryptedGasUrl);
                const g_token = decrypt(encryptedGasToken);

                // é©—è­‰æ©Ÿåˆ¶ (ä¾æ“šæ‚¨çš„ç¿’æ…£ï¼Œåªè¦æˆåŠŸè§£é–‹ä¸€å€‹ä»£è¡¨å¯†ç¢¼æ­£ç¢º)
                if (g_key.startsWith("AIza") || g_url.startsWith("https")) {
                    geminiKey = g_key;
                    googleKey = p_key;
                    gasUrl = g_url;
                    gasToken = g_token;

                    // é‡è¦ï¼šå¯†ç¢¼æ­£ç¢ºï¼Œå­˜å…¥æœ¬æ©Ÿè¨˜æ†¶
                    localStorage.setItem("app_password", password);
                    // ã€å®‰æ’æ­¤è¡Œã€‘å•Ÿå‹•æ™‚è‡ªå‹•åŒæ­¥è³‡æ–™
                    syncLedgerData();
                    // æ ¹æ“šéœ€æ±‚å›å‚³
                    const map = { 'gemini': geminiKey, 'places': googleKey, 'gas_url': gasUrl, 'gas_token': gasToken };
                    return map[type];
                } else {
                    alert("å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°å˜—è©¦ã€‚");
                    localStorage.removeItem("app_password"); // éŒ¯èª¤å°±æ¸…æ‰
                    return null;
                }
            } catch (e) {
                console.error("è§£å¯†å‡ºéŒ¯", e);
                localStorage.removeItem("app_password");
                return null;
            }
        }


        // [é–‹å§‹] æ›¿æ› switchView
        function switchView(viewId) {
            // éš±è—æ‰€æœ‰å®¹å™¨ï¼Œé¡¯ç¤ºç›®æ¨™å®¹å™¨
            document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');

            // æ›´æ–°å°è¦½åˆ—ç‹€æ…‹
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.getAttribute('onclick').includes(viewId));
            });

            // é‡å°ç‰¹å®šåˆ†é çš„åˆå§‹åŒ–
            if (viewId === 'view-ledger') {
                syncLedgerData();
                // ç¢ºä¿ DOM å·²ç¶“æº–å‚™å¥½å†åˆå§‹åŒ–é ­åƒé¸æ“‡å™¨
                requestAnimationFrame(() => {
                    initAvatarSelector();
                });
            }
        }
        // [çµæŸ] æ›¿æ› switchView

        // Weather Data Configuration
        // Icons: Using simple SVG strings for white icons


        const tripConfig = {
            'd1': {
                dateStr: '2026-01-25', // å‹™å¿…ç¢ºèªå¹´ä»½æ—¥æœŸæ­£ç¢º
                loc: 'ç†Šæœ¬å¸‚',
                lat: 32.803, lon: 130.707,
                backup: { temp: '10Â°C', range: '2Â°C ~ 11Â°C', desc: 'æ™´æ™‚å¤šé›²', advice: 'æ°£æº«é©ä¸­ä½†æ—©æ™šåæ¶¼ï¼Œé•·è¢–é…å¤–å¥—ã€‚', icon: 'cloud-sun' }
            },
            'd2': {
                dateStr: '2026-01-26',
                loc: 'é˜¿è˜‡/é»‘å·',
                lat: 33.096, lon: 131.096, // é»‘å·æº«æ³‰é™„è¿‘åº§æ¨™
                backup: { temp: '5Â°C', range: '-3Â°C ~ 6Â°C', desc: 'å¤šé›²/é£„é›ª', advice: 'å±±å€æ¥µå†·ï¼Œå‹™å¿…ç©¿è‘—ç¾½çµ¨å¤–å¥—ä¿æš–ã€‚', icon: 'snow' }
            },
            'd3': {
                dateStr: '2026-01-27',
                loc: 'åˆ¥åºœ/ç”±å¸ƒé™¢',
                lat: 33.265, lon: 131.360, // ç”±å¸ƒé™¢åº§æ¨™
                backup: { temp: '7Â°C', range: '0Â°C ~ 8Â°C', desc: 'å¤šé›²', advice: 'æ¿•åº¦è¼ƒé«˜é«”æ„Ÿå¯’å†·ï¼Œè«‹ç©¿é˜²æ»‘é‹ã€‚', icon: 'cloud' }
            },
            'd4': {
                dateStr: '2026-01-28',
                loc: 'ç¦å²¡å¸‚',
                lat: 33.590, lon: 130.401,
                backup: { temp: '9Â°C', range: '4Â°C ~ 10Â°C', desc: 'é™°å¤©', advice: 'å¸‚å€é¢¨å¤§ï¼Œå»ºè­°ç©¿è‘—é˜²é¢¨å¤–å¥—ã€‚', icon: 'cloud' }
            },
            'd5': {
                dateStr: '2026-01-29',
                loc: 'ç¦å²¡å¸‚',
                lat: 33.590, lon: 130.401,
                backup: { temp: '10Â°C', range: '3Â°C ~ 11Â°C', desc: 'æ™´æœ—', advice: 'æ—©æ™šæº«å·®å¤§ï¼Œæ´‹è”¥å¼ç©¿æ³•æœ€ä½³ã€‚', icon: 'sun' }
            },
            'd6': {
                dateStr: '2026-01-30',
                loc: 'ç¦å²¡å¸‚',
                lat: 33.590, lon: 130.401,
                backup: { temp: '9Â°C', range: '4Â°C ~ 10Â°C', desc: 'å¤šé›²æ™‚æ™´', advice: 'å®¤å…§æš–æ°£å¼·ï¼Œå…§æ­ä¸å®œéåšã€‚', icon: 'cloud-sun' }
            }
        };

        // [ä¿®æ”¹ 2] è®“ Widget æ”¯æ´éåŒæ­¥è®€å–èˆ‡ Loading ç‹€æ…‹
        // [æ–°å¢] é€šç”¨å¿«å–æŠ“å–å‡½å¼ (10åˆ†é˜å¿«å–æ©Ÿåˆ¶)
        // [æ–°å¢] å…¨åŸŸå¿«å–è®Šæ•¸ (é‡æ–°æ•´ç†ç¶²é å¾Œæœƒè‡ªå‹•æ¸…ç©ºï¼Œç¬¦åˆæ‚¨çš„éœ€æ±‚)
        // [API çœæµå„ªåŒ–] çµ±ä¸€å¿«å–ç®¡ç†ç³»çµ± (LocalStorage ç‰ˆ)
        const CACHE_SYSTEM = {
            // å­˜å…¥è³‡æ–™ (é è¨­ TTL ç‚º 30 åˆ†é˜)
            save: (key, data, ttlMinutes = 30) => {
                try {
                    const record = {
                        timestamp: Date.now(),
                        expiry: ttlMinutes * 60 * 1000,
                        data: data
                    };
                    localStorage.setItem(key, JSON.stringify(record));
                } catch (e) {
                    console.warn("LocalStorage å„²å­˜å¤±æ•— (å¯èƒ½æ˜¯å®¹é‡å·²æ»¿)", e);
                }
            },
            // è®€å–è³‡æ–™
            get: (key) => {
                const json = localStorage.getItem(key);
                if (!json) return null;

                try {
                    const record = JSON.parse(json);
                    const now = Date.now();

                    // æª¢æŸ¥æ˜¯å¦éæœŸ
                    if (now - record.timestamp > record.expiry) {
                        console.log(`[å¿«å–éæœŸ] ${key} å·²æ¸…é™¤`);
                        localStorage.removeItem(key);
                        return null;
                    }

                    console.log(`[çœæµæ¨¡å¼] è®€å– LocalStorage: ${key}`);
                    return record.data;
                } catch (e) {
                    return null;
                }
            }
        };

        // [ä¿®æ”¹] æ”¯æ´ LocalStorage çš„ Fetch å‡½å¼
        async function fetchWithCache(url, cacheKey) {
            // 1. å…ˆæŸ¥å¿«å–
            const cachedData = CACHE_SYSTEM.get(cacheKey);
            if (cachedData) return cachedData;

            // 2. ç„¡å¿«å–å‰‡å‘¼å« API
            console.log(`[APIæ¶ˆè€—] å‘¼å«ç¶²è·¯: ${url}`);
            try {
                const res = await fetch(url);
                const data = await res.json();

                // 3. å­˜å…¥å¿«å– (å¤©æ°£è³‡æ–™å­˜ 20 åˆ†é˜)
                CACHE_SYSTEM.save(cacheKey, data, 20);
                return data;
            } catch (e) {
                console.error("Fetch Error:", e);
                return null;
            }
        }
        window.currentActiveConfig = null;

        async function updateWeatherWidget(dayId) {
            const config = tripConfig[dayId];
            if (!config) return;

            window.currentActiveConfig = config; // â˜… åŠ å…¥é€™ä¸€è¡Œï¼ç´€éŒ„ç›®å‰çš„è¨­å®š

            // 1. å…ˆé¡¯ç¤º Loading ç‹€æ…‹ (æå‡ä½¿ç”¨è€…é«”é©—)
            document.getElementById('hw-loc').innerText = config.loc;
            //document.getElementById('hw-date').innerText = config.dateStr.slice(5); // åªé¡¯ç¤º MM-DD
            document.getElementById('hw-date').innerText = config.dateStr; // åªé¡¯ç¤º MM-DD
            document.getElementById('hw-temp').innerText = '--';
            document.getElementById('hw-desc').innerText = 'è®€å–ä¸­...';
            document.getElementById('hw-range').innerText = '';
            document.getElementById('hw-advice').innerText = 'è³‡æ–™æ›´æ–°ä¸­...';
            // é¡¯ç¤ºä¸€å€‹ç°¡å–®çš„è¼‰å…¥åœ–ç¤º
            document.getElementById('hw-icon').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="animation: rotate 1s linear infinite;"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>`;

            // 2. å‘¼å«æ™ºæ…§åˆ¤æ–·å‡½æ•¸å–å¾—è³‡æ–™
            const data = await getSmartWeatherData(config);

            // 3. æ›´æ–°ç•«é¢
            document.getElementById('hw-temp').innerText = data.temp;
            document.getElementById('hw-desc').innerText = data.desc;
            document.getElementById('hw-range').innerText = data.range;
            document.getElementById('hw-advice').innerText = data.advice;

            // è™•ç† Icon
            const iconType = data.icon || 'cloud';
            // å¦‚æœæ˜¯ API å›å‚³çš„ï¼Œæˆ‘å€‘åªçµ¦ä»£ç¢¼ (å¦‚ sun, cloud, rain)ï¼Œå¦‚æœæ²’å°æ‡‰åˆ°å°±çµ¦ cloud
            const validIcons = ['sun', 'cloud', 'cloud-sun', 'snow', 'rain', 'fog', 'lightning'];
            const finalIcon = validIcons.includes(iconType) ? iconType : 'cloud';

            document.getElementById('hw-icon').innerHTML = `<div class="weather-icon ${finalIcon}"></div>`;
            // ... å‰é¢æ˜¯ document.getElementById('hw-icon').innerHTML = ...

            // â˜…â˜…â˜… [æ–°å¢ Start] ä¾æ“šæ—¥æœ¬ç•¶åœ°çš„ isDay åˆ‡æ› Header èƒŒæ™¯ â˜…â˜…â˜…
            const header = document.querySelector('header');

            // å¦‚æœ API æœ‰å›å‚³ isDay (ä»£è¡¨æ˜¯å³æ™‚è³‡æ–™)ï¼Œå°±ç”¨å®ƒåˆ¤æ–·
            if (data.isDay !== undefined) {
                if (data.isDay === 0) {
                    header.classList.add('is-night'); // åˆ‡æ›ç‚ºé»‘å¤œ
                } else {
                    header.classList.remove('is-night'); // åˆ‡æ›ç‚ºç™½å¤©
                }
            } else {
                // å¦‚æœæ˜¯æœªä¾†é å ±æˆ–é›¢ç·šè³‡æ–™ï¼Œé€šå¸¸é è¨­é¡¯ç¤ºç™½å¤©æ¯”è¼ƒç¾è§€
                header.classList.remove('is-night');
            }
            // â˜…â˜…â˜… [æ–°å¢ End] â˜…â˜…â˜…

            setWeatherEffect(finalIcon);
        }
        // â˜…â˜…â˜… [æ–°å¢å‡½å¼] ç•¶è¡Œç¨‹æ‘ºé å…¨é—œé–‰æ™‚ï¼Œé‚„åŸå›ã€Œæˆ‘çš„ä½ç½®ã€å¤©æ°£èˆ‡ç‰¹æ•ˆ
        function resetHeaderToLocal() {
            /* --- è«‹åœ¨æ­¤è™•æ’å…¥ä»£ç¢¼ Start --- */
            // [ä¿®æ­£] å¼·åˆ¶æ¸…ç©ºç›®å‰é¸ä¸­çš„è¡Œç¨‹è¨­å®šï¼Œè®“ Modal çŸ¥é“ç¾åœ¨æ˜¯ã€Œæˆ‘çš„ä½ç½®ã€æ¨¡å¼
            window.currentActiveConfig = null;
            /* --- è«‹åœ¨æ­¤è™•æ’å…¥ä»£ç¢¼ End --- */

            // 1. æª¢æŸ¥æ˜¯å¦æœ‰å¿«å–çš„å®šä½è³‡æ–™
            if (!window.appCache || !window.appCache['my_location_combined']) {
                return; // é‚„æ²’å®šä½éå°±ä¸å‹•ä½œ
            }

            const cached = window.appCache['my_location_combined'].data;
            const header = document.querySelector('header');

            // 2. é‚„åŸæ–‡å­—è³‡è¨Š
            document.getElementById('hw-loc').innerText = cached.city;
            document.getElementById('hw-date').innerText = 'ç¾åœ¨ä½ç½®';
            document.getElementById('hw-temp').innerText = `${Math.round(cached.temp)}Â°C`;
            document.getElementById('hw-desc').innerText = getWeatherDescText(cached.code);
            document.getElementById('hw-range').innerText = '';
            document.getElementById('hw-advice').innerText = 'é¡¯ç¤ºæ‚¨æ‰€åœ¨åœ°çš„å³æ™‚å¤©æ°£ã€‚';

            // 3. é‚„åŸæ—¥å¤œèƒŒæ™¯ (é—œéµ)
            if (cached.isDay === 0) {
                header.classList.add('is-night');
            } else {
                header.classList.remove('is-night');
            }

            // 4. é‚„åŸå¤©æ°£åœ–ç¤ºèˆ‡ç‰¹æ•ˆ
            const iconType = getWeatherIconClass(cached.code);
            document.getElementById('hw-icon').innerHTML = `<div class="weather-icon ${iconType}"></div>`;

            if (typeof setWeatherEffect === 'function') {
                setWeatherEffect(iconType);
            }
        }
        // [ä¿®æ”¹] æ™ºæ…§åˆ¤æ–·å‡½å¼ï¼šæ”¹ç”¨ã€ŒçœŸå¯¦æº«åº¦ã€ç”Ÿæˆå‹•æ…‹å»ºè­°
        // [ä¿®æ”¹] æ™ºæ…§åˆ¤æ–·å‡½å¼ï¼šåŠ å…¥ 10 åˆ†é˜å¿«å–æ©Ÿåˆ¶
        async function getSmartWeatherData(config) {
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0]; // æ ¼å¼: YYYY-MM-DD

            const tripDate = new Date(config.dateStr);
            tripDate.setHours(0, 0, 0, 0);
            const todayDate = new Date();
            todayDate.setHours(0, 0, 0, 0);

            // --- æƒ…å¢ƒ A: éå»å¼ ---
            if (tripDate < todayDate) {
                console.log(`[${config.loc}] æ˜¯éå»è¡Œç¨‹ï¼Œä½¿ç”¨éœæ…‹ç´€éŒ„ã€‚`);
                return config.backup;
            }

            // --- æƒ…å¢ƒ B & C: ä»Šå¤©æˆ–æœªä¾† (å‘¼å« API + å¿«å–) ---
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${config.lat}&longitude=${config.lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&current_weather=true&timezone=Asia%2FTokyo`;

                // â˜… ç”¢ç”Ÿå”¯ä¸€å¿«å–é‡‘é‘° (æ—¥æœŸ+åœ°é»)
                const cacheKey = `trip_weather_${config.dateStr}_${config.lat}`;

                // â˜… æ”¹ç”¨å¿«å–å‡½å¼æŠ“å–
                const json = await fetchWithCache(url, cacheKey);

                const index = json.daily.time.indexOf(config.dateStr);
                let displayData = {};

                // è³‡æ–™è§£æé‚è¼¯ (ç¶­æŒåŸæœ¬ä¸è®Š)
                if (config.dateStr === todayStr) {
                    const current = json.current_weather;
                    const todayMax = json.daily.temperature_2m_max[0];
                    const todayMin = json.daily.temperature_2m_min[0];

                    displayData = {
                        temp: `${Math.round(current.temperature)}Â°C`,
                        range: `${Math.round(todayMin)}Â°C ~ ${Math.round(todayMax)}Â°C`,
                        desc: getWeatherDescText(current.weathercode),
                        icon: getWeatherIconClass(current.weathercode),
                        advice: `(å³æ™‚) ${getSmartAdviceText(current.temperature, current.weathercode)}`,
                        isDay: current.is_day // â˜… æ–°å¢é€™è¡Œï¼šå›å‚³æ—¥æœ¬ç•¶åœ°çš„æ—¥å¤œ
                    };
                }
                else if (index !== -1) {
                    const code = json.daily.weathercode[index];
                    const max = json.daily.temperature_2m_max[index];
                    const min = json.daily.temperature_2m_min[index];
                    const avgTemp = (max + min) / 2;

                    displayData = {
                        temp: `${Math.round(avgTemp)}Â°C`,
                        range: `${Math.round(min)}Â°C ~ ${Math.round(max)}Â°C`,
                        desc: getWeatherDescText(code),
                        icon: getWeatherIconClass(code),
                        advice: `(é å ±) ${getSmartAdviceText(avgTemp, code)}`,
                        // â˜…â˜…â˜… [æ–°å¢] å¼·åˆ¶å¸¶å…¥è©²åœ°é»ã€Œæ­¤æ™‚æ­¤åˆ»ã€çš„æ—¥å¤œç‹€æ…‹ â˜…â˜…â˜…
                        // é€™æ¨£å°±ç®—æŸ¥çœ‹æ˜å¤©çš„è¡Œç¨‹ï¼ŒèƒŒæ™¯ä¹Ÿæœƒåæ˜ æ—¥æœ¬ç¾åœ¨æ˜¯é»‘å¤œ
                        isDay: json.current_weather.is_day
                    };
                }
                else {
                    // è‹¥è¶…å‡ºé å ±ç¯„åœ (ä¾‹å¦‚7å¤©å¾Œ)ï¼Œé¡¯ç¤ºç•¶ä¸‹å¤©æ°£ä½œç‚ºåƒè€ƒ
                    const current = json.current_weather;
                    const todayMax = json.daily.temperature_2m_max[0];
                    const todayMin = json.daily.temperature_2m_min[0];
                    displayData = {
                        temp: `${Math.round(current.temperature)}Â°C`,
                        range: `${Math.round(todayMin)}Â°C ~ ${Math.round(todayMax)}Â°C`,
                        desc: getWeatherDescText(current.weathercode),
                        icon: getWeatherIconClass(current.weathercode),
                        advice: `(è¡Œå‰åƒè€ƒ) ${getSmartAdviceText(current.temperature, current.weathercode)}`,
                        isDay: current.is_day // â˜…â˜…â˜… [æ–°å¢] è£œä¸Šé€™è¡Œ
                    };
                }

                return displayData;

            } catch (e) {
                console.error("API ç²å–å¤±æ•—", e);
                return { ...config.backup, desc: config.backup.desc + ' (é›¢ç·š)', advice: 'ç¶²è·¯é€£ç·šç•°å¸¸ï¼Œé¡¯ç¤ºé›¢ç·šè³‡æ–™ã€‚' };
            }
        }

        // è¼”åŠ©å‡½å¼ï¼šå°‡ WMO Code è½‰æˆä¸­æ–‡æè¿°
        function getWeatherDescText(code) {
            if (code === 0) return 'æ™´æœ—';
            if (code >= 1 && code <= 3) return 'å¤šé›²';
            if (code >= 45 && code <= 48) return 'æœ‰éœ§'; // [å„ªåŒ–] å¢åŠ éœ§çš„åˆ¤æ–·
            if (code >= 51 && code <= 67) return 'æœ‰é›¨';
            if (code >= 71 && code <= 77) return 'æœ‰é›ª';
            if (code >= 80 && code <= 82) return 'é™£é›¨';
            if (code >= 95) return 'é›·é›¨';
            return 'å¤šé›²';
        }
        // [æ–°å¢] è£œä¸Šéºå¤±çš„å¤©æ°£ç‹€æ…‹æ–‡å­—è½‰æ›å‡½å¼ (ç”¨æ–¼è©³ç´°å¤©æ°£ Modal)
        function getWeatherStatusText(code) {
            // ç›´æ¥æ²¿ç”¨ getWeatherDescText çš„é‚è¼¯ï¼Œæˆ–è€…å¯ä»¥å¯«å¾—æ›´ç°¡çŸ­
            return getWeatherDescText(code);
        }

        // è¼”åŠ©å‡½å¼ï¼šå°‡ WMO Code è½‰æˆä½ çš„ CSS Icon Class
        function getWeatherIconClass(code) {
            if (code === 0) return 'sun';
            if (code <= 3) return 'cloud-sun'; // æˆ– cloud
            if (code <= 48) return 'fog'; // ä½ å¯èƒ½éœ€è¦æ–°å¢ fog æ¨£å¼ï¼Œæˆ–ç”¨ cloud ä»£æ›¿
            if (code <= 67) return 'rain';
            if (code <= 77) return 'snow';
            if (code <= 82) return 'rain';
            if (code <= 99) return 'lightning'; // ä½ å¯èƒ½éœ€è¦æ–°å¢ lightning æ¨£å¼
            return 'cloud';
        }
        // [æ–°å¢] ç©¿è¡£å»ºè­°å¤§è…¦ï¼šæ ¹æ“šã€Œæº«åº¦ã€èˆ‡ã€Œå¤©æ°£ã€è‡ªå‹•ç”Ÿæˆå»ºè­°
        function getSmartAdviceText(temp, weatherCode) {
            let advice = "";

            // 1. æº«åº¦åˆ¤æ–· (åŸºç¤ç©¿è‘—)
            if (temp >= 30) {
                advice = "å¤©æ°£ç‚ç†±ï¼Œè«‹è‘—çŸ­è¢–ä¸¦æ³¨æ„é˜²æ›¬è£œæ°´ã€‚";
            } else if (temp >= 25) {
                advice = "æ°£æº«èˆ’é©åç†±ï¼ŒçŸ­è¢–æˆ–è–„è¡«å³å¯ã€‚";
            } else if (temp >= 20) {
                advice = "æ°£æº«å®œäººï¼Œå»ºè­°ç©¿è‘—è–„é•·è¢–æˆ–è¥¯è¡«ã€‚";
            } else if (temp >= 15) {
                advice = "ç¨æœ‰æ¶¼æ„ï¼Œå»ºè­°é•·è¢–æ­é…è–„å¤–å¥—æˆ–é¢¨è¡£ã€‚";
            } else if (temp >= 10) {
                advice = "å¤©æ°£åå†·ï¼Œè«‹ç©¿è‘—æ¯›è¡£ã€å¤¾å…‹æˆ–åšå¤–å¥—ã€‚";
            } else if (temp >= 5) {
                advice = "æ°£æº«å¯’å†·ï¼Œå‹™å¿…ç©¿è‘—ç¾½çµ¨å¤–å¥—ã€ç™¼ç†±è¡£ä¿æš–ã€‚";
            } else {
                advice = "åš´å¯’ä½æº«ï¼è«‹å…¨å‰¯æ­¦è£ï¼Œåœå·¾æ‰‹å¥—ä¸å¯å°‘ã€‚";
            }

            // 2. ç‰¹æ®Šå¤©æ°£è¿½åŠ æé†’ (ä¸‹é›¨/ä¸‹é›ª)
            if (weatherCode >= 51 && weatherCode <= 67 || weatherCode >= 80 && weatherCode <= 82) {
                advice += " å¤–å‡ºè«‹è¨˜å¾—æ”œå¸¶é›¨å…·ã€‚";
            } else if (weatherCode >= 71 && weatherCode <= 77) {
                advice += " è·¯é¢å¯èƒ½æ¿•æ»‘ï¼Œè«‹ç©¿é˜²æ»‘é‹ã€‚";
            }

            return advice;
        }
        // --- REAL-TIME WEATHER FUNCTIONS (Using Open-Meteo Free API) ---
        let currentMyTemp = null;

        // æ™ºæ…§åœ°åç¿»è­¯å°ç…§è¡¨ (ä¿ç•™ä½œç‚ºå¿«é€Ÿå¿«å–ï¼Œç¯€çœ AI è³‡æº)
        const cityMapping = {
            'ç”±å¸ƒé™¢': 'Yufuin',
            'æ¹¯å¸ƒé™¢': 'Yufuin',
            'é»‘å·': 'Minamioguni',
            'é»‘å·æº«æ³‰': 'Minamioguni',
            'ç†Šæœ¬': 'Kumamoto',
            'ç†Šæœ¬å¸‚': 'Kumamoto',
            'é˜¿è˜‡': 'Aso',
            'åˆ¥åºœ': 'Beppu',
            'ç¦å²¡': 'Fukuoka',
            'åšå¤š': 'Fukuoka',
            'å¤ªå®°åºœ': 'Dazaifu',
            'é«˜åƒç©—': 'Takachiho'
        };

        // æ–°å¢ï¼šç¨ç«‹çš„ Gemini å‘¼å«å‡½æ•¸ï¼Œåªå›å‚³æ–‡å­—ï¼Œä¸æ“ä½œ UI
        // [ä¿®æ”¹] Gemini API å‘¼å«å‡½å¼ï¼šå‡ç´šæ”¯æ´åœ–ç‰‡å‚³é€ (Multimodal)
        // [ä¿®æ”¹] Gemini API å‘¼å«å‡½å¼ï¼šå‡ç´šç‚ºæœ€æ–°çš„ Gemini 3 Flash Preview
        async function getGeminiResponse(promptText, imageBase64 = null) {
            // [ä¿®æ”¹] æŒ‡å®šç²å– Gemini çš„ Key
            const currentKey = getKey('gemini');
            if (!currentKey) {
                appendMessage('ai', 'âš ï¸ å°šæœªè¼¸å…¥æ­£ç¢ºå¯†ç¢¼ï¼Œç„¡æ³•ä½¿ç”¨ AI åŠŸèƒ½ã€‚');
                throw new Error("API Key Missing");
            }

            try {
                // 1. å»ºç«‹åŸºæœ¬çš„ parts é™£åˆ—ï¼Œå…ˆæ”¾å…¥æ–‡å­—
                let parts = [
                    { text: promptText }
                ];

                // 2. å¦‚æœæœ‰åœ–ç‰‡ï¼Œä½¿ç”¨ unshift å°‡åœ–ç‰‡ã€Œæ’éšŠã€åˆ°æœ€å‰é¢
                if (imageBase64) {
                    parts.unshift({
                        inline_data: {
                            mime_type: "image/jpeg",
                            data: imageBase64
                        }
                    });
                }

                // 3. çµ„åˆè«‹æ±‚å…§å®¹
                const requestBody = {
                    contents: [{
                        parts: parts
                    }]
                };

                // â˜… é—œéµä¿®æ”¹ï¼šä½¿ç”¨æ­£ç¢ºçš„ Gemini 3 Flash Preview æ¨¡å‹åç¨±
                // Release Date: 2025-12-17
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${currentKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (data.error) {
                    console.error("API Error Detail:", data.error);
                    throw new Error(data.error.message);
                }

                if (!data.candidates || !data.candidates[0].content) {
                    throw new Error("API å›å‚³ç„¡å…§å®¹ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                }

                let text = data.candidates[0].content.parts[0].text.trim();
                text = text.replace(/```(html|json)?/g, '').replace(/```/g, '').trim();
                return text;

            } catch (error) {
                console.error("AI Fetch Error:", error);
                throw error;
            }
        }

        async function fetchRealtimeWeather() {
            const rawInput = document.getElementById('weather-city-input').value.trim();
            if (!rawInput) {
                alert('è«‹è¼¸å…¥åŸå¸‚åç¨±');
                return;
            }

            // UI Loading State
            document.getElementById('weather-placeholder').style.display = 'none';
            document.getElementById('weather-result').style.display = 'block';
            document.getElementById('wc-loc').innerText = rawInput;
            document.getElementById('wc-desc').innerText = 'æº–å‚™ä¸­...';
            document.getElementById('wc-temp').innerText = '--Â°';
            document.getElementById('wc-advice').innerText = '...';

            let searchTerm = rawInput;
            let isTranslated = false;

            try {
                // æ­¥é©Ÿ 1: å…ˆæª¢æŸ¥å¿«é€Ÿå°ç…§è¡¨ (æœ€å¿«)
                for (const key in cityMapping) {
                    if (rawInput.includes(key)) {
                        searchTerm = cityMapping[key];
                        isTranslated = true;
                        console.log("ä½¿ç”¨å…§å»ºå°ç…§è¡¨:", searchTerm);
                        break;
                    }
                }

                // æ­¥é©Ÿ 2: å¦‚æœå°ç…§è¡¨æ²’æœ‰ï¼Œè«‹æ±‚ AI åœ¨èƒŒæ™¯ç¿»è­¯ (æ‚¨çš„æ–°æƒ³æ³•!)
                // æ­¥é©Ÿ 2: AI èƒŒæ™¯ç¿»è­¯ (å·²åŠ å…¥æ°¸ä¹…å¿«å–)
                if (!isTranslated) {
                    // [æ–°å¢] å…ˆæŸ¥å¿«å– (é‡‘é‘°: city_trans_ä¸­æ–‡å)
                    const cacheKey = `city_trans_${rawInput}`;
                    const cachedName = CACHE_SYSTEM.get(cacheKey);

                    if (cachedName) {
                        searchTerm = cachedName;
                        isTranslated = true;
                        console.log("ä½¿ç”¨å¿«å–åœ°å:", searchTerm);
                        document.getElementById('wc-desc').innerText = `æœå°‹: ${searchTerm} (å¿«å–)`;
                    } else {
                        // ç„¡å¿«å–ï¼Œæ‰å‘¼å« AI
                        document.getElementById('wc-desc').innerText = 'ğŸ” AI æ­£åœ¨ç¿»è­¯åœ°å...';

                        const translatePrompt = `
                            Task: Translate the place name "${rawInput}" into its official English Romanization name for using in a Weather API.
                            Target: Global locations (Focus on Taiwan/Japan).
                            Rule: Output ONLY the English name. No explanations.
                            Example: "å°åŒ—" -> "Taipei", "ç”±å¸ƒé™¢" -> "Yufuin", "æ–°ç«¹" -> "Hsinchu".
                        `;

                        try {
                            const aiTranslation = await getGeminiResponse(translatePrompt);
                            if (/^[a-zA-Z\s\-,]+$/.test(aiTranslation)) {
                                searchTerm = aiTranslation;
                                isTranslated = true;
                                console.log("AI ç¿»è­¯çµæœ:", searchTerm);
                                document.getElementById('wc-desc').innerText = `æœå°‹: ${searchTerm}...`;

                                // [æ–°å¢] ç¿»è­¯æˆåŠŸå¾Œï¼Œå­˜å…¥å¿«å– (ä¿å­˜ 24 å°æ™‚ = 1440 åˆ†é˜)
                                CACHE_SYSTEM.save(cacheKey, searchTerm, 1440);
                            }
                        } catch (e) {
                            console.warn("AI ç¿»è­¯å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨åŸå§‹ä¸­æ–‡æœå°‹");
                        }
                    }
                }

                document.getElementById('wc-desc').innerText = 'é€£ç·šæ°£è±¡è¡›æ˜Ÿ...';

                // æ­¥é©Ÿ 3: Geocoding API æŸ¥è©¢
                // å„ªå…ˆä½¿ç”¨ç¿»è­¯å¾Œçš„è‹±æ–‡ï¼Œè‹¥ç„¡å‰‡ç”¨ä¸­æ–‡
                // [ä¿®æ”¹] count=10 ä»¥ç²å–æ›´å¤šå€™é¸åœ°é»ä¾†ç¯©é¸æ—¥æœ¬
                let geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(searchTerm)}&count=10&language=en&format=json`;
                let geoRes = await fetch(geoUrl);
                let geoData = await geoRes.json();

                // è‹±æ–‡æ‰¾ä¸åˆ°ï¼Œæœ€å¾Œå˜—è©¦ä¸­æ–‡
                if ((!geoData.results || geoData.results.length === 0) && isTranslated) {
                    geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(rawInput)}&count=10&language=zh&format=json`;
                    geoRes = await fetch(geoUrl);
                    geoData = await geoRes.json();
                }

                if (!geoData.results || geoData.results.length === 0) {
                    throw new Error(`æ‰¾ä¸åˆ°ã€Œ${rawInput}ã€<br>AI ç¿»è­¯: ${searchTerm}`);
                }

                // [æ–°å¢] ç¯©é¸é‚è¼¯ï¼šå„ªå…ˆæ‰¾æ—¥æœ¬çš„çµæœ
                let targetLocation = geoData.results[0];
                const jpLocation = geoData.results.find(r => r.country_code === 'JP' || r.country === 'Japan');
                if (jpLocation) {
                    targetLocation = jpLocation;
                    console.log("å·²è‡ªå‹•é–å®šæ—¥æœ¬åœ°é»:", targetLocation.name);
                }

                const { latitude, longitude, name, country } = targetLocation;

                // æ­¥é©Ÿ 4: å–å¾—å¤©æ°£
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`;
                const weatherRes = await fetch(weatherUrl);
                const weatherData = await weatherRes.json();

                const temp = weatherData.current_weather.temperature;
                const weatherCode = weatherData.current_weather.weathercode;

                // --- [å°ˆå®¶å„ªåŒ– Start]ï¼šä¾æ“šå³æ™‚æ°£æº«å‹•æ…‹èª¿æ•´èƒŒæ™¯é¡è‰² ---
                const boxMain = document.getElementById('wc-box-main');
                const tempText = document.getElementById('wc-temp');

                // æ¸…é™¤èˆŠçš„è¡Œå…§æ¨£å¼ (é‡ç½®ç‚ºå‹•æ…‹é…è‰²)
                boxMain.style.color = '';

                if (temp < 15) {
                    // ğŸ¥¶ å¯’å†· (è—è‰²ç³»ï¼šæ·ºè—åº• + æ·±è—å­—)
                    boxMain.style.background = '#EFF6FF'; // æ·ºè—èƒŒæ™¯
                    boxMain.style.borderColor = '#BFDBFE'; // è—è‰²é‚Šæ¡†
                    boxMain.style.color = '#1E3A8A';       // æ·±è—æ–‡å­— (åœ°å)
                    tempText.style.color = '#2563EB';      // äº®è—æ°£æº«
                    // ä¿®æ­£é™°å½±é¡è‰²ç‚ºè—è‰²èª¿
                    boxMain.style.boxShadow = '0 4px 10px rgba(37, 99, 235, 0.15)';
                } else if (temp >= 15 && temp <= 25) {
                    // ğŸƒ èˆ’é© (ç¶ è‰²ç³»ï¼šæ·ºç¶ åº• + æ·±ç¶ å­—)
                    boxMain.style.background = '#ECFDF5'; // æ·ºç¶ èƒŒæ™¯
                    boxMain.style.borderColor = '#6EE7B7'; // ç¶ è‰²é‚Šæ¡†
                    boxMain.style.color = '#064E3B';       // æ·±ç¶ æ–‡å­—
                    tempText.style.color = '#059669';      // äº®ç¶ æ°£æº«
                    boxMain.style.boxShadow = '0 4px 10px rgba(5, 150, 105, 0.15)';
                } else {
                    // ğŸ¥µ ç‚ç†± (æ©˜è‰²ç³»ï¼šæ·ºæ©˜åº• + æ·±æ©˜å­—)
                    boxMain.style.background = '#FFF7ED'; // æ·ºæ©˜èƒŒæ™¯
                    boxMain.style.borderColor = '#FED7AA'; // æ©˜è‰²é‚Šæ¡†
                    boxMain.style.color = '#7C2D12';       // æ·±è¤æ–‡å­—
                    tempText.style.color = '#EA580C';      // äº®æ©˜æ°£æº«
                    boxMain.style.boxShadow = '0 4px 10px rgba(234, 88, 12, 0.15)';
                }
                // --- [å°ˆå®¶å„ªåŒ– End] ---
                // Update UI with Vertical English Name (ä¸Šä¸‹åˆ†å±¤)
                let displayLocHtml = rawInput;
                if (searchTerm && searchTerm.toLowerCase() !== rawInput.toLowerCase()) {
                    displayLocHtml = `
                        <div style="display: flex; flex-direction: column; align-items: center; line-height: 1.2;">
                            <span>${rawInput}</span>
                            <span style="font-size: 0.6em; opacity: 0.8; font-weight: 400; margin-top: 4px; font-family: sans-serif; letter-spacing: 0.5px;">${searchTerm}</span>
                        </div>
                    `;
                }
                document.getElementById('wc-loc').innerHTML = displayLocHtml;

                document.getElementById('wc-temp').innerText = `${temp}Â°C`;
                // ä¿®æ­£ 3: æ”¹ç”¨ innerHTML ä»¥æ”¯æ´ SVG åœ–ç¤º
                document.getElementById('wc-desc').innerHTML = getWeatherDesc(weatherCode);

                // æ­¥é©Ÿ 5: æº«å·®å°æ¯”
                updateComparison(temp);

                // æ­¥é©Ÿ 6: AI ç©¿è¡£å»ºè­°
                document.getElementById('wc-advice').innerText = 'AI æ­£åœ¨åˆ†æç•¶åœ°æ°£å€™...';
                askAiWeatherAdvice(rawInput, temp, getWeatherDesc(weatherCode));

            } catch (error) {
                console.error(error);
                document.getElementById('wc-desc').innerText = 'æŸ¥è©¢å¤±æ•—';

                let errorMsg = error.message;
                if (errorMsg.includes('Failed to fetch')) {
                    errorMsg = 'ç¶²è·¯é€£ç·šè¢«é˜»æ“‹ã€‚<br>è«‹æª¢æŸ¥ç¶²è·¯è¨­å®šã€‚';
                }

                document.getElementById('wc-advice').innerHTML = `<span style="color:var(--danger); font-weight:bold;">${errorMsg}</span>`;
            }
        }

        // ä¿®æ­£ 2: å®šç¾©ç°¡ç´„å¤©æ°£ SVG åœ–ç¤º (ç™½è‰²ç·šæ¢)
        const simpleIcons = {
            sun: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>',
            cloud: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>',
            rain: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 13v8"></path><path d="M8 13v8"></path><path d="M12 15v8"></path><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"></path></svg>',

            // [ä¿®æ”¹] é›ªï¼šæ›´æ–°ç‚ºæœ€æ–°çš„é›™é‡å¹³è¡Œ V å‹ + å…­è§’å†°æ ¸
            snow: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 9 L14.6 10.5 L14.6 13.5 L12 15 L9.4 13.5 L9.4 10.5 Z"/><path d="M12 9 V1 M12 15 V23 M14.6 10.5 L21.5 6.5 M14.6 13.5 L21.5 17.5 M9.4 13.5 L2.5 17.5 M9.4 10.5 L2.5 6.5"/><path d="M9.5 5.5 L12 7.5 L14.5 5.5 M9.5 2 L12 4 L14.5 2"/><path d="M9.5 18.5 L12 16.5 L14.5 18.5 M9.5 22 L12 20 L14.5 22"/><path d="M16.4 6.6 L15.9 9.75 L18.9 10.9 M19.4 4.8 L18.9 8 L21.9 9.2"/><path d="M18.9 13.1 L15.9 14.25 L16.4 17.4 M21.9 14.8 L18.9 16 L19.4 19.2"/><path d="M7.6 17.4 L8.1 14.25 L5.1 13.1 M4.6 19.2 L5.1 16 L2.1 14.8"/><path d="M5.1 10.9 L8.1 9.75 L7.6 6.6 M2.1 9.2 L5.1 8 L4.6 4.8"/></svg>',

            fog: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 6h14M4 10h16M6 14h12M4 18h16"></path></svg>',
            lightning: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9"></path><polyline points="13 11 9 17 15 17 11 23"></polyline></svg>'
        };

        function getWeatherDesc(code) {
            // Updated to return HTML with Simple SVG
            if (code === 0) return `æ™´æœ— ${simpleIcons.sun}`;
            if (code >= 1 && code <= 3) return `å¤šé›² ${simpleIcons.cloud}`;
            if (code >= 45 && code <= 48) return `æœ‰éœ§ ${simpleIcons.fog}`;
            if (code >= 51 && code <= 67) return `æœ‰é›¨ ${simpleIcons.rain}`;
            if (code >= 71 && code <= 77) return `æœ‰é›ª ${simpleIcons.snow}`;
            if (code >= 80 && code <= 82) return `é™£é›¨ ${simpleIcons.rain}`;
            if (code >= 95) return `é›·é›¨ ${simpleIcons.lightning}`;
            return `å¤šé›² ${simpleIcons.cloud}`;
        }

        // [ä¿®æ”¹] å–å¾—å®šä½å¤©æ°£ (åŒæ­¥æ›´æ–° Header èˆ‡ åˆ†é )
        // [ä¿®æ”¹] å–å¾—å®šä½å¤©æ°£ (å„²å­˜å¤©æ°£ä»£ç¢¼ä¾› AI è®€å–)
        // [ä¿®æ”¹] å–å¾—å®šä½å¤©æ°£ (é˜²å¡æ­»ç©©å®šç‰ˆ)
        // [ä¿®æ”¹] æ™ºæ…§å®šä½å‡½å¼ï¼šæ‰‹æ©Ÿç”¨é«˜ç²¾ç¢ºåº¦ï¼Œé›»è…¦è‡ªå‹•é™ç´šç‚ºä¸€èˆ¬æ¨¡å¼
        // [ä¿®æ”¹] çµ‚æ¥µå®šä½å‡½å¼ï¼šæ”¯æ´ GPS (æ‰‹æ©Ÿ)ã€Wi-Fi (ç­†é›») èˆ‡ æœ‰ç·šç¶²è·¯ (æ¡Œæ©Ÿ)
        // [ä¿®æ­£ç‰ˆ] æ··åˆé›™è»Œå®šä½ï¼šæ‰‹æ©ŸæŠ“ç²¾ç¢ºã€é›»è…¦æŠ“ IPï¼Œç¢ºä¿ 100% æˆåŠŸç‡
        // [æ™ºæ…§å®šä½å‡½å¼] å®Œç¾è§£æ±ºæ–¹æ¡ˆï¼šæ‰‹æ©Ÿå„ªå…ˆæŠ“ GPSï¼Œé›»è…¦è‡ªå‹•é€€å›æŠ“ IP
        // [æœ€çµ‚ç‰ˆ] è£ç½®åˆ†æµå®šä½ï¼šé›»è…¦æ¨¡æ“¬èˆŠç‰ˆè¡Œç‚º(IP)ï¼Œæ‰‹æ©Ÿå•Ÿç”¨é«˜ç²¾åº¦(GPS)
        function getLocalWeather() {
            // å®šç¾© UI 
            const els = {
                headerLoc: document.getElementById('header-my-loc'),
                headerTemp: document.getElementById('header-my-temp'),
                tabTemp: document.getElementById('wc-my-temp'),
                titleBox: document.getElementById('wc-loc-box')
            };

            // 1. æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
            if (!navigator.geolocation) {
                alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½');
                return;
            }

            // UI é¡¯ç¤º
            if (els.headerLoc) els.headerLoc.innerText = 'å®šä½ä¸­...';
            if (els.titleBox) els.titleBox.innerHTML = '<span class="loading-dots">å®šä½ä¸­</span>';

            // 2. åˆ¤æ–·è£ç½®é¡å‹ï¼šæ˜¯æ‰‹æ©Ÿå—ï¼Ÿ
            // å¦‚æœæ˜¯ iPhone, Android ç­‰è¡Œå‹•è£ç½®ï¼ŒisMobile æœƒæ˜¯ true
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            // ç­–ç•¥ï¼šæ‰‹æ©Ÿç”¨ true (é«˜ç²¾åº¦)ï¼Œé›»è…¦å¼·åˆ¶ç”¨ false (ä½ç²¾åº¦ï¼Œåƒ index_ai ä¸€æ¨£)
            const useHighAccuracy = isMobile;

            console.log(`è£ç½®åµæ¸¬: ${isMobile ? "æ‰‹æ©Ÿ (å•Ÿç”¨ GPS)" : "é›»è…¦ (ä½¿ç”¨ IP å®šä½)"}`);

            // === æˆåŠŸé‚è¼¯ ===
            const handleSuccess = async (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                try {
                    // A. æŠ“å¤©æ°£ (åŠ å…¥ timezone=auto ä»¥ç²å–ç²¾ç¢ºæ™‚å€)
                    const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`);
                    const weatherData = await weatherRes.json();

                    currentMyTemp = weatherData.current_weather.temperature;
                    const tempStr = `${Math.round(currentMyTemp)}Â°C`;
                    const code = weatherData.current_weather.weathercode;
                    // â˜…â˜…â˜… [æ–°å¢ Start] æ•æ‰æ—¥å¤œç‹€æ…‹ â˜…â˜…â˜…
                    const localIsDay = weatherData.current_weather.is_day; // 1=ç™½, 0=å¤œ
                    // â˜…â˜…â˜… [æ–°å¢ End] â˜…â˜…â˜…
                    // [æ–°å¢] å–å¾— API å›å‚³çš„ç•¶åœ°æ™‚å€ (ä¾‹å¦‚ "Asia/Tokyo")
                    const localTimezone = weatherData.timezone;

                    // B. AI è§£æåœ°å
                    let displayZh = "æˆ‘çš„ä½ç½®";
                    try {
                        // æç¤ºè©
                        const locationPrompt = `Task: Identify the specific district/township name for ${lat},${lon} (e.g., ç«¹åŒ—å¸‚, æ–°ç«¹å¸‚æ±å€, åšå¤šå€). Output ONLY the Traditional Chinese name.`;
                        // å‘¼å« AI (è¨­å®š 10ç§’ è¶…æ™‚)
                        const aiPromise = getGeminiResponse(locationPrompt);
                        const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 10000));
                        const aiCity = await Promise.race([aiPromise, timeoutPromise]);
                        if (aiCity) displayZh = aiCity.trim();
                    } catch (e) {
                        console.warn("AI è§£æç•¥é");
                    }

                    // C. æ›´æ–° UI
                    if (els.headerLoc) els.headerLoc.innerText = displayZh;
                    if (els.headerTemp) els.headerTemp.innerText = tempStr;
                    if (els.tabTemp) {
                        els.tabTemp.innerText = tempStr;
                        els.tabTemp.style.fontSize = '1.5rem';
                        els.tabTemp.style.color = '#1F2937';
                    }
                    if (els.titleBox) {
                        els.titleBox.innerHTML = `
                            <div style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                                <svg class="icon-mini" style="color: #EF4444;" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                                <span>${displayZh}</span>
                            </div>`;
                    }

                    // å­˜æª”èˆ‡æ¯”å°
                    window.appCache = window.appCache || {};
                    window.appCache['my_location_combined'] = {
                        timestamp: Date.now(),
                        data: {
                            temp: currentMyTemp,
                            city: displayZh,
                            code: code,
                            timezone: localTimezone,
                            isDay: localIsDay // â˜… é‡é»ï¼šé€™è£¡å¤šå­˜äº†ä¸€å€‹æ¬„ä½
                        }
                    };

                    // â˜…â˜…â˜… [æ–°å¢] è‹¥ç›®å‰æ²’æœ‰ä»»ä½•è¡Œç¨‹è¢«æ‰“é–‹ï¼Œå°±ç›´æ¥å¥—ç”¨é€™è£¡çš„æ—¥å¤œç‰¹æ•ˆ
                    /*if (!document.querySelector('.timeline.show')) {
                        const header = document.querySelector('header');
                        if (localIsDay === 0) header.classList.add('is-night');
                        else header.classList.remove('is-night');
                        
                        // é‡ç¹ªç‰¹æ•ˆ
                        if (typeof setWeatherEffect === 'function') {
                             setWeatherEffect(getWeatherIconClass(code));
                        }
                    }*/
                    // â˜…â˜…â˜… [ä¿®æ”¹] è‹¥ç›®å‰æ²’æœ‰ä»»ä½•è¡Œç¨‹è¢«æ‰“é–‹ï¼Œç›´æ¥å‘¼å«é‚„åŸå‡½å¼æ›´æ–°ã€Œå…¨éƒ¨ä»‹é¢ã€(å«æ–‡å­—èˆ‡ç‰¹æ•ˆ)
                    if (!document.querySelector('.timeline.show')) {
                        resetHeaderToLocal();
                    }
                    const targetTempStr = document.getElementById('wc-temp') ? document.getElementById('wc-temp').innerText : '--Â°';
                    if (targetTempStr !== '--Â°') updateComparison(parseFloat(targetTempStr));

                } catch (e) {
                    console.error("è™•ç†å¤±æ•—", e);
                    if (els.headerLoc) els.headerLoc.innerText = 'é€£ç·šå¤±æ•—';
                }
            };

            // === å¤±æ•—è™•ç† (åªé‡å°æ‰‹æ©Ÿçš„é«˜ç²¾åº¦å¤±æ•—é€²è¡Œé™ç´š) ===
            const handleError = (err) => {
                console.warn("å®šä½å¤±æ•—:", err.code, err.message);

                // å¦‚æœæ˜¯æ‰‹æ©Ÿå˜—è©¦é«˜ç²¾åº¦å¤±æ•—äº†ï¼Œå†çµ¦å®ƒä¸€æ¬¡æ©Ÿæœƒç”¨ä½ç²¾åº¦
                if (useHighAccuracy) {
                    console.log("æ‰‹æ©Ÿ GPS å¤±æ•—ï¼Œå˜—è©¦åˆ‡æ› IP å®šä½...");
                    navigator.geolocation.getCurrentPosition(
                        handleSuccess,
                        (err2) => {
                            alert("å®šä½å¤±æ•—ï¼Œè«‹ç¢ºèªæ‰‹æ©Ÿå®šä½æœå‹™å·²é–‹å•Ÿã€‚");
                            if (els.headerLoc) els.headerLoc.innerText = 'å®šä½æœªé–‹';
                        },
                        { enableHighAccuracy: false, timeout: 10000, maximumAge: 0 }
                    );
                } else {
                    // é›»è…¦ä½ç²¾åº¦å¦‚æœä¹Ÿå¤±æ•—ï¼Œé‚£å°±æ˜¯çœŸçš„è¢«å°é–æˆ–æ²’ç¶²è·¯äº†
                    if (els.headerLoc) els.headerLoc.innerText = 'ç„¡æ³•å®šä½';
                    alert("é›»è…¦ç„¡æ³•å–å¾—ä½ç½®ï¼Œè«‹ç¢ºèªç€è¦½å™¨æ¬Šé™ã€‚");
                }
            };

            // === 3. é–‹å§‹åŸ·è¡Œ ===
            // é€™è£¡ä½¿ç”¨äº†è®Šæ•¸ useHighAccuracy
            // é›»è…¦ç‰ˆï¼šuseHighAccuracy ç‚º false -> è¡Œç‚ºç­‰åŒ index_ai (ä¸æœƒå ±éŒ¯)
            // æ‰‹æ©Ÿç‰ˆï¼šuseHighAccuracy ç‚º true -> è¡Œç‚ºç­‰åŒ index (æŠ“ç«¹åŒ—)
            navigator.geolocation.getCurrentPosition(
                handleSuccess,
                handleError,
                { enableHighAccuracy: useHighAccuracy, timeout: 5000, maximumAge: 0 }
            );
        }

        // --- Modal Functions (å–ä»£åŸç”Ÿ alert/prompt) ---
        function openModal(msg) {
            document.getElementById('modal-msg').innerText = msg;
            document.getElementById('location-modal').style.display = 'flex';
            document.getElementById('modal-city-input').focus();
        }

        function closeModal() {
            document.getElementById('location-modal').style.display = 'none';
        }
        // [æ–°å¢] éš¨èº«ç­†è¨˜åŠŸèƒ½ (è‡ªå‹•å„²å­˜)
        // [ä¿®æ”¹] éš¨èº«ç­†è¨˜åŠŸèƒ½ (æ”¯æ´åœ–æ–‡å„²å­˜ + é»æ“Šæ”¾å¤§)
        const NOTE_STORAGE_KEY = 'kyushu_trip_note_2026';

        function openNoteModal() {
            const modal = document.getElementById('note-modal');
            const area = document.getElementById('note-area');
            const status = document.getElementById('note-status');

            // 1. è®€å–èˆŠç­†è¨˜ (æ”¹ç”¨ innerHTML è®€å– HTML æ ¼å¼)
            area.innerHTML = localStorage.getItem(NOTE_STORAGE_KEY) || '';
            status.innerText = '';

            modal.style.display = 'flex';

            // 2. ç¶å®šè¼¸å…¥äº‹ä»¶ (å³æ™‚è‡ªå‹•å„²å­˜ HTML)
            area.oninput = function () {
                saveNoteContent();
            };

            // [é—œéµæ–°å¢] 3. ç¶å®šåœ–ç‰‡é»æ“Šäº‹ä»¶ (äº‹ä»¶å§”æ´¾)
            // è®“ç­†è¨˜å…§ä»»ä½•åœ–ç‰‡è¢«é»æ“Šæ™‚ï¼Œéƒ½æœƒè§¸ç™¼å…¨è¢å¹•ç‡ˆç®±
            area.onclick = function (e) {
                if (e.target.tagName === 'IMG') {
                    openLightbox(e.target.src); // å‘¼å«åŸæœ¬å·²å¯«å¥½çš„ç‡ˆç®±åŠŸèƒ½
                }
            };
        }

        function saveNoteContent() {
            const area = document.getElementById('note-area');
            const status = document.getElementById('note-status');

            // å„²å­˜æ•´å€‹ HTML (å«åœ–ç‰‡ Base64)
            localStorage.setItem(NOTE_STORAGE_KEY, area.innerHTML);
            status.innerText = 'å·²è‡ªå‹•å„²å­˜ âœ“';
        }

        function closeNoteModal() {
            document.getElementById('note-modal').style.display = 'none';
        }

        // [æ–°å¢] è™•ç†ç­†è¨˜æ’å…¥åœ–ç‰‡
        async function insertNoteImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const area = document.getElementById('note-area');
            const status = document.getElementById('note-status');
            status.innerText = 'åœ–ç‰‡è™•ç†ä¸­...';

            try {
                // 1. å¼·åŠ›å£“ç¸®åœ–ç‰‡ (å¯¬åº¦ 600px, å“è³ª 0.6)
                // ä½¿ç”¨æ‚¨ç¨‹å¼ç¢¼åº•éƒ¨åŸæœ¬å°±æœ‰çš„ compressImage å‡½å¼
                const base64 = await compressImage(file, 600, 0.6);

                // 2. å»ºç«‹åœ–ç‰‡å…ƒç´ 
                const img = document.createElement('img');
                img.src = `data:image/jpeg;base64,${base64}`;

                // 3. æ’å…¥åœ–ç‰‡
                area.focus(); // ç¢ºä¿ç„¦é»
                area.appendChild(document.createElement('br')); // æ›è¡Œ
                area.appendChild(img);
                area.appendChild(document.createElement('br')); // æ›è¡Œ

                // 4. è§¸ç™¼å„²å­˜
                saveNoteContent();

            } catch (e) {
                alert("åœ–ç‰‡æ’å…¥å¤±æ•—ï¼š" + e);
                status.innerText = 'å¤±æ•—';
            } finally {
                // æ¸…ç©º inputï¼Œç¢ºä¿ä¸‹ä¸€å¼µåŒååœ–ç‰‡ä¹Ÿèƒ½è§¸ç™¼
                event.target.value = '';
            }
        }
        /* --- åœ¨ function closeNoteModal() { ... } çµæŸå¾Œæ’å…¥ --- */

        // [æ–°å¢] åŒ¯ç‡è¨ˆç®—æ©Ÿèˆ‡ API ä¸²æ¥é‚è¼¯
        function openCalcModal() {
            document.getElementById('calc-modal').style.display = 'flex';

            // 1. å…ˆå˜—è©¦è®€å–å¿«å–
            const savedRateData = JSON.parse(localStorage.getItem('live_exchange_rate_cache') || '{}');
            const now = Date.now();
            const oneHour = 3600000;

            if (savedRateData.rate && (now - savedRateData.timestamp < oneHour)) {
                updateRateUI(savedRateData.rate, 'å¿«å–');
            } else {
                fetchLiveRate();
            }

            // [æ–°å¢] æ¯æ¬¡é–‹å•Ÿé è¨­ç‚º JPY -> TWD æ¨¡å¼
            if (typeof isJpyToTwd !== 'undefined') {
                isJpyToTwd = true;
                const mainLabel = document.getElementById('cur-label-main');
                const subLabel = document.getElementById('cur-label-sub');
                if (mainLabel && subLabel) {
                    mainLabel.innerText = "JPY";
                    subLabel.innerText = "TWD";
                    mainLabel.style.color = "#2563EB"; // JPY è—è‰²
                    subLabel.style.color = "#059669"; // [æ–°å¢] TWD ç¶ è‰²
                }
            }

            // é‡ç½®è¨ˆç®—æ©Ÿç•«é¢
            if (typeof calcInput === 'function') {
                calcInput('AC');
            }
        }

        function closeCalcModal() {
            document.getElementById('calc-modal').style.display = 'none';
        }

        // æŠ“å–å³æ™‚åŒ¯ç‡ (ä¾†æº: å…è²»å…¬é–‹ API)
        // æŠ“å–å³æ™‚åŒ¯ç‡ (ä¾†æº: å…è²»å…¬é–‹ API)
        async function fetchLiveRate() {
            // [ä¿®æ­£] åŠ å…¥æª¢æŸ¥
            const statusEl = document.getElementById('rate-status');
            if (statusEl) {
                statusEl.innerText = 'âŸ³ æ›´æ–°ä¸­...';
                statusEl.style.color = '#F59E0B';
            }

            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                const data = await res.json();
                const newRate = data.rates.TWD;

                if (newRate) {
                    localStorage.setItem('live_exchange_rate_cache', JSON.stringify({
                        rate: newRate,
                        timestamp: Date.now()
                    }));
                    updateRateUI(newRate, 'å³æ™‚');

                    // [ä¿®æ­£] æ”¹å‘¼å«æ–°çš„é‡ç®—å‡½å¼
                    if (typeof reCalcTotal === 'function') reCalcTotal();
                }
            } catch (e) {
                console.error("åŒ¯ç‡æ›´æ–°å¤±æ•—", e);
                // [ä¿®æ­£] åŠ å…¥æª¢æŸ¥
                if (statusEl) {
                    statusEl.innerText = 'âš ï¸ é€£ç·šå¤±æ•—';
                    statusEl.style.color = '#EF4444';
                }
                // å¤±æ•—æ™‚è‹¥æ²’å€¼ï¼Œçµ¦å€‹é è¨­å€¼
                const rateInput = document.getElementById('calc-rate');
                if (rateInput && !rateInput.value) rateInput.value = 0.22;
            }
        }

        function updateRateUI(rate, type) {
            const rateInput = document.getElementById('calc-rate');
            if (rateInput) rateInput.value = Number(rate).toFixed(3);

            // [ä¿®æ­£] åŠ å…¥æª¢æŸ¥ï¼šç¢ºèª statusEl å­˜åœ¨æ‰æ›´æ–°ï¼Œé¿å…å ±éŒ¯
            const statusEl = document.getElementById('rate-status');
            if (statusEl) {
                statusEl.innerText = `â— ${type}åŒ¯ç‡`;
                statusEl.style.color = '#10B981'; // ç¶ è‰²
            }
        }

        // [æ–°å¢] è¨ˆç®—æ©Ÿè®Šæ•¸èˆ‡é‚è¼¯
        let calcExpression = ""; // å„²å­˜ç®—å¼å­—ä¸²
        let isJpyToTwd = true;   // [æ–°å¢] é è¨­ç‚º æ—¥å¹£ -> å°å¹£

        // [æ–°å¢] åˆ‡æ›å¹£åˆ¥æ¨¡å¼
        function toggleCurrency() {
            isJpyToTwd = !isJpyToTwd; // åˆ‡æ›ç‹€æ…‹

            // æ›´æ–°æŒ‰éˆ•æ–‡å­—èˆ‡é¡è‰²
            const mainLabel = document.getElementById('cur-label-main');
            const subLabel = document.getElementById('cur-label-sub');

            if (isJpyToTwd) {
                // æ¨¡å¼ï¼šæ—¥ -> å°
                mainLabel.innerText = "JPY";
                mainLabel.style.color = "#2563EB"; // ä¸»é¡¯ç¤º JPY (è—)
                subLabel.innerText = "TWD";
                subLabel.style.color = "#059669";  // å‰¯é¡¯ç¤º TWD (ç¶ )
            } else {
                // æ¨¡å¼ï¼šå° -> æ—¥
                mainLabel.innerText = "TWD";
                mainLabel.style.color = "#059669"; // ä¸»é¡¯ç¤º TWD (ç¶ )
                subLabel.innerText = "JPY";
                subLabel.style.color = "#2563EB";  // å‰¯é¡¯ç¤º JPY (è—)
            }

            // æ›´æ–°ç•«é¢ä¸Šçš„ç¬¦è™Ÿä¸¦é‡æ–°è¨ˆç®—
            updateCalcDisplaySymbol();
            reCalcTotal();
        }

        // [æ–°å¢] æ›´æ–°ç•«é¢ä¸Šçš„å¹£åˆ¥ç¬¦è™Ÿ
        function updateCalcDisplaySymbol() {
            const mainDisplay = document.getElementById('calc-main-display');
            // è®€å–ç›®å‰çš„æ•¸å­— (å»æ‰éæ•¸å­—å­—å…ƒ)
            let currentVal = mainDisplay.innerText.replace(/[^\d.-]/g, '');
            if (!currentVal) currentVal = "0";

            // æ ¹æ“šæ¨¡å¼åŠ ä¸Šå°æ‡‰ç¬¦è™Ÿ
            const symbol = isJpyToTwd ? "Â¥" : "NT$";
            mainDisplay.innerText = symbol + currentVal;
        }

        // [ä¿®æ”¹] è¨ˆç®—æ©Ÿæ ¸å¿ƒè™•ç†
        function calcInput(val) {
            const exprDisplay = document.getElementById('calc-expr-display');
            const mainDisplay = document.getElementById('calc-main-display');
            const symbol = isJpyToTwd ? "Â¥" : "NT$"; // æ ¹æ“šæ¨¡å¼æ±ºå®šä¸»ç¬¦è™Ÿ

            if (val === 'AC') {
                calcExpression = "";
                exprDisplay.innerText = "";
                mainDisplay.innerText = symbol + "0";
                reCalcTotal(0);
                return;
            }

            if (val === 'DEL') {
                calcExpression = calcExpression.toString().slice(0, -1);
            } else if (val === '=') {
                try {
                    const safeExpr = calcExpression.replace(/Ã—/g, '*').replace(/Ã·/g, '/');
                    if (!safeExpr) return;

                    const result = eval(safeExpr);

                    // é¡¯ç¤ºçµæœ (åŠ ä¸Šç¬¦è™Ÿ)
                    mainDisplay.innerText = symbol + parseFloat(result.toFixed(2));
                    calcExpression = result.toString();
                    exprDisplay.innerText = "";
                    reCalcTotal(result);
                    return;
                } catch (e) {
                    mainDisplay.innerText = "Error";
                    calcExpression = "";
                }
            } else {
                const lastChar = calcExpression.slice(-1);
                const ops = ['+', '-', '*', '/', '.'];
                let displayVal = val;
                if (val === '*') displayVal = 'Ã—';
                if (val === '/') displayVal = 'Ã·';

                if (ops.includes(val) && ops.includes(lastChar)) {
                    calcExpression = calcExpression.slice(0, -1) + val;
                } else {
                    calcExpression += val;
                }
            }

            exprDisplay.innerText = calcExpression.replace(/\*/g, 'Ã—').replace(/\//g, 'Ã·');

            try {
                const safeExpr = calcExpression.replace(/Ã—/g, '*').replace(/Ã·/g, '/');
                if (safeExpr && !['+', '-', '*', '/'].includes(safeExpr.slice(-1))) {
                    const previewRes = eval(safeExpr);
                    reCalcTotal(previewRes);
                }
            } catch (e) { }
        }

        // [ä¿®æ”¹] é›™å‘åŒ¯ç‡æ›ç®—é‚è¼¯
        function reCalcTotal(amount = null) {
            const rate = parseFloat(document.getElementById('calc-rate').value) || 0;
            const subDisplay = document.getElementById('calc-sub-display');
            const mainDisplay = document.getElementById('calc-main-display');

            if (amount === null) {
                // å¾ç•«é¢è®€å–æ•¸å­— (ç§»é™¤ Â¥ æˆ– NT$)
                amount = parseFloat(mainDisplay.innerText.replace(/[^\d.-]/g, '')) || 0;
            }

            let resultVal = 0;
            let resultSymbol = "";

            if (isJpyToTwd) {
                // æ¨¡å¼ï¼šæ—¥å¹£è½‰å°å¹£ (ä¹˜æ³•)
                // é‚è¼¯ï¼šæ—¥å¹£é‡‘é¡ Ã— åŒ¯ç‡(0.22) = å°å¹£
                resultVal = Math.round(amount * rate);
                resultSymbol = "NT$";
            } else {
                // æ¨¡å¼ï¼šå°å¹£è½‰æ—¥å¹£ (é™¤æ³•)
                // é‚è¼¯ï¼šå°å¹£é‡‘é¡ Ã· åŒ¯ç‡(0.22) = æ—¥å¹£
                if (rate !== 0) {
                    resultVal = Math.round(amount / rate);
                }
                resultSymbol = "Â¥";
            }

            subDisplay.innerText = `â‰ˆ ${resultSymbol}${resultVal.toLocaleString()}`;
        }


        // [ä¿®æ­£ç‰ˆ] é»æ“ŠèƒŒæ™¯é—œé–‰è¦–çª— (æ”¹ç”¨ç›´æ¥ç¶å®šï¼Œè§£æ±ºæ‰‹æ©Ÿè§¸æ§ç„¡æ•ˆå•é¡Œ)
        // è‡ªå‹•æŠ“å–æ‰€æœ‰ class ç‚º modal-overlay çš„é®ç½©å±¤
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', function (e) {
                // åˆ¤æ–·é—œéµï¼šåªæœ‰ç•¶é»æ“Šçš„ç›®æ¨™æ˜¯ã€ŒèƒŒæ™¯æœ¬äººã€æ™‚æ‰é—œé–‰
                // å¦‚æœé»åˆ°å…§éƒ¨çš„ç™½è‰²è¦–çª— (modal-box)ï¼Œe.target æœƒæ˜¯ box è€Œä¸æ˜¯ overlayï¼Œå°±ä¸æœƒè§¸ç™¼
                if (e.target === this) {

                    // ç‰¹æ®Šè™•ç†ï¼šå¦‚æœæ˜¯åœ–ç‰‡é è¦½è¦–çª—ï¼Œéœ€è¦æ¸…ç©ºæš«å­˜
                    if (this.id === 'img-preview-modal' && typeof cancelImagePreview === 'function') {
                        cancelImagePreview();
                    } else {
                        this.style.display = 'none';
                    }
                }
            });
        });

        // [ä¿®æ”¹] å…©æ®µå¼åˆ†äº«åŠŸèƒ½ (è§£æ±ºç€è¦½å™¨é˜»æ“‹è¦–çª—å•é¡Œ)
        // ç‹€æ…‹æ¨™è¨˜ï¼šç´€éŒ„ç›®å‰æ˜¯å¦å·²ç¶“åˆ†æå®Œæˆ
        // --- [æ–°å¢] Google Places API æ•‘æ´å‡½å¼ (ä¸‰éšæ®µå®šä½é‚è¼¯ç”¨) ---
        const fetchGooglePlaces = async (lat, lng, radius = 50) => {
            // [ä¿®æ”¹] æŒ‡å®šç²å– Google Places çš„ Key
            const currentKey = getKey('places');
            if (!currentKey) return [];

            const centerLat = Number(lat);
            const centerLng = Number(lng);

            // å®šç¾©è¦æœå°‹çš„åœ°æ¨™é¡å‹ (æ’é™¤å¤ªéç± çµ±çš„é¡å‹)
            const validTypes = [
                "restaurant", "cafe", "convenience_store", "tourist_attraction",
                "park", "store", "lodging", "transit_station", "museum", "shopping_mall"
            ];

            const url = `https://places.googleapis.com/v1/places:searchNearby`;
            const body = {
                includedTypes: validTypes,
                maxResultCount: 1, // [ä¿®æ”¹] å—æ­¡è¿åº¦ç¬¬ä¸€ï¼Œæ‰€ä»¥å– 1 ç­†å³å¯
                rankPreference: "POPULARITY", // [ä¿®æ”¹] æ”¹å›ä¾ã€Œå—æ­¡è¿åº¦ã€æ’åº
                locationRestriction: {
                    circle: {
                        center: { latitude: centerLat, longitude: centerLng },
                        radius: Number(radius), // æœå°‹åŠå¾‘ (å…¬å°º)
                    },
                },
                languageCode: "zh-TW",
            };

            try {
                const res = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-Goog-Api-Key": currentKey,
                        "X-Goog-FieldMask": "places.displayName,places.addressDescriptor",
                    },
                    body: JSON.stringify(body),
                });
                if (!res.ok) return [];
                const data = await res.json();
                return data.places || [];
            } catch (e) {
                console.error("Google Places API Error:", e);
                return [];
            }
        };
        let isLocReady = false;
        let pendingShareData = null;

        // [ä¿®æ”¹] æ™ºæ…§åˆ†äº«åŠŸèƒ½ (å˜—è©¦ä¸€éµå®Œæˆï¼Œé‡é˜»æ“‹å‰‡å„ªé›…è®Šèº«)
        // [ä¿®æ”¹] æ™ºæ…§åˆ†äº«åŠŸèƒ½ (ä¸‰éšæ®µç²¾æº–å®šä½ç‰ˆ)
        function shareCurrentLocation() {
            const btn = document.getElementById('btn-share-loc');

            // --- [éšæ®µäºŒ] å¦‚æœæŒ‰éˆ•å·²ç¶“æ˜¯ã€Œæº–å‚™å®Œæˆã€ç‹€æ…‹ï¼Œç›´æ¥ç™¼å°„ ---
            if (btn.dataset.shareState === 'ready' && window.pendingShareData) {
                navigator.share(window.pendingShareData)
                    .then(() => {
                        resetShareButton(btn); // åˆ†äº«æˆåŠŸå¾Œå¾©åŸ
                    })
                    .catch((err) => {
                        console.log("ä½¿ç”¨è€…å–æ¶ˆåˆ†äº«", err);
                    });
                return;
            }

            // --- [éšæ®µä¸€] æ­£å¸¸æµç¨‹ (ç¬¬ä¸€æ¬¡é»æ“Š) ---
            if (!navigator.geolocation) {
                alert("æ‚¨çš„è£ç½®ä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚");
                return;
            }

            // é˜²æ­¢é‡è¤‡é»æ“Š
            if (btn.dataset.shareState === 'analyzing') return;

            // 1. é–å®šä¸¦è®Šæ›´ç‚ºã€Œé›·é”åˆ†æä¸­ã€å‹•ç•«
            if (!btn.dataset.originalHtml) {
                btn.dataset.originalHtml = btn.innerHTML;
            }

            btn.dataset.shareState = 'analyzing';
            btn.style.pointerEvents = "none";

            // é›·é”å‹•ç•«
            btn.innerHTML = `
                <svg viewBox="0 0 24 24" style="width: 28px; height: 28px; color: #10B981;">
                    <circle cx="12" cy="12" r="4" fill="currentColor"></circle>
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none">
                        <animate attributeName="r" from="4" to="12" dur="1.5s" repeatCount="indefinite" />
                        <animate attributeName="opacity" from="1" to="0" dur="1.5s" repeatCount="indefinite" />
                    </circle>
                </svg>
            `;
            btn.style.background = "#ECFDF5";
            btn.style.borderColor = "#10B981";
            btn.style.color = "#10B981";
            btn.style.opacity = "0.8";

            // 2. åŸ·è¡Œå®šä½ (åŠ ä¸Š async ä»¥æ”¯æ´ await)
            navigator.geolocation.getCurrentPosition(async position => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                const mapUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;

                let locationName = "";
                let locationSource = "";

                try {
                    // --- ç¬¬ä¸€é—œï¼šOSM (Nominatim) ---
                    const osmUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1&accept-language=zh-TW`;
                    const osmRes = await fetch(osmUrl);
                    const osmData = await osmRes.json();

                    if (osmData && osmData.name) {
                        locationName = osmData.name;
                        locationSource = "(OSM)";
                    }

                    // --- ç¬¬äºŒé—œï¼šGoogle Places API (NEW) æ•‘æ´ ---
                    if (!locationName) {
                        console.log("OSM ç„¡åœ°æ¨™åï¼Œå•Ÿç”¨ Google Places æ•‘æ´...");
                        // å‘¼å«æˆ‘å€‘å‰›å‰›æ–°å¢çš„è¼”åŠ©å‡½å¼
                        const googlePlaces = await fetchGooglePlaces(lat, lon, 100);

                        // [ä¿®æ”¹] æ¢ä»¶ï¼šå–ç”¨å—æ­¡è¿åº¦ç¬¬ä¸€(Index 0) çš„çµæœï¼Œä¸¦å„ªå…ˆè®€å–å…¶ Landmark
                        if (googlePlaces.length > 0) {
                            const place = googlePlaces[0];

                            // 1. å„ªå…ˆæª¢æŸ¥æ˜¯å¦æœ‰ã€Œåœ°æ¨™ (landmarks)ã€è³‡è¨Š
                            if (place.addressDescriptor &&
                                place.addressDescriptor.landmarks &&
                                place.addressDescriptor.landmarks.length > 0) {

                                // å–å‡ºç¬¬ä¸€å€‹åœ°æ¨™åç¨± (ä¾‹å¦‚ï¼šç››ç¾¤åŠå°é«”)
                                locationName = place.addressDescriptor.landmarks[0].displayName.text;
                                locationSource = "(Googleåœ°æ¨™)";
                            }
                            // 2. å¦‚æœæ²’æœ‰åœ°æ¨™ï¼Œæ‰ä½¿ç”¨åŸæœ¬çš„åç¨±
                            else if (place.displayName) {
                                locationName = place.displayName.text;
                                locationSource = "(Googleç†±é»)";
                            }
                        }
                    }

                    // --- ç¬¬ä¸‰é—œï¼šOSM é–€ç‰Œåœ°å€ (Fallback) ---
                    if (!locationName && osmData && osmData.address) {
                        const addr = osmData.address;
                        const road = addr.road || addr.pedestrian || "";
                        const houseNum = addr.house_number || "";
                        const suburb = addr.suburb || addr.neighbourhood || "";

                        if (road) {
                            locationName = `${road}${houseNum ? " " + houseNum + "" : ""}`;
                        } else if (suburb) {
                            locationName = suburb;
                        } else {
                            locationName = osmData.display_name.split(',')[0];
                        }
                        locationSource = "(åœ°å€)";
                    }

                    if (!locationName) locationName = "æˆ‘çš„ä½ç½®";
                    console.log(`å®šä½å®Œæˆ: ${locationName} ${locationSource}`);

                } catch (e) {
                    console.error("å®šä½è§£æå¤±æ•—", e);
                    locationName = "æˆ‘çš„ä½ç½®";
                }

                // C. æº–å‚™å…¨åŸŸè³‡æ–™
                window.pendingShareData = {
                    title: 'æˆ‘çš„å³æ™‚ä½ç½®',
                    text: `ã€å ±å¹³å®‰ã€‘æˆ‘ç›®å‰åœ¨ã€Œ${locationName}ã€é™„è¿‘`,
                    url: mapUrl
                };

                // D. å˜—è©¦è§¸ç™¼åˆ†äº«
                try {
                    await navigator.share(window.pendingShareData);
                    resetShareButton(btn);
                } catch (err) {
                    // è¢«é˜»æ“‹æ™‚ï¼Œåˆ‡æ›ç‚ºæ‰‹å‹•ç™¼é€æŒ‰éˆ•
                    console.log("è‡ªå‹•åˆ†äº«æœªè§¸ç™¼ï¼Œåˆ‡æ›ç‚ºæ‰‹å‹•æ¨¡å¼");
                    btn.style.pointerEvents = "auto";

                    /* --- [ä¿®æ”¹] åŠ å…¥å³ä¸Šè§’å–æ¶ˆæŒ‰éˆ• (X) --- */
                    btn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px; animation: popIn 0.3s;">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                        é»æ“Šç™¼é€
                        <div class="share-cancel-badge" onclick="event.stopPropagation(); resetShareButton(this.parentElement);">âœ•</div>
                    `;
                    /* --- [ä¿®æ”¹çµæŸ] --- */

                    btn.style.background = "#10B981";
                    btn.style.borderColor = "#10B981";
                    btn.style.color = "white";
                    btn.style.opacity = "1";
                    btn.dataset.shareState = 'ready';
                    if (navigator.vibrate) navigator.vibrate(50);
                }

            }, error => {
                console.error(error);
                alert("ç„¡æ³•å–å¾—ä½ç½®ï¼Œè«‹ç¢ºèª GPS å·²é–‹å•Ÿã€‚");
                resetShareButton(btn);
            }, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        }
        // è¼”åŠ©å‡½å¼ï¼šé‡ç½®æŒ‰éˆ•
        // è«‹æ›´æ–°é€™å€‹è¼”åŠ©å‡½å¼ (é€šå¸¸åœ¨ç¨‹å¼ç¢¼æœ€ä¸‹æ–¹)
        function resetShareButton(btn) {
            if (btn.dataset.originalHtml) {
                btn.innerHTML = btn.dataset.originalHtml;
            }
            btn.style.background = "";
            btn.style.borderColor = "";
            btn.style.color = "";
            btn.style.opacity = "";
            btn.style.pointerEvents = "auto"; // æ¢å¾©å¯é»æ“Š

            // æ¸…é™¤ç‹€æ…‹æ¨™è¨˜èˆ‡æš«å­˜è³‡æ–™
            delete btn.dataset.shareState;
            window.pendingShareData = null;
        }
        async function submitManualLocation() {
            const manualCity = document.getElementById('modal-city-input').value.trim();
            if (!manualCity) return;

            closeModal();

            const tempEl = document.getElementById('wc-my-temp');
            tempEl.innerText = 'æŸ¥è©¢ä¸­..';
            tempEl.style.color = '#2563EB';
            tempEl.style.fontSize = '1.2rem';

            // --- æ–°å¢ï¼šæ™ºæ…§ç¿»è­¯é‚è¼¯ (èˆ‡å¤©æ°£æŸ¥è©¢åŒæ­¥) ---
            let searchTerm = manualCity;
            let isTranslated = false;

            // 1. æª¢æŸ¥å…§å»ºå°ç…§è¡¨
            for (const key in cityMapping) {
                if (manualCity.includes(key)) {
                    searchTerm = cityMapping[key];
                    isTranslated = true;
                    break;
                }
            }

            // 2. AI èƒŒæ™¯ç¿»è­¯ (è‹¥å°ç…§è¡¨æ²’æœ‰)
            if (!isTranslated) {
                // æç¤ºä½¿ç”¨è€…æ­£åœ¨ç¿»è­¯
                tempEl.innerText = 'ç¿»è­¯ä¸­..';

                const translatePrompt = `
                    Task: Translate the place name "${manualCity}" into its official English Romanization name for using in a Weather API.
                    Target: Global locations (Focus on Taiwan/Japan).
                    Rule: Output ONLY the English name. No explanations.
                    Example: "å°åŒ—" -> "Taipei", "ç”±å¸ƒé™¢" -> "Yufuin", "æ–°ç«¹" -> "Hsinchu".
                `;

                try {
                    const aiTranslation = await getGeminiResponse(translatePrompt);
                    if (/^[a-zA-Z\s\-,]+$/.test(aiTranslation)) {
                        searchTerm = aiTranslation;
                        isTranslated = true;
                        console.log("æ‰‹å‹•ä½ç½® AI ç¿»è­¯çµæœ:", searchTerm);
                    }
                } catch (e) {
                    console.warn("AI ç¿»è­¯å¤±æ•—ï¼Œå°‡ä½¿ç”¨åŸå§‹ä¸­æ–‡æœå°‹");
                }
            }

            tempEl.innerText = 'é€£ç·šä¸­..';
            // --- é‚è¼¯çµæŸ ---

            try {
                // ä½¿ç”¨ Geocoding API æŸ¥è©¢
                // å„ªå…ˆä½¿ç”¨ç¿»è­¯å¾Œçš„è‹±æ–‡æœå°‹ (ç²¾æº–åº¦è¼ƒé«˜)
                // [ä¿®æ”¹] count=10
                let geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(searchTerm)}&count=10&language=en&format=json`;
                let geoRes = await fetch(geoUrl);
                let geoData = await geoRes.json();

                // å¦‚æœè‹±æ–‡æ‰¾ä¸åˆ°ï¼Œå˜—è©¦ç”¨åŸå§‹ä¸­æ–‡æœå°‹ (Fallback)
                if ((!geoData.results || geoData.results.length === 0) && isTranslated) {
                    geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(manualCity)}&count=10&language=zh&format=json`;
                    geoRes = await fetch(geoUrl);
                    geoData = await geoRes.json();
                }

                if (!geoData.results || geoData.results.length === 0) {
                    tempEl.innerText = 'æŸ¥ç„¡æ­¤åœ°';
                    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹ä¸¦é¡¯ç¤ºéŒ¯èª¤
                    setTimeout(() => openModal(`æ‰¾ä¸åˆ°ã€Œ${manualCity}ã€(ç¿»è­¯: ${searchTerm})ï¼Œè«‹å˜—è©¦è¼¸å…¥å…¶ä»–åç¨±ï¼š`), 1000);
                    return;
                }

                // [æ–°å¢] ç¯©é¸é‚è¼¯ (æ‰‹å‹•è¼¸å…¥ä¹Ÿé©ç”¨)
                let targetLocation = geoData.results[0];
                const jpLocation = geoData.results.find(r => r.country_code === 'JP' || r.country === 'Japan');
                // å¦‚æœæ‰‹å‹•è¼¸å…¥çš„åœ°é»æœ‰æ‰¾åˆ°æ—¥æœ¬çš„ï¼Œä¸”ä½¿ç”¨è€…è¼¸å…¥çš„æ˜¯ä¸­æ–‡æˆ–è·Ÿæ—¥æœ¬è¡Œç¨‹ç›¸é—œï¼Œå„ªå…ˆé¸æ—¥æœ¬
                // (é€™è£¡ç°¡å–®åšï¼šåªè¦æœ‰æ—¥æœ¬é¸é …å°±é¸æ—¥æœ¬ï¼Œå› ç‚ºé€™æ˜¯ä¹å·æ—…éŠ App)
                if (jpLocation) {
                    targetLocation = jpLocation;
                }

                const { latitude, longitude } = targetLocation;
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`;
                const weatherRes = await fetch(weatherUrl);
                const weatherData = await weatherRes.json();

                currentMyTemp = weatherData.current_weather.temperature;

                // æ›´æ–° UI
                tempEl.innerText = `${currentMyTemp}Â°C`;
                tempEl.style.fontSize = '1.5rem';
                tempEl.style.color = '#1F2937';

                // æ›´æ”¹æ¨™é¡Œè®“äººçŸ¥é“æ˜¯æ‰‹å‹•çš„ (åŠ å…¥è‹±æ–‡é¡¯ç¤ºï¼Œä¸Šä¸‹åˆ†å±¤)
                const titleEl = document.querySelector('.wc-mini-card .wc-mini-title');

                // é è¨­ HTML çµæ§‹
                let titleHtml = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px;">
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <svg class="icon-mini" style="color: #EF4444;" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                            <span>${manualCity}</span>
                        </div>
                `;

                // è‹¥æœ‰è‹±æ–‡ç¿»è­¯ä¸”ä¸åŒï¼Œå‰‡åŠ å…¥ä¸‹ä¸€è¡Œ
                if (searchTerm && searchTerm.toLowerCase() !== manualCity.toLowerCase()) {
                    titleHtml += `<span style="font-size: 0.75rem; color: #9CA3AF; font-weight: 400; font-family: sans-serif;">${searchTerm}</span>`;
                }

                titleHtml += `</div>`; // Close container
                titleEl.innerHTML = titleHtml;

                const targetTempStr = document.getElementById('wc-temp').innerText;
                if (targetTempStr !== '--Â°') {
                    updateComparison(parseFloat(targetTempStr));
                }

            } catch (e) {
                console.error(e);
                tempEl.innerText = 'å¤±æ•—';
                tempEl.style.color = '#EF4444';
            }
        }

        // [å°ˆå®¶å„ªåŒ–] æº«å·®æ¯”å°ï¼šå‹•æ…‹åœ°é» + é¡è‰²æƒ…ç·’
        function updateComparison(targetTemp) {
            // 1. æª¢æŸ¥æ˜¯å¦æœ‰å®šä½è³‡æ–™
            if (currentMyTemp === null) {
                getLocalWeather(); // å˜—è©¦é‡æ–°å®šä½
                return;
            }

            // 2. å–å¾—æ¯”è¼ƒåŸºæº–çš„åœ°é»åç¨± (é è¨­ç‚ºã€Œæ‚¨çš„ä½ç½®ã€)
            let baseLocName = "æ‚¨çš„ä½ç½®";
            if (window.appCache && window.appCache['my_location_combined']) {
                // å–å‡ºå®šä½æ™‚å­˜ä¸‹çš„åŸå¸‚å (ä¾‹å¦‚: ç«¹åŒ—å¸‚, Taipei)
                const cachedName = window.appCache['my_location_combined'].data.city;
                if (cachedName) {
                    // å¦‚æœåå­—å¤ªé•·ï¼Œæ“·å–å‰å…©å€‹å­—æ¯”è¼ƒç°¡æ½” (ä¾‹å¦‚ "æ–°ç«¹å¸‚æ±å€" -> "æ–°ç«¹")
                    baseLocName = cachedName.length > 3 ? cachedName.substring(0, 2) : cachedName;
                }
            }

            // 3. è¨ˆç®—æº«å·®
            const diff = targetTemp - currentMyTemp;
            const diffAbs = Math.abs(diff).toFixed(1);

            // 4. å–å¾— UI å…ƒç´ 
            const box = document.getElementById('wc-diff-box');
            const title = document.getElementById('wc-diff-title');
            const val = document.getElementById('wc-diff-val');

            // 5. é¡è‰²èˆ‡æ–‡å­—é‚è¼¯
            if (diff > 0) {
                // ğŸ¥µ ç›®çš„åœ°æ¯”è¼ƒç†± (æš–è‰²ç³»)
                box.style.background = '#FFF7ED'; // æ·ºæ©˜åº•
                box.style.color = '#9A3412';      // æ·±æ©˜è¤å­—
                /*box.style.borderColor = '#FED7AA'; // æ©˜é‚Šæ¡†*/

                title.innerText = `æ¯”${baseLocName}ç†±`;
                val.innerText = `+${diffAbs}Â°C`;

            } else if (diff < 0) {
                // ğŸ¥¶ ç›®çš„åœ°æ¯”è¼ƒå†· (å†·è‰²ç³»)
                box.style.background = '#EFF6FF'; // æ·ºè—åº•
                box.style.color = '#1E40AF';      // æ·±è—å­—
                /*box.style.borderColor = '#BFDBFE'; // è—é‚Šæ¡†*/

                title.innerText = `æ¯”${baseLocName}å†·`;
                val.innerText = `-${diffAbs}Â°C`;

            } else {
                // ğŸ˜ æº«åº¦ç›¸åŒ
                box.style.background = '#F3F4F6';
                box.style.color = '#4B5563';
                /*box.style.borderColor = 'transparent';*/

                title.innerText = `èˆ‡${baseLocName}`;
                val.innerText = `æº«å·®å°`;
            }
        }

        async function askAiWeatherAdvice(city, temp, condition) {
            // [æ–°å¢] 1. ç”¢ç”Ÿå¿«å–é‡‘é‘° (åœ°é» + æ°£æº«æ•´æ•¸ + å¤©æ°£ç‹€æ³)
            // é€™æ¨£å¦‚æœæº«åº¦åªå·® 0.1 åº¦ï¼Œæˆ–æ˜¯å¤©æ°£ä¸€æ¨£ï¼Œå°±ä¸ç”¨é‡æ–°å• AI
            const cacheKey = `ai_advice_${city}_${Math.round(temp)}_${condition}`;

            // [æ–°å¢] 2. å…ˆæŸ¥å¿«å–
            const cachedAdvice = CACHE_SYSTEM.get(cacheKey);
            if (cachedAdvice) {
                console.log("ä½¿ç”¨å¿«å–ç©¿è¡£å»ºè­°");
                document.getElementById('wc-advice').innerText = cachedAdvice;
                return;
            }

            // ç„¡å¿«å–ï¼Œæ‰åŸ·è¡Œ AI è«‹æ±‚
            const prompt = `
                ç¾åœ¨${city}çš„å³æ™‚æ°£æº«æ˜¯ ${temp}åº¦ï¼Œå¤©æ°£ç‹€æ³ç‚º${condition}ã€‚
                è«‹ä»¥ã€Œæ—…éŠå°ç§˜æ›¸ã€çš„å£å»ï¼Œçµ¦äºˆå°ç£æ—…å®¢ç°¡çŸ­çš„ç©¿è¡£å»ºè­°ï¼ˆç´„50å­—ï¼‰ã€‚
                è«‹åŒ…å«é«”æ„Ÿæè¿°ï¼ˆä¾‹å¦‚ï¼šæ˜¯å¦éœ€è¦ç™¼ç†±è¡£ã€åœå·¾ç­‰ï¼‰ã€‚
            `;

            try {
                const text = await getGeminiResponse(prompt);
                document.getElementById('wc-advice').innerText = text;

                // [æ–°å¢] 3. å­˜å…¥å¿«å– (ä¿å­˜ 60 åˆ†é˜)
                CACHE_SYSTEM.save(cacheKey, text, 30);

            } catch (e) {
                document.getElementById('wc-advice').innerText = 'AI é€£ç·šé€¾æ™‚ï¼Œå»ºè­°æ´‹è”¥å¼ç©¿æ­ã€‚';
            }
        }

        // --- END REAL-TIME WEATHER ---

        // [ä¿®æ”¹] åˆ‡æ›åˆ†é å‡½å¼ - åŠ å…¥å·¦å³æ»‘å‹•å‹•ç•«åˆ¤æ–·
        function switchTab(element) {
            // ç§»é™¤æ‰€æœ‰ active
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.container').forEach(container => {
                container.classList.remove('active');
                // æ¸…é™¤æ®˜ç•™æ¨£å¼
                container.style.transform = '';
                container.style.opacity = '';
                container.style.filter = '';
            });

            // è¨­å®š active
            element.classList.add('active');
            const targetId = element.getAttribute('data-target');
            document.getElementById(targetId).classList.add('active');

            window.scrollTo(0, 0);
            // å¦‚æœåˆ‡æ›åˆ°ã€Œæ—…ç¨‹è¨˜éŒ„ã€åˆ†é ï¼Œå¼·åˆ¶åˆå§‹åŒ–é ­åƒé¸å–®
            if (targetId === 'view-ledger') {
                // ä½¿ç”¨ setTimeout ç¢ºä¿ DOM å·²ç¶“å®Œå…¨é¡¯ç¤ºå¾Œå†åŸ·è¡Œ
                setTimeout(() => {
                    if (typeof initAvatarSelector === 'function') {
                        initAvatarSelector();
                    }
                }, 50);
            }
        }

        function toggleTimeline(id, toggleElement) {
            const timeline = document.getElementById(id);
            // If opening a new day
            if (!timeline.classList.contains('show')) {
                // Collapse others
                document.querySelectorAll('.timeline.show').forEach(t => t.classList.remove('show'));
                document.querySelectorAll('.day-toggle.open').forEach(t => t.classList.remove('open'));

                // Show target
                timeline.classList.add('show');
                toggleElement.classList.add('open');

                // Update Weather!
                updateWeatherWidget(id);
            } else {
                // Closing the current day
                timeline.classList.remove('show');
                toggleElement.classList.remove('open');

                // â˜…â˜…â˜… [ä¿®æ”¹] æª¢æŸ¥æ˜¯å¦é‚„æœ‰å…¶ä»–æ‘ºé æ˜¯é–‹è‘—çš„ï¼Ÿ
                // å¦‚æœæ²’æœ‰ä»»ä½• .timeline.show äº†ï¼Œä»£è¡¨å…¨éƒ¨é—œé–‰ -> é‚„åŸå›æˆ‘çš„ä½ç½®
                if (!document.querySelector('.timeline.show')) {
                    resetHeaderToLocal();
                }
            }
        }

        // AI Functions - UI Interaction Part
        const chatHistory = document.getElementById('chat-history');
        const aiInput = document.getElementById('ai-user-input');
        const aiTitle = document.getElementById('ai-modal-title');
        const aiInputArea = document.getElementById('ai-input-area');
        const btnBackTrans = document.getElementById('btn-back-trans');

        // Initial Greeting
        // [ä¿®æ”¹] åˆå§‹åŒ–æ­¡è¿è¨Šæ¯ (åŠ å…¥å°æ‡‰æŒ‰éˆ•çš„é¡è‰²èˆ‡åœ–ç¤º)
        function initAiChat() {
            if (chatHistory.children.length === 0) {
                // å®šç¾©æ¨£å¼è®Šæ•¸ï¼Œè®“ç¨‹å¼ç¢¼è¼ƒæ•´æ½”
                const iconStyle = 'width:16px; height:16px; vertical-align:text-bottom; margin-right:2px; display:inline-block;';
                const spanStyle = 'font-weight:700; display:inline-flex; align-items:center; vertical-align:middle; margin:0 2px;';

                // 1. è¡Œç¨‹è«®è©¢ (è—è‰²)
                const iconConsult = `<svg style="${iconStyle}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon></svg>`;
                const txtConsult = `<span style="${spanStyle} color:#2563EB;">${iconConsult}è¡Œç¨‹è«®è©¢</span>`;

                // 2. ä¸­/æ—¥ç¿»è­¯ (å¤©ç©ºè—)
                const iconTrans = `<svg style="${iconStyle}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 10h14"></path><path d="M17 6l4 4-4 4"></path><path d="M17 14H3"></path><path d="M7 18l-4-4 4-4"></path></svg>`;
                const txtTrans = `<span style="${spanStyle} color:#0EA5E9;">${iconTrans}ä¸­/æ—¥ç¿»è­¯</span>`;

                // 3. èªéŸ³è¼¸å…¥ (é’è‰²)
                const iconVoice = `<svg style="${iconStyle}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>`;
                const txtVoice = `<span style="${spanStyle} color:#06B6D4;">${iconVoice}èªéŸ³è¼¸å…¥</span>`;

                // 4. æ‹ç…§è¾¨è­˜ (ç´«è‰²/ç²‰è‰²)
                const iconCam = `<svg style="${iconStyle}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>`;
                const txtCam = `<span style="${spanStyle} color:#D946EF;">${iconCam}æ‹ç…§è¾¨è­˜</span>`;

                const welcomeHtml = `
                    ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ä¹å·æ—…éŠ AI åŠ©æ‰‹ã€‚
                    <br><br>
                    ä½ å¯ä»¥é»é¸ä¸‹æ–¹çš„ ${txtConsult} è©¢å•è·¯ç·šï¼Œæˆ–ä½¿ç”¨ ${txtTrans} èˆ‡ç•¶åœ°äººæºé€šã€‚
                    é»é¸ ${txtVoice} æ­é…èªè¨€åˆ‡æ›é‚„èƒ½ç”¨èªªçš„å–”ï¼
                    æ›´æœ‰ ${txtCam} åŠŸèƒ½å¯ä»¥æ–¹ä¾¿é»é¤åŠç²å¾—å•†å“è³‡è¨Šã€‚
                `;
                appendMessage('ai', welcomeHtml);
            }
        }

        // Function to switch to AI tab programmatically
        function goToAiTab() {
            const aiTabBtn = document.querySelector('[data-target="view-ai"]');
            switchTab(aiTabBtn);
        }

        function showAiTranslatorMode() {
            // ä¿®æ­£ 3: JS å‹•æ…‹åˆ‡æ›æ¨™é¡Œæ™‚ä¹Ÿè¦ç”¨ SVG
            const iconSvg = '<svg class="icon-mini" style="width: 24px; height: 24px; color: #F59E0B; margin-right: 8px;" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>';
            aiTitle.innerHTML = iconSvg + '<span>éš¨èº« AI ç¿»è­¯èˆ‡åŠ©æ‰‹</span>';
            aiInputArea.style.display = 'block';
            btnBackTrans.style.display = 'none';
            // Scroll to bottom
            chatHistory.scrollTop = chatHistory.scrollHeight;
            setupVoiceButton();
        }

        // Append Message Bubble
        // [ä¿®æ”¹] è¨Šæ¯é¡¯ç¤ºå‡½å¼ï¼šç§»é™¤è‡ªå‹•æœ—è®€ï¼Œæ”¹ç‚ºå…¨æ‰‹å‹•æ’­æ”¾
        function appendMessage(sender, htmlContent, isAudio = false) {
            const row = document.createElement('div');
            row.className = `chat-row ${sender}`;

            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${sender}`;
            bubble.innerHTML = htmlContent;

            // è‹¥ç‚º AI å›è¦†ä¸”æ¨™è¨˜ç‚ºå¯æœ—è®€ (isAudio=true)ï¼ŒåŠ å…¥å–‡å­æŒ‰éˆ•
            if (sender === 'ai' && isAudio) {
                const btn = document.createElement('button');
                btn.className = 'btn-audio-inline';
                // å–‡å­åœ–ç¤º
                btn.innerHTML = '<svg viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>';

                // å–å¾—ç´”æ–‡å­— (ç§»é™¤ HTML æ¨™ç±¤èˆ‡åœ–ç¤ºæ–‡å­—) ä»¥ä¾›æœ—è®€
                const textToSpeak = bubble.innerText.replace('ğŸ”Š', '').trim();

                // ç¶å®šé»æ“Šäº‹ä»¶ (åªæœ‰é»æ“Šæ™‚æ‰ç™¼è²)
                btn.onclick = () => speakText(textToSpeak);

                bubble.appendChild(btn);

                // â˜… å·²ç§»é™¤ï¼šsetTimeout(() => speakText(textToSpeak), 200); 
                // ç¾åœ¨ä¸æœƒè‡ªå‹•æ’­æ”¾äº†ï¼
            }

            row.appendChild(bubble);
            chatHistory.appendChild(row);

            // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
            chatHistory.scrollTop = chatHistory.scrollHeight;

            return bubble;
        }

        // [æ–°å¢] å…¨åŸŸè¼‰å…¥æŒ‡ç¤ºå™¨ (ç”¨æ–¼è¨˜å¸³èˆ‡ç³»çµ±æ“ä½œ)
        function showGlobalLoading() {
            if (document.getElementById('global-loading-overlay')) return;

            const overlay = document.createElement('div');
            overlay.id = 'global-loading-overlay';
            overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:99999; display:flex; justify-content:center; align-items:center; backdrop-filter:blur(2px);';
            overlay.innerHTML = '<div style="background:white; padding:20px 30px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.2); display:flex; flex-direction:column; align-items:center;">' +
                '<div class="loading-spinner" style="border:4px solid #f3f3f3; border-top:4px solid #2563EB; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin-bottom:10px;"></div>' +
                '<div style="font-weight:bold; color:#374151;">Loading...</div>' +
                '<style>@keyframes spin {0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);}}</style>' +
                '</div>';
            document.body.appendChild(overlay);
        }

        function hideGlobalLoading() {
            const overlay = document.getElementById('global-loading-overlay');
            if (overlay) overlay.remove();
        }

        function showLoading() {
            // ã€æœ‰ä¸€èªªä¸€ã€‘ç›´æ¥æŠ“å– AI æ­·å²ç´€éŒ„å®¹å™¨
            const chatHistoryContainer = document.getElementById('chat-history');

            // å¦‚æœæŠ“ä¸åˆ°å®¹å™¨ï¼ˆè¡¨ç¤ºä¸åœ¨ AI åˆ†é ï¼‰ï¼Œå°±å®‰éœçµæŸï¼Œä¸è¦å ±éŒ¯ä¹Ÿä¸è¦ return å½±éŸ¿åˆ¥äºº
            if (!chatHistoryContainer) return;

            const row = document.createElement('div');
            row.className = 'chat-row ai loading-row';
            row.id = 'loading-indicator';

            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble ai loading-bubble';
            bubble.innerHTML = 'AI æ­£åœ¨æ€è€ƒä¸­<span class="loading-dots"></span>';

            row.appendChild(bubble);
            chatHistoryContainer.appendChild(row);
            chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
        }

        function removeLoading() {
            const loading = document.getElementById('loading-indicator');
            if (loading) loading.remove();
        }

        // Helper to update placeholder based on selection
        function updatePlaceholder() {
            const lang = document.querySelector('input[name="voice_lang"]:checked').value;
            const input = document.getElementById('ai-user-input');
            if (lang === 'zh-TW') {
                input.placeholder = 'è«‹è¼¸å…¥ä¸­æ–‡ (æˆ–ä½¿ç”¨èªéŸ³)...';
            } else {
                input.placeholder = 'è«‹è¼¸å…¥æ—¥æ–‡ (æˆ–åˆ‡æ›èªéŸ³)...';
            }
        }

        // [ä¿®æ”¹] æ–‡å­—è½‰èªéŸ³å‡½å¼ (éæ¿¾ç¾…é¦¬æ‹¼éŸ³ï¼Œåªå”¸æ—¥æ–‡)
        // [ä¿®æ”¹] æ–‡å­—è½‰èªéŸ³å‡½å¼ (å¼·åŠ›éæ¿¾ç‰ˆ)
        // [ä¿®æ”¹] æ–‡å­—è½‰èªéŸ³å‡½å¼ (éæ¿¾ç¾…é¦¬æ‹¼éŸ³ + éæ¿¾æ˜Ÿè™Ÿ)
        // [ä¿®æ”¹] æ–‡å­—è½‰èªéŸ³å‡½å¼ (å¼·åŠ›éæ¿¾ï¼šæ‹¬è™Ÿã€æ˜Ÿè™Ÿã€æ‰€æœ‰è‹±æ–‡å­—æ¯éƒ½ä¸å”¸)
        function speakText(text) {
            speechSynthesis.cancel(); // åœæ­¢ä¸Šä¸€å¥

            let cleanText = text;

            // 1. ç§»é™¤æ‹¬è™Ÿ (...) åŠå…¶å…§å®¹
            cleanText = cleanText.replace(/\([^\)]+\)/g, '');

            // 2. ç§»é™¤æ˜Ÿè™Ÿ (*)
            cleanText = cleanText.replace(/\*/g, '');

            // 3. â˜… é—œéµä¿®æ­£ï¼šç§»é™¤æ‰€æœ‰ç¾…é¦¬æ‹¼éŸ³/è‹±æ–‡å­—æ¯ (å«é•·éŸ³ç¬¦è™Ÿ)
            // é€™æ¨£å°±ç®—æ‹¼éŸ³æ²’æœ‰æ‹¬è™Ÿ (å¦‚ BebÄ«chea)ï¼Œä¹Ÿæœƒè¢«åˆªé™¤ï¼Œä¸æœƒå”¸å‡ºä¾†
            cleanText = cleanText.replace(/[a-zA-ZÄÄ“Ä«ÅÅ«Ä€Ä’ÄªÅŒÅª]+/g, '');

            // 4. å»é™¤å‰å¾Œèˆ‡å¤šé¤˜ç©ºç™½
            cleanText = cleanText.trim();

            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'ja-JP'; // è¨­å®šèªè¨€ç‚ºæ—¥æ–‡
            utterance.rate = 0.9;     // èªé€Ÿç¨æ…¢

            // å˜—è©¦å–å¾—è¼ƒè‡ªç„¶çš„æ—¥æ–‡èªéŸ³åŒ…
            const voices = speechSynthesis.getVoices();
            const jaVoice = voices.find(v => v.lang.includes('ja'));
            if (jaVoice) utterance.voice = jaVoice;

            speechSynthesis.speak(utterance);
        }

        // Voice Recognition Logic
        // [ä¿®æ­£] å°‡ recognition ç§»å‡ºå‡½å¼ï¼Œé¿å…é‡è¤‡å®£å‘Š
        let recognition = null;

        function setupVoiceButton() {
            // [ä¿®æ­£] å¦‚æœå·²ç¶“åˆå§‹åŒ–éï¼Œå°±ç›´æ¥çµæŸï¼Œé˜²æ­¢é‡è¤‡ç¶å®šäº‹ä»¶
            if (recognition) return;

            const voiceBtn = document.getElementById('btn-voice-ja');
            if (!voiceBtn) return;

            // é˜²æ­¢é•·æŒ‰è·³å‡ºé¸å–®
            voiceBtn.oncontextmenu = (e) => { e.preventDefault(); return false; };

            // let recognition; <--- [ä¿®æ­£] é€™è¡Œåˆªé™¤ï¼Œæ”¹ç”¨ä¸Šé¢çš„å…¨åŸŸè®Šæ•¸

            // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´åº¦
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();

                // è¨­å®šé€£çºŒæ¨¡å¼ï¼šè®“ iOS ä¸æœƒè¬›ä¸€å¥è©±å°±è‡ªå·±æ–·ç·šï¼Œè€Œæ˜¯ç”±æˆ‘å€‘ç¨‹å¼æ§åˆ¶ä½•æ™‚æ–·
                recognition.continuous = true;
                recognition.interimResults = true;

                // --- [é—œéµä¿®æ­£ 1] è¨­å®šèªè¨€èˆ‡ UI ç‹€æ…‹ (onstart) ---
                recognition.onstart = function () {
                    voiceBtn.classList.add('recording');

                    // å–å¾—ç•¶å‰é¸æ“‡çš„èªè¨€åç¨±ï¼Œæ›´æ–°æŒ‰éˆ•æ–‡å­—
                    const selectedLang = document.querySelector('input[name="voice_lang"]:checked').value;
                    const langText = selectedLang === 'zh-TW' ? 'ä¸­æ–‡' : 'æ—¥æ–‡';

                    voiceBtn.innerHTML = `<span style="animation: pulse 1s infinite;">ğŸ”´ è†è½${langText}...</span>`;
                    document.getElementById('ai-user-input').placeholder = `æ­£åœ¨è†è½${langText} (èªªå®Œè‡ªå‹•åœæ­¢)...`;
                };

                // --- [é—œéµä¿®æ­£ 2] çµæŸæ™‚é‡ç½®æŒ‰éˆ• (onend) ---
                recognition.onend = function () {
                    voiceBtn.classList.remove('recording');
                    voiceBtn.innerHTML = `
                        <svg class="icon-sprite"><use href="#icon-voice"></use></svg>
                        èªéŸ³è¼¸å…¥
                    `;
                    updatePlaceholder();
                };

                // --- [é—œéµä¿®æ­£ 3] éŒ¯èª¤è™•ç† (onerror) ---
                // éæ¿¾æ‰ iPhone å¸¸è¦‹çš„è‰¯æ€§éŒ¯èª¤ï¼Œä¸å†è·³å‡ºç…©äººçš„ Alert
                recognition.onerror = function (event) {
                    console.log('Voice Error:', event.error);

                    // å¿½ç•¥ "no-speech" (æ²’è½åˆ°è²éŸ³) å’Œ "aborted" (æ‰‹å‹•åœæ­¢)
                    if (event.error === 'no-speech' || event.error === 'aborted') {
                        // éœé»˜å¤±æ•—ï¼Œåªç§»é™¤éŒ„éŸ³ç‹€æ…‹ï¼Œä¸æ“¾æ°‘
                        voiceBtn.classList.remove('recording');
                        return;
                    }

                    // åªæœ‰çœŸæ­£çš„éŒ¯èª¤æ‰è·³é€šçŸ¥
                    voiceBtn.classList.remove('recording');
                    alert("èªéŸ³é€£ç·šä¸­æ–·ï¼Œè«‹é‡æ–°é»æ“ŠæŒ‰éˆ•ã€‚");
                };

                // --- [æ ¸å¿ƒé‚è¼¯] è™•ç†è¾¨è­˜çµæœ (onresult) ---
                recognition.onresult = function (event) {
                    let finalTranscript = '';

                    // çµ„åˆæ‰€æœ‰å·²ç¢ºèªçš„ç‰‡æ®µ
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        }
                    }

                    // å¦‚æœæœ‰åµæ¸¬åˆ°å®Œæ•´çš„å¥å­
                    if (finalTranscript.trim().length > 0) {
                        recognition.stop(); // 1. è½åˆ°é€™å¥è©±å°±ç«‹åˆ»åœæ­¢éŒ„éŸ³

                        // 2. å¡«å…¥è¼¸å…¥æ¡†é¡¯ç¤ºçµ¦ä½¿ç”¨è€…çœ‹
                        document.getElementById('ai-user-input').value = finalTranscript;

                        // 3. ç›´æ¥ç™¼é€çµ¦ AI é€²è¡Œç¿»è­¯
                        sendToGemini('voice_direct');
                    }
                };

                // --- [é—œéµä¿®æ­£ 4] æŒ‰éˆ•é»æ“Šäº‹ä»¶ ---
                voiceBtn.onclick = (e) => {
                    if (e && e.cancelable) e.preventDefault();

                    if (voiceBtn.classList.contains('recording')) {
                        // å¦‚æœæ­£åœ¨éŒ„éŸ³ï¼ŒæŒ‰ä¸€ä¸‹å‰‡åœæ­¢
                        recognition.stop();
                    } else {
                        // â˜…â˜…â˜… ä¿®æ­£é‡é»ï¼šåœ¨ start() ä¹‹å‰è¨­å®šèªè¨€ï¼ â˜…â˜…â˜…
                        const selectedLang = document.querySelector('input[name="voice_lang"]:checked').value;
                        recognition.lang = selectedLang;

                        try {
                            recognition.start();
                        } catch (err) {
                            console.error("å•Ÿå‹•å¤±æ•—:", err);
                        }
                    }
                };

            } else {
                voiceBtn.style.display = 'none';
                alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥åŠŸèƒ½');
            }
        }

        function askGeminiGuide(spotName, customPrompt) {
            goToAiTab();
            // ä¿®æ­£ 4: å°è¦½æ¨¡å¼æ¨™é¡Œåœ–ç¤ºä¹Ÿçµ±ä¸€
            const iconSvg = '<svg class="icon-mini" style="width: 24px; height: 24px; color: #F59E0B; margin-right: 8px;" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>';
            aiTitle.innerHTML = iconSvg + `<span>${spotName} å°æ•…äº‹</span>`;
            aiInputArea.style.display = 'none';
            btnBackTrans.style.display = 'block';

            // Add system message to chat indicating start
            appendMessage('ai', `æ­£åœ¨ç‚ºæ‚¨ç”Ÿæˆé—œæ–¼ã€Œ${spotName}ã€çš„æ•…äº‹...`);

            const prompt = `
                ä½ æ˜¯ä¸€ä½å¸¶é ˜è¦ªå­æ—…éŠçš„ä¹å·å°éŠã€‚
                è«‹é‡å°æ™¯é»ã€Œ${spotName}ã€ç”Ÿæˆä¸€æ®µçµ¦ 5-8 æ­²å°å­©è½çš„å°è¦½è©ã€‚
                è¦æ±‚ï¼š
                1. èªæ°£ç”Ÿå‹•æ´»æ½‘ï¼Œä½¿ç”¨å°ç£ç¹é«”ä¸­æ–‡ã€‚
                2. å…§å®¹åŒ…å«ä¸€å€‹é—œæ–¼è©²æ™¯é»çš„æœ‰è¶£å†·çŸ¥è­˜ã€‚
                3. çµ¦å­©å­ä¸€å€‹ã€Œå°å°è§€å¯Ÿä»»å‹™ã€ï¼ˆä¾‹å¦‚ï¼šæ‰¾æ‰¾çœ‹æŸå€‹é¡è‰²çš„æ±è¥¿ï¼‰ã€‚
                4. æ•´é«”é•·åº¦æ§åˆ¶åœ¨ 150 å­—ä»¥å…§ã€‚
                5. ${customPrompt}
            `;

            callGemini(prompt);
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendToGemini('auto');
        }

        // [ä¿®æ”¹] AI ç™¼é€é‚è¼¯ï¼šæ•´åˆç³»çµ±è¨˜æ†¶èˆ‡å¤šç¨®æ¨¡å¼
        // [ä¿®æ”¹] AI ç™¼é€é‚è¼¯ï¼šåŠ å…¥ã€Œæƒ…å¢ƒæ„ŸçŸ¥ã€èƒ½åŠ›
        // [ä¿®æ”¹] AI ç™¼é€é‚è¼¯ï¼šæ•´åˆè¨˜æ†¶ã€å¤©æ°£æ„ŸçŸ¥ã€ä»¥åŠã€Œç¾…é¦¬æ‹¼éŸ³ã€ç¿»è­¯
        // [ä¿®æ”¹] AI ç™¼é€é‚è¼¯ï¼šä¾æ“šç¿»è­¯æ–¹å‘æ±ºå®šæ˜¯å¦é¡¯ç¤ºæ‹¼éŸ³
        // [ä¿®æ”¹] AI ç™¼é€é‚è¼¯ï¼šåŠ å…¥ã€Œé€£çºŒå°è©±è¨˜æ†¶ã€åŠŸèƒ½
        // [ä¿®æ”¹] AI ç™¼é€é‚è¼¯ï¼šä¿®å¾©ã€Œè«®è©¢æ¨¡å¼ã€èª¤åˆ¤ç‚ºç¿»è­¯çš„å•é¡Œ
        async function sendToGemini(mode) {
            const text = aiInput.value.trim();
            if (!text) return;

            // é¡¯ç¤ºä½¿ç”¨è€…çš„è©±
            appendMessage('user', text);
            aiInput.value = '';

            let finalPrompt = "";

            // å–å¾—ç›®å‰é¸æ“‡çš„èªè¨€
            const selectedLang = document.querySelector('input[name="voice_lang"]:checked').value;
            const isInputZh = selectedLang === 'zh-TW';

            // --- æ¨¡å¼ A: è¡Œç¨‹è«®è©¢ ---
            if (mode === 'consult' || mode === 'auto') {
                let liveContext = "";
                if (window.appCache && window.appCache['my_location_combined']) {
                    const d = window.appCache['my_location_combined'].data;
                    liveContext = `ç›®å‰ä½ç½®ï¼š${d.city}, å¤©æ°£ï¼š${d.code}, æ°£æº«ï¼š${d.temp}Â°C`;
                }
                const historyText = conversationHistory.join('\n');

                finalPrompt = `
                    ${systemPrompt}
                    ${liveContext}
                    ${historyText}
                    ã€ä½¿ç”¨è€…å•é¡Œã€‘ï¼š "${text}"
                `;
            }
            // --- æ¨¡å¼ B: æ‰‹å‹•æŒ‰ç¿»è­¯æŒ‰éˆ• ---
            else if (mode === 'translate') {
                finalPrompt = `
                    Role: Professional JP/TW Translator.
                    Input: "${text}"
                    Rules:
                    1. If input is Chinese -> Translate to Japanese (Polite). Add Pronunciation.
                    2. If input is Japanese -> Translate to Traditional Chinese.
                    Output: Translation result ONLY.
                `;
            }
            // --- æ¨¡å¼ C: èªéŸ³ç›´é”ç¿»è­¯ (Voice Direct) ---
            else if (mode === 'voice_direct') {
                if (isInputZh) {
                    // ä½¿ç”¨è€…èªªä¸­æ–‡ -> ç¿»æˆæ—¥æ–‡çµ¦åº—å“¡è½
                    finalPrompt = `
                        Task: Translate this Traditional Chinese text to Japanese (Polite form).
                        Input: "${text}"
                        Output: ONLY the Japanese translation text. NO Romaji. NO explanations.
                     `;
                } else {
                    // ä½¿ç”¨è€…(æˆ–åº—å“¡)èªªæ—¥æ–‡ -> ç¿»æˆä¸­æ–‡çµ¦è‡ªå·±çœ‹
                    finalPrompt = `
                        Task: Translate this Japanese text to Traditional Chinese (Taiwan).
                        Input: "${text}"
                        Output: ONLY the Chinese translation. NO English. NO Romanization.
                     `;
                }
            }

            showLoading();
            try {
                const responseText = await getGeminiResponse(finalPrompt);
                removeLoading();

                // æ±ºå®šæ˜¯å¦é¡¯ç¤ºå–‡å­æŒ‰éˆ•
                let showAudioBtn = false;

                if (mode === 'voice_direct') {
                    // é‚è¼¯ï¼šå¦‚æœä½ èªªä¸­æ–‡(isInputZh)ï¼Œä»£è¡¨ä½ è¦ç¿»æˆæ—¥æ–‡çµ¦åˆ¥äººè½ -> é¡¯ç¤ºå–‡å­
                    if (isInputZh) {
                        showAudioBtn = true;
                    }
                    // å¦‚æœä½ éŒ„çš„æ˜¯æ—¥æ–‡ï¼Œä»£è¡¨æ˜¯ç¿»è­¯æˆä¸­æ–‡çµ¦è‡ªå·±çœ‹ -> ä¸é¡¯ç¤ºå–‡å­
                } else {
                    // æ‰‹å‹•ç¿»è­¯æ¨¡å¼ï¼šåªè¦çµæœæœ‰æ—¥æ–‡å°±é¡¯ç¤ºå–‡å­
                    showAudioBtn = (mode === 'translate') && /[\u3040-\u309F\u30A0-\u30FF]/.test(responseText);
                }

                const formattedText = responseText.replace(/\n/g, '<br>');
                appendMessage('ai', formattedText, showAudioBtn);

                // å¯«å…¥æ­·å²ç´€éŒ„ (è«®è©¢æ¨¡å¼æ‰éœ€è¦)
                if (mode === 'consult' || mode === 'auto') {
                    conversationHistory.push(`User: ${text}`);
                    conversationHistory.push(`Guide: ${responseText}`);
                    if (conversationHistory.length > 20) conversationHistory = conversationHistory.slice(-20);
                }

            } catch (e) {
                removeLoading();
                appendMessage('ai', `<span style="color:red">é€£ç·šéŒ¯èª¤: ${e.message}</span>`);
            }
        }

        async function callGemini(promptText) {
            showLoading();

            try {
                // æ”¹ç”¨æ–°çš„å…±ç”¨å‡½æ•¸ getGeminiResponse
                let rawText = await getGeminiResponse(promptText);
                removeLoading();

                // Check for Japanese chars to decide if we show audio button
                const hasJapanese = /[\u3040-\u309F\u30A0-\u30FF]/.test(rawText);
                const isTranslation = hasJapanese && rawText.length < 500;

                // Format text (convert newlines to <br>)
                const formattedText = rawText.replace(/\n/g, '<br>');

                appendMessage('ai', formattedText, isTranslation);

            } catch (error) {
                removeLoading();
                console.error('Gemini API Error:', error);
                appendMessage('ai', `<span style="color:red">ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚<br>Error: ${error.message}</span>`);
            }
        }
        function resetAppPassword() {
            if (confirm("æ‚¨ç¢ºå®šè¦æ¸…é™¤å·²è¨˜æ†¶çš„å¯†ç¢¼ä¸¦é‡æ–°è¼¸å…¥å—ï¼Ÿ")) {
                localStorage.removeItem("app_password"); // æ¸…é™¤ç€è¦½å™¨è¨˜æ†¶
                alert("å¯†ç¢¼å·²æ¸…é™¤ï¼é é¢å°‡é‡æ–°æ•´ç†ï¼Œè«‹é‡æ–°è¼¸å…¥æ–°å¯†ç¢¼ã€‚");
                window.location.reload(); // é‡æ–°æ•´ç†ç¶²é 
            }
        }
        // [ä¿®æ”¹] è¡Œå‰æ¸…å–®åŠŸèƒ½ï¼šæ”¯æ´å‹•æ…‹æ–°å¢ã€åˆªé™¤èˆ‡ç‹€æ…‹å„²å­˜
        const CHECKLIST_KEY = 'kyushu_trip_checklist_v2'; // æ”¹ç”¨æ–° Key é¿å…èˆŠè³‡æ–™è¡çª

        // é è¨­æ¸…å–®è³‡æ–™ (è‹¥ä½¿ç”¨è€…ç¬¬ä¸€æ¬¡é–‹å•Ÿ)
        const defaultItems = [
            { id: 'c1', text: 'æ©Ÿå ´åœè»Šé ç´„ (æˆªåœ–å‚™ä»½)', checked: false },
            { id: 'c2', text: 'è­·ç…§ & æ©Ÿç¥¨ (æˆªåœ–å‚™ä»½)', checked: false },
            { id: 'c3', text: 'æ—…éŠä¿éšªå–® (ç´™æœ¬/é›»å­)', checked: false },
            { id: 'c4', text: 'æ—¥å¹£ç¾é‡‘ & ä¿¡ç”¨å¡ & è¥¿ç“œå¡', checked: false },
            { id: 'c5', text: 'eSIM / æ¼«éŠé–‹é€š', checked: false },
            { id: 'c6', text: 'Visit Japan Web å¡«å¯«', checked: false },
            { id: 'c7', text: 'è¡Œå‹•é›»æº & å……é›»ç·š & è»Šå……', checked: false },
            { id: 'c8', text: 'åœ‹éš›é§•ç…§ (æ—¥æ–‡è­¯æœ¬)', checked: false },
            { id: 'c9', text: 'ç‰™åˆ·/å¸¸å‚™è—¥å“', checked: false },
            { id: 'c10', text: 'å¥ä¿å¡ / å¤§é ­ç…§', checked: false },
            { id: 'c11', text: 'å°å·¥å…·é†«ç™‚ç®± / é›ªæ¾', checked: false },
            { id: 'c12', text: 'è€³æº«æ§ / åˆ®é¬åˆ€', checked: false },
            { id: 'c13', text: 'ç›¸æ©Ÿ / è®€å¡æ©Ÿ / æ‹ç«‹å¾—', checked: false },
            { id: 'c14', text: 'æ‰‹å¥— / è„–åœ', checked: false }
        ];

        let checklistData = [];

        function initChecklist() {
            // 1. è®€å–è³‡æ–™
            const saved = localStorage.getItem(CHECKLIST_KEY);
            if (saved) {
                try {
                    checklistData = JSON.parse(saved);
                } catch (e) {
                    checklistData = JSON.parse(JSON.stringify(defaultItems));
                }
            } else {
                checklistData = JSON.parse(JSON.stringify(defaultItems)); // æ·±æ‹·è²
            }
            renderChecklist();
        }

        // æ¸²æŸ“æ¸…å–®ç•«é¢ (åŒ…å«è¨ˆç®—é€²åº¦)
        function renderChecklist() {
            const listArea = document.getElementById('checklist-list-area');
            const progressEl = document.getElementById('checklist-progress');
            if (!listArea) return;

            listArea.innerHTML = ''; // æ¸…ç©ºç›®å‰ç•«é¢
            let checkedCount = 0;

            checklistData.forEach((item, index) => {
                if (item.checked) checkedCount++;

                const label = document.createElement('label');
                label.className = 'check-item';
                // é»æ“Š label æœ¬èº«åˆ‡æ› checkboxï¼Œé˜²æ­¢é»æ“Šåˆªé™¤æŒ‰éˆ•æ™‚è§¸ç™¼
                label.innerHTML = `
                    <div style="display:flex; align-items:center; gap:8px; flex:1; cursor:pointer;">
                        <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleItemStatus(${index})">
                        <span>${item.text}</span>
                    </div>
                    <button class="btn-del-item" onclick="deleteCheckItem(${index}, event)">Ã—</button>
                `;
                listArea.appendChild(label);
            });

            // æ›´æ–°é€²åº¦æ–‡å­—
            if (progressEl) {
                progressEl.innerText = `${checkedCount}/${checklistData.length}`;
                if (checkedCount === checklistData.length && checklistData.length > 0) {
                    progressEl.style.background = '#ECFDF5';
                    progressEl.style.color = '#059669';
                    progressEl.innerText = 'æº–å‚™å®Œæˆï¼';
                } else {
                    progressEl.style.background = '#FFFBEB';
                    progressEl.style.color = '#D97706';
                }
            }

            // å„²å­˜åˆ° LocalStorage
            localStorage.setItem(CHECKLIST_KEY, JSON.stringify(checklistData));
        }

        // åˆ‡æ›å‹¾é¸ç‹€æ…‹
        function toggleItemStatus(index) {
            checklistData[index].checked = !checklistData[index].checked;
            renderChecklist(); // é‡æ–°æ¸²æŸ“ (æœƒè‡ªå‹•å„²å­˜)
        }

        // æ–°å¢é …ç›®
        function addNewCheckItem() {
            const input = document.getElementById('new-item-input');
            const text = input.value.trim();
            if (!text) return;

            checklistData.unshift({ // åŠ åœ¨æœ€ä¸Šé¢
                id: 'new_' + Date.now(),
                text: text,
                checked: false
            });

            input.value = '';
            renderChecklist();
        }

        // åˆªé™¤é …ç›®
        function deleteCheckItem(index, event) {
            // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…é»æ“Šåˆªé™¤æ™‚è§¸ç™¼ label çš„å‹¾é¸
            event.stopPropagation();
            event.preventDefault();

            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹é …ç›®å—ï¼Ÿ')) {
                checklistData.splice(index, 1);
                renderChecklist();
            }
        }
        // [æ–°å¢] é‡ç½®æª¢æŸ¥æ¸…å–® (æ¢å¾©é è¨­å€¼)
        function resetChecklist(event) {
            event.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé¿å…è§¸ç™¼æŠ˜ç–Š

            if (!confirm("ç¢ºå®šè¦é‡ç½®æ¸…å–®å—ï¼Ÿ\n\né€™å°‡æœƒï¼š\n1. æ¸…é™¤æ‰€æœ‰å‹¾é¸ç‹€æ…‹\n2. åˆªé™¤æ‚¨è‡ªè¨‚çš„æ–°å¢é …ç›®\n3. æ¢å¾©ç‚ºåŸå§‹é è¨­æ¸…å–®")) {
                return;
            }

            // æ¢å¾©ç‚ºé è¨­é …ç›® (ä½¿ç”¨æ·±æ‹·è²ï¼Œé¿å…æ±™æŸ“åŸå§‹ defaultItems)
            checklistData = JSON.parse(JSON.stringify(defaultItems));

            // é‡æ–°æ¸²æŸ“ä¸¦å„²å­˜
            renderChecklist();

            // å¦‚æœæ¸…å–®ç›®å‰æ˜¯æ”¶åˆçš„ï¼Œè‡ªå‹•å±•é–‹è®“ä½¿ç”¨è€…çœ‹åˆ°çµæœ
            const container = document.getElementById('checklist-container');
            const icon = document.querySelector('.checklist-card-header .toggle-icon');
            if (container && !container.classList.contains('show')) {
                container.classList.add('show');
                if (icon) {
                    icon.style.transform = 'rotate(180deg)';
                    icon.style.color = '#2563EB';
                }
            }

            alert("æ¸…å–®å·²é‡ç½®å®Œæˆï¼");
        }
        // æŠ˜ç–Š/å±•é–‹æ§åˆ¶
        function toggleChecklist(headerEl) {
            const container = document.getElementById('checklist-container');
            const icon = headerEl.querySelector('.toggle-icon');

            // åˆ‡æ›é¡¯ç¤ºå®¹å™¨ (åŠ ä¸Šæˆ–ç§»é™¤ .show é¡åˆ¥)
            const isClosed = !container.classList.contains('show');

            if (isClosed) {
                container.classList.add('show');
                icon.style.transform = 'rotate(180deg)';
                icon.style.color = '#2563EB';
            } else {
                container.classList.remove('show');
                icon.style.transform = 'rotate(0deg)';
                icon.style.color = '#6B7280';
            }
        }
        // [æ–°å¢] åœ–ç‰‡é è¦½å…¨åŸŸè®Šæ•¸
        let pendingImageBase64 = null;

        // [æ–°å¢] é—œé–‰åœ–ç‰‡é è¦½
        function cancelImagePreview() {
            document.getElementById('img-preview-modal').style.display = 'none';
            pendingImageBase64 = null;
        }

        // [æ–°å¢] ç¢ºèªç™¼é€åœ–ç‰‡ (åŸæœ¬çš„é‚è¼¯ç§»åˆ°é€™è£¡)
        async function confirmImageAnalysis() {
            if (!pendingImageBase64) return;

            // [ä¿®æ­£] 1. ç§»é™¤é€™è£¡çš„ cancelImagePreview();
            // ä¸è¦åœ¨ä¸€é–‹å§‹å°±æ¸…é™¤è³‡æ–™ï¼

            // 2. å…ˆæŠŠè¦–çª—éš±è—èµ·ä¾†å°±å¥½ (è¦–è¦ºä¸Šé—œé–‰ï¼Œä½†ä¸è¦æ¸…ç©ºè®Šæ•¸)
            document.getElementById('img-preview-modal').style.display = 'none';

            showLoading();

            try {
                // 3. åœ¨èŠå¤©å®¤é¡¯ç¤ºåœ–ç‰‡
                // [ä¿®æ”¹] åŠ å…¥ onclick äº‹ä»¶èˆ‡ cursor:zoom-in æ¨£å¼
                const imgHtml = `<img src="data:image/jpeg;base64,${pendingImageBase64}" onclick="openLightbox(this.src)" style="max-width:100%; border-radius:10px; border:1px solid #ccc; margin-top:5px; cursor:zoom-in;">`;
                appendMessage('user', imgHtml);

                // è®€å–ä½ç½®
                let curLoc = "";
                if (window.appCache && window.appCache['my_location_combined']) {
                    curLoc = window.appCache['my_location_combined'].data.city;
                }

                // è¨­å®š Prompt
                const visionPrompt = `
                ${systemPrompt}
                ã€ä½¿ç”¨è€…å‚³é€äº†ä¸€å¼µåœ–ç‰‡ã€‘
                ã€ä½¿ç”¨è€…ç›®å‰ä½ç½®ã€‘ï¼š${curLoc}
                ä»»å‹™ï¼šè«‹æ“”ä»»å°ˆæ¥­å°éŠèˆ‡è³¼ç‰©åŠ©æ‰‹ã€‚
                è«‹åˆ¤æ–·åœ–ç‰‡å…§å®¹ä¸¦æä¾›å”åŠ©ï¼š
                1. è‹¥æ˜¯å•†å“/è—¥å¦/é›¶é£Ÿï¼šèªªæ˜é€™æ˜¯ä»€éº¼ (åç¨±èˆ‡åŠŸæ•ˆ)ï¼Œä¸¦æ¨è–¦åœ¨ã€Œ${curLoc}ã€å“ªè£¡è²·å¾—åˆ°ã€‚
                2. è‹¥æ˜¯èœå–®ï¼šç¿»è­¯èœåä¸¦æ¨è–¦å¿…åƒã€‚
                3. è‹¥æ˜¯æ™¯é»/è·¯ç‰Œï¼šå‘Šè¨´æˆ‘é€™åœ¨å“ªè£¡ã€‚
                è«‹ç”¨ç°¡æ½”ã€åƒæœ‹å‹èˆ¬çš„å£å»å›ç­”ã€‚
            `;

                // 4. ç™¼é€ API (é€™æ™‚å€™ pendingImageBase64 é‚„æœ‰å€¼ï¼Œæ‰€ä»¥æœƒæˆåŠŸ)
                const responseText = await getGeminiResponse(visionPrompt, pendingImageBase64);

                removeLoading();
                const formattedText = responseText.replace(/\n/g, '<br>');
                appendMessage('ai', formattedText, false);

            } catch (e) {
                removeLoading();
                appendMessage('ai', `<span style="color:red">åœ–ç‰‡è¾¨è­˜å¤±æ•—ï¼š${e.message}</span>`);
            } finally {
                // [ä¿®æ­£] 5. ç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼Œæœ€å¾Œæ‰çœŸæ­£æ¸…ç©ºè®Šæ•¸
                pendingImageBase64 = null;
            }
        }
        async function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 1. å£“ç¸®åœ–ç‰‡ (ä½†å…ˆä¸ç™¼é€)
            // ç‚ºäº†é è¦½æµæš¢ï¼Œé€™è£¡å…ˆåšå£“ç¸®ï¼Œå¦‚æœæª”æ¡ˆå¤ªå¤§æœƒåœ¨é€™è£¡è™•ç†æ‰
            try {
                pendingImageBase64 = await compressImage(file, 800, 0.7);

                // 2. é¡¯ç¤ºé è¦½å½ˆçª—
                const previewImg = document.getElementById('img-preview-content');
                previewImg.src = `data:image/jpeg;base64,${pendingImageBase64}`;

                document.getElementById('img-preview-modal').style.display = 'flex';

            } catch (e) {
                alert("åœ–ç‰‡è™•ç†å¤±æ•—ï¼Œè«‹é‡è©¦");
                console.error(e);
            }

            // 3. æ¸…ç©º inputï¼Œç¢ºä¿ä¸‹æ¬¡é¸åŒä¸€å¼µåœ–ä¹Ÿèƒ½è§¸ç™¼ change äº‹ä»¶
            event.target.value = '';
        }

        // ğŸŸ¢ æ­£ç¢ºä½ç½®ï¼šå£“ç¸®å‡½å¼ä¹Ÿä¸€èµ·ç§»å‡ºä¾†
        function compressImage(file, maxWidth, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        let w = img.width;
                        let h = img.height;
                        if (w > maxWidth) {
                            h = Math.round(h * (maxWidth / w));
                            w = maxWidth;
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = w;
                        canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        const dataUrl = canvas.toDataURL('image/jpeg', quality);
                        const base64 = dataUrl.split(',')[1];
                        resolve(base64);
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        }

        // --- ğŸ‘‡ è«‹åœ¨æ­¤è™•æ’å…¥ä¿®æ­£è¡çªçš„ç¨‹å¼ç¢¼ ğŸ‘‡ ---

        // [ä¿®æ­£] é˜²æ­¢å¤©æ°£æ©«å‘æ²å‹•å€èˆ‡å…¨åŸŸæ›é æ‰‹å‹¢è¡çª
        // [ä¿®æ­£] é˜²æ­¢å¤©æ°£æ©«å‘æ²å‹•å€èˆ‡å…¨åŸŸæ›é æ‰‹å‹¢è¡çª
        // [ä¿®æ­£] é˜²æ­¢å¤©æ°£è¦–çª—æ»‘å‹•æ™‚èª¤è§¸åº•å±¤æ›é 
        function preventSwipeConflict() {
            // å®šç¾©ä¸€å€‹é˜»æ“‹è¨Šè™Ÿå¾€ä¸Šå‚³çš„å‡½å¼
            const stopPropagation = (e) => {
                e.stopPropagation();
            };

            // 1. é‡å°ã€Œæ©«å‘ã€æ²å‹•çš„å°æ™‚é å ± (ç¶­æŒåŸæœ‰åŠŸèƒ½)
            const hourlyScroll = document.getElementById('wd-hourly-list');
            if (hourlyScroll) {
                hourlyScroll.addEventListener('touchstart', stopPropagation, { passive: true });
                hourlyScroll.addEventListener('touchmove', stopPropagation, { passive: true });
                hourlyScroll.addEventListener('touchend', stopPropagation, { passive: true });
                hourlyScroll.addEventListener('wheel', stopPropagation, { passive: true });
            }

            // 2. [æ–°å¢] é‡å°ã€Œå‚ç›´ã€æ²å‹•çš„å¤©æ°£è¦–çª—ç™½è‰²å€å¡Š (.modal-box)
            // é€™è¡Œæ˜¯è§£æ±ºã€Œä¸Šä¸‹æ»‘å‹•èª¤æ§ã€çš„é—œéµ
            const weatherModalBox = document.querySelector('#weather-detail-modal .modal-box');
            if (weatherModalBox) {
                weatherModalBox.addEventListener('touchstart', stopPropagation, { passive: true });
                weatherModalBox.addEventListener('touchmove', stopPropagation, { passive: true });
                weatherModalBox.addEventListener('touchend', stopPropagation, { passive: true });
                weatherModalBox.addEventListener('wheel', stopPropagation, { passive: true });
            }
        }

        // ç¢ºä¿é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œç¶å®š
        window.addEventListener('load', preventSwipeConflict);

        // --- ğŸ‘† æ’å…¥çµæŸ ğŸ‘† ---

        document.addEventListener('DOMContentLoaded', () => {
            // [æ–°å¢] ä¾æ“š GPS ä½ç½®è‡ªå‹•åˆ¤æ–·æ—¥å¤œ (æ”¯æ´è·¨æ™‚å€)
            function initDynamicTheme() {
                const header = document.querySelector('header');

                // å®šç¾©æˆåŠŸæ™‚çš„é‚è¼¯
                const applyTheme = async (lat, lon) => {
                    try {
                        // å‘¼å« APIï¼Œå‚³å…¥ç•¶ä¸‹åº§æ¨™ï¼ŒAPI æœƒæ ¹æ“šç¶“ç·¯åº¦èˆ‡å¤©æ–‡æ™‚é–“è‡ªå‹•è¨ˆç®—
                        // current_weather=true åŒ…å« is_day (1=ç™½å¤©, 0=é»‘å¤œ)
                        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`;

                        // å˜—è©¦è®€å–å¿«å–ä»¥ç¯€çœæµé‡ (èˆ‡å¤©æ°£åŠŸèƒ½å…±ç”¨å¿«å–ç³»çµ±)
                        const cacheKey = `theme_status_${lat.toFixed(1)}_${lon.toFixed(1)}`;
                        let isDay = CACHE_SYSTEM.get(cacheKey);

                        if (isDay === null) {
                            const res = await fetch(url);
                            const data = await res.json();
                            isDay = data.current_weather.is_day;
                            // å­˜å…¥å¿«å– 30 åˆ†é˜
                            CACHE_SYSTEM.save(cacheKey, isDay, 30);
                        }

                        // åˆ‡æ›æ¨£å¼ï¼š0 ä»£è¡¨é»‘å¤œï¼Œ1 ä»£è¡¨ç™½å¤©
                        if (isDay === 0) {
                            header.classList.add('is-night');
                            console.log(`[ä¸»é¡Œ] ä½æ–¼ (${lat},${lon})ï¼Œç›®å‰æ˜¯å¤œæ™š ğŸŒ™`);
                        } else {
                            header.classList.remove('is-night');
                            console.log(`[ä¸»é¡Œ] ä½æ–¼ (${lat},${lon})ï¼Œç›®å‰æ˜¯ç™½å¤© â˜€ï¸`);
                        }

                        // â˜…â˜…â˜… [æ’å…¥é€™æ®µ] è¨­å®šå®Œæ—¥å¤œå¾Œï¼Œå¼·åˆ¶é‡ç¹ªç‰¹æ•ˆ â˜…â˜…â˜…
                        if (window.setWeatherEffect && window.currentWeatherIcon) {
                            setWeatherEffect(window.currentWeatherIcon);
                        }
                    } catch (e) {
                        console.warn("ä¸»é¡Œ API é€£ç·šå¤±æ•—ï¼Œåˆ‡æ›ç‚ºç³»çµ±æ™‚é–“å‚™æ¡ˆ");
                        fallbackTheme();
                    }
                };

                // å‚™æ¡ˆé‚è¼¯ï¼šå¦‚æœæ²’é–‹ GPS æˆ– API å¤±æ•—ï¼Œæ”¹ç”¨æ‰‹æ©Ÿç³»çµ±æ™‚é–“
                const fallbackTheme = () => {
                    const hour = new Date().getHours();
                    // ç°¡å–®åˆ¤æ–·ï¼šæ™šä¸Š 6 é»å¾Œæˆ–æ—©ä¸Š 6 é»å‰ç‚ºå¤œæ™š
                    if (hour >= 18 || hour < 6) {
                        header.classList.add('is-night');
                    } else {
                        header.classList.remove('is-night');
                    }

                    // â˜…â˜…â˜… [æ’å…¥é€™æ®µ] å‚™æ¡ˆæ¨¡å¼ä¹Ÿè¦é‡ç¹ªç‰¹æ•ˆ â˜…â˜…â˜…
                    if (window.setWeatherEffect && window.currentWeatherIcon) {
                        setWeatherEffect(window.currentWeatherIcon);
                    }
                };

                // é–‹å§‹åŸ·è¡Œå®šä½
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            // æˆåŠŸå–å¾—ä½ç½®ï¼Œä½¿ç”¨ API ç²¾æº–åˆ¤æ–·
                            applyTheme(position.coords.latitude, position.coords.longitude);
                        },
                        (error) => {
                            console.log("ç„¡æ³•å–å¾—ä½ç½®ï¼Œä½¿ç”¨æ™‚é–“å‚™æ¡ˆ");
                            fallbackTheme();
                        },
                        { timeout: 5000 }
                    );
                } else {
                    fallbackTheme();
                }
            }

            // å•Ÿå‹•ä¸»é¡Œåµæ¸¬
            initDynamicTheme();
            // [æ–°å¢] åœ–ç‰‡è™•ç†èˆ‡å£“ç¸®é‚è¼¯

            // --- æ™ºæ…§è‡ªå‹•å±•é–‹é‚è¼¯é–‹å§‹ ---

            // 1. å®šç¾©æ—¥æœŸèˆ‡è¡Œç¨‹ ID çš„å°æ‡‰è¡¨
            const scheduleMap = {
                '2026-01-25': 'd1',
                '2026-01-26': 'd2',
                '2026-01-27': 'd3',
                '2026-01-28': 'd4',
                '2026-01-29': 'd5',
                '2026-01-30': 'd6'
            };

            // 2. å–å¾—ä»Šæ—¥æ—¥æœŸ (æ ¼å¼ YYYY-MM-DD)
            const now = new Date();
            // â˜… æ¸¬è©¦ç”¨ï¼šè‹¥æƒ³ç¾åœ¨æ¸¬è©¦ã€Œæ—…é€”ä¸­ã€çš„æ•ˆæœï¼Œè«‹å–æ¶ˆä¸‹è¡Œè¨»è§£ä¸¦ä¿®æ”¹æ—¥æœŸ
            //const now = new Date('2026-01-28'); 

            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${day}`;

            // 3. å–å¾— DOM å…ƒç´ 
            const checklistContainer = document.getElementById('checklist-container');
            const checklistIcon = document.querySelector('.checklist-card-header .toggle-icon');

            // 4. åŸ·è¡Œåˆ¤æ–·
            if (todayStr < '2026-01-25') {
                // ã€æƒ…å¢ƒ Aï¼šè¡Œå‰æº–å‚™æœŸã€‘(ç¾åœ¨ ~ 1/24)
                // å‹•ä½œï¼šè‡ªå‹•å±•é–‹ Checklistï¼Œæ”¶åˆæ‰€æœ‰è¡Œç¨‹

                if (checklistContainer) {
                    checklistContainer.classList.add('show');
                    if (checklistIcon) {
                        checklistIcon.style.transform = 'rotate(180deg)';
                        checklistIcon.style.color = '#2563EB'; // è—è‰²ç®­é ­è¡¨ç¤ºå±•é–‹
                    }
                }
                // é è¨­è¼‰å…¥ Day 1 å¤©æ°£è³‡è¨Šä¾›åƒè€ƒ
                /*updateWeatherWidget('d1');*/

            } else if (scheduleMap[todayStr]) {
                // ã€æƒ…å¢ƒ Bï¼šæ—…é€”ä¸­ã€‘(1/25 ~ 1/30)
                // å‹•ä½œï¼šChecklist ä¿æŒé—œé–‰ï¼Œè‡ªå‹•å±•é–‹ã€Œç•¶å¤©ã€çš„è¡Œç¨‹

                const targetDayId = scheduleMap[todayStr];
                const dayTimeline = document.getElementById(targetDayId);
                const dayToggle = document.getElementById('toggle-' + targetDayId);
                const dayIcon = dayToggle ? dayToggle.querySelector('.toggle-icon') : null;

                if (dayTimeline && dayToggle) {
                    // å±•é–‹è©²æ—¥è¡Œç¨‹
                    dayTimeline.classList.add('show');
                    dayToggle.classList.add('open'); // è®“å·¦é‚Šæ¡†è®Šè‰²
                    if (dayIcon) {
                        // é€™è£¡æ‚¨ä½¿ç”¨ div ç®­é ­ï¼Œæˆ‘å€‘é€é CSS class æ§åˆ¶æ—‹è½‰ï¼Œæˆ–è€…ç›´æ¥ç”¨ style
                        // æ‚¨çš„ CSS .day-toggle.open .toggle-icon å·²ç¶“æœ‰è¨­å®š transformï¼Œæ‰€ä»¥åŠ ä¸Š open é¡åˆ¥å³å¯
                    }

                    // æ›´æ–° Header å¤©æ°£ç‚ºã€Œç•¶å¤©ã€çš„åœ°é»
                    updateWeatherWidget(targetDayId);

                    // (é¸ç”¨) è‡ªå‹•æ²å‹•åˆ°ç•¶æ—¥è¡Œç¨‹ï¼Œæå‡é«”é©—
                    setTimeout(() => {
                        dayToggle.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 500);
                }
            } else {
                // ã€æƒ…å¢ƒ Cï¼šæ—…ç¨‹çµæŸã€‘
                // å…¨éƒ¨æ”¶åˆï¼Œæˆ–è¦–éœ€æ±‚é¡¯ç¤º
                /*updateWeatherWidget('d1'); // é è¨­å›é¡¯ D1*/
            }

            // --- æ™ºæ…§è‡ªå‹•å±•é–‹é‚è¼¯çµæŸ ---

            initAiChat();
            setupVoiceButton(); // Init voice listener
            getLocalWeather(); // Fetch local weather on load
            initChecklist(); // Init checklist
            // [ä¿®æ­£] 1:1 æŒ‡éš¨å¿ƒå‹•ç‰©ç†ç¿»é å¼•æ“ (Physics Page Flip)
            let isDragging = false;
            let startX = 0;
            let startY = 0; // [æ–°å¢] å‚ç›´èµ·é»ï¼Œç”¨ä¾†åˆ¤æ–·æ˜¯å¦ç‚ºæ²å‹•
            let currentTranslate = 0;
            let activeContainer = null;
            let navItems = [];
            let activeIndex = 0;

            // 1. æ‰‹æŒ‡æŒ‰ä¸‹ï¼šé–å®šç›®æ¨™ï¼Œæº–å‚™æ‹–æ›³
            document.addEventListener('touchstart', (e) => {
                const active = document.querySelector('.container.active');
                if (!active || active.classList.contains('is-animating')) return;

                // [ä¿®æ­£] æ”¹ç‚ºã€Œæ½›åœ¨æ‹–æ›³ä¸­ã€ï¼Œå…ˆä¸é–æ­»ï¼Œç­‰ç§»å‹•åˆ¤æ–·æ–¹å‘å¾Œå†æ±ºå®š
                isDragging = true;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY; // [æ–°å¢] ç´€éŒ„å‚ç›´ä½ç½®
                activeContainer = active;

                navItems = Array.from(document.querySelectorAll('.nav-item'));
                const activeNavItem = document.querySelector('.nav-item.active');
                activeIndex = navItems.indexOf(activeNavItem);
            }, { passive: false });

            // 2. æ‰‹æŒ‡ç§»å‹•ï¼šè¨ˆç®—ç‰©ç†é‡ï¼Œå³æ™‚æ›´æ–°ç•«é¢
            document.addEventListener('touchmove', (e) => {
                if (!isDragging || !activeContainer) return;

                const currentX = e.touches[0].clientX;
                const currentY = e.touches[0].clientY;
                const diffX = currentX - startX;
                const diffY = currentY - startY;

                // å„ªå…ˆåˆ¤æ–·æ²å‹•ï¼šå¦‚æœå‚ç›´ç§»å‹• > æ°´å¹³ç§»å‹•ï¼Œè¦–ç‚ºæ²å‹•ç¶²é 
                if (Math.abs(diffY) > Math.abs(diffX)) {
                    isDragging = false;
                    activeContainer.classList.remove('is-dragging');
                    return;
                }

                // ç¢ºå®šæ˜¯æ°´å¹³æ»‘å‹•
                activeContainer.classList.add('is-dragging');
                if (e.cancelable) e.preventDefault();

                // â˜… [ä¿®æ”¹] æ ¸å¿ƒç‰©ç†å…¬å¼ï¼šæ”¹ç‚º 2D å¹³ç§» (TranslateX)
                // ä½¿ç”¨ translate3d ç¢ºä¿å•Ÿç”¨ GPU åŠ é€Ÿ
                activeContainer.style.transform = `translate3d(${diffX}px, 0, 0)`;

                // ğŸ’¡ [é¸ç”¨] æ ¹æ“šæ»‘å‹•è·é›¢å¾®èª¿é€æ˜åº¦ (æ¨¡æ“¬æ‚¨æä¾›çš„ opacity: 0 æ•ˆæœ)
                // æ»‘å‹•è¶Šé ï¼Œé€æ˜åº¦è¶Šä½ (æœ€å¤šé™åˆ° 0.8ï¼Œä¿ç•™ä¸€é»å¯è¦‹åº¦ä»¥å…ä½¿ç”¨è€…è¿·å¤±)
                const opacity = 1 - (Math.abs(diffX) / window.innerWidth) * 0.5;
                activeContainer.style.opacity = opacity;
                activeContainer.style.filter = ''; // ç§»é™¤èˆŠçš„äº®åº¦æ¿¾é¡ï¼Œä¿æŒä¹¾æ·¨

                currentTranslate = diffX;
            }, { passive: false });


            // 3. æ‰‹æŒ‡æ”¾é–‹ï¼šåˆ¤æ–·æ˜¯ã€Œç¿»éå»ã€é‚„æ˜¯ã€Œå½ˆå›ä¾†ã€
            document.addEventListener('touchend', (e) => {
                if (!isDragging || !activeContainer) return;
                isDragging = false;

                // ç§»é™¤æ‹–æ›³ç‹€æ…‹ï¼ŒåŠ å…¥å‹•ç•«ç‹€æ…‹ (è®“ CSS æ¥æ‰‹å‰©ä¸‹çš„å‹•ä½œ)
                activeContainer.classList.remove('is-dragging');
                activeContainer.classList.add('is-animating');

                const threshold = 80; // æ»‘å‹•è¶…é 80px å°±è¦–ç‚ºè¦ç¿»é 

                // A. æ±ºå®šç¿»é  (æ»‘å‹•è·é›¢è¶³å¤ )
                // A. æ±ºå®šç¿»é  (æ»‘å‹•è·é›¢è¶³å¤ )
                if (Math.abs(currentTranslate) > threshold) {
                    const direction = currentTranslate > 0 ? 'prev' : 'next';
                    let targetIndex;

                    // [ä¿®æ­£] å¾ªç’°é‚è¼¯ï¼šä½¿ç”¨é¤˜æ•¸é‹ç®—ä¾†å¯¦ç¾ç„¡é™å¾ªç’°
                    if (direction === 'next') {
                        // å¾€å³ç¿» (ä¸‹ä¸€é ): å¦‚æœæ˜¯æœ€å¾Œä¸€é ï¼Œæœƒå›åˆ° 0
                        targetIndex = (activeIndex + 1) % navItems.length;
                    } else {
                        // å¾€å·¦ç¿» (ä¸Šä¸€é ): å¦‚æœæ˜¯ç¬¬ 0 é ï¼Œæœƒå›åˆ°æœ€å¾Œä¸€é 
                        targetIndex = (activeIndex - 1 + navItems.length) % navItems.length;
                    }

                    finishFlip(activeContainer, direction, navItems[targetIndex]);
                }
                // B. å–æ¶ˆç¿»é  (æ»‘å‹•è·é›¢ä¸å¤ ï¼Œå½ˆå›ä¾†)
                else {
                    revertFlip(activeContainer);
                }

                currentTranslate = 0;
            });

            // è¼”åŠ©ï¼šå½ˆå›åŸä½ (Revert)
            function revertFlip(element) {
                // å›åˆ°ä¸­å¿ƒ (x: 0)
                element.style.transform = 'translate3d(0, 0, 0)';
                element.style.opacity = '1';

                setTimeout(() => {
                    element.classList.remove('is-animating');
                    element.style.transform = '';
                    element.style.opacity = '';
                }, 250); // å°æ‡‰ CSS çš„ 0.25s
            }

            // è¼”åŠ©ï¼šå®Œæˆç¿»é å‹•ä½œ (Slide Out & Slide In)
            function finishFlip(oldElement, direction, nextNavItem) {
                const screenW = window.innerWidth;

                // 1. èˆŠé é¢æ»‘å‡ºå» (Slide Exit)
                // å¾€å·¦æ»‘(Next) -> èˆŠé é¢å» -100%ï¼Œå¾€å³æ»‘(Prev) -> èˆŠé é¢å» 100%
                const targetX = direction === 'next' ? -screenW : screenW;

                oldElement.style.transform = `translate3d(${targetX}px, 0, 0)`;
                oldElement.style.opacity = '0'; // æ»‘å‡ºæ™‚æ·¡å‡º

                // 2. ç­‰èˆŠé é¢æ»‘å‡ºå»å¾Œï¼Œåˆ‡æ›å…§å®¹
                setTimeout(() => {
                    switchTab(nextNavItem);

                    const newTargetId = nextNavItem.getAttribute('data-target');
                    const newContainer = document.getElementById(newTargetId);

                    // 3. æ–°é é¢æº–å‚™é€²å ´ (Slide Enter)
                    // å¦‚æœæ˜¯ Nextï¼Œæ–°é é¢å¾å³é‚Š(100%)é€²ä¾†ï¼›å¦‚æœæ˜¯ Prevï¼Œå¾å·¦é‚Š(-100%)é€²ä¾†
                    const startX = direction === 'next' ? screenW : -screenW;

                    newContainer.classList.add('is-dragging'); // æš«æ™‚ç§»é™¤ transition ä»¥ä¾¿ç¬é–“å®šä½
                    newContainer.style.transform = `translate3d(${startX}px, 0, 0)`;
                    newContainer.style.opacity = '0';

                    // å¼·åˆ¶ç€è¦½å™¨é‡ç¹ª (Reflow) ç¢ºä¿å®šä½ç”Ÿæ•ˆ
                    void newContainer.offsetWidth;

                    // 4. åŸ·è¡Œé€²å ´å‹•ç•« (Go to Center)
                    newContainer.classList.remove('is-dragging');
                    newContainer.classList.add('is-animating');
                    newContainer.style.transform = 'translate3d(0, 0, 0)';
                    newContainer.style.opacity = '1';

                    // æ¸…ç†èˆŠå…ƒç´ 
                    oldElement.classList.remove('is-animating');
                    oldElement.style.transform = '';
                    oldElement.style.opacity = '';

                    // æ¸…ç†æ–°å…ƒç´ 
                    setTimeout(() => {
                        newContainer.classList.remove('is-animating');
                        newContainer.style.transform = '';
                    }, 250); // å°æ‡‰ CSS çš„ 0.25s

                }, 200); // ç¨å¾®ææ—©ä¸€é»åˆ‡æ›ï¼Œè®“éŠœæ¥æ›´ç·Šå¯†
            }
        });
        // [å‡ç´šç‰ˆ] åœ–ç‰‡æ”¾å¤§ç‡ˆç®±æ§åˆ¶å‡½å¼ (å«ç¸®æ”¾èˆ‡æ‹–æ›³åŠŸèƒ½)
        let lbState = {
            scale: 1,
            panning: false,
            pointX: 0, pointY: 0, // ç•¶å‰åº§æ¨™
            startX: 0, startY: 0, // æ‹–æ›³èµ·å§‹é»
            lastX: 0, lastY: 0,   // ä¸Šä¸€æ¬¡çµæŸé»
            initialDist: 0        // é›™æŒ‡åˆå§‹è·é›¢
        };

        const lbImg = document.getElementById('lightbox-img');
        const lbModal = document.getElementById('lightbox-modal');

        // 1. é–‹å•Ÿç‡ˆç®±
        window.openLightbox = function (src) {
            if (!lbImg || !lbModal) return;

            lbImg.src = src;
            lbModal.style.display = 'flex';

            // é‡ç½®ç‹€æ…‹
            resetLightbox();

            // é˜»æ“‹åœ–ç‰‡é»æ“Šå†’æ³¡ (é¿å…é»åœ–ç‰‡æ™‚é—œé–‰ç‡ˆç®±)
            lbImg.onclick = (e) => e.stopPropagation();

            // åŠ å…¥äº‹ä»¶ç›£è½
            addLightboxListeners();
        }

        // 2. é—œé–‰ç‡ˆç®±
        window.closeLightbox = function (e) {
            // åªæœ‰é»æ“ŠèƒŒæ™¯(é®ç½©)æˆ–é—œé–‰æŒ‰éˆ•æ™‚æ‰é—œé–‰
            // (å› ç‚º img å·²ç¶“é˜»æ“‹å†’æ³¡ï¼Œé€™è£¡é€šå¸¸æ˜¯é»åˆ° overlay)
            if (e && e.target !== lbModal && !e.target.classList.contains('lightbox-close')) return;

            lbModal.style.display = 'none';
            removeLightboxListeners();
        }

        function resetLightbox() {
            lbState = { scale: 1, panning: false, pointX: 0, pointY: 0, startX: 0, startY: 0, lastX: 0, lastY: 0, initialDist: 0 };
            updateTransform();
        }

        function updateTransform() {
            // é™åˆ¶ç¸®å°ä¸èƒ½å°æ–¼ 1 (åŸå°ºå¯¸)
            if (lbState.scale < 1) lbState.scale = 1;
            lbImg.style.transform = `translate(${lbState.pointX}px, ${lbState.pointY}px) scale(${lbState.scale})`;
        }

        // --- äº‹ä»¶è™•ç†å€ ---

        function addLightboxListeners() {
            // é›»è…¦ç‰ˆï¼šæ»¾è¼ªç¸®æ”¾
            lbImg.addEventListener('wheel', handleWheel, { passive: false });
            // é›»è…¦ç‰ˆï¼šæ‹–æ›³
            lbImg.addEventListener('mousedown', handleMouseDown);

            // æ‰‹æ©Ÿç‰ˆï¼šè§¸æ§
            lbImg.addEventListener('touchstart', handleTouchStart, { passive: false });
            lbImg.addEventListener('touchmove', handleTouchMove, { passive: false });
            lbImg.addEventListener('touchend', handleTouchEnd);
        }

        function removeLightboxListeners() {
            lbImg.removeEventListener('wheel', handleWheel);
            lbImg.removeEventListener('mousedown', handleMouseDown);
            window.removeEventListener('mousemove', handleMouseMove);
            window.removeEventListener('mouseup', handleMouseUp);
            lbImg.removeEventListener('touchstart', handleTouchStart);
            lbImg.removeEventListener('touchmove', handleTouchMove);
            lbImg.removeEventListener('touchend', handleTouchEnd);
        }

        // [é›»è…¦] æ»¾è¼ªç¸®æ”¾
        function handleWheel(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.2 : 0.2;
            lbState.scale += delta;
            updateTransform();
        }

        // [é›»è…¦] æ»‘é¼ æ‹–æ›³
        function handleMouseDown(e) {
            if (lbState.scale <= 1) return; // æ²’æ”¾å¤§æ™‚ä¸çµ¦æ‹–
            e.preventDefault();
            lbState.startX = e.clientX - lbState.pointX;
            lbState.startY = e.clientY - lbState.pointY;
            lbState.panning = true;

            window.addEventListener('mousemove', handleMouseMove);
            window.addEventListener('mouseup', handleMouseUp);
        }

        function handleMouseMove(e) {
            if (!lbState.panning) return;
            e.preventDefault();
            lbState.pointX = e.clientX - lbState.startX;
            lbState.pointY = e.clientY - lbState.startY;
            updateTransform();
        }

        function handleMouseUp() {
            lbState.panning = false;
            window.removeEventListener('mousemove', handleMouseMove);
            window.removeEventListener('mouseup', handleMouseUp);
        }

        // [æ‰‹æ©Ÿ] è§¸æ§è™•ç† (å–®æŒ‡æ‹–æ›³ / é›™æŒ‡ç¸®æ”¾)
        function handleTouchStart(e) {
            if (e.touches.length === 2) {
                // é›™æŒ‡ï¼šé–‹å§‹ç¸®æ”¾
                e.preventDefault(); // é˜²æ­¢èƒŒæ™¯æ²å‹•
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                lbState.initialDist = Math.hypot(touch1.pageX - touch2.pageX, touch1.pageY - touch2.pageY);
                lbState.lastScale = lbState.scale;
            } else if (e.touches.length === 1 && lbState.scale > 1) {
                // å–®æŒ‡ä¸”å·²æ”¾å¤§ï¼šé–‹å§‹æ‹–æ›³
                const touch = e.touches[0];
                lbState.startX = touch.pageX - lbState.pointX;
                lbState.startY = touch.pageY - lbState.pointY;
                lbState.panning = true;
            }
        }

        function handleTouchMove(e) {
            if (e.touches.length === 2) {
                // é›™æŒ‡ç¸®æ”¾ä¸­
                e.preventDefault();
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const dist = Math.hypot(touch1.pageX - touch2.pageX, touch1.pageY - touch2.pageY);

                // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹
                const delta = dist / lbState.initialDist;
                lbState.scale = lbState.lastScale * delta;
                updateTransform();
            } else if (e.touches.length === 1 && lbState.panning) {
                // å–®æŒ‡æ‹–æ›³ä¸­
                e.preventDefault(); // é˜²æ­¢èƒŒæ™¯æ²å‹•
                const touch = e.touches[0];
                lbState.pointX = touch.pageX - lbState.startX;
                lbState.pointY = touch.pageY - lbState.startY;
                updateTransform();
            }
        }

        function handleTouchEnd(e) {
            lbState.panning = false;
            if (e.touches.length < 2) {
                lbState.initialDist = 0;
            }
        }
        // [æ–°å¢] è¤‡è£½æ–‡å­—åŠŸèƒ½ (å«å›é¥‹å‹•ç•«)
        function copyText(btn, text) {
            if (!navigator.clipboard) {
                // å‚™æ¡ˆï¼šè‹¥ç€è¦½å™¨ä¸æ”¯æ´ Clipboard API (è¼ƒèˆŠçš„å®‰å“ Webview)
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("Copy");
                document.body.removeChild(textArea);
                showCopyFeedback(btn);
                return;
            }

            navigator.clipboard.writeText(text).then(() => {
                showCopyFeedback(btn);
            }).catch(err => {
                console.error('è¤‡è£½å¤±æ•—', err);
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½');
            });
        }

        function showCopyFeedback(btn) {
            const originalHtml = btn.innerHTML;
            // è®Šæ›´ç‚ºç¶ è‰²å‹¾å‹¾
            btn.innerHTML = `<svg class="icon-mini" style="width:12px;height:12px;"><path d="M20 6L9 17l-5-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> å·²è¤‡è£½`;
            btn.classList.add('copied');

            // 2ç§’å¾Œå¾©åŸ
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.classList.remove('copied');
            }, 2000);
        }
        // [æ–°å¢] å®šç¾©ä¸€å€‹å…¨åŸŸè®Šæ•¸ä¾†è¨˜ä½ç¾åœ¨æ˜¯ä»€éº¼åœ–ç¤º (é è¨­ cloud)
        window.currentWeatherIcon = 'cloud';

        // [ä¿®æ”¹] åŸæœ¬çš„ setWeatherEffect å‡½å¼
        function setWeatherEffect(iconType) {
            // 1. [é—œéµæ–°å¢] ç„¡è«–åˆ‡æ›åˆ°å“ªç¨®å¤©æ°£ï¼Œå…ˆå¼·åˆ¶é—œé–‰ä¹‹å‰çš„ç‰©ç†å¼•æ“
            // é€™èƒ½ç¢ºä¿é›¨å¤©ç‰¹æ•ˆä¸æœƒåœ¨æ™´å¤©ã€é™°å¤©æˆ–éœ§å¤©æ™‚ç¹¼çºŒåœ¨èƒŒæ™¯é‹ç®—
            if (typeof clearRainTimers === 'function') {
                clearRainTimers();
            }

            // 2. è¨˜ä½ç¾åœ¨çš„å¤©æ°£åœ–ç¤ºï¼Œä»¥ä¾¿æ—¥å¤œåˆ‡æ›å¾Œé‡ç¹ª
            window.currentWeatherIcon = iconType;

            const header = document.querySelector('header');
            const layer = document.getElementById('weather-effect-layer');
            if (!header || !layer) return;

            // 3. é‡ç½®æ‰€æœ‰å¤©æ°£ class (ä¿ç•™ is-night)
            header.classList.remove('w-sun', 'w-cloud', 'w-rain', 'w-snow', 'w-fog'); layer.innerHTML = ''; // æ¸…ç©ºèˆŠç²’å­

            // 2. æ ¹æ“šåœ–ç¤ºé¡å‹å¥—ç”¨å°æ‡‰ç‰¹æ•ˆ
            // å°æ‡‰æ‚¨çš„ validIcons: 'sun', 'cloud', 'cloud-sun', 'snow', 'rain', 'fog', 'lightning'

            if (iconType === 'sun') {
                header.classList.add('w-sun');

                // [ä¿®æ”¹] æª¢æŸ¥ Header æ˜¯å¦æœ‰ 'is-night' é¡åˆ¥ (ç”± initDynamicTheme æ§åˆ¶)
                if (header.classList.contains('is-night')) {
                    // â˜… æƒ…å¢ƒ Aï¼šæ™´æœ—çš„æ™šä¸Š -> é¡¯ç¤ºå¯«å¯¦æ˜Ÿç©º
                    let stars = '';
                    // ç”Ÿæˆ 60 é¡†éš¨æ©Ÿåˆ†ä½ˆçš„æ˜Ÿæ˜Ÿ
                    for (let i = 0; i < 60; i++) {
                        const left = Math.floor(Math.random() * 100);     // æ°´å¹³éš¨æ©Ÿ
                        const top = Math.floor(Math.random() * 70);       // é›†ä¸­åœ¨ä¸­ä¸Šç©º (0%~70%)
                        const size = (Math.random() * 2 + 1).toFixed(1);  // å¤§å° 1px ~ 3px
                        const dur = (Math.random() * 3 + 1.5).toFixed(1); // é–ƒçˆé€Ÿåº¦ 1.5s ~ 4.5s (è®“æ˜Ÿæ˜Ÿä¸è¦é–ƒå¾—å¤ªæ•´é½Š)
                        const delay = (Math.random() * 2).toFixed(1);     // éš¨æ©Ÿå»¶é²å…¥å ´

                        stars += `<div class="star-particle" style="left:${left}%; top:${top}%; width:${size}px; height:${size}px; animation-duration:${dur}s; animation-delay:${delay}s;"></div>`;
                    }
                    layer.innerHTML = stars;
                } else {
                    // â˜… æƒ…å¢ƒ Bï¼šæ™´æœ—çš„ç™½å¤© -> é¡¯ç¤ºå¤ªé™½å…‰æšˆ (åŸæœ¬çš„ä»£ç¢¼)
                    layer.innerHTML = '<div class="sun-glow"></div>';
                }
            }
            else if (iconType === 'cloud' || iconType === 'cloud-sun') {
                header.classList.add('w-cloud');

                const isNight = header.classList.contains('is-night');

                // [é—œéµä¿®æ”¹] è¨­å®šæ—¥å¤œä¸åŒçš„é€æ˜åº¦
                // ç™½å¤©ï¼šé›²æœµä¸é€æ˜åº¦é«˜ (0.85)ï¼Œçœ‹èµ·ä¾†ç™½ç™½èƒ–èƒ–
                // æ™šä¸Šï¼šé›²æœµä¸é€æ˜åº¦ä½ (0.4)ï¼Œçœ‹èµ·ä¾†åƒå¤œç©ºä¸­çš„é™°å½±
                const mainOp = isNight ? 0.4 : 0.85;
                const bgOp = isNight ? 0.1 : 0.3;    // èƒŒæ™¯å¤§é›²æ›´æ·¡

                let content = '';

                // [æ–°å¢] å¦‚æœæ˜¯ã€Œæ™šä¸Šå¤šé›²ã€ï¼Œåœ¨é›²å±¤å¾Œæ–¹åŠ ä¸€é»ç¨€ç–çš„æ˜Ÿæ˜Ÿ
                if (isNight) {
                    // ç”Ÿæˆ 15 é¡†æ˜Ÿæ˜Ÿ (æ¯”æ™´å¤©çš„ 60 é¡†å°‘ï¼Œç‡Ÿé€ è¢«é›²é®æ“‹çš„æ„Ÿè¦º)
                    for (let i = 0; i < 15; i++) {
                        const left = Math.floor(Math.random() * 100);
                        const top = Math.floor(Math.random() * 80);
                        const size = (Math.random() * 2).toFixed(1);
                        // é–ƒçˆé€Ÿåº¦è¨­æ…¢ä¸€é»ï¼Œç‡Ÿé€ å¯§éœæ„Ÿ
                        const dur = (Math.random() * 3 + 3).toFixed(1);
                        content += `<div class="star-particle" style="left:${left}%; top:${top}%; width:${size}px; height:${size}px; animation-duration:${dur}s; opacity: 0.6;"></div>`;
                    }
                }

                // é›²æœµå±¤ (HTML çµæ§‹ä¸è®Šï¼Œä½† style è£¡çš„ opacity æ›æˆäº†è®Šæ•¸)
                content += `
            <div class="cloud-shape" style="top: 5%; transform: scale(3); animation-duration: 20s; opacity: ${bgOp}; z-index: 1;"></div>
            <div class="cloud-shape" style="top: 25%; transform: scale(1.8); animation-duration: 35s; animation-delay: -5s; opacity: ${mainOp};"></div>
            <div class="cloud-shape" style="top: 45%; width: 140px; transform: scale(1.6); animation-duration: 45s; animation-delay: -20s; opacity: ${mainOp * 0.8};"></div>
            <div class="cloud-shape" style="top: 65%; transform: scale(2.0); animation-duration: 60s; animation-delay: -10s; opacity: ${bgOp};"></div>
            <div class="cloud-shape" style="top: 10%; transform: scale(0.8); animation-duration: 80s; animation-delay: -40s; opacity: ${bgOp};"></div>
        `;

                layer.innerHTML = content;
            }
            else if (iconType === 'rain' || iconType === 'lightning') {
                // 1. å…ˆæ¸…é™¤èˆŠç‹€æ…‹
                clearRainTimers();

                header.classList.add('w-rain');
                layer.innerHTML = '';

                // 2. [èƒŒæ™¯] ç©ºä¸­è½ä¸‹çš„é›¨çµ²
                const rainContainer = document.createElement('div');
                for (let i = 0; i < 40; i++) {
                    const drop = document.createElement('div');
                    drop.className = 'rain-drop';
                    drop.style.left = `${Math.floor(Math.random() * 100)}%`;
                    drop.style.animationDelay = `${(Math.random() * 2).toFixed(2)}s`;
                    drop.style.animationDuration = `${(0.5 + Math.random() * 0.4).toFixed(2)}s`;
                    rainContainer.appendChild(drop);
                }
                layer.appendChild(rainContainer);

                // 3. [å‰æ™¯] ç»ç’ƒå®¹å™¨
                const glassSurface = document.createElement('div');
                glassSurface.className = 'glass-surface';
                layer.appendChild(glassSurface);

                // 4. ç”Ÿæˆã€Œéœæ…‹æ°´ç ã€ (çµç‰©)
                const staticDrops = [];

                function spawnStaticDrop(isRespawn = false) {
                    const drop = document.createElement('div');
                    const left = Math.random() * 100;
                    const top = Math.random() * 95;
                    const size = (Math.random() * 6 + 3).toFixed(1);

                    drop.className = 'glass-drop';
                    if (isRespawn) drop.classList.add('fade-in');

                    drop.style.left = `${left}%`;
                    drop.style.top = `${top}%`;
                    drop.style.width = `${size}px`;
                    drop.style.height = `${size}px`;

                    const r1 = Math.floor(40 + Math.random() * 40);
                    const r2 = Math.floor(40 + Math.random() * 40);
                    drop.style.borderRadius = `${r1}% ${100 - r1}% ${r2}% ${100 - r2}%`;

                    glassSurface.appendChild(drop);
                    staticDrops.push(drop);
                }

                // åˆå§‹ç”Ÿæˆ 45 é¡†
                for (let i = 0; i < 45; i++) spawnStaticDrop();

                // 5. ç”Ÿæˆã€Œå‹•æ…‹æ°´æµã€ (çµäºº)
                const activeTricklers = [];

                const spawnTrickler = () => {
                    const trickler = document.createElement('div');
                    const tLeft = Math.random() * 96 + 2;
                    const tDuration = Math.random() * 3 + 5; // 5~8ç§’
                    const tHeight = Math.random() * 40 + 60; // 60~100px

                    trickler.className = 'glass-drop trickle';
                    trickler.style.left = `${tLeft}%`;
                    trickler.style.top = '0%';
                    trickler.style.height = `${tHeight}px`;

                    trickler.style.animationDuration = `${tDuration}s`;

                    glassSurface.appendChild(trickler);
                    activeTricklers.push(trickler);

                    // å‹•ç•«çµæŸå¾Œç§»é™¤
                    const cleanup = setTimeout(() => {
                        trickler.remove();
                        const idx = activeTricklers.indexOf(trickler);
                        if (idx > -1) activeTricklers.splice(idx, 1);
                    }, tDuration * 1000);

                    window.rainTimers.push(cleanup);
                };

                // 6. [æ ¸å¿ƒ] å³æ™‚ç‰©ç†å¼•æ“ (Real-time Physics Engine)
                function runPhysicsLoop() {
                    if (activeTricklers.length > 0) {
                        const targets = staticDrops.filter(d => !d.classList.contains('merged') && d.parentNode);

                        activeTricklers.forEach(trickler => {
                            const tRect = trickler.getBoundingClientRect();
                            if (tRect.bottom < 0 || tRect.top > window.innerHeight) return;

                            targets.forEach(drop => {
                                const dRect = drop.getBoundingClientRect();

                                // ç¢°æ’åˆ¤å®š
                                const xOverlap = (tRect.right > dRect.left + 2) && (tRect.left < dRect.right - 2);
                                const yHit = (tRect.bottom >= dRect.top + 5);
                                const yNotPassed = (tRect.top < dRect.bottom);

                                if (xOverlap && yHit && yNotPassed) {
                                    drop.classList.add('merged'); // å³æ™‚æ¶ˆå¤±

                                    // 3ç§’å¾Œé‡ç”Ÿ
                                    const respawnTimer = setTimeout(() => {
                                        if (drop.parentNode) drop.remove();
                                        const idx = staticDrops.indexOf(drop);
                                        if (idx > -1) staticDrops.splice(idx, 1);
                                        spawnStaticDrop(true);
                                    }, Math.random() * 2000 + 2000);
                                    window.rainTimers.push(respawnTimer);
                                }
                            });
                        });
                    }
                    window.rainPhysicsFrame = requestAnimationFrame(runPhysicsLoop);
                }

                // å•Ÿå‹•å¼•æ“
                spawnTrickler();
                window.rainInterval = setInterval(spawnTrickler, 1200);
                runPhysicsLoop();
            }
            else if (iconType === 'snow') {
                // [é‡è¦] åˆ‡æ›åˆ°é›ªå¤©æ™‚ï¼Œå‹™å¿…æ¸…é™¤é›¨å¤©çš„ç‰©ç†é‹ç®—
                if (typeof clearRainTimers === 'function') {
                    clearRainTimers();
                }

                header.classList.add('w-snow');

                let html = '';
                // ç”Ÿæˆ 30 ç‰‡é›ªèŠ± (ä¾æ“šæ‚¨ snowflash æª”æ¡ˆä¸­çš„è¨­å®š)
                for (let i = 0; i < 30; i++) {
                    const left = Math.floor(Math.random() * 100);
                    const delay = (Math.random() * 5).toFixed(2);
                    // è®“é›ªèŠ±å¤§å°å·®ç•°å¤§ä¸€é» (3px ~ 8px)
                    const size = 3 + Math.floor(Math.random() * 6);

                    // opacity: 0.9 è®“å®ƒåœ¨æ·ºè‰²èƒŒæ™¯æ›´æ¸…æ¥š
                    html += `<div class="snow-flake" style="left:${left}%; width:${size}px; height:${size}px; animation-delay:${delay}s; opacity: 0.9;"></div>`;
                }
                layer.innerHTML = html;
            }
            else if (iconType === 'fog') {
                header.classList.add('w-fog');

                const isNight = header.classList.contains('is-night');

                // [ä¿®æ­£] è¨­å®šæ—¥å¤œé€æ˜åº¦
                // ç™½å¤© (0.8): éœ§å¾ˆæ¿ƒï¼Œä¸‹æ–¹ç™½ç™½çš„
                // æ™šä¸Š (0.2): éœ§å¾ˆè–„ï¼Œåƒä¸€å±¤è–„ç´—ï¼Œæ‰ä¸æœƒè®“å¤œç©ºè®Šæˆå…¨ç™½
                const fogOp = isNight ? 0.5 : 0.8;

                // ä½¿ç”¨å‰›å‰›æ–°å¢çš„ CSS class "fog-layer"
                layer.innerHTML = `<div class="fog-layer" style="opacity:${fogOp};"></div>`;
            }
            else {
                header.classList.add('w-cloud'); // é è¨­
            }
        }
        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('PWA Service Worker registered!', reg))
                    .catch(err => console.log('PWA registration failed:', err));
            });
        }
        // [æ–°å¢] é–‹å•Ÿè©³ç´°å¤©æ°£ Modal çš„é‚è¼¯
        async function openDetailedWeatherModal() {
            // 1. å–å¾—ç›®å‰ Header é¡¯ç¤ºçš„åœ°é»è³‡æ–™
            // å„ªå…ˆä½¿ç”¨è¡Œç¨‹è¡¨åˆ‡æ›çš„è¨­å®šï¼Œå¦‚æœæ²’æœ‰(ä¾‹å¦‚å‰›é–‹å•ŸApp)ï¼Œå‰‡ä½¿ç”¨ã€Œæˆ‘çš„ä½ç½®ã€
            let config = window.currentActiveConfig;

            // ç‰¹åˆ¤ï¼šå¦‚æœä½¿ç”¨è€…å‰›é»äº†ã€Œæˆ‘çš„ä½ç½®ã€ï¼Œæˆ‘å€‘éœ€è¦æŠ“å–æˆ‘çš„ä½ç½®çš„ç¶“ç·¯åº¦
            // é€™è£¡æˆ‘å€‘åˆ©ç”¨ä¹‹å‰ getLocalWeather å­˜å…¥çš„ appCache
            if (!config && window.appCache && window.appCache['my_location_combined']) {
                const myData = window.appCache['my_location_combined'].data;
                // ç”±æ–¼æˆ‘å€‘æ²’å­˜ç¶“ç·¯åº¦åœ¨ cache (åªå­˜äº†æ°£æº«)ï¼Œé€™è£¡ç°¡åŒ–è™•ç†ï¼š
                // å¦‚æœæ˜¯ã€Œæˆ‘çš„ä½ç½®ã€ç‹€æ…‹ï¼Œé‡æ–°è§¸ç™¼ä¸€æ¬¡ getLocalWeather ä¾†ç²å–ç¶“ç·¯åº¦ä¸¦å‘¼å« API
                // ç‚ºäº†ä¸è®“ç¨‹å¼ç¢¼å¤ªè¤‡é›œï¼Œé€™è£¡å»ºè­°ä½¿ç”¨è€…å…ˆé¸æ“‡ä¸€å¤©è¡Œç¨‹ï¼Œæˆ–æ˜¯æˆ‘å€‘ç›´æ¥é¡¯ç¤ºæç¤º
                if (!navigator.geolocation) { alert("ç„¡æ³•å–å¾—è©³ç´°è³‡è¨Š"); return; }

                navigator.geolocation.getCurrentPosition(pos => {
                    fetchAndShowDetail(pos.coords.latitude, pos.coords.longitude, myData.city);
                });
                return;
            }

            if (!config) {
                alert("è«‹å…ˆé¸æ“‡ä¸€å¤©è¡Œç¨‹ï¼Œæˆ–ç­‰å¾…å®šä½å®Œæˆã€‚");
                return;
            }

            // 2. å‘¼å« API ä¸¦é¡¯ç¤º
            fetchAndShowDetail(config.lat, config.lon, config.loc);
        }

        // [ä¿®æ”¹] æŠ“å–è©³ç´°å¤©æ°£è³‡æ–™ (åŠ å…¥æ¼¸å±¤åœ–ç¤ºé‚è¼¯)
        // [ä¿®æ”¹] æŠ“å–è©³ç´°å¤©æ°£è³‡æ–™ (ä¿®æ­£ï¼šç¾åœ¨æ¨™ç±¤ã€æ—¥å¤œåˆ¤æ–·ã€æ¨™æº–åœ–ç¤º)
        async function fetchAndShowDetail(lat, lon, locName) {
            // é¡¯ç¤º Loading
            document.getElementById('weather-detail-modal').style.display = 'flex';
            document.getElementById('wd-title').innerText = locName;
            // [æ–°å¢] è¨­å®šé‡æ•´æŒ‰éˆ•çš„åŠŸèƒ½ (é»æ“Šå¾Œé‡æ–°åŸ·è¡Œæ­¤å‡½å¼)
            document.getElementById('wd-btn-refresh').onclick = function () {
                // åŠ å…¥ç°¡å–®çš„æ—‹è½‰å‹•ç•«æ•ˆæœï¼Œè®“ä½¿ç”¨è€…çŸ¥é“æœ‰åœ¨è·‘
                const icon = this.querySelector('svg');
                if (icon) {
                    icon.style.transition = 'transform 0.5s';
                    icon.style.transform = 'rotate(360deg)';
                    setTimeout(() => { icon.style.transform = 'none'; }, 500);
                }
                // é‡æ–°æŠ“å–è³‡æ–™
                fetchAndShowDetail(lat, lon, locName);
            };
            // åˆå§‹åŒ–å„€è¡¨æ¿æ•¸å€¼
            document.getElementById('wd-cur-temp').innerText = '--Â°';
            document.getElementById('wd-cur-desc').innerText = 'è¼‰å…¥ä¸­...';
            document.getElementById('wd-feel').innerText = '--';
            document.getElementById('wd-pop').innerText = '--';
            document.getElementById('wd-uv').innerText = '--';
            document.getElementById('wd-wind').innerText = '--';

            document.getElementById('wd-hourly-list').innerHTML = '<div style="padding:10px;">è³‡æ–™è¼‰å…¥ä¸­...</div>';
            document.getElementById('wd-daily-list').innerHTML = '';

            try {
                // [é—œéµä¿®æ”¹] URL æ–°å¢ hourly åƒæ•¸: apparent_temperature (é«”æ„Ÿ), uv_index (ç´«å¤–ç·š), wind_speed_10m (é¢¨é€Ÿ)
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,weathercode,precipitation_probability,apparent_temperature,uv_index,wind_speed_10m&daily=weathercode,temperature_2m_max,temperature_2m_min,sunrise,sunset,precipitation_probability_max&current_weather=true&timezone=auto`;

                const res = await fetch(url);
                const data = await res.json();

                // --- 0. è™•ç†æ™‚é–“ç´¢å¼• (ä¿®æ­£ï¼šä½¿ç”¨ç•¶åœ°çš„ current_weather æ™‚é–“) ---
                // Open-Meteo çš„ current_weather.time å›å‚³çš„æ˜¯ç•¶åœ°çš„ ISO æ™‚é–“ (ä¾‹å¦‚ "2026-01-27T11:00")
                const localTimeStr = data.current_weather.time;

                // ç›´æ¥åœ¨ hourly åˆ—è¡¨ä¸­å°‹æ‰¾é€™å€‹æ™‚é–“å­—ä¸²ï¼Œå°±èƒ½ç²¾æº–å°æ‡‰åˆ°ç•¶åœ°çš„ã€Œç¾åœ¨ã€
                let startIdx = data.hourly.time.indexOf(localTimeStr);

                // é˜²å‘†ï¼šå¦‚æœå‰›å¥½æ²’å°åˆ° (æ¥µå°‘è¦‹)ï¼Œå‰‡é è¨­å¾ 0 é–‹å§‹
                if (startIdx === -1) {
                    // å˜—è©¦åªæ¯”å° "YYYY-MM-DDTHH" (å‰13ç¢¼)ï¼Œå¿½ç•¥åˆ†é˜å·®ç•°
                    const hourStr = localTimeStr.substring(0, 13);
                    startIdx = data.hourly.time.findIndex(t => t.startsWith(hourStr));
                }

                if (startIdx === -1) startIdx = 0;

                // --- 1. æ›´æ–°ä¸Šæ–¹å„€è¡¨æ¿ (Dashboard) ---
                // ä½¿ç”¨ç›®å‰é€™å°æ™‚çš„è©³ç´°æ•¸æ“š
                const curTemp = Math.round(data.current_weather.temperature);
                const curCode = data.current_weather.weathercode;
                const curFeel = Math.round(data.hourly.apparent_temperature[startIdx]);
                const curPop = data.hourly.precipitation_probability[startIdx];
                const curUv = data.hourly.uv_index[startIdx];
                const curWind = Math.round(data.hourly.wind_speed_10m[startIdx]);

                const todayMax = Math.round(data.daily.temperature_2m_max[0]);
                const todayMin = Math.round(data.daily.temperature_2m_min[0]);

                document.getElementById('wd-cur-temp').innerText = `${curTemp}Â°`;
                document.getElementById('wd-cur-desc').innerText = getWeatherDescText(curCode); // ä½¿ç”¨æ—¢æœ‰çš„æ–‡å­—è½‰æ›å‡½å¼
                document.getElementById('wd-cur-hl').innerText = `é«˜:${todayMax}Â° ä½:${todayMin}Â°`;

                document.getElementById('wd-feel').innerText = `${curFeel}Â°`;
                document.getElementById('wd-pop').innerText = `${curPop}%`;
                document.getElementById('wd-uv').innerText = curUv;
                document.getElementById('wd-wind').innerText = `${curWind} km/h`;


                // --- 2. æ›´æ–°æ—¥å‡ºæ—¥è½ ---
                const todayIndex = 0;
                const sunriseStr = data.daily.sunrise[todayIndex].split('T')[1];
                const sunsetStr = data.daily.sunset[todayIndex].split('T')[1];
                const sunriseHour = parseInt(sunriseStr.split(':')[0]);
                const sunsetHour = parseInt(sunsetStr.split(':')[0]);

                document.getElementById('wd-sunrise').innerText = sunriseStr;
                document.getElementById('wd-sunset').innerText = sunsetStr;
                // --- [æ–°å¢] 2.5 æ›´æ–°å³å´ï¼šæº«å·®æ¯”å°èˆ‡ç©¿è¡£å»ºè­° ---

                // A. æº«å·®æ¯”å°
                const diffBadge = document.getElementById('wd-diff-badge');
                // currentMyTemp æ˜¯å…¨åŸŸè®Šæ•¸ï¼Œè‹¥æœ‰å®šä½æˆåŠŸæœƒæœ‰æ•¸å€¼
                if (typeof currentMyTemp !== 'undefined' && currentMyTemp !== null) {
                    const diff = curTemp - currentMyTemp;
                    diffBadge.style.display = 'inline-flex';

                    if (Math.abs(diff) < 2) {
                        // æº«å·®å°æ–¼ 2 åº¦ï¼Œä¸é¡¯ç¤ºå·®ç•°ï¼Œæˆ–é¡¯ç¤ºå·®ä¸å¤š
                        diffBadge.style.display = 'none';
                    } else if (diff > 0) {
                        diffBadge.className = 'diff-badge diff-hot';
                        diffBadge.innerHTML = `æ°£æº«æ¯”ç›®å‰é«˜ ${diff.toFixed(1)}Â°C`;
                    } else {
                        diffBadge.className = 'diff-badge diff-cold';
                        diffBadge.innerHTML = `æ°£æº«æ¯”ç›®å‰ä½ ${Math.abs(diff).toFixed(1)}Â°C`;
                    }
                } else {
                    diffBadge.style.display = 'none'; // ç„¡å®šä½è³‡æ–™æ™‚éš±è—
                }

                // B. ç©¿è¡£å»ºè­° (é‡è¤‡åˆ©ç”¨æ‚¨æ—¢æœ‰çš„æ™ºæ…§å»ºè­°å‡½å¼)
                // getSmartAdviceText(æº«åº¦, å¤©æ°£ä»£ç¢¼) æ˜¯æ‚¨ç¨‹å¼ç¢¼ä¸­å·²ç¶“å­˜åœ¨çš„å‡½å¼
                const smartAdvice = getSmartAdviceText(curTemp, curCode);
                document.getElementById('wd-advice-text').innerText = smartAdvice;

                // --- 3. æ¸²æŸ“ 24å°æ™‚é å ± (ç¶­æŒä¸è®Š) ---
                const hourlyContainer = document.getElementById('wd-hourly-list');
                hourlyContainer.innerHTML = '';

                for (let i = startIdx; i < startIdx + 24; i++) {
                    if (!data.hourly.time[i]) break;

                    let hourRaw = parseInt(data.hourly.time[i].split('T')[1].split(':')[0]);
                    let timeStr = (i === startIdx) ? "ç¾åœ¨" : `${hourRaw}æ™‚`;
                    let isNight = (hourRaw < sunriseHour || hourRaw >= sunsetHour);
                    const temp = Math.round(data.hourly.temperature_2m[i]);
                    const code = data.hourly.weathercode[i];

                    const iconSvg = getSimpleIconSvg(code, 0, `h${i}`, isNight);
                    const statusText = getWeatherStatusText(code);

                    const item = document.createElement('div');
                    item.className = 'wd-hour-item';

                    item.innerHTML = `
                <div class="wd-hour-time" style="${i === startIdx ? 'font-weight:bold; color:#2563EB;' : ''}">${timeStr}</div>
                <div class="wd-hour-icon">${iconSvg}</div>
                <div class="wd-hour-desc">${statusText}</div>
                <div class="wd-hour-temp">${temp}Â°</div>
            `;
                    hourlyContainer.appendChild(item);
                }

                // --- 4. æ¸²æŸ“æœªä¾† 7 å¤©é å ± (ç´…ç·šçµ•å°é˜²ç¦¦ç‰ˆï¼šGap ç¡¬æ€§éš”é›¢) ---
                const dailyContainer = document.getElementById('wd-daily-list');
                dailyContainer.innerHTML = '';

                const weeklyMaxVals = data.daily.temperature_2m_max.slice(0, 7);
                const weeklyMinVals = data.daily.temperature_2m_min.slice(0, 7);
                const globalMax = Math.max(...weeklyMaxVals);
                const globalMin = Math.min(...weeklyMinVals);
                const globalRange = globalMax - globalMin || 1;

                for (let i = 0; i < 7; i++) {
                    const max = Math.round(data.daily.temperature_2m_max[i]);
                    const min = Math.round(data.daily.temperature_2m_min[i]);
                    const code = data.daily.weathercode[i];
                    const popMax = data.daily.precipitation_probability_max[i];
                    const iconSvg = getSimpleIconSvg(code, popMax, `d${i}`, false);

                    const dateObj = new Date(data.daily.time[i]);
                    const dayNames = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];
                    const dayName = dayNames[dateObj.getDay()];

                    const leftPercent = ((min - globalMin) / globalRange) * 100;
                    const widthPercent = ((max - min) / globalRange) * 100;

                    let dotHtml = '';
                    if (i === 0) {
                        const currentT = data.current_weather.temperature;
                        const dotPercent = ((currentT - globalMin) / globalRange) * 100;
                        dotHtml = `
                        <div style="
                            position: absolute;
                            left: ${dotPercent}%;
                            top: 50%;
                            transform: translate(-50%, -50%);
                            width: 10px;
                            height: 10px;
                            background: #FFFFFF;
                            border: 2px solid #374151;
                            border-radius: 50%;
                            box-shadow: 0 0 3px rgba(0,0,0,0.3);
                            z-index: 10;
                        "></div>
                    `;
                    }

                    const row = document.createElement('div');
                    row.className = 'wd-daily-row';

                    // [æœ€çµ‚è§£æ±ºæ–¹æ¡ˆ]
                    // 1. gap: 15px; -> é€™å°±æ˜¯æ‚¨çš„ç´…ç·šã€‚
                    //    é€™æ˜¯ Grid ç³»çµ±çš„å¼·åˆ¶é–“è·ï¼Œä»»ä½•å…ƒç´ éƒ½ç„¡æ³•é€²å…¥é€™ 15px çš„ç¯„åœã€‚
                    // 2. è‰²æ¢æ¬„ä½å¯¬åº¦: 80px; -> å°‡è‰²æ¢é™åˆ¶åœ¨ä¸­é–“è¼ƒçª„çš„å€åŸŸã€‚
                    row.style.cssText = `
                    display: grid;
                    grid-template-columns: 45px 85px 1fr 30px 80px 30px;
                    align-items: center;
                    gap: 15px; 
                    padding: 8px 0;
                    border-bottom: 1px solid #f0f0f0;
                `;

                    row.innerHTML = `
                    <div style="text-align:center;">
                        <div style="font-weight:700; font-size:0.9rem; color:#374151;">${i === 0 ? 'ä»Šå¤©' : dayName}</div>
                    </div>

                    <div style="display:flex; flex-direction:row; align-items:center; justify-content:flex-start; gap: 12px;">
                        <div style="width:30px; height:30px; flex-shrink:0;">${iconSvg}</div>
                        ${popMax > 0 ? `<div style="font-size:0.8rem; color:#60A5FA; font-weight:700; white-space:nowrap;">${popMax}%</div>` : ''}
                    </div>
                    
                    <div></div>

                    <div style="text-align:right; font-family:monospace; font-weight:600; color:#9CA3AF; font-size:0.95rem;">${min}Â°</div>

                    <div style="height: 6px; position: relative; width: 100%;">
                        <div style="
                            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                            background: #E5E7EB; 
                            border-radius: 10px; 
                            overflow: hidden; /* â˜…é—œéµï¼šé€™è£¡è² è²¬åˆ‡æ‰è·‘å‡ºå»çš„è‰²æ¢ */
                        ">
                            <div style="
                                position: absolute;
                                top: 0;
                                bottom: 0;
                                left: ${leftPercent}%;
                                width: ${widthPercent}%;
                                min-width: 6px;
                                border-radius: 10px;
                                background: linear-gradient(90deg, #22D3EE, #34D399, #FBBF24, #FB923C, #F87171);
                                opacity: 0.9;
                            "></div>
                        </div>
                        
                        ${dotHtml}
                    </div>

                    <div style="text-align:left; font-family:monospace; font-weight:600; color:#374151; font-size:0.95rem;">${max}Â°</div>
                `;
                    dailyContainer.appendChild(row);
                }

            } catch (e) {
                console.error(e);
                document.getElementById('wd-hourly-list').innerHTML = 'ç„¡æ³•å–å¾—è©³ç´°è³‡æ–™';
                alert('ç²å–å¤©æ°£è©³æƒ…å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚');
            }
        }

        // [ä¿®æ”¹] å–å¾—æ¨™æº–å¤©æ°£ SVG åœ–ç¤º
        // pop: é™é›¨æ©Ÿç‡ (æ±ºå®šæ°´ä½ï¼Œè‹¥ç‚º0å‰‡ç´”ç·šæ¢)
        // isNight: æ˜¯å¦ç‚ºæ™šä¸Š (æ±ºå®šé¡¯ç¤ºå¤ªé™½é‚„æ˜¯æœˆäº®)
        // [ä¿®æ”¹] æœ€çµ‚å®Œæ•´ç‰ˆï¼šæ•´åˆå¤ªé™½å…‰èŠ’åˆ‡æ›ã€è—è‰²é›¨æ»´ã€é›·é›¨é›™é–ƒé›»
        // [ä¿®æ­£] æœ€çµ‚é™¤éŒ¯ç‰ˆï¼šä¿®å¾©é›·é›¨è¢«èª¤åˆ¤ç‚ºé›¨å¤©(Code 80+)çš„å•é¡Œ
        // [ä¿®æ”¹] æœ€çµ‚ç‰ˆï¼šåŠ å…¥ã€Œéœ§ã€çš„æ°´ä½è¨ˆæ”¯æ´ + æ‰€æœ‰ä¿®å¾©
        // [ä¿®æ”¹] æœ€çµ‚ç¾åŒ–ç‰ˆï¼šåŠ å…¥ç²¾ç·»ã€Œå…­è§’é›ªèŠ±ã€é€ å‹ + å®Œæ•´åŠŸèƒ½
        // [ä¿®æ”¹] æœ€çµ‚å®Œæˆç‰ˆï¼šåš´æ ¼å¹¾ä½•å°ç¨±é›ªèŠ± + å…¨å±€æ°´ä½è¨ˆ (ç”±ä¸‹è€Œä¸Šå¹³æ•´å¡«æ»¿)
        function getSimpleIconSvg(code, pop, uid, isNight = false) {
            const originalColor = "#374151";
            const waterColor = "#60A5FA";
            const percentage = pop || 0;

            // 1. å®šç¾©æ¼¸å±¤ (ä¿®æ”¹ç‚º userSpaceOnUse æ¨¡å¼)
            let defs = '';
            let strokeAttr = `stroke="${originalColor}"`;

            if (percentage > 0) {
                defs = `
        <defs>
            <linearGradient id="grad-${uid}" x1="0" y1="24" x2="0" y2="0" gradientUnits="userSpaceOnUse">
                <stop offset="${percentage}%" stop-color="${waterColor}" />
                <stop offset="${percentage}%" stop-color="${originalColor}" />
            </linearGradient>
        </defs>`;
                strokeAttr = `stroke="url(#grad-${uid})"`;
            }

            const commonAttr = `viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" ${strokeAttr}`;

            let path = '';

            // 2. åœ–ç¤ºç¹ªè£½é‚è¼¯
            if (code === 0 || code === 1) {
                // === æ™´æœ— ===
                if (isNight) {
                    path = `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>`;
                } else {
                    // å¤ªé™½
                    if (percentage > 0) {
                        path = `<circle cx="12" cy="12" r="5"></circle>`;
                        // å¤ªé™½å…‰èŠ’ç¶­æŒç´”è‰²ï¼Œä¸åƒèˆ‡æ°´ä½æ¼¸å±¤
                        const rayStyle = `stroke="${originalColor}"`;
                        path += `
                    <line x1="12" y1="1" x2="12" y2="4" ${rayStyle}></line>
                    <line x1="12" y1="1" x2="12" y2="4" transform="rotate(60 12 12)" ${rayStyle}></line>
                    <line x1="12" y1="1" x2="12" y2="4" transform="rotate(120 12 12)" ${rayStyle}></line>
                    <line x1="12" y1="1" x2="12" y2="4" transform="rotate(180 12 12)" ${rayStyle}></line>
                    <line x1="12" y1="1" x2="12" y2="4" transform="rotate(240 12 12)" ${rayStyle}></line>
                    <line x1="12" y1="1" x2="12" y2="4" transform="rotate(300 12 12)" ${rayStyle}></line>
                `;
                    } else {
                        path = `
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                `;
                    }
                }
            } else if (code === 2 || code === 3) {
                // === å¤šé›² ===
                path = `<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>`;
            } else if (code >= 45 && code <= 48) {
                // === éœ§ ===
                path = `<path d="M4 10h16 M4 14h16 M4 18h16"></path>`;
            } else if ((code >= 51 && code <= 67) || (code >= 80 && code <= 82)) {
                // === é›¨ ===
                path = `
            <line x1="16" y1="13" x2="16" y2="21" stroke="${waterColor}"></line>
            <line x1="8" y1="13" x2="8" y2="21" stroke="${waterColor}"></line>
            <line x1="12" y1="15" x2="12" y2="23" stroke="${waterColor}"></line>
            <path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"></path>
        `;
            } else if ((code >= 71 && code <= 77) || (code >= 85 && code <= 86)) {
                // === é›ªï¼šåš´æ ¼å¹¾ä½•å°ç¨±ç‰ˆ + å…¨å±€æ°´ä½è¨ˆ ===

                // 1. ä¸­å¤®å…­è§’å†°æ ¸ (R=3)
                path = `<path d="M12 9 L14.6 10.5 L14.6 13.5 L12 15 L9.4 13.5 L9.4 10.5 Z"></path>`;

                // 2. å…­æ¢ç›´ç·šä¸»å¹¹ (R=3 åˆ° R=11)
                path += `
            <path d="M12 9 V1 M12 15 V23"></path> <path d="M14.6 10.5 L21.5 6.5 M14.6 13.5 L21.5 17.5"></path> <path d="M9.4 13.5 L2.5 17.5 M9.4 10.5 L2.5 6.5"></path>     `;

                // 3. V å‹çµæ§‹ (å¹¾ä½•å°ç¨±è¤‡è£½)
                // --- ä¸Š (0åº¦) ---
                path += `<path d="M9.5 5.5 L12 7.5 L14.5 5.5"></path>`;
                path += `<path d="M9.5 2 L12 4 L14.5 2"></path>`;

                // --- ä¸‹ (180åº¦) ---
                path += `<path d="M9.5 18.5 L12 16.5 L14.5 18.5"></path>`;
                path += `<path d="M9.5 22 L12 20 L14.5 22"></path>`;

                // --- å³ä¸Š (60åº¦) ---
                path += `<path d="M16.4 6.6 L15.9 9.75 L18.9 10.9"></path>`;
                path += `<path d="M19.4 4.8 L18.9 8 L21.9 9.2"></path>`;

                // --- å³ä¸‹ (120åº¦) ---
                path += `<path d="M18.9 13.1 L15.9 14.25 L16.4 17.4"></path>`;
                path += `<path d="M21.9 14.8 L18.9 16 L19.4 19.2"></path>`;

                // --- å·¦ä¸‹ (240åº¦) ---
                path += `<path d="M7.6 17.4 L8.1 14.25 L5.1 13.1"></path>`;
                path += `<path d="M4.6 19.2 L5.1 16 L2.1 14.8"></path>`;

                // --- å·¦ä¸Š (300åº¦) ---
                path += `<path d="M5.1 10.9 L8.1 9.75 L7.6 6.6"></path>`;
                path += `<path d="M2.1 9.2 L5.1 8 L4.6 4.8"></path>`;

            } else if (code >= 95) {
                // === é›·é›¨ ===
                path = `<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>`;
                /*path += `<polygon points="19 2 16 7 18 7 17 11 22 5 20 5 19 2"></polygon>`;*/
            } else {
                path = `<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>`;
            }

            return `<svg ${commonAttr}>${defs}${path}</svg>`;
        }
        // A. åˆ‡æ›è¼¸å…¥æ¨¡å¼
        function toggleLedgerInput() {
            const type = document.getElementById('ledger-type').value;
            document.getElementById('ledger-finance-fields').style.display = type === 'finance' ? 'block' : 'none';
            document.getElementById('ledger-note-fields').style.display = type === 'note' ? 'block' : 'none';
        }

        // [é–‹å§‹] æ›¿æ›èº«åˆ†å®šç¾©ç›¸é—œé‚è¼¯
        const AVATAR_OPTIONS = [
            'ğŸ¦', 'ğŸ°', 'ğŸ¼', 'ğŸ¨', 'ğŸ¦Š', 'ğŸ±', 'ğŸ¶', 'ğŸ¯', 'ğŸµ', 'ğŸ·',
            'ğŸ¹', 'ğŸ»', 'ğŸ®', 'ğŸ¸', 'ğŸ”', 'ğŸ§', 'ğŸ¦„', 'ğŸ™', 'ğŸ¦–', 'ğŸ¬'
        ];

        // [å·²ä¿®æ­£] åˆå§‹åŒ–é ­åƒé¸æ“‡å™¨ (å…§å»ºæ·¨æ°´å™¨åŠŸèƒ½)
        function initAvatarSelector() {
            const container = document.getElementById('avatar-list');
            if (!container) return;

            // â˜…â˜…â˜… é—œéµä¿®æ­£ 1ï¼šè®€å–ä¸¦æ¸…æ´—é«’è³‡æ–™ â˜…â˜…â˜…
            let safeName = 'çˆ¸çˆ¸'; // é è¨­å€¼
            const cachedName = localStorage.getItem('last_user_name');

            if (cachedName) {
                const raw = cachedName.trim();
                // æª¢æŸ¥ï¼šå¦‚æœè®€å‡ºä¾†çš„è³‡æ–™åƒ JSON (ä»¥ { é–‹é ­)ï¼Œä»£è¡¨æ˜¯é«’è³‡æ–™
                if (raw.startsWith('{')) {
                    try {
                        const parsed = JSON.parse(raw);
                        // å˜—è©¦æ•‘å›çœŸæ­£çš„åå­— (æ’é™¤ undefined æˆ–éè¿´ JSON)
                        if (parsed.name && !parsed.name.startsWith('{')) {
                            safeName = parsed.name;
                        } else {
                            safeName = 'åŒ¿å'; // æ•‘ä¸å›ä¾†å°±é‡ç½®
                        }
                    } catch (e) {
                        safeName = 'çˆ¸çˆ¸'; // è§£æå¤±æ•—ç”¨é è¨­å€¼
                    }
                } else if (raw !== 'undefined' && raw !== 'null') {
                    // å¦‚æœæ˜¯ä¹¾æ·¨çš„ç´”æ–‡å­—ï¼Œç›´æ¥ç”¨
                    safeName = raw;
                }
            }
            // â˜…â˜…â˜… ä¿®æ­£çµæŸ â˜…â˜…â˜…

            const lastEmoji = localStorage.getItem('last_user_emoji') || 'ğŸ¦';

            // å°‡æ¸…æ´—éçš„åå­—å¡«å…¥ä»‹é¢
            const nameInput = document.getElementById('custom-user-name');
            if (nameInput) {
                nameInput.value = safeName;
                // åŒæ­¥æ›´æ–°å…¨åŸŸé˜²ç¦¦è®Šæ•¸ (é…åˆ handleLedgerSubmit)
                if (window.TEMP_USER_NAME !== undefined) window.TEMP_USER_NAME = safeName;
            }

            document.getElementById('current-selected-emoji').innerText = lastEmoji;

            // å‹•æ…‹ç”Ÿæˆé ­åƒåˆ— (ä¿æŒä¸è®Š)
            container.innerHTML = AVATAR_OPTIONS.map((emoji) => `
        <div class="avatar-item ${emoji === lastEmoji ? 'active' : ''}" 
             onclick="selectAvatar('${emoji}', this)"
             style="font-size: 1.8rem; cursor: pointer; padding: 10px; border-radius: 50%; border: 2px solid transparent; background: #f8fafc; flex-shrink: 0; transition: 0.2s; line-height: 1;">
            ${emoji}
        </div>
    `).join('');

            // æ›´æ–°éš±è—æ¬„ä½
            updateUserInfoFromUI();
        }

        function selectAvatar(emoji, el) {
            document.getElementById('current-selected-emoji').innerText = emoji;
            document.querySelectorAll('.avatar-item').forEach(item => {
                item.style.borderColor = 'transparent';
                item.style.background = '#f8fafc';
            });
            el.style.borderColor = '#2563EB';
            el.style.background = '#EFF6FF';

            updateUserInfoFromUI();
            localStorage.setItem('last_user_emoji', emoji);
        }

        // [å·²ä¿®æ­£] æ›´æ–°ä½¿ç”¨è€…è³‡è¨Š (é˜²æ­¢é«’è³‡æ–™å¯«å…¥å¿«å–)
        function updateUserInfoFromUI() {
            const nameInput = document.getElementById('custom-user-name');
            let name = nameInput ? nameInput.value : 'åŒ¿å';

            // â˜…â˜…â˜… é—œéµä¿®æ­£ 2ï¼šå¯«å…¥å‰çš„æœ€å¾Œé˜²ç·š â˜…â˜…â˜…
            // å¦‚æœåå­—çœ‹èµ·ä¾†åƒ JSON (ä»¥ { é–‹é ­) æˆ–åŒ…å« avatar é—œéµå­—ï¼Œå¼·åˆ¶é‡ç½®
            if (name && (name.trim().startsWith('{') || name.includes('"avatar"') || name.includes('avatar":'))) {
                console.warn('âš ï¸ æ””æˆªåˆ°é«’è³‡æ–™ï¼Œå¼·åˆ¶ä¿®æ­£ç‚ºåŒ¿å');
                name = 'åŒ¿å';
                // åŒæ­¥ä¿®æ­£ä»‹é¢ï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ°ä¹¾æ·¨çš„åå­—
                if (nameInput) nameInput.value = 'åŒ¿å';
            }

            // é˜²å‘†
            if (!name || name === 'undefined' || name === 'null') {
                name = 'åŒ¿å';
            }
            // â˜…â˜…â˜… ä¿®æ­£çµæŸ â˜…â˜…â˜…

            const avatar = document.getElementById('current-selected-emoji').innerText;

            // æ›´æ–°éš±è—æ¬„ä½ (é€™æ˜¯çµ¦ç¨‹å¼çœ‹çš„ï¼Œæ²’é—œä¿‚)
            const infoEl = document.getElementById('selected-user-info');
            if (infoEl) {
                infoEl.value = JSON.stringify({ name: name, avatar: avatar });
            }

            // â˜… é—œéµï¼šåªå­˜å…¥ã€Œä¹¾æ·¨çš„ç´”æ–‡å­—ã€åˆ°å¿«å–
            localStorage.setItem('last_user_name', name);

            // [æ–°å¢] åŒæ­¥æ›´æ–° "å€‹äºº" é¸é …çš„é¡¯ç¤ºåç¨±
            const privateOptions = document.querySelectorAll('#ledger-pay-type option[value="private"], #bill-scan-pay-type option[value="private"]');
            privateOptions.forEach(opt => {
                opt.innerText = name || 'å€‹äºº';
            });

            // æ›´æ–°å…¨åŸŸè®Šæ•¸ (é…åˆ handleLedgerSubmit)
            window.TEMP_USER_NAME = name;
        }
        // [çµæŸ] æ›¿æ›èº«åˆ†å®šç¾©ç›¸é—œé‚è¼¯

        // [æœ€çµ‚æ·¨åŒ–ç‰ˆ] è™•ç†è¨˜å¸³é€å‡º (å¾¹åº•é˜²æ­¢è³‡æ–™æ±¡æŸ“ + æŒ‰éˆ•å›é¥‹å„ªåŒ–)
        async function handleLedgerSubmit() {
            // åˆ¤æ–·æ˜¯å¦ç‚ºè¨˜å¸³æ¨¡å¼ (æ±ºå®šè¦ç”¨å“ªç¨® Loading æ–¹å¼)
            const isFinance = (document.getElementById('ledger-type')?.value === 'finance') ||
                (document.getElementById('ledger-finance-fields').style.display !== 'none');

            // å–å¾—æŒ‰éˆ•
            let activeBtn;
            if (isFinance) {
                activeBtn = document.querySelector('#ledger-finance-fields .btn-submit-ledger');
            } else {
                activeBtn = document.querySelector('#ledger-note-fields .btn-submit-ledger');
            }

            // å‚™ä»½åŸå§‹åœ–ç¤º (ç´™é£›æ©Ÿ + æ–‡å­—)
            // let originalContent = activeBtn ? activeBtn.innerHTML : '';
            // æ”¹ç‚ºï¼šä¸ç®¡åŸæœ¬æ˜¯ä»€éº¼ï¼Œæˆ‘å€‘éƒ½é æœŸæ¢å¾©æˆæ¨™æº–çš„ã€Œç´™é£›æ©Ÿã€åœ–ç¤º (å› ç‚º Edit æ¨¡å¼æœƒæŠŠåœ–ç¤ºæ”¹æˆæ‰“å‹¾ï¼Œsubmit å®Œè¦è®Šå›ç´™é£›æ©Ÿ)
            const originalIconSVG = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${isFinance ? '#F97316' : '#2563EB'}"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>`;

            // å¦‚æœæ˜¯ç´”åœ–ç¤ºï¼ˆFinanceï¼‰ï¼Œå°±æ¢å¾©ç´”åœ–ç¤ºï¼›å¦‚æœæ˜¯æ–‡å­—+åœ–ç¤ºï¼ˆNoteï¼‰ï¼Œå°±æ¢å¾©æ–‡å­—+åœ–ç¤º

            if (activeBtn) {
                // ä½¿ç”¨æŒ‰éˆ•å…§ Loading (æ©˜è‰²è½‰åœˆåœˆ)
                activeBtn.disabled = true;
                activeBtn.innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#F59E0B" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="animation: spin 1s linear infinite;">
                    <style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>
                    <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
                </svg>`;
            } else {
                showGlobalLoading();
            }

            console.log("ã€åŸ·è¡Œç‰ˆæœ¬ï¼šv2026-CLEAN-FLOW + UXå›é¥‹ã€‘");

            try {
                // ============================================================
                // 1. æŠ“å–ä½¿ç”¨è€…è³‡æ–™ (å¤šé‡ä¾†æº + é«’è³‡æ–™æ¸…æ´—)
                // ============================================================
                // ä¾†æº A: å„ªå…ˆè®€å– LocalStorage
                let userName = localStorage.getItem('last_user_name');
                if (!userName && window.TEMP_USER_NAME) userName = window.TEMP_USER_NAME.trim();

                // ä¾†æº C: æœ€å¾Œå˜—è©¦ DOM
                if (!userName) {
                    const el = document.getElementById('custom-user-name') || document.querySelector('.user-name-input');
                    if (el) userName = el.value.trim();
                }

                // â˜…â˜…â˜… æ ¸å¿ƒæ·¨åŒ–é‚è¼¯ â˜…â˜…â˜…
                if (userName.startsWith('{') || userName.includes('"avatar"') || userName.includes('avatar":')) {
                    console.warn("âš ï¸ æ””æˆªåˆ°å—æ±™æŸ“çš„è³‡æ–™ï¼å·²è‡ªå‹•ä¿®å¾©ã€‚");
                    userName = 'åŒ¿å';
                    const el = document.getElementById('custom-user-name');
                    if (el) el.value = '';
                    window.TEMP_USER_NAME = '';
                }

                if (!userName || userName === 'undefined' || userName === 'null') userName = 'åŒ¿å';

                let userAvatar = localStorage.getItem('last_user_emoji') || 'ğŸ¦';

                // ============================================================
                // 2. æº–å‚™ Payload
                // ============================================================
                let finalRate = 0.21;
                const manualRateEl = document.getElementById('calc-rate');
                if (manualRateEl && parseFloat(manualRateEl.value) > 0) {
                    finalRate = parseFloat(manualRateEl.value);
                } else {
                    try {
                        const cached = localStorage.getItem('live_exchange_rate_cache');
                        if (cached) {
                            const parsed = JSON.parse(cached);
                            if (parsed.rate > 0) finalRate = parsed.rate;
                        }
                    } catch (e) { }
                }

                const rawAmount = document.getElementById('ledger-amount').value;
                const amountJpy = parseFloat(rawAmount) || 0;
                const amountTwd = amountJpy > 0 ? Math.round(amountJpy * finalRate) : 0;
                const finalAmountJpy = isFinance ? String(amountJpy) : "0";
                const finalAmountTwd = isFinance ? String(amountTwd) : "0";

                const payloadData = {
                    action: window.editingId ? 'edit' : 'upload',
                    token: (typeof getKey === 'function') ? getKey('gas_token') : '',
                    type: isFinance ? 'finance' : 'note',
                    id: window.editingId ? window.editingId : ((window.crypto && window.crypto.randomUUID) ? window.crypto.randomUUID() : ('id-' + Date.now())),
                    userName: userName,
                    userAvatar: userAvatar,
                    // [ä¿®æ”¹] çµ±ä¸€æ—¥æœŸé‚è¼¯ (Finance ä¹Ÿå¯ä»¥é¸æ—¥æœŸ)
                    date: (() => {
                        const el = isFinance ? document.getElementById('ledger-date') : document.getElementById('ledger-note-date');
                        // å„ªå…ˆä½¿ç”¨ ISO å€¼ (å› ç‚ºé¡¯ç¤ºå€¼å¯èƒ½æ˜¯ 2026/2/4)
                        return el ? (el.dataset.isoValue || el.value) : new Date().toISOString().split('T')[0];
                    })(),
                    timestamp: (() => {
                        try {
                            const dateEl = isFinance ? document.getElementById('ledger-date') : document.getElementById('ledger-note-date');
                            if (dateEl) {
                                const dVal = dateEl.dataset.isoValue || dateEl.value; // YYYY-MM-DD
                                if (dVal) {
                                    // æ”¯æ´å…©ç¨®åˆ†éš”ç¬¦
                                    let y, m, d;
                                    if (dVal.includes('/')) {
                                        [y, m, d] = dVal.split('/').map(Number);
                                    } else {
                                        [y, m, d] = dVal.split('-').map(Number);
                                    }
                                    const now = new Date();
                                    const combined = new Date(y, m - 1, d, now.getHours(), now.getMinutes(), now.getSeconds());
                                    return combined.toISOString();
                                }
                            }
                        } catch (e) {
                            console.warn("Date construction error, fallback to now:", e);
                        }
                        return new Date().toISOString();
                    })(),
                    rate: String(finalRate),
                    twdAmount: finalAmountTwd,
                    item: isFinance ? (document.getElementById('ledger-item')?.value || '') : (document.getElementById('ledger-note-content')?.value || ''),
                    content: isFinance ? (document.getElementById('ledger-item')?.value || '') : (document.getElementById('ledger-note-content')?.value || ''),
                    amount: finalAmountJpy,
                    // [æ–°å¢] ä»˜æ¬¾æ–¹å¼
                    paymentMethod: isFinance ? (document.getElementById('ledger-payment-method')?.value || 'cash') : '',
                    // [æ–°å¢] æ”¯ä»˜è€…é¡å‹ (Public or UserName)
                    paymentType: isFinance ? (document.getElementById('ledger-pay-type')?.value === 'public' ? 'Public' : userName) : '',
                    // [æ–°å¢] åŠ å…¥åœ–ç‰‡æ¬„ä½ (Array of Base64 or URLs)
                    images: window.currentNoteImages || []
                };

                // ============================================================
                // 3. ç™¼é€è«‹æ±‚
                // ============================================================
                const url = (typeof getKey === 'function') ? getKey('gas_url') : '';
                const resp = await fetch(url, { method: 'POST', body: JSON.stringify(payloadData) });
                const result = await resp.json();

                if (result.status === 'success' || result.result === 'success') {
                    // æ¸…ç©ºè¼¸å…¥
                    document.getElementById('ledger-item').value = '';
                    document.getElementById('ledger-amount').value = '';
                    document.getElementById('ledger-note-content').value = '';

                    // [æ–°å¢] é‡ç½®æ—¥æœŸç‚ºä»Šå¤© (Finance & Note)
                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    const todayStr = `${yyyy}-${mm}-${dd}`;

                    const noteDate = document.getElementById('ledger-note-date');
                    if (noteDate) {
                        noteDate.type = 'date';
                        noteDate.value = todayStr;
                        noteDate.dataset.isoValue = todayStr; // [é—œéµ] å¼·åˆ¶è¦†å¯«ç·©å­˜ç‚ºä»Šå¤©
                        if (typeof formatCompactDate === 'function') formatCompactDate(noteDate);
                    }

                    const finDate = document.getElementById('ledger-date');
                    if (finDate) {
                        finDate.type = 'date';
                        finDate.value = todayStr;
                        finDate.dataset.isoValue = todayStr; // [é—œéµ] å¼·åˆ¶è¦†å¯«ç·©å­˜ç‚ºä»Šå¤©
                        if (typeof formatCompactDate === 'function') formatCompactDate(finDate);
                    }

                    // [æ–°å¢] é‡ç½®ä»˜æ¬¾æ–¹å¼
                    const payMethod = document.getElementById('ledger-payment-method');
                    if (payMethod) payMethod.value = 'cash';

                    // [ä¿®æ­£] æ¸…ç©ºåœ–ç‰‡æš«å­˜èˆ‡é è¦½
                    window.currentNoteImages = [];
                    renderImagePreviews();

                    // [ä¿®æ­£] å…ˆåˆ¤æ–·æ˜¯å¦ç‚ºç·¨è¼¯æ¨¡å¼ (å› ç‚ºä¸‹é¢ exitEditMode æœƒæ¸…ç©º window.editingId)
                    const wasEditing = !!window.editingId;

                    if (window.editingId) {
                        try {
                            exitEditMode(); // [æ–°å¢] æˆåŠŸé€å‡ºå¾Œï¼Œå‘¼å«å–æ¶ˆæ¨¡å¼ä¾†å¾©åŸ UI
                        } catch (e) {
                            console.error("Exit edit mode error:", e);
                            window.editingId = null;
                        }
                    }

                    // [å›é¥‹é¡¯ç¤ºé‚è¼¯]
                    // [å›é¥‹é¡¯ç¤ºé‚è¼¯]
                    if (activeBtn) {
                        // é¡¯ç¤ºæ©˜è‰² OK (ç·¨è¼¯) æˆ– ç¶ è‰² OK (æ–°å¢)
                        const okColor = wasEditing ? '#F97316' : '#10B981';

                        // [ä¿®æ­£] å¼·åˆ¶è¨­å®šæŒ‰éˆ•æ¨£å¼ï¼Œä¸å— validation å½±éŸ¿
                        activeBtn.style.opacity = '1';
                        activeBtn.style.filter = 'none';
                        // é›–ç„¶ disable=true (å› ç‚ºæ¸…ç©ºè¼¸å…¥)ï¼Œä½†è¦–è¦ºä¸Šæˆ‘å€‘è¦å®ƒæ˜¯äº®è‰²çš„
                        // é€™è£¡å¯ä»¥è¨­ disabled=false ä»¥å…æœ‰äº› CSS selector å½±éŸ¿
                        activeBtn.disabled = false;

                        activeBtn.innerHTML = `<span style="color:${okColor}; font-weight:900; font-size:1.2rem;">OK</span>`;
                        // 1.5ç§’å¾Œé‚„åŸ
                        setTimeout(() => {
                            if (activeBtn) {
                                // é‚„åŸå›ç´™é£›æ©Ÿ
                                activeBtn.innerHTML = originalIconSVG;
                                // ä¿®æ­£é¡è‰²ï¼šFinance ç”¨æ©˜è‰²ï¼ŒNote ç”¨è—è‰²
                                // activeBtn.querySelector('svg').style.stroke = isFinance ? '#F97316' : '#2563EB'; 
                                activeBtn.disabled = false;
                            }
                            // [ä¿®æ­£] ç­‰åˆ°é‚„åŸåœ–ç¤ºå¾Œï¼Œæ‰å»æª¢æŸ¥ç‹€æ…‹ (é€™æ™‚ input æ˜¯ç©ºçš„ï¼Œæœƒè®Šç°)
                            updateLedgerSubmitState();
                        }, 1500);
                    } else {
                        alert(`âœ… å„²å­˜æˆåŠŸï¼`);
                        updateLedgerSubmitState();
                    }

                    if (typeof syncLedgerData === 'function') await syncLedgerData();
                } else {
                    throw new Error(result.message || "æœªçŸ¥éŒ¯èª¤");
                }

                // [ä¿®æ­£] ç§»é™¤é€™è£¡çš„ updateLedgerSubmitStateï¼Œæ”¹æˆåœ¨ setTimeout è£¡åš
                // updateLedgerSubmitState();

            } catch (e) {
                console.error("åŸ·è¡ŒéŒ¯èª¤:", e);
                // å¤±æ•—å›é¥‹
                // å¤±æ•—å›é¥‹
                if (activeBtn) {
                    // é¡¯ç¤ºç´…è‰² NG
                    activeBtn.innerHTML = `<span style="color:#EF4444; font-weight:900; font-size:1.2rem;">NG</span>`;
                    setTimeout(() => {
                        if (activeBtn) {
                            // é‚„åŸå›ç´™é£›æ©Ÿ (å³ä½¿å¤±æ•—ä¹Ÿé‚„åŸï¼Œä¸ä¿ç•™ Edit æ‰“å‹¾ç‹€æ…‹ï¼Œè®“ä½¿ç”¨è€…é‡æ–°å˜—è©¦æœƒæ¯”è¼ƒæ¸…æ¥š)
                            // æˆ–è€…ä¿ç•™æ‰“å‹¾ï¼Ÿé€šå¸¸å¤±æ•—å¾Œä¿æŒåŸç‹€æ¯”è¼ƒå¥½ï¼Œä½†é€™è£¡ç‚ºäº†ç°¡å–®é‚è¼¯ï¼Œå…ˆé‚„åŸæˆç´™é£›æ©Ÿ(è¦–ç‚ºé‡ç½®)
                            // ä¸ï¼Œç”¨æˆ¶èªªã€Œå¤±æ•—é¡¯ç¤ºNGã€ï¼Œé‚£NGå®Œæ‡‰è©²è®Šå›åŸæœ¬çš„æ¨£å­ (å¦‚æœæ˜¯ Edit æ¨¡å¼ï¼ŒåŸæœ¬æ˜¯æ‰“å‹¾)
                            // ä½†é€™è£¡æˆ‘å€‘ç°¡åŒ–ï¼šNG å®Œè®Šå›ç´™é£›æ©Ÿï¼Œå› ç‚ºè³‡æ–™å¯èƒ½æ²’é€å‡ºï¼Œ
                            // ä¿®æ­£ï¼šå¦‚æœ window.editingId é‚„åœ¨ï¼Œæ‡‰è©²è®Šå›æ‰“å‹¾ï¼Ÿ 
                            // æš«æ™‚çµ±ä¸€è®Šå›ç´™é£›æ©Ÿï¼Œå› ç‚ºå¤±æ•—é€šå¸¸éœ€è¦é‡æ–°æª¢æŸ¥
                            activeBtn.innerHTML = originalIconSVG;
                            activeBtn.disabled = false;
                        }
                    }, 2000);
                } else {
                    alert("âŒ éŒ¯èª¤: " + e.message);
                }
            } finally {
                if (!isFinance) hideGlobalLoading();
            }
        }

        // C. æŠ“å–ä¸¦æ¸²æŸ“åˆ—è¡¨ (ä¾æ“š backend.gs çš„ getAll)
        // A. æ–°å¢åˆ‡æ›è¦–åœ–å‡½å¼
        function filterLedgerView(type) {
            currentLedgerFilter = type;

            // æ›´æ–°æŒ‰éˆ•é€æ˜åº¦ï¼ˆè®“ä½¿ç”¨è€…çŸ¥é“ç›®å‰é¸ä¸­å“ªå€‹ï¼‰
            const btnFinance = document.getElementById('btn-view-finance');
            const btnNote = document.getElementById('btn-view-note');
            if (btnFinance) btnFinance.style.opacity = type === 'finance' ? '1' : '0.4';
            if (btnNote) btnNote.style.opacity = type === 'note' ? '1' : '0.4';

            // åˆ‡æ›è¼¸å…¥å€åŸŸé¡¯ç¤º
            const finFields = document.getElementById('ledger-finance-fields');
            const noteFields = document.getElementById('ledger-note-fields');
            if (finFields) finFields.style.display = type === 'finance' ? 'block' : 'none';
            if (noteFields) noteFields.style.display = type === 'note' ? 'block' : 'none';

            // åˆ‡æ›æ¨™é¡Œæ–‡å­—
            const title = document.getElementById('ledger-view-title');
            if (title) title.innerText = type === 'finance' ? 'å…¬è²»ç¸½æ”¯å‡º (JPY)' : 'è¨˜äº‹ç¸½æ•¸';

            // é‡æ–°æ¸²æŸ“æ¸…å–®
            renderLedgerList(rawLedgerData);

            // [æ–°å¢] åˆ‡æ›è¦–åœ–æ™‚åŒæ­¥æ›´æ–°æª¢æŸ¥æŒ‰éˆ•ç‹€æ…‹
            updateLedgerSubmitState();
        }

        // [æ–°å¢] ç¢ºä¿å…¨åŸŸè®Šæ•¸å­˜åœ¨ (è§£æ±º Delete/Edit æ‰¾ä¸åˆ°è³‡æ–™çš„å•é¡Œ)
        window.rawLedgerData = [];

        // B. æ›´æ–°å¾Œçš„åŒæ­¥å‡½å¼ (åŠ å…¥å¿«å–æ©Ÿåˆ¶)
        async function syncLedgerData() {
            const url = getKey('gas_url');
            const token = getKey('gas_token');
            if (!url || !token) return;

            try {
                const res = await fetch(`${url}?token=${token}&action=getAll`);
                const result = await res.json();
                if (result.status === 'success') {
                    // [ä¿®æ­£] å¼·åˆ¶å¯«å…¥ window ç‰©ä»¶ï¼Œç¢ºä¿ deleteLedgerItem å¯ä»¥è®€å–
                    window.rawLedgerData = result.data;
                    // åŒæ™‚æ›´æ–°æœ¬åœ°è®Šæ•¸ (å¦‚æœæœ‰çš„è©±)ä»¥é˜²è¬ä¸€
                    rawLedgerData = result.data;
                    renderLedgerList(window.rawLedgerData);
                }
            } catch (e) {
                console.error("åŒæ­¥å¤±æ•—", e);
            }
        }

        // [ä¿®æ­£ç‰ˆ] æ¸²æŸ“åˆ—è¡¨ (åˆ†çµ„ + æŠ˜ç–Š + å«å¹´ä»½)
        function renderLedgerList(data) {
            const listContainer = document.getElementById('ledger-list');
            if (!listContainer) return;

            // æ’åºï¼šæ–°çš„åœ¨ä¸Šé¢
            data.sort((a, b) => new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date));

            const currentUserName = localStorage.getItem('last_user_name') || 'åŒ¿å'; // [ç§»å‹•åˆ°å‰é¢å®šç¾©]

            const filteredData = data.filter(item => {
                // 1. åŸºæœ¬ Tab éæ¿¾ (finance / note)
                if (item.type !== currentLedgerFilter) return false;

                // 2. [æ–°å¢] éš±ç§éæ¿¾ï¼šåªé¡¯ç¤ºå…¬è²» OR è‡ªå·±çš„ç§äººæ”¯å‡º
                if (item.type === 'finance') {
                    const pType = item.paymentType || 'Public';
                    // å¦‚æœæ˜¯å…¬è²»ï¼Œä¿ç•™
                    if (pType === 'Public' || pType === 'public') return true;
                    // å¦‚æœæ˜¯ç§äººï¼Œæª¢æŸ¥æ˜¯å¦ç‚ºè‡ªå·±
                    if (currentUserName && pType === currentUserName) return true;

                    // å…¶ä»–äººçš„ç§äººæ”¯å‡º -> éš±è—
                    return false;
                }

                // Note æš«æ™‚ä¸éæ¿¾ (æˆ–è¦–éœ€æ±‚è€Œå®š)
                return true;
            });

            let totalJPY = 0;
            let totalTWD = 0;
            // [æ–°å¢] ç§äººæ”¯å‡ºçµ±è¨ˆ
            let privateJPY = 0;
            let privateTWD = 0;

            // [åˆªé™¤] é‡è¤‡å®£å‘Š
            // const currentUserName = localStorage.getItem('last_user_name') || 'åŒ¿å';

            if (filteredData.length === 0) {
                listContainer.innerHTML = `<div style="text-align: center; color: #999; padding: 60px;">å°šç„¡ç´€éŒ„</div>`;
                updateTotalDisplay(0, 0);
                // æ¸…ç©ºç§äººé¡¯ç¤º
                const pTotalEl = document.getElementById('user-private-total');
                if (pTotalEl) pTotalEl.innerText = '';
                return;
            }

            // 1. åˆ†çµ„é‚è¼¯ (Group By Date: YYYY-MM-DD)
            const groups = {};
            filteredData.forEach(item => {
                let dateStr = 'Unknown';
                let timeObj = new Date();
                try {
                    timeObj = new Date(item.timestamp || item.date);
                    // æ ¼å¼ï¼šYYYY-MM-DD
                    const y = timeObj.getFullYear();
                    const m = String(timeObj.getMonth() + 1).padStart(2, '0');
                    const d = String(timeObj.getDate()).padStart(2, '0');
                    dateStr = `${y}-${m}-${d}`;
                } catch (e) { }

                if (!groups[dateStr]) groups[dateStr] = [];
                groups[dateStr].push(item);

                // è¨ˆç®—ç¸½é¡ (ä¸è®Š)
                if (item.type === 'finance') {
                    const jpy = parseFloat(item.amount || 0);
                    const twd = item.twdAmount ? parseInt(item.twdAmount) : Math.round(jpy * (item.rate || 0.21));

                    const pType = item.paymentType || 'Public';

                    // å…¬è²»ç¸½è¨ˆ
                    if (pType === 'Public' || pType === 'public') {
                        totalJPY += jpy;
                        totalTWD += twd;
                    }
                    // ç§äººç¸½è¨ˆ (åªç®—ç›®å‰ç™»å…¥è€…çš„)
                    else if (pType === currentUserName) {
                        privateJPY += jpy;
                        privateTWD += twd;
                    }
                }
            });

            // æ›´æ–° UIé¡¯ç¤º
            updateTotalDisplay(totalJPY, totalTWD);

            const pTotalEl = document.getElementById('user-private-total');
            if (pTotalEl) {
                if (privateJPY > 0) {
                    pTotalEl.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: flex-start; margin-left: 8px; line-height: 1.2;">
                        <span style="font-weight: 700; color: #2563EB; font-size: 1rem;">Â¥ ${privateJPY.toLocaleString()}</span>
                        <span style="font-size: 0.75rem; color: #6B7280;">â‰ˆ NT$ ${privateTWD.toLocaleString()}</span>
                    </div>`;
                } else {
                    pTotalEl.innerText = '';
                }
            }

            // 2. æ¸²æŸ“åˆ†çµ„
            let html = '';
            // å–å¾—ä»Šå¤©çš„æ—¥æœŸå­—ä¸² (ç”¨ä¾†åˆ¤æ–·æ˜¯å¦é è¨­å±•é–‹)
            const now = new Date();
            const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

            // æ’åºæ—¥æœŸ (æ–°çš„æ—¥æœŸåœ¨ä¸Šé¢)
            const sortedDates = Object.keys(groups).sort((a, b) => new Date(b) - new Date(a));

            sortedDates.forEach(dateKey => {
                const groupItems = groups[dateKey];
                const isToday = (dateKey === todayStr);

                // æ ¼å¼åŒ–é¡¯ç¤ºæ¨™é¡Œ (YYYY/MM/DD + æ˜ŸæœŸ)
                let displayDateTitle = dateKey;
                try {
                    const d = new Date(dateKey); // é€™è£¡æœƒæ˜¯ UTC 00:00ï¼Œä½†å› ç‚ºæˆ‘å€‘åªå–å¹´æœˆæ—¥ï¼Œæ‡‰è©²æ²’å·®
                    // ä¿®æ­£ï¼šç›´æ¥è§£æå­—ä¸²é¿å…æ™‚å€å•é¡Œ
                    const [yy, mm, dd] = dateKey.split('-');
                    const dateObj = new Date(parseInt(yy), parseInt(mm) - 1, parseInt(dd));
                    const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
                    displayDateTitle = `${yy}/${mm}/${dd} (${dayNames[dateObj.getDay()]})`;
                } catch (e) { }

                // æ¨™é¡Œ HTML (é»æ“Šåˆ‡æ›é¡¯ç¤º)
                // isToday é è¨­å±•é–‹ï¼Œå…¶ä»–é è¨­æŠ˜ç–Š
                const arrowTransform = isToday ? 'rotate(180deg)' : 'rotate(0deg)';
                const contentDisplay = isToday ? 'block' : 'none';

                // ç”Ÿæˆ Group ID
                const groupId = `group-${dateKey}`;

                const itemCount = groupItems.length; // [æ–°å¢] è¨ˆç®—ç­†æ•¸

                html += `
                <div class="ledger-group" style="margin-bottom: 20px;">
                    <div onclick="toggleLedgerGroup('${groupId}', this)" 
                         style="display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; cursor: pointer; user-select: none;">
                        <div style="font-weight: 700; color: #4B5563; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                            <span>${displayDateTitle}</span>
                            <span style="font-size: 0.85rem; color: #9CA3AF; font-weight: 500;">(${itemCount})</span>
                            ${isToday ? '<span style="font-size:0.75rem; color:#EF4444; background:#FEE2E2; padding:2px 6px; border-radius:4px;">Today</span>' : ''}
                        </div>
                        <svg class="group-arrow" style="width: 20px; height: 20px; transition: transform 0.3s; transform: ${arrowTransform}; color: #9CA3AF;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                    
                    <div id="${groupId}" style="display: ${contentDisplay};">
                `;

                // æ¸²æŸ“è©²æ—¥æœŸçš„æ‰€æœ‰é …ç›®
                groupItems.forEach(item => {
                    // â˜…â˜…â˜… æ ¸å¿ƒè§£æé‚è¼¯ (èˆ‡åŸæœ¬ç›¸åŒ) â˜…â˜…â˜…
                    let displayUser = { name: 'æœªçŸ¥', avatar: 'ğŸ‘¤' };
                    try {
                        if (typeof item.user === 'object' && item.user !== null) {
                            displayUser = item.user;
                        } else if (typeof item.user === 'string') {
                            if (item.user.trim().startsWith('{')) {
                                displayUser = JSON.parse(item.user);
                            } else {
                                displayUser = { name: item.user, avatar: 'ğŸ‘¤' };
                            }
                        }
                    } catch (e) {
                        console.warn("è§£æä½¿ç”¨è€…è³‡æ–™å¤±æ•—", item.user);
                    }

                    // æ™‚é–“åªé¡¯ç¤º HH:mm (å› ç‚ºæ—¥æœŸåœ¨æ¨™é¡Œäº†)
                    let timeStr = '';
                    try {
                        const t = new Date(item.timestamp || item.date);
                        timeStr = `${t.getHours().toString().padStart(2, '0')}:${t.getMinutes().toString().padStart(2, '0')}`;
                    } catch (e) { }

                    if (item.type === 'finance') {
                        const jpy = parseFloat(item.amount || 0);
                        const twd = item.twdAmount ? parseInt(item.twdAmount) : Math.round(jpy * (item.rate || 0.21));
                        const displayTitle = item.content || item.item || 'ç„¡æ¨™é¡Œ';

                        // é©—è­‰èº«åˆ†
                        const currentUserName = localStorage.getItem('last_user_name');
                        let actionButtons = '';

                        // [æ–°å¢] ä»˜æ¬¾æ–¹å¼åœ–ç¤ºå°æ‡‰
                        let payIcon = 'ğŸ’µ'; // é è¨­ç¾é‡‘
                        const pm = (item.paymentMethod || '').toLowerCase();
                        if (pm.includes('card') || pm.includes('åˆ·å¡')) payIcon = 'ğŸ’³';
                        else if (pm.includes('ic') || pm.includes('suica')) payIcon = 'ğŸ§';
                        else if (pm.includes('pay')) payIcon = 'ğŸ“±';

                        if (currentUserName && displayUser.name === currentUserName) {
                            actionButtons = `
                            <div style="display: flex; gap: 10px; margin-top: 8px; justify-content: flex-end;">
                                <button onclick="editLedgerItem('${item.id}')" style="background:none; border:none; cursor:pointer; padding:4px;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <button onclick="deleteLedgerItem('${item.id}', this)" style="background:none; border:none; cursor:pointer; padding:4px;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#EF4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>`;
                        }

                        html += `
                        <div class="card" style="margin-bottom: 12px; padding: 15px; border-left: 4px solid #F97316; background: white; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="display: flex; gap: 12px;">
                                    <div style="display:flex; flex-direction:column; align-items:center; min-width:44px;">
                                        <span style="font-size: 1.8rem; line-height: 1;">${displayUser.avatar || 'ğŸ‘¤'}</span>
                                        <span style="font-size: 0.7rem; color: #6B7280; margin-top:2px; font-weight:500; text-align:center; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:44px;">${displayUser.name || 'æˆå“¡'}</span>
                                    </div>
                                    <div>
                                        <div style="font-weight: 700; font-size: 1.1rem; color: #1F2937; margin-bottom: 4px;">${displayTitle}</div>
                                        <div style="font-size: 0.8rem; color: #9CA3AF; display: flex; align-items: center; gap: 4px;">
                                            <span style="font-size: 0.9rem; filter: grayscale(0.1);" title="${item.paymentMethod || 'ç¾é‡‘'}">${payIcon}</span>
                                            ${timeStr}
                                        </div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 700; font-size: 1.2rem; color: #F97316;">
                                        Â¥${jpy.toLocaleString()}
                                    </div>
                                    <div style="font-size: 0.85rem; color: #6B7280;">â‰ˆ NT$${twd.toLocaleString()}</div>
                                </div>
                            </div>
                            ${actionButtons}
                        </div>`;
                    } else {
                        // ç­†è¨˜æ¨¡å¼
                        const noteContent = item.content || item.item || 'ç„¡å…§å®¹';
                        const currentUserName = localStorage.getItem('last_user_name');

                        // [æ–°å¢] åœ–ç‰‡è™•ç†é‚è¼¯
                        let imagesHtml = '';
                        let imagesData = [];
                        if (item.image && typeof item.image === 'string') {
                            imagesData = item.image.split('\n').filter(u => u.trim() !== '');
                        }


                        if (imagesData.length > 0) {
                            // [ä¿®æ­£] å°‡åœ–ç‰‡è³‡æ–™å­˜å…¥å…¨åŸŸ Cacheï¼Œé¿å… onclick å‚³ééå¤§å­—ä¸²å°è‡´å¤±æ•ˆ
                            if (!window.ledgerImagesCache) window.ledgerImagesCache = {};
                            window.ledgerImagesCache[item.id] = imagesData;

                            const previewHtml = imagesData.map((src, idx) => {
                                return `
                                 <div class="note-img-thumb" style="width: 80px; height: 80px; border-radius: 8px; overflow: hidden; flex-shrink: 0; cursor: pointer; border:1px solid #eee;"
                                      onclick="openGalleryFromList('${item.id}', ${idx})">
                                     <img src="${src}" style="width: 100%; height: 100%; object-fit: cover;">
                                 </div>
                                 `;
                            }).join('');

                            imagesHtml = `
                             <div class="horizontal-scroll-container" 
                                  style="display: flex; gap: 8px; margin-top: 8px; overflow-x: auto; padding-bottom: 4px;"
                                  ontouchstart="event.stopPropagation()" 
                                  ontouchmove="event.stopPropagation()">
                                ${previewHtml}
                             </div>`;
                        }

                        let actionButtons = '';

                        if (currentUserName && displayUser.name === currentUserName) {
                            actionButtons = `
                            <div style="display: flex; gap: 10px; margin-top: 8px; justify-content: flex-end; border-top: 1px dashed #eee; padding-top: 8px;">
                                <button onclick="editLedgerItem('${item.id}')" style="background:none; border:none; cursor:pointer; padding:4px;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <button onclick="deleteLedgerItem('${item.id}', this)" style="background:none; border:none; cursor:pointer; padding:4px;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#EF4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>`;
                        }

                        html += `
                        <div class="card" style="margin-bottom: 12px; padding: 15px; border-left: 4px solid #2563EB; background: white; border-radius: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 8px;">
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <span style="font-size: 1.4rem;">${displayUser.avatar || 'ğŸ‘¤'}</span>
                                    <span style="font-size: 0.85rem; font-weight: 600; color:#374151;">${displayUser.name}</span>
                                </div>
                                <div style="font-size: 0.75rem; color: #9ca3af;">${timeStr}</div>
                            </div>
                            <div style="font-size: 1rem; color: #374151; line-height: 1.6; white-space: pre-wrap;">${noteContent}</div>
                            ${imagesHtml}
                            ${actionButtons}
                        </div>`;
                    }
                });

                html += `</div></div>`; // Close group div
            });

            listContainer.innerHTML = html;
            updateTotalDisplay(totalJPY, totalTWD);
        }

        // [æ–°å¢] åˆ‡æ›æŠ˜ç–Šé¡¯ç¤º
        function toggleLedgerGroup(groupId, headerEl) {
            const content = document.getElementById(groupId);
            const arrow = headerEl.querySelector('.group-arrow');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                if (arrow) arrow.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                if (arrow) arrow.style.transform = 'rotate(0deg)';
            }
        }

        // è¼”åŠ©å‡½å¼ï¼šæ›´æ–°ä¸Šæ–¹ç¸½é‡‘é¡
        function updateTotalDisplay(jpy, twd) {
            const totalDisplay = document.getElementById('ledger-total-amount');
            if (totalDisplay && currentLedgerFilter === 'finance') {
                totalDisplay.innerHTML = `
            <div>Â¥ ${jpy.toLocaleString()}</div>
            <div style="font-size: 0.85rem; opacity: 0.8; font-weight: 400;">â‰ˆ NT$ ${twd.toLocaleString()}</div>
        `;
            } else if (totalDisplay) {
                // ç­†è¨˜æ¨¡å¼é¡¯ç¤ºå‰‡æ•¸
                const count = document.querySelectorAll('#ledger-list .card').length;
                totalDisplay.innerHTML = `<div>${count} å‰‡ç­†è¨˜</div>`;
            }
        }



        // --- [æ–°å¢] ä½¿ç”¨è€…èº«åˆ†ç®¡ç†é‚è¼¯ (Welcome Flow) ---

        // 1. æª¢æŸ¥ä½¿ç”¨è€… Session
        function checkUserSession() {
            const userName = localStorage.getItem('last_user_name');
            const userAvatar = localStorage.getItem('last_user_emoji');

            // åš´æ ¼æª¢æŸ¥ï¼šå¿…é ˆå…©å€‹éƒ½æœ‰å€¼ï¼Œä¸” name ä¸æ˜¯é«’è³‡æ–™
            let isValid = false;
            if (userName && userAvatar) {
                if (!userName.trim().startsWith('{') && userName !== 'undefined' && userName !== 'null') {
                    isValid = true;
                }
            }

            if (isValid) {
                // å·²ç™»å…¥ï¼šæ›´æ–° UI ä¸¦éš±è—è¿è³“é 
                updateUserDisplay();
                hideWelcomeModal();
                updateUserInfoFromUI(); // ç¢ºä¿ hidden fields åŒæ­¥
            } else {
                // æœªç™»å…¥ï¼šé¡¯ç¤ºè¿è³“é 
                showWelcomeModal();
            }
        }

        // 2. é¡¯ç¤ºè¿è³“ Modal
        function showWelcomeModal() {
            const modal = document.getElementById('welcome-modal');
            modal.style.display = 'flex';
            initWelcomeAvatarSelector();
        }

        // 3. éš±è—è¿è³“ Modal
        function hideWelcomeModal() {
            document.getElementById('welcome-modal').style.display = 'none';
        }

        // 4. åˆå§‹åŒ–è¿è³“é é ­åƒé¸æ“‡å™¨
        let selectedWelcomeAvatar = 'ğŸ¦'; // é è¨­

        function initWelcomeAvatarSelector() {
            const container = document.getElementById('welcome-avatar-grid');
            // [ä¿®æ­£] æ”¹ç”¨ children.length æª¢æŸ¥ï¼Œé¿å…è¢« HTML è¨»è§£èª¤å°
            if (container.children.length > 0) return;

            // ä½¿ç”¨èˆ‡åŸæœ¬ç›¸åŒçš„é ­åƒåˆ—è¡¨
            const emojis = [
                'ğŸ¦', 'ğŸ°', 'ğŸ¼', 'ğŸ¨', 'ğŸ¦Š', 'ğŸ±', 'ğŸ¶', 'ğŸ¯', 'ğŸµ', 'ğŸ·',
                'ğŸ¹', 'ğŸ»', 'ğŸ®', 'ğŸ¸', 'ğŸ”', 'ğŸ§', 'ğŸ¦„', 'ğŸ™', 'ğŸ¦–', 'ğŸ¬'
            ];

            container.innerHTML = '';
            emojis.forEach(emoji => {
                const div = document.createElement('div');
                div.className = 'avatar-option';
                div.innerText = emoji;
                if (emoji === selectedWelcomeAvatar) div.classList.add('selected');

                div.onclick = function () {
                    // ç§»é™¤å…¶ä»–é¸ä¸­ç‹€æ…‹
                    document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
                    // é¸ä¸­ç•¶å‰
                    this.classList.add('selected');
                    selectedWelcomeAvatar = emoji;
                };
                container.appendChild(div);
            });
        }

        // 5. è™•ç†ç™»å…¥ (æŒ‰éˆ•é»æ“Š)
        function handleLogin() {
            const nameInput = document.getElementById('welcome-nickname');
            const name = nameInput.value.trim();

            if (!name) {
                alert('è«‹è¼¸å…¥ä¸€å€‹å¸¥æ°£æˆ–å¯æ„›çš„æš±ç¨±ï¼');
                return;
            }

            // å„²å­˜åˆ° LocalStorage
            localStorage.setItem('last_user_name', name);
            localStorage.setItem('last_user_emoji', selectedWelcomeAvatar);

            // æ›´æ–° UI
            updateUserDisplay();
            updateUserInfoFromUI(); // åŒæ­¥ hidden fields

            // é—œé–‰ Modal
            hideWelcomeModal();

            // æ­¡è¿æç¤º (å¯é¸)
            // alert(`æ­¡è¿åŠ å…¥æ—…ç¨‹ï¼Œ${name}ï¼`);
        }

        // 6. é¡¯ç¤ºç™»å‡ºç¢ºèªçª—
        function showLogoutPopup() {
            const name = localStorage.getItem('last_user_name') || 'æˆå“¡';
            const avatar = localStorage.getItem('last_user_emoji') || 'ğŸ‘¤';

            document.getElementById('logout-name-preview').innerText = name;
            document.getElementById('logout-avatar-preview').innerText = avatar;
            document.getElementById('logout-popup').style.display = 'flex';
        }

        // 7. ç¢ºèªç™»å‡º
        function handleLogoutConfirm() {
            // æ¸…é™¤ LocalStorage
            localStorage.removeItem('last_user_name');
            localStorage.removeItem('last_user_emoji');

            // é—œé–‰ç¢ºèªçª—
            document.getElementById('logout-popup').style.display = 'none';

            // é‡æ–°é¡¯ç¤ºè¿è³“é 
            showWelcomeModal();
        }

        // 8. æ›´æ–° UIé¡¯ç¤º (å°‡ LocalStorage è³‡æ–™å¡«å…¥ user-status-display å’Œ hidden fields)
        function updateUserDisplay() {
            const name = localStorage.getItem('last_user_name') || 'è«‹ç™»å…¥';
            const avatar = localStorage.getItem('last_user_emoji') || 'ğŸ‘¤';

            // æ›´æ–°é¡¯ç¤ºå¡ç‰‡
            document.getElementById('display-current-name').innerText = name;
            document.getElementById('display-current-avatar').innerText = avatar;

            // æ›´æ–°éš±è—æ¬„ä½ (çµ¦ handleLedgerSubmit ç”¨)
            const nameInput = document.getElementById('custom-user-name');
            if (nameInput) nameInput.value = name;

            // ç¢ºä¿éš±è—çš„ JSON æ¬„ä½ä¹Ÿæ›´æ–° (ç›¸å®¹æ€§)
            updateUserInfoFromUI();
        }

        // [Override] ä¿®æ”¹æ—¢æœ‰çš„ updateUserInfoFromUI ä»¥æ”¯æ´æˆ‘å€‘çš„æ–°æµç¨‹
        // ç”±æ–¼æˆ‘å€‘ç§»é™¤äº†åŸæœ¬çš„ UIï¼Œé€™è£¡éœ€è¦æ”¹å¯«ä»¥å¾ hidden field è®€å–æˆ–ç›´æ¥å¾ LS è®€å–
        // æ³¨æ„ï¼šåŸæœ¬çš„å‡½æ•¸æ˜¯ç¶å®šåœ¨ input oninput ä¸Šçš„ï¼Œç¾åœ¨ input æ˜¯ hidden çš„
        function updateUserInfoFromUI() {
            const name = document.getElementById('custom-user-name').value || localStorage.getItem('last_user_name') || 'åŒ¿å';
            const avatar = localStorage.getItem('last_user_emoji') || 'ğŸ¦';

            // æ§‹å»º JSON å­—ä¸² (çµ¦å¾Œç«¯ç”¨)
            const userInfo = JSON.stringify({
                name: name,
                avatar: avatar
            });

            const hiddenInput = document.getElementById('selected-user-info');
            if (hiddenInput) hiddenInput.value = userInfo;

            // ç¢ºä¿å…¨åŸŸè®Šæ•¸åŒæ­¥ (å¦‚æœæœ‰ç”¨åˆ°çš„è©±)
            window.TEMP_USER_NAME = name;
        }

        // [Hook] åœ¨åˆ‡æ› Tab æ™‚æª¢æŸ¥ (å¦‚æœåˆ‡æ›åˆ°æ—…ç¨‹è¨˜éŒ„ view-ledger)
        // è¦†å¯«åŸæœ¬çš„ switchTab é‚è¼¯å¯èƒ½æœƒå¤ªè¤‡é›œï¼Œæˆ‘å€‘é¸æ“‡ç”¨äº‹ä»¶ç›£è½æˆ–åœ¨ switchTab å¾Œé¢æ›é‰¤
        // é€™è£¡æ¡ç”¨ç°¡å–®çš„å®šæ™‚æª¢æŸ¥æˆ–åœ¨ switchTab çš„ onclick ä¸­åŠ å…¥
        // ç”±æ–¼ switchTab æ˜¯å…¨åŸŸçš„ï¼Œæˆ‘å€‘å¯ä»¥åœ¨é€™è£¡åŠ«æŒå®ƒå—ï¼Ÿ 
        // æ¯”è¼ƒå®‰å…¨çš„æ–¹å¼æ˜¯ï¼šæ‰¾åˆ° nav-itemï¼Œç‚ºå…¶æ·»åŠ é¡å¤–çš„ onclick

        document.addEventListener('DOMContentLoaded', () => {
            const ledgerBtn = document.querySelector('.nav-item[data-target="view-ledger"]');
            if (ledgerBtn) {
                ledgerBtn.addEventListener('click', () => {
                    // é»æ“Šæ—…ç¨‹è¨˜éŒ„åˆ†é æ™‚ï¼Œæª¢æŸ¥ Session
                    checkUserSession();
                });
            }

            if (document.getElementById('view-ledger').classList.contains('active')) {
                checkUserSession();
            }

            // [æ–°å¢] æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•æ™‚ï¼Œè‡ªå‹•æŠ“å–ä¸€æ¬¡åŒ¯ç‡ (è§£æ±ºé›»è…¦ç‰ˆæ²’é–‹è¨ˆç®—æ©Ÿå°±æŠ“ä¸åˆ°åŒ¯ç‡çš„å•é¡Œ)
            if (typeof fetchLiveRate === 'function') {
                fetchLiveRate();
            }
            // [æ–°å¢] åˆå§‹åŒ–æ—¥æœŸç‚ºä»Šå¤©
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const dateStr = `${yyyy}-${mm}-${dd}`;

            const noteDate = document.getElementById('ledger-note-date');
            if (noteDate && !noteDate.value) noteDate.value = dateStr;

            const finDate = document.getElementById('ledger-date');
            if (finDate && !finDate.value) finDate.value = dateStr;
        });

        // [æ–°å¢] ç·¨è¼¯èˆ‡åˆªé™¤åŠŸèƒ½ (éœ€é…åˆ GAS å¾Œç«¯æ›´æ–°)
        // ==========================================
        window.editingId = null; // å…¨åŸŸè®Šæ•¸ï¼šç´€éŒ„ç›®å‰æ­£åœ¨ç·¨è¼¯çš„ ID
        window.deleteConfirmMap = {}; // [æ–°å¢] ç”¨ä¾†è¨˜éŒ„å“ªäº› ID è™•æ–¼åˆªé™¤ç¢ºèªç‹€æ…‹

        async function deleteLedgerItem(id, btnElement) {
            // [ç‹€æ…‹ 1] ç¬¬ä¸€æ¬¡é»æ“Šï¼šè®Šæ›´ç‚ºç¢ºèªç‹€æ…‹ (ç´…è‰²å¯¦å¿ƒåƒåœ¾æ¡¶)
            if (!window.deleteConfirmMap[id]) {
                window.deleteConfirmMap[id] = true;

                // è®Šæ›´åœ–ç¤ºç‚ºç´…è‰²å¯¦å¿ƒ
                const originalContent = btnElement.innerHTML;
                btnElement.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="#EF4444" stroke="#EF4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>`;

                // 3ç§’å¾Œè‹¥æ²’é»æ“Šï¼Œè‡ªå‹•é‚„åŸ
                setTimeout(() => {
                    if (window.deleteConfirmMap[id] === true) { // å¦‚æœé‚„åœ¨ç¢ºèªç‹€æ…‹(æ²’é€²å…¥åˆªé™¤ä¸­)
                        delete window.deleteConfirmMap[id];
                        btnElement.innerHTML = originalContent; // é‚„åŸ
                    }
                }, 3000);
                return;
            }

            // [ç‹€æ…‹ 2] ç¬¬äºŒæ¬¡é»æ“Šï¼šåŸ·è¡Œåˆªé™¤ (æ°´ä½ä¸‹é™å‹•ç•«)
            window.deleteConfirmMap[id] = 'deleting'; // æ¨™è¨˜ç‚ºåˆªé™¤ä¸­

            // æ›¿æ›ç‚ºæ°´ä½ä¸‹é™å‹•ç•« SVG
            // é€™è£¡ä½¿ç”¨å…©å€‹ pathï¼Œä¸€å€‹æ˜¯å¤–æ¡†ï¼Œä¸€å€‹æ˜¯å…§éƒ¨æ°´ä½ (ç”¨ CSS animation æ§åˆ¶ height æˆ– clip-path)
            btnElement.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="none">
                 <!-- å®šç¾©é®ç½© (åƒåœ¾æ¡¶å½¢ç‹€) -->
                 <defs>
                    <clipPath id="trash-clip-${id}">
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </clipPath>
                 </defs>
                 
                 <!-- èƒŒæ™¯ (å¤–æ¡†) -->
                 <path d="M3 6h18" stroke="#EF4444" stroke-width="2" stroke-linecap="round"></path>
                 <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="#EF4444" stroke-width="2"></path>
                 
                 <!-- æ°´ä½ (ç´…è‰²å€å¡Š) -->
                 <!-- ä½¿ç”¨ rect é…åˆ maskï¼Œä¸¦å° rect åš translateY å‹•ç•« -->
                 <rect x="0" y="0" width="24" height="24" fill="#EF4444" clip-path="url(#trash-clip-${id})" style="animation: drainWater 1.5s linear forwards; transform-origin: bottom;">
                 </rect>
                 
                 <style>
                    @keyframes drainWater {
                        0% { transform: translateY(0); }
                        100% { transform: translateY(24px); }
                    }
                 </style>
            </svg>`;

            try {
                const url = getKey('gas_url');
                const dataList = window.rawLedgerData || [];
                const item = dataList.find(d => d.id === id);
                const type = item ? item.type : 'finance';

                const payload = {
                    action: 'delete',
                    id: id,
                    type: type,
                    token: getKey('gas_token')
                };

                const res = await fetch(url, { method: 'POST', body: JSON.stringify(payload) });
                const result = await res.json();

                if (result.status === 'success') {
                    // [ç‹€æ…‹ 3] æˆåŠŸï¼šé¡¯ç¤º OK
                    btnElement.innerHTML = `<span style="color:#10B981; font-weight:900; font-size:0.9rem;">OK</span>`;

                    // çŸ­æš«åœç•™å¾Œç§»é™¤é …ç›®
                    setTimeout(() => {
                        if (window.rawLedgerData) {
                            window.rawLedgerData = window.rawLedgerData.filter(item => item.id !== id);
                            renderLedgerList(window.rawLedgerData);
                        } else {
                            syncLedgerData();
                        }
                    }, 500);
                } else {
                    throw new Error(result.message);
                }
            } catch (e) {
                console.error(e);
                // [ç‹€æ…‹ 4] å¤±æ•—ï¼šé¡¯ç¤º NG
                btnElement.innerHTML = `<span style="color:#EF4444; font-weight:900; font-size:0.9rem;">NG</span>`;
                setTimeout(() => {
                    delete window.deleteConfirmMap[id];
                    // é‚„åŸå›åˆå§‹ SVG (ç©ºå¿ƒåƒåœ¾æ¡¶)
                    btnElement.innerHTML = `
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#EF4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>`;
                }, 1500);
            }
        }


        function editLedgerItem(id) {
            // [ä¿®æ­£] ç¢ºä¿è®€å–å…¨åŸŸè®Šæ•¸
            const dataList = window.rawLedgerData || [];
            const item = dataList.find(d => d.id === id);
            if (!item) {
                alert('æ‰¾ä¸åˆ°è©²ç­†è³‡æ–™ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚');
                return;
            }

            // è¨­å®šå…¨åŸŸç·¨è¼¯ ID
            window.editingId = id;

            // åˆ‡æ›åˆ°å°æ‡‰çš„ Tab (Finance or Note)
            if (item.type === 'finance') {
                filterLedgerView('finance');
                // å¡«å…¥è³‡æ–™
                document.getElementById('ledger-item').value = item.item || item.content || '';
                document.getElementById('ledger-amount').value = item.amount || '';

                // [æ–°å¢] å¡«å…¥æ—¥æœŸ (Finance)
                const fDateInput = document.getElementById('ledger-date');
                if (fDateInput) {
                    // [é—œéµä¿®æ­£] å…ˆå¼·åˆ¶è½‰å› date é¡å‹
                    fDateInput.type = 'date';
                    let dStr = item.date || item.timestamp; // Fallback to timestamp

                    if (dStr) {
                        // å˜—è©¦æ¨™æº–åŒ–ç‚º YYYY-MM-DD
                        try {
                            // å¦‚æœæ˜¯ ISO æ ¼å¼ æˆ– æ™‚é–“æˆ³
                            const dObj = new Date(dStr);
                            if (!isNaN(dObj.getTime())) {
                                const y = dObj.getFullYear();
                                const m = String(dObj.getMonth() + 1).padStart(2, '0');
                                const d = String(dObj.getDate()).padStart(2, '0');
                                dStr = `${y}-${m}-${d}`;
                            }
                        } catch (e) { }
                    }

                    fDateInput.value = dStr || '';
                    // è§¸ç™¼æ ¼å¼åŒ–
                    if (typeof formatCompactDate === 'function') formatCompactDate(fDateInput);
                }

                // [æ–°å¢] å¡«å…¥ä»˜æ¬¾æ–¹å¼
                const payMethod = document.getElementById('ledger-payment-method');
                if (payMethod) {
                    // è‹¥èˆŠè³‡æ–™æ²’æœ‰ paymentMethod å‰‡é è¨­ cash
                    payMethod.value = item.paymentMethod || 'cash';

                    // [ä¿®æ­£] å¦‚æœæ˜¯ Public/Privateï¼Œæ‡‰è©²è¨­å®š payType
                    // ä½†ç›®å‰ payType æ˜¯æ ¹æ“š item.paymentType
                    const payTypeSelect = document.getElementById('ledger-pay-type');
                    if (payTypeSelect) {
                        const pType = item.paymentType || 'Public';
                        // å¦‚æœæ˜¯ 'Public' æˆ– 'public' -> value='public'
                        // å¦‚æœæ˜¯ userName æˆ– å…¶ä»– -> value='private'
                        if (pType.toLowerCase() === 'public') {
                            payTypeSelect.value = 'public';
                        } else {
                            payTypeSelect.value = 'private';
                        }
                    }
                }
                // ç‚ºäº†è®“ä½¿ç”¨è€…çŸ¥é“æ­£åœ¨ç·¨è¼¯ï¼Œæ”¹è®ŠæŒ‰éˆ•æ–‡å­—
                const btn = document.querySelector('#ledger-finance-fields .btn-submit-ledger');
                if (btn) {
                    // æ”¹ç‚ºé¡¯ç¤ºã€Œç·¨è¼¯(æ‰“å‹¾)ã€åœ–ç¤º (æ©˜è‰²)
                    btn.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#F59E0B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                }
            } else {
                filterLedgerView('note');
                // å¡«å…¥è³‡æ–™
                document.getElementById('ledger-note-content').value = item.content || item.item || '';

                // [æ–°å¢] å¡«å…¥æ—¥æœŸ
                const dateInput = document.getElementById('ledger-note-date');
                if (dateInput) {
                    // [é—œéµä¿®æ­£] å…ˆå¼·åˆ¶è½‰å› date é¡å‹
                    dateInput.type = 'date';
                    let dStr = item.date || item.timestamp;
                    if (dStr) {
                        try {
                            const dObj = new Date(dStr);
                            if (!isNaN(dObj.getTime())) {
                                const y = dObj.getFullYear();
                                const m = String(dObj.getMonth() + 1).padStart(2, '0');
                                const d = String(dObj.getDate()).padStart(2, '0');
                                dStr = `${y}-${m}-${d}`;
                            }
                        } catch (e) { }
                    }
                    dateInput.value = dStr || '';
                    // è§¸ç™¼æ ¼å¼åŒ–
                    if (typeof formatCompactDate === 'function') formatCompactDate(dateInput);
                }
                // ç‚ºäº†è®“ä½¿ç”¨è€…çŸ¥é“æ­£åœ¨ç·¨è¼¯ï¼Œæ”¹è®ŠæŒ‰éˆ•æ–‡å­—
                const btn = document.querySelector('#ledger-note-fields .btn-submit-ledger');
                if (btn) {
                    // æ”¹ç‚ºé¡¯ç¤ºã€Œç·¨è¼¯(æ‰“å‹¾)ã€åœ–ç¤º (è—è‰²)
                    btn.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2563EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                }
            }

            // [æ–°å¢] é¡¯ç¤º Cancel æŒ‰éˆ•
            if (item.type === 'finance') {
                const cBtn = document.getElementById('btn-cancel-edit-finance');
                if (cBtn) cBtn.style.display = 'flex';
            } else {
                const cBtn = document.getElementById('btn-cancel-edit-note');
                if (cBtn) cBtn.style.display = 'flex';
            }

            // [æ–°å¢] è¼‰å…¥ç¾æœ‰åœ–ç‰‡ (Note æ¨¡å¼)
            if (item.type !== 'finance') {
                window.currentNoteImages = [];
                // item.image å¯èƒ½æ˜¯ä¸€ä¸² URL (æ›è¡Œåˆ†éš”)
                if (item.image && typeof item.image === 'string') {
                    const urls = item.image.split('\n').filter(u => u.trim() !== '');
                    window.currentNoteImages = urls;
                }
                renderImagePreviews();
            }

            // æ»¾å‹•åˆ°è¼¸å…¥å€
            document.getElementById('ledger-input-card').scrollIntoView({ behavior: 'smooth' });

            // æç¤º
            // alert('è«‹ä¿®æ”¹ä¸Šæ–¹å…§å®¹å¾Œï¼Œé»æ“ŠæŒ‰éˆ•é€å‡ºã€‚');

            // [æ–°å¢] å¡«å…¥è³‡æ–™å¾Œç«‹å³æª¢æŸ¥ç‹€æ…‹
            updateLedgerSubmitState();
        }

        // [æ–°å¢] æª¢æŸ¥è¨˜å¸³/è¨˜äº‹è¼¸å…¥ç‹€æ…‹ï¼Œæ§åˆ¶é€å‡ºæŒ‰éˆ•å¯ç”¨æ€§
        function updateLedgerSubmitState() {
            // 1. Finance Check
            const itemVal = document.getElementById('ledger-item').value.trim();
            const amountVal = document.getElementById('ledger-amount').value.trim();
            // æ³¨æ„ï¼šé€™è£¡æ”¹æˆæ›´ç²¾ç¢ºçš„é¸æ“‡å™¨ï¼Œé¿å…é¸éŒ¯
            const financeBtn = document.querySelector('#ledger-finance-fields .btn-submit-ledger');

            if (financeBtn) {
                if (itemVal && amountVal) {
                    financeBtn.disabled = false;
                    financeBtn.style.opacity = '1';
                    financeBtn.style.cursor = 'pointer';
                    financeBtn.style.filter = 'none';
                } else {
                    financeBtn.disabled = true;
                    financeBtn.style.opacity = '0.3';
                    financeBtn.style.cursor = 'not-allowed';
                    financeBtn.style.filter = 'grayscale(100%)';
                }
            }

            // 2. Note Check
            const noteVal = document.getElementById('ledger-note-content').value.trim();
            const noteBtn = document.querySelector('#ledger-note-fields .btn-submit-ledger');

            if (noteBtn) {
                // [ä¿®æ­£] åªè¦æœ‰æ–‡å­— OR æœ‰åœ–ç‰‡å°±å¯ä»¥é€å‡º
                const hasImages = window.currentNoteImages && window.currentNoteImages.length > 0;

                if (noteVal || hasImages) {
                    noteBtn.disabled = false;
                    noteBtn.style.opacity = '1';
                    noteBtn.style.cursor = 'pointer';
                    noteBtn.style.filter = 'none';
                } else {
                    noteBtn.disabled = true;
                    noteBtn.style.opacity = '0.3';
                    noteBtn.style.cursor = 'not-allowed';
                    noteBtn.style.filter = 'grayscale(100%)';
                }
            }
        }

        // [æ–°å¢] ç¶å®šè¼¸å…¥ç›£è½
        document.addEventListener('DOMContentLoaded', () => {
            const inputs = ['ledger-item', 'ledger-amount', 'ledger-note-content'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', updateLedgerSubmitState);
                }
            });
            // åˆå§‹åŒ–æª¢æŸ¥ (ç¨å¾®å»¶é²ç¢ºä¿ DOM å®Œå…¨å°±ç·’)
            setTimeout(updateLedgerSubmitState, 100);
        });

        // [æ–°å¢] æ”¾æ£„è®Šæ›´æ¨¡å¼ (æ›´åç‚º exitEditMode ä»¥é¿å…è¡çª)
        function exitEditMode() {
            window.editingId = null;

            // æ¸…ç©ºè¼¸å…¥
            document.getElementById('ledger-item').value = '';
            document.getElementById('ledger-amount').value = '';
            document.getElementById('ledger-note-content').value = '';

            // [æ–°å¢] é‡ç½®æ—¥æœŸç‚ºä»Šå¤©
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const todayStr = `${yyyy}-${mm}-${dd}`;

            const finDate = document.getElementById('ledger-date');
            if (finDate) {
                finDate.type = 'date';
                finDate.value = todayStr;
                finDate.dataset.isoValue = todayStr; // [é—œéµ] å¼·åˆ¶è¦†å¯«ç·©å­˜ç‚ºä»Šå¤©
                if (typeof formatCompactDate === 'function') formatCompactDate(finDate);
            }

            const noteDate = document.getElementById('ledger-note-date');
            if (noteDate) {
                noteDate.type = 'date';
                noteDate.value = todayStr;
                noteDate.dataset.isoValue = todayStr; // [é—œéµ] å¼·åˆ¶è¦†å¯«ç·©å­˜ç‚ºä»Šå¤©
                if (typeof formatCompactDate === 'function') formatCompactDate(noteDate);
            }

            // [æ–°å¢] é‡ç½®ä»˜æ¬¾æ–¹å¼
            const payMethod = document.getElementById('ledger-payment-method');
            if (payMethod) payMethod.value = 'cash';

            // [æ–°å¢] æ¸…ç©ºåœ–ç‰‡
            window.currentNoteImages = [];
            renderImagePreviews();

            // éš±è— Cancel æŒ‰éˆ•
            const cBtnFin = document.getElementById('btn-cancel-edit-finance');
            if (cBtnFin) cBtnFin.style.display = 'none';
            const cBtnNote = document.getElementById('btn-cancel-edit-note');
            if (cBtnNote) cBtnNote.style.display = 'none';

            // é‚„åŸæŒ‰éˆ•ç‚ºç´™é£›æ©Ÿ
            const btns = document.querySelectorAll('.btn-submit-ledger');
            btns.forEach(btn => {
                // [ä¿®æ­£] ä½¿ç”¨ .closest() ä¾†åˆ¤æ–·æ˜¯å¦ç‚º Note å€å¡Š
                const isNote = !!btn.closest('#ledger-note-fields');
                const color = isNote ? '#2563EB' : 'currentColor';

                btn.innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${color}"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>`;
            });

            // [æ–°å¢] æ¸…ç©ºå¾Œæª¢æŸ¥ç‹€æ…‹
            updateLedgerSubmitState();
        }

        // ============================================================
        // [æ–°å¢] å¤šåœ–ä¸Šå‚³èˆ‡é è¦½é‚è¼¯
        // ============================================================
        window.currentNoteImages = []; // å­˜æ”¾ Base64 å­—ä¸²æˆ– URL

        async function handleMultiImageSelect(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            showGlobalLoading(); // é¡¯ç¤ºè®€å–ä¸­ (å› ç‚ºå£“ç¸®å¯èƒ½èŠ±æ™‚é–“)

            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    // ç°¡å–®å£“ç¸®: Max 1024px
                    // [ä¿®æ­£] æ”¹åé¿å…èˆ‡ AI åŠ©æ‰‹è¡çª
                    const base64 = await compressImageForNote(file, 1024, 0.8);
                    window.currentNoteImages.push(base64);
                }
                renderImagePreviews();
                // æ¸…ç©º input è®“åŒä¸€æª”æ¡ˆå¯é‡è¤‡é¸
                event.target.value = '';
            } catch (e) {
                console.error("Image process error", e);
                alert("åœ–ç‰‡è™•ç†å¤±æ•—");
            } finally {
                hideGlobalLoading();
            }
        }

        // [ä¿®æ­£] æ”¹åç‚º compressImageForNote ä»¥å…è¦†è“‹ AI åŠ©æ‰‹åŸæœ¬çš„ compressImage
        function compressImageForNote(file, maxWidth, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function (e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function () {
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = Math.round(height * (maxWidth / width));
                            width = maxWidth;
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        function renderImagePreviews() {
            const container = document.getElementById('note-image-preview');
            // [ä¿®æ­£] å³ä½¿æ¸…ç©ºä¹Ÿè¦å‘¼å« updateLedgerSubmitStateï¼Œç¢ºä¿æŒ‰éˆ•ç‹€æ…‹æ­£ç¢º
            if (!window.currentNoteImages || window.currentNoteImages.length === 0) {
                container.style.display = 'none';
                container.innerHTML = '';
                updateLedgerSubmitState(); // [æ–°å¢] æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                return;
            }

            // [ä¿®æ­£] æ”¹ç”¨ horizontal-scroll-container æ¨£å¼ï¼Œä¸¦åŠ å…¥é˜²èª¤è§¸
            container.style.display = 'flex';
            // æ³¨æ„ï¼šè¦ç¢ºä¿ style ä¸­æœ‰ overflow-x: auto; é€™è£¡é€é class æ§åˆ¶ï¼Œä½†è‹¥åŸæœ¬æ²’æœ‰ CSS class å®šç¾©ï¼Œéœ€æ‰‹å‹•åŠ  inline style
            // é€™è£¡ç‚ºäº†ä¿éšªï¼ŒåŠ ä¸Š inline style
            container.style.overflowX = 'auto';
            container.style.paddingBottom = '4px'; // è®“æ²è»¸ä¸é®æ“‹

            // [é—œéµ] åŠ å…¥é˜²èª¤è§¸äº‹ä»¶
            container.ontouchstart = (e) => e.stopPropagation();
            container.ontouchmove = (e) => e.stopPropagation();

            container.innerHTML = window.currentNoteImages.map((src, index) => `
                <div class="preview-thumb-box" onclick="openGallery(${index})" style="position: relative; flex-shrink: 0; width: 60px; height: 60px; margin-right: 8px;">
                    <img src="${src}" class="preview-thumb-img" style="width:100%; height:100%; object-fit:cover; border-radius:4px;">
                    <div class="btn-remove-img" onclick="removeImage(event, ${index})" 
                        style="position:absolute; top:2px; right:2px; background:rgba(239, 68, 68, 0.9); color:white; border-radius:50%; width:16px; height:16px; display:flex; align-items:center; justify-content:center; font-size:10px; cursor:pointer; font-weight:bold;">âœ•</div>
                </div>
            `).join('');

            updateLedgerSubmitState(); // [æ–°å¢] æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        }

        function removeImage(e, index) {
            e.stopPropagation(); // é˜»æ­¢å†’æ³¡è§¸ç™¼ openGallery
            if (confirm('ç¢ºå®šç§»é™¤é€™å¼µç…§ç‰‡å—ï¼Ÿ')) {
                window.currentNoteImages.splice(index, 1);
                renderImagePreviews();
            }
        }

        // ============================================================
        // [æ–°å¢] å…¨è¢å¹•åœ–åº«é‚è¼¯ (å«ç¸®æ”¾èˆ‡æ»‘å‹•)
        // ============================================================
        let galleryCurrentIndex = 0;
        let galleryImages = []; // ç•¶å‰åœ–åº«é¡¯ç¤ºçš„åœ–ç‰‡ä¾†æºé™£åˆ—

        // [æ–°å¢] å¾åˆ—è¡¨é–‹å•Ÿåœ–åº«çš„è¼”åŠ©å‡½å¼
        function openGalleryFromList(itemId, index) {
            if (window.ledgerImagesCache && window.ledgerImagesCache[itemId]) {
                const images = window.ledgerImagesCache[itemId];
                openGallery(index, images);
            }
        }

        // é–‹å•Ÿåœ–åº« (ä¾†æºå¯èƒ½æ˜¯ window.currentNoteImages æˆ–æ˜¯ Ledger List ä¸­çš„åœ–ç‰‡)
        function openGallery(index, imagesSource = null) {

            // è§£æ imagesSource (å¦‚æœæ˜¯å­—ä¸²æˆ–é™£åˆ—)
            let imgs = [];

            if (imagesSource) {
                if (Array.isArray(imagesSource)) {
                    imgs = imagesSource;
                } else if (typeof imagesSource === 'string') {
                    try {
                        imgs = JSON.parse(unescape(imagesSource));
                    } catch (e) {
                        imgs = [];
                    }
                }
            } else {
                // é è¨­æ˜¯å¤§é ­è²¼è¼¸å…¥é è¦½
                imgs = window.currentNoteImages || [];
            }

            galleryImages = imgs;
            if (galleryImages.length === 0) return;

            galleryCurrentIndex = index;
            const modal = document.getElementById('gallery-modal');
            const container = document.getElementById('gallery-container');
            const dotsContainer = document.getElementById('gallery-dots');

            // æ¸²æŸ“åœ–ç‰‡
            container.innerHTML = galleryImages.map((src, i) => `
                <div class="gallery-slide" style="transform: translateX(${(i - index) * 100}%)"
                     data-index="${i}">
                    <img src="${src}" class="gallery-img">
                </div>
            `).join('');

            // æ¸²æŸ“åœ“é»
            updateGalleryDots();

            modal.style.display = 'flex';

            // ç¶å®šæ‰‹å‹¢äº‹ä»¶
            bindGalleryEvents();
        }

        function closeGallery() {
            document.getElementById('gallery-modal').style.display = 'none';
        }

        function updateGalleryDots() {
            const dotsContainer = document.getElementById('gallery-dots');
            dotsContainer.innerHTML = galleryImages.map((_, i) => `
                <div class="gallery-dot ${i === galleryCurrentIndex ? 'active' : ''}"></div>
            `).join('');
        }

        function switchGallerySlide(newIndex) {
            if (newIndex < 0) newIndex = 0;
            if (newIndex >= galleryImages.length) newIndex = galleryImages.length - 1;

            galleryCurrentIndex = newIndex;

            const slides = document.querySelectorAll('.gallery-slide');
            slides.forEach(slide => {
                const idx = parseInt(slide.getAttribute('data-index'));
                slide.style.transform = `translateX(${(idx - galleryCurrentIndex) * 100}%)`;
            });

            updateGalleryDots();

            // é‡ç½®ç¸®æ”¾
            resetZoom();
        }


        // --- æ‰‹å‹¢èˆ‡ç¸®æ”¾é‚è¼¯ (Pinch Zoom & Swipe) ---
        let touchStartX = 0;
        let touchStartY = 0;
        let isZooming = false;
        let currentScale = 1;
        let lastScale = 1;
        let initialDistance = 0;

        // è®Šæ•¸å„²å­˜ç•¶å‰åœ–ç‰‡å…ƒç´  (ç”¨æ–¼ç¸®æ”¾)
        function getCurrentImg() {
            const slide = document.querySelector(`.gallery-slide[data-index="${galleryCurrentIndex}"]`);
            return slide ? slide.querySelector('img') : null;
        }

        function bindGalleryEvents() {
            const container = document.getElementById('gallery-container');
            const modal = document.getElementById('gallery-modal');

            // [æ–°å¢] é˜»æ“‹ Modal èƒŒæ™¯çš„è§¸æ§äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢åº•å±¤æ»‘å‹•
            const blockTouch = (e) => {
                e.stopPropagation();
                // å¦‚æœæ˜¯åœ¨èƒŒæ™¯æ»‘å‹•ï¼Œä¹Ÿé˜»æ­¢é»˜èªæ²å‹•
                if (e.type === 'touchmove') e.preventDefault();
            };
            modal.ontouchstart = blockTouch;
            modal.ontouchmove = blockTouch;
            modal.ontouchend = blockTouch;

            container.ontouchstart = (e) => {
                e.stopPropagation(); // [æ–°å¢] é˜»æ­¢å†’æ³¡
                if (e.touches.length === 1) {
                    // å–®æŒ‡ï¼šå¯èƒ½æ˜¯æ»‘å‹•
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                } else if (e.touches.length === 2) {
                    // é›™æŒ‡ï¼šç¸®æ”¾èµ·å§‹
                    isZooming = true;
                    initialDistance = getDistance(e.touches);
                }
            };

            container.ontouchmove = (e) => {
                e.stopPropagation(); // [æ–°å¢] é˜»æ­¢å†’æ³¡
                e.preventDefault(); // é˜»æ­¢ç€è¦½å™¨é è¨­è¡Œç‚º

                if (isZooming && e.touches.length === 2) {
                    // ç¸®æ”¾ä¸­
                    const dist = getDistance(e.touches);
                    const delta = dist / initialDistance;
                    const newScale = lastScale * delta;

                    // é™åˆ¶ç¸®æ”¾ç¯„åœ (1x ~ 4x)
                    if (newScale >= 1 && newScale <= 4) {
                        currentScale = newScale;
                        const img = getCurrentImg();
                        if (img) img.style.transform = `scale(${currentScale})`;
                    }
                }
            };

            container.ontouchend = (e) => {
                e.stopPropagation(); // [æ–°å¢] é˜»æ­¢å†’æ³¡
                if (isZooming) {
                    // ç¸®æ”¾çµæŸï¼Œç´€éŒ„ç•¶å‰å€ç‡
                    isZooming = false;
                    lastScale = currentScale;
                    if (lastScale < 1.1) {
                        lastScale = 1;
                        resetZoom(); // ç¨å¾®ç¸®å°å°±å›å½ˆè‡³åŸå§‹å¤§å°ï¼Œæ–¹ä¾¿é€²è¡Œæ›é 
                    }
                } else {
                    // å–®æŒ‡æ»‘å‹•çµæŸåˆ¤æ–·
                    if (e.changedTouches.length === 1 && currentScale === 1) {
                        const touchEndX = e.changedTouches[0].clientX;
                        const diffX = touchStartX - touchEndX;

                        if (Math.abs(diffX) > 50) { // æ»‘å‹•è¶…é 50px
                            if (diffX > 0) {
                                switchGallerySlide(galleryCurrentIndex + 1); // Next
                            } else {
                                switchGallerySlide(galleryCurrentIndex - 1); // Prev
                            }
                        }
                    }
                }
            };
        }

        function getDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        function resetZoom() {
            currentScale = 1;
            lastScale = 1;
            const img = getCurrentImg();
            if (img) img.style.transform = `scale(1)`;
        }

    </script>
    <!-- [æ–°å¢] æ­¡è¿èˆ‡èº«åˆ†é¸æ“‡ Modal -->
    <div id="welcome-modal">
        <div class="welcome-box">
            <div class="welcome-title">æ­¡è¿ä½¿ç”¨æ—…ç¨‹è¨˜éŒ„ ğŸ‘‹</div>
            <div class="welcome-desc">è«‹é¸æ“‡æ‚¨çš„ç¨±å‘¼èˆ‡é ­åƒ<br>è®“æ—…ç¨‹è¨˜éŒ„æ›´ç”Ÿå‹•ï¼</div>

            <div class="avatar-grid" id="welcome-avatar-grid"></div>

            <input type="text" id="welcome-nickname" class="input-nickname" placeholder="è«‹è¼¸å…¥æš±ç¨± (ä¾‹å¦‚: çˆ¸çˆ¸)" maxlength="10"
                onclick="this.focus()">

            <button class="btn-start-trip" onclick="handleLogin()">é–‹å§‹è¨˜éŒ„æ—…ç¨‹ </button>
        </div>
    </div>

    <!-- [æ–°å¢] ç™»å‡º/åˆ‡æ›èº«åˆ†ç¢ºèª Modal -->
    <div id="logout-popup" class="modal-overlay">
        <div class="modal-box" style="width: 300px;">
            <div class="modal-title">åˆ‡æ›èº«åˆ†</div>
            <div class="logout-box">
                <span id="logout-avatar-preview" class="logout-avatar">ğŸ‘¤</span>
                <p class="modal-desc">ç¢ºå®šè¦ç™»å‡ºç›®å‰çš„ã€Œ<span id="logout-name-preview"
                        style="font-weight:bold; color:#1F2937;"></span>ã€èº«åˆ†ï¼Œä¸¦é‡æ–°é¸æ“‡å—ï¼Ÿ</p>
            </div>
            <div class="modal-btns">
                <button class="modal-btn btn-cancel"
                    onclick="document.getElementById('logout-popup').style.display='none'">å–æ¶ˆ</button>
                <button class="modal-btn btn-confirm" onclick="handleLogoutConfirm()"
                    style="background: #EF4444; color: white;">ç¢ºå®šç™»å‡º</button>
            </div>
        </div>
    </div>

    <!-- [æ–°å¢] å…¨è¢å¹•åœ–åº« Modal -->
    <div id="gallery-modal">
        <div class="gallery-close" onclick="closeGallery()">Ã—</div>
        <div id="gallery-container">
            <!-- Images injected via JS -->
        </div>
        <div class="gallery-dots" id="gallery-dots">
            <!-- Dots injected via JS -->
        </div>
    </div>
    </div>
    <!-- [æ–°å¢] å¸³å–®è¾¨è­˜çµæœç¢ºèª Modal -->
    <!-- [ä¿®æ­£] å¢åŠ  ontouchmove="event.stopPropagation()" é˜²æ­¢æ²å‹•ç©¿é€åˆ° Body -->
    <div id="bill-scan-modal" class="modal-overlay">
        <div class="modal-box" onclick="event.stopPropagation()" ontouchmove="event.stopPropagation()"
            style="max-width: 90%; width: 400px; max-height: 85vh; display: flex; flex-direction: column;">
            <div class="modal-title">æƒæçµæœç¢ºèª</div>
            <div class="modal-desc">è«‹å‹¾é¸ä¸¦ç¢ºèªè¦åŠ å…¥çš„é …ç›®ã€‚</div>

            <div
                style="background: #F9FAFB; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px dashed #E5E7EB;">
                <div style="display: flex; gap: 6px; margin-bottom: 8px; align-items: center;">
                    <label style="font-size: 0.85rem; color: #666; width: 40px;">æ—¥æœŸ</label>
                    <input type="date" id="bill-scan-date"
                        style="flex: 1; border: 1px solid #ddd; border-radius: 4px; padding: 6px; -webkit-appearance: none; appearance: none; background: white; color: #000;">
                </div>
                <div style="display: flex; gap: 6px; align-items: center;">
                    <label style="font-size: 0.85rem; color: #666; width: 40px;">ä»˜æ¬¾</label>
                    <select id="bill-scan-payment-method"
                        style="flex: 1; border: 1px solid #ddd; border-radius: 4px; padding: 6px; background: white;">
                        <option value="cash">ğŸ’µ ç¾é‡‘</option>
                        <option value="card" selected>ğŸ’³ åˆ·å¡</option>
                        <option value="ic">ğŸ§ ICå¡</option>
                        <option value="pay">ğŸ“± Pay</option>
                    </select>
                    <label style="font-size: 0.85rem; color: #666; margin: 0 4px;">æ”¯ä»˜</label>
                    <select id="bill-scan-pay-type"
                        style="flex: 1; border: 1px solid #ddd; border-radius: 4px; padding: 6px; background: white;">
                        <option value="public" selected>å…¬è²»</option>
                        <option value="private">å€‹äºº</option>
                    </select>
                </div>
            </div>

            <div id="bill-scan-list"
                style="flex: 1; overflow-y: auto; margin: 10px 0; border: 1px solid #eee; border-radius: 8px; padding: 8px;">
                <!-- JS å‹•æ…‹ç”Ÿæˆé …ç›® -->
            </div>

            <!-- æ‰‹å‹•æ–°å¢æŒ‰éˆ• -->
            <button onclick="addManualBillItem()"
                style="align-self: flex-start; margin-bottom: 10px; background: transparent; border: 1px dashed #aaa; padding: 5px 10px; border-radius: 6px; font-size: 0.9rem; color: #555; cursor: pointer;">
                + æ–°å¢é …ç›®
            </button>

            <div class="modal-btns">
                <button class="modal-btn btn-cancel"
                    onclick="document.getElementById('bill-scan-modal').style.display='none'; document.body.style.overflow='';">å–æ¶ˆ</button>
                <button class="modal-btn btn-confirm" onclick="confirmBillScan()">ç¢ºå®šåŠ å…¥</button>
            </div>
        </div>
    </div>

    <!-- [æ–°å¢] å¸³å–®è¾¨è­˜ Modal æ¨£å¼ -->
    <style>
        .bill-item-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .bill-item-row:last-child {
            border-bottom: none;
        }

        .bill-check {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .bill-name-input {
            flex: 2;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 0;
        }

        .bill-amount-input {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 0;
            text-align: right;
        }

        .bill-remove-btn {
            color: #ef4444;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0 4px;
        }
    </style>

    <script>
        // [æ–°å¢] å¸³å–®æƒæèˆ‡è¾¨è­˜é‚è¼¯

        async function handleBillFileChange(event) {
            const file = event.target.files[0];
            if (!file) return;

            // æ¸…ç©º Input é¿å…é‡è¤‡è§¸ç™¼
            event.target.value = '';

            showGlobalLoading("æ­£åœ¨åˆ†ææ”¶æ“š...");

            try {
                // 1. å£“ç¸®åœ–ç‰‡
                const base64 = await compressImageForNote(file, 1024, 0.8);
                // å»é™¤ data:image/jpeg;base64, å‰ç¶´
                const cleanBase64 = base64.split(',')[1];

                // 2. å‘¼å« Gemini
                const prompt = `
                    ä½ æ˜¯ä¸€å€‹æ”¶æ“šè¾¨è­˜åŠ©æ‰‹ã€‚è«‹åˆ†æé€™å¼µæ”¶æ“šåœ–ç‰‡ï¼Œä¸¦æå–ã€Œäº¤æ˜“æ—¥æœŸã€èˆ‡æ‰€æœ‰ã€Œæ¶ˆè²»é …ç›®ã€ã€‚
                    
                    è¦å‰‡ï¼š
                    1. åªæå–å…·é«”æ¶ˆè²»å“é …ï¼Œä¸è¦ç¸½è¨ˆ(Total)ã€ç¨…é‡‘(Tax)æˆ–æ‰¾é›¶ã€‚
                    2. è‹¥å“é …åç¨±ç‚ºæ—¥æ–‡æˆ–è‹±æ–‡ï¼Œè«‹ç¿»è­¯æˆã€Œç¹é«”ä¸­æ–‡ã€ (è‹¥ä¸ç¢ºå®šå‰‡ä¿ç•™åŸæ–‡)ã€‚
                    3. é‡‘é¡è«‹åªä¿ç•™æ•¸å­—ã€‚
                    4. è¾¨è­˜æ”¶æ“šä¸Šçš„æ—¥æœŸï¼Œæ ¼å¼ç‚º YYYY-MM-DD (è‹¥æ‰¾ä¸åˆ°æˆ–ä¸ç¢ºå®šå‰‡å›å‚³ null)ã€‚
                    5. å›å‚³æ ¼å¼å¿…é ˆæ˜¯å–®ç´”çš„ JSON Objectï¼Œä¸è¦ Markdown æ¨™è¨˜ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
                       {
                         "date": "2024-01-01",
                         "items": [{"name": "å“é …A", "amount": 100}, {"name": "å“é …B", "amount": 550}]
                       }
                `;

                const resultText = await getGeminiResponse(prompt, cleanBase64);

                // 3. è§£æ JSON
                let items = [];
                let detectedDate = null;

                try {
                    // å˜—è©¦æ¸…ç† Markdown ä»£ç¢¼å¡Š
                    let cleanJson = resultText.replace(/```json/g, '').replace(/```/g, '').trim();
                    const parsed = JSON.parse(cleanJson);

                    if (Array.isArray(parsed)) {
                        items = parsed; // ç›¸å®¹èˆŠæ ¼å¼ (é›–ç„¶ Prompt æ”¹äº†ï¼Œä½†ä»¥é˜²è¬ä¸€)
                    } else if (parsed && typeof parsed === 'object') {
                        items = parsed.items || [];
                        detectedDate = parsed.date;
                    }
                } catch (e) {
                    console.error("JSON Parse Error:", e);
                    alert("è¾¨è­˜çµæœæ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡è©¦");
                    hideGlobalLoading();
                    return;
                }

                if (!Array.isArray(items)) {
                    alert("è¾¨è­˜çµæœæ ¼å¼ä¸ç¬¦ï¼Œè«‹é‡è©¦");
                    hideGlobalLoading();
                    return;
                }

                // 4. é¡¯ç¤ºçµæœ Modal
                renderBillScanResult(items);
                document.getElementById('bill-scan-modal').style.display = 'flex';

                // [æ–°å¢] åˆå§‹åŒ–æ—¥æœŸèˆ‡ä»˜æ¬¾æ–¹å¼
                const bsDate = document.getElementById('bill-scan-date');
                if (bsDate) {
                    if (detectedDate) {
                        bsDate.value = detectedDate;
                    } else {
                        // è‹¥æ²’æŠ“åˆ°ï¼Œé è¨­ç‚ºä»Šå¤©
                        const today = new Date();
                        const yyyy = today.getFullYear();
                        const mm = String(today.getMonth() + 1).padStart(2, '0');
                        const dd = String(today.getDate()).padStart(2, '0');
                        bsDate.value = `${yyyy}-${mm}-${dd}`;
                    }
                }

                const bsPay = document.getElementById('bill-scan-payment-method');
                if (bsPay) bsPay.value = 'card'; // æƒæé€šå¸¸æ˜¯åˆ·å¡å–®? æˆ–ä¿æŒé è¨­

                // [æ–°å¢] é–å®šèƒŒæ™¯æ²å‹•
                document.body.style.overflow = 'hidden';

            } catch (e) {
                console.error("Scan Error:", e);
                alert("è¾¨è­˜å¤±æ•—ï¼š" + e.message);
            } finally {
                hideGlobalLoading();
            }
        }

        function renderBillScanResult(items) {
            const list = document.getElementById('bill-scan-list');
            list.innerHTML = '';

            items.forEach(item => {
                addManualBillItem(item.name, item.amount);
            });
            // å¦‚æœæ²’æ±è¥¿ï¼Œé è¨­åŠ ä¸€åˆ—
            if (items.length === 0) addManualBillItem();
        }

        function addManualBillItem(name = '', amount = '') {
            const list = document.getElementById('bill-scan-list');
            const div = document.createElement('div');
            div.className = 'bill-item-row';
            div.innerHTML = `
                <input type="checkbox" class="bill-check" checked>
                <input type="text" class="bill-name-input" placeholder="å“é …åç¨±" value="${name}">
                <input type="number" class="bill-amount-input" placeholder="é‡‘é¡" value="${amount}">
                <div class="bill-remove-btn" onclick="this.parentElement.remove()">Ã—</div>
            `;
            list.appendChild(div);
        }

        async function confirmBillScan() {
            const rows = document.querySelectorAll('.bill-item-row');
            let entries = [];

            // [æ–°å¢] è®€å–å…¨åŸŸæ—¥æœŸèˆ‡ä»˜æ¬¾æ–¹å¼
            const dateVal = document.getElementById('bill-scan-date')?.value || new Date().toISOString().split('T')[0];
            const payVal = document.getElementById('bill-scan-payment-method')?.value || 'cash';
            const pType = document.getElementById('bill-scan-pay-type')?.value || 'public';

            // 1. è’é›†è³‡æ–™
            rows.forEach(row => {
                const checked = row.querySelector('.bill-check').checked;
                // [ä¿®æ­£] ç¢ºä¿å»é™¤å‰å¾Œç©ºç™½
                const name = row.querySelector('.bill-name-input').value.trim();
                const amount = row.querySelector('.bill-amount-input').value.trim();

                if (checked && name && amount) {
                    entries.push({ item: name, amount: parseInt(amount) });
                }
            });

            if (entries.length === 0) {
                alert("æ²’æœ‰é¸å–ä»»ä½•æœ‰æ•ˆé …ç›®");
                return;
            }

            // 2. æ‰¹æ¬¡é€å‡º
            document.getElementById('bill-scan-modal').style.display = 'none';
            // [æ–°å¢] è§£é™¤èƒŒæ™¯æ²å‹•é–å®š
            document.body.style.overflow = '';

            showGlobalLoading("æ­£åœ¨å„²å­˜ " + entries.length + " ç­†å¸³ç›®...");

            try {
                // [ä¿®æ­£] æ¡ç”¨èˆ‡ handleLedgerSubmit å®Œå…¨ä¸€è‡´çš„ä½¿ç”¨è€…æŠ“å–é‚è¼¯
                // é€™æ¨£èƒ½é¿å…æŠ“åˆ° "è«‹ç™»å…¥" æˆ–æ˜¯éŒ¯èª¤çš„æ–‡å­—
                let userName = localStorage.getItem('last_user_name');
                if (!userName && window.TEMP_USER_NAME) userName = window.TEMP_USER_NAME.trim();
                if (!userName) {
                    const el = document.getElementById('custom-user-name') || document.querySelector('.user-name-input');
                    if (el) userName = el.value.trim();
                }
                if (!userName || userName === 'undefined' || userName === 'null' || userName === 'è«‹ç™»å…¥') userName = 'åŒ¿å';

                let avatar = localStorage.getItem('last_user_emoji') || 'ğŸ¦';
                // å¦‚æœ localStorage æ²’æ±è¥¿ï¼Œæ‰è©¦è‘—æŠ“ DOM
                if (avatar === 'ğŸ¦') {
                    const domAvatar = document.getElementById('display-current-avatar').innerText;
                    if (domAvatar && domAvatar !== 'ğŸ‘¤') avatar = domAvatar;
                }

                // å¾ªåºé€å‡º (Serial) ä¸¦åŠ å…¥å»¶é²ï¼Œé¿å…å¾Œç«¯é–æ­» (Script Lock)
                let successCount = 0;
                for (const entry of entries) {
                    await submitFinanceEntrySimple(entry.item, entry.amount, avatar, userName, dateVal, payVal, pType);
                    successCount++;
                    // [æ–°å¢] å»¶é² 300ms
                    await new Promise(r => setTimeout(r, 300));
                }

                alert(`æˆåŠŸåŠ å…¥ ${successCount} ç­†é …ç›®ï¼`);

                // é‡æ–°æ•´ç†åˆ—è¡¨
                syncLedgerData();

            } catch (e) {
                console.error("Batch Submit Error:", e);
                alert("å„²å­˜éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message);
                syncLedgerData();
            } finally {
                hideGlobalLoading();
            }
        }

        // [æå–] ç¨ç«‹çš„è¨˜å¸³é€å‡ºå‡½å¼ (ä¿®æ­£ç‰ˆï¼šå¢åŠ  payType åƒæ•¸)
        async function submitFinanceEntrySimple(item, amount, avatar, userName, dateStr, paymentMethod, payType) {
            const url = getKey('gas_url');
            const token = getKey('gas_token');
            if (!url || !token) throw new Error("API URL/Token Missing");

            // 1. è¨ˆç®—åŒ¯ç‡ (æ¯”ç…§ handleLedgerSubmit)
            let finalRate = 0.21;
            const manualRateEl = document.getElementById('calc-rate');
            if (manualRateEl && parseFloat(manualRateEl.value) > 0) {
                finalRate = parseFloat(manualRateEl.value);
            } else {
                try {
                    const cached = localStorage.getItem('live_exchange_rate_cache');
                    if (cached) {
                        const parsed = JSON.parse(cached);
                        if (parsed.rate > 0) finalRate = parsed.rate;
                    }
                } catch (e) { }
            }

            const amountJpy = parseFloat(amount) || 0;
            const amountTwd = amountJpy > 0 ? Math.round(amountJpy * finalRate) : 0;

            // 2. å»ºæ§‹æ¨™æº– Payload
            const payload = {
                action: 'upload', // ä¿®æ­£ç‚ºæ­£ç¢ºçš„ action
                token: token,
                type: 'finance',
                // ç”¢ç”Ÿ UUID
                id: (window.crypto && window.crypto.randomUUID) ? window.crypto.randomUUID() : ('id-' + Date.now() + Math.random().toString(36).substr(2, 5)),
                userName: userName,
                userAvatar: avatar,
                date: dateStr || new Date().toISOString().split('T')[0], // ä½¿ç”¨å‚³å…¥çš„æ—¥æœŸ
                timestamp: (() => {
                    // ç°¡æ˜“æ§‹é€  timestamp
                    if (dateStr) {
                        const now = new Date();
                        const [y, m, d] = dateStr.split('-').map(Number);
                        return new Date(y, m - 1, d, now.getHours(), now.getMinutes()).toISOString();
                    }
                    return new Date().toISOString();
                })(),
                paymentMethod: paymentMethod || 'cash',
                paymentType: (payType === 'public' ? 'Public' : userName), // [æ–°å¢]
                rate: String(finalRate),
                twdAmount: String(amountTwd),
                item: item,
                content: item, // ç‚ºäº†ç›¸å®¹æ€§ï¼Œå…©è€…éƒ½å¡«
                amount: String(amountJpy),
                images: [] // æƒæé …ç›®æš«ä¸é™„åœ–
            };

            // 3. ç™¼é€è«‹æ±‚
            const resp = await fetch(url, { method: 'POST', body: JSON.stringify(payload) });
            const result = await resp.json();

            if (result.status !== 'success' && result.result !== 'success') {
                throw new Error(result.message || "Submit Failed");
            }
        }

        // [æ–°å¢] å–æ¶ˆç·¨è¼¯æ¨¡å¼
        function cancelEditMode() {
            window.editingId = null;

            // 1. é‡ç½®æ—¥æœŸç‚ºä»Šå¤©
            // ä½¿ç”¨æœ¬åœ°æ™‚å€ï¼Œé¿å… ISO UTC èª¤å·®
            const today = new Date();
            const y = today.getFullYear();
            const m = String(today.getMonth() + 1).padStart(2, '0');
            const d = String(today.getDate()).padStart(2, '0');
            const todayStr = `${y}-${m}-${d}`;

            const dateInput = document.getElementById('ledger-note-date');
            if (dateInput) dateInput.value = todayStr;

            // 2. æ¸…ç©ºè¼¸å…¥æ¡†
            if (document.getElementById('ledger-note-content')) document.getElementById('ledger-note-content').value = '';
            if (document.getElementById('ledger-item')) document.getElementById('ledger-item').value = '';
            if (document.getElementById('ledger-amount')) document.getElementById('ledger-amount').value = '';

            // [æ–°å¢] é‡ç½® Finance æ—¥æœŸèˆ‡ä»˜æ¬¾
            if (document.getElementById('ledger-date')) document.getElementById('ledger-date').value = todayStr;
            if (document.getElementById('ledger-payment-method')) document.getElementById('ledger-payment-method').value = 'cash';

            // 3. éš±è— Cancel æŒ‰éˆ•
            const cBtnNote = document.getElementById('btn-cancel-edit-note');
            if (cBtnNote) cBtnNote.style.display = 'none';

            const cBtnFinance = document.getElementById('btn-cancel-edit-finance');
            if (cBtnFinance) cBtnFinance.style.display = 'none';

            // 4. é‚„åŸæŒ‰éˆ•åœ–ç¤º (Note)
            const btnNote = document.querySelector('#ledger-note-fields .btn-submit-ledger');
            if (btnNote) {
                btnNote.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2563EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>`;
            }

            // 5. é‚„åŸæŒ‰éˆ•åœ–ç¤º (Finance)
            const btnFinance = document.querySelector('#ledger-finance-fields .btn-submit-ledger');
            if (btnFinance) {
                btnFinance.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2563EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>`;
            }

            // 6. æ¸…ç©ºåœ–ç‰‡é è¦½
            window.currentNoteImages = [];
            if (typeof renderImagePreviews === 'function') renderImagePreviews();

            // 7. æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            if (typeof updateLedgerSubmitState === 'function') updateLedgerSubmitState();

            // [æ–°å¢] å¼·åˆ¶æ ¼å¼åŒ–æ—¥æœŸ (ç¸®çŸ­é¡¯ç¤º)
            if (typeof formatCompactDate === 'function') {
                formatCompactDate(document.getElementById('ledger-date'));
                formatCompactDate(document.getElementById('ledger-note-date'));
            }
        }

        // [æ–°å¢] ç·Šæ¹Šæ—¥æœŸé¡¯ç¤ºé‚è¼¯ (YYYY/M/D)
        function initCompactDateInput(id) {
            const el = document.getElementById(id);
            if (!el) return;

            // åˆå§‹æ ¼å¼åŒ–
            formatCompactDate(el);

            // èšç„¦æ™‚åˆ‡æ›å›åŸç”Ÿ Date Picker
            el.addEventListener('focus', function () {
                this.type = 'date';

                // é‚„åŸ ISO æ ¼å¼ (YYYY-MM-DD) çµ¦ Picker
                if (this.dataset.isoValue) {
                    this.value = this.dataset.isoValue;
                }
            });

            // å¤±ç„¦æˆ–æ”¹è®Šæ™‚åˆ‡æ›å› Text ä¸¦æ ¼å¼åŒ–
            el.addEventListener('blur', function () {
                handleDateBlur(this);
            });
            el.addEventListener('change', function () {
                handleDateBlur(this);
            });
        }

        function handleDateBlur(el) {
            if (el.value) {
                // å¦‚æœæ˜¯ ISO æ ¼å¼ï¼Œå­˜èµ·ä¾†
                if (el.value.includes('-')) {
                    el.dataset.isoValue = el.value;
                }
            } else {
                // å¦‚æœæ¸…ç©ºäº†ï¼Œä¹Ÿè¨±è¦ä¿ç•™åŸå€¼æˆ–è¨­ç‚ºä»Šå¤©ï¼Ÿ
                // é€™è£¡æš«æ™‚ä¿æŒåŸæ¨£
            }

            el.type = 'text';
            formatCompactDate(el);
        }

        function formatCompactDate(el) {
            if (!el) return;

            // å¦‚æœç•¶å‰æ˜¯ date typeï¼Œå…ˆå–å€¼å­˜èµ·ä¾†
            if (el.type === 'date' && el.value) {
                el.dataset.isoValue = el.value;
            }

            const rawVal = el.dataset.isoValue || el.value;
            if (!rawVal) return;

            // å˜—è©¦è§£æ YYYY-MM-DD
            if (rawVal.includes('-')) {
                const parts = rawVal.split('-');
                if (parts.length === 3) {
                    const y = parts[0];
                    const m = parseInt(parts[1], 10);
                    const d = parseInt(parts[2], 10);
                    // åˆ‡æ›ç‚º Text
                    el.type = 'text';
                    el.value = `${y}/${m}/${d}`;
                }
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initCompactDateInput('ledger-date');
            initCompactDateInput('ledger-note-date');
        });

    </script>
</body>

<style>
    /* Refined Gallery Modal Styles (Lightbox feel, not fullscreen) */
    #gallery-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        /* Dimmed backdrop */
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 24px;
        /* Padding creates the 'not full screen' effect */
        box-sizing: border-box;
    }

    #gallery-container {
        width: 100%;
        height: 100%;
        max-width: 100%;
        max-height: 100%;
        /* Fill the padded area */
        position: relative;
        background: black;
        border-radius: 16px;
        /* Rounded corners */
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .gallery-close {
        position: absolute;
        top: 16px;
        right: 16px;
        color: white;
        font-size: 28px;
        line-height: 1;
        z-index: 10001;
        cursor: pointer;
        background: rgba(0, 0, 0, 0.4);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
    }

    .gallery-dots {
        position: absolute;
        bottom: 20px;
        left: 0;
        right: 0;
        display: flex;
        justify-content: center;
        gap: 8px;
        z-index: 10002;
        pointer-events: none;
    }
</style>

</html>